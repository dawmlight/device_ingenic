cscope 15 $HOMEopenharmony/openharmony-2.2beta2-1/openharmony-2.2beta2/device/ingenic/x2000/hardware/hals/communication/bluetooth/frameworks -q 0000003894 0000775756
	@BtMain.cpp

7 
	#LOG_TAG
 "BtMaš"

	)

9 
	~"wifi/W·IÁ”çû.h
"

10 
	~"wifi_deviû.h
"

11 
	~"b§_bË_­i.h
"

12 
	~"BtMaš.h
"

13 
	~"ohos_bt_g©t.h
"

14 
	~"ohos_bt_g©t_£rv”.h
"

15 
	~<S‘tšgsDB.h
>

16 
	~<uts/Log.h
>

18 #ifdeà
__ılu¥lus


22 
­p_mgr_g‘_addr
(* 
addr
);

23 #ifdeà
__ılu¥lus


27 
	#APP_BLE_SERVICE_IS_PRIMARY
 1

28 
	#APP_BLE_SERVICE_NUM_HANDLE
 6

	)

29 
	tUINT8
;

30 
UINT8
 
	gRSP_DEV_NAME
[32] = "Hi-VIATON-2DDZ00";

31 
UINT8
 
	gMANU_DATA
[] = {0x01, 0x31, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66};

43 
UINT8
 
	gHILINK_SERVICE_RW
[
MAX_UUID_SIZE
] = {0x00, 0x91, 0x8a, 0xef, 0x39, 0xdd, 0x84, 0xa4, 0xfc, 0x43, 0x77, 0xa2, 0x00, 0xe6, 0xf1, 0x15};

45 
UINT8
 
	gHILINK_CHAR_DATA_READ
[
MAX_UUID_SIZE
] = {0x00, 0x91, 0x8a, 0xef, 0x39, 0xdd, 0x84, 0xa4, 0xfc, 0x43, 0x77, 0xa2, 0x01, 0xe6, 0xf1, 0x15};

47 
UINT8
 
	gHILINK_CHAR_DATA_WRITE
[
MAX_UUID_SIZE
] = {0x00, 0x91, 0x8a, 0xef, 0x39, 0xdd, 0x84, 0xa4, 0xfc, 0x43, 0x77, 0xa2, 0x02, 0xe6, 0xf1, 0x15};

50 
UINT8
 
	gHILINK_SERVICE_REGISTER
[
MAX_UUID_SIZE
] = {0x00, 0x91, 0x8a, 0xef, 0x39, 0xdd, 0x84, 0xa4, 0xfc, 0x43, 0x77, 0xa2, 0x00, 0xe5, 0xf1, 0x15};

52 
UINT8
 
	gHILINK_CHAR_REGISTER
[
MAX_UUID_SIZE
] = {0x00, 0x91, 0x8a, 0xef, 0x39, 0xdd, 0x84, 0xa4, 0xfc, 0x43, 0x77, 0xa2, 0x01, 0xe5, 0xf1, 0x15};

53 cÚ¡ 
	gHILINK_SERVICE_SUM
 = 2;

54 
	ghšk_bË_uuid
[] = {0xe600, 0xe500};

55 
UINT8
 *
	ghšk_£rviûs
[] = {
HILINK_SERVICE_RW
, 
HILINK_SERVICE_REGISTER
};

57 
UINT8
 *
	ghšk_ch¬aù”i¡ic_of_d©a
[] = {
HILINK_CHAR_DATA_READ
, 
HILINK_CHAR_DATA_WRITE
};

58 
UINT8
 
	ghšk_ch¬aù”i¡ic_´İ”ty_of_d©a
[] = {

59 
BSA_GATT_CHAR_PROP_BIT_NOTIFY
 | 
BSA_GATT_CHAR_PROP_BIT_INDICATE
,

60  
BSA_GATT_CHAR_PROP_BIT_WRITE
,

63 
UINT8
 *
	ghšk_ch¬aù”i¡ic_of_»g
[] = {
HILINK_CHAR_REGISTER
};

64 
UINT8
 
	ghšk_ch¬aù”i¡ic_´İ”ty_of_»g
[] = {

65 
BSA_GATT_CHAR_PROP_BIT_NOTIFY
 | 
BSA_GATT_CHAR_PROP_BIT_WRITE
 | 
BSA_GATT_CHAR_PROP_BIT_INDICATE
,

68 
	#BLE_BEACON_HUAWEI_UUID
 0xFDEE

	)

69 
	~<fú.h
>

71 
UINT8
 
	guÄeg_d©a
[] = {0x01, 0x01, 0x07, 0x04, 0x00, 0x11, 0x0f, 0x12, 0x32, 0x44, 0x44, 0x5A, 0xFF, 0x00, 0x04, 0x02, 0x39, 0x39};

72 
UINT8
 
	g»g_d©a
[] = {0x01, 0x01, 0x07, 0x04, 0x00, 0x11, 0x0f, 0x12, 0x32, 0x44, 0x44, 0x5A, 0xFF, 0x00, 0x0C, 0x02, 0x39, 0x39};

75 
	mDEV_UNREG
 = 0,

76 
	mDEV_REG
,

77 } 
	tREG_ST
;

78 
	ghšk_¡©e
 = 
DEV_UNREG
;

79 
	$hšk_£t_¡©e
(
REG_ST
 
¡
) {

80 
fd
 = 
	`İ’
("/tmp/hšk_»g_¡©e", 
O_RDWR
 | 
O_CREAT
);

81 ià(
fd
 >= 0) {

82 
UINT8
 
tc
 = '0';

83 ià(
¡
 =ğ
DEV_REG
)

84 
tc
 = '1';

85 
	`wr™e
(
fd
, &
tc
, 1);

86 
	`şo£
(
fd
);

87 
	`´štf
("wr™bt_hšk,c:%x,¡:%d\n", 
tc
, 
¡
);

89 
	`´štf
("write bt_hilink state fail\n");

91 
hšk_¡©e
 = 
¡
;

92 
	}
}

93 
REG_ST
 
	$hšk_g‘_¡©e
() {

94 
REG_ST
 
¡
 = 
DEV_UNREG
;

95 
fd
 = 
	`İ’
("/tmp/hšk_»g_¡©e", 
O_RDONLY
);

96 ià(
fd
 >= 0) {

97 
UINT8
 
tc
 = '0';

98 
	`»ad
(
fd
, &
tc
, 1);

99 
	`şo£
(
fd
);

100 ià(
tc
 == '1') {

101 
¡
 = 
DEV_REG
;

103 
	`´štf
("»ad bt_hšk :%d,¡:%d\n", 
tc
, 
¡
);

105 
	`´štf
("read fail, will write default bt_hilink state\n");

106 
	`hšk_£t_¡©e
(
¡
 = 
DEV_UNREG
);

108 
hšk_¡©e
 = 
¡
;

109  
hšk_¡©e
;

110 
	}
}

111 
	#DEV_INFO_READ_MAX_LEN
 256

	)

112 
	$_g‘_sys_dev_šfo
(*
dev_Çme
, *
d©a
, 
off_t
 
off
) {

113 
buf
[
DEV_INFO_READ_MAX_LEN
];

114 
fd
 = 
	`İ’
(
dev_Çme
, 
O_RDONLY
);

115 
Ën
;

116 *
±r
;

117 
»t
 = -1;

118 ià(
fd
 >= 0) {

119 ià(
off
 > 0)

120 
	`l£ek
(
fd
, 
off
, 
SEEK_SET
);

121 
Ën
 = 
	`»ad
(
fd
, 
buf
, 
DEV_INFO_READ_MAX_LEN
 - 1);

122 ià(
Ën
 > 0) {

123 
»t
 = 0;

124 
±r
 = 
	`¡rchr
(
buf
, '\n');

125 ià(
±r
) {

126 *
±r
 = 0;

127 
Ën
 = 
±r
 - 
buf
;

129 
buf
[
Ën
] = 0;

132 
	`şo£
(
fd
);

133 ià(
d©a
 !ğ
NULL
) {

134 
	`memıy
(
d©a
, 
buf
, 
Ën
 + 1);

137 
	`´štf
("wrÚg, cª\'ˆİ’ f%s\n", 
dev_Çme
);

139  
»t
;

140 
	}
}

142 
	#MAX_SN_LENGTH
 20

	)

143 
	g´oduù_¢
[
MAX_SN_LENGTH
] = "";

144 
	$g‘_´oduù_¢
(*
¢
) {

145 
buf
[
DEV_INFO_READ_MAX_LEN
];

146 
»t
 = 
	`_g‘_sys_dev_šfo
((*)"/dev/mmcblk0p4", 
buf
, 1024);

147 
	`¡ºıy
(
¢
, 
buf
, 
MAX_SN_LENGTH
 - 1);

148 
¢
[
MAX_SN_LENGTH
 - 1] = 0;

149  
»t
;

150 
	}
}

152 
	$b—cÚ_£t_bË_sÿÄ¥_d©a
() {

153 
tBSA_DM_BLE_ADV_CONFIG
 
bË_cÚfig_adv
;

154 
Ën
;

155 
mac
[6]={0};

156 
	`mem£t
(
MANU_DATA
 + 2, 0, 6);

157 ià(
	`G‘DeviûMacAdd»ss
(
mac
è=ğ
WIFI_SUCCESS
) {

158 
	`´štf
("===>>%s:g‘ mac:%x,%x,%x,%x,%x,%x\n",
__func__
,
mac
[0],mac[1],mac[2],mac[3],mac[4],mac[5]);

159 
	`memıy
(
MANU_DATA
+2, 
mac
, (mac));

162 
	`¥rštf
(
RSP_DEV_NAME
, "Hi-VIATON-12DDZ%02hhX", 
MANU_DATA
[(MANU_DATA) - 1]);

163 
	`´štf
("%s-RSP_DEV_NAME:%s\n", 
__FUNCTION__
, 
RSP_DEV_NAME
);

164 
	`´štf
("MANU_DATA:%02hhx %02hhx %02hhx %02hhx %02hhx %02hhx %02hhx %02hhx\n", 
MANU_DATA
[0], MANU_DATA[1],

165 
MANU_DATA
[2], MANU_DATA[3], MANU_DATA[4], MANU_DATA[5], MANU_DATA[6], MANU_DATA[7]);

166 
	`S‘DeviûName
(
RSP_DEV_NAME
, 
	`¡¾’
(RSP_DEV_NAME));

168 
	`mem£t
(&
bË_cÚfig_adv
, 0, (
tBSA_DM_BLE_ADV_CONFIG
));

169 
bË_cÚfig_adv
.
is_sÿn_r¥
 = 
TRUE
;

170 
bË_cÚfig_adv
.
adv_d©a_mask
 = 
BSA_DM_BLE_AD_BIT_MANU
 | 
BSA_DM_BLE_AD_BIT_DEV_NAME
;

171 
	`memıy
(
bË_cÚfig_adv
.
p_v®
, 
MANU_DATA
, (MANU_DATA));

172 
bË_cÚfig_adv
.
Ën
 = (
MANU_DATA
);

174 
BËCÚfigAdvD©a
 
d©a
;

175 
d©a
.
advD©a
 = (*)&
bË_cÚfig_adv
;

176 
d©a
.
advL’gth
 = (
bË_cÚfig_adv
);

177 
	`BËS‘AdvD©a
(0, &
d©a
);

178 
	}
}

179 
	$b—cÚ_bË_adv_’abË
(
REG_ST
 
¡
) {

180 
tBSA_DM_BLE_ADV_CONFIG
 
bË_cÚfig_adv
;

181 
¢_Ën
, 
»gšfo_Ën
;

182 ià(
´oduù_¢
[0] == 0) {

183 
	`g‘_´oduù_¢
(
´oduù_¢
);

184 ià(
´oduù_¢
[0] != 0) {

185 
»gšfo_Ën
 = (
uÄeg_d©a
);

186 
¢_Ën
 = 
	`¡¾’
(
´oduù_¢
);

187 
	`memıy
(
uÄeg_d©a
 + 
»gšfo_Ën
 - 2, 
´oduù_¢
 + 
¢_Ën
 - 2, 2);

188 
»gšfo_Ën
 = (
»g_d©a
);

189 
	`memıy
(
»g_d©a
 + 
»gšfo_Ën
 - 2, 
´oduù_¢
 + 
¢_Ën
 - 2, 2);

192 
	`mem£t
(&
bË_cÚfig_adv
, 0, (
tBSA_DM_BLE_ADV_CONFIG
));

193 
bË_cÚfig_adv
.
æag
 = 
BTM_BLE_GEN_DISC_FLAG
 | 
BTM_BLE_BREDR_NOT_SPT
;

194 
bË_cÚfig_adv
.
is_sÿn_r¥
 = 
FALSE
;

196 
bË_cÚfig_adv
.
adv_d©a_mask
 = 
BSA_DM_BLE_AD_BIT_FLAGS
 | 
BTM_BLE_AD_BIT_SERVICE_DATA
;

197 
¡©e
;

198 ià(
¡
 =ğ
DEV_UNREG
) {

199 
Ën
 = (
uÄeg_d©a
);

200 
bË_cÚfig_adv
.
£rviû_d©a_Ën
 = 
Ën
;

201 
bË_cÚfig_adv
.
£rviû_d©a_uuid
.
Ën
 = 
LEN_UUID_16
;

202 
bË_cÚfig_adv
.
£rviû_d©a_uuid
.
uu
.
uuid16
 = 
BLE_BEACON_HUAWEI_UUID
;

203 
	`memıy
(
bË_cÚfig_adv
.
£rviû_d©a_v®
, 
uÄeg_d©a
, 
Ën
);

205 
Ën
 = (
»g_d©a
);

206 
bË_cÚfig_adv
.
£rviû_d©a_Ën
 = 
Ën
;

207 
bË_cÚfig_adv
.
£rviû_d©a_uuid
.
Ën
 = 
LEN_UUID_16
;

208 
bË_cÚfig_adv
.
£rviû_d©a_uuid
.
uu
.
uuid16
 = 
BLE_BEACON_HUAWEI_UUID
;

209 
	`memıy
(
bË_cÚfig_adv
.
£rviû_d©a_v®
, 
»g_d©a
, 
Ën
);

211 
BËCÚfigAdvD©a
 
d©a
;

212 
d©a
.
advD©a
 = (*)&
bË_cÚfig_adv
;

213 
d©a
.
advL’gth
 = (
bË_cÚfig_adv
);

214 
	`BËS‘AdvD©a
(0, &
d©a
);

215 
	`BËS¹Adv
(0, 
NULL
);

216 
	}
}

222 
	gbk_bË_b—cÚ_¡©e
=-1;

223 
	gbË_b—cÚ_Ú_off
 = 0;

224 
	gÏ¡_¡©e
 = -1;

225 
	$£tBTBËB—cÚOnOff
(
¡©e
){

226 
Ï¡_¡©e
 = 
bË_b—cÚ_Ú_off
 = 
¡©e
;

227 
	}
}

229 
	$g‘BTBËB—cÚOnOff
(){

230  
bË_b—cÚ_Ú_off
;

231 
	}
}

232 
»£t_b—cÚ_tim”
();

234 
	$£tBTBËB—cÚ
(
¡©e
) {

235 if(
¡©e
 == 4) {

236 ifĞ
bË_b—cÚ_Ú_off
 ) {

237 
	`»£t_b—cÚ_tim”
();

241 if(
Ï¡_¡©e
 =ğ
¡©e
)

243 
Ï¡_¡©e
 = 
¡©e
;

244 
¡©e
) {

247 ià(
bË_b—cÚ_Ú_off
 !ğ
¡©e
) {

248 
bË_b—cÚ_Ú_off
 = 
¡©e
;

249 
	`ALOGD
("\À£tBTBËB—cÚ:%s\n", (
¡©e
 == 0) ? "off" : "on");

254 ià(
bk_bË_b—cÚ_¡©e
 !ğ
¡©e
) {

255 
bk_bË_b—cÚ_¡©e
 = 
¡©e
;

256 
	`ALOGD
("\À£tBTBËB—cÚ:%s\n", (
¡©e
 == 2) ? "unreg" : "reg");

257 
	`hšk_£t_¡©e
((
¡©e
 == 2) ? 0 : 1);

261 
	`BËStİAdv
(0);

262 ià(
bË_b—cÚ_Ú_off
 == 1) {

263 ià(
¡©e
) {

265 
	`b—cÚ_£t_bË_sÿÄ¥_d©a
();

267 
¡©e
) {

269 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

273 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

277 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

285 
	}
}

288 
	$b—cÚ_£t_adv_·¿m
(
UINT16
 
·¿
) {

289 
tBSA_DM_BLE_ADV_PARAM
 
bË_adv_·¿
;

290 ià(
	`g‘BTBËB—cÚOnOff
()) {

291 
	`mem£t
(&
bË_adv_·¿
, 0, (
tBSA_DM_BLE_ADV_PARAM
));

293 
bË_adv_·¿
.
adv_št_mš
 = 
·¿
;

294 
bË_adv_·¿
.
adv_št_max
 = 
·¿
;

295 
	`g‘_bt_addr
(
bË_adv_·¿
.
dœ_bda
.
bd_addr
);

296 
	`­p_dm_£t_bË_adv_·¿m
(&
bË_adv_·¿
);

300 
	}
}

301 
	gb—cÚ_štv_£‰imes
 = 0;

303 
	#TIME_BEACON_KEEP_20MS_S
 180

	)

304 
	$»£t_b—cÚ_tim”
() {

305 ià(
	`g‘BTBËB—cÚOnOff
()) {

306 
b—cÚ_štv_£‰imes
 = 0;

307 
	`BËS¹Adv
(0, 
NULL
);

309 
	}
}

310 cÚ¡ 
	gwifi_Úoff_âame
[] = "/tmp/wifi_use_state";

311 
	$g‘_wifi_Ú_off
() {

312 
buf
[2];

313 
Ën
;

314 
fd
 = 
	`İ’
(
wifi_Úoff_âame
, 
O_RDONLY
);

315 ià(
fd
 < 0) {

316 
	`´štf
("cannot„ead wifi onoff state");

319 
Ën
 = 
	`»ad
(
fd
, 
buf
, 1);

320 
	`şo£
(
fd
);

321 ià(
Ën
 == 1) {

322 ià(
buf
[0] == '1')

328 
	}
}

330 
	$g‘_fe_size
(cÚ¡ *
f’ame
)

332 
¡©
 
buf
;

333 if(
	`¡©
(
f’ame
, &
buf
)<0)

337  ()
buf
.
¡_size
;

338 
	}
}

339 
	$isN“dB—cÚ
(){

341 if(
	`g‘_fe_size
("/tmp/hilink_reg_state") == 0)

344 if(
	`g‘_fe_size
("/tmp/hilink_need_beacon_reg") > 0)

347 
	}
}

349 
	$­p_£t_adv_·¿m_th»ad
() {

350 
wifi_Úoff_¡©e
,
wifi_cÚn_¡©e
;

351 
wa™time
=0,
w2time
=0;

353 
	`¦“p
(1);

355 
wifi_Úoff_¡©e
 = 
	`g‘_wifi_Ú_off
();

356 ià(
	`g‘BTBËB—cÚOnOff
()) {

357 
wa™time
 = 0;

358 ià((
wifi_Úoff_¡©e
 =ğ0è|| (!
	`isN“dB—cÚ
())) {

359 if(
wifi_Úoff_¡©e
 == 0)

360 
	`´štf
("wif˜off,‚“d stİ bË b—cÚ,Ú_off:%d",
wifi_Úoff_¡©e
);

362 
	`APP_INFO0
("isNeedBeacon false,‚eed stop ble beacon.");

363 
	`£tBTBËB—cÚOnOff
(0);

364 
b—cÚ_štv_£‰imes
 = 
TIME_BEACON_KEEP_20MS_S
+1;

365 
w2time
 = 0;

366 } ià(0 < 
	`g‘_fe_size
("/tmp/wifi_conn_state")) {

367 ++
w2time
;

368 if(++
w2time
 > 1) {

369 
	`´štf
("wif˜cÚÃùed,‚“d stİ bË b—cÚ,cÚn_¡©e:%d,wa™:%d",
	`g‘_fe_size
("/tmp/wifi_cÚn_¡©e"), 
w2time
);

370 
w2time
 = 0;

371 
	`£tBTBËB—cÚOnOff
(0);

372 
b—cÚ_štv_£‰imes
 = 
TIME_BEACON_KEEP_20MS_S
+1;

375 
w2time
 = 0;

376 ià(
b—cÚ_štv_£‰imes
 <ğ
TIME_BEACON_KEEP_20MS_S
) {

377 
	`­p_dm_’su»_bË_visib™y
();

378 
	`b—cÚ_£t_adv_·¿m
(0x20);

379 ++
b—cÚ_štv_£‰imes
;

380 ià((
b—cÚ_štv_£‰imes
 - 1) % 10 == 0)

381 
	`´štf
("b—cÚ_štv_£‰imes:%u", 
b—cÚ_štv_£‰imes
);

382 } ià(
b—cÚ_štv_£‰imes
 <ğ
TIME_BEACON_KEEP_20MS_S
 + 1) {

383 
	`­p_dm_£t_bË_visib™y
(
FALSE
, FALSE);

384 ++
b—cÚ_štv_£‰imes
;

385 
	`´štf
("¡İ bË b—cÚ, b—cÚ_štv_£‰imes:%u", 
b—cÚ_štv_£‰imes
);

389 
w2time
 = 0;

390 ià((
wifi_Úoff_¡©e
 =ğ1è&& 
	`isN“dB—cÚ
()) {

391 if(0 =ğ
	`g‘_fe_size
("/tmp/wifi_conn_state")){

392 ++
wa™time
;

393 ià(
wa™time
 > 4) {

394 
	`APP_INFO0
("!!!wrong!!!,no wifi , bt beacon shuld be on");

395 
wa™time
 = 0;

396 
	`£tBTBËB—cÚOnOff
(1);

397 
	`b—cÚ_£t_bË_sÿÄ¥_d©a
();

398 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

401 
wa™time
 = 0;

403 
wa™time
 = 0;

407 
	`´štf
("Exit");

408 
	`±h»ad_ex™
(
NULL
);

409 
	}
}

411 
	$bt_»gi¡”_£rv”_ÿÎback
(
¡©us
, 
£rv”Id
, 
BtUuid
 *
­pUuid
)

413 
	`´štf
("===>>rzhao:%s\n",
__func__
);

414 
	}
}

416 
	$bt_cÚÃù_£rv”_ÿÎback
(
cÚnId
, 
£rv”Id
, cÚ¡ 
BdAddr
 *
bdAddr
)

418 
	`´štf
("===>>rzhao:%s\n",
__func__
);

419 
	}
}

421 
	$bt_discÚÃù_£rv”_ÿÎback
(
cÚnId
, 
£rv”Id
, cÚ¡ 
BdAddr
 *
bdAddr
)

423 
	`´štf
("===>>rzhao:%s\n",
__func__
);

424 
	`BËStİAdv
(0);

425 
	`b—cÚ_£t_bË_sÿÄ¥_d©a
();

426 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

427 
	}
}

429 
	$bt_£rviû_add_ÿÎback
(
¡©us
, 
£rv”Id
, 
BtUuid
 *
uuid
, 
¤vcHªdË
)

431 
i
, 
ch¬_sum
;

432 
£rv”_num
 = 
¤vcHªdË
;

433 ià(
£rv”_num
 == 0)

434 
ch¬_sum
 = (
hšk_ch¬aù”i¡ic_of_d©a
è/ (
UINT8
 *);

436 
ch¬_sum
 = (
hšk_ch¬aù”i¡ic_of_»g
è/ (
UINT8
 *);

437 
	`ALOGD
("­p_bË_£rv”_add_ch¬ s”v”_num:%d,sum:%d", 
£rv”_num
, 
ch¬_sum
);

438 
i
 = 0; i < 
ch¬_sum
; i++) {

439 ià((
£rv”_num
 >ğ0è&& (£rv”_num < 
HILINK_SERVICE_SUM
)) {

440 
UINT8
 *
ch¬_Çme
;

441 
ch¬aù”i¡ic_´İ”ty
 = 0;

442 ià(
£rv”_num
 == 0) {

443 
ch¬_Çme
 = 
hšk_ch¬aù”i¡ic_of_d©a
[
i
];

444 
ch¬aù”i¡ic_´İ”ty
 = 
hšk_ch¬aù”i¡ic_´İ”ty_of_d©a
[
i
];

446 
ch¬_Çme
 = 
hšk_ch¬aù”i¡ic_of_»g
[
i
];

447 
ch¬aù”i¡ic_´İ”ty
 = 
hšk_ch¬aù”i¡ic_´İ”ty_of_»g
[
i
];

449 
BtUuid
 
ch¬ac_uuid
;

450 
ch¬ac_uuid
.
uuid
 = (*)
ch¬_Çme
;

451 
ch¬ac_uuid
.
uuidL’
 = 
	`¡¾’
(ch¬ac_uuid.
uuid
);

452 
	`BËG©tsAddCh¬aù”i¡ic
(
£rv”Id
, 
£rv”_num
, 
ch¬ac_uuid
, 
ch¬aù”i¡ic_´İ”ty
, (1<<0 | 1<<4));

455 
	`´štf
("===>>rzhao:%s:£rv”Id=%d\n",
__func__
,
£rv”Id
);

456 
	}
}

458 
	$bt_šşude_£rviû_add_ÿÎback
(
¡©us
, 
£rv”Id
, 
¤vcHªdË
, 
šşudeSrvcHªdË
)

460 
	`´štf
("===>>rzhao:%s\n",
__func__
);

461 
	}
}

463 
	$bt_ch¬aù”i¡ic_add_ÿÎback
(
¡©us
, 
£rv”Id
, 
BtUuid
 *
uuid
,

464 
¤vcHªdË
, 
ch¬aù”i¡icHªdË
)

466 
	`´štf
("===>>rzhao:%s\n",
__func__
);

467 
	`BËG©tsS¹S”viû
(
£rv”Id
, 
¤vcHªdË
);

468 
	}
}

470 
	$bt_desütÜ_add_ÿÎback
(
¡©us
, 
£rv”Id
, 
BtUuid
 *
uuid
,

471 
¤vcHªdË
, 
desütÜHªdË
)

473 
	`´štf
("===>>rzhao:%s\n",
__func__
);

474 
	}
}

476 
	$bt_£rviû_¡¬t_ÿÎback
(
¡©us
, 
£rv”Id
, 
¤vcHªdË
)

478 
	`´štf
("===>>rzhao:%s\n",
__func__
);

479 
	`BËStİAdv
(0);

480 
	`b—cÚ_£t_bË_sÿÄ¥_d©a
();

481 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

482 
	}
}

484 
	$bt_£rviû_¡İ_ÿÎback
(
¡©us
, 
£rv”Id
, 
¤vcHªdË
)

486 
	`´štf
("===>>rzhao:%s\n",
__func__
);

487 
	}
}

489 
	$bt_£rviû_d–‘e_ÿÎback
(
¡©us
, 
£rv”Id
, 
¤vcHªdË
)

491 
	`´štf
("===>>rzhao:%s\n",
__func__
);

492 
	}
}

494 
	$bt_»que¡_»ad_ÿÎback
(
BtReqR—dCbP¬a
 
»adCbP¬a
)

496 
	`´štf
("===>>rzhao:%s\n",
__func__
);

497 
	}
}

499 
	$bt_»que¡_wr™e_ÿÎback
(
BtReqWr™eCbP¬a
 
wr™eCbP¬a
)

501 
	`´štf
("===>>rzhao:%s\n",
__func__
);

502 
	}
}

504 
	$bt_»¥Ú£_cÚfœm©iÚ_ÿÎback
(
¡©us
, 
hªdË
)

506 
	`´štf
("===>>rzhao:%s\n",
__func__
);

507 
	}
}

509 
	$bt_šdiÿtiÚ_£Á_ÿÎback
(
cÚnId
, 
¡©us
)

511 
	`´štf
("===>>rzhao:%s\n",
__func__
);

512 
	}
}

514 
	$bt_mtu_chªge_ÿÎback
(
cÚnId
, 
mtu
)

516 
	`´štf
("===>>rzhao:%s\n",
__func__
);

517 
	}
}

519 
BtG©tS”v”C®lbacks
 
	gbË_cback
 = {

520 .
»gi¡”S”v”Cb
 = 
bt_»gi¡”_£rv”_ÿÎback
,

521 .
	gcÚÃùS”v”Cb
 = 
bt_cÚÃù_£rv”_ÿÎback
,

522 .
	gdiscÚÃùS”v”Cb
 = 
bt_discÚÃù_£rv”_ÿÎback
,

523 .
	g£rviûAddCb
 = 
bt_£rviû_add_ÿÎback
,

524 .
	gšşudeS”viûAddCb
 = 
bt_šşude_£rviû_add_ÿÎback
,

525 .
	gch¬aù”i¡icAddCb
 = 
bt_ch¬aù”i¡ic_add_ÿÎback
,

526 .
	gdesütÜAddCb
 = 
bt_desütÜ_add_ÿÎback
,

527 .
	g£rviûS¹Cb
 = 
bt_£rviû_¡¬t_ÿÎback
,

528 .
	g£rviûStİCb
 = 
bt_£rviû_¡İ_ÿÎback
,

529 .
	g£rviûD–‘eCb
 = 
bt_£rviû_d–‘e_ÿÎback
,

530 .
	g»que¡R—dCb
 = 
bt_»que¡_»ad_ÿÎback
,

531 .
	g»que¡Wr™eCb
 = 
bt_»que¡_wr™e_ÿÎback
,

532 .
	g»¥Ú£CÚfœm©iÚCb
 = 
bt_»¥Ú£_cÚfœm©iÚ_ÿÎback
,

533 .
	gšdiÿtiÚS’tCb
 = 
bt_šdiÿtiÚ_£Á_ÿÎback
,

534 .
	gmtuChªgeCb
 = 
bt_mtu_chªge_ÿÎback
,

537 
	$ü—tBSAP©h
(){

538 
DIR
 * 
dœp
 = 
	`İ’dœ
("/usr/data/bsa");

539 ià(
NULL
 =ğ
dœp
) {

540 
»t
 = 
	`mkdœ
("/usr/data/bsa", 0777);

541 ià(
»t
 != 0) {

542 
	`´štf
("Error:can't create directory: %s\n", "/usr/data/bsa");

546 
	`şo£dœ
(
dœp
);

549 
	}
}

555 
¡ršg
 
	gbt_Çme
 = "";

557 
	$BtMaš
()

559 
	`ALOGV
("--BtMain in\n");

561 if(
	`ü—tBSAP©h
() < 0) {

562 
	`ALOGE
("\n\nwrong creatBSAPath wrong\n");

566 if(
	`In™BtSck
() != 0) {

567 
	`ALOGE
("\n\nwrong managerInit wrong\n");

571 
¡ršg
 
’abË
 = "";

572 
ªdroid
::
S‘tšgsDB
::
	`g‘SŒšg
(
DB_KEY_BLUETOOTH_ENABLE
, 
’abË
);

573 ià(
’abË
.
	`em±y
()) {

574 
ªdroid
::
S‘tšgsDB
::
	`g‘SŒšg
(
DB_KEY_BLUETOOTH_OPEN_ENABLE
, 
’abË
);

576 
ªdroid
::
S‘tšgsDB
::
	`putSŒšg
(
DB_KEY_BLUETOOTH_ENABLE
, 
’abË
);

578 
	`ALOGV
("’abË:%s\n",
’abË
.
	`c_¡r
());

579 ià(1||(
’abË
 == "true")) {

580 
	`EÇbËBtSck
();

581 
	`BËG©tsRegi¡”C®lbacks
(&
bË_cback
);

583 
BtUuid
 
­pUuid
;

584 
idx
 = 0; idx < 
HILINK_SERVICE_SUM
; idx++) {

585 
uuid
 = 
hšk_bË_uuid
[
idx
];

586 
uuidCh¬
[10];

587 
	`¥rštf
(
uuidCh¬
,"%u",
uuid
);

588 
­pUuid
.
uuid
 = 
	`¡rdup
(
uuidCh¬
);

589 
­pUuid
.
uuidL’
=
	`¡¾’
×µUuid.
uuid
);

590 
	`´štf
("===>>%s:%d,­pUuid.uuid i %s\n",
__func__
,
__LINE__
,
­pUuid
.
uuid
);

591 
	`BËG©tsRegi¡”
(
­pUuid
);

592 
	`ä“
(
­pUuid
.
uuid
);

594 
idx
 = 0; idx < 
HILINK_SERVICE_SUM
; idx++) {

595 
­pUuid
.
uuid
 = (*)
hšk_£rviûs
[
idx
];

596 
­pUuid
.
uuidL’
=
	`¡¾’
×µUuid.
uuid
);

597 #ià
APP_BLE_SERVICE_IS_PRIMARY


598 
	`BËG©tsAddS”viû
(
idx
, 
­pUuid
, 
Œue
, 
APP_BLE_SERVICE_NUM_HANDLE
);

600 
	`BËG©tsAddS”viû
(
idx
, 
­pUuid
, 
çl£
, 
APP_BLE_SERVICE_NUM_HANDLE
);

603 
	`BËS¹Adv
(1, 
NULL
);

606 
	`ALOGD
("BTMain start here");

608 
	}
}

	@ble/BleProtocol.cpp

1 
	#LOG_NDEBUG
 0

	)

2 
	#LOG_TAG
 "BËPrÙocŞ"

	)

4 
	~<fú.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dlib.h
>

7 
	~<uni¡d.h
>

9 
	~<sys/sock‘.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/un.h
>

14 
	~"BËPrÙocŞ.h
"

15 
	~"SyncD©aToŞs.h
"

16 
	~<uts/Log.h
>

18 
	#LONGDATA_CRC_LENGTH
 8

	)

19 
	#LONGDATA_FLAG_LENGTH
 10

	)

20 
	#BLE_DATA_MAX_SIZE
 150

	)

21 
	#REMOTE_DEVICE_UUID_SIZE
 36

	)

23 
	#BLE_BOND_REQ_PREFIX
 "<bind>uuid:"

24 
	#BLE_RECONN_REQ_PREFIX
 "<connect>uuid:"

25 
	#BLE_UNBOND_REQ
 "unbÚd"

	)

26 
	#BLE_UNBOND_END_REQ
 "unbÚdEnd"

	)

28 
	#BLE_BOND_OK
 "bond:0"

29 
	#BLE_BOND_FAILED
 "bond:1"

30 
	#BLE_UNBOND_RSP
 "unbond:0"

31 

	)

32 
	#BLE_NORMAL_PKG
 "syncd©a"

	)

33 
	#BLE_CONTACT_PKG
 "<CN>"

	)

35 #ifdeà
__ılu¥lus


38 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

41 
­p_bË_£rv”_£nd_šdiÿtiÚ
(
cÚ_id
, *
šdiÿtiÚ
, 
size
);

42 
­p_bË_£rv”_»gi¡”_wr™e_cback
((*
»ûiveWr™eReque¡Cback
)(*
addr
, 
cÚn_id
, *
d©a
, 
size
));

43 
­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
((*
ÚCÚÃùiÚS‹Chªge
)(*
add
, 
¡©e
));

44 
­p_bË_£rv”_şo£
();

45 
­p_bË_wake_cÚfigu»
();

46 #ifdeà
BLUETOOTH_HILINK_SUPPORT


47 
hšk_bË_£rv”_»gi¡”_wr™e_cback
((*
»ûiveWr™eReque¡Cback
)(
£rv”_no
, *
addr
, 
cÚn_id
, *
d©a
, 
size
));

48 
hšk_­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
((*
hškOnCÚÃùiÚS‹Chªge
)(*
addr
, 
lšk_¡©e
, 
cÚ_id
, 
£rv”_num
));

50 
BËPrÙocŞ_š¡ªû
();

51 #ifdeà
__ılu¥lus


57 
Çme¥aû
 
	gªdroid
 {

59 
BËPrÙocŞ
 *
	gBËPrÙocŞ
::
sIn¡ªû
 = 
NULL
;

60 
	gBËPrÙocŞ
::
mCÚId
 = -1;

61 #ifdeà
BLUETOOTH_HILINK_SUPPORT


62 
	gBËPrÙocŞ
::
mHškCÚId
[4] = {-1,-1,-1,-1};

65 şas 
	cH—d”
 : 
public
 
RefBa£
 {

66 
public
:

68 cÚ¡ 
NORMAL_PKG
 = 0x0;

69 cÚ¡ 
	gCONTACT_PKG
 = 0x1;

72 
H—d”
(*
d©a
, 
Ën
) {

73 *
	g´efix
 = 
Ãw
 [20];

74 
mem£t
(
´efix
, 0, 20);

75 
memıy
(
´efix
, 
d©a
, 20);

76 ià(
¡ºÿ£cmp
(
´efix
 + 4, 
BLE_NORMAL_PKG
, 
¡¾’
(BLE_NORMAL_PKG)) == 0) {

77 
mTy³
 = 
NORMAL_PKG
;

78 
ušt8_t
 
	ga
 = 
´efix
[16];

79 
ušt8_t
 
	gb
 = 
´efix
[17];

80 
ušt8_t
 
	gc
 = 
´efix
[18];

81 
ušt8_t
 
	gd
 = 
´efix
[19];

82 
št32_t
 
	gmoduË_Ën
 = 
a
 << 24 | 
b
 << 16 | 
c
 << 8 | 
d
;

83 
	gmModuËName
 = 
Ãw
 [
moduË_Ën
 + 1];

84 
mem£t
(
mModuËName
, '\0', 
moduË_Ën
 + 1);

85 
memıy
(
mModuËName
, 
d©a
 + 20, 
moduË_Ën
);

87 
	gmPkgL’
 = 
Ën
 - 16 - 
moduË_Ën
;

88 
	gmD©as
 = 
Ãw
 [
mPkgL’
];

89 
mem£t
(
mD©as
, 0, 
mPkgL’
);

90 
memıy
(
mD©as
, 
d©a
 + 12, 4);

91 
memıy
(
mD©as
 + 4, 
d©a
 + 20 + 
moduË_Ën
, 
mPkgL’
 - 4);

93 
	gmTy³
 = 
CONTACT_PKG
;

94 
	gmPkgL’
 = 
Ën
;

95 
	gmD©as
 = 
Ãw
 [
mPkgL’
];

96 
mem£t
(
mD©as
, 0, 
mPkgL’
);

97 
memıy
(
mD©as
, 
d©a
, 
mPkgL’
);

99 
	gd–‘e
[] 
	g´efix
;

102 
g‘Ty³
() {

103  
	gmTy³
;

106 
g‘PkgL’
() {

107  
	gmPkgL’
;

110 
g‘ModuË
(
¡ršg
 &
moduË
) {

111 
	gmoduË
.
assign
(
mModuËName
);

114 *
g‘D©a
() {

115  
	gmD©as
;

119 
H—d”
(cÚ¡ *
moduËName
, *
d©a
, 
size
) {

120 *
	g´efix
 = 
Ãw
 [
¡¾’
(
BLE_CONTACT_PKG
)];

121 
mem£t
(
´efix
, 0, 
¡¾’
(
BLE_CONTACT_PKG
));

122 
memıy
(
´efix
, 
d©a
, 
¡¾’
(
BLE_CONTACT_PKG
));

123 ià(
¡ºÿ£cmp
(
´efix
, 
BLE_CONTACT_PKG
, 
¡¾’
(BLE_CONTACT_PKG)) == 0) {

124 
mTy³
 = 
CONTACT_PKG
;

125 
	gmPkgL’
 = 
size
;

126 
	gmD©as
 = 
Ãw
 [
mPkgL’
];

127 
mem£t
(
mD©as
, 0, 
mPkgL’
);

128 
memıy
(
mD©as
, 
d©a
, 
mPkgL’
);

131 
	gmTy³
 = 
NORMAL_PKG
;

132 
	gmoduË_Ën
 = 
¡¾’
(
moduËName
);

133 
	gmModuËName
 = 
Ãw
 [
moduË_Ën
 + 1];

134 
mem£t
(
mModuËName
, '\0', 
moduË_Ën
 + 1);

135 
memıy
(
mModuËName
, 
moduËName
, 
moduË_Ën
);

137 
	gmPkgL’
 = 
size
 + 16 + 
moduË_Ën
;

139 
	gmD©as
 = 
Ãw
 [
mPkgL’
];

140 
mem£t
(
mD©as
, 0, 
mPkgL’
);

141 
toBy‹s
(
mD©as
);

142 
	gËn
 = 
¡¾’
(
BLE_NORMAL_PKG
);

143 
memıy
(
mD©as
 + 4, 
BLE_NORMAL_PKG
, 
Ën
);

144 
memıy
(
mD©as
 + 4 + 
Ën
, 
d©a
, 4);

145 
memıy
(
mD©as
 + 20, 
moduËName
, 
moduË_Ën
);

146 
memıy
(
mD©as
 + 20 + 
moduË_Ën
, 
d©a
 + 4, 
size
 - 4);

150 
toBy‹s
(*
bufãr
) {

151 
št32_t
 
	gi
 = 8;

152 
	ga
 = ()(
i
 >> 24);

153 
	gb
 = ()(
i
 >> 16);

154 
	gc
 = ()(
i
 >> 8);

155 
	gd
 = ()
i
;

156 
	gbufãr
[0] = 
a
;

157 
	gbufãr
[1] = 
b
;

158 
	gbufãr
[2] = 
c
;

159 
	gbufãr
[3] = 
d
;

160 
št32_t
 
	gmoduË_Ën
 = 
¡¾’
(
mModuËName
);

161 
	ga
 = ()(
moduË_Ën
 >> 24);

162 
	gb
 = ()(
moduË_Ën
 >> 16);

163 
	gc
 = ()(
moduË_Ën
 >> 8);

164 
	gd
 = ()
moduË_Ën
;

165 
	gbufãr
[16] = 
a
;

166 
	gbufãr
[17] = 
b
;

167 
	gbufãr
[18] = 
c
;

168 
	gbufãr
[19] = 
d
;

171 ~
H—d”
() {

172 
	gd–‘e
[] 
	gmD©as
;

175 
	g´iv©e
:

176 
mTy³
;

177 
	gmPkgL’
;

178 *
	gmD©as
;

179 *
	gmModuËName
;

182 
BËPrÙocŞ
 *
	gBËPrÙocŞ
::
	$g‘In¡ªû
() {

183 ià(
sIn¡ªû
 =ğ
NULL
) {

184 
sIn¡ªû
 = 
Ãw
 
	`BËPrÙocŞ
();

186  
sIn¡ªû
;

187 
	}
}

189 
	gBËPrÙocŞ
::
	$BËPrÙocŞ
()

190 : 
	`mIsBšded
(
çl£
),

203 
	`mThœdP¬tyS”v”
(
NULL
),

204 #ifdeà
BLUETOOTH_HILINK_SUPPORT


205 
	`mHškS”v”
(
NULL
),

207 
	`mBlu‘oÙhAdd»ss
("") {

208 
mDBH–³r
 = 
Ãw
 
	`DBH–³r
();

210 
	`­p_bË_£rv”_»gi¡”_wr™e_cback
(
»ûiveWr™eReque¡Cback
);

211 
	`­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
(
ÚCÚÃùiÚS‹Chªge
);

212 #ifdeà
BLUETOOTH_HILINK_SUPPORT


213 
	`hšk_bË_£rv”_»gi¡”_wr™e_cback
(
hškReûiveWr™eReque¡Cback
);

214 
	`hšk_­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
(
hškOnCÚÃùiÚS‹Chªge
);

215 
mHškS”v”
 = 
HškS”v”
::
	`g‘In¡ªû
(
this
);

217 
mThœdP¬tyS”v”
 = 
ThœdP¬tyS”v”
::
	`g‘In¡ªû
(
this
);

218 
	}
}

220 
	gBËPrÙocŞ
::~
	$BËPrÙocŞ
() {

221 
mIsBšded
 = 
çl£
;

222 
mCÚId
 = -1;

223 
mDBH–³r
 = 
NULL
;

224 
	`­p_bË_£rv”_»gi¡”_wr™e_cback
(
NULL
);

225 
	`­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
(
NULL
);

226 #ifdeà
BLUETOOTH_HILINK_SUPPORT


227 
mHškCÚId
[0] = mHilinkConId[1] = mHilinkConId[2] = mHilinkConId[3] = -1;

228 
	`hšk_bË_£rv”_»gi¡”_wr™e_cback
(
NULL
);

229 
	`hšk_­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
(
NULL
);

232 ià(
mThœdP¬tyS”v”
 !ğ
NULL
) {

233 
d–‘e
 
mThœdP¬tyS”v”
;

234 
mThœdP¬tyS”v”
 = 
NULL
;

236 #ifdeà
BLUETOOTH_HILINK_SUPPORT


237 if(
mHškS”v”
 =ğ
NULL
) {

238 
d–‘e
 
mHškS”v”
;

239 
mHškS”v”
 = 
NULL
;

242 
	}
}

244 
	gBËPrÙocŞ
::
	$ÚCÚÃùiÚS‹Chªge
(*
addr
, 
lšk_¡©e
) {

245 ià(
sIn¡ªû
 =ğ
NULL
)

247 
	`ALOGV
("addr:%s,¡©e:%d", 
addr
, 
lšk_¡©e
);

248 ià(
lšk_¡©e
 == 0) {

250 
sIn¡ªû
->
	`unbÚd
();

251 
	`£tBTVisib™y
(
Œue
,rue);

253 
	`£tBTVisib™y
(
çl£
, 
Œue
);

255 
	}
}

256 #ifdeà
BLUETOOTH_HILINK_SUPPORT


257 
	gBËPrÙocŞ
::
	$hškOnCÚÃùiÚS‹Chªge
(*
addr
, 
lšk_¡©e
, 
cÚ_id
, 
£rv”_num
) {

258 ià(
sIn¡ªû
 =ğ
NULL
)

260 
	`ALOGV
("addr:%s,¡©e:%d,cÚ_id:%d,£rv”:%d", 
addr
, 
lšk_¡©e
 ,
cÚ_id
,
£rv”_num
);

261 ià(
lšk_¡©e
 == 0) {

263 if((
£rv”_num
>=0) && (server_num <=4))

264 
sIn¡ªû
->
mHškCÚId
[
£rv”_num
] = -1;

266 
	`£tBTVisib™y
(
Œue
,rue);

267 
	`hškReûiveWr™eReque¡Cback
(-1, 
nuÎ±r
, -1, "bË-şo£_evt-", 
	`¡¾’
("ble-close_evt-"));

269 if((
£rv”_num
>=0) && (server_num <=4))

270 
sIn¡ªû
->
mHškCÚId
[
£rv”_num
] = 
cÚ_id
;

271 
	`£tBTVisib™y
(
çl£
, 
Œue
);

273 
	`ALOGV
("cÚ_id:0->%d, 1->%d, 2->%d, 3->%d",
sIn¡ªû
->
mHškCÚId
[0],sInstance->mHilinkConId[1],sInstance->mHilinkConId[2],sInstance->mHilinkConId[3]);

274 
	}
}

275 
	gBËPrÙocŞ
::
	$hškReûiveWr™eReque¡Cback
(
£rv”_no
, *
add»ss
, 
cÚ_id
, *
d©a
, 
size
) {

276 ià(
sIn¡ªû
 =ğ
NULL
)

281 
	`ALOGD
("mCÚId:%d,cÚ_id:%d!\n", 
sIn¡ªû
->
mCÚId
, 
cÚ_id
);

282 
sIn¡ªû
->
mHškS”v”
->
	`ÚR‘rive
("h",(*)
d©a
, 
size
);

283 
	}
}

285 
	gBËPrÙocŞ
::
	$»ûiveWr™eReque¡Cback
(*
add»ss
, 
cÚ_id
, *
d©a
, 
size
) {

286 ià(
sIn¡ªû
 =ğ
NULL
)

288 
	`ALOGD
("mCÚId:%d,cÚ_id:%d!\n", 
sIn¡ªû
->
mCÚId
, 
cÚ_id
);

289 
Ëngth
 = 0;

290 ià(
	`¡ºÿ£cmp
(
d©a
, 
BLE_BOND_REQ_PREFIX
, 
	`¡¾’
(BLE_BOND_REQ_PREFIX)) == 0) {

292 
	`ALOGD
("recv…hone bond„equest!");

293 
Ëngth
 = 
	`¡¾’
(
BLE_BOND_REQ_PREFIX
);

294 
sIn¡ªû
->
	`´oûssBšdCÚÃùReque¡
(
add»ss
, 
cÚ_id
, 
Ëngth
, 
d©a
, 
Œue
);

295 } ià(
	`¡ºÿ£cmp
(
d©a
, 
BLE_RECONN_REQ_PREFIX
, 
	`¡¾’
(BLE_RECONN_REQ_PREFIX)) == 0) {

297 
	`ALOGD
("recv…hone„econnect„equest!");

298 
Ëngth
 = 
	`¡¾’
(
BLE_RECONN_REQ_PREFIX
);

299 
sIn¡ªû
->
	`´oûssBšdCÚÃùReque¡
(
add»ss
, 
cÚ_id
, 
Ëngth
, 
d©a
, 
çl£
);

300 } ià(
	`¡rcmp
(
d©a
, 
BLE_UNBOND_REQ
) == 0) {

301 
	`ALOGD
("recv…hone unbond„equest !\n");

302 ià(
sIn¡ªû
->
mCÚId
 =ğ-1 || sIn¡ªû->mCÚId !ğ
cÚ_id
)

304 
sIn¡ªû
->
	`»cvUnbÚd
();

305 } ià(
	`¡rcmp
(
d©a
, 
BLE_UNBOND_END_REQ
) == 0) {

306 ià(
sIn¡ªû
->
mCÚId
 =ğ-1 || sIn¡ªû->mCÚId !ğ
cÚ_id
)

308 
sIn¡ªû
->
	`unbÚd
();

310 ià(
sIn¡ªû
->
mCÚId
 =ğ-1 || sIn¡ªû->mCÚId !ğ
cÚ_id
)

313 
sIn¡ªû
->
	`´oûssPackage
(
d©a
, 
size
);

315 
	}
}

317 
	gBËPrÙocŞ
::
	$´oûssPackage
(*
d©a
, 
size
) {

318 
sync
[8 + 1] = {0};

319 ià(
size
 > 12) {

321 
	`memıy
(
sync
, 
d©a
 + 4, 8);

323 ià(
	`¡rcmp
("syncd©a", 
sync
) == 0) {

325 
sIn¡ªû
->
	`·r£rPackage
(
d©a
, 
size
);

326 } ià(
size
 > 10) {

328 
üc
[
LONGDATA_CRC_LENGTH
 + 1];

329 
Ën
 = 
size
 - 
LONGDATA_FLAG_LENGTH
;

330 
v®id
[
Ën
 + 1];

331 
	`memıy
(
üc
, 
d©a
, 
LONGDATA_CRC_LENGTH
);

332 
üc
[
LONGDATA_CRC_LENGTH
] = '\0';

333 
	`memıy
(
v®id
, 
d©a
 + 
LONGDATA_FLAG_LENGTH
, 
Ën
);

334 
v®id
[
Ën
] = '\0';

335 
M­LÚgD©a
::
™”©Ü
 
™_fšd
;

336 
™_fšd
 = 
mM­LÚgD©a
.
	`fšd
(
üc
);

337 ià(
™_fšd
 !ğ
mM­LÚgD©a
.
	`’d
()) {

338 
LÚgSyncD©a
 *
lÚgD©a
 = 
™_fšd
->
£cÚd
;

339 *
»D©a
 = 
lÚgD©a
->
	`g‘ReûiveD©a
();

340 
Ëngth
 = 
lÚgD©a
->
	`g‘Size
();

341 
	`memıy
(
»D©a
 + 
Ëngth
, 
v®id
, 
Ën
);

342 
®»adCouÁ
 = 
lÚgD©a
->
	`g‘ReûiveCouÁ
() + 1;

343 ià(
®»adCouÁ
 =ğ
lÚgD©a
->
	`g‘TÙ®CouÁ
()) {

344 
sIn¡ªû
->
	`·r£rPackage
(
»D©a
, 
Ëngth
 + 
Ën
);

345 
mM­LÚgD©a
.
	`”a£
(
üc
);

347 
lÚgD©a
->
	`£tReûiveCouÁ
(
®»adCouÁ
);

348 
lÚgD©a
->
	`£tSize
(
Ëngth
 + 
Ën
);

351 
LÚgSyncD©a
 *
lÚgSyncD©a
 = 
Ãw
 
	`LÚgSyncD©a
();

352 *
»D©a
 = 
lÚgSyncD©a
->
	`g‘ReûiveD©a
();

353 
	`memıy
(
»D©a
, 
v®id
, 
Ën
);

354 
lÚgSyncD©a
->
	`£tTÙ®CouÁ
(
d©a
[
LONGDATA_CRC_LENGTH
] & 0xFF);

355 
lÚgSyncD©a
->
	`£tReûiveCouÁ
(1);

356 
lÚgSyncD©a
->
	`£tCrc32
(
üc
);

357 
lÚgSyncD©a
->
	`£tSize
(
Ën
);

358 
mM­LÚgD©a
.
	`š£¹
(
M­LÚgD©a
::
	`v®ue_ty³
(
üc
, 
lÚgSyncD©a
));

361 
	}
}

363 
	gBËPrÙocŞ
::
	$´oûssBšdCÚÃùReque¡
(*
add»ss
, 
cÚ_id
, 
Ëngth
, *
d©aBuf
, 
boŞ
 
bšdReque¡
) {

365 
»mÙe_uuid
[
REMOTE_DEVICE_UUID_SIZE
 + 1];

366 
	`mem£t
(
»mÙe_uuid
, 0, 
REMOTE_DEVICE_UUID_SIZE
 + 1);

367 
	`memıy
(
»mÙe_uuid
, 
d©aBuf
 + 
Ëngth
, 
REMOTE_DEVICE_UUID_SIZE
);

369 ià(
	`checkBšdS‹
(
»mÙe_uuid
) == 1) {

371 
	`£ndToSourû
(
cÚ_id
, 
BLE_BOND_OK
, 
	`¡¾’
(BLE_BOND_OK));

372 
mIsBšded
 = 
Œue
;

373 
mCÚId
 = 
cÚ_id
;

374 
mBlu‘oÙhAdd»ss
 = 
add»ss
;

376 
	`­p_bË_wake_cÚfigu»
();

377 
mThœdP¬tyS”v”
->
	`BšdedS‹Chªge
(
Œue
,rue);

378 
	`£tBTVisib™y
(
çl£
, 
Œue
);

379 
	`ALOGI
(" bšd sucûs »mÙe_uuid=%s\n", 
»mÙe_uuid
);

382 
	`£ndToSourû
(
cÚ_id
, 
BLE_BOND_FAILED
, 
	`¡¾’
(BLE_BOND_FAILED));

383 
	`£tBTVisib™y
(
Œue
,rue);

385 
	}
}

387 
	gBËPrÙocŞ
::
	$checkBšdS‹
(cÚ¡ *
»mÙe_addr
) {

388 
t_DB_CONFIG
 
db_cÚfig
;

389 
db_cÚfig
.
bšd_¡©e
 = 0;

390 
	`mem£t
(
db_cÚfig
.
bšd_addr
, 0, (db_config.bind_addr));

391 
mDBH–³r
->
	`»adS‹FromDB
(
db_cÚfig
);

392 ià(
db_cÚfig
.
bšd_¡©e
 && 
	`¡rcmp
(db_cÚfig.
bšd_addr
, 
»mÙe_addr
)) {

393 
	`ALOGW
("has‡lready bind other device\n");

396 
mDBH–³r
->
	`wr™eS‹ToDB
(
Œue
, 
»mÙe_addr
);

398 
	}
}

400 
	gBËPrÙocŞ
::
	$»cvUnbÚd
() {

401 
t_DB_CONFIG
 
db_cÚfig
;

402 
	`mem£t
(
db_cÚfig
.
bšd_addr
, 0, (db_config.bind_addr));

403 
¥
<
DBH–³r
> 
dBH–³r
 = 
Ãw
 
	`DBH–³r
();

404 
dBH–³r
->
	`»adS‹FromDB
(
db_cÚfig
);

405 ià(
	`¡¾’
(
db_cÚfig
.
bšd_addr
è!ğ
REMOTE_DEVICE_UUID_SIZE
) {

409 
	`£ndToSourû
(
mCÚId
, 
BLE_UNBOND_RSP
, 
	`¡¾’
(BLE_UNBOND_RSP));

410 
	}
}

412 
	gBËPrÙocŞ
::
	$unbÚd
() {

413 
	`ALOGV
("ble unbond");

415 
mIsBšded
 = 
çl£
;

416 
mThœdP¬tyS”v”
->
	`BšdedS‹Chªge
(
çl£
, 
Œue
);

417 
	`­p_bË_£rv”_şo£
();

418 
mDBH–³r
->
	`wr™eS‹ToDB
(
çl£
, "");

419 
mCÚId
 = -1;

421 
M­LÚgD©a
::
™”©Ü
 
™
;

422 
™
 = 
mM­LÚgD©a
.
	`begš
(); iˆ!ğmM­LÚgD©a.
	`’d
();) {

423 
mM­LÚgD©a
.
	`”a£
(
™
++);

426 
	}
}

428 
	gBËPrÙocŞ
::
	$·r£rPackage
(*
·ckage
, 
size
) {

430 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(
·ckage
, 
size
);

431 
h—d”
->
	`g‘Ty³
()) {

432 (
H—d”
::
NORMAL_PKG
): {

433 
¡ršg
 
midName
;

434 
h—d”
->
	`g‘ModuË
(
midName
);

435 *
d©a
 = 
h—d”
->
	`g‘D©a
();

436 
size
 = 
h—d”
->
	`g‘PkgL’
();

437 
	`moduËR‘rive
(
midName
.
	`c_¡r
(), 
d©a
, 
size
);

440 (
H—d”
::
CONTACT_PKG
): {

444 
	`ALOGE
("Error:unkonw…kgype!");

446 
h—d”
 = 
NULL
;

447 
	}
}

449 
	gBËPrÙocŞ
::
	$£ndPack‘
(cÚ¡ 
¡ršg
 &
moduËName
, *
d©a
, 
size
) {

451 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(
moduËName
.
	`c_¡r
(), 
d©a
, 
size
);

453 
h—d”
->
	`g‘Ty³
()) {

454 (
H—d”
::
NORMAL_PKG
): {

455 *
d©a
 = 
h—d”
->
	`g‘D©a
();

456 
size
 = 
h—d”
->
	`g‘PkgL’
();

457 
	`£ndToSourû
(
mCÚId
, 
d©a
, 
size
);

460 (
H—d”
::
CONTACT_PKG
): {

464 
	`ALOGE
("Error:unkonw…kgype!");

466 
h—d”
 = 
NULL
;

468 
	}
}

469 #ifdeà
BLUETOOTH_HILINK_SUPPORT


470 
	#IDX_SEND_2_PHONE_SERVER
 0

	)

471 
	gBËPrÙocŞ
::
	$£ndPack‘
(cÚ¡ 
¡ršg
 &
moduËName
, *
d©a
, 
size
, 
boŞ
 
ishšk
) {

472 
»t
;

474 if(
mHškCÚId
[
IDX_SEND_2_PHONE_SERVER
] == -1) {

475 
	`ALOGE
("d©¨size:%d,mHškCÚId[%d]:%d‚Øhšk bË cÚÃùed",
size
, 
IDX_SEND_2_PHONE_SERVER
, 
mHškCÚId
[IDX_SEND_2_PHONE_SERVER]);

476 
»t
 = -1;

478 
	`ALOGD
("d©¨size:%d,mHškCÚId[%d]:%d", 
size
, 
IDX_SEND_2_PHONE_SERVER
, 
mHškCÚId
[IDX_SEND_2_PHONE_SERVER]);

479 
»t
 = 
	`£ndToSourû
(
mHškCÚId
[
IDX_SEND_2_PHONE_SERVER
], 
d©a
, 
size
);

481  
»t
;

482 
	}
}

484 
	gBËPrÙocŞ
::
	$£ndToSourû
(
cÚ_id
, *
d©a
, 
size
) {

485 ià(
cÚ_id
 < 0)

487 
	`­p_bË_£rv”_£nd_šdiÿtiÚ
(
cÚ_id
, 
d©a
, 
size
);

488 
	}
}

490 
boŞ
 
	gBËPrÙocŞ
::
	$g‘BËBšdedS‹
() {

491  
mIsBšded
;

492 
	}
}

494 
	gBËPrÙocŞ
::
	$¡¬tModuË
() {

505 
	}
}

507 
BËPrÙocŞ
::
	$¡İModuË
() {

550 
	}
}

552 
BËPrÙocŞ
::
	$»gi¡”ModuË
(cÚ¡ 
¡ršg
 &
moduË_Çme
, 
SyncModuË
 *
moduË
) {

553 
mModuËM­
.
	`š£¹
(
MODULEMAP
::
	`v®ue_ty³
(
moduË_Çme
, 
moduË
));

554 
	}
}

556 
	gBËPrÙocŞ
::
	$unRegi¡”ModuË
(cÚ¡ 
¡ršg
 &
moduË_Çme
) {

557 
MODULEMAP
::
™”©Ü
 
™
 = 
mModuËM­
.
	`fšd
(
moduË_Çme
);

558 ià(
™
 =ğ
mModuËM­
.
	`’d
()) {

559 
	`ALOGD
("no findhis module\n");

562 
™
->
£cÚd
 = 
NULL
;

563 
mModuËM­
.
	`”a£
(
™
);

564 
	}
}

566 
	gBËPrÙocŞ
::
	$moduËR‘rive
(cÚ¡ *
moduËName
, *
d©a
, 
size
) {

567 
MODULEMAP
::
™”©Ü
 
™
 = 
mModuËM­
.
	`fšd
(
moduËName
);

568 ià(
™
 =ğ
sIn¡ªû
->
mModuËM­
.
	`’d
()) {

570 
mThœdP¬tyS”v”
->
	`ÚR‘rive
(
moduËName
, 
d©a
, 
size
);

572 
¥
<
SyncD©a
> 
syncD©a
 = 
Ãw
 
	`SyncD©a
();

573 
»t
 = 
SyncD©aToŞs
::
	`by‹s2D©a
(
syncD©a
, 
d©a
, 
size
);

575 ià(
»t
 < 0) {

576 
	`ALOGE
("funùiÚ=%s,E¼Ü:syncd©¨·r£¸çed!\n", 
__FUNCTION__
);

578 (
™
->
£cÚd
)->
	`ÚR‘rive
(
syncD©a
);

581 
	}
}

584 
	$BËPrÙocŞ_š¡ªû
(){

585 
ªdroid
::
BËPrÙocŞ
::
	`g‘In¡ªû
();

586 
	}
}

	@incall/InCall.cpp

1 
	#LOG_NDEBUG
 0

	)

2 
	#LOG_TAG
 "InC®l"

	)

4 
	~<fú.h
>

5 
	~<sys/¡©.h
>

6 
	~<mÚ™Ü/ProûssMÚ™Ü.h
>

8 
	~"InC®l.h
"

9 
	#ALOGV
 
´štf


	)

10 
	#ALOGE
 
´štf


	)

12 
Çme¥aû
 
	gªdroid
 {

14 
	gInC®l
::
InC®l
(){

15 
ALOGV
("InCall in");

16 
£tS‹
(
Œue
);

19 
	gInC®l
::~
InC®l
()

21 
£tS‹
(
çl£
);

22 
ALOGV
("~InCall out");

25 
boŞ
 
	gInC®l
::
£tS‹
(boŞ 
isAùive
)

27 
»t
 = -1;

28 if(
	gisAùive
){

29 
	g»t
 = 
£tProûssStus
(
STATUS_INCALL
);

31 
	g»t
 = 
£tProûssStus
(
STATUS_INVALID
);

33 if(
	g»t
 < 0){

34 
ALOGE
("InCall setState failed!");

35  
	gçl£
;

37  
	gŒue
;

	@ohos_bt.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<uni¡d.h
>

5 
	~<dœ’t.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<fú.h
>

9 
	~<sys/time.h
>

10 
	~<sys/wa™.h
>

11 
	~<¡dboŞ.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršgs.h
>

15 
	~"gki.h
"

16 
	~"uc.h
"

18 
	~"b§_dm_­i.h
"

19 
	~"b§_­i.h
"

21 
	~"­p_xml_uts.h
"

23 
	~"­p_disc.h
"

24 
	~"­p_uts.h
"

25 
	~"­p_dm.h
"

26 
	~"­p_bË.h
"

27 
	~"­p_dg.h
"

28 
	~"­p_bË_£rv”.h
"

29 
	~"­p_uts.h
"

31 
	~"­p_£rviûs.h
"

32 
	~"­p_mgt.h
"

33 
	~"­p_th»ad.h
"

34 
	~"­p_mªag”.h
"

36 
	~<¡dboŞ.h
>

37 
	~"ohos_bt_def.h
"

38 
	~"ohos_bt_g©t_£rv”.h
"

39 
	~"ohos_bt_g©t.h
"

41 
	#ALOGE
 
´štf


	)

42 
	#BT_POWER_STATE
 "/sys/şass/rfkl/rfkl0/¡©e"

	)

43 #ifdeà
BLUETOOTH_HILINK_SUPPORT


44 
tAPP_MGR_CB
 
­p_mgr_cb
;

46 
Blu‘oÙhS”v”_š¡ªû
();

48 
mªag”In™
(cÚ¡ * 
Çme
);

49 
BtG©tS”v”C®lbacks
 *
	gbt_ÿÎback
 = 
NULL
;

50 
	gbt_Çme
[128] = "ohos-bt";

51 
	$£tBtPow”EÇbË
(
boŞ
 
’abË
){

52 
bufãr
 = '0';

53 
fd
 = 
	`İ’
(
BT_POWER_STATE
, 
O_WRONLY
);

54 ià(
fd
 < 0){

55 
	`ALOGE
("set_bluetooth_power : open for write failed: %s (%d)",

56 
	`¡»¼Ü
(
”ºo
),ƒrrno);

60 if(
’abË
){

61 
bufãr
 = '1';

63 
sz
 = 
	`wr™e
(
fd
, &
bufãr
, 1);

64 ià(
sz
 < 0) {

65 
	`ALOGE
("set_bluetooth_power : write failed: %s (%d)",

66 
	`¡»¼Ü
(
”ºo
),ƒrrno);

68 
	`şo£
(
fd
);

69 
	}
}

71 
	$¡¬tProfes
(){

72 
»t
 = 0;

73 
¡©us
 = 
	`­p_bË_š™
();

74 ià(
¡©us
 < 0){

75 
	`APP_ERROR0
("Couldn't Initialize BLE !!");

76 
»t
 = -1;

79 
¡©us
 = 
	`­p_bË_¡¬t
();

80 ià(
¡©us
 < 0){

81 
	`APP_ERROR0
("Couldn't Start BLE !!");

82 
»t
 = -1;

84  
»t
;

85 
	}
}

87 
	$¡İProfes
(){

88 
	`­p_bË_ex™
();

89 
	`­p_mgt_şo£
();

90 
	}
}

91 
	$£tBTEÇbË
(
boŞ
 
’abË
)

93 
	`­p_mgr_£t_bt_cÚfig
(
’abË
);

94 
	`£tBtPow”EÇbË
(
’abË
);

95 if(
’abË
)

96 
	`¡¬tProfes
();

98 
	`¡İProfes
();

99 
	}
}

105 
BOOLEAN
 
	$­p_mgr_mgt_ÿÎback
(
tBSA_MGT_EVT
 
ev’t
, 
tBSA_MGT_MSG
 *
p_d©a
)

107 
ev’t
)

109 
BSA_MGT_STATUS_EVT
:

110 
	`APP_DEBUG0
("BSA_MGT_STATUS_EVT");

111 ià(
p_d©a
->
¡©us
.
’abË
)

113 
	`APP_DEBUG0
("Bluetooth„estarted =>„e-initializehe‡pplication");

114 
	`­p_mgr_cÚfig
(
bt_Çme
);

118 
BSA_MGT_DISCONNECT_EVT
:

119 
	`APP_DEBUG1
("---BSA_MGT_DISCONNECT_EVT„—sÚ:%d", 
p_d©a
->
discÚÃù
.
»asÚ
);

120 
	`sy¡em
("killall -2 bsa_server_mips");

122 
pid_t
 
pid
;

123 
pid
 = 
	`fÜk
();

124 ià(
pid
 == -1){

125 
	`APP_ERROR0
("fork failed!");

128 ià(
pid
 == 0) {

129 
	`APP_DEBUG0
("start bsa_server_mips..");

130 
	`exeşp
("/u¤/bš/b§_£rv”_ms", "b§_£rv”_ms","-Ím","-®l=0","-r","14","-d","/dev/‰yS0","-u","/v¬/run/","-p","/fœmw¬e/BCM43455_003.001.025.0160.0303.hcd", 
NULL
);

132 
	`APP_DEBUG0
("signal..");

133 
	`sigÇl
(
SIGCHLD
,
SIG_IGN
);

135 
	`APP_DEBUG1
("bt_Çme:%s", 
bt_Çme
);

136 if(
bt_Çme
 !ğ
NULL
) {

137 if(
	`mªag”In™
(
bt_Çme
) < 0) {

138 
	`APP_ERROR0
("managerInit failed!");

142 if(
	`¡¬tProfes
() < 0) {

143 
	`APP_ERROR0
("startProfiles failed!");

151  
TRUE
;

152 
	}
}

153 
	$mªag”In™
(cÚ¡ * 
Çme
){

154 
mode
;

155 
	`­p_mgt_š™
();

156 ià(
	`­p_mgt_İ’
("/v¬/run/", 
­p_mgr_mgt_ÿÎback
) < 0){

157 
	`APP_ERROR0
("Unableo connecto server");

162 
	`­p_xml_š™
();

163 ià(
	`­p_mgr_cÚfig
(
Çme
)){

164 
	`APP_ERROR0
("Couldn't configure successfully,ƒxiting");

169 
	`­p_mgr_»ad_v”siÚ
();

172 
mode
 = 
	`­p_dm_g‘_du®_¡ack_mode
();

173 ià(
mode
 < 0){

174 
	`APP_ERROR0
("app_dm_get_dual_stack_mode failed");

178 
­p_mgr_cb
.
du®_¡ack_mode
 = 
mode
;

179 
	`APP_INFO1
("Cu¼’ˆDu®Sck mode:%s", 
	`­p_mgr_g‘_du®_¡ack_mode_desc
());

182 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


184 
»t
 = 
	`lßd_šg’ic_audio_oss
();

185 
	`APP_INFO1
("Lßd ing’iøaudiØdev:%d\n",
»t
);

188 
	}
}

199 
	$ev’t_cback
(
tBSA_BLE_EVT
 
ev’t
, 
tBSA_BLE_MSG
 *
p_d©a
) {

200 
num
;

201 
BtReqR—dCbP¬a
 
»adCbP¬a
;

202 
BtReqWr™eCbP¬a
 
wr™eCbP¬a
;

204 if(
bt_ÿÎback
 =ğ
NULL
){

205 
	`´štf
("%s: bt_ÿÎback i nuÎ,‚Ùhšgodo!",
__func__
);

209 
	`´štf
("ev’t_cbackƒv’ˆğ%d ", 
ev’t
);

210 
ev’t
) {

211 
BSA_BLE_SE_CREATE_EVT
:

212 ià(
p_d©a
->
£r_ü—‹
.
¡©us
 =ğ
BSA_SUCCESS
) {

213 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_ü—‹
.
£rv”_if
);

216 ià(
num
 < 0) {

217 
	`APP_ERROR0
("no interface!!");

221 if(
bt_ÿÎback
->
£rviûAddCb
 !ğ
NULL
)

222 
bt_ÿÎback
->
	`£rviûAddCb
(
p_d©a
->
£r_ü—‹
.
¡©us
,…_d©a->£r_ü—‹.
£rviû_id
, 
NULL
, 
num
);

226 
BSA_BLE_SE_ADDCHAR_EVT
:

227 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_addch¬
.
£rv”_if
);

230 ià(
num
 < 0) {

231 
	`APP_ERROR0
("no interface!!");

235 if(
bt_ÿÎback
->
ch¬aù”i¡icAddCb
 !ğ
NULL
)

236 
bt_ÿÎback
->
	`ch¬aù”i¡icAddCb
(
p_d©a
->
£r_addch¬
.
¡©us
,…_d©a->£r_addch¬.
£rviû_id
, 
NULL
, 
num
, 0);

239 
BSA_BLE_SE_START_EVT
:

240 ià(
p_d©a
->
£r_¡¬t
.
¡©us
 =ğ
BSA_SUCCESS
) {

241 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_¡¬t
.
£rv”_if
);

244 ià(
num
 < 0) {

245 
	`APP_ERROR0
("no interface!!");

248 if(
bt_ÿÎback
->
£rviûS¹Cb
 !ğ
NULL
){

249 
bt_ÿÎback
->
	`£rviûS¹Cb
(
p_d©a
->
£r_¡¬t
.
¡©us
,…_d©a->£r_¡¬t.
£rviû_id
, 
num
);

254 
BSA_BLE_SE_READ_EVT
:

255 
	`mem£t
(&
»adCbP¬a
, 0, (readCbPara));

256 
»adCbP¬a
.
cÚnId
 = 
p_d©a
->
£r_»ad
.
cÚn_id
;

257 
»adCbP¬a
.
ŒªsId
 = 
p_d©a
->
£r_»ad
.
Œªs_id
;

258 
»adCbP¬a
.
bdAddr
 = 
p_d©a
->
£r_»ad
.
»mÙe_bda
;

259 
»adCbP¬a
.
©ŒHªdË
 = 
p_d©a
->
£r_»ad
.
hªdË
;

260 
»adCbP¬a
.
off£t
 = 
p_d©a
->
£r_»ad
.offset;

261 
»adCbP¬a
.
isLÚg
 = 
çl£
;

262 if(
bt_ÿÎback
->
»que¡R—dCb
 !ğ
NULL
)

263 
bt_ÿÎback
->
	`»que¡R—dCb
(
»adCbP¬a
);

266 
BSA_BLE_SE_WRITE_EVT
:

267 
	`mem£t
(&
wr™eCbP¬a
, 0, (writeCbPara));

268 
wr™eCbP¬a
.
cÚnId
 = 
p_d©a
->
£r_wr™e
.
cÚn_id
;

269 
wr™eCbP¬a
.
ŒªsId
 = 
p_d©a
->
£r_wr™e
.
Œªs_id
;

270 
wr™eCbP¬a
.
bdAddr
 = 
p_d©a
->
£r_wr™e
.
»mÙe_bda
;

271 
wr™eCbP¬a
.
©ŒHªdË
 = 
p_d©a
->
£r_wr™e
.
hªdË
;

272 
wr™eCbP¬a
.
off£t
 = 
p_d©a
->
£r_wr™e
.offset;

273 
wr™eCbP¬a
.
ÃedR¥
 = 
çl£
;

274 
wr™eCbP¬a
.
isP»p
 = 
çl£
;

275 
Ëngth
 = ()(
p_d©a
->
£r_wr™e
.
Ën
);

276 
Ëngth
 =†’gth > 
BLE_DATA_MAX_SIZE
 * 2 ? BLE_DATA_MAX_SIZE * 2 :†ength;

277 
»que¡_v®ue
[
BLE_DATA_MAX_SIZE
 * 2];

278 
	`mem£t
(
»que¡_v®ue
, 0, 
BLE_DATA_MAX_SIZE
 * 2);

279 
	`memıy
(
»que¡_v®ue
, 
p_d©a
->
£r_wr™e
.
v®ue
, 
Ëngth
);

280 
wr™eCbP¬a
.
Ëngth
 =†ength;

281 
wr™eCbP¬a
.
v®ue
 = 
»que¡_v®ue
;

282 if(
bt_ÿÎback
->
»que¡Wr™eCb
 !ğ
NULL
)

283 
bt_ÿÎback
->
	`»que¡Wr™eCb
(
wr™eCbP¬a
);

286 
BSA_BLE_SE_OPEN_EVT
:

287 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_İ’
.
£rv”_if
);

289 ià(
num
 < 0) {

290 
	`APP_ERROR0
("no interface!!");

293 if(
bt_ÿÎback
->
cÚÃùS”v”Cb
 !ğ
NULL
){

294 
BdAddr
 
bdAddr
;

295 
	`mem£t
(
bdAddr
.
addr
, 0, (bdAddr.addr));

296 
	`memıy
(
bdAddr
.
addr
, 
p_d©a
->
£r_İ’
.
»mÙe_bda
, 
BD_ADDR_LEN
);

297 
bt_ÿÎback
->
	`cÚÃùS”v”Cb
(
p_d©a
->
£r_İ’
.
cÚn_id
, 
num
, &
bdAddr
);

301 
BSA_BLE_SE_CLOSE_EVT
:

302 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_şo£
.
£rv”_if
);

304 ià(
num
 < 0) {

305 
	`APP_ERROR0
("no interface!!");

308 if(
bt_ÿÎback
->
discÚÃùS”v”Cb
 !ğ
NULL
)

309 
bt_ÿÎback
->
	`discÚÃùS”v”Cb
(
p_d©a
->
£r_şo£
.
cÚn_id
, 
num
,…_d©a->£r_şo£.
»mÙe_bda
);

312 
BSA_BLE_SE_CONF_EVT
:

313 
	`APP_INFO1
("BSA_BLE_SE_CONF_EVT stus:%d,cÚn_id:0x%x", 
p_d©a
->
£r_cÚf
.
¡©us
,…_d©a->£r_cÚf.
cÚn_id
);

319 
	}
}

328 
	$In™BtSck
()

330 if(
	`mªag”In™
(
bt_Çme
) < 0) {

331 
	`ALOGE
("\n\nwrong managerInit wrong\n");

332  
OHOS_BT_STATUS_FAIL
;

334 
	`­p_mgr_£t_bt_cÚfig
(
Œue
);

335 
	`£tBtPow”EÇbË
(
Œue
);

336  
OHOS_BT_STATUS_SUCCESS
;

337 
	}
}

346 
	$EÇbËBtSck
()

348 
	`¡¬tProfes
();

349  
OHOS_BT_STATUS_SUCCESS
;

350 
	}
}

359 
	$Di§bËBtSck
()

361  
OHOS_BT_STATUS_SUCCESS
;

362 
	}
}

373 
	$S‘DeviûName
(cÚ¡ *
Çme
, 
Ën
)

375 
»t
 = 
OHOS_BT_STATUS_SUCCESS
;

376 if(
	`­p_mgr_£t_bË_Çme
(
Çme
, 
Ën
)) {

377 
»t
 = 
OHOS_BT_STATUS_FAIL
;

379  
»t
;

380 
	}
}

391 
	$BËS‘AdvD©a
(
advId
, cÚ¡ 
BËCÚfigAdvD©a
 *
d©a
)

394 
tBSA_DM_BLE_ADV_CONFIG
 *
p_d©a
 = (tBSA_DM_BLE_ADV_CONFIG*)
d©a
->
advD©a
;

395 
	`­p_dm_£t_bË_adv_d©a
(
p_d©a
);

396  
OHOS_BT_STATUS_SUCCESS
;

397 
	}
}

408 
	$BËS¹Adv
(
advId
, cÚ¡ 
BËAdvP¬ams
 *
·¿m
)

411 
	`­p_dm_£t_bË_visib™y
(
Œue
,rue);

412 if(
advId
){

413 
	`SµPrÙocŞ_š¡ªû
();

414 
	`BËPrÙocŞ_š¡ªû
();

415 
	`Blu‘oÙhS”v”_š¡ªû
();

418  
OHOS_BT_STATUS_SUCCESS
;

419 
	}
}

429 
	$BËStİAdv
(
advId
)

431 
	`­p_dm_£t_bË_visib™y
(
çl£
, false);

432  
OHOS_BT_STATUS_SUCCESS
;

433 
	}
}

444 
	$BËUpd©eAdv
(
advId
, cÚ¡ 
BËAdvP¬ams
 *
·¿m
)

446  
OHOS_BT_STATUS_SUCCESS
;

447 
	}
}

457 
	$BËS‘Secur™yIoC­
(
BËIoC­Mode
 
mode
)

459  
OHOS_BT_STATUS_SUCCESS
;

460 
	}
}

470 
	$BËS‘Secur™yAuthReq
(
BËAuthReqMode
 
mode
)

472  
OHOS_BT_STATUS_SUCCESS
;

473 
	}
}

485 
	$BËG©tSecur™yR¥
(
BdAddr
 
bdAddr
, 
boŞ
 
acû±
)

487  
OHOS_BT_STATUS_SUCCESS
;

488 
	}
}

499 
	$R—dBtMacAddr
(*
mac
, 
Ën
)

501  
OHOS_BT_STATUS_SUCCESS
;

502 
	}
}

513 
	$BËS‘SÿnP¬am‘”s
(
ş›ÁId
, 
BËSÿnP¬ams
 *
·¿m
)

515  
OHOS_BT_STATUS_SUCCESS
;

516 
	}
}

525 
	$BËS¹Sÿn
()

527  
OHOS_BT_STATUS_SUCCESS
;

528 
	}
}

537 
	$BËStİSÿn
()

539  
OHOS_BT_STATUS_SUCCESS
;

540 
	}
}

550 
	$BËG©tRegi¡”C®lbacks
(
BtG©tC®lbacks
 *
func
)

552  
OHOS_BT_STATUS_SUCCESS
;

553 
	}
}

567 
	$BËS¹AdvEx
(*
advId
, cÚ¡ 
S¹AdvRawD©a
 
¿wD©a
, 
BËAdvP¬ams
 
advP¬am
)

569  
OHOS_BT_STATUS_SUCCESS
;

570 
	}
}

583 
	$BËG©tsRegi¡”
(
BtUuid
 
­pUuid
)

585 
uuid
 = 
	`©oi
(
­pUuid
.uuid);

586 
	`´štf
("===>>%s:uuid=%u,%x\n",
__func__
,
uuid
,uuid);

587 
	`­p_bË_£rv”_»gi¡”
(
uuid
, 
ev’t_cback
);

588  
OHOS_BT_STATUS_SUCCESS
;

589 
	}
}

599 
	$BËG©tsUnRegi¡”
(
£rv”Id
)

601 
bt_ÿÎback
 = 
NULL
;

602  
OHOS_BT_STATUS_SUCCESS
;

603 
	}
}

615 
	$BËG©tsDiscÚÃù
(
£rv”Id
, 
BdAddr
 
bdAddr
, 
cÚnId
)

617  
OHOS_BT_STATUS_SUCCESS
;

618 
	}
}

636 
	$BËG©tsAddS”viû
(
£rv”Id
, 
BtUuid
 
¤vcUuid
, 
boŞ
 
isPrim¬y
, 
numb”
)

638 
	`­p_bË_£rv”_ü—‹_£rviû
(
£rv”Id
, 
¤vcUuid
.
uuid
, 
isPrim¬y
, 
numb”
);

639  
OHOS_BT_STATUS_SUCCESS
;

640 
	}
}

654 
	$BËG©tsAddInşudedS”viû
(
£rv”Id
, 
¤vcHªdË
, 
šşudedHªdË
)

656  
OHOS_BT_STATUS_SUCCESS
;

657 
	}
}

675 
	$BËG©tsAddCh¬aù”i¡ic
(
£rv”Id
, 
¤vcHªdË
, 
BtUuid
 
ch¬acUuid
,

676 
´İ”t›s
, 
³rmissiÚs
)

678 
	`­p_bË_£rv”_add_ch¬
(
£rv”Id
, 
¤vcHªdË
, 
ch¬acUuid
.
uuid
, 
´İ”t›s
, 
³rmissiÚs
);

679  
OHOS_BT_STATUS_SUCCESS
;

680 
	}
}

696 
	$BËG©tsAddDesütÜ
(
£rv”Id
, 
¤vcHªdË
, 
BtUuid
 
descUuid
, 
³rmissiÚs
)

698  
OHOS_BT_STATUS_SUCCESS
;

699 
	}
}

710 
	$BËG©tsS¹S”viû
(
£rv”Id
, 
¤vcHªdË
)

712 
	`­p_bË_£rv”_¡¬t_£rviû
(
£rv”Id
, 
¤vcHªdË
);

713  
OHOS_BT_STATUS_SUCCESS
;

714 
	}
}

725 
	$BËG©tsStİS”viû
(
£rv”Id
, 
¤vcHªdË
)

727  
OHOS_BT_STATUS_SUCCESS
;

728 
	}
}

739 
	$BËG©tsD–‘eS”viû
(
£rv”Id
, 
¤vcHªdË
)

741  
OHOS_BT_STATUS_SUCCESS
;

742 
	}
}

752 
	$BËG©tsCË¬S”viûs
(
£rv”Id
)

754  
OHOS_BT_STATUS_SUCCESS
;

755 
	}
}

766 
	$BËG©tsS’dRe¥Ú£
(
£rv”Id
, 
G©tsS’dR¥P¬am
 *
·¿m
)

768  
OHOS_BT_STATUS_SUCCESS
;

769 
	}
}

782 
	$BËG©tsS’dIndiÿtiÚ
(
£rv”Id
, 
G©tsS’dIndP¬am
 *
·¿m
)

784  
OHOS_BT_STATUS_SUCCESS
;

785 
	}
}

796 
	$BËG©tsS‘Enüy±iÚ
(
BdAddr
 
bdAddr
, 
BËSecAù
 
£cAù
)

798  
OHOS_BT_STATUS_SUCCESS
;

799 
	}
}

809 
	$BËG©tsRegi¡”C®lbacks
(
BtG©tS”v”C®lbacks
 *
func
)

811 
bt_ÿÎback
 = 
func
;

812  
OHOS_BT_STATUS_SUCCESS
;

813 
	}
}

827 
	$BËG©tsS¹S”viûEx
(*
¤vcHªdË
, 
BËG©tS”viû
 *
¤vcInfo
)

829  
OHOS_BT_STATUS_SUCCESS
;

830 
	}
}

842 
	$BËG©tsStİS”viûEx
(
¤vcHªdË
)

844  
OHOS_BT_STATUS_SUCCESS
;

845 
	}
}

	@protocol/DBHelper.cpp

1 
	#LOG_NDEBUG
 0

	)

2 
	#LOG_TAG
 "DBH–³r"

	)

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<”ºo.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ty³s.h
>

9 
	~<dœ’t.h
>

11 
	~<uts/Log.h
>

12 
	~"DBH–³r.h
"

14 
	#DB_DIR_PATH
 "/u¤/d©a/d©aba£/"

	)

15 
	#DB_CONFIG_FILE_PATH
 "/u¤/d©a/d©aba£/bt_db.xml"

	)

17 
Çme¥aû
 
	gªdroid
{

19 
	gDBH–³r
::
wr™eS‹ToDB
(
boŞ
 
bšd_¡©e
, cÚ¡ * 
bšd_addr
)

21 ià(!
checkD©aba£Dœ
()) {

22 
ALOGE
("ÿn'ˆmkdœ f•(%s)", 
DB_DIR_PATH
);

26 
FILE
* 
	gpFe
 = 
fİ’
(
DB_CONFIG_FILE_PATH
,"w+");

27 ià(
	gNULL
 =ğ
pFe
) {

28 
ALOGE
("ÿn'ˆİ’ f•(%s)", 
DB_CONFIG_FILE_PATH
);

32 
t_DB_CONFIG
 
	gcfg
;

33 
	gcfg
.
	gbšd_¡©e
 = 
bšd_¡©e
;

34 
mem£t
(
cfg
.
bšd_addr
, 0, (cfg.bind_addr));

35 
¡ºıy
(
cfg
.
bšd_addr
, bind_addr,

36 
¡¾’
(
bšd_addr
è> 0 ? sŒËn(bšd_addrè: sŒËn(
cfg
.bind_addr));

38 if(
fwr™e
(&
cfg
, (
t_DB_CONFIG
), 1, 
pFe
)){

39 
fşo£
(
pFe
);

43 
fşo£
(
pFe
);

47 
	gDBH–³r
::
»adS‹FromDB
(
t_DB_CONFIG
 & 
cfg
)

49 
FILE
* 
pFe
 = 
fİ’
(
DB_CONFIG_FILE_PATH
,"r+");

50 ià(
	gNULL
 =ğ
pFe
) {

51 
ALOGE
("ÿn'ˆİ’ f•(%s)", 
DB_CONFIG_FILE_PATH
);

55 if(
ä—d
(&
cfg
, (
t_DB_CONFIG
), 1, 
pFe
è!ğ1 && 
ã¼Ü
(pFile)) {

56 
ALOGE
("read dbƒrror");

57 
fşo£
(
pFe
);

61 
ALOGD
("»ad d©¨: %d\n", 
cfg
.
bšd_¡©e
);

63 
ALOGD
("read‡ddr : %02x:%02x:%02x:%02x:%02x:%02x\n",

64 0xFF & 
cfg
.
bšd_addr
[0], 0xFF & cfg.bind_addr[1],

65 0xFF & 
cfg
.
bšd_addr
[2], 0xFF & cfg.bind_addr[3],

66 0xFF & 
cfg
.
bšd_addr
[4], 0xFF & cfg.bind_addr[5]);

68 
fşo£
(
pFe
);

73 
boŞ
 
	gDBH–³r
::
checkD©aba£Dœ
(){

74 
DIR
 *
dœ±r
;

75 ià((
	gdœ±r
 = 
İ’dœ
(
DB_DIR_PATH
)è=ğ
NULL
) {

76 
»t
 = 
mkdœ
(
DB_DIR_PATH
, 0775);

77 ià(
	g»t
 < 0) {

78 
ALOGE
(" Creat database…ath Failed");

79  
	gçl£
;

82 
şo£dœ
(
dœ±r
);

83  
	gŒue
;

	@protocol/SppProtocol.cpp

5 
	#LOG_NDEBUG
 0

	)

6 
	#LOG_TAG
 "SµPrÙocŞ"

	)

8 
	~<uni¡d.h
>

9 
	~<fú.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dšt.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~<sys/un.h
>

16 
	~<io¡»am
>

17 
	~<uts/Log.h
>

18 
	~<S‘tšgsDB.h
>

22 #ifdeà
__ılu¥lus


26 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

29 
­p_dg_£nd
(
cÚ_id
, * 
d©a
, 
size
);

30 
­p_dg_»gi¡”_d©a_cback
(*
u£r
, (*
»ûiveSµD©aCback
)(*u£r, 
cÚn_id
, * 
d©a
, 
size
));

31 
­p_dg_»gi¡”_lšk_¡©e_cback
(*
u£r
, (*
lškS‹Cback
)(*u£r,
cÚ_id
, 
boŞ
 
lšked
,* 
»mÙe_addr
, 
size
));

32 
SµPrÙocŞ_š¡ªû
();

33 #ifdeà
__ılu¥lus


37 
	~"SµPrÙocŞ.h
"

38 
	~"SyncD©aToŞs.h
"

39 
	~"UnBšdModuË.h
"

42 
	#CONFIG_SIZE
 36

	)

43 
	#NEG_SIZE
 2

	)

44 
	#HEADER_SIZE
 2

	)

45 
	#EXTRA_HEADER_SIZE
 16

	)

46 
	#MAC_ADDRESS_SIZE
 6

	)

47 
usšg
 
Çme¥aû
 
	g¡d
;

48 
Çme¥aû
 
	gªdroid
 {

50 
SµPrÙocŞ
* 
	gSµPrÙocŞ
::
sIn¡ªû
 = 
NULL
;

53 cÚ¡ 
¡ršg
 
	gMODULE_UNBIND
 = "system_module";

54 cÚ¡ 
¡ršg
 
	gUNBIND_TYPE
 = "unbind";

55 cÚ¡ 
¡ršg
 
	gMODULE_SYSTEM
 = "SYSTEM";

57 şas 
	cNeg
 : 
public
 
RefBa£
{

58 
public
:

60 cÚ¡ 
SUCCESS
 = 0;

61 cÚ¡ 
	gFAIL_ADDRESS_MISMATCH
 = 1;

62 cÚ¡ 
	gFAIL_VERSION_MISMATCH
 = 2;

65 
Neg
(
boŞ
 
·ss
, 
»asÚ
) {

66 
	gmACK2
 = 
Œue
;

67 
	gmPass
 = 
·ss
;

68 
	gmR—sÚ
 = 
»asÚ
;

71 
toBy‹s
(* 
bufãr
) {

72 
	gbufãr
[0] = (è
mACK2
 << 6;

73 ià(
	gmPass
) {

74 
	gbufãr
[1] = () (1 << 7);

76 
	gbufãr
[1] = (è
mR—sÚ
;

81 
Neg
(* 
d©a
) {

82 
	gmACK2
 = (
d©a
[0] & 0x40);

83 
	gmPass
 = 
mACK2
 && (((
d©a
[1] & 0xff) >> 7) == 1);

84 
	gmR—sÚ
 = 
mACK2
 ? (
d©a
[1] & 0x7f) : -1;

87 
boŞ
 
isACK2
() {

88  
	gmACK2
;

90 
boŞ
 
isPass
() {

91  
	gmPass
;

94 * 
g‘R—sÚ
() {

95 if(
	gmR—sÚ
 =ğ
FAIL_ADDRESS_MISMATCH
)

97 if(
	gmR—sÚ
 =ğ
FAIL_VERSION_MISMATCH
)

103 ~
Neg
(){

106 
	g´iv©e
:

107 
boŞ
 
mACK2
;

108 
boŞ
 
	gmPass
;

109 
	gmR—sÚ
;

112 şas 
	cH—d”
 : 
public
 
RefBa£
{

113 
public
:

115 cÚ¡ 
PKG
 = 0x0;

116 cÚ¡ 
	gCFG
 = 0x1;

117 cÚ¡ 
	gNEG
 = 0x2;

120 
H—d”
 (*
d©a
) {

121 
	ga
 = 
d©a
[0];

122 
	gb
 = 
d©a
[1];

123 
	gmPkgL’
 = ((
a
 & 0x3fè<< 8è| (
b
 & 0xff);

124 
	gmTy³
 = (
a
 & (0xc0)) >> 6;

127 
g‘Ty³
(){

128  
	gmTy³
;

131 
g‘PkgL’
(){

132  
	gmPkgL’
;

136 
H—d”
 (
ty³
, 
Ën
) {

137 
	gmTy³
 = 
ty³
;

138 
	gmPkgL’
 = 
Ën
;

141 
toBy‹s
(* 
bufãr
) {

142 
	gi
 = (
mTy³
 << 14è| 
mPkgL’
;

143 
	ga
 = (è(
i
 >> 8);

144 
	gb
 = (è
i
;

145 
	gbufãr
[0] = 
a
;

146 
	gbufãr
[1] = 
b
;

149 ~
H—d”
(){

152 
	g´iv©e
:

153 
mTy³
;

154 
	gmPkgL’
;

157 şas 
	cExŒaH—d”
 : 
public
 
RefBa£
{

158 
public
:

159 cÚ¡ 
TYPE_USER_DATA
 = 0;

160 cÚ¡ 
	gTYPE_ACK
 = 1;

162 cÚ¡ 
	gMEMBER_NUM
 = 3;

163 cÚ¡ 
	gBYTES_PER_MEMBER
 = 4;

166 
ExŒaH—d”
 (* 
by‹s
) {

167 * 
	gh—d”D©a
 = 
by‹s
+
BYTES_PER_MEMBER
;

168 * 
	gmem
 = 
Ãw
 [
MEMBER_NUM
];

169 
	gi
 = 0; i < 
	gMEMBER_NUM
; i++) {

170 
	gmem
[
i
] = 
»adIÁ
(
h—d”D©a
, 
BYTES_PER_MEMBER
*i);

173 
	gmmD©aTy³
 = 
mem
[0];

174 
	gmmS”ŸlNum
 = 
mem
[1];

175 
	gmmD©aL’
 = 
mem
[2];

176 
	gd–‘e
 []
	gmem
;

179 
g‘D©aL’
(){

180  
	gmmD©aL’
;

183 
g‘D©aTy³
(){

184  
	gmmD©aTy³
;

188 
ExŒaH—d”
 (
ty³
, 
num
, 
d©aL’
) {

189 
	gmmD©aTy³
 = 
ty³
;

190 
	gmmS”ŸlNum
 = 
num
;

191 
	gmmD©aL’
 = 
d©aL’
;

194 
toBy‹s
(* 
bufãr
) {

195 
wr™eIÁ
(
bufãr
, 
BYTES_PER_MEMBER
*0, 
MEMBER_NUM
*BYTES_PER_MEMBER);

196 
wr™eIÁ
(
bufãr
, 
BYTES_PER_MEMBER
*1, 
mmD©aTy³
);

197 
wr™eIÁ
(
bufãr
, 
BYTES_PER_MEMBER
*2, 
mmS”ŸlNum
);

198 
wr™eIÁ
(
bufãr
, 
BYTES_PER_MEMBER
*3, 
mmD©aL’
);

201 ~
ExŒaH—d”
(){

204 
	g´iv©e
:

205 
mmD©aTy³
;

206 
	gmmS”ŸlNum
;

207 
	gmmD©aL’
;

209 
»adIÁ
(* 
buf
, 
off£t
) {

210 
	gv®
 = ((
buf
[
off£t
]&0xff)

211 | ((
buf
[
off£t
+1]&0xff) << 8)

212 | ((
buf
[
off£t
+2]&0xff) << 16)

213 | ((
buf
[
off£t
+3]&0xff) << 24));

214  
	gv®
;

217 
wr™eIÁ
(* 
buf
, 
off£t
, 
v®ue
) {

218 
	gbuf
[
off£t
] = (è(
v®ue
);

219 
	gbuf
[
off£t
+1] = (è(
v®ue
 >> 8);

220 
	gbuf
[
off£t
+2] = (è(
v®ue
 >> 16);

221 
	gbuf
[
off£t
+3] = (è(
v®ue
 >> 24);

226 
	gSµPrÙocŞ
::
	$SµPrÙocŞ
()

227 : 
	`mCfgWa™D©a
(
çl£
),

228 
	`mCÚId
(-1),

229 
	`mLeáL’gth
(0),

243 
	$mThœdP¬tyS”v”
(
NULL
)

245 
mIsBšded
 = 
çl£
;

246 
mLeáD©a
 = 
Ãw
 [2048]();

247 
mDBH–³r
 = 
Ãw
 
	`DBH–³r
();

249 
UnBšdModuË
::
	`g‘In¡ªû
(
this
);

251 
	`­p_dg_»gi¡”_d©a_cback
(
this
,
»ûiveWr™eReque¡Cback
);

252 
	`­p_dg_»gi¡”_lšk_¡©e_cback
(
this
,
lškS‹Cback
);

254 
mThœdP¬tyS”v”
 = 
ThœdP¬tyS”v”
::
	`g‘In¡ªû
(
this
);

255 
	}
}

257 
	gSµPrÙocŞ
::~
	$SµPrÙocŞ
() {

258 
mDBH–³r
 = 
NULL
;

259 
	`­p_dg_»gi¡”_d©a_cback
(
this
,
NULL
);

260 
	`­p_dg_»gi¡”_lšk_¡©e_cback
(
this
,
NULL
);

262 
d–‘e
 []
mLeáD©a
;

263 if(
mThœdP¬tyS”v”
 !ğ
NULL
){

264 
d–‘e
 
mThœdP¬tyS”v”
;

265 
mThœdP¬tyS”v”
 = 
NULL
;

267 
	}
}

269 
SµPrÙocŞ
* 
	gSµPrÙocŞ
::
	$g‘In¡ªû
()

271 if(
sIn¡ªû
 =ğ
NULL
){

272 
sIn¡ªû
 = 
Ãw
 
	`SµPrÙocŞ
();

274  
sIn¡ªû
;

275 
	}
}

277 
	gSµPrÙocŞ
::
	$´oûssBšdReque¡
(
cÚ_id
, * 
»mÙe_addr
, 
size
){

278 
Ëngth
 = 
EXTRA_HEADER_SIZE
+
HEADER_SIZE
+
NEG_SIZE
;

279 *
buf
 = 
Ãw
 [
Ëngth
];

280 
¥
<
Neg
> 
Ãg
 ;

281 if(!
	`checkBšdS‹
(
»mÙe_addr
)){

283 
¥
<
ExŒaH—d”
> 
exŒaH—d”
 = 
Ãw
 
	`ExŒaH—d”
(ExŒaH—d”::
TYPE_USER_DATA
,1,
HEADER_SIZE
+
NEG_SIZE
);

284 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(H—d”::
NEG
,
NEG_SIZE
);

285 
Ãg
 = 
Ãw
 
	`Neg
(
çl£
,
Neg
::
FAIL_ADDRESS_MISMATCH
);

286 
exŒaH—d”
->
	`toBy‹s
(
buf
);

287 
h—d”
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
);

288 
Ãg
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
+
HEADER_SIZE
);

289 
	`£ndToSourû
(
mCÚId
, 
buf
, 
Ëngth
);

290 
	`ALOGW
("has‡lready bind other device");

292 
	`ALOGI
(" bšd sucûs »mÙe_addr=%s",
»mÙe_addr
);

293 
¥
<
ExŒaH—d”
> 
exŒaH—d”
 = 
Ãw
 
	`ExŒaH—d”
(ExŒaH—d”::
TYPE_USER_DATA
,1,
HEADER_SIZE
+
NEG_SIZE
);

294 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(H—d”::
NEG
,
NEG_SIZE
);

295 
Ãg
 = 
Ãw
 
	`Neg
(
Œue
,0);

296 
exŒaH—d”
->
	`toBy‹s
(
buf
);

297 
h—d”
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
);

298 
Ãg
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
+
HEADER_SIZE
);

300 
mIsBšded
 = 
Œue
;

301 
mThœdP¬tyS”v”
->
	`BšdedS‹Chªge
(
Œue
,
çl£
);

302 
mCÚId
 = 
cÚ_id
;

303 
mLeáL’gth
 = 0;

304 
	`£ndToSourû
(
mCÚId
, 
buf
, 
Ëngth
);

305 
	`£tBTVisib™y
(
çl£
, 
Œue
);

308 
d–‘e
 []
buf
;

309 
	}
}

311 
	gSµPrÙocŞ
::
	$checkBšdS‹
(cÚ¡ *
»mÙe_addr
)

313 
t_DB_CONFIG
 
db_cÚfig
;

314 
db_cÚfig
.
bšd_¡©e
 = 0;

315 
	`mem£t
(
db_cÚfig
.
bšd_addr
, 0, (db_config.bind_addr));

316 
mDBH–³r
->
	`»adS‹FromDB
(
db_cÚfig
);

317 ià(
db_cÚfig
.
bšd_¡©e
 && 
	`¡ºcmp
(db_cÚfig.
bšd_addr
, 
»mÙe_addr
, 
MAC_ADDRESS_SIZE
)) {

318 
	`ALOGD
("has‡lready bind other device\n");

321 
mDBH–³r
->
	`wr™eS‹ToDB
(
Œue
, 
»mÙe_addr
);

323 
	}
}

325 
	gSµPrÙocŞ
::
	$lškS‹Cback
(*
u£r
,
cÚ_id
, 
boŞ
 
lšked
,* 
»mÙe_addr
, 
size
){

326 
SµPrÙocŞ
 *
¥p
 = (SµPrÙocŞ *è
u£r
;

327 
	`ALOGV
("lškS‹Cback†šked=%d",
lšked
);

328 if(
lšked
){

330 
¥p
->
	`´oûssBšdReque¡
(
cÚ_id
, 
»mÙe_addr
, 
size
);

333 if(
¥p
->
mIsBšded
)

334 
¥p
->
	`»£tBšdS‹
();

336 
	}
}

338 
	gSµPrÙocŞ
::
	$»ûiveWr™eReque¡Cback
(*
u£r
, 
cÚ_id
, * 
d©a
, 
size
){

339 
SµPrÙocŞ
 *
¥p
 = (SµPrÙocŞ *è
u£r
;

340 
	`ALOGV
("SµPrÙocŞ mCÚId=%d,cÚ_id:%d,size:%d\n",
¥p
->
mCÚId
,
cÚ_id
,
size
);

342 if(
size
 < 
EXTRA_HEADER_SIZE
){

343 
	`ALOGE
("receive data is invalid,drop it!");

345 
¥p
->
	`·r£rExŒaH—d”
(
d©a
,
size
);

347 
	}
}

349 
	gSµPrÙocŞ
::
	$·r£rExŒaH—d”
(*
buf
,
size
) {

350 
Ëngth
 = 0;

351 
šdex
 = 0;

352 *
d©abuf
 = 
Ãw
 [
mLeáL’gth
 + 
size
]();

353 if(
mLeáL’gth
 > 0){

354 
	`memıy
(
d©abuf
, 
mLeáD©a
, 
mLeáL’gth
);

355 
	`memıy
(
d©abuf
 + 
mLeáL’gth
, 
buf
, 
size
);

356 
Ëngth
 = 
mLeáL’gth
 + 
size
;

357 
mLeáL’gth
 = 0;

359 
	`memıy
(
d©abuf
, 
buf
, 
size
);

360 
Ëngth
 = 
size
;

362 ;
Ëngth
 > 
EXTRA_HEADER_SIZE
;){

363 
exŒaH—d”Buf
[
EXTRA_HEADER_SIZE
]={0};

364 
	`memıy
(
exŒaH—d”Buf
, 
d©abuf
 + 
šdex
, 
EXTRA_HEADER_SIZE
);

365 
¥
<
ExŒaH—d”
> 
exŒaH—d”
 = 
Ãw
 
	`ExŒaH—d”
(
exŒaH—d”Buf
);

366 
d©aL’
 = 
exŒaH—d”
->
	`g‘D©aL’
();

367 if(
Ëngth
 - 
EXTRA_HEADER_SIZE
 >ğ
d©aL’
){

368 
šdex
 +ğ
EXTRA_HEADER_SIZE
;

369 
	`·r£rPackageH—d”
(
d©abuf
 + 
šdex
,
d©aL’
);

370 
šdex
 +ğ
d©aL’
;

371 
Ëngth
 =†’gth - 
EXTRA_HEADER_SIZE
 - 
d©aL’
;

373 
	`mem£t
(
mLeáD©a
, 0, 
	`¡¾’
(mLeftData));

374 
	`memıy
(
mLeáD©a
, 
d©abuf
 + 
šdex
, 
Ëngth
);

377 
exŒaH—d”
 = 
NULL
;

379 
mLeáL’gth
 = 
Ëngth
;

380 
d–‘e
 []
d©abuf
;

381 
	}
}

383 
	gSµPrÙocŞ
::
	$·r£rPackageH—d”
(*
·ckage
,
size
) {

384 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(
·ckage
);

385 * 
d©a
 = 
·ckage
 + 
HEADER_SIZE
;

386 
d©aSize
 = 
size
 - 
HEADER_SIZE
;

388 
h—d”
->
	`g‘Ty³
()){

389 (
H—d”
::
NEG
):{

391 
¥
<
Neg
> 
Ãg
 = 
Ãw
 
	`Neg
(
d©a
);

392 if(
Ãg
->
	`isACK2
(è=ğ
çl£
){

393 
	`ALOGE
("Error:no support‚o-ACK2 Neg‚ow!\n");

396 if(
Ãg
->
	`isPass
()){

397 
	`ALOGD
("connect success!\n");

399 
	`ALOGE
("cÚÃù faed.„—sÚ=%s\n",
Ãg
->
	`g‘R—sÚ
());

404 (
H—d”
::
CFG
):{

405 
mCfg
 = 
Ãw
 
	`Cfg
(
d©a
,
d©aSize
);

406 
mCfgWa™D©a
 = 
Œue
;

409 (
H—d”
::
PKG
):{

410 if(
mCfgWa™D©a
 =ğ
çl£
){

411 
	`ALOGE
("Error:no cfg data.lost…ackage.\n");

414 
mCfgWa™D©a
 = 
çl£
;

416 
¡ršg
 
midName
 ;

417 
mCfg
->
	`g‘ModuË
(
midName
);

418 if(
midName
.
	`com·»
(
MODULE_SYSTEM
)==0){

419 
	`ALOGE
("SYSTEM ignore !\n");

422 
	`ALOGD
("·r£rPackageH—d” midNam=%s",
midName
.
	`c_¡r
());

423 
	`moduËR‘rive
(
midName
.
	`c_¡r
(),
d©a
,
d©aSize
);

424 
mCfg
 = 
NULL
;

428 
	`ALOGE
("Error:unkonw…kgype!\n");

430 
	}
}

432 
	gSµPrÙocŞ
::
	$£ndPack‘
(cÚ¡ 
¡ršg
 & 
moduËName
,* 
d©a
,
size
){

433 
	`ALOGV
("SµPrÙocŞ::£ndPack‘ iÀsize=%d\n",
size
);

434 if(!
mIsBšded
 || 
size
 <= 0) -1;

436 
h—d”Size
 = 
EXTRA_HEADER_SIZE
+
HEADER_SIZE
;

437 
Ëngth
 = 
EXTRA_HEADER_SIZE
+
HEADER_SIZE
+
CONFIG_SIZE
;

438 * 
buf
 = 
Ãw
 [
Ëngth
]();

439 
¥
<
ExŒaH—d”
> 
exŒaH—d”
 = 
Ãw
 
	`ExŒaH—d”
(ExŒaH—d”::
TYPE_USER_DATA
,1,
HEADER_SIZE
+
CONFIG_SIZE
);

440 
¥
<
H—d”
> 
h—d”
 = 
Ãw
 
	`H—d”
(H—d”::
CFG
,
CONFIG_SIZE
);

441 
exŒaH—d”
->
	`toBy‹s
(
buf
);

442 
h—d”
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
);

444 
Cfg
::
	`Cfg2By‹s
(
CHANNEL_SPEICAL
,
çl£
,çl£,çl£,çl£,
moduËName
,
size
,"",
buf
+
h—d”Size
);

446 
	`£ndToSourû
(
mCÚId
, 
buf
, 
Ëngth
);

447 
d–‘e
 []
buf
;

448 
h—d”
 = 
NULL
;

449 
exŒaH—d”
=
NULL
;

452 
Ëngth
 = 
EXTRA_HEADER_SIZE
+
HEADER_SIZE
+
size
;

453 
buf
 = 
Ãw
 [
Ëngth
]();

454 
exŒaH—d”
 = 
Ãw
 
	`ExŒaH—d”
(
ExŒaH—d”
::
TYPE_USER_DATA
,1,
HEADER_SIZE
+
size
);

455 
h—d”
 = 
Ãw
 
	`H—d”
(
H—d”
::
PKG
,
size
);

456 
exŒaH—d”
->
	`toBy‹s
(
buf
);

457 
h—d”
->
	`toBy‹s
(
buf
+
EXTRA_HEADER_SIZE
);

458 
	`memıy
(&
buf
[
h—d”Size
],
d©a
,
size
);

459 
	`£ndToSourû
(
mCÚId
, 
buf
, 
Ëngth
);

460 
d–‘e
 []
buf
;

461 if(
	`¡rcmp
(
MODULE_UNBIND
.
	`c_¡r
(), 
moduËName
.c_str()) == 0){

462 
mIsBšded
 = 
çl£
;

463 
mThœdP¬tyS”v”
->
	`BšdedS‹Chªge
(
çl£
,false);

467 
	}
}

469 
	gSµPrÙocŞ
::
	$£ndToSourû
(
cÚ_id
, * 
d©a
, 
size
)

471 if(
mIsBšded
 =ğ
çl£
){

472 
	`ALOGW
("send data failed.device is unbind‚ow");

476 if(
cÚ_id
 < 0)  -1;

477  
	`­p_dg_£nd
(
cÚ_id
, 
d©a
, 
size
);

478 
	}
}

480 
boŞ
 
	gSµPrÙocŞ
::
	$g‘SµBšdedS‹
(){

481  
mIsBšded
;

482 
	}
}

484 
	gSµPrÙocŞ
::
	$»£tBšdS‹
()

486 
¥
<
SyncD©a
> 
d©a
 = 
Ãw
 
	`SyncD©a
();

487 
d©a
->
	`putBoŞ—n
(
UNBIND_TYPE
, 
Œue
);

488 
UnBšdModuË
 *
moduË
 = UnBšdModuË::
	`g‘In¡ªû
(
this
);

489 
moduË
->
	`£nd
(
d©a
);

490 
mDBH–³r
->
	`wr™eS‹ToDB
(
çl£
, "");

491 
	`£tBTVisib™y
(
Œue
,rue);

493 
mIsBšded
 = 
çl£
;

494 
	}
}

496 
	gSµPrÙocŞ
::
	$discÚÃù
()

498 
	`ALOGV
("disconnect");

500 
	`»£tBšdS‹
();

501 
	}
}

503 
	gSµPrÙocŞ
::
	$¡¬tModuË
(){

515 
	}
}

517 
SµPrÙocŞ
::
	$¡İModuË
(){

564 
	}
}

566 
SµPrÙocŞ
::
	$»gi¡”ModuË
(cÚ¡ 
¡ršg
 & 
moduË_Çme
, 
SyncModuË
* 
moduË
){

567 
mModuËM­
.
	`š£¹
(
MODULEMAP
::
	`v®ue_ty³
(
moduË_Çme
, 
moduË
));

568 
	}
}

570 
	gSµPrÙocŞ
::
	$unRegi¡”ModuË
(cÚ¡ 
¡ršg
 & 
moduË_Çme
){

571 
MODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
	`fšd
(
moduË_Çme
);

572 if(
™
 =ğ
mModuËM­
.
	`’d
()) {

573 
	`ALOGE
("no findhis module\n");

576 
™
->
£cÚd
 = 
NULL
;

577 
mModuËM­
.
	`”a£
(
™
);

578 
	}
}

580 
	gSµPrÙocŞ
::
	$moduËR‘rive
(cÚ¡ * 
moduËName
,* 
d©a
,
size
){

581 
MODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
	`fšd
(
moduËName
);

582 if(
™
 =ğ
sIn¡ªû
->
mModuËM­
.
	`’d
()) {

583 
mThœdP¬tyS”v”
->
	`ÚR‘rive
(
moduËName
,
d©a
,
size
);

586 
¥
<
SyncD©a
> 
syncD©a
 = 
Ãw
 
	`SyncD©a
();

587 
»t
 = 
SyncD©aToŞs
::
	`by‹s2D©a
(
syncD©a
,
d©a
,
size
);

589 if(
»t
 < 0){

590 
	`ALOGE
("funùiÚ=%s,E¼Ü:syncd©¨·r£¸çed!\n",
__FUNCTION__
);

592 (
™
->
£cÚd
)->
	`ÚR‘rive
(
syncD©a
);

595 
	}
}

598 
	$SµPrÙocŞ_š¡ªû
(){

599 
ªdroid
::
SµPrÙocŞ
::
	`g‘In¡ªû
();

600 
	}
}

	@protocol/SyncData.cpp

5 
	#LOG_NDEBUG
 0

	)

6 
	#LOG_TAG
 "SyncD©a"

	)

8 
	~<uni¡d.h
>

9 
	~<fú.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dšt.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~<sys/sock‘.h
>

16 
	~<sys/un.h
>

18 
	~<uts/Log.h
>

20 
	~"SyncD©a.h
"

21 
	#ALOGD
 
´štf


	)

22 
	#ALOGE
 
´štf


	)

23 
	#ALOGV
 
´štf


	)

24 
Çme¥aû
 
	gªdroid
 {

26 
	gSyncD©a
::
SyncD©a
(){

30 
SyncD©a
::~SyncData(){

31 
ALOGD
("~SyncData\n");

32 
	gDATAMAP
::
™”©Ü
 
™”
;

33 
	g™”
 = 
mV®ues
.
begš
(); i‹¸!ğmV®ues.
’d
(); ++iter){

34 
	g™”
->
	g£cÚd
 = 
NULL
;

35 
	gmV®ues
.
”a£
(
™”
);

39 
	gSyncD©a
::
add
(cÚ¡ 
¡ršg
 & 
key
, * 
v®ues
,
size
) {

40 
	g¥
<
	gObjeù
> 
	gobj
 = 
Ãw
 
Objeù
(
v®ues
,
size
);

41 
	gmV®ues
.
š£¹
(
DATAMAP
::
v®ue_ty³
(
key
, 
obj
));

42 
ALOGD
("SyncD©¨: key=% v®usize=%d\n",
key
.
c_¡r
(),
size
);

45 
št8_t
 
	gSyncD©a
::
g‘BoŞ—n
(cÚ¡ 
¡ršg
 & 
key
){

46 
DATAMAP
::
™”©Ü
 
™
ğ
mV®ues
.
fšd
(
key
);

48 if(
	g™
 =ğ
mV®ues
.
’d
()) {

49 
ALOGE
("no findhis key\n");

53  
»adBoŞ—n
((
™
->
£cÚd
)->
g‘D©a
());

56 
št32_t
 
	gSyncD©a
::
g‘IÁ
(cÚ¡ 
¡ršg
 & 
key
){

57 
DATAMAP
::
™”©Ü
 
™
ğ
mV®ues
.
fšd
(
key
);

59 if(
	g™
 =ğ
mV®ues
.
’d
()) {

60 
ALOGE
("no findhis key\n");

64  
»adIÁ
((
™
->
£cÚd
)->
g‘D©a
());

67 
št32_t
 
	gSyncD©a
::
g‘SŒšg
(cÚ¡ 
¡ršg
 & 
key
,¡ršg & 
v®ues
){

68 
	gDATAMAP
::
™”©Ü
 
™
ğ
mV®ues
.
fšd
(
key
);

69 if(
	g™
 =ğ
mV®ues
.
’d
()) {

70 
ALOGE
("no findhis key\n");

73 * 
	gd©a
 = (
™
->
£cÚd
)->
g‘D©a
();

74 
št32_t
 
	gËngth
 = 
»adIÁ
(
d©a
);

75 * 
	g¡r
 = 
Ãw
 [
Ëngth
];

76 
memıy
(
¡r
,
d©a
+4,(
™
->
£cÚd
)->
g‘D©aSize
()-4);

78 
	gv®ues
.
assign
(
¡r
,
Ëngth
);

79 
	gd–‘e
 []
	g¡r
;

83 
št32_t
 
	gSyncD©a
::
g‘By‹A¼ay
(cÚ¡ 
¡ršg
 & 
key
,* 
v®ue
){

84 
	gDATAMAP
::
™”©Ü
 
™
ğ
mV®ues
.
fšd
(
key
);

85 if(
	g™
 =ğ
mV®ues
.
’d
()) {

86 
ALOGE
("no findhis key\n");

89 * 
	gd©a
 = (
™
->
£cÚd
)->
g‘D©a
();

90 
št32_t
 
	gËngth
 = 
»adIÁ
(
d©a
);

91 
memıy
(
v®ue
,
d©a
+4,
Ëngth
);

92  
	gËngth
;

95 
št32_t
 
	gSyncD©a
::
»adIÁ
(* 
b
){

96 
št32_t
 
i
 = (
b
[0] << 24) & 0xff000000;

97 
	gi
 |ğ(
b
[1] << 16) & 0x00ff0000;

98 
	gi
 |ğ(
b
[2] << 8) & 0x0000ff00;

99 
	gi
 |ğ
b
[3] & 0xff;

100  
	gi
;

103 
št8_t
 
	gSyncD©a
::
»adBoŞ—n
(* 
b
){

104  *
b
;

107 
	gSyncD©a
::
put
(cÚ¡ 
¡ršg
 & 
key
, 
ty³
,cÚ¡ * 
v®ues
,
size
) {

108 
	g¥
<
	gObjeù
> 
	gobj
 = 
Ãw
 
Objeù
(
ty³
,
v®ues
,
size
);

109 
	gmV®ues
.
š£¹
(
DATAMAP
::
v®ue_ty³
(
key
, 
obj
));

112 
	gSyncD©a
::
putBoŞ—n
(cÚ¡ 
¡ršg
 & 
key
,
boŞ
 
v®ue
){

113 
put
(
key
,
BOOL
,(*)&
v®ue
,1);

115 
	gSyncD©a
::
putIÁ
(cÚ¡ 
¡ršg
 & 
key
,
v®ue
){

116 
put
(
key
,
INT
,(*)(&
v®ue
),4);

119 
	gSyncD©a
::
putLÚg
(cÚ¡ 
¡ršg
 & 
key
, 
št64_t
 
v®ue
){

120 
put
(
key
,
LONG
,(*)(&
v®ue
),8);

123 
	gSyncD©a
::
putSŒšg
(cÚ¡ 
¡ršg
 & 
key
,cÚ¡ sŒšg & 
v®ue
){

124 
put
(
key
,
STRING
,
v®ue
.
c_¡r
(),v®ue.
size
());

127 
	gSyncD©a
::
putBy‹A¼ay
(cÚ¡ 
¡ršg
 & 
key
,* 
v®ue
,
size
){

128 
put
(
key
,
BYTE_ARY
,
v®ue
,
size
);

	@protocol/SyncDataTools.cpp

5 
	#LOG_NDEBUG
 0

	)

6 
	#LOG_TAG
 "SyncD©aToŞs"

	)

8 
	~<uni¡d.h
>

9 
	~<fú.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dšt.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~<uts/Log.h
>

16 
	~<uts/RefBa£.h
>

18 
	~"SyncD©aToŞs.h
"

20 
Çme¥aû
 
	gªdroid
 {

21 şas 
	cSyncD©aToŞs
::
Encod”
 {

22 
public
:

23 cÚ¡ 
CAP
 = 4 * 1024;

25 
Encod”
(cÚ¡ 
¥
<
SyncD©a
>& 
d©a
)

26 :
mPos
(0),

27 
mSyncD©a
(
d©a
){

30 
’code
(* 
by‹D©a
){

31 
	gmBy‹s
 = 
by‹D©a
;

32 
	gkeycouÁ
 = 
mSyncD©a
->
keyCouÁ
();

33 
wr™eIÁ
(
keycouÁ
);

35 
	gSyncD©a
::
DATAMAP
 
m­
 = 
mSyncD©a
->
g‘D©aM­
();

36 
	gSyncD©a
::
DATAMAP
::
™”©Ü
 
™”
;

37 
	g™”
 = 
m­
.
begš
(); i‹¸!ğm­.
’d
(); ++iter){

38 
wr™eSŒšg
(
™”
->
fœ¡
);

39 
wr™eObjeù
(
™”
->
£cÚd
);

41 
	gmBy‹s
 = 
NULL
;

42  
	gmPos
;

45 ~
Encod”
(){

46 
	gd–‘e
 []
	gmBy‹s
;

48 
	g´iv©e
:

49 
¥
<
SyncD©a
> 
mSyncD©a
;

50 * 
	gmBy‹s
;

51 
	gmPos
;

53 
wr™eIÁ
(
i
){

54 
	gmBy‹s
[
mPos
++] = (è(
i
 >> 24);

55 
	gmBy‹s
[
mPos
++] = (è(
i
 >> 16);

56 
	gmBy‹s
[
mPos
++] = (è(
i
 >> 8);

57 
	gmBy‹s
[
mPos
++] = (è
i
;

60 
wr™eSŒšg
(cÚ¡ 
¡ršg
 & 
s
){

61 
wr™eIÁ
(
s
.
size
());

62 
memıy
(&
mBy‹s
[
mPos
],
s
.
c_¡r
(),s.
size
());

63 
	gmPos
 +ğ
s
.
size
();

66 
wr™eSŒšg
(cÚ¡ * 
s
,
size
){

67 
¡ršg
 
	g¡r
;

68 
	g¡r
.
assign
(
s
,
size
);

69 
wr™eIÁ
(
size
);

70 
memıy
(&
mBy‹s
[
mPos
],
s
,
size
);

71 
	gmPos
 +ğ
size
;

73 
wr™eObjeù
(cÚ¡ 
¥
<
Objeù
> & 
objeù
){

74 
	gty³
 = ()(
objeù
->
g‘Ty³
());

75 
wr™eBy‹
(
ty³
);

76 if(
	gty³
 =ğ
BYTE
){

77 
wr™eBy‹
(()(*(
objeù
->
g‘D©a
())));

78 }if(
	gty³
 =ğ
INT
){

79 
wr™eIÁ
(*((*)(
objeù
->
g‘D©a
())));

80 }if(
	gty³
 =ğ
STRING
){

81 
wr™eSŒšg
(
objeù
->
g‘D©a
(),objeù->
g‘D©aSize
());

82 }if(
	gty³
 =ğ
BOOL
){

83 
wr™eBoŞ—n
((
boŞ
)(*(
objeù
->
g‘D©a
())));

84 }if(
	gty³
 =ğ
LONG
){

85 
wr™eLÚg
((*((
št64_t
 *)
objeù
->
g‘D©a
())));

86 }if(
	gty³
 =ğ
BYTE_ARY
){

87 
wr™eBy‹A¼ay
((*)
objeù
->
g‘D©a
(),objeù->
g‘D©aSize
());

90 
wr™eBy‹
(
b
) {

91 
	gmBy‹s
[
mPos
++] = 
b
;

93 
wr™eBoŞ—n
(
boŞ
 
b
) {

94 ià(
	gb
)

95 
	gmBy‹s
[
mPos
++] = () 1;

97 
	gmBy‹s
[
mPos
++] = () 0;

100 
wr™eLÚg
(
št64_t
 
l
){

101 
ALOGD
("wr™eLÚg† =%Îd\n", 
l
);

102 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 56);

103 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 48);

104 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 40);

105 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 32);

106 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 24);

107 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 16);

108 
	gmBy‹s
[
mPos
++] = (è(
l
 >> 8);

109 
	gmBy‹s
[
mPos
++] = (è
l
;

111 
wr™eBy‹A¼ay
(cÚ¡ * 
s
,
size
){

112 
wr™eIÁ
(
size
);

113 
¡ºıy
(
mBy‹s
+
mPos
, 
s
, 
size
);

114 
	gmPos
 +ğ
size
;

118 şas 
	cSyncD©aToŞs
::
Decod”
 {

119 
public
:

120 cÚ¡ 
TRUE
 = 1;

122 
Decod”
(* 
d©a
,
size
)

123 : 
mPos
(0){

124 
mOÃBy‹s
 = 
Ãw
 [
size
];

125 
memıy
(
mOÃBy‹s
,
d©a
,
size
);

126 
	gd©asize
 = 
size
;

129 
decode
(
¥
<
SyncD©a
> & 
d©a
) {

130 
	gkeyCouÁ
 = 
»adIÁ
();

131 
	gi
 = 0; i < 
	gkeyCouÁ
; i++) {

132 
¡ršg
 
	gkey
;

133 
»adSŒšg
(
key
);

134 
	gpos
 = 
mPos
+1;

135 
»adObj
();

136 
	gd©a
->
add
(
key
, 
mOÃBy‹s
+
pos
,
mPos
-pos);

138  
	gmPos
;

141 ~
Decod”
(){

142 
	gd–‘e
 []
	gmOÃBy‹s
;

144 
	g´iv©e
:

145 * 
mOÃBy‹s
;

146 
	gd©asize
;

147 
	gmPos
 = 0;

149 
»adObj
(){

150 
	gty³
 = 
»adBy‹
();

151 ià(
	gty³
 =ğ
BYTE
) {

152 
mPos
 += 1;

153 } ià(
	gty³
 =ğ
INT
) {

154 
mPos
 +ğ
INT_LENGTH
;

155 } ià(
	gty³
 =ğ
STRING
) {

156 
mPos
 +ğ
»adIÁ
();

157 } ià(
	gty³
 =ğ
BOOL
) {

158 
mPos
 += 1;

159 } ià(
	gty³
 =ğ
LONG
) {

160 
mPos
 +ğ
LONG_LENGTH
;

161 } ià(
	gty³
 =ğ
SHORT
) {

162 
mPos
 +ğ
SHORT_LENGTH
;

163 } ià(
	gty³
 =ğ
FLOAT
) {

164 
mPos
 +ğ
FLOAT_LENGTH
;

165 } ià(
	gty³
 =ğ
DOUBLE
) {

166 
mPos
 +ğ
DOUBLE_LENGTH
;

167 } ià(
	gty³
 =ğ
BYTE_ARY
) {

168 
mPos
 +ğ
»adIÁ
();

170 
ALOGE
("unknowy³:\n" + 
ty³
);

174 
boŞ
 
»adBoŞ—n
() {

175 ià(
	gmOÃBy‹s
[
mPos
++] =ğ
TRUE
) {

176  
Œue
;

178  
	gçl£
;

181 
št32_t
 
»adIÁ
() {

182 * 
	gb
 = 
Ãw
 [
INT_LENGTH
];

183 
memıy
(
b
,
mOÃBy‹s
+
mPos
,
INT_LENGTH
);

185 
	gi
 = (
b
[0] << 24) & 0xff000000;

186 
	gi
 |ğ(
b
[1] << 16) & 0x00ff0000;

187 
	gi
 |ğ(
b
[2] << 8) & 0x0000ff00;

188 
	gi
 |ğ
b
[3] & 0xff;

189 
	gmPos
 +ğ
INT_LENGTH
;

190 
	gd–‘e
 []
	gb
;

191  
	gi
;

194 
ušt8_t
 
»adBy‹
() {

195  
	gmOÃBy‹s
[
mPos
++];

198 
»adShÜt
() {

199  (è((
	gmOÃBy‹s
[
mPos
++] & 0xff << 8) | (mOneBytes[mPos++] & 0xff));

202 
»adLÚg
() {

203 
	g‹mp
 = 0;

204 
	g»s
 = 0;

205 
	gi
 = 0; i < 
	gLONG_LENGTH
; i++) {

206 
	g»s
 <<= 8;

207 
	g‹mp
 = 
mOÃBy‹s
[
mPos
++] & 0xff;

208 
	g»s
 |ğ
‹mp
;

210  
	g»s
;

213 
»adSŒšg
(
¡ršg
 & 
¡r
){

214 
	gËngth
 = 
»adIÁ
();

215 * 
	gb
 = 
Ãw
 [
Ëngth
];

216 
memıy
(
b
,
mOÃBy‹s
+
mPos
,
Ëngth
);

217 
	gmPos
 +ğ
Ëngth
;

219 
	g¡r
.
assign
(
b
,
Ëngth
);

220 
	gd–‘e
 []
	gb
;

224 
	gSyncD©aToŞs
::
by‹s2D©a
(
¥
<
SyncD©a
> & 
d©a
,* 
d©aBy‹s
,
size
) {

225 
	grsize
;

227 
Decod”
* 
	gdecod”
 = 
Ãw
 
SyncD©aToŞs
::Decod”(
d©aBy‹s
,
size
);

228 
	grsize
 = 
decod”
->
decode
(
d©a
);

229 
d–‘e
 
	gdecod”
;

230  
	grsize
;

233 
	gSyncD©aToŞs
::
d©a2By‹s
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
,* 
by‹s
){

234 
Encod”
* 
	g’cod”
 = 
Ãw
 
SyncD©aToŞs
::Encod”(
d©a
);

235 
	gsize
 = 
’cod”
->
’code
(
by‹s
);

236 
d–‘e
 
	g’cod”
;

237  
	gsize
;

	@protocol/SyncModule.cpp

6 
	#LOG_NDEBUG
 0

	)

7 
	#LOG_TAG
 "SyncModuË"

	)

9 
	~<uni¡d.h
>

10 
	~<fú.h
>

11 
	~<¡dlib.h
>

12 
	~<¡dšt.h
>

14 
	~<sys/ty³s.h
>

15 
	~<sys/¡©.h
>

16 
	~<sys/un.h
>

18 
	~<uts/Log.h
>

19 
	~<ty³šfo
>

20 
	~"SyncModuË.h
"

21 
	~"SyncD©aToŞs.h
"

22 
	~"DBH–³r.h
"

23 
	~"SµPrÙocŞ.h
"

24 
	~"BËPrÙocŞ.h
"

26 
Çme¥aû
 
	gªdroid
 {

27 cÚ¡ 
	gCAP
 = 4 * 1024;

28 
	#REMOTE_DEVICE_UUID_SIZE
 36

	)

30 
	gSyncModuË
::
SyncModuË
(cÚ¡ 
¡ršg
 & 
Çme
, 
RefBa£
* 
´ÙocŞ
)

32 
	gmModuËName
 = 
Çme
;

34 
	gmModuË
 = 
this
;

35 
	gmModuË
->
	gmPrÙocŞ
 = 
´ÙocŞ
;

36 if(
ty³id
(*
´ÙocŞ
è=ğty³id(
SµPrÙocŞ
)){

37 
mTy³
 = 1;

38 ((
	gSµPrÙocŞ
 *)
	g´ÙocŞ
)->
»gi¡”ModuË
(
mModuËName
, 
mModuË
);

39 }if(
ty³id
(*
´ÙocŞ
è=ğty³id(
BËPrÙocŞ
)){

40 
mTy³
 = 2;

41 ((
	gBËPrÙocŞ
 *)
	g´ÙocŞ
)->
»gi¡”ModuË
(
mModuËName
, 
mModuË
);

43 
´štf
("SyncModuË:mModuËName=%s\n", 
mModuËName
.
c_¡r
());

46 
	gSyncModuË
::~
SyncModuË
()

48 if(
mPrÙocŞ
 !ğ
NULL
){

49 if(
mTy³
 == 1){

50 ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
unRegi¡”ModuË
(
mModuËName
);

51 }if(
	gmTy³
 == 2){

52 ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
unRegi¡”ModuË
(
mModuËName
);

57 
	gSyncModuË
::
ÚR‘rive
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
)

61 
SyncModuË
::
£nd
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
)

63 * 
by‹s
 = 
Ãw
 [
CAP
];

64 
	gsize
 = 
SyncD©aToŞs
::
d©a2By‹s
(
d©a
,
by‹s
);

65 if(
	gsize
 <= 0){

66 
ALOGE
("Error:serial failed!");

70 if(
	gmPrÙocŞ
 !ğ
NULL
){

71 if(
mTy³
 == 1){

72 ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
mModuËName
.
c_¡r
(),
by‹s
,
size
);

73 }if(
	gmTy³
 == 2){

74 ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
mModuËName
.
c_¡r
(),
by‹s
,
size
);

78 
	gd–‘e
 []
	gby‹s
;

81 
	gSyncModuË
::
isBËBšded
()

83 
t_DB_CONFIG
 
db_cÚfig
;

84 
mem£t
(
db_cÚfig
.
bšd_addr
, 0, (db_config.bind_addr));

85 
	g¥
<
	gDBH–³r
> 
	gdBH–³r
 = 
Ãw
 
DBH–³r
();

86 
	gdBH–³r
->
»adS‹FromDB
(
db_cÚfig
);

87 if(
¡¾’
(
db_cÚfig
.
bšd_addr
è=ğ
REMOTE_DEVICE_UUID_SIZE
) {

88 
´štf
("ble binded\n");

91 
	gdBH–³r
 = 
NULL
;

	@protocol/UnBindModule.cpp

1 
	#LOG_TAG
 "UnBšdModuË"

	)

4 
	~"UnBšdModuË.h
"

5 
	~"DBH–³r.h
"

6 #ifdeà
__ılu¥lus


10 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

11 #ifdeà
__ılu¥lus


14 
	#ALOGD
 
´štf


	)

17 
Çme¥aû
 
	gªdroid
 {

19 cÚ¡ 
¡ršg
 
	gMODULE_NAME
 = "system_module";

20 cÚ¡ 
¡ršg
 
	gUNBIND_TYPE
 = "unbind";

22 
UnBšdModuË
* 
	gUnBšdModuË
::
sIn¡ªû
 = 
NULL
;

24 
UnBšdModuË
* 
	gUnBšdModuË
::
g‘In¡ªû
(
RefBa£
* 
´ÙocŞ
)

26 if(
sIn¡ªû
 =ğ
NULL
){

27 
sIn¡ªû
 = 
Ãw
 
UnBšdModuË
(
´ÙocŞ
);

29  
	gsIn¡ªû
;

32 
	gUnBšdModuË
::
UnBšdModuË
(
RefBa£
* 
´ÙocŞ
è: 
SyncModuË
(
MODULE_NAME
,…rotocol)

34 
ALOGD
("UnBindModule in\n");

38 
	gUnBšdModuË
::~
UnBšdModuË
()

43 
UnBšdModuË
::
ÚR‘rive
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
)

45 
boŞ
 
unbšd
 = 
d©a
->
g‘BoŞ—n
("unbind");

46 ià(
	gunbšd
) {

47 
ALOGD
("unbind has clear DB\n");

49 
	g¥
<
	gSyncD©a
> 
	gsyncd©a
 = 
Ãw
 
SyncD©a
();

50 
£nd
(
syncd©a
);

51 
	g¥
<
	gDBH–³r
> 
	gh–³r
 = 
Ãw
 
DBH–³r
();

52 
	gh–³r
->
wr™eS‹ToDB
(
çl£
, "");

53 
£tBTVisib™y
(
Œue
,rue);

	@sdk/BluetoothController.cpp

2 
	#LOG_TAG
 "Blu‘oÙhCÚŒŞËr"

	)

4 
	~"Blu‘oÙhCÚŒŞËr.h
"

6 
	~<uni¡d.h
>

7 
	~<fú.h
>

8 
	~<±h»ad.h
>

9 
	~<sigÇl.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg
>

12 
	~<sys/sock‘.h
>

13 
	~<sys/un.h
>

16 cÚ¡ 
	gCAP
 = 4 * 1024;

17 
	#ALOGV
 
´štf


	)

18 
	#ALOGD
 
´štf


	)

19 
	#ALOGE
 
´štf


	)

20 
	#UNIX_DOMAIN
 "/v¬/run/blu‘oÙh_sock‘"

	)

21 
	#BUFFER_SIZE
 1024

	)

23 cÚ¡ *
	gbtcmdSŒ
[] = {

35 
	mCMD_OPEN_OK_IDX
 = 0,

36 
	mCMD_CLOSE_OK_IDX
,

37 
	mCMD_DISABLE_OK_IDX
,

38 
	mCMD_DISCMPL_IDX
,

39 
	mCMD_A2DP_SOURCE_OPEN_OK_IDX
,

40 
	mCMD_A2DP_SOURCE_OPEN_FAILED_IDX
,

41 
	mCMD_A2DP_SOURCE_CLOSE_OK_IDX
,

42 
	mCMD_A2DP_SOURCE_CLOSE_FAILED_IDX
,

43 
	mCMD_DELLINKED_OK_IDX
,

44 
	mCMD_DELLINKED_FAILED_IDX
,

45 
	mCMD_LINKINGCMPL_IDX
,

46 
	mCMD_LINKING_IDX
,

47 
	mCMD_LINKEDCMPL_IDX
,

48 
	mCMD_LINKED_IDX
,

49 
	mCMD_DISCOVERY_IDX
,

50 
	mCMD_A2DP_SOURCE_OPEN_IDX
,

51 
	mCMD_A2DP_SOURCE_CLOSE_IDX
,

52 
	mCMD_DELLINKED_IDX
,

53 
	mCMD_AG_SOURCE_OPEN
,

54 
	mCMD_AG_SOURCE_CLOSE
,

55 
	mCMD_A2DP_AV_NOTIFY
,

56 
	mCMD_A2DP_AV_CHECK_CONNECT
,

57 
	mCMD_A2DP_AV_SEND_VOLUME_OK
,

58 
	mCMD_A2DP_AV_SEND_VOLUME_FAILED
,

59 } 
	tBlu‘oÙhCÚŒrŞËr_cmd_ty³
;

61 
boŞ
 
	gavLškUp
 = 
çl£
;

62 
boŞ
 
	gavLškDn
 = 
çl£
;

63 
boŞ
 
	gd–lšk
 = 
çl£
;

64 
boŞ
 
	gddiscÚÃù
 = 
çl£
;

65 
boŞ
 
	gagLšked
 = 
çl£
;

67 
boŞ
 
	gavLškWa™
 = 
çl£
;

68 
boŞ
 
	gavLškDnWa™
 = 
çl£
;

69 
boŞ
 
	gisİ’ok
 = 
çl£
;

70 
boŞ
 
	gisşo£ok
 = 
çl£
;

71 
boŞ
 
	gisd–lšked
 = 
çl£
;

73 (*
disc_ÿÎ_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
èğ
NULL
;

74 (*
lšked_ÿÎ_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
èğ
NULL
;

75 (*
lškšg_ÿÎ_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
èğ
NULL
;

76 (*
a2dp_nÙify_ÿÎ_back
)(
¡©e
èğ
NULL
;

78 
Blu‘oÙhCÚŒŞËr
 *Blu‘oÙhCÚŒŞËr::
sIn¡ªû
 = 
NULL
;

79 
Blu‘oÙhCÚŒŞËr
 *Blu‘oÙhCÚŒŞËr::
	$g‘In¡ªû
() {

80 
	`ALOGV
("%s", 
__FUNCTION__
);

81 ià(
sIn¡ªû
 =ğ
NULL
) {

82 
sIn¡ªû
 = 
Ãw
 
	`Blu‘oÙhCÚŒŞËr
();

84  
sIn¡ªû
;

85 
	}
}

87 
	gBlu‘oÙhCÚŒŞËr
::
	$Blu‘oÙhCÚŒŞËr
() {

88 
	`ALOGV
("%s", 
__FUNCTION__
);

89 
mavIsCÚÃùed
 = 0;

90 
	`¡¬tSock‘Cl›Á
();

92 
	`±h»ad_mu‹x_š™
(&
mMu‹x
, 
NULL
);

93 
	`±h»ad_cÚd_š™
(&
mCÚd™iÚ
, 
NULL
);

95 
»t
 = 
	`±h»ad_cÚd©Œ_š™
(&
mAvCÚd™iÚA‰r
);

97 
»t
 = 
	`±h»ad_cÚd©Œ_£tşock
(&
mAvCÚd™iÚA‰r
, 
CLOCK_MONOTONIC
);

98 
»t
 = 
	`±h»ad_cÚd_š™
(&
mAvCÚd™iÚ
, &
mAvCÚd™iÚA‰r
);

102 
	}
}

104 
	gBlu‘oÙhCÚŒŞËr
::~
	$Blu‘oÙhCÚŒŞËr
() {

105 
	`ALOGV
("%s", 
__FUNCTION__
);

106 
	`¡İSock‘Cl›Á
();

108 
	`±h»ad_cÚd_de¡roy
(&
mCÚd™iÚ
);

109 
	`±h»ad_cÚd_de¡roy
(&
mAvCÚd™iÚ
);

110 
	`±h»ad_cÚd©Œ_de¡roy
(&
mAvCÚd™iÚA‰r
);

111 
	`±h»ad_mu‹x_de¡roy
(&
mMu‹x
);

112 
	}
}

114 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$İ’
() {

115 
	`ALOGV
("%s", 
__FUNCTION__
);

117 ià(
	`isO³Ãd
(è=ğ
Œue
)

118  
Œue
;

120 
¡ršg
 
msg
 = "open-";

121 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

122 ià(
»’
 > 0) {

123 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

124  
Œue
;

126  
çl£
;

127 
	}
}

129 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$£tBËB—cÚ
(
¡©e
) {

130 
	`ALOGD
("%s", 
__FUNCTION__
);

131 ià(
	`isO³Ãd
(è=ğ
çl£
) {

132 
	`ALOGE
("setBLEbeacon failed:must open bluetooth first.");

133  
çl£
;

136 
¡ršg
 
msg
 = "hwbeacon-";

137 ià(
¡©e
 == 0)

138 
msg
.
	`­³nd
("0");

139 if(
¡©e
 == 1)

140 
msg
.
	`­³nd
("1");

141 if(
¡©e
 == 2)

142 
msg
.
	`­³nd
("2");

143 if(
¡©e
 == 3)

144 
msg
.
	`­³nd
("3");

146 
msg
.
	`­³nd
("4");

147 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

148 ià(
»’
 > 0) {

149  
Œue
;

151  
çl£
;

152 
	}
}

154 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$£tBlu‘oÙhVisib™y
(
boŞ
 
’abË
) {

155 
	`ALOGV
("%s", 
__FUNCTION__
);

156 ià(
	`isO³Ãd
(è=ğ
çl£
) {

157 
	`ALOGE
("setBluetoothVisibility failed:must open bluetooth first.");

158  
çl£
;

161 
¡ršg
 
msg
 = "visibility-";

162 ià(
’abË
)

163 
msg
.
	`­³nd
("true");

165 
msg
.
	`­³nd
("false");

167 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

168 ià(
»’
 > 0) {

169  
Œue
;

171  
çl£
;

172 
	}
}

173 
	gBlu‘oÙhCÚŒŞËr
::
	$wa™True
(
boŞ
 *
isTrue
, 
timeout
) {

174 
times
 = 0;

175 *
isTrue
 =ğ
çl£
) {

176 ià(
times
++ > 
timeout
)

178 
	`u¦“p
(5 * 1000);

180  
times
 * 5;

181 
	}
}

183 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$isO³Ãd
() {

184 
	`ALOGV
("%s", 
__FUNCTION__
);

185 
fd
 = ::
	`İ’
("/sys/şass/rfkl/rfkl0/¡©e", 
O_RDONLY
);

186 ià(
fd
 < 0) {

187 
	`ALOGE
("İ’ /sys/şass/rfkl/rfkl0/¡©çed: % ", 
	`¡»¼Ü
(
”ºo
));

188  
çl£
;

191 
bufãr
 = 0;

192 ::
	`»ad
(
fd
, &
bufãr
, 1);

194 ::
	`şo£
(
fd
);

198  (
bufãr
 =ğ'1'è? 
Œue
 : 
çl£
;

199 
	}
}

201 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$şo£
() {

202 
	`ALOGV
("%s", 
__FUNCTION__
);

204 ià(
	`isO³Ãd
(è=ğ
çl£
)

205  
Œue
;

207 
¡ršg
 
msg
 = "close-";

208 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

209 ià(
»’
 > 0) {

210 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

211  
Œue
;

213  
çl£
;

214 
	}
}

216 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$H—dS‘Answ”C®l
() {

217 
	`ALOGV
("%s", 
__FUNCTION__
);

219 
¡ršg
 
msg
 = "answercall-";

220 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

221 ià(
»’
 > 0)

222  
Œue
;

224  
çl£
;

225 
	}
}

227 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$H—dS‘HªgUp
() {

228 
	`ALOGV
("%s", 
__FUNCTION__
);

230 
¡ršg
 
msg
 = "hangup-";

231 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

232 ià(
»’
 > 0)

233  
Œue
;

235  
çl£
;

236 
	}
}

238 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$discÚÃù
() {

239 
	`ALOGV
("%s", 
__FUNCTION__
);

240 
¡ršg
 
msg
 = "disable-";

241 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

242 ià(
»’
 > 0)

243  
Œue
;

245  
çl£
;

246 
	}
}

248 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$ü—tBÚd
(cÚ¡ 
¡ršg
 &
bd_Çme
) {

249 
	`ALOGV
("%s", 
__FUNCTION__
);

250 
¡ršg
 
msg
 = "creatbond-";

251 
msg
.
	`­³nd
(
bd_Çme
);

252 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

253 ià(
»’
 > 0)

254  
Œue
;

256  
çl£
;

257 
	}
}

259 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$»moveBÚd
(cÚ¡ 
¡ršg
 &
bd_Çme
) {

260 
	`ALOGV
("%s", 
__FUNCTION__
);

261 
¡ršg
 
msg
 = "removebond-";

262 
msg
.
	`­³nd
(
bd_Çme
);

263 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

264 ià(
»’
 > 0)

265  
Œue
;

267  
çl£
;

268 
	}
}

269 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$d–lšked
(cÚ¡ 
BD_ADDR
 
addr
) {

270 
	`ALOGD
("%s", 
__func__
);

272 
msg
[50] = "dellinked-";

273 
d–lšk
 = 
çl£
;

274 
isd–lšked
 = 
çl£
;

275 
	`memıy
(&
msg
[
	`¡¾’
("d–lšked-")], 
addr
, 
BD_ADDR_SIZE
);

276 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
("d–lšked-"è+ 
BD_ADDR_SIZE
, 0);

277 ià(
»’
 > 0) {

279 
times
 = 
	`wa™True
(&
isd–lšked
, 1000);

280 
	`ALOGD
("aá” wa™ %d ms,d–lšked„‘uº %s", 
times
, 
d–lšk
 ? "true" : "false");

281  
d–lšk
;

283 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

284 ià(
d–lšk
 =ğ
Œue
)

285  
Œue
;

288  
çl£
;

289 
	}
}

291 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$g‘Lšked
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
) {

292 
	`ALOGD
("%s", 
__FUNCTION__
);

293 
lšked_ÿÎ_back
 = 
disc_back
;

294 
¡ršg
 
msg
 = "getlinked-";

295 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
du¿tiÚ
));

296 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

297 ià(
»’
 > 0)

298  
Œue
;

300  
çl£
;

301 
	}
}

303 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$g‘Lškšg
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
) {

304 
	`ALOGD
("%s", 
__FUNCTION__
);

305 
lškšg_ÿÎ_back
 = 
disc_back
;

306 
¡ršg
 
msg
 = "getlinking-";

307 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
du¿tiÚ
));

308 
	`ALOGD
("%s,%d", 
msg
.
	`c_¡r
(), msg.
	`Ëngth
());

309 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

310 ià(
»’
 > 0)

311  
Œue
;

313  
çl£
;

314 
	}
}

316 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$¡¬tDiscov”y
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
, 
ty³
) {

317 
	`ALOGV
("%s", 
__FUNCTION__
);

318 
disc_ÿÎ_back
 = 
disc_back
;

319 
¡ršg
 
msg
 = "startdisc-";

320 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
du¿tiÚ
));

321 
msg
.
	`­³nd
("-");

322 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
ty³
));

323 
msg
.
	`­³nd
("-");

324 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

325 ià(
»’
 > 0)

326  
Œue
;

328  
çl£
;

329 
	}
}

331 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPSock‘R—dy
() {

332 
	`ALOGD
("%s(èsock‘:%d", 
__FUNCTION__
, 
mSock‘Fd
);

333 
¡ršg
 
msg
 = "a2dp-av-socket-ready-";

334 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

335 
	`ALOGD
("„‘=%d", 
»’
);

336 ià(
»’
 > 0)

337  
Œue
;

339  
çl£
;

340 
	}
}

342 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPS’dVŞume
(
vŞume
) {

343 
	`ALOGD
("%s(èvŞumeğ%d, sock‘:%d", 
__FUNCTION__
, 
vŞume
, 
mSock‘Fd
);

344 
¡ršg
 
msg
 = "a2dp-av-send-volume-";

345 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
vŞume
));

346 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

347 
	`ALOGD
("„‘=%d", 
»’
);

348 ià(
»’
 > 0)

349  
Œue
;

351  
çl£
;

352 
	}
}

354 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$¡İDiscov”y
() {

355 
	`ALOGV
("%s", 
__FUNCTION__
);

356 
¡ršg
 
msg
 = "stopdisc-";

357 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

358 ià(
»’
 > 0)

359  
Œue
;

361  
çl£
;

362 
	}
}

363 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPCheckCÚÃù
(&
is_cÚÃù
) {

364 
	`ALOGV
("%s", 
__FUNCTION__
);

365 
¡ršg
 
msg
 = "a2dp-av-check_connect-";

366 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

367 ià(
»’
 <= 0) {

368 
is_cÚÃù
 = 0;

369  
çl£
;

372 
timev®
 
now
;

373 
time¥ec
 
ou‰ime
;

375 
	`±h»ad_mu‹x_lock
(&
g_mu‹x
);

377 
	`g‘timeofday
(&
now
, 
NULL
);

378 
ou‰ime
.
tv_£c
 = 
now
.tv_sec;

379 
ou‰ime
.
tv_n£c
 = 
now
.
tv_u£c
 * 1000;

380 
	`±h»ad_cÚd_timedwa™
(&
mAvCÚd™iÚ
, &
mMu‹x
);

382 
time¥ec
 
tv
;

383 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
tv
);

384 
	`ALOGV
("%s-±h»ad_cÚd_timedwa™ 1s--", 
__FUNCTION__
);

385 
tv
.
tv_£c
 += 1;

386 
»t
 = 
	`±h»ad_cÚd_timedwa™
(&
mAvCÚd™iÚ
, &
mMu‹x
, &
tv
);

387 if(
»t
 == 0)

388 
	`ALOGV
("%s-dÚe,‡v_cÚÃù=%d,»ˆğ%d", 
__FUNCTION__
, 
mavIsCÚÃùed
,
»t
);

390 
mavIsCÚÃùed
 = 0;

391 
	`ALOGV
("%s-ç,„‘ = %d", 
__FUNCTION__
, 
mavIsCÚÃùed
,
»t
);

394 
is_cÚÃù
 = 
mavIsCÚÃùed
;

395  
Œue
;

396 
	}
}

401 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPNÙify
((*
a2dp_ÿÎback
)(
¡©e
)) {

402 
	`ALOGV
("%s", 
__FUNCTION__
);

403 
¡ršg
 
msg
 = "a2dp-av-notify-";

404 
cb_¡©e
 = 0;

405 ià(
a2dp_ÿÎback
) {

406 
cb_¡©e
 = 1;

407 
a2dp_nÙify_ÿÎ_back
 = 
a2dp_ÿÎback
;

409 
a2dp_nÙify_ÿÎ_back
 = 
NULL
;

411 
msg
.
	`­³nd
(
¡d
::
	`to_¡ršg
(
cb_¡©e
));

412 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
.
	`c_¡r
(), msg.
	`Ëngth
(), 0);

413 ià(
»’
 > 0)

414  
Œue
;

416  
çl£
;

417 
	}
}

419 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$HFPAGLškUp
(cÚ¡ 
BD_ADDR
 
addr
) {

420 
	`ALOGV
("%s", 
__FUNCTION__
);

421 ià(
	`isO³Ãd
(è=ğ
çl£
)

422  
çl£
;

424 
msg
[50] = "ag-source-open-";

425 
	`memıy
(&
msg
[
	`¡¾’
("ag-sourû-İ’-")], 
addr
, 
BD_ADDR_SIZE
);

426 
agLšked
 = 
çl£
;

427 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
(msgè+ 
BD_ADDR_SIZE
, 0);

428 ià(
»’
 > 0) {

429 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

430 ià(
agLšked
)

431  
Œue
;

433  
çl£
;

434 
	}
}

436 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$HFPAGLškDown
() {

437 
	`ALOGV
("%s", 
__FUNCTION__
);

438 ià(
	`isO³Ãd
(è=ğ
çl£
)

439  
çl£
;

441 
agLšked
 = 
çl£
;

442 *
msg
 = "ag-source-close-";

444 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
(msg), 0);

445 ià(
»’
 > 0) {

446 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

447 ià(
agLšked
)

448  
Œue
;

450  
çl£
;

451 
	}
}

453 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$AGO³nAudio
() {

454 
	`ALOGV
("%s", 
__FUNCTION__
);

455 ià(
	`isO³Ãd
(è=ğ
çl£
)

456  
çl£
;

458 *
msg
 = "ag-open-audio-";

460 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
(msg), 0);

461 ià(
»’
 > 0)

462  
Œue
;

464  
çl£
;

465 
	}
}

467 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$AGClo£Audio
() {

468 
	`ALOGV
("%s", 
__FUNCTION__
);

469 ià(
	`isO³Ãd
(è=ğ
çl£
)

470  
çl£
;

472 *
msg
 = "ag-close-audio-";

474 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
(msg), 0);

475 ià(
»’
 > 0)

476  
Œue
;

478  
çl£
;

479 
	}
}

481 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPSouûLškUp
(cÚ¡ 
BD_ADDR
 
addr
) {

482 
maxwa™
 = 0;

483 ià(
	`isO³Ãd
(è=ğ
çl£
)

484  
çl£
;

486 
msg
[50] = "a2dp-source-open-";

487 
	`memıy
(&
msg
[
	`¡¾’
("a2dp-sourû-İ’-")], 
addr
, 
BD_ADDR_SIZE
);

488 
avLškWa™
 = 
çl£
;

489 
avLškUp
 = 
çl£
;

490 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
("a2dp-sourû-İ’-"è+ 
BD_ADDR_SIZE
, 0);

491 ià(
»’
 > 0) {

494 
times
 = 
	`wa™True
(&
avLškWa™
, 2000);

495 ià(
maxwa™
 < 
times
)

496 
maxwa™
 = 
times
;

517  
avLškUp
;

519 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

520 ià(
avLškUp
)

521  
Œue
;

524  
çl£
;

525 
	}
}

527 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$A2DPSouûLškDown
() {

528 
maxwa™
 = 0;

529 ià(
	`isO³Ãd
(è=ğ
çl£
)

530  
çl£
;

532 
avLškDn
 = 
çl£
;

533 
avLškDnWa™
 = 
çl£
;

534 *
msg
 = "a2dp-source-close-";

536 
»’
 = ::
	`£nd
(
mSock‘Fd
, 
msg
, 
	`¡¾’
(msg), 0);

537 ià(
»’
 > 0) {

540 
times
 = 
	`wa™True
(&
avLškDnWa™
, 2000);

561  
avLškDn
;

563 
	`±h»ad_cÚd_wa™
(&
mCÚd™iÚ
, &
mMu‹x
);

564 ià(
avLškDn
)

565  
Œue
;

568  
çl£
;

569 
	}
}

571 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$¡İSock‘Cl›Á
() {

572 
	`±h»ad_još
(
mR—dTh»ad
, 
NULL
);

573 ià(
mSock‘Fd
 > 0) {

574 ::
	`şo£
(
mSock‘Fd
);

575 
mSock‘Fd
 = -1;

577  
Œue
;

578 
	}
}

580 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$¡¬tSock‘Cl›Á
() {

581 
	`ALOGD
("%s,mR—dTh»ad:%d", 
__FUNCTION__
, 
mR—dTh»ad
);

582 
boŞ
 
»t
 = 
Œue
;

583 
fd
;

584 
mSock‘Fd
 = -1;

585 
sockaddr_un
 
£r_addr
;

586 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

587 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

588 
	`¡rıy
(
£r_addr
.
sun_·th
, 
UNIX_DOMAIN
);

589 
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

590 ià(
fd
 < 0) {

591 
	`ALOGE
("sock‘ƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”ºo
));

593 
»t
 = 
çl£
;

596 
æags
 = 
	`fú
(
fd
, 
F_GETFD
);

597 
æags
 |ğ
FD_CLOEXEC
;

598 
	`fú
(
fd
, 
F_SETFD
, 
æags
);

600 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

601 ià(
»t
 < 0) {

602 
	`ALOGE
("cÚÃù sock‘ƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”ºo
));

603 ::
	`şo£
(
fd
);

605 
»t
 = 
çl£
;

609 
mSock‘Fd
 = 
fd
;

610 
	`ALOGD
("mSock‘Fd =%d", 
mSock‘Fd
);

611 
	`±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
Blu‘oÙhCÚŒŞËr
::
R—dTh»adW¿µ”
, 
this
);

613  
»t
;

614 
	}
}

615 
boŞ
 
	gBlu‘oÙhCÚŒŞËr
::
	$»¡¬tSock‘Cl›Á
(
»Œy_times
) {

616 
	`ALOGV
("%s", 
__FUNCTION__
);

617 
fd
;

618 
sockaddr_un
 
£r_addr
;

619 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

620 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

621 
	`¡rıy
(
£r_addr
.
sun_·th
, 
UNIX_DOMAIN
);

622 
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

624 ià(
fd
 < 0) {

625 
	`ALOGE
("sock‘ƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”ºo
));

626  
çl£
;

629 
æags
 = 
	`fú
(
fd
, 
F_GETFD
);

630 
æags
 |ğ
FD_CLOEXEC
;

631 
	`fú
(
fd
, 
F_SETFD
, 
æags
);

633 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

634 ià(
»t
 < 0) {

635 
	`ALOGE
("cÚÃù sock‘ƒ¼Ü: %s,times:%d\n", 
	`¡»¼Ü
(
”ºo
), 
»Œy_times
);

636 ::
	`şo£
(
fd
);

637 
mSock‘Fd
 = -1;

638  
çl£
;

641 
mSock‘Fd
 = 
fd
;

642 
	`ALOGD
("mSock‘Fd =%d,times=%d", 
mSock‘Fd
, 
»Œy_times
);

643  
Œue
;

644 
	}
}

646 *
	gBlu‘oÙhCÚŒŞËr
::
	$R—dTh»adW¿µ”
(*
me
) {

648 
Blu‘oÙhCÚŒŞËr
 *
moduË
 = 
¡©ic_ÿ¡
<Blu‘oÙhCÚŒŞË¸*>(
me
);

649 
moduË
->
	`R—dTh»adFunc
();

650  
NULL
;

651 
	}
}

653 
	gBlu‘oÙhCÚŒŞËr
::
	$´štPack‘Info
(cÚ¡ *
t™Ë
, cÚ¡ *
buf
, 
size
, 
boŞ
 
»®y
) {

654 iàĞ
»®y
) {

655 
j
, 
i
, 
k
;

656 
´tšfo
[512], 
´2
[256];

658 ià(
»®y
)

659 
	`ALOGE
(" -%s-size=%d--- -¡¬t-------", 
t™Ë
, 
size
);

661 
	`ALOGD
(" -%s-size=%d--- -¡¬t-------", 
t™Ë
, 
size
);

662 
k
 = 
i
 = 0; i < 
size
; k++) {

663 
´tšfo
[0] = 0;

664 
´2
[0] = 0;

665 
j
 = 0; (
i
 < 
size
 && j < 16); j++, i++) {

666 
	`¥rštf
(
´2
 + 
j
, "%c", 
	`isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

667 
	`¥rštf
(
´tšfo
 + 
	`¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
]) & 0xff);

669 ià(
»®y
)

670 
	`ALOGE
("%3x| % -- %s", 
k
, 
´tšfo
, 
´2
);

672 
	`ALOGD
("%3x| % -- %s", 
k
, 
´tšfo
, 
´2
);

674 ià(
»®y
)

675 
	`ALOGE
(" -%s-size=%d--’d----------", 
t™Ë
, 
size
);

677 
	`ALOGD
(" -%s-size=%d--’d----------", 
t™Ë
, 
size
);

679 
	}
}

681 
	gBlu‘oÙhCÚŒŞËr
::
	$R—dTh»adFunc
() {

682 
»cv_buf
[
BUFFER_SIZE
];

683 *
»cv_±r
;

684 
couÁ
 = 1, 
»Œy_times
;

685 
boŞ
 
´štæag
;

688 ià(
mSock‘Fd
 <= 0) {

689 
	`u¦“p
(200 * 1000);

690 ià(
	`isO³Ãd
()) {

691 ià(
»Œy_times
 == 0)

692 
	`u¦“p
(400 * 1000);

693 
	`»¡¬tSock‘Cl›Á
(++
»Œy_times
);

695 ià(
mSock‘Fd
 > 0) {

696 
»Œy_times
 = 0;

697 if(
a2dp_nÙify_ÿÎ_back
){

698 
	`A2DPNÙify
(
a2dp_nÙify_ÿÎ_back
);

700 } ià(
»Œy_times
 > 40) {

701 
	`ALOGE
("socket wrong,„etry open");

702 
»Œy_times
 = 0;

706 
mSock‘Fd
 > 0) {

707 
	`mem£t
(
»cv_buf
, 0, 
BUFFER_SIZE
);

708 
couÁ
 = 
	`»cv
(
mSock‘Fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

709 ià(
couÁ
 <= 0) {

710 
	`ALOGE
("sock‘ i şo£ !ƒ¼Ü=%s(%d)", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

711 ::
	`şo£
(
mSock‘Fd
);

712 
mSock‘Fd
 = -1;

717 
»cv_±r
 = 
»cv_buf
;

718 
´štæag
 = 
çl£
;

720 ià(
	`memcmp
(
btcmdSŒ
[
CMD_OPEN_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_OPEN_OK_IDX])) == 0)

722 
isİ’ok
 = 
Œue
;

723 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_OPEN_OK_IDX
]);

724 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_OPEN_OK_IDX
]);

725 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_CLOSE_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_CLOSE_OK_IDX])) == 0)

727 
isşo£ok
 = 
Œue
;

728 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_CLOSE_OK_IDX
]);

729 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_CLOSE_OK_IDX
]);

730 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_DISABLE_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DISABLE_OK_IDX])) == 0)

732 
ddiscÚÃù
 = 
Œue
;

733 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DISABLE_OK_IDX
]);

734 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DISABLE_OK_IDX
]);

735 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_DISCMPL_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DISCMPL_IDX])) == 0)

737 ià(
disc_ÿÎ_back
 !ğ
NULL
) {

738 
	`disc_ÿÎ_back
(
DISC_CMPL_EVT
, 
NULL
);

739 
disc_ÿÎ_back
 = 
NULL
;

741 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DISCMPL_IDX
]);

742 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DISCMPL_IDX
]);

743 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_OPEN_IDX])) == 0)

745 ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_OPEN_OK_IDX])) == 0)

747 
avLškUp
 = 
Œue
;

748 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_OK_IDX
]);

749 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_OK_IDX
]);

750 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_FAILED_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_OPEN_FAILED_IDX])) == 0)

752 
avLškUp
 = 
çl£
;

753 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_FAILED_IDX
]);

754 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_OPEN_FAILED_IDX
]);

756 
avLškWa™
 = 
Œue
;

757 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_CLOSE_IDX])) == 0)

759 ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_CLOSE_OK_IDX])) == 0)

761 
avLškDn
 = 
Œue
;

762 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_OK_IDX
]);

763 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_OK_IDX
]);

764 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_FAILED_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_SOURCE_CLOSE_FAILED_IDX])) == 0)

766 
avLškDn
 = 
çl£
;

767 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_FAILED_IDX
]);

768 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_SOURCE_CLOSE_FAILED_IDX
]);

770 
avLškDnWa™
 = 
Œue
;

771 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_DELLINKED_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DELLINKED_IDX])) == 0)

773 ià(
	`memcmp
(
btcmdSŒ
[
CMD_DELLINKED_OK_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DELLINKED_OK_IDX])) == 0)

775 
d–lšk
 = 
Œue
;

776 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DELLINKED_OK_IDX
]);

777 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DELLINKED_OK_IDX
]);

778 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_DELLINKED_FAILED_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DELLINKED_FAILED_IDX])) == 0)

780 
d–lšk
 = 
çl£
;

781 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DELLINKED_FAILED_IDX
]);

782 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_DELLINKED_FAILED_IDX
]);

784 
isd–lšked
 = 
Œue
;

785 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_LINKINGCMPL_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_LINKINGCMPL_IDX])) == 0)

787 ià(
lškšg_ÿÎ_back
 !ğ
NULL
) {

788 
	`lškšg_ÿÎ_back
(
DISC_CMPL_EVT
, 
NULL
);

789 
lškšg_ÿÎ_back
 = 
NULL
;

791 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_LINKINGCMPL_IDX
]);

792 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_LINKINGCMPL_IDX
]);

793 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_LINKING_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_LINKING_IDX])) == 0)

795 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_LINKING_IDX
]);

796 
REMOTE_DEVICE
 
msg
;

797 ià(
lškšg_ÿÎ_back
 !ğ
NULL
) {

798 
	`mem£t
(&
msg
, 0, (msg));

799 
msg
.
bd_ty³
 = 
»cv_±r
[
msgËn
];

800 
	`memıy
(
msg
.
bd_addr
, &
»cv_±r
[
msgËn
 + 1], 
BD_ADDR_SIZE
);

801 
msgËn
 +ğ1 + 
BD_ADDR_SIZE
;

802 
	`¡rıy
(
msg
.
Çme
, &
»cv_±r
[
msgËn
]);

803 
msgËn
 +ğ
	`¡¾’
(&
»cv_±r
[msglen]) + 1;

805 
	`lškšg_ÿÎ_back
(
DISC_NEW_EVT
, &
msg
);

807 
couÁ
 -ğ
msgËn
;

808 
»cv_±r
 +ğ
msgËn
;

809 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_LINKEDCMPL_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_LINKEDCMPL_IDX])) == 0)

811 ià(
lšked_ÿÎ_back
 !ğ
NULL
) {

812 
	`lšked_ÿÎ_back
(
DISC_CMPL_EVT
, 
NULL
);

813 
lšked_ÿÎ_back
 = 
NULL
;

815 
couÁ
 -ğ
	`¡¾’
(
btcmdSŒ
[
CMD_LINKEDCMPL_IDX
]);

816 
»cv_±r
 +ğ
	`¡¾’
(
btcmdSŒ
[
CMD_LINKEDCMPL_IDX
]);

817 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_LINKED_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_LINKED_IDX])) == 0)

819 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_LINKED_IDX
]);

820 
REMOTE_DEVICE
 
msg
;

821 ià(
lšked_ÿÎ_back
 !ğ
NULL
) {

822 
	`mem£t
(&
msg
, 0, (msg));

823 
msg
.
bd_ty³
 = 
»cv_±r
[
msgËn
];

824 
	`memıy
(
msg
.
bd_addr
, &
»cv_±r
[
msgËn
 + 1], 
BD_ADDR_SIZE
);

825 
msgËn
 +ğ1 + 
BD_ADDR_SIZE
;

826 
	`¡rıy
(
msg
.
Çme
, &
»cv_±r
[
msgËn
]);

827 
msgËn
 +ğ
	`¡¾’
(&
»cv_±r
[msglen]) + 1;

829 
	`lšked_ÿÎ_back
(
DISC_NEW_EVT
, &
msg
);

831 
couÁ
 -ğ
msgËn
;

832 
»cv_±r
 +ğ
msgËn
;

833 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_DISCOVERY_IDX
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_DISCOVERY_IDX])) == 0)

835 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_DISCOVERY_IDX
]);

836 
REMOTE_DEVICE
 
msg
;

837 ià(
disc_ÿÎ_back
) {

838 
	`mem£t
(&
msg
, 0, (msg));

839 
msg
.
bd_ty³
 = 
»cv_±r
[
msgËn
];

840 
	`memıy
(
msg
.
bd_addr
, &
»cv_±r
[
msgËn
 + 1], 
BD_ADDR_SIZE
);

841 
msgËn
 +ğ1 + 
BD_ADDR_SIZE
;

842 
	`¡rıy
(
msg
.
Çme
, &
»cv_±r
[
msgËn
]);

843 
msgËn
 +ğ
	`¡¾’
(&
»cv_±r
[msglen]) + 1;

844 
	`disc_ÿÎ_back
(
DISC_NEW_EVT
, &
msg
);

846 
couÁ
 -ğ
msgËn
;

847 
»cv_±r
 +ğ
msgËn
;

848 #ifdeà
BLUETOOTH_AG_SUPPORT


849 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_AG_SOURCE_OPEN
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_AG_SOURCE_OPEN])) == 0) {

850 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_AG_SOURCE_OPEN
]);

851 ià(
	`¡ºcmp
(
»cv_buf
, "ok", 2) == 0) {

852 
msgËn
 += 2;

853 
agLšked
 = 
Œue
;

855 
msgËn
 +ğ
	`¡¾’
("failed");

857 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

858 
couÁ
 -ğ
msgËn
;

859 
»cv_±r
 +ğ
msgËn
;

860 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_AG_SOURCE_CLOSE
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_AG_SOURCE_CLOSE])) == 0) {

861 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_AG_SOURCE_CLOSE
]);

862 ià(
	`¡ºcmp
(
»cv_buf
, "ok", 2) == 0) {

863 
msgËn
 += 2;

864 
agLšked
 = 
Œue
;

866 
msgËn
 +ğ
	`¡¾’
("failed");

868 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

869 
couÁ
 -ğ
msgËn
;

870 
»cv_±r
 +ğ
msgËn
;

872 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_AV_NOTIFY
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_AV_NOTIFY])) == 0) {

873 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_AV_NOTIFY
]);

874 
¡©e
;

875 ià('0' =ğ
»cv_±r
[
msgËn
])

876 
¡©e
 = 0;

878 
¡©e
 = 1;

879 
	`ALOGD
("»cv %s,¡©e:%d.", 
»cv_±r
, 
¡©e
);

880 ià(
a2dp_nÙify_ÿÎ_back
) {

881 
	`a2dp_nÙify_ÿÎ_back
(
¡©e
);

883 
couÁ
 -ğ
msgËn
 + 1;

884 
»cv_±r
 +ğ
msgËn
 + 1;

885 } ià(
	`memcmp
(
btcmdSŒ
[
CMD_A2DP_AV_CHECK_CONNECT
], 
»cv_±r
, 
	`¡¾’
(btcmdStr[CMD_A2DP_AV_CHECK_CONNECT])) == 0) {

886 
msgËn
 = 
	`¡¾’
(
btcmdSŒ
[
CMD_A2DP_AV_CHECK_CONNECT
]);

887 ià('y' =ğ
»cv_±r
[
msgËn
])

888 
mavIsCÚÃùed
 = 1;

890 
mavIsCÚÃùed
 = 0;

891 
	`ALOGD
("av_check_cÚÃù %s,¡©e:%d.", 
»cv_±r
, 
mavIsCÚÃùed
);

892 
	`±h»ad_cÚd_sigÇl
(&
mAvCÚd™iÚ
);

894 
couÁ
 -ğ
msgËn
 + 2;

895 
»cv_±r
 +ğ
msgËn
 + 2;

897 ià(
´štæag
 =ğ
çl£
) {

898 
	`´štPack‘Info
("mis£d Blu‘oÙhCÚŒŞËr::R—dTh»adFunømsg", 
»cv_±r
, 
couÁ
, 
Œue
);

899 
´štæag
 = 
Œue
;

901 
couÁ
--;

902 
»cv_±r
++;

905 } 
couÁ
 > 0);

907 ià(
	`¡r¡r
(
»cv_buf
, "open-ok") == &recv_buf[0]) {

908 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

909 } ià(
	`¡r¡r
(
»cv_buf
, "close-ok") == &recv_buf[0]) {

910 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

911 } ià(
	`¡r¡r
(
»cv_buf
, "disable-ok") == &recv_buf[0]) {

912 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

913 } ià(
	`¡r¡r
(
»cv_buf
, "disccmpl-") == &recv_buf[0]) {

914 
	`disc_ÿÎ_back
(
DISC_CMPL_EVT
, 
NULL
);

915 } ià(
	`¡r¡r
(
»cv_buf
, "a2dp-source-open-") == &recv_buf[0]) {

916 ià(
	`¡r¡r
(
»cv_buf
, "ok"è!ğ
NULL
)

917 
avLšked
 = 
Œue
;

918 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

919 } ià(
	`¡r¡r
(
»cv_buf
, "a2dp-source-close-") == &recv_buf[0]) {

920 ià(
	`¡r¡r
(
»cv_buf
, "ok"è!ğ
NULL
)

921 
avLšked
 = 
Œue
;

922 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

923 } ià(
	`¡r¡r
(
»cv_buf
, "discov”y-"è!ğ
NULL
) {

924 
REMOTE_DEVICE
 
msg
;

925 
	`mem£t
(&
msg
, 0, (msg));

926 
	`memıy
(
msg
.
bd_addr
, &
»cv_buf
[
	`¡¾’
("discov”y-")], 
BD_ADDR_SIZE
);

927 
	`¡rıy
(
msg
.
Çme
, &
»cv_buf
[
	`¡¾’
("discov”y-"è+ 
BD_ADDR_SIZE
]);

929 
	`disc_ÿÎ_back
(
DISC_NEW_EVT
, &
msg
);

930 #ifdeà
BLUETOOTH_AG_SUPPORT


931 } ià(
	`¡r¡r
(
»cv_buf
, "ag-source-open-") == &recv_buf[0]) {

932 ià(
	`¡r¡r
(
»cv_buf
, "ok"è!ğ
NULL
)

933 
agLšked
 = 
Œue
;

934 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

935 } ià(
	`¡r¡r
(
»cv_buf
, "ag-source-close-") == &recv_buf[0]) {

936 ià(
	`¡r¡r
(
»cv_buf
, "ok"è!ğ
NULL
)

937 
agLšked
 = 
Œue
;

938 
	`±h»ad_cÚd_sigÇl
(&
mCÚd™iÚ
);

941 
	`ALOGD
("%s(è–£ sŒ¡rÔecv_buf),„ecv(ècouÁğ%d", 
__func__
, 
couÁ
);

948 
	`ALOGV
("readhread over \n");

949 
	}
}

	@sdk/BluetoothController.h

249 #iâdeà
BLUETOOTH_CONTROLLER_H_


250 
	#BLUETOOTH_CONTROLLER_H_


	)

252 
	~<¡dio.h
>

253 
	~<¡ršg
>

254 
	~"Blu‘oÙhUts.h
"

260 
usšg
 
	g¡d
::
¡ršg
;

261 şas 
	cBlu‘oÙhCÚŒŞËr
{

262 
	mpublic
:

263 
Blu‘oÙhCÚŒŞËr
* 
g‘In¡ªû
();

265 
	mvœtu®
 ~
Blu‘oÙhCÚŒŞËr
();

275 
boŞ
 
İ’
();

285 
boŞ
 
şo£
();

296 
boŞ
 
isO³Ãd
();

307 
boŞ
 
£tBËB—cÚ
(
¡©e
);

318 
boŞ
 
£tBlu‘oÙhVisib™y
(boŞ 
’abË
);

328 
boŞ
 
discÚÃù
();

339 
boŞ
 
A2DPSouûLškUp
(cÚ¡ 
BD_ADDR
 
addr
);

349 
boŞ
 
A2DPSouûLškDown
();

359 
boŞ
 
H—dS‘Answ”C®l
();

369 
boŞ
 
H—dS‘HªgUp
();

381 
boŞ
 
¡¬tDiscov”y
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
=8, 
ty³
=0);

392 
boŞ
 
	`g‘Lšked
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
=8);

402 
boŞ
 
	`d–lšked
(cÚ¡ 
BD_ADDR
 
addr
);

412 
boŞ
 
	`g‘Lškšg
((*
disc_back
)(
DISC_EVT
 
ev’t
, 
REMOTE_DEVICE
 *
p_d©a
), 
du¿tiÚ
=8);

422 
boŞ
 
	`¡İDiscov”y
();

435 
boŞ
 
	`ü—tBÚd
(cÚ¡ 
¡ršg
 & 
bd_Çme
);

447 
boŞ
 
	`»moveBÚd
(cÚ¡ 
¡ršg
 & 
bd_Çme
);

449 
boŞ
 
	`A2DPS’dVŞume
(
vŞume
=80);

450 
boŞ
 
	`A2DPSock‘R—dy
();

452 
boŞ
 
	`HFPAGLškUp
(cÚ¡ 
BD_ADDR
 
addr
);

454 
boŞ
 
	`HFPAGLškDown
();

456 
boŞ
 
	`AGO³nAudio
();

458 
boŞ
 
	`AGClo£Audio
();

460 
boŞ
 
	`A2DPNÙify
((*
a2dp_ÿÎback
)(
¡©e
));

461 
boŞ
 
	`A2DPCheckCÚÃù
(&
is_cÚÃù
);

462 
´iv©e
:

463 
	`Blu‘oÙhCÚŒŞËr
();

464 
Blu‘oÙhCÚŒŞËr
* 
sIn¡ªû
;

467 
boŞ
 
	`¡İSock‘Cl›Á
();

468 
boŞ
 
	`¡¬tSock‘Cl›Á
();

469 
	`´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
);

470 
boŞ
 
	`»¡¬tSock‘Cl›Á
(
»Œy_times
);

471 *
	`R—dTh»adW¿µ”
(*
me
);

472 
	`R—dTh»adFunc
();

473 
	`wa™True
(
boŞ
 *
isTrue
, 
timeout
);

474 
mavIsCÚÃùed
;

475 
mSock‘Fd
;

476 
±h»ad_t
 
mR—dTh»ad
;

478 
±h»ad_cÚd_t
 
mCÚd™iÚ
;

479 
±h»ad_cÚd_t
 
mAvCÚd™iÚ
;

480 
±h»ad_cÚd©Œ_t
 
mAvCÚd™iÚA‰r
;

481 
±h»ad_mu‹x_t
 
mMu‹x
;

	@sdk/BluetoothServer.cpp

2 
	#LOG_TAG
 "Blu‘oÙhS”v”"

	)

4 
	~<sigÇl.h
>

5 
	~<uts/Log.h
>

7 
	~"SµPrÙocŞ.h
"

8 
	~"BËPrÙocŞ.h
"

9 
	~"Blu‘oÙhS”v”.h
"

10 
	~"Blu‘oÙhUts.h
"

11 
	~<sys/sock‘.h
>

12 
	~<sys/un.h
>

13 
	~<”ºo.h
>

16 
	#UNIX_DOMAIN
 "/v¬/run/blu‘oÙh_sock‘"

	)

17 
	#BUFFER_SIZE
 4096

	)

19 #ifdeà
__ılu¥lus


23 
	~"­p_av.h
"

24 #ifdeà
BLUETOOTH_AG_SUPPORT


25 
	~"­p_ag.h
"

27 #ifdeà
BLUETOOTH_HILINK_SUPPORT


30 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

31 
£tBTEÇbË
(
boŞ
 
’abË
);

32 
­p_hs_ªsw”_ÿÎ
();

33 
­p_hs_hªgup
();

34 
­p_mgr_¡¬t_discov”y
((*
­pDiscCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
, 
ty³
);

35 
­p_disc_abÜt
();

36 
­p_mgr_£c_bÚd
(cÚ¡ * 
bd_Çme
);

37 
­p_mgr_£c_uÅaœ
(cÚ¡ * 
bd_Çme
);

38 
­p_mgr_g‘_lšked_deviûs
((*
­pG‘LškedCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
);

39 
­p_mgr_g‘_lškšg_deviûs
((*
­pG‘LškšgCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
);

40 
­p_mgr_d–_lšked_deviûs
(cÚ¡ 
BD_ADDR
 
addr
);

41 
Blu‘oÙhS”v”_š¡ªû
();

43 #ifdeà
__ılu¥lus


47 
Çme¥aû
 
	gªdroid
 {

48 
Blu‘oÙhS”v”
* 
	gBlu‘oÙhS”v”
::
sIn¡ªû
 = 
NULL
;

49 
Blu‘oÙhS”v”
* 
	gBlu‘oÙhS”v”
::
g‘In¡ªû
()

51 
ALOGD
("%s", 
__FUNCTION__
);

52 if(
	gsIn¡ªû
 =ğ
NULL
){

53 
sIn¡ªû
 = 
Ãw
 
Blu‘oÙhS”v”
();

55  
	gsIn¡ªû
;

58 
	gBlu‘oÙhS”v”
::
Blu‘oÙhS”v”
(){

59 
mDÚe
 = 
çl£
;

60 
¡¬tSock‘S”v”
();

61 
±h»ad_mu‹x_š™
(&
mDiscLock
, 
NULL
);

62 
±h»ad_mu‹x_š™
(&
mMu‹x
, 
NULL
);

63 
±h»ad_mu‹x_š™
(&
mBÚdLock
, 
NULL
);

64 
±h»ad_cÚd_š™
(&
mCÚd™iÚ
,
NULL
);

65 
	gmG‘tšgLškedDeviû
 = 
çl£
;

66 
	gmDiscov”šg
 = 
çl£
;

67 
±h»ad_mu‹x_š™
(&
mG‘LškedDeviûLock
,
NULL
);

68 
±h»ad_mu‹x_š™
(&
mG‘LškšgDeviûLock
,
NULL
);

69 
	gmG‘tšgLškšgDeviû
 = 
çl£
;

70 
	gmNÙifyCl›Áfd
 = -1;

73 
	gBlu‘oÙhS”v”
::~
Blu‘oÙhS”v”
()

75 
¡İSock‘S”v”
();

76 
±h»ad_cÚd_de¡roy
(&
mCÚd™iÚ
);

77 
±h»ad_mu‹x_de¡roy
(&
mMu‹x
);

78 
±h»ad_mu‹x_de¡roy
(&
mDiscLock
);

79 
±h»ad_mu‹x_de¡roy
(&
mBÚdLock
);

81 
±h»ad_mu‹x_de¡roy
(&
mG‘LškedDeviûLock
);

82 
±h»ad_mu‹x_de¡roy
(&
mG‘LškšgDeviûLock
);

85 
	gBlu‘oÙhS”v”
::
İ’Blu‘oÙh
(){

86 
ALOGV
("%s", 
__FUNCTION__
);

87 
±h»ad_mu‹x_lock
(&
mMu‹x
);

88 
£tBTEÇbË
(
Œue
);

89 
±h»ad_mu‹x_uÆock
(&
mMu‹x
);

92 
	gBlu‘oÙhS”v”
::
şo£Blu‘oÙh
(){

93 
ALOGV
("%s", 
__FUNCTION__
);

94 
±h»ad_mu‹x_lock
(&
mMu‹x
);

95 
£tBTEÇbË
(
çl£
);

96 
±h»ad_mu‹x_uÆock
(&
mMu‹x
);

99 
	gBlu‘oÙhS”v”
::
£tBlu‘oÙhVisib™y
(
boŞ
 
’abË
){

100 
ALOGV
("%s", 
__FUNCTION__
);

101 
±h»ad_mu‹x_lock
(&
mMu‹x
);

102 
£tBTVisib™y
(
’abË
,
Œue
);

103 
±h»ad_mu‹x_uÆock
(&
mMu‹x
);

106 
	gBlu‘oÙhS”v”
::
£tBËB—cÚ
(
¡©e
){

107 
ALOGD
("%s", 
__FUNCTION__
);

108 
±h»ad_mu‹x_lock
(&
mMu‹x
);

109 #ifdeà
BLUETOOTH_HILINK_SUPPORT


112 
±h»ad_mu‹x_uÆock
(&
mMu‹x
);

115 
	gBlu‘oÙhS”v”
::
di§bËBlu‘oÙh
(){

116 
ALOGV
("%s", 
__FUNCTION__
);

117 
±h»ad_mu‹x_lock
(&
mMu‹x
);

118 
BËPrÙocŞ
* 
	gbË
 = BËPrÙocŞ::
g‘In¡ªû
();

119 
SµPrÙocŞ
* 
	g¥p
 = SµPrÙocŞ::
g‘In¡ªû
();

121 if(
	g¥p
->
g‘SµBšdedS‹
()){

122 
	g¥p
->
discÚÃù
();

123 }if(
	gbË
->
g‘BËBšdedS‹
()){

124 
	gbË
->
»cvUnbÚd
();

126 
ALOGI
("bluetooth is disable‡lready");

128 
±h»ad_mu‹x_uÆock
(&
mMu‹x
);

131 
	gBlu‘oÙhS”v”
::
hsAnsw”C®l
(){

132 
ALOGV
("%s", 
__FUNCTION__
);

133 
­p_hs_ªsw”_ÿÎ
();

136 
	gBlu‘oÙhS”v”
::
hsHªgUp
(){

137 
ALOGV
("%s", 
__FUNCTION__
);

138 
­p_hs_hªgup
();

141 
	gBlu‘oÙhS”v”
::
ü—tBÚd
(cÚ¡ * 
bd_Çme
){

142 
ALOGV
("% Çmğ%s", 
__FUNCTION__
, 
bd_Çme
);

143 
±h»ad_mu‹x_lock
(&
mBÚdLock
);

144 
­p_mgr_£c_bÚd
(
bd_Çme
);

145 
±h»ad_mu‹x_uÆock
(&
mBÚdLock
);

148 
	gBlu‘oÙhS”v”
::
»moveBÚd
(cÚ¡ * 
bd_Çme
){

149 
ALOGV
("% Çmğ%s", 
__FUNCTION__
, 
bd_Çme
);

150 
±h»ad_mu‹x_lock
(&
mBÚdLock
);

151 
­p_mgr_£c_uÅaœ
(
bd_Çme
);

152 
±h»ad_mu‹x_uÆock
(&
mBÚdLock
);

155 
	gBlu‘oÙhS”v”
::
£ndLškedDeviûD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

156 ià(
	gev’t
 =ğ
APP_DISC_NEW_EVT
) {

157 
msg_Ën
;

158 
	gh—d_Ën
 = 
¡¾’
("linked-");

159 
	gmsg
[
h—d_Ën
+
BD_ADDR_SIZE
+
BD_NAME_SIZE
];

160 
memıy
(&
msg
[0],"lšked-",
h—d_Ën
);

161 
	gmsg
[
h—d_Ën
++] = 
p_d©a
->
disc_Ãw
.
bd_ty³
;

162 
memıy
(&
msg
[
h—d_Ën
],
p_d©a
->
disc_Ãw
.
bd_addr
,
BD_ADDR_SIZE
);

163 
	gmsg_Ën
 = 
h—d_Ën
+
BD_ADDR_SIZE
;

164 
memıy
(&
msg
[
h—d_Ën
+
BD_ADDR_SIZE
],
p_d©a
->
disc_Ãw
.
Çme
,
¡¾’
(p_data->disc_new.name)+1);

165 
	gmsg_Ën
 +ğ
¡¾’
(
p_d©a
->
disc_Ãw
.
Çme
)+1;

167 
	gLi¡
<>::
™”©Ü
 
™
;

168 
	g™
 = 
mG‘LškedDeviûMªag”
.
begš
(); iˆ!ğmG‘LškedDeviûMªag”.
’d
(); ++it){

169 ::
£nd
(*
™
, 
msg
, 
msg_Ën
, 0);

170 ::
sync
();

172 } if(
	gev’t
 =ğ
APP_DISC_CMPL_EVT
) {

173 
±h»ad_mu‹x_lock
(&
mG‘LškedDeviûLock
);

174 
	gmG‘tšgLškedDeviû
 = 
çl£
;

175 
±h»ad_mu‹x_uÆock
(&
mG‘LškedDeviûLock
);

176 
¡ršg
 
	gmsg
 = "linkedcmpl-";

177 
	gLi¡
<>::
™”©Ü
 
™
;

178 
	g™
 = 
mG‘LškedDeviûMªag”
.
begš
(); iˆ!ğmG‘LškedDeviûMªag”.
’d
(); ++it){

179 ::
£nd
(*
™
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

180 ::
sync
();

182 
	gmG‘LškedDeviûMªag”
.
ş—r
();

186 
	gBlu‘oÙhS”v”
::
­p_g‘lšked_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

187 
	gev’t
)

190 
	gAPP_DISC_NEW_EVT
:{

191 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

193 
	g£rv”
->
£ndLškedDeviûD©aToCl›Á
(
ev’t
, 
p_d©a
);

196 
	gAPP_DISC_CMPL_EVT
: {

197 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

199 
	g£rv”
->
£ndLškedDeviûD©aToCl›Á
(
ev’t
, 
NULL
);

203 
ALOGE
("­p_g‘lšked_cback unknowÀev’t:%d", 
ev’t
);

208 
	gBlu‘oÙhS”v”
::
g‘LškedDeviû
(
ş›Á_fd
, 
du¿tiÚ
)

210 
±h»ad_mu‹x_lock
(&
mG‘LškedDeviûLock
);

212 ià(
	gmG‘tšgLškedDeviû
) {

213 
	gmG‘LškedDeviûMªag”
.
push_back
(
ş›Á_fd
);

214 
±h»ad_mu‹x_uÆock
(&
mG‘LškedDeviûLock
);

219 
	gmG‘LškedDeviûMªag”
.
push_back
(
ş›Á_fd
);

220 
	gmG‘tšgLškedDeviû
 = 
Œue
;

221 
±h»ad_mu‹x_uÆock
(&
mG‘LškedDeviûLock
);

222 
­p_mgr_g‘_lšked_deviûs
(
­p_g‘lšked_cback
, 
du¿tiÚ
);

227 
	gBlu‘oÙhS”v”
::
£ndLškšgDeviûD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

228 ià(
	gev’t
 =ğ
APP_DISC_NEW_EVT
) {

229 
msg_Ën
;

230 
	gh—d_Ën
 = 
¡¾’
("linking-");

231 
	gmsg
[
h—d_Ën
+
BD_ADDR_SIZE
+
BD_NAME_SIZE
];

232 
memıy
(&
msg
[0],"lškšg-",
h—d_Ën
);

233 
	gmsg
[
h—d_Ën
++] = 
p_d©a
->
disc_Ãw
.
bd_ty³
;

234 
memıy
(&
msg
[
h—d_Ën
],
p_d©a
->
disc_Ãw
.
bd_addr
,
BD_ADDR_SIZE
);

235 
	gmsg_Ën
 = 
h—d_Ën
+
BD_ADDR_SIZE
;

236 
memıy
(&
msg
[
h—d_Ën
+
BD_ADDR_SIZE
],
p_d©a
->
disc_Ãw
.
Çme
,
¡¾’
(p_data->disc_new.name)+1);

237 
	gmsg_Ën
 +ğ
¡¾’
(
p_d©a
->
disc_Ãw
.
Çme
)+1;

239 
	gLi¡
<>::
™”©Ü
 
™
; 
	gfÜiii
=0;

240 
	g™
 = 
mG‘LškšgDeviûMªag”
.
begš
(); iˆ!ğmG‘LškšgDeviûMªag”.
’d
(); ++it){

241 ::
£nd
(*
™
, 
msg
, 
msg_Ën
, 0);

242 ::
sync
();

244 } if(
	gev’t
 =ğ
APP_DISC_CMPL_EVT
) {

245 
±h»ad_mu‹x_lock
(&
mG‘LškšgDeviûLock
);

246 
	gmG‘tšgLškšgDeviû
 = 
çl£
;

247 
±h»ad_mu‹x_uÆock
(&
mG‘LškšgDeviûLock
);

248 
¡ršg
 
	gmsg
 = "linkingcmpl-";

249 
	gLi¡
<>::
™”©Ü
 
™
;

250 
	g™
 = 
mG‘LškšgDeviûMªag”
.
begš
(); iˆ!ğmG‘LškšgDeviûMªag”.
’d
(); ++it){

251 ::
£nd
(*
™
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

252 ::
sync
();

254 
	gmG‘LškšgDeviûMªag”
.
ş—r
();

258 
	gBlu‘oÙhS”v”
::
­p_g‘lškšg_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

259 
	gev’t
)

262 
	gAPP_DISC_NEW_EVT
:{

263 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

265 
	g£rv”
->
£ndLškšgDeviûD©aToCl›Á
(
ev’t
, 
p_d©a
);

268 
	gAPP_DISC_CMPL_EVT
: {

269 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

271 
	g£rv”
->
£ndLškšgDeviûD©aToCl›Á
(
ev’t
, 
NULL
);

275 
ALOGE
("­p_g‘lškšg_cback unknowÀev’t:%d", 
ev’t
);

280 
	gBlu‘oÙhS”v”
::
g‘LškšgDeviû
(
ş›Á_fd
, 
du¿tiÚ
)

282 
±h»ad_mu‹x_lock
(&
mG‘LškšgDeviûLock
);

284 ià(
	gmG‘tšgLškšgDeviû
) {

285 
	gmG‘LškšgDeviûMªag”
.
push_back
(
ş›Á_fd
);

286 
±h»ad_mu‹x_uÆock
(&
mG‘LškšgDeviûLock
);

291 
	gmG‘LškšgDeviûMªag”
.
push_back
(
ş›Á_fd
);

292 
	gmG‘tšgLškšgDeviû
 = 
Œue
;

293 
±h»ad_mu‹x_uÆock
(&
mG‘LškšgDeviûLock
);

294 
­p_mgr_g‘_lškšg_deviûs
(
­p_g‘lškšg_cback
, 
du¿tiÚ
);

301 
	gBlu‘oÙhS”v”
::
­p_av_nÙify_cback
(
¡©e
) {

302 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

303 if(
	g£rv”
->
	gmNÙifyCl›Áfd
 > 0) {

304 
¡ršg
 
	gmsg
 = "a2dp-av-notify-";

305 
	gmsg
.
­³nd
(
¡d
::
to_¡ršg
(
¡©e
));

306 
ALOGD
("£rv” s’d %s,¡©e:%d",
msg
.
c_¡r
(),
¡©e
);

307 ::
£nd
(
£rv”
->
mNÙifyCl›Áfd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0);

308 ::
sync
();

311 
	gBlu‘oÙhS”v”
::
avS‘NÙify
(
ş›Á_fd
, 
nÙify
) {

312 
±h»ad_mu‹x_lock
(&
mDiscLock
);

313 if(
	gnÙify
){

314 
	gmNÙifyCl›Áfd
 = 
ş›Á_fd
;

315 
­p_av_£t_nÙify_cb
(
­p_av_nÙify_cback
);

317 
­p_av_£t_nÙify_cb
(
NULL
);

318 
	gmNÙifyCl›Áfd
 = -1;

320 
±h»ad_mu‹x_uÆock
(&
mDiscLock
);

322 
	gBlu‘oÙhS”v”
::
¡¬tDiscov”y
(
ş›Á_fd
, 
du¿tiÚ
, 
ty³
){

323 
ALOGV
("% deçuÉ du¿tiÚ = %d", 
__FUNCTION__
, 
du¿tiÚ
);

324 
±h»ad_mu‹x_lock
(&
mDiscLock
);

325 ià(
	gmDiscov”šg
) {

326 
	gmDiscov”yMªag”
.
push_back
(
ş›Á_fd
);

327 
±h»ad_mu‹x_uÆock
(&
mDiscLock
);

331 
­p_mgr_¡¬t_discov”y
(
­p_disc_cback
, 
du¿tiÚ
, 
ty³
);

332 
	gmDiscov”yMªag”
.
push_back
(
ş›Á_fd
);

333 
	gmDiscov”šg
 = 
Œue
;

335 
±h»ad_mu‹x_uÆock
(&
mDiscLock
);

338 
	gBlu‘oÙhS”v”
::
¡İDiscov”y
(
ş›Á_fd
){

339 
ALOGV
("%s", 
__FUNCTION__
);

340 
±h»ad_mu‹x_lock
(&
mDiscLock
);

341 
­p_disc_abÜt
();

342 
	gmDiscov”yMªag”
.
ş—r
();

343 
	gmDiscov”šg
 = 
çl£
;

344 
±h»ad_mu‹x_uÆock
(&
mDiscLock
);

348 
	gBlu‘oÙhS”v”
::
­p_disc_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

349 
	gev’t
)

352 
	gAPP_DISC_NEW_EVT
:{

353 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

355 
	g£rv”
->
£ndDiscD©aToCl›Á
(
ev’t
, 
p_d©a
);

358 
	gAPP_DISC_CMPL_EVT
: {

359 
Blu‘oÙhS”v”
 *
£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(Blu‘oÙhS”v”::
g‘In¡ªû
());

361 
	g£rv”
->
£ndDiscD©aToCl›Á
(
ev’t
, 
NULL
);

365 
ALOGE
("­p_disc_cback unknowÀev’t:%d", 
ev’t
);

385 
	gBlu‘oÙhS”v”
::
£ndDiscD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
){

386 ià(
	gev’t
 =ğ
APP_DISC_NEW_EVT
) {

388 
msg_Ën
;

389 
	gh—d_Ën
 = 
¡¾’
("discovery-");

390 
	gmsg
[
h—d_Ën
+
BD_ADDR_SIZE
+
BD_NAME_SIZE
];

392 
memıy
(&
msg
[0],"discov”y-",
h—d_Ën
);

393 
	gmsg
[
h—d_Ën
++] = 
p_d©a
->
disc_Ãw
.
bd_ty³
;

394 
memıy
(&
msg
[
h—d_Ën
],
p_d©a
->
disc_Ãw
.
bd_addr
,
BD_ADDR_SIZE
);

395 
	gmsg_Ën
 = 
h—d_Ën
+
BD_ADDR_SIZE
;

396 
memıy
(&
msg
[
h—d_Ën
+
BD_ADDR_SIZE
],
p_d©a
->
disc_Ãw
.
Çme
,
¡¾’
(p_data->disc_new.name)+1);

397 
	gmsg_Ën
 +ğ
¡¾’
(
p_d©a
->
disc_Ãw
.
Çme
)+1;

405 
	gLi¡
<>::
™”©Ü
 
™
; 
	gfÜiii
=0;

406 
	g™
 = 
mDiscov”yMªag”
.
begš
(); iˆ!ğmDiscov”yMªag”.
’d
(); ++it){

407 ::
£nd
(*
™
, 
msg
, 
msg_Ën
, 0);

408 ::
sync
();

410 } if(
	gev’t
 =ğ
APP_DISC_CMPL_EVT
) {

411 
±h»ad_mu‹x_lock
(&
mDiscLock
);

412 
	gmDiscov”šg
 = 
çl£
;

413 
±h»ad_mu‹x_uÆock
(&
mDiscLock
);

414 
¡ršg
 
	gmsg
 = "disccmpl-";

415 
	gLi¡
<>::
™”©Ü
 
™
;

416 
	g™
 = 
mDiscov”yMªag”
.
begš
(); iˆ!ğmDiscov”yMªag”.
’d
(); ++it){

417 ::
£nd
(*
™
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

418 ::
sync
();

420 
	gmDiscov”yMªag”
.
ş—r
();

424 
	gBlu‘oÙhS”v”
::
¡İSock‘S”v”
(){

425 *
dummy
;

426 
	gmDÚe
 = 
Œue
;

427 
±h»ad_još
(
mAcû±Th»ad
, &
dummy
);

428 
şo£
(
mLi¡’fd
);

431 
	gBlu‘oÙhS”v”
::
¡¬tSock‘S”v”
(){

432 
sockaddr_un
 
£r_addr
;

433 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

434 
¡ºıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
,(ser_addr.sun_path)-1);

435 
uÆšk
(
UNIX_DOMAIN
);

436 
	gmLi¡’fd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

437 if(
	gmLi¡’fd
 < 0){

438 
ALOGE
("”rÜ: sock‘ c»©iÚ faed; skt_fd:%d\n", 
mLi¡’fd
);

441 if(
bšd
(
mLi¡’fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr)) < 0){

442 
ALOGE
(" bšdƒ¼Ü: %sÓ¼no: %d)\n",
¡»¼Ü
(
”ºo
),errno);

443 ::
şo£
(
mLi¡’fd
);

446 if(
li¡’
(
mLi¡’fd
, 1) < 0){

447 
ALOGE
("error: socket†isten failed\n");

448 ::
şo£
(
mLi¡’fd
);

452 
±h»ad_ü—‹
(&
mAcû±Th»ad
, 
NULL
, 
Blu‘oÙhS”v”
::
Acû±Th»adW¿µ”
, 
this
);

455 *
	gBlu‘oÙhS”v”
::
Acû±Th»adW¿µ”
(*
me
) {

456 
Blu‘oÙhS”v”
 *
sourû
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(
me
);

457 
	gsourû
->
Acû±Th»adFunc
();

458  
	gNULL
;

461 *
	gBlu‘oÙhS”v”
::
Cl›ÁR—dTh»adW¿µ”
(*
¬g
) {

462 
THREAD_ARG
 *
¬gs
 = (THREAD_ARG *)
¬g
;

463 
Blu‘oÙhS”v”
 *
	g£rv”
 = 
¡©ic_ÿ¡
<Blu‘oÙhS”v” *>(
¬gs
->
£rv”
);

464 
	g£rv”
->
Cl›ÁR—dTh»adFunc
(
¬gs
->
ş›Á_fd
);

465  
	gNULL
;

468 
	gBlu‘oÙhS”v”
::
Acû±Th»adFunc
(){

469 
buf
[
BUFFER_SIZE
];

470 
	g»adL’
 = 0;

471 
	gcouÁ
 = 0;

472 
	gmDÚe
 =ğ
çl£
){

473 
ş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

474 if(
	gş›Á_fd
 < 0){

475 
ALOGE
("cannot‡ccept client connect„equest");

478 
THREAD_ARG
 
	g¬g
;

479 
	g¬g
.
	g£rv”
 = 
this
;

480 
	g¬g
.
	gş›Á_fd
 = 
ş›Á_fd
;

481 
±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
Blu‘oÙhS”v”
::
Cl›ÁR—dTh»adW¿µ”
, &
¬g
);

484 
	gBlu‘oÙhS”v”
::
´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
)

486 ifĞ
	g»®y
)

488 
	gj
,
	gi
,
	gk
;

489 
	g´tšfo
[512],
	g´2
[256];

491 if(
	g»®y
)

492 
ALOGE
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

494 
ALOGD
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

495 
	gk
=
i
=0; 
	gi
<
	gsize
;k++)

497 
	g´tšfo
[0]=0;

498 
	g´2
[0] = 0;

499 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

501 
¥rštf
(
´2
+
j
, "%c", 
isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

502 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
])&0xff);

504 if(
	g»®y
)

505 
ALOGE
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

507 
ALOGD
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

509 if(
	g»®y
)

510 
ALOGE
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

512 
ALOGD
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

518 
	gBlu‘oÙhS”v”
::
Cl›ÁR—dTh»adFunc
(
ş›Á_fd_¬g
){

519 
»cv_buf
[
BUFFER_SIZE
];

520 
	gcouÁ
 = 1;

521 
	gş›Á_fd
 = 
ş›Á_fd_¬g
;

524 if(
	gş›Á_fd
 <= 0)

526 
u¦“p
(10*1000);

527 
	gş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

528 if(
	gş›Á_fd
 < 0){

529 
ALOGE
("wait‚ew mListenfd");

532 
ALOGD
("g‘‚ew mLi¡’fd=%d", 
mLi¡’fd
);

536 
mem£t
(
»cv_buf
, 0 ,
BUFFER_SIZE
);

537 
	gcouÁ
 = 
»cv
(
ş›Á_fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

538 if(
	gcouÁ
 <= 0){

539 
ALOGE
("sock‘ i şo£ !ƒ¼Ü=%s(%d)",
¡»¼Ü
(
”ºo
),errno);

540 
şo£
(
ş›Á_fd
);

541 
	gş›Á_fd
 = -1;

545 *
	g»cv_±r
;

546 
boŞ
 
	g´štæag
;

547 
	gbkcouÁ
 = 
couÁ
;

549 
	g´štæag
 = 
çl£
;

550 
	g»cv_±r
 = 
»cv_buf
;

551 
´štPack‘Info
("£rv”„—d msg", 
»cv_buf
, 
bkcouÁ
, 
Œue
);

554 if(
memcmp
(
»cv_±r
, "İ’-", 
¡¾’
("open-")) == 0)

556 
msgËn
 = 
¡¾’
("open-");

557 
İ’Blu‘oÙh
();

558 
¡ršg
 
	gmsg
 = "open-ok";

559 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

560 
	gcouÁ
 -ğ
msgËn
;

561 
	g»cv_±r
 +ğ
msgËn
;

562 }if(
memcmp
(
»cv_±r
, "şo£-", 
¡¾’
("close-")) == 0)

564 
msgËn
 = 
¡¾’
("close-");

565 
şo£Blu‘oÙh
();

566 
¡ršg
 
	gmsg
 = "close-ok";

567 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

568 
	gcouÁ
 -ğ
msgËn
;

569 
	g»cv_±r
 +ğ
msgËn
;

570 }if(
memcmp
(
»cv_±r
, "hwb—cÚ-", 
¡¾’
("hwbeacon-")) ==0) {

571 
msgËn
 = 
¡¾’
("hwbeacon-");

572 *
	g±r
 = 
»cv_±r
 + 
msgËn
;

573 if(
¡ºcmp
(
±r
,"1",1)==0){

574 
msgËn
 +=1;

575 
£tBËB—cÚ
(1);

576 }if(
¡ºcmp
(
±r
,"0",1)==0){

577 
msgËn
 += 1;

578 
£tBËB—cÚ
(0);

579 }if(
¡ºcmp
(
±r
,"2",1)==0){

580 
msgËn
 += 1;

581 
£tBËB—cÚ
(2);

582 }if(
¡ºcmp
(
±r
,"3",1)==0){

583 
msgËn
 += 1;

584 
£tBËB—cÚ
(3);

585 }if(
¡ºcmp
(
±r
,"4",1)==0){

586 
msgËn
 += 1;

587 
£tBËB—cÚ
(4);

589 
	gcouÁ
 -ğ
msgËn
;

590 
	g»cv_±r
 +ğ
msgËn
;

592 }if(
memcmp
(
»cv_±r
, "visib™y-" ,
¡¾’
("visibility-")) == 0)

594 
msgËn
;

595 if(
memcmp
(
»cv_±r
, "visib™y-Œue", 
¡¾’
("visibility-true")) == 0)

597 
£tBlu‘oÙhVisib™y
(
Œue
);

598 
	gmsgËn
 = 
¡¾’
("visibility-true");

602 
£tBlu‘oÙhVisib™y
(
çl£
);

603 
	gmsgËn
 = 
¡¾’
("visibility-false");

605 
	gcouÁ
 -ğ
msgËn
;

606 
	g»cv_±r
 +ğ
msgËn
;

607 }if(
memcmp
(
»cv_±r
, "di§bË-", 
¡¾’
("disable-")) == 0)

609 
msgËn
 = 
¡¾’
("disable-");

610 
di§bËBlu‘oÙh
();

611 
¡ršg
 
	gmsg
 = "disable-ok";

612 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

613 
	gcouÁ
 -ğ
msgËn
;

614 
	g»cv_±r
 +ğ
msgËn
;

615 }if(
memcmp
(
»cv_±r
, "ªsw”ÿÎ-", 
¡¾’
("answercall-")) == 0)

617 
msgËn
 = 
¡¾’
("answercall-");

618 
hsAnsw”C®l
();

619 
	gcouÁ
 -ğ
msgËn
;

620 
	g»cv_±r
 +ğ
msgËn
;

621 }if(
memcmp
(
»cv_±r
, "hªgup-", 
¡¾’
("hangup-")) == 0)

623 
msgËn
 = 
¡¾’
("hangup-");

624 
hsHªgUp
();

625 
	gcouÁ
 -ğ
msgËn
;

626 
	g»cv_±r
 +ğ
msgËn
;

627 }if(
memcmp
(
»cv_±r
, "g‘lškšg-", 
¡¾’
("getlinking-")) == 0)

629 
msgËn
 = 
¡¾’
("getlinking-");

631 
¡ršg
 
	gdu¿tiÚ
;

633 
	gdu¿tiÚ
.
assign
(
»cv_±r
+
msgËn
,
couÁ
-msglen);

634 
g‘LškšgDeviû
(
ş›Á_fd
, 
©oi
(
du¿tiÚ
.
c_¡r
()));

636 
	gibuf
[2];

637 
	gibuf
[0] = 
»cv_±r
[
msgËn
];

638 
	gibuf
[1] = 0;

639 
	gdu¿tiÚ
 = 
©oi
(
ibuf
);

640 
	gmsgËn
 ++;

641 
g‘LškšgDeviû
(
ş›Á_fd
, 
du¿tiÚ
);

643 
ALOGD
("g‘lškšg- du¿tiÚ:%d,msgËn:%d\n",
du¿tiÚ
,
msgËn
);

644 
	gcouÁ
 -ğ
msgËn
;

645 
	g»cv_±r
 +ğ
msgËn
;

646 }if(
memcmp
(
»cv_±r
, "g‘lšked-", 
¡¾’
("getlinked-")) ==0)

648 
msgËn
 = 
¡¾’
("getlinked-");

650 
¡ršg
 
	gdu¿tiÚ
;

652 
	gdu¿tiÚ
.
assign
(
»cv_±r
+
msgËn
,
couÁ
-msglen);

653 
g‘LškedDeviû
(
ş›Á_fd
, 
©oi
(
du¿tiÚ
.
c_¡r
()));

655 
	gibuf
[2];

656 
	gibuf
[0] = 
»cv_±r
[
msgËn
];

657 
	gibuf
[1] = 0;

658 
	gdu¿tiÚ
 = 
©oi
(
ibuf
);

659 
	gmsgËn
 ++;

660 
g‘LškedDeviû
(
ş›Á_fd
, 
du¿tiÚ
);

662 
ALOGD
("g‘lšked- du¿tiÚ:%d,msgËn:%d\n",
du¿tiÚ
,
msgËn
);

663 
	gcouÁ
 -ğ
msgËn
;

664 
	g»cv_±r
 +ğ
msgËn
;

665 }if(
memcmp
(
»cv_±r
, "d–lšked-", 
¡¾’
("dellinked-")) == 0)

667 
msgËn
 = 
¡¾’
("dellinked-");

668 
BD_ADDR
 
	gaddr
;

669 
memıy
(&
addr
,&
»cv_±r
[
msgËn
],
BD_ADDR_SIZE
);

670 
	gmsgËn
 +ğ
BD_ADDR_SIZE
;

671 
	g»t
 = 
­p_mgr_d–_lšked_deviûs
(
addr
);

672 if(
	g»t
 == 0)

673 ::
£nd
(
ş›Á_fd
,"d–lšked-ok",
¡¾’
("dellinked-ok"),0);

675 ::
£nd
(
ş›Á_fd
,"d–lšked-çed",
¡¾’
("dellinked-failed"),0);

676 
	gcouÁ
 -ğ
msgËn
;

677 
	g»cv_±r
 +ğ
msgËn
;

678 }if(
memcmp
(
»cv_±r
, "¡¬tdisc-", 
¡¾’
("startdisc-")) == 0)

680 
msgËn
 = 
¡¾’
("startdisc-");

681 
	gdu¿tiÚ
=8,
	gty³
=0;

683 *
	g±r
=
»cv_±r
+
¡¾’
("startdisc-");

684 
	gdu¿tiÚ
 = 
©oi
(
±r
);

685 
	g±r
 = 
¡rchr
(
±r
,'-');

686 if(
	g±r
){

687 
	g±r
 ++;

688 
	gty³
 = 
©oi
(
±r
);

690 
	gmsgËn
 = 
±r
 - 
»cv_±r
 + 2;

691 
ALOGD
("¡¬tdisc-%d-%d-,msgËn=%d",
du¿tiÚ
,
ty³
,
msgËn
);

692 
¡¬tDiscov”y
(
ş›Á_fd
, 
du¿tiÚ
, 
ty³
);

694 
	gcouÁ
 -ğ
msgËn
;

695 
	g»cv_±r
 +ğ
msgËn
;

696 }if(
memcmp
(
»cv_±r
, "¡İdisc-", 
¡¾’
("stopdisc-")) == 0)

698 
msgËn
 = 
¡¾’
("stopdisc-");

699 
¡İDiscov”y
(
ş›Á_fd
);

700 
	gcouÁ
 -ğ
msgËn
;

701 
	g»cv_±r
 +ğ
msgËn
;

702 }if(
memcmp
(
»cv_±r
, "ü—tbÚd-", 
¡¾’
("creatbond-")) == 0)

704 
msgËn
 = 
¡¾’
("creatbond-");

705 
¡ršg
 
	gÇme
;

707 
	gÇme
.
assign
(
»cv_±r
+
msgËn
,
couÁ
-msglen);

708 
ü—tBÚd
(
Çme
.
c_¡r
());

709 
	gcouÁ
 -ğ
msgËn
;

710 
	g»cv_±r
 +ğ
msgËn
;

711 }if(
memcmp
(
»cv_±r
, "»movebÚd-", 
¡¾’
("removebond-")) == 0)

713 
msgËn
 = 
¡¾’
("removebond-");

714 
¡ršg
 
	gÇme
;

716 
	gÇme
.
assign
(
»cv_±r
+
msgËn
,
couÁ
-msglen);

717 
»moveBÚd
(
Çme
.
c_¡r
());

718 
	gcouÁ
 -ğ
msgËn
;

719 
	g»cv_±r
 +ğ
msgËn
;

720 }if(
memcmp
(
»cv_±r
, "a2dp-sourû-İ’-", 
¡¾’
("a2dp-source-open-")) == 0)

722 
msgËn
 = 
¡¾’
("a2dp-source-open-");

723 
BD_ADDR
 
	gaddr
;

724 
memıy
(&
addr
,&
»cv_±r
[
msgËn
],
BD_ADDR_SIZE
);

725 
	gmsgËn
 +ğ
BD_ADDR_SIZE
;

727 
	g»t
 = 
­p_av_İ’
(&
addr
 );

728 if(
	g»t
 == 0)

729 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-İ’-ok",
¡¾’
("a2dp-source-open-ok"),0);

733 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-İ’-çed",
¡¾’
("a2dp-source-open-failed"),0);

735 
	gcouÁ
 -ğ
msgËn
;

736 
	g»cv_±r
 +ğ
msgËn
;

738 #ifdeà
BLUETOOTH_AG_SUPPORT


739 if(
memcmp
(
»cv_±r
, "ag-sourû-İ’-",
¡¾’
("ag-source-open-")) == 0) {

740 
msgËn
 = 
¡¾’
("ag-source-open-");

741 
BD_ADDR
 
	gaddr
;

742 
memıy
(&
addr
,&
»cv_±r
[
msgËn
],
BD_ADDR_SIZE
);

743 
	gmsgËn
 +ğ
BD_ADDR_SIZE
;

745 
	g»t
 = 
­p_ag_İ’
(&
addr
);

746 if(
	g»t
 == 0)

747 ::
£nd
(
ş›Á_fd
,"ag-sourû-İ’-ok",
¡¾’
("ag-source-open-ok"),0);

749 ::
£nd
(
ş›Á_fd
,"ag-sourû-İ’-çed",
¡¾’
("ag-source-open-failed"),0);

750 
	gcouÁ
 -ğ
msgËn
;

751 
	g»cv_±r
 +ğ
msgËn
;

753 }if(
memcmp
(
»cv_±r
, "ag-sourû-şo£-", 
¡¾’
("ag-source-close-")) == 0) {

754 
msgËn
 = 
¡¾’
("ag-source-close-");

755 
	g»t
 = 
­p_ag_şo£
();

757 if(
	g»t
 == 0)

758 ::
£nd
(
ş›Á_fd
,"ag-sourû-şo£-ok",
¡¾’
("ag-source-close-ok"),0);

760 ::
£nd
(
ş›Á_fd
,"ag-sourû-şo£-çed",
¡¾’
("ag-source-close-failed"),0);

761 
	gcouÁ
 -ğ
msgËn
;

762 
	g»cv_±r
 +ğ
msgËn
;

763 }if(
memcmp
(
»cv_±r
, "ag-İ’-audio-", 
¡¾’
( "ag-open-audio-")) == 0) {

764 
msgËn
 = 
¡¾’
("ag-open-audio-");

765 
­p_ag_İ’_audio
();

767 
	gcouÁ
 -ğ
msgËn
;

768 
	g»cv_±r
 +ğ
msgËn
;

769 }if(
memcmp
(
»cv_±r
, "ag-şo£-audio-" , 
¡¾’
("ag-close-audio-")) == 0) {

770 
msgËn
 = 
¡¾’
("ag-close-audio-");

771 
­p_ag_şo£_audio
();

773 
	gcouÁ
 -ğ
msgËn
;

774 
	g»cv_±r
 +ğ
msgËn
;

777 if(
memcmp
(
»cv_±r
, "a2dp-sourû-şo£-",
¡¾’
("a2dp-source-close-")) == 0)

779 
msgËn
 = 
¡¾’
("a2dp-source-close-");

780 
	g»t
 = 
­p_av_şo£
();

782 if(
	g»t
 == 0)

783 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-şo£-ok",
¡¾’
("a2dp-source-close-ok"),0);

787 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-şo£-çed",
¡¾’
("a2dp-source-close-failed"),0);

789 
	gcouÁ
 -ğ
msgËn
;

790 
	g»cv_±r
 +ğ
msgËn
;

791 }if(
memcmp
(
»cv_±r
, "a2dp-av-sock‘-»ady-", 
¡¾’
("a2dp-av-socket-ready-"))== 0) {

792 
msgËn
 = 
¡¾’
("a2dp-av-socket-ready-");

793 
ALOGD
("a2dp-av-socket-ready-:‡pp_av_socket_connect");

794 
­p_av_sock‘_cÚÃù
();

795 
	gcouÁ
 -ğ
msgËn
;

796 
	g»cv_±r
 +ğ
msgËn
;

797 }if(
memcmp
(
»cv_±r
, "a2dp-av-£nd-vŞume-", 
¡¾’
("a2dp-av-send-volume-")) == 0) {

798 
msgËn
 = 
¡¾’
("a2dp-av-send-volume-");

799 
	g»t
, 
	gvŞume
;

801 
	gvŞume
 = 
©oi
(&
»cv_±r
[
msgËn
]);

802 
ALOGD
("a2dp-av-£nd-vŞume-: %d", 
vŞume
);

803 
	g»t
 = 
­p_av_rc_£nd_absŞu‹_vŞume_vd_commªd
(0, 
vŞume
);

811 
	gcouÁ
 -ğ
msgËn
+1;

812 
	g»cv_±r
 +ğ
msgËn
+1;

813 }if(
memcmp
(
»cv_±r
, "a2dp-av-nÙify-", 
¡¾’
("a2dp-av-notify-")) == 0) {

814 
msgËn
 = 
¡¾’
("a2dp-av-notify-");

815 
	g¡©e
;

817 if('0' =ğ
»cv_±r
[
msgËn
])

818 
¡©e
 = 0;

820 
	g¡©e
 = 1;

822 
avS‘NÙify
(
ş›Á_fd
, 
¡©e
);

823 
	gcouÁ
 -ğ
msgËn
+1;

824 
	g»cv_±r
 +ğ
msgËn
+1;

825 }if(
memcmp
(
»cv_±r
, "a2dp-av-check_cÚÃù-", 
¡¾’
("a2dp-av-check_connect-")) == 0) {

826 
msgËn
 = 
¡¾’
("a2dp-av-check_connect-");

827 
	g¡©e
 = 
­p_av_is_cÚÃù
();

828 if(
	g¡©e
)

829 ::
£nd
(
ş›Á_fd
, "a2dp-av-check_cÚÃù-y-", 
¡¾’
("a2dp-av-check_connect-y-"), 0);

831 ::
£nd
(
ş›Á_fd
, "a2dp-av-check_cÚÃù-n-", 
¡¾’
("a2dp-av-check_connect-n-"), 0);

832 
	gcouÁ
 -ğ
msgËn
;

833 
	g»cv_±r
 +ğ
msgËn
;

835 
ALOGE
("no valid data be„eceived!");

836 if(
	g´štæag
 =ğ
çl£
)

838 
´štPack‘Info
("ÜigÇÈmsg", 
»cv_buf
, 
bkcouÁ
, 
Œue
);

839 
´štPack‘Info
("mis£d Blu‘oÙhS”v”::Cl›ÁR—dTh»adFunømsg", 
»cv_±r
, 
couÁ
, 
Œue
);

840 
	g´štæag
 = 
Œue
;

842 
	gcouÁ
 --;

843 
	g»cv_±r
 ++;

846 }
	gcouÁ
 > 0);

848 if(
¡r¡r
(
»cv_buf
, "open-") == &recv_buf[0]){

849 
İ’Blu‘oÙh
();

850 
¡ršg
 
	gmsg
 = "open-ok";

851 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

852 }if(
¡r¡r
(
»cv_buf
, "close-") == &recv_buf[0]){

853 
şo£Blu‘oÙh
();

854 
¡ršg
 
	gmsg
 = "close-ok";

855 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

856 }if(
¡r¡r
(
»cv_buf
, "visibility-") == &recv_buf[0]){

857 if(
¡r¡r
(
»cv_buf
, "Œue"è!ğ
NULL
)

858 
£tBlu‘oÙhVisib™y
(
Œue
);

860 
£tBlu‘oÙhVisib™y
(
çl£
);

861 }if(
¡r¡r
(
»cv_buf
, "disable-") == &recv_buf[0]){

862 
di§bËBlu‘oÙh
();

863 
¡ršg
 
	gmsg
 = "disable-ok";

864 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

865 }if(
¡r¡r
(
»cv_buf
, "answercall-") == &recv_buf[0]){

866 
hsAnsw”C®l
();

867 }if(
¡r¡r
(
»cv_buf
, "hangup-") == &recv_buf[0]){

868 
hsHªgUp
();

869 }if(
¡r¡r
(
»cv_buf
, "startdisc-") == &recv_buf[0]) {

870 
¡ršg
 
du¿tiÚ
;

871 
	gh—d_Ën
 = 
¡¾’
("startdisc-");

872 
	gdu¿tiÚ
.
assign
(
»cv_buf
+
h—d_Ën
,
couÁ
-head_len);

873 
¡¬tDiscov”y
(
ş›Á_fd
, 
©oi
(
du¿tiÚ
.
c_¡r
()));

874 }if(
¡r¡r
(
»cv_buf
, "stopdisc-") == &recv_buf[0]) {

875 
¡İDiscov”y
(
ş›Á_fd
);

876 }if(
¡r¡r
(
»cv_buf
, "creatbond-") == &recv_buf[0]) {

877 
¡ršg
 
Çme
;

878 
	gh—d_Ën
 = 
¡¾’
("creatbond-");

879 
	gÇme
.
assign
(
»cv_buf
+
h—d_Ën
,
couÁ
-head_len);

880 
ü—tBÚd
(
Çme
.
c_¡r
());

881 }if(
¡r¡r
(
»cv_buf
, "removebond-") == &recv_buf[0]) {

882 
¡ršg
 
Çme
;

883 
	gh—d_Ën
 = 
¡¾’
("removebond-");

884 
	gÇme
.
assign
(
»cv_buf
+
h—d_Ën
,
couÁ
-head_len);

885 
»moveBÚd
(
Çme
.
c_¡r
());

886 }if(
¡r¡r
(
»cv_buf
, "a2dp-source-open-") == &recv_buf[0]) {

887 
BD_ADDR
 
addr
;

888 
memıy
(&
addr
,&
»cv_buf
[
¡¾’
("a2dp-sourû-İ’-")],
BD_ADDR_SIZE
);

890 
	g»t
 = 
­p_av_İ’
(&
addr
);

891 if(
	g»t
 == 0)

892 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-İ’-ok",
¡¾’
("a2dp-source-open-ok"),0);

894 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-İ’-çed",
¡¾’
("a2dp-source-open-failed"),0);

896 }if(
¡r¡r
(
»cv_buf
, "a2dp-source-close-") == &recv_buf[0]) {

897 
»t
 = 
­p_av_şo£
();

899 if(
	g»t
 == 0)

900 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-şo£-ok",
¡¾’
("a2dp-source-close-ok"),0);

902 ::
£nd
(
ş›Á_fd
,"a2dp-sourû-şo£-çed",
¡¾’
("a2dp-source-close-failed"),0);

904 }if(
¡r¡r
(
»cv_buf
, "a2dp-av-send-volume-") == &recv_buf[0]) {

905 
»t
, 
vŞume
;

907 
	gvŞume
 = 
©oi
(&
»cv_buf
[
¡¾’
("a2dp-av-send-volume-")]);

908 
ALOGD
("a2dp-av-£nd-vŞume-: %d", 
vŞume
);

909 
	g»t
 = 
­p_av_rc_£nd_absŞu‹_vŞume_vd_commªd
(0, 
vŞume
);

911 if(
	g»t
 == 0)

912 ::
£nd
(
ş›Á_fd
,"a2dp-av-£nd-vŞume-ok",
¡¾’
("a2dp-av-send-volume-ok"),0);

914 ::
£nd
(
ş›Á_fd
,"a2dp-av-£nd-vŞume-çed",
¡¾’
("a2dp-av-send-volume-failed"),0);

915 #ifdeà
BLUETOOTH_AG_SUPPORT


916 }if(
¡r¡r
(
»cv_buf
, "ag-source-open-") == &recv_buf[0]) {

917 
BD_ADDR
 
addr
;

918 
memıy
(&
addr
,&
»cv_buf
[
¡¾’
("ag-sourû-İ’-")],
BD_ADDR_SIZE
);

920 
	g»t
 = 
­p_ag_İ’
(&
addr
);

921 if(
	g»t
 == 0)

922 ::
£nd
(
ş›Á_fd
,"ag-sourû-İ’-ok",
¡¾’
("ag-source-open-ok"),0);

924 ::
£nd
(
ş›Á_fd
,"ag-sourû-İ’-çed",
¡¾’
("ag-source-open-failed"),0);

926 }if(
¡r¡r
(
»cv_buf
, "ag-source-close-") == &recv_buf[0]) {

927 
»t
 = 
­p_ag_şo£
();

929 if(
	g»t
 == 0)

930 ::
£nd
(
ş›Á_fd
,"ag-sourû-şo£-ok",
¡¾’
("ag-source-close-ok"),0);

932 ::
£nd
(
ş›Á_fd
,"ag-sourû-şo£-çed",
¡¾’
("ag-source-close-failed"),0);

934 }if(
¡r¡r
(
»cv_buf
, "ag-open-audio-") == &recv_buf[0]) {

935 
­p_ag_İ’_audio
();

936 ::
£nd
(
ş›Á_fd
,"ag-İ’-audio-ok",
¡¾’
("ag-open-audio-ok"),0);

938 }if(
¡r¡r
(
»cv_buf
, "ag-close-audio-") == &recv_buf[0]) {

939 
­p_ag_şo£_audio
();

940 ::
£nd
(
ş›Á_fd
,"ag-şo£-audio-ok",
¡¾’
("ag-close-audio-ok"),0);

943 
ALOGE
("no valid data be„eceived!");

949 
ALOGV
("client„eadhread over \n");

953 
	$Blu‘oÙhS”v”_š¡ªû
(){

954 
ªdroid
::
Blu‘oÙhS”v”
::
	`g‘In¡ªû
();

955 
	}
}

	@sdk/BluetoothServer.h

1 #iâdeà
BLUETOOTHSERVER_H_


2 
	#BLUETOOTHSERVER_H_


	)

4 
	~<¡dio.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

9 
	~<uts/Li¡.h
>

10 
	~<uts/RefBa£.h
>

11 
	~"SyncD©a.h
"

12 
	~"­p_disc_cback.h
"

14 
Çme¥aû
 
	gªdroid
 {

16 şas 
	cBlu‘oÙhS”v”
 : 
public
 
RefBa£
{

17 
public
:

18 
Blu‘oÙhS”v”
* 
g‘In¡ªû
();

19 
	gvœtu®
 ~
Blu‘oÙhS”v”
();

21 
	g´iv©e
:

22 
Blu‘oÙhS”v”
();

23 
	sTHREAD_ARG
{

24 
Blu‘oÙhS”v”
* 
	g£rv”
;

25 
	gş›Á_fd
;

28 
Blu‘oÙhS”v”
* 
	gsIn¡ªû
;

29 
Blu‘oÙhS”v”
(
RefBa£
* 
´ÙocŞ
);

31 *
Acû±Th»adW¿µ”
(*
me
);

32 *
Cl›ÁR—dTh»adW¿µ”
(*
m­
);

34 
Acû±Th»adFunc
();

35 
Cl›ÁR—dTh»adFunc
(
ş›Á_fd
);

37 
¡¬tSock‘S”v”
();

38 
¡İSock‘S”v”
();

40 
İ’Blu‘oÙh
();

41 
şo£Blu‘oÙh
();

42 
£tBËB—cÚ
(
¡©e
);

43 
´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
);

44 
£tBlu‘oÙhVisib™y
(
boŞ
 
’abË
);

45 
di§bËBlu‘oÙh
();

46 
hsAnsw”C®l
();

47 
hsHªgUp
();

48 
ü—tBÚd
(cÚ¡ * 
bd_Çme
);

49 
»moveBÚd
(cÚ¡ * 
bd_Çme
);

50 
¡¬tDiscov”y
(
ş›Á_fd
, 
du¿tiÚ
, 
ty³
);

51 
¡İDiscov”y
(
ş›Á_fd
);

52 
£ndDiscD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

53 
­p_disc_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

55 
g‘LškedDeviû
(
ş›Á_fd
, 
du¿tiÚ
);

56 
­p_g‘lšked_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

57 
£ndLškedDeviûD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

59 
g‘LškšgDeviû
(
ş›Á_fd
, 
du¿tiÚ
);

60 
­p_g‘lškšg_cback
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

61 
£ndLškšgDeviûD©aToCl›Á
(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
);

63 
avS‘NÙify
(
ş›Á_fd
, 
nÙify
);

64 
­p_av_nÙify_cback
(
¡©e
);

66 
boŞ
 
	gmDÚe
;

67 
boŞ
 
	gmDiscov”šg
;

68 
	gmLi¡’fd
;

69 
±h»ad_t
 
	gmAcû±Th»ad
;

70 
±h»ad_t
 
	gmR—dTh»ad
;

72 
±h»ad_cÚd_t
 
	gmCÚd™iÚ
;

73 
±h»ad_mu‹x_t
 
	gmMu‹x
;

74 
±h»ad_mu‹x_t
 
	gmDiscLock
;

75 
±h»ad_mu‹x_t
 
	gmBÚdLock
;

77 
	gLi¡
<> 
	gmDiscov”yMªag”
;

79 
boŞ
 
	gmG‘tšgLškedDeviû
;

80 
±h»ad_mu‹x_t
 
	gmG‘LškedDeviûLock
;

81 
	gLi¡
<> 
	gmG‘LškedDeviûMªag”
;

83 
boŞ
 
	gmG‘tšgLškšgDeviû
;

84 
±h»ad_mu‹x_t
 
	gmG‘LškšgDeviûLock
;

85 
	gLi¡
<> 
	gmG‘LškšgDeviûMªag”
;

87 
	gmNÙifyCl›Áfd
;

	@sdk/BluetoothUtils.h

1 #iâdeà
__BLUETOOTH_UTILS_H__


2 
	#__BLUETOOTH_UTILS_H__


	)

4 
	~<¡dio.h
>

5 
	#BD_ADDR_SIZE
 6

	)

6 
	#BD_NAME_SIZE
 100

	)

7 
	tBD_ADDR
[
BD_ADDR_SIZE
];

10 
	mDISC_NEW_EVT
,

11 
	mDISC_CMPL_EVT
,

12 } 
	tDISC_EVT
;

15 
	mBD_TYPE_UNKNOWN
 = 0,

16 
	mBD_TYPE_BLE
 = 1,

17 
	mBD_TYPE_SPP
 = 2,

18 
	mBD_TYPE_A2DP
 = 3,

19 } 
	tBD_TYPE_ENUM
;

22 
BD_ADDR
 
	mbd_addr
;

23 
	mÇme
[
BD_NAME_SIZE
];

24 
	mbd_ty³
;

25 } 
	tREMOTE_DEVICE
;

	@sdk/HilinkModule.cpp

2 
	#LOG_TAG
 "HškModuË"

	)

4 
	~"SyncD©aToŞs.h
"

5 
	~"HškModuË.h
"

6 
	~<uni¡d.h
>

8 
	~<±h»ad.h
>

9 
	~<sigÇl.h
>

10 
	~<sys/sock‘.h
>

11 
	~<sys/un.h
>

14 
Çme¥aû
 
	gªdroid
 {

16 cÚ¡ 
	gCAP
 = 4 * 1024;

17 
	#ALOGV
 
´štf


	)

18 
	#ALOGD
 
´štf


	)

19 
	#ALOGE
 
´štf


	)

20 
	#UNIX_DOMAIN
 "/v¬/run/hšk_sock‘"

	)

21 
	#BUFFER_SIZE
 (1024 * 8)

	)

23 
´štPack‘Info
(cÚ¡ *
t™Ë
, cÚ¡ *
buf
, 
size
, 
boŞ
 
»®y
) {

24 ià(
	g»®y
) {

25 
	gj
, 
	gi
, 
	gk
;

26 
	g´tšfo
[512], 
	g´2
[256];

28 ià(
	g»®y
)

29 
ALOGD
(" -%s-size=%d--- -¡¬t-------", 
t™Ë
, 
size
);

30 
	gk
 = 
i
 = 0; 
	gi
 < 
	gsize
; k++) {

31 
	g´tšfo
[0] = 0;

32 
	g´2
[0] = 0;

33 
	gj
 = 0; (
	gi
 < 
	gsize
 && j < 16); j++, i++) {

34 
¥rštf
(
´2
 + 
j
, "%c", 
isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

35 
¥rštf
(
´tšfo
 + 
¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
]) & 0xff);

37 ià(
	g»®y
)

38 
ALOGD
("%3x| % -- %s", 
k
, 
´tšfo
, 
´2
);

40 ià(
	g»®y
)

41 
ALOGD
(" -%s-size=%d--’d----------", 
t™Ë
, 
size
);

45 
	gHškModuË
::
HškModuË
(cÚ¡ 
¡ršg
 &
Çme
) {

46 
time¥ec
 

;

47 
şock_g‘time
(
CLOCK_MONOTONIC
, &

);

48 
ALOGD
("% %ld.%06ld", 
__FUNCTION__
, 

.
tv_£c
,p.
tv_n£c
 / 1000);

49 
	gmModuËName
 = 
Çme
;

50 ià(
	gmModuËName
.
Ëngth
() >= 15) {

51 
ALOGE
("ModuËName(%sèmu¡ bËs thª 15!", 
Çme
.
c_¡r
());

52 
ex™
(1);

55 
	gmIsBšded
 = 
çl£
;

56 
	gmBšdTy³
 = 
NONE
;

57 
	gmModuË
 = 
this
;

58 
mem£t
(
mAdd»ss
, 0, (mAddress));

59 
	gmN“dPrštD©a
 = 
çl£
;

60 
	gi¤egi¡”OK
 = 
çl£
;

61 
	gisS’ddÚe
 = 0;

62 
¡¬tSock‘Cl›Á
();

63 
¡ršg
 
	gmsg
 = "register-";

64 
	gmsg
.
­³nd
(
Çme
);

65 
	gtimes
 = 0;

66 ::
£nd
(
mSock‘Fd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0) < 0) {

67 
ALOGE
("£nd faed %d.", 
mSock‘Fd
);

68 ià(
	gtimes
++ > 3) {

69 
şock_g‘time
(
CLOCK_MONOTONIC
, &

);

70 
ALOGE
("ThœdModuË„egi¡” fa.% %ld.%06ld", 

.
tv_£c
,p.
tv_n£c
 / 1000);

73 
¦“p
(1);

75 
±h»ad_mu‹x_š™
(&
mS’dLock
, 
NULL
);

76 
	gtimes
 = 0;

77 
	gi¤egi¡”OK
 =ğ
çl£
) {

78 
u¦“p
(10 * 1000);

79 ià(
	gtimes
++ > 40) {

80 
şock_g‘time
(
CLOCK_MONOTONIC
, &

);

81 
ALOGE
("wa™„egi¡” faed %ld.%06ld.", 

.
tv_£c
,p.
tv_n£c
 / 1000);

88 ià(
	gi¤egi¡”OK
) {

89 
şock_g‘time
(
CLOCK_MONOTONIC
, &

);

90 
ALOGD
("»gi¡” ok. %ld.%06ld", 

.
tv_£c
,p.
tv_n£c
 / 1000);

94 
	gHškModuË
::~
HškModuË
() {

95 
ALOGV
("%s", 
__FUNCTION__
);

96 
¡İSock‘Cl›Á
();

97 
mem£t
(
mAdd»ss
, 0, (mAddress));

98 
	gmN“dPrštD©a
 = 
çl£
;

99 
	gi¤egi¡”OK
 = 
çl£
;

100 
	gisS’ddÚe
 = 0;

103 
±h»ad_mu‹x_de¡roy
(&
mS’dLock
);

107 
	gHškModuË
::
£nd
(cÚ¡ *
d©a
, 
size
) {

108 
	gwa™times
=0;

109 
	g»t
=0;

110 
±h»ad_mu‹x_lock
(&
mS’dLock
);

120 if(
	gisS’ddÚe
)

121 
ALOGE
("isS’ddÚi nÙ„—dy %d", 
isS’ddÚe
);

122 
	gbuf
[
CAP
]="hilink-send-";

123 
	gËn
 = 
¡¾’
((cÚ¡ *)
buf
);

124 
	gbuf
[
Ën
++]ğ
size
 & 0xff;

125 
	gbuf
[
Ën
++]ğ(
size
>>8) & 0xff;

126 
memıy
(
buf
+
Ën
, 
d©a
, 
size
);

127 
	gisS’ddÚe
 = 1;

129 
	g»’
 = ::
£nd
(
mSock‘Fd
, 
buf
, 
Ën
+
size
, 0);

134 
	gwa™times
 = 0;

135 
	gisS’ddÚe
 == 1) {

136 ià(
wa™times
++ > 1000)

141 
u¦“p
(1 * 100);

144 if(
	gisS’ddÚe
 == 2)

145 
»t
 = -1;

147 
	g»t
 = 0;

148 ià(
	gwa™times
 > 0)

149 
ALOGD
("£nd wa™imes=%dus,»t:%d", 
wa™times
*100,
»t
);

151 
ALOGD
("£nd %d d©¨dÚe",
size
);

154 
	gisS’ddÚe
 = 0;

155 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

156  
	g»t
;

159 
boŞ
 
	gHškModuË
::
¡İSock‘Cl›Á
() {

160 
±h»ad_još
(
mR—dTh»ad
, 
NULL
);

161 ià(
	gmSock‘Fd
 > 0) {

162 
ALOGD
("¡İSock‘Cl›Á %d", 
mSock‘Fd
);

163 
şo£
(
mSock‘Fd
);

164 
	gmSock‘Fd
 = -1;

166 
ALOGE
("nØşo£ sock‘ %d <0", 
mSock‘Fd
);

168  
	gŒue
;

171 
boŞ
 
	gHškModuË
::
¡¬tSock‘Cl›Á
() {

172 
ALOGV
("%s", 
__FUNCTION__
);

173 
	gfd
;

174 
sockaddr_un
 
	g£r_addr
;

175 
mem£t
(&
£r_addr
, 0, (ser_addr));

176 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

177 
¡rıy
(
£r_addr
.
sun_·th
, 
UNIX_DOMAIN
);

178 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

179 ià(
	gfd
 < 0) {

180 
ALOGE
("sock‘ƒ¼Ü: %s\n", 
¡»¼Ü
(
”ºo
));

181  
	gçl£
;

184 
	gæags
 = 
fú
(
fd
, 
F_GETFD
);

185 
	gæags
 |ğ
FD_CLOEXEC
;

186 
fú
(
fd
, 
F_SETFD
, 
æags
);

188 
	g»t
 = 
cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

189 ià(
	g»t
 < 0) {

190 
ALOGE
("cÚÃù sock‘ƒ¼Ü: %s\n", 
¡»¼Ü
(
”ºo
));

191  
	gçl£
;

194 
	gmSock‘Fd
 = 
fd
;

195 
ALOGD
("%s,mSock‘Fd =%d", 
__FUNCTION__
, 
mSock‘Fd
);

196 
±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
HškModuË
::
R—dTh»adW¿µ”
, 
this
);

197  
	gŒue
;

200 
boŞ
 
	gHškModuË
::
»¡¬tSock‘Cl›Á
(
»Œy_times
) {

201 
ALOGV
("%s", 
__FUNCTION__
);

202 
	gfd
;

203 
sockaddr_un
 
	g£r_addr
;

204 
mem£t
(&
£r_addr
, 0, (ser_addr));

205 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

206 
¡rıy
(
£r_addr
.
sun_·th
, 
UNIX_DOMAIN
);

207 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

208 ià(
	gfd
 < 0) {

209 
ALOGE
("sock‘ƒ¼Ü: %s\n", 
¡»¼Ü
(
”ºo
));

210  
	gçl£
;

213 
	gæags
 = 
fú
(
fd
, 
F_GETFD
);

214 
	gæags
 |ğ
FD_CLOEXEC
;

215 
fú
(
fd
, 
F_SETFD
, 
æags
);

217 
	g»t
 = 
cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

218 ià(
	g»t
 < 0) {

219 
ALOGE
("cÚÃù sock‘ƒ¼Ü: %s,»Œy_time:%d\n", 
¡»¼Ü
(
”ºo
), 
»Œy_times
);

220 
şo£
(
fd
);

221  
	gçl£
;

224 
	gmSock‘Fd
 = 
fd
;

226 
¡ršg
 
	gmsg
 = "register-";

227 
	gmsg
.
­³nd
(
mModuËName
);

228 
	gtimes
 = 0;

229 ::
£nd
(
mSock‘Fd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0) < 0) {

231 ià(
	gtimes
++ > 3000) {

232 
ALOGE
("ThirdModule„egister fail.");

235 
u¦“p
(1000);

238 
ALOGD
("%s,mSock‘Fd =%d,»Œy=%d,wa™=%d", 
__FUNCTION__
, 
mSock‘Fd
, 
»Œy_times
, 
times
);

239  
	gŒue
;

242 *
	gHškModuË
::
R—dTh»adW¿µ”
(*
me
) {

244 
HškModuË
 *
moduË
 = 
¡©ic_ÿ¡
<HškModuË *>(
me
);

245 
	gmoduË
->
R—dTh»adFunc
();

246  
	gNULL
;

249 
boŞ
 
	gHškModuË
::
isO³Ãd
() {

250 
ALOGV
("%s", 
__FUNCTION__
);

251 
	gfd
 = ::
İ’
("/sys/şass/rfkl/rfkl0/¡©e", 
O_RDONLY
);

252 ià(
	gfd
 < 0) {

253 
ALOGE
("İ’ /sys/şass/rfkl/rfkl0/¡©çed: % ", 
¡»¼Ü
(
”ºo
));

254  
	gçl£
;

257 
	gbufãr
 = 0;

258 ::
»ad
(
fd
, &
bufãr
, 1);

260 ::
şo£
(
fd
);

264  (
	gbufãr
 =ğ'1'è? 
Œue
 : 
çl£
;

267 cÚ¡ * cÚ¡ 
	gcmp¡r
[4] = {"bind-state-change:", "msg_send_ret:", "hilink-recv-","ble-close_evt-"};

269 
	gHškModuË
::
R—dTh»adFunc
() {

270 
couÁ
 = 1;

271 
	gcmp¡¾’
[3], 
	gi
;

272 
	g»Œy_times
;

273 
	g»cv_buf
[
BUFFER_SIZE
+256];

276 ià(
	gmSock‘Fd
 <= 0) {

277 
u¦“p
(200 * 1000);

278 ià(
isO³Ãd
()) {

279 ià(
	g»Œy_times
 == 0)

280 
u¦“p
(400 * 1000);

281 
»¡¬tSock‘Cl›Á
(++
»Œy_times
);

283 ià(
	gmSock‘Fd
 > 0)

284 
	g»Œy_times
 = 0;

285 ià(
	g»Œy_times
 > 40)

288 
	gmSock‘Fd
 > 0) {

289 
	gi
 = 0; i < 3; i++) {

290 
	gcmp¡¾’
[
i
] = 
¡¾’
(
cmp¡r
[i]);

292 
mem£t
(
»cv_buf
, 0, 
BUFFER_SIZE
);

293 
	gcouÁ
 = 
»cv
(
mSock‘Fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

294 ià(
	gcouÁ
 <= 0) {

295 
ALOGE
("sock‘ %d i şo£ !ƒ¼Ü=%s(%d),”ºo=%d,couÁ=%d", 
mSock‘Fd
, 
¡»¼Ü
(
”ºo
),ƒ¼no, 
couÁ
);

296 
şo£
(
mSock‘Fd
);

297 
	gmSock‘Fd
 = -1;

301 
	gmsgsum
 = 0;

302 
	gbcouÁ
 = 
couÁ
;

303 
	g’
;

304 *
	g»cv_±r
 = 
»cv_buf
;

305 
boŞ
 
	gi¢“d´št
 = 
Œue
;

310 ià(
memcmp
(
»cv_buf
, 
cmp¡r
[0] , 
cmp¡¾’
[0] ) == 0) {

311 
’
 = 
cmp¡¾’
[0];

312 ià(
	g»cv_buf
[
’
] == '0') {

313 
mIsBšded
 = 
çl£
;

314 
	gmBšdTy³
 = 
NONE
;

315 } ià(
	g»cv_buf
[
’
] == '1') {

316 
mIsBšded
 = 
Œue
;

317 
	gmBšdTy³
 = 
BLE
;

318 } ià(
	g»cv_buf
[
’
] == '2') {

319 
mIsBšded
 = 
Œue
;

320 
	gmBšdTy³
 = 
BLUETOOTH
;

322 
	gi¤egi¡”OK
 = 
Œue
;

323 
time¥ec
 
	g
;

324 
şock_g‘time
(
CLOCK_MONOTONIC
, &

);

326 
ALOGD
("bšd-¡©e-chªge: mIsBšded=%s,bšdTy³=% %ld.%06ld", 
mIsBšded
 ? "Œue" : "çl£", (
mBšdTy³
 =ğ
BLE
è? "BLE" : ((mBšdTy³ =ğ
BLUETOOTH
è? "BLUETOOTH" : "NONE"), 

.
tv_£c
,p.
tv_n£c
 / 1000);

327 
	gcouÁ
 -ğ
’
 + 1;

328 
	g»cv_±r
 +ğ
’
 + 1;

330 
	gi¢“d´št
 = 
Œue
;

331 } ià(
memcmp
(
»cv_±r
, 
cmp¡r
[1] , 
cmp¡¾’
[1] ) == 0) {

332 
’
 = 
cmp¡¾’
[1];

333 
ALOGD
("£nd„‘ %c",
»cv_±r
[
cmp¡¾’
[1]]);

334 if(
	gisS’ddÚe
 ==1) {

335 if(
»cv_±r
[
cmp¡¾’
[1]]=='1')

336 
isS’ddÚe
 = 2;

338 
	gisS’ddÚe
 = 3;

340 
	gcouÁ
 -ğ
’
 + 1;

341 
	g»cv_±r
 +ğ
’
 + 1;

342 
	gi¢“d´št
 = 
Œue
;

343 } if(
memcmp
(
»cv_±r
, 
cmp¡r
[2] , 
cmp¡¾’
[2]) == 0) {

344 
’
 = ()
»cv_±r
[
cmp¡¾’
[2]+1];

345 
	g’
 <<=8;

346 
	g’
 +ğ()
»cv_±r
[
cmp¡¾’
[2]];

347 if(
	g’
 > 0) {

349 
´štPack‘Info
("hškModuË„ecv-",(
»cv_±r
+
cmp¡¾’
[2]+2), 
’
, 
Œue
);

350 
ÚR‘rive
((cÚ¡ *)(
»cv_±r
+
cmp¡¾’
[2]+2), 
’
);

351 
	gmsgsum
++;

352 
	gcouÁ
 -ğ
cmp¡¾’
[2]+2 +
’
;

353 
	g»cv_±r
 +ğ
cmp¡¾’
[2]+2 +
’
;

355 
ALOGD
("cmp¡r:%s,Ën:%d",
cmp¡r
[2],
cmp¡¾’
[2]);

356 
´štPack‘Info
("!!!hškModuË wrÚg msg†’!!!",
»cv_±r
, 
couÁ
, 
Œue
);

357 
	g’
 = 1;

358 
	g»cv_±r
 +ğ
couÁ
;

359 
	gcouÁ
 = 0;

361 
	gi¢“d´št
 = 
Œue
;

362 } if(
memcmp
(
»cv_±r
, 
cmp¡r
[3], 
cmp¡¾’
[3]) == 0) {

363 
’
 = 
cmp¡¾’
[3];

364 if(
	g’
 > 0)

365 
ÚR‘rive
((cÚ¡ *)
»cv_±r
, 
’
);

367 
ALOGD
("cmp¡r:%s,Ën:%d",
cmp¡r
[3],
cmp¡¾’
[3]);

368 
´štPack‘Info
("!!!hškModuË wrÚg msg†’!!!",
»cv_±r
, 
couÁ
, 
Œue
);

369 
	g’
 = 1;

370 
	g»cv_±r
 +ğ
couÁ
;

371 
	gcouÁ
 = 0;

373 
	gcouÁ
 -ğ
’
;

374 
	g»cv_±r
 +ğ
’
;

375 
	gi¢“d´št
 = 
Œue
;

377 
	g»maš_size
 = 
couÁ
;

378 if(
	gi¢“d´št
) {

379 
	gi¢“d´št
 = 
çl£
;

380 
´štPack‘Info
("hškModuË wrÚg msg",
»cv_±r
, 
couÁ
, 
Œue
);

382 
	gcouÁ
 --;

383 
	g»cv_±r
 ++;

385 } 
	gcouÁ
 > 0);

387 ià(
	gmsgsum
 > 1) {

388 
ALOGD
("msgsum:%d,®lsize=%d", 
msgsum
, 
bcouÁ
);

394 
ALOGV
("readhread over \n");

397 
BIND_TYPE
 
	gHškModuË
::
g‘BšdTy³
() {

398  
mBšdTy³
;

401 
boŞ
 
	gHškModuË
::
g‘Blu‘oÙhAdd»ss
(
¡ršg
 &
add»ss
) {

402 ià(
¡¾’
(
mAdd»ss
) > 11) {

403 
add»ss
 = 
mAdd»ss
;

404  
	gŒue
;

407 
FILE
 *
	gpFe
 = 
fİ’
("/usr/data/bsa/bt_addr", "r");

408 ià(
	gNULL
 =ğ
pFe
) {

409 
ALOGE
("can't open filep(%s)", "/usr/data/bsa/bt_addr");

410  
	gçl£
;

413 
fsÿnf
(
pFe
, "%s", 
mAdd»ss
);

414 
fşo£
(
pFe
);

415 ià(
	gmAdd»ss
 =ğ
NULL
 || 
¡¾’
(
mAdd»ss
) < 11) {

416  
çl£
;

418 
	gadd»ss
 = 
mAdd»ss
;

419  
	gŒue
;

	@sdk/HilinkModule.h

1 #iâdeà
HškModuË_H_


2 
	#HškModuË_H_


	)

4 
	~<¡dio.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

9 
	~<uts/RefBa£.h
>

10 
	~<±h»ad.h
>

11 
	~"SyncD©a.h
"

13 
Çme¥aû
 
	gªdroid
 {

25 şas 
	cHškModuË
{

26 
	gpublic
:

31 
HškModuË
(cÚ¡ 
¡ršg
 & 
Çme
);

38 
£nd
(cÚ¡ *
buf
, 
Ën
);

44 
	gvœtu®
 ~
HškModuË
();

51 
vœtu®
 
ÚR‘rive
(cÚ¡ *
buf
, 
Ën
)=0;

57 
boŞ
 
isBšded
(){ 
	gmIsBšded
;};

63 
BIND_TYPE
 
g‘BšdTy³
();

70 
boŞ
 
g‘Blu‘oÙhAdd»ss
(
¡ršg
 & 
add»ss
);

72 
	g´iv©e
:

74 
boŞ
 
¡İSock‘Cl›Á
();

75 
boŞ
 
¡¬tSock‘Cl›Á
();

76 
boŞ
 
isO³Ãd
();

77 
boŞ
 
»¡¬tSock‘Cl›Á
(
»Œy_times
);

78 *
R—dTh»adW¿µ”
(*
me
);

79 
R—dTh»adFunc
();

81 
boŞ
 
	gmIsBšded
;

82 
BIND_TYPE
 
	gmBšdTy³
;

83 
	gmSock‘Fd
;

84 
±h»ad_t
 
	gmR—dTh»ad
;

85 
¡ršg
 
	gmModuËName
;

86 
	gmAdd»ss
[20];

87 
HškModuË
* 
	gmModuË
;

88 
boŞ
 
	gi¤egi¡”OK
;

89 
boŞ
 
	gmN“dPrštD©a
;

90 vŞ©
	gisS’ddÚe
;

93 
±h»ad_mu‹x_t
 
	gmS’dLock
;

	@sdk/HilinkServer.cpp

2 
	#LOG_TAG
 "HškS”v”"

	)

4 
	~<sigÇl.h
>

5 
	~<uts/Log.h
>

7 
	~"HškS”v”.h
"

8 
	~<sys/sock‘.h
>

9 
	~<sys/un.h
>

11 
	~"BËPrÙocŞ.h
"

13 
Çme¥aû
 
	gªdroid
 {

15 #ifdeà
__ılu¥lus


19 
	~"­p_av.h
"

20 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

21 #ifdeà
__ılu¥lus


26 
	#UNIX_DOMAIN
 "/v¬/run/hšk_sock‘"

	)

27 
	#BUFFER_SIZE
 4096

28 cÚ¡ 
¡ršg
 
MODULE_NAME
 = "thœd·¹y_m";

	)

30 
´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
)

32 if(
	g»®y
)

34 
	gj
,
	gi
,
	gk
;

35 
	g´tšfo
[512],
	g´2
[256];

37 
ALOGD
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

38 
	gk
=
i
=0; 
	gi
<
	gsize
;k++)

40 
	g´tšfo
[0]=0;

41 
	g´2
[0] = 0;

42 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

44 
¥rštf
(
´2
+
j
, "%c", 
isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

45 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
])&0xff);

47 
ALOGD
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

49 
ALOGD
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

54 
HškS”v”
* 
	gHškS”v”
::
sIn¡ªû
 = 
NULL
;

56 
HškS”v”
* 
	gHškS”v”
::
g‘In¡ªû
(
RefBa£
* 
´ÙocŞ
)

58 
ALOGV
("%s", 
__FUNCTION__
);

59 if(
	gsIn¡ªû
 =ğ
NULL
){

60 
sIn¡ªû
 = 
Ãw
 
HškS”v”
(
´ÙocŞ
);

62  
	gsIn¡ªû
;

65 
	gHškS”v”
::
HškS”v”
(
RefBa£
* 
´ÙocŞ
){

66 
±h»ad_mu‹x_š™
(&
m£ndLock
, 
NULL
);

67 
	gmDÚe
 = 
çl£
;

68 
	gmIsBšded
 = 
çl£
;

69 
	gmPrÙocŞ
 = 
´ÙocŞ
;

70 
¡¬tSock‘S”v”
();

73 
	gHškS”v”
::~
HškS”v”
()

75 
¡İSock‘S”v”
();

76 
±h»ad_mu‹x_de¡roy
(&
m£ndLock
);

79 
boŞ
 
	gHškS”v”
::
»gi¡”ModuË
(
¡ršg
 
moduË
,
ş›Á_fd
)

81 
time¥ec
 
	g
;

82 
ALOGV
("%s,fd=%d", 
__FUNCTION__
,
ş›Á_fd
);

83 
	gMODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
fšd
(
moduË
.
c_¡r
());

84 if(
	g™
 =ğ
mModuËM­
.
’d
()) {

85 
mModuËM­
.
š£¹
(
MODULEMAP
::
v®ue_ty³
(
moduË
, 
ş›Á_fd
));

87 
¡ršg
 
	gmsg
 = "bind-state-change:";

88 
	gmTy³
){

89 
	gNONE
:

90 
msg
.
­³nd
("0");

92 
	gBLE
:

93 
msg
.
­³nd
("1");

95 
	gBLUETOOTH
:

96 
msg
.
­³nd
("2");

100 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

102 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

103 
ALOGD
("»gi¡” moduË(%sèsucûss!,%ld.%06ld.",
moduË
.
c_¡r
(),

.
tv_£c
,.
tv_n£c
/1000);

104 
sy¡em
("wpa_cli scan &");

105  
	gŒue
;

107 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

108 
ALOGE
("»gi¡” moduË(%sèçed,%ld.%06ld..sy¡em hav¨sommoduËƒxi¡!",
moduË
.
c_¡r
(),

.
tv_£c
,.
tv_n£c
/1000);

109  
	gçl£
;

113 
boŞ
 
	gHškS”v”
::
unRegi¡”ModuË
(
ş›Á_fd
)

115 
ALOGD
("%s,fd=%d", 
__FUNCTION__
,
ş›Á_fd
);

117 
	gMODULEMAP
::
™”©Ü
 
™
;

118 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

119 if(
	g™
->
	g£cÚd
 =ğ
ş›Á_fd
){

120 
mModuËM­
.
”a£
(
™
);

121 
ALOGD
("unRegi¡” moduË(%sèsucûss,fd i %d",(
™
->
fœ¡
).
c_¡r
(), it->
£cÚd
);

122  
	gŒue
;

125 
ALOGD
("unRegi¡” moduË fa,fd i %d", 
™
->
£cÚd
);

126  
	gçl£
;

129 
	gHškS”v”
::
BšdedS‹Chªge
(
boŞ
 
isBšded
,boŞ 
isBË
){

130 
ALOGV
("%s", 
__FUNCTION__
);

131 
	gmIsBšded
 = 
isBšded
;

132 
¡ršg
 
	gmsg
 = "bind-state-change:";

133 if(
	gmIsBšded
){

134 
	gmTy³
 = 
isBË
 ? 
BLE
 : 
BLUETOOTH
;

135 if(
	gisBË
)

136 
	gmsg
.
­³nd
("1");

138 
	gmsg
.
­³nd
("2");

140 
	gmsg
.
­³nd
("0");

141 
	gmTy³
 = 
NONE
;

143 
	gMODULEMAP
::
™”©Ü
 
™
;

144 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

146 
	gş›Á_fd
 = 
™
->
£cÚd
;

147 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

151 
	gHškS”v”
::
£nddÚe
(
ş›Á_fd
,
»t
)

153 
ALOGD
("% »t:%d", 
__FUNCTION__
,
»t
);

155 
¡ršg
 
	gmsg
 = "msg_send_ret:";

156 
	g»t
){

158 
msg
.
­³nd
("0");

162 
msg
.
­³nd
("1");

172 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

174 
	gHškS”v”
::
ÚR‘rive
(cÚ¡ * 
moduËName
,* 
d©a
,
size
)

176 
ALOGD
("%s,size=%d", 
__FUNCTION__
,
size
);

177 
	gMODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
fšd
(
moduËName
);

178 if(
	g™
 =ğ
mModuËM­
.
’d
()) {

179 
ALOGE
("ÚR‘rivçed .‚ØmoduË(%sèexi¡!",
moduËName
);

180 
´štPack‘Info
("UÄe¥Ú msg",
d©a
,
size
,
Œue
);

183 
	gbuf
[
BUFFER_SIZE
]="hilink-recv-";

184 
	gËn
 = 
¡¾’
((cÚ¡ *)
buf
);

185 
	gbuf
[
Ën
++] = 
size
 & 0xff;

186 
	gbuf
[
Ën
++] = (
size
>>8) & 0xff;

187 
memıy
(
buf
+
Ën
, 
d©a
, 
size
);

189 
	gş›Á_fd
 = 
™
->
£cÚd
;

190 ::
£nd
(
ş›Á_fd
, 
buf
, 
Ën
+
size
,0);

191 
ALOGD
("hšk s”v” R‘riv%d",
size
);

195 
	gHškS”v”
::
£ndTimes
(
¡ršg
 
moduË
,* 
by‹s
,
size
, *
u£d_size
)

198 cÚ¡ 
	gmsgsub¡r
[]="hilink-send-";

199 cÚ¡ 
	gmsg_h—d_Ën
 = 14;

200 cÚ¡ 
	goff_msg_size
 = 10;

201 
	g·ckSum
 = 0;

202 
	gcursize
;

203 *
	g¤c
;

204 
	gÃwsize
=0,
	g¡rsize
,
	gtÙ®
=0;

205 
	g»t
;

207 *
	gu£d_size
 = 0;

208 if(
	gsize
 <= 0){

209 
ALOGE
("Error:serial failed!");

213 
ALOGV
("% wa™†ock", 
__FUNCTION__
);

218 
	g¡rsize
 = 
¡¾’
((*)
msgsub¡r
);

219 
	g¤c
 = (*)
by‹s
;

222 
	gcursize
 = 
¤c
[1];

223 
	gcursize
 <<= 8;

224 
	gcursize
 +ğ
¤c
[0];

225 #ifdeà
PRINT_DATA_INFO


226 
ALOGD
("tÙ®=%d cursize=%d,size=%d",
tÙ®
,
cursize
,
size
);

228 
	gtÙ®
 = 
cursize
 + 2;

230 
	g»t
 = ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),(*)
¤c
+2,()
cursize
, 
Œue
);

231 
	g¤c
 +ğ
tÙ®
;

233 *
	gu£d_size
 = 
tÙ®
;

236  
	g»t
;

239 
	gHškS”v”
::
¡İSock‘S”v”
(){

240 *
dummy
;

241 
	gmDÚe
 = 
Œue
;

242 
±h»ad_još
(
mAcû±Th»ad
, &
dummy
);

243 
şo£
(
mLi¡’fd
);

246 
	gHškS”v”
::
¡¬tSock‘S”v”
(){

247 
sockaddr_un
 
£r_addr
;

248 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

249 
¡ºıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
,(ser_addr.sun_path)-1);

250 
uÆšk
(
UNIX_DOMAIN
);

251 
	gmLi¡’fd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

252 if(
	gmLi¡’fd
 < 0){

253 
ALOGE
("”rÜ: sock‘ c»©iÚ faed; skt_fd:%d\n", 
mLi¡’fd
);

256 if(
bšd
(
mLi¡’fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr)) < 0){

257 
ALOGE
(" bšdƒ¼Ü: %sÓ¼no: %d)\n",
¡»¼Ü
(
”ºo
),errno);

258 
şo£
(
mLi¡’fd
);

261 if(
li¡’
(
mLi¡’fd
, 1) < 0){

262 
ALOGE
("error: hstp socket†isten failed\n");

263 
şo£
(
mLi¡’fd
);

267 
±h»ad_ü—‹
(&
mAcû±Th»ad
, 
NULL
, 
HškS”v”
::
Acû±Th»adW¿µ”
, 
this
);

270 *
	gHškS”v”
::
Acû±Th»adW¿µ”
(*
me
) {

271 
HškS”v”
 *
sourû
 = 
¡©ic_ÿ¡
<HškS”v” *>(
me
);

272 
	gsourû
->
Acû±Th»adFunc
();

273  
	gNULL
;

276 *
	gHškS”v”
::
Cl›ÁR—dTh»adW¿µ”
(*
¬g
) {

277 
THREAD_ARG
 *
¬gs
 = (THREAD_ARG *)
¬g
;

278 
HškS”v”
 *
	g£rv”
 = 
¡©ic_ÿ¡
<HškS”v” *>(
¬gs
->
£rv”
);

279 
	g£rv”
->
Cl›ÁR—dTh»adFunc
(
¬gs
->
ş›Á_fd
);

280  
	gNULL
;

283 *
	gHškS”v”
::
S‘BTVisibtiy
Ğ*
±r
 )

284 { 
±h»ad_d‘ach
(
±h»ad_£lf
());

285 
u¦“p
(2000*1000);

287 
£tBTVisib™y
(
Œue
,true);

288 
±h»ad_ex™
(0) ;

292 
	gHškS”v”
::
Acû±Th»adFunc
(){

294 
»adL’
 = 0;

295 
	gcouÁ
 = 0;

296 
	gmDÚe
 =ğ
çl£
){

297 
ş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

298 if(
	gş›Á_fd
 < 0){

299 
ALOGE
("cannot‡ccept client connect„equest");

302 
THREAD_ARG
 
	g¬g
;

304 
	g¬g
.
	g£rv”
 = 
this
;

305 
	g¬g
.
	gş›Á_fd
 = 
ş›Á_fd
;

306 
±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
HškS”v”
::
Cl›ÁR—dTh»adW¿µ”
, &
¬g
);

310 
	gHškS”v”
::
Cl›ÁR—dTh»adFunc
(
ş›Á_fd_¬g
){

311 
»cv_buf
[
BUFFER_SIZE
];

312 
	gcouÁ
 = 1;

313 cÚ¡ *
	gcmp¡r
[]={"register-","hilink-send-"};

314 *
	g»cv_±r
;

315 
	gcmp¡¾’
[2],
	gi
,
	gu£d_size
,
	g´štæag
;

316 
	gş›Á_fd
 = 
ş›Á_fd_¬g
;

317 
±h»ad_t
 
	gmyth»ad
;

319 
	gi
=0; i<2; i++)

321 
	gcmp¡¾’
[
i
] = 
¡¾’
(
cmp¡r
[i]);

325 if(
	gş›Á_fd
 <= 0)

327 
u¦“p
(10*1000);

328 
	gş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

329 if(
	gş›Á_fd
 < 0){

330 
ALOGE
("wait‚ew mListenfd");

333 
ALOGD
("g‘‚ew mLi¡’fd=%d", 
mLi¡’fd
);

335 
£tBTVisib™y
(
Œue
,true);

337 
±h»ad_mu‹x_lock
(&
m£ndLock
);

338 
mem£t
(
»cv_buf
, 0 ,
BUFFER_SIZE
);

339 
	gcouÁ
 = 
»cv
(
ş›Á_fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

340 if(
	gcouÁ
 <= 0){

341 
£tBTVisib™y
(
çl£
,false);

342 
ALOGE
("sock‘ i şo£ !ƒ¼Ü=%s(%d),ƒ¼no=%d,couÁ=%d",
¡»¼Ü
(
”ºo
),”ºo,
couÁ
);

343 
şo£
(
ş›Á_fd
);

344 
unRegi¡”ModuË
(
ş›Á_fd
);

345 
	gş›Á_fd
 = -1;

346 
±h»ad_mu‹x_uÆock
(&
m£ndLock
);

349 
	g»cv_±r
 = 
»cv_buf
;

350 
	g´štæag
 = 0;

351 
´štPack‘Info
("HškS”v”„eûived ", 
»cv_buf
,
couÁ
,
Œue
);

354 if(
memcmp
(
»cv_±r
,
cmp¡r
[1], 
cmp¡¾’
[1])==0)

358 
»cv_±r
 +ğ
cmp¡¾’
[1];

359 
	gcouÁ
 -ğ
cmp¡¾’
[1];

360 
	gMODULEMAP
::
™”©Ü
 
™
;

361 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

362 if(
	g™
->
	g£cÚd
 =ğ
ş›Á_fd
){

363 
¡ršg
 
moduË
 = 
™
->
fœ¡
;

365 
	g»t
 = 
£ndTimes
(
moduË
,
»cv_±r
,
couÁ
,&
u£d_size
);

366 
	gcouÁ
 -ğ
u£d_size
;

367 
	g»cv_±r
 +ğ
u£d_size
;

373 }if(
memcmp
(
»cv_±r
, 
cmp¡r
[0], 
cmp¡¾’
[0]) == 0)

375 
¡ršg
 
moduË
;

377 
	gmoduË
.
assign
((*)
»cv_±r
+
cmp¡¾’
[0], 
couÁ
-cmpstrlen[0]);

378 
»gi¡”ModuË
(
moduË
,
ş›Á_fd
);

380 
	gcouÁ
 -ğ
cmp¡¾’
[0]+1;

381 
	g»cv_±r
 +ğ
cmp¡¾’
[0]+1;

385 
	gcouÁ
 --;

386 
	g»cv_±r
 ++;

387 
ALOGE
("invalid data be„eceived!");

388 if(
	g´štæag
 ==0)

390 
´štPack‘Info
("šv®id d©a", 
»cv_±r
,
couÁ
,
Œue
);

391 
	g´štæag
=1;

394 }
	gcouÁ
 > 0);

396 
±h»ad_mu‹x_uÆock
(&
m£ndLock
);

399 
ALOGV
("client„eadhread over \n");

	@sdk/HilinkServer.h

1 #iâdeà
HILINKSERVER_H_


2 
	#HILINKSERVER_H_


	)

4 
	~<¡dio.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

9 
	~<uts/RefBa£.h
>

10 
	~"SyncD©a.h
"

12 
Çme¥aû
 
	gªdroid
 {

18 şas 
	cHškS”v”
 : 
public
 
RefBa£
{

19 
public
:

20 
¡d
::
	tm­
<
	t¡ršg
, > 
	tMODULEMAP
;

21 
HškS”v”
* 
g‘In¡ªû
(
RefBa£
* 
´ÙocŞ
);

22 
	gvœtu®
 ~
HškS”v”
();

24 
ÚR‘rive
(cÚ¡ * 
moduËName
,* 
d©a
,
size
);

25 
BšdedS‹Chªge
(
boŞ
 
isBšded
,boŞ 
isBË
);

26 
	g´iv©e
:

27 
±h»ad_mu‹x_t
 
m£ndLock
;

28 
	sTHREAD_ARG
{

29 
HškS”v”
* 
	g£rv”
;

30 
	gş›Á_fd
;

33 
HškS”v”
* 
	gsIn¡ªû
;

34 
HškS”v”
(
RefBa£
* 
´ÙocŞ
);

36 *
S‘BTVisibtiy
(*
me
);

37 *
Acû±Th»adW¿µ”
(*
me
);

38 *
Cl›ÁR—dTh»adW¿µ”
(*
m­
);

40 
Acû±Th»adFunc
();

41 
Cl›ÁR—dTh»adFunc
(
ş›Á_fd
);

43 
¡¬tSock‘S”v”
();

44 
¡İSock‘S”v”
();

46 
boŞ
 
»gi¡”ModuË
(
¡ršg
 
moduË
,
ş›Á_fd
);

47 
boŞ
 
unRegi¡”ModuË
(
ş›Á_fd
);

49 
£ndTimes
(
¡ršg
 
moduË
,* 
by‹s
,
size
, *
u£d_size
);

50 
£nddÚe
(
ş›Á_fd
,
»t
);

51 
boŞ
 
	gmDÚe
;

52 
boŞ
 
	gmIsBšded
;

53 
	gmLi¡’fd
;

54 
±h»ad_t
 
	gmAcû±Th»ad
;

55 
±h»ad_t
 
	gmR—dTh»ad
;

57 
MODULEMAP
 
	gmModuËM­
;

58 
RefBa£
* 
	gmPrÙocŞ
;

59 
BIND_TYPE
 
	gmTy³
;

	@sdk/ThirdPartyModule.cpp

2 
	#LOG_TAG
 "ThœdP¬tyModuË"

	)

5 
	~<sigÇl.h
>

6 
	~<uni¡d.h
>

8 
	~<±h»ad.h
>

9 
	~<sys/sock‘.h
>

10 
	~<sys/un.h
>

11 
	~"ThœdP¬tyModuË.h
"

12 
	~"SyncD©aToŞs.h
"

14 
Çme¥aû
 
	gªdroid
 {

16 cÚ¡ 
	gCAP
 = 4 * 1024;

17 
	#ALOGV
 
´štf


	)

18 
	#ALOGD
 
´štf


	)

19 
	#ALOGE
 
´štf


	)

20 
	#UNIX_DOMAIN
 "/v¬/run/thœd·¹y_sock‘"

	)

21 
	#BUFFER_SIZE
 (1024*4)

	)

23 
´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
)

25 if(
	g»®y
)

27 
	gj
,
	gi
,
	gk
;

28 
	g´tšfo
[512],
	g´2
[256];

30 if(
	g»®y
)

31 
ALOGE
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

33 
ALOGD
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

34 
	gk
=
i
=0; 
	gi
<
	gsize
;k++)

36 
	g´tšfo
[0]=0;

37 
	g´2
[0] = 0;

38 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

40 
¥rštf
(
´2
+
j
, "%c", 
isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

41 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
])&0xff);

43 if(
	g»®y
)

44 
ALOGE
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

46 
ALOGD
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

48 if(
	g»®y
)

49 
ALOGE
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

51 
ALOGD
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

55 
	gThœdP¬tyModuË
::
ThœdP¬tyModuË
(cÚ¡ 
¡ršg
 & 
Çme
)

57 
time¥ec
 

;

58 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

59 
ALOGD
("% %ld.%06ld", 
__FUNCTION__
,

.
tv_£c
,.
tv_n£c
/1000);

60 
	gmModuËName
 = 
Çme
;

61 if(
	gmModuËName
.
Ëngth
() >= 15){

62 
ALOGE
("ModuËName(%sèmu¡ bËs thª 15!",
Çme
.
c_¡r
());

63 
ex™
(1);

66 
	gmIsBšded
 = 
çl£
;

67 
	gmBšdTy³
 = 
NONE
;

68 
	gmModuË
 = 
this
;

69 
mem£t
(
mAdd»ss
, 0, (mAddress));

70 
	gmN“dPrštD©a
 = 
çl£
;

71 
	gi¤egi¡”OK
 = 
çl£
;

72 
	gisS’ddÚe
 = 0;

73 
¡¬tSock‘Cl›Á
();

74 
¡ršg
 
	gmsg
 = "register-";

75 
	gmsg
.
­³nd
(
Çme
);

76 
	gtimes
 = 0;

77 ::
£nd
(
mSock‘Fd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0) < 0){

78 
ALOGE
("£nd faed %d.",
mSock‘Fd
);

79 if(
	gtimes
++ >3)

81 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

82 
ALOGE
("ThœdModuË„egi¡” fa.% %ld.%06ld",

.
tv_£c
,.
tv_n£c
/1000);

85 
¦“p
(1);

87 
±h»ad_mu‹x_š™
(&
mS’dLock
, 
NULL
);

88 
	gtimes
 = 0;

89 
	gi¤egi¡”OK
 =ğ
çl£
) {

90 
u¦“p
(10*1000);

91 if(
	gtimes
++ > 40){

92 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

93 
ALOGE
("wa™„egi¡” faed %ld.%06ld.",

.
tv_£c
,.
tv_n£c
/1000);

100 if(
	gi¤egi¡”OK
) {

101 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

102 
ALOGD
("»gi¡” ok. %ld.%06ld",

.
tv_£c
,.
tv_n£c
/1000);

107 
	gThœdP¬tyModuË
::~
ThœdP¬tyModuË
()

109 
ALOGV
("%s", 
__FUNCTION__
);

110 
¡İSock‘Cl›Á
();

111 
mem£t
(
mAdd»ss
, 0, (mAddress));

112 
	gmN“dPrštD©a
 = 
çl£
;

113 
	gi¤egi¡”OK
 = 
çl£
;

114 
	gisS’ddÚe
 = 0;

117 
±h»ad_mu‹x_de¡roy
(&
mS’dLock
);

120 
	gThœdP¬tyModuË
::
g‘SyncD©aSize
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
){

121 
by‹s
[
CAP
];

122 
	gsize
 = 
SyncD©aToŞs
::
d©a2By‹s
(
d©a
,
by‹s
);

123  
	gsize
;

126 
boŞ
 
	gThœdP¬tyModuË
::
£nd
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
)

128 
by‹s
[
CAP
];

129 #ifdeà
PRINT_DATA_INFO


130 
	gj
;

131 
	g´tšfo
[1024];

133 
	gwa™times
=0;

134 
	gi
,
	gd©asize
;

135 
±h»ad_mu‹x_lock
(&
mS’dLock
);

136 
	gisS’ddÚe
 != 0)

138 
ALOGE
("isS’ddÚi nÙ„—dy %d",
wa™times
);

139 if(
	gwa™times
++ > 1000)

141 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

142  
	gçl£
;

144 
u¦“p
(1*1000);

146 
	gsize
 = 
SyncD©aToŞs
::
d©a2By‹s
(
d©a
,
by‹s
);

147 if(
	gsize
 <= 0){

148 
ALOGE
("Error:serial failed!");

149 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

150  
	gçl£
;

153 
	gd©asize
 = ()
by‹s
[10];

154 
	gi
=11; i<14; i++)

156 
	gd©asize
 <<=8;

157 
	gd©asize
 +ğ()
by‹s
[
i
] & 0xff;

161 if((
	gsize
 - 
	gd©asize
) != 14)

162 
ALOGE
("!!!!wrÚg Thœd_£nd_d©a_size=%d, s’d buàsize=%dƒ¼Ü !!!",
d©asize
,
size
);

163 #ifdeà
PRINT_DATA_INFO


164 
ALOGD
("Thœd_£nd size=%d---d©asize=%d -¡¬t-------",
size
,
d©asize
);

165 
	gi
=0; i<
	gsize
; i++)

167 
	g´tšfo
[0]=0;

168 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

170 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", 
by‹s
[
i
]);

172 
ALOGD
("Thœd_£nd | %s",
´tšfo
);

174 
ALOGD
("Third_send -end----------");

177 if(
	gmBšdTy³
 =ğ
NONE
){

178 
ALOGE
("Error:bluetooth is disconnect‚ow!");

179 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

180  
	gçl£
;

183 if(
	gsize
 > 150 && 
	gmBšdTy³
 =ğ
BLE
){

184 
ALOGE
("Error:ble send data must be < 150!");

185 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

186  
	gçl£
;

189 
¡ršg
 
	gmsg
 = "send-";

190 
	gmsg
.
­³nd
(
by‹s
,
size
);

191 
	gisS’ddÚe
 = 1;

192 
	g»’
 = ::
£nd
(
mSock‘Fd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0);

195 
	gwa™times
 = 0;

196 
	gisS’ddÚe
 != 2)

198 if(
wa™times
++ > 21000)

200 
ALOGE
("£nd wa™imes=%dm toØlÚg,ex™ s’d()",
wa™times
/10);

203 
u¦“p
(1*100);

206 if(
	gwa™times
>0)

207 
ALOGV
("£nd wa™imes=%d",
wa™times
);

209 
	gisS’ddÚe
 = 0;

210 
±h»ad_mu‹x_uÆock
(&
mS’dLock
);

211  
	gŒue
;

214 
boŞ
 
	gThœdP¬tyModuË
::
¡İSock‘Cl›Á
(){

215 
±h»ad_još
(
mR—dTh»ad
, 
NULL
);

216 if(
	gmSock‘Fd
 > 0){

217 
ALOGD
("¡İSock‘Cl›Á %d",
mSock‘Fd
);

218 
şo£
(
mSock‘Fd
);

219 
	gmSock‘Fd
 = -1;

221 
ALOGE
("nØşo£ sock‘ %d <0",
mSock‘Fd
);

223  
	gŒue
;

226 
boŞ
 
	gThœdP¬tyModuË
::
¡¬tSock‘Cl›Á
(){

227 
ALOGV
("%s", 
__FUNCTION__
);

228 
	gfd
;

229 
sockaddr_un
 
	g£r_addr
;

230 
mem£t
(&
£r_addr
, 0, (ser_addr));

231 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

232 
¡rıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
);

233 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

234 if(
	gfd
 < 0){

235 
ALOGE
("sock‘ƒ¼Ü: %s\n",
¡»¼Ü
(
”ºo
));

236  
	gçl£
;

239 
	gæags
 = 
fú
(
fd
, 
F_GETFD
);

240 
	gæags
 |ğ
FD_CLOEXEC
;

241 
fú
(
fd
, 
F_SETFD
, 
æags
);

243 
	g»t
 = 
cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

244 if(
	g»t
 < 0){

245 
ALOGE
("cÚÃù sock‘ƒ¼Ü: %s\n",
¡»¼Ü
(
”ºo
));

246  
	gçl£
;

249 
	gmSock‘Fd
 = 
fd
;

250 
ALOGD
("%s,mSock‘Fd =%d", 
__FUNCTION__
,
mSock‘Fd
);

251 
±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
ThœdP¬tyModuË
::
R—dTh»adW¿µ”
, 
this
);

252  
	gŒue
;

255 
boŞ
 
	gThœdP¬tyModuË
::
»¡¬tSock‘Cl›Á
(
»Œy_times
){

256 
ALOGV
("%s", 
__FUNCTION__
);

257 
	gfd
;

258 
sockaddr_un
 
	g£r_addr
;

259 
mem£t
(&
£r_addr
, 0, (ser_addr));

260 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

261 
¡rıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
);

262 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

263 if(
	gfd
 < 0){

264 
ALOGE
("sock‘ƒ¼Ü: %s\n",
¡»¼Ü
(
”ºo
));

265  
	gçl£
;

268 
	gæags
 = 
fú
(
fd
, 
F_GETFD
);

269 
	gæags
 |ğ
FD_CLOEXEC
;

270 
fú
(
fd
, 
F_SETFD
, 
æags
);

272 
	g»t
 = 
cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

273 if(
	g»t
 < 0){

274 
ALOGE
("cÚÃù sock‘ƒ¼Ü: %s,»Œy_time:%d\n",
¡»¼Ü
(
”ºo
),
»Œy_times
);

275 
şo£
(
fd
);

276  
	gçl£
;

279 
	gmSock‘Fd
 = 
fd
;

281 
¡ršg
 
	gmsg
 = "register-";

282 
	gmsg
.
­³nd
(
mModuËName
);

283 
	gtimes
 = 0;

284 ::
£nd
(
mSock‘Fd
, 
msg
.
c_¡r
(), msg.
Ëngth
(), 0) < 0){

286 if(
	gtimes
++ >3000)

288 
ALOGE
("ThirdModule„egister fail.");

291 
u¦“p
(1000);

295 
ALOGD
("%s,mSock‘Fd =%d,»Œy=%d,wa™=%d", 
__FUNCTION__
, 
mSock‘Fd
, 
»Œy_times
,
times
);

296  
	gŒue
;

299 *
	gThœdP¬tyModuË
::
R—dTh»adW¿µ”
(*
me
) {

301 
ThœdP¬tyModuË
 *
moduË
 = 
¡©ic_ÿ¡
<ThœdP¬tyModuË *>(
me
);

302 
	gmoduË
->
R—dTh»adFunc
();

303  
	gNULL
;

306 
boŞ
 
	gThœdP¬tyModuË
::
isO³Ãd
(){

307 
ALOGV
("%s", 
__FUNCTION__
);

308 
	gfd
 = ::
İ’
("/sys/şass/rfkl/rfkl0/¡©e", 
O_RDONLY
);

309 ià(
	gfd
 < 0){

310 
ALOGE
("İ’ /sys/şass/rfkl/rfkl0/¡©çed: % ",
¡»¼Ü
(
”ºo
));

311  
	gçl£
;

314 
	gbufãr
=0;

315 ::
»ad
(
fd
, &
bufãr
, 1);

317 ::
şo£
(
fd
);

321  (
	gbufãr
=='1'è? 
Œue
 : 
çl£
;

324 
	gThœdP¬tyModuË
::
R—dTh»adFunc
(){

325 
»cv_buf
[
BUFFER_SIZE
];

326 
	gcouÁ
 = 1;

327 cÚ¡ *
	gcmp¡r
[2]={"bind-state-change:","msg_send_ret:"};

328 
	gcmp¡¾’
[2],
	gi
;

329 
	g»Œy_times
;

331 
	gi
=0; i<2; i++)

333 
	gcmp¡¾’
[
i
] = 
¡¾’
(
cmp¡r
[i]);

336 if(
	gmSock‘Fd
 <= 0){

337 
u¦“p
(200*1000);

338 if(
isO³Ãd
()) {

339 if(
	g»Œy_times
 == 0)

340 
u¦“p
(400*1000);

341 
»¡¬tSock‘Cl›Á
(++
»Œy_times
);

343 if(
	gmSock‘Fd
 > 0)

344 
	g»Œy_times
 = 0;

345 if(
	g»Œy_times
 >40)

348 
	gmSock‘Fd
 > 0){

349 
mem£t
(
»cv_buf
, 0 ,
BUFFER_SIZE
);

350 
	gcouÁ
 = 
»cv
(
mSock‘Fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

351 if(
	gcouÁ
 <= 0){

352 
ALOGE
("sock‘ %d i şo£ !ƒ¼Ü=%s(%d),”ºo=%d,couÁ=%d",
mSock‘Fd
,
¡»¼Ü
(
”ºo
),”ºo, 
couÁ
);

353 
şo£
(
mSock‘Fd
);

354 
	gmSock‘Fd
 = -1;

358 if(
¡r¡r
(
»cv_buf
, "bšd-¡©e-chªge:"è!ğ
NULL
){

359 if(
»cv_buf
[
couÁ
-1] == '0'){

360 
mIsBšded
 = 
çl£
;

361 
	gmBšdTy³
 = 
NONE
;

362 }if(
	g»cv_buf
[
couÁ
-1] == '1'){

363 
mIsBšded
 = 
Œue
;

364 
	gmBšdTy³
 = 
BLE
;

365 }if(
	g»cv_buf
[
couÁ
-1] == '2'){

366 
mIsBšded
 = 
Œue
;

367 
	gmBšdTy³
 = 
BLUETOOTH
;

369 
time¥ec
 
	g
;

370 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

372 
ALOGD
("bšd-¡©e-chªge: mIsBšded=%s,bšdTy³=% %ld.%ld",
mIsBšded
?"Œue":"çl£",(
mBšdTy³
==
BLE
)?"BLE":((mBšdTy³==
BLUETOOTH
)?"BLUETOOTH":"NONE"),

.
tv_£c
,.
tv_n£c
);

373 
	gi¤egi¡”OK
 = 
Œue
;

378 
	gmsgsum
 =0;

379 
	gbcouÁ
 = 
couÁ
;

380 
	g’
;

381 *
	g»cv_±r
 = 
»cv_buf
;

386 if(
memcmp
(
»cv_buf
, 
cmp¡r
[0] ,
cmp¡¾’
[0] ) == 0){

387 
’
 = 
cmp¡¾’
[0];

388 if(
	g»cv_buf
[
’
] == '0'){

389 
mIsBšded
 = 
çl£
;

390 
	gmBšdTy³
 = 
NONE
;

391 }if(
	g»cv_buf
[
’
] == '1'){

392 
mIsBšded
 = 
Œue
;

393 
	gmBšdTy³
 = 
BLE
;

394 }if(
	g»cv_buf
[
’
] == '2'){

395 
mIsBšded
 = 
Œue
;

396 
	gmBšdTy³
 = 
BLUETOOTH
;

398 
	gi¤egi¡”OK
 = 
Œue
;

399 
time¥ec
 
	g
;

400 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

402 
ALOGD
("bšd-¡©e-chªge: mIsBšded=%s,bšdTy³=% %ld.%06ld",
mIsBšded
?"Œue":"çl£",(
mBšdTy³
==
BLE
)?"BLE":((mBšdTy³==
BLUETOOTH
)?"BLUETOOTH":"NONE"),

.
tv_£c
,.
tv_n£c
/1000);

403 
	gcouÁ
 -ğ
’
 + 1;

404 
	g»cv_±r
 +ğ
’
 +1;

406 }if(
memcmp
(
»cv_±r
, 
cmp¡r
[1] , 
cmp¡¾’
[1] )==0)

408 
’
 = 
cmp¡¾’
[1];

409 if(
	gisS’ddÚe
 == 1)

410 
isS’ddÚe
=2;

411 
	gcouÁ
 -ğ
’
 +1;

412 
	g»cv_±r
 +ğ
’
 +1;

415 
	g»maš_size
=
couÁ
;

417 
	g¥
<
	gSyncD©a
> 
	gsyncD©a
 = 
Ãw
 
SyncD©a
();

418 
	g»tsize
 = 
SyncD©aToŞs
::
by‹s2D©a
(
syncD©a
,
»cv_±r
,
»maš_size
);

420 if(
	g»tsize
 < 0){

421 
ALOGE
("funùiÚ=%s,E¼Ü:syncd©¨·r£¸çed!\n",
__FUNCTION__
);

424 
´štPack‘Info
("rcv-",
»cv_±r
,
»maš_size
,
Œue
);

425 
ÚR‘rive
(
syncD©a
);

427 
	g»maš_size
 -ğ
»tsize
;

428 if(
	g»maš_size
 > 
¡¾’
("msg_send_ret:") +1)

429 
ALOGD
("®lsize=%d,size=%d", 
bcouÁ
, 
»tsize
);

431 
ALOGD
("size=%d",
»tsize
);

432 
	gmsgsum
++;

433 
	gcouÁ
 -ğ
»tsize
;

434 
	g»cv_±r
 +ğ
»tsize
;

437 }
	gcouÁ
 > 0);

439 if(
	gmsgsum
 > 1)

441 
ALOGD
("msgsum:%d,®lsize=%d", 
msgsum
,
bcouÁ
);

448 
ALOGV
("readhread over \n");

451 
BIND_TYPE
 
	gThœdP¬tyModuË
::
g‘BšdTy³
(){

452  
mBšdTy³
;

455 
boŞ
 
	gThœdP¬tyModuË
::
g‘Blu‘oÙhAdd»ss
(
¡ršg
 & 
add»ss
){

456 if(
¡¾’
(
mAdd»ss
) > 11)

458 
add»ss
 = 
mAdd»ss
;

459  
	gŒue
;

462 
FILE
* 
	gpFe
 = 
fİ’
("/usr/data/bsa/bt_addr","r");

463 ià(
	gNULL
 =ğ
pFe
) {

464 
ALOGE
("can't open filep(%s)", "/usr/data/bsa/bt_addr");

465  
	gçl£
;

468 
fsÿnf
(
pFe
, "%s", 
mAdd»ss
);

469 
fşo£
(
pFe
);

470 if(
	gmAdd»ss
 =ğ
NULL
 || 
¡¾’
(
mAdd»ss
) < 11){

471  
çl£
;

473 
	gadd»ss
 = 
mAdd»ss
;

474  
	gŒue
;

	@sdk/ThirdPartyModule.h

1 #iâdeà
THIRDPARTYMODULE_H_


2 
	#THIRDPARTYMODULE_H_


	)

4 
	~<¡dio.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

10 
	~<±h»ad.h
>

11 
	~"SyncD©a.h
"

13 
Çme¥aû
 
	gªdroid
 {

21 şas 
	cThœdP¬tyModuË
{

22 
	gpublic
:

27 
ThœdP¬tyModuË
(cÚ¡ 
¡ršg
 & 
Çme
);

34 
boŞ
 
£nd
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
);

41 
g‘SyncD©aSize
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
);

46 
	gvœtu®
 ~
ThœdP¬tyModuË
();

52 
vœtu®
 
ÚR‘rive
(cÚ¡ 
¥
<
SyncD©a
> & 
d©a
)=0;

58 
boŞ
 
isBšded
(){ 
	gmIsBšded
;};

64 
BIND_TYPE
 
g‘BšdTy³
();

71 
boŞ
 
g‘Blu‘oÙhAdd»ss
(
¡ršg
 & 
add»ss
);

73 
	g´iv©e
:

75 
boŞ
 
¡İSock‘Cl›Á
();

76 
boŞ
 
¡¬tSock‘Cl›Á
();

77 
boŞ
 
isO³Ãd
();

78 
boŞ
 
»¡¬tSock‘Cl›Á
(
»Œy_times
);

79 *
R—dTh»adW¿µ”
(*
me
);

80 
R—dTh»adFunc
();

82 
boŞ
 
	gmIsBšded
;

83 
BIND_TYPE
 
	gmBšdTy³
;

84 
	gmSock‘Fd
;

85 
±h»ad_t
 
	gmR—dTh»ad
;

86 
¡ršg
 
	gmModuËName
;

87 
	gmAdd»ss
[20];

88 
ThœdP¬tyModuË
* 
	gmModuË
;

89 
boŞ
 
	gi¤egi¡”OK
;

90 
boŞ
 
	gmN“dPrštD©a
;

91 vŞ©
	gisS’ddÚe
;

94 
±h»ad_mu‹x_t
 
	gmS’dLock
;

	@sdk/ThirdPartyServer.cpp

2 
	#LOG_TAG
 "ThœdP¬tyS”v”"

	)

4 
	~<sigÇl.h
>

5 
	~<uts/Log.h
>

7 
	~"ThœdP¬tyS”v”.h
"

8 
	~<sys/sock‘.h
>

9 
	~<sys/un.h
>

10 
	~<”ºo.h
>

12 
	~"SµPrÙocŞ.h
"

13 
	~"BËPrÙocŞ.h
"

15 
Çme¥aû
 
	gªdroid
 {

17 #ifdeà
__ılu¥lus


21 
	~"­p_av.h
"

22 
£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
);

23 #ifdeà
__ılu¥lus


28 
	#UNIX_DOMAIN
 "/v¬/run/thœd·¹y_sock‘"

	)

29 
	#BUFFER_SIZE
 4096

30 cÚ¡ 
¡ršg
 
MODULE_NAME
 = "thœd·¹y_m";

	)

32 
´štPack‘Info
(cÚ¡ * 
t™Ë
, cÚ¡ * 
buf
, 
size
,
boŞ
 
»®y
)

34 if(
	g»®y
)

36 
	gj
,
	gi
,
	gk
;

37 
	g´tšfo
[512],
	g´2
[256];

39 if(
	g»®y
)

40 
ALOGE
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

42 
ALOGD
(" -%s-size=%d--- -¡¬t-------",
t™Ë
,
size
);

43 
	gk
=
i
=0; 
	gi
<
	gsize
;k++)

45 
	g´tšfo
[0]=0;

46 
	g´2
[0] = 0;

47 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

49 
¥rštf
(
´2
+
j
, "%c", 
isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

50 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
])&0xff);

52 if(
	g»®y
)

53 
ALOGE
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

55 
ALOGD
("%3x| % -- %s",
k
,
´tšfo
,
´2
);

57 if(
	g»®y
)

58 
ALOGE
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

60 
ALOGD
(" -%s-size=%d--’d----------",
t™Ë
,
size
);

65 
ThœdP¬tyS”v”
* 
	gThœdP¬tyS”v”
::
sIn¡ªû
 = 
NULL
;

67 
ThœdP¬tyS”v”
* 
	gThœdP¬tyS”v”
::
g‘In¡ªû
(
RefBa£
* 
´ÙocŞ
)

69 
ALOGV
("%s", 
__FUNCTION__
);

70 if(
	gsIn¡ªû
 =ğ
NULL
){

71 
sIn¡ªû
 = 
Ãw
 
ThœdP¬tyS”v”
(
´ÙocŞ
);

73  
	gsIn¡ªû
;

76 
	gThœdP¬tyS”v”
::
ThœdP¬tyS”v”
(
RefBa£
* 
´ÙocŞ
){

77 
±h»ad_mu‹x_š™
(&
m£ndLock
, 
NULL
);

78 
	gmDÚe
 = 
çl£
;

79 
	gmIsBšded
 = 
çl£
;

80 
	gmPrÙocŞ
 = 
´ÙocŞ
;

82 
¡¬tSock‘S”v”
();

85 
	gThœdP¬tyS”v”
::~
ThœdP¬tyS”v”
()

87 
¡İSock‘S”v”
();

88 
±h»ad_mu‹x_de¡roy
(&
m£ndLock
);

91 
boŞ
 
	gThœdP¬tyS”v”
::
»gi¡”ModuË
(
¡ršg
 
moduË
,
ş›Á_fd
)

93 
time¥ec
 
	g
;

94 
ALOGV
("%s,fd=%d", 
__FUNCTION__
,
ş›Á_fd
);

95 
	gMODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
fšd
(
moduË
.
c_¡r
());

96 if(
	g™
 =ğ
mModuËM­
.
’d
()) {

97 
mModuËM­
.
š£¹
(
MODULEMAP
::
v®ue_ty³
(
moduË
, 
ş›Á_fd
));

99 
¡ršg
 
	gmsg
 = "bind-state-change:";

100 
	gmTy³
){

101 
	gNONE
:

102 
msg
.
­³nd
("0");

104 
	gBLE
:

105 
msg
.
­³nd
("1");

107 
	gBLUETOOTH
:

108 
msg
.
­³nd
("2");

112 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

114 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

115 
ALOGD
("»gi¡” moduË(%sèsucûss!,%ld.%06ld.",
moduË
.
c_¡r
(),

.
tv_£c
,.
tv_n£c
/1000);

116  
	gŒue
;

118 
şock_g‘time
(
CLOCK_MONOTONIC
,&

);

119 
ALOGE
("»gi¡” moduË(%sèçed,%ld.%06ld..sy¡em hav¨sommoduËƒxi¡!",
moduË
.
c_¡r
(),

.
tv_£c
,.
tv_n£c
/1000);

120  
	gçl£
;

124 
boŞ
 
	gThœdP¬tyS”v”
::
unRegi¡”ModuË
(
ş›Á_fd
)

126 
ALOGD
("%s,fd=%d", 
__FUNCTION__
,
ş›Á_fd
);

128 
	gMODULEMAP
::
™”©Ü
 
™
;

129 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

130 if(
	g™
->
	g£cÚd
 =ğ
ş›Á_fd
){

131 
mModuËM­
.
”a£
(
™
);

132 
ALOGD
("unRegi¡” moduË(%sèsucûss,fd i %d",(
™
->
fœ¡
).
c_¡r
(), it->
£cÚd
);

133  
	gŒue
;

136 
ALOGD
("unRegi¡” moduË fa,fd i %d", 
™
->
£cÚd
);

137  
	gçl£
;

140 
	gThœdP¬tyS”v”
::
BšdedS‹Chªge
(
boŞ
 
isBšded
,boŞ 
isBË
){

141 
ALOGV
("%s", 
__FUNCTION__
);

142 
	gmIsBšded
 = 
isBšded
;

143 
¡ršg
 
	gmsg
 = "bind-state-change:";

144 if(
	gmIsBšded
){

145 
	gmTy³
 = 
isBË
 ? 
BLE
 : 
BLUETOOTH
;

146 if(
	gisBË
)

147 
	gmsg
.
­³nd
("1");

149 
	gmsg
.
­³nd
("2");

151 
	gmsg
.
­³nd
("0");

152 
	gmTy³
 = 
NONE
;

154 
	gMODULEMAP
::
™”©Ü
 
™
;

155 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

157 
	gş›Á_fd
 = 
™
->
£cÚd
;

158 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

162 
boŞ
 
	gThœdP¬tyS”v”
::
£nddÚe
(
ş›Á_fd
,
»t
)

164 
ALOGV
("% »t:%d", 
__FUNCTION__
,
»t
);

166 
¡ršg
 
	gmsg
 = "msg_send_ret:";

167 
	g»t
){

169 
msg
.
­³nd
("0");

172 
msg
.
­³nd
("1");

175 
msg
.
­³nd
("2");

185 ::
£nd
(
ş›Á_fd
,
msg
.
c_¡r
(),msg.
Ëngth
(),0);

187 
	gThœdP¬tyS”v”
::
ÚR‘rive
(cÚ¡ * 
moduËName
,* 
d©a
,
size
)

189 
ALOGD
("%s,size=%d", 
__FUNCTION__
,
size
);

190 
	gMODULEMAP
::
™”©Ü
 
™
ğ
mModuËM­
.
fšd
(
moduËName
);

191 if(
	g™
 =ğ
mModuËM­
.
’d
()) {

192 
ALOGE
("ÚR‘rivçed .‚ØmoduË(%sèexi¡!",
moduËName
);

193 
´štPack‘Info
("UÄe¥Ú msg",
d©a
,
size
,
Œue
);

198 
	gş›Á_fd
 = 
™
->
£cÚd
;

199 ::
£nd
(
ş›Á_fd
,
d©a
,
size
,0);

203 
boŞ
 
	gThœdP¬tyS”v”
::
£nd
(
¡ršg
 
moduË
,* 
by‹s
,
size
)

205 #ifdeà
PRINT_DATA_INFO


206 
	gj
,
	gi
,
	gk
;

207 
	g´tšfo
[1024];

209 
ALOGD
("% size=%d", 
__FUNCTION__
,
size
);

210 if(
	gsize
 <= 0){

211 
ALOGE
("Error:serial failed!");

212  
	gçl£
;

215 if(
	gmIsBšded
 =ğ
çl£
){

216 
ALOGE
("%s:now s‹ i unbšd ", 
__FUNCTION__
);

217  
	gçl£
;

220 #ifdeà
PRINT_DATA_INFO


223 
ALOGD
(" size=%d--- -¡¬t-------",
size
);

224 
	gk
=
i
=0; 
	gi
<
	gsize
;k++)

226 
	g´tšfo
[0]=0;

227 
¥rštf
(
´tšfo
,"%3x | ",
i
>>4);

228 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

230 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", 
by‹s
[
i
]&0xff);

232 
ALOGD
("%3x| %s",
k
,
´tšfo
);

234 
ALOGD
(" -end----------");

237 if(
	gmPrÙocŞ
 !ğ
NULL
){

238 if(
mTy³
 =ğ
BLUETOOTH
){

239 ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),
by‹s
,
size
);

240 }if(
	gmTy³
 =ğ
BLE
){

241 ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),
by‹s
,
size
);

245  
	gŒue
;

249 
boŞ
 
	gThœdP¬tyS”v”
::
£ndTimes
(
¡ršg
 
moduË
,* 
by‹s
,
size
, *
u£d_size
)

252 cÚ¡ 
	gmsgsub¡r
[]={"send-"};

253 cÚ¡ 
	gmsg_h—d_Ën
 = 14;

254 cÚ¡ 
	goff_msg_size
 = 10;

255 
	g·ckSum
 = 0;

256 
	gcursize
;

257 *
	g¤c
;

258 
	gÃwsize
=0,
	g¡rsize
,
	gtÙ®
=0;

259 
boŞ
 
	g»t
;

261 *
	gu£d_size
 = 0;

262 if(
	gsize
 <= 0){

263 
ALOGE
("Error:serial failed!");

264  
	gçl£
;

267 if(
	gmIsBšded
 =ğ
çl£
){

268 
ALOGE
("%s:now s‹ i unbšd ", 
__FUNCTION__
);

269 *
	gu£d_size
 = 
size
;

270  
	gçl£
;

272 
ALOGV
("% wa™†ock", 
__FUNCTION__
);

275 
ALOGV
("% size=%d", 
__FUNCTION__
,
size
);

279 
	g¡rsize
 = 
¡¾’
((*)
msgsub¡r
);

280 
	g¤c
 = (*)
by‹s
;

283 if(
	g·ckSum
 == 0)

287 
cursize
 = (
¤c
[
off_msg_size
]<<24) + (src[off_msg_size+1]<<16) + (src[off_msg_size+2]<<8) + src[off_msg_size+3];

289 
	gÃwsize
 = 
cursize
 + 
msg_h—d_Ën
;

290 #ifdeà
PRINT_DATA_INFO


291 
ALOGD
("tÙ®=%x…ack=%d size=%X sŒsize=%d!!!!",
tÙ®
,
·ckSum
,
cursize
,
¡rsize
);

293 
	gtÙ®
 = 
cursize
 + 
msg_h—d_Ën
;

295 if(
	gmPrÙocŞ
 !ğ
NULL
){

297 if(
mTy³
 =ğ
BLUETOOTH
){

298 
»t
 = ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),(*)
¤c
,()
cursize
 + 
msg_h—d_Ën
);

299 }if(
	gmTy³
 =ğ
BLE
){

300 
»t
 = ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),(*)
¤c
,()
cursize
 + 
msg_h—d_Ën
);

303 
	g¤c
 +ğ
tÙ®
;

304 
	g·ckSum
 ++;

310 
	gcursize
 = (
¤c
[
off_msg_size
+
¡rsize
]<<24) + (src[off_msg_size+strsize+1]<<16) + \

311 (
¤c
[
off_msg_size
+
¡rsize
+2]<<8) + src[off_msg_size+strsize+3];

316 #ifdeà
PRINT_DATA_INFO


317 
ALOGD
("tÙ®=%x,·ck=%d size=%X, %02X.%02X.%02X.%02X !",
tÙ®
,
·ckSum
,
cursize
,
¤c
[15],

318 
¤c
[16],src[17],src[18]);

320 
	gtÙ®
 +ğ
cursize
 + 
msg_h—d_Ën
 + 
¡rsize
;

321 if(
	gtÙ®
 > 
	gsize
)

323 
ALOGE
("!!!!ƒ¼Ü size=%d,Ãed %d !!!!",
size
,
tÙ®
);

324 
	g»t
 = 
çl£
;

327 if(
	gmPrÙocŞ
 !ğ
NULL
){

329 if(
mTy³
 =ğ
BLUETOOTH
){

330 
»t
 = ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),(*)
¤c
+
¡rsize
,()
cursize
 + 
msg_h—d_Ën
);

331 }if(
	gmTy³
 =ğ
BLE
){

332 
»t
 = ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),(*)
¤c
+
¡rsize
,()
cursize
 + 
msg_h—d_Ën
);

335 
	g·ckSum
 ++;

336 
	g¤c
 +ğ
cursize
 + 
msg_h—d_Ën
 + 
¡rsize
;

338 }
	gtÙ®
 < 
	gsize
);

339 *
	gu£d_size
 = 
tÙ®
;

340 if(
	g·ckSum
 > 1)

341 
ALOGD
(" %d…ackag%d size,u£d %d.",
·ckSum
,
size
-ÕackSum-1)*5,
tÙ®
);

343 #ifdeà
PRINT_DATA_INFO


344 if((
	gsize
 >100)&& (
	g·ckSum
 >1))

346 
ALOGD
("aá size=%d--- -¡¬t-------",
size
);

347 
	gi
=0; i<
	gsize
;)

349 
	g´tšfo
[0]=0;

350 
¥rštf
(
´tšfo
,"%3x | ",
i
>>4);

351 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

353 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", 
by‹s
[
i
]);

355 
ALOGD
("aá S”v”_£nd %s",
´tšfo
);

357 
ALOGD
("aft Server_send -end----------");

363  
	g»t
;

366 
	gThœdP¬tyS”v”
::
wr™eIÁ
(*
±r
, 
v®
)

368 
	g±r
[0]=(
v®
>>24)&0xff;

369 
	g±r
[1]=(
v®
>>16)&0xff;

370 
	g±r
[2]=(
v®
>>8)&0xff;

371 
	g±r
[3]=
v®
&0xff;

373 
boŞ
 
	gThœdP¬tyS”v”
::
£ndMuÉi
(
¡ršg
 
moduË
,* 
by‹s
,
size
)

375 #ifdeà
PRINT_DATA_INFO


376 
	gj
,
	gi
;

377 
	g´tšfo
[1024];

379 cÚ¡ 
	gmsgsub¡r
[]={"send-"};

380 cÚ¡ 
	gmsg_h—d_Ën
 = 14;

381 
	g·ckSum
 = 0;

382 
	gcursize
;

383 *
	g¤c
,*
	gde¡
;

384 
	gÃwsize
=0,
	g¡rsize
,
	gtÙ®
=0;

387 if(
	gsize
 <= 0){

388 
ALOGE
("Error:serial failed!");

389  
	gçl£
;

392 if(
	gmIsBšded
 =ğ
çl£
){

393 
ALOGE
("%s:now s‹ i unbšd ", 
__FUNCTION__
);

394  
	gçl£
;

398 
ALOGD
("% size=%d", 
__FUNCTION__
,
size
);

399 #ifdeà
PRINT_DATA_INFO


400 if(
	gsize
 > 133)

402 
ALOGD
("beàS”v”_£ndMuÉ˜size=%d--- -¡¬t-------",
size
);

403 
	gi
=0; i<
	gsize
;)

405 
	g´tšfo
[0]=0;

406 
¥rštf
(
´tšfo
,"%3x | ",
i
>>4);

407 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

409 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", ()
by‹s
[
i
]);

411 
ALOGD
("beàS”v”_£nd %s",
´tšfo
);

413 
ALOGD
("befServer_send -end----------");

417 
	g¡rsize
 = 
¡¾’
((cÚ¡ *)
msgsub¡r
);

418 
	g¤c
 = 
de¡
 = (*)
by‹s
;

421 if(
	g·ckSum
 == 0)

425 
cursize
 = (
¤c
[10]<<24) + (src[11]<<16) + (src[12]<<8) + src[13];

427 
	gÃwsize
 = 
cursize
 + 
msg_h—d_Ën
;

428 
ALOGD
("S”v”_£ndMuÉ˜·ck=%d size=%X !!!!",
·ckSum
,
cursize
);

429 
	gtÙ®
 = 
cursize
 + 
msg_h—d_Ën
;

430 
	gde¡
 +ğ
cursize
 + 
msg_h—d_Ën
;

431 
	g¤c
 +ğ
cursize
 + 
msg_h—d_Ën
;

432 
	g·ckSum
 ++;

437 
	gcursize
 = (
¤c
[18]<<24) + (src[19]<<16) + (src[20]<<8) + src[21];

438 
	gtÙ®
 +ğ
cursize
+ 
msg_h—d_Ën
 + 
¡rsize
;

439 
ALOGD
("S”v”_£ndMuÉ˜·ck=%d size=%X !!!!",
·ckSum
,
cursize
);

440 if(
	gtÙ®
 > 
	gsize
)

442 
ALOGE
("!!!! S”v”_£ndMuÉ˜”rÜ size=%d,Ãed %d !!!!",
size
,
tÙ®
);

445 
	g·ckSum
 ++;

446 
memmove
(
de¡
, 
¤c
+
¡rsize
+4, 
cursize
 + 
msg_h—d_Ën
 -4);

447 
	gde¡
 +ğ
cursize
 + 
msg_h—d_Ën
 -4;

448 
	gÃwsize
 +ğ
cursize
 + 
msg_h—d_Ën
-4;

449 
	g¤c
 +ğ
cursize
 + 
msg_h—d_Ën
 + 
¡rsize
;

451 }
	gtÙ®
 < 
	gsize
);

452 if(
	g·ckSum
 > 1)

453 
ALOGD
("S”v”_£ndMuÉ˜hav%d…ackag",
·ckSum
);

454 if(
	g·ckSum
 > 1)

455 
wr™eIÁ
((*)
by‹s
, 
·ckSum
);

457 #ifdeà
PRINT_DATA_INFO


458 if((
	gsize
 >100)&& (
	g·ckSum
 >1))

460 
ALOGD
("aá S”v”_£ndMuÉ˜size=%d--- -¡¬t-------",
size
);

461 
	gi
=0; i<
	gsize
;)

463 
	g´tšfo
[0]=0;

464 
¥rštf
(
´tšfo
,"%3x | ",
i
>>4);

465 
	gj
=0; (
	gi
<
	gsize
 && j<16); j++,i++)

467 
¥rštf
(
´tšfo
+
¡¾’
Õ¹šfo), "%02X, ", 
by‹s
[
i
]);

469 
ALOGD
("aá S”v”_£nd %s",
´tšfo
);

471 
ALOGD
("aft Server_send -end----------");

476 if(
	gmPrÙocŞ
 !ğ
NULL
){

477 if(
mTy³
 =ğ
BLUETOOTH
){

478 ((
SµPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),
by‹s
,
Ãwsize
);

479 }if(
	gmTy³
 =ğ
BLE
){

480 ((
BËPrÙocŞ
 *)
mPrÙocŞ
)->
£ndPack‘
(
moduË
.
c_¡r
(),
by‹s
,
Ãwsize
);

484  
	gŒue
;

488 
	gThœdP¬tyS”v”
::
¡İSock‘S”v”
(){

489 *
dummy
;

490 
	gmDÚe
 = 
Œue
;

491 
±h»ad_još
(
mAcû±Th»ad
, &
dummy
);

492 
şo£
(
mLi¡’fd
);

495 
	gThœdP¬tyS”v”
::
¡¬tSock‘S”v”
(){

496 
sockaddr_un
 
£r_addr
;

497 
	g£r_addr
.
	gsun_çmy
 = 
AF_UNIX
;

498 
¡ºıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
,(ser_addr.sun_path)-1);

499 
uÆšk
(
UNIX_DOMAIN
);

500 
	gmLi¡’fd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

501 if(
	gmLi¡’fd
 < 0){

502 
ALOGE
("”rÜ: sock‘ c»©iÚ faed; skt_fd:%d\n", 
mLi¡’fd
);

505 if(
bšd
(
mLi¡’fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr)) < 0){

506 
ALOGE
(" bšdƒ¼Ü: %sÓ¼no: %d)\n",
¡»¼Ü
(
”ºo
),errno);

507 
şo£
(
mLi¡’fd
);

510 if(
li¡’
(
mLi¡’fd
, 1) < 0){

511 
ALOGE
("error: hstp socket†isten failed\n");

512 
şo£
(
mLi¡’fd
);

516 
±h»ad_ü—‹
(&
mAcû±Th»ad
, 
NULL
, 
ThœdP¬tyS”v”
::
Acû±Th»adW¿µ”
, 
this
);

519 *
	gThœdP¬tyS”v”
::
Acû±Th»adW¿µ”
(*
me
) {

520 
ThœdP¬tyS”v”
 *
sourû
 = 
¡©ic_ÿ¡
<ThœdP¬tyS”v” *>(
me
);

521 
	gsourû
->
Acû±Th»adFunc
();

522  
	gNULL
;

525 *
	gThœdP¬tyS”v”
::
Cl›ÁR—dTh»adW¿µ”
(*
¬g
) {

526 
THREAD_ARG
 *
¬gs
 = (THREAD_ARG *)
¬g
;

527 
ThœdP¬tyS”v”
 *
	g£rv”
 = 
¡©ic_ÿ¡
<ThœdP¬tyS”v” *>(
¬gs
->
£rv”
);

528 
	g£rv”
->
Cl›ÁR—dTh»adFunc
(
¬gs
->
ş›Á_fd
);

529  
	gNULL
;

532 *
	gThœdP¬tyS”v”
::
S‘BTVisibtiy
Ğ*
±r
 )

533 { 
±h»ad_d‘ach
(
±h»ad_£lf
());

534 
u¦“p
(2000*1000);

536 
£tBTVisib™y
(
Œue
,true);

537 
±h»ad_ex™
(0) ;

541 
	gThœdP¬tyS”v”
::
Acû±Th»adFunc
(){

543 
»adL’
 = 0;

544 
	gcouÁ
 = 0;

545 
	gmDÚe
 =ğ
çl£
){

546 
ş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

547 if(
	gş›Á_fd
 < 0){

548 
ALOGE
("cannot‡ccept client connect„equest");

551 
THREAD_ARG
 
	g¬g
;

553 
	g¬g
.
	g£rv”
 = 
this
;

554 
	g¬g
.
	gş›Á_fd
 = 
ş›Á_fd
;

555 
±h»ad_ü—‹
(&
mR—dTh»ad
, 
NULL
, 
ThœdP¬tyS”v”
::
Cl›ÁR—dTh»adW¿µ”
, &
¬g
);

559 
	gThœdP¬tyS”v”
::
Cl›ÁR—dTh»adFunc
(
ş›Á_fd_¬g
){

560 
»cv_buf
[
BUFFER_SIZE
];

561 
	gcouÁ
 = 1;

562 cÚ¡ *
	gcmp¡r
[]={"register-","send-"};

563 *
	g»cv_±r
;

564 
	gcmp¡¾’
[2],
	gi
,
	gu£d_size
,
	g´štæag
;

565 
	gş›Á_fd
 = 
ş›Á_fd_¬g
;

566 
±h»ad_t
 
	gmyth»ad
;

568 
	gi
=0; i<2; i++)

570 
	gcmp¡¾’
[
i
] = 
¡¾’
(
cmp¡r
[i]);

574 if(
	gş›Á_fd
 <= 0)

576 
u¦“p
(10*1000);

577 
	gş›Á_fd
 = 
acû±
(
mLi¡’fd
, 
NULL
, NULL);

578 if(
	gş›Á_fd
 < 0){

579 
ALOGE
("wait‚ew mListenfd");

582 
ALOGD
("g‘‚ew mLi¡’fd=%d", 
mLi¡’fd
);

586 
±h»ad_mu‹x_lock
(&
m£ndLock
);

587 
mem£t
(
»cv_buf
, 0 ,
BUFFER_SIZE
);

588 
	gcouÁ
 = 
»cv
(
ş›Á_fd
, 
»cv_buf
, 
BUFFER_SIZE
, 
MSG_NOSIGNAL
);

589 if(
	gcouÁ
 <= 0){

590 
£tBTVisib™y
(
çl£
,false);

591 
ALOGE
("sock‘ i şo£ !ƒ¼Ü=%s(%d),ƒ¼no=%d,couÁ=%d",
¡»¼Ü
(
”ºo
),”ºo,
couÁ
);

592 
şo£
(
ş›Á_fd
);

593 
unRegi¡”ModuË
(
ş›Á_fd
);

594 
	gş›Á_fd
 = -1;

595 
±h»ad_mu‹x_uÆock
(&
m£ndLock
);

599 
	g»cv_±r
 = 
»cv_buf
;

600 
	g´štæag
 = 0;

603 if(
memcmp
(
»cv_±r
,
cmp¡r
[1], 
cmp¡¾’
[1])==0)

607 
»cv_±r
 +ğ
cmp¡¾’
[1];

608 
	gcouÁ
 -ğ
cmp¡¾’
[1];

609 
	gMODULEMAP
::
™”©Ü
 
™
;

610 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

611 if(
	g™
->
	g£cÚd
 =ğ
ş›Á_fd
){

612 
¡ršg
 
moduË
 = 
™
->
fœ¡
;

614 
£ndTimes
(
moduË
,
»cv_±r
,
couÁ
,&
u£d_size
);

615 
	gcouÁ
 -ğ
u£d_size
;

616 
	g»cv_±r
 +ğ
u£d_size
;

617 
£nddÚe
(
ş›Á_fd
,1);

621 }if(
memcmp
(
»cv_±r
, 
cmp¡r
[0], 
cmp¡¾’
[0]) == 0)

623 
¡ršg
 
moduË
;

625 
	gmoduË
.
assign
(
»cv_±r
+
cmp¡¾’
[0], 
couÁ
-cmpstrlen[0]);

626 
»gi¡”ModuË
(
moduË
,
ş›Á_fd
);

628 
	gcouÁ
 -ğ
cmp¡¾’
[0]+1;

629 
	g»cv_±r
 +ğ
cmp¡¾’
[0]+1;

630 
±h»ad_ü—‹
(&
myth»ad
, 
NULL
, &
S‘BTVisibtiy
, NULL);

633 
	gcouÁ
 --;

634 
	g»cv_±r
 ++;

635 
ALOGE
("no valid data be„eceived!");

636 if(
	g´štæag
 ==0)

638 
´štPack‘Info
("šv®id d©a", 
»cv_±r
,
couÁ
,
Œue
);

639 
	g´štæag
=1;

642 }
	gcouÁ
 > 0);

644 if(
¡r¡r
(
»cv_buf
, "»gi¡”-"è!ğ
NULL
){

645 
´štPack‘Info
("»gi¡”-", 
»cv_buf
,
couÁ
,
Œue
);

646 
¡ršg
 
	gmoduË
;

647 
	gh—d_Ën
 = 
¡¾’
("register-");

648 
	gmoduË
.
assign
(
»cv_buf
+
h—d_Ën
,
couÁ
-head_len);

649 
»gi¡”ModuË
(
moduË
,
ş›Á_fd
);

650 }if(
¡r¡r
(
»cv_buf
, "£nd-"è!ğ
NULL
){

651 
h—d_Ën
 = 
¡¾’
("send-");

653 
	gMODULEMAP
::
™”©Ü
 
™
;

654 
	g™
 = 
mModuËM­
.
begš
(); iˆ!ğmModuËM­.
’d
(); it++) {

655 if(
	g™
->
	g£cÚd
 =ğ
ş›Á_fd
){

656 
¡ršg
 
moduË
 = 
™
->
fœ¡
;

658 
£ndTimes
(
moduË
,
»cv_buf
+
h—d_Ën
,
couÁ
-h—d_Ën,&
u£d_size
);

659 
£nddÚe
(
ş›Á_fd
,1);

664 
ALOGE
("no valid data be„eceived!");

665 
´štPack‘Info
("šv®id d©a", 
»cv_buf
,
couÁ
,
Œue
);

669 
±h»ad_mu‹x_uÆock
(&
m£ndLock
);

672 
ALOGV
("client„eadhread over \n");

	@sdk/ThirdPartyServer.h

1 #iâdeà
THIRDPARTYSERVER_H_


2 
	#THIRDPARTYSERVER_H_


	)

4 
	~<¡dio.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

9 
	~<uts/RefBa£.h
>

10 
	~"SyncD©a.h
"

12 
Çme¥aû
 
	gªdroid
 {

18 şas 
	cThœdP¬tyS”v”
 : 
public
 
RefBa£
{

19 
public
:

20 
¡d
::
	tm­
<
	t¡ršg
, > 
	tMODULEMAP
;

21 
ThœdP¬tyS”v”
* 
g‘In¡ªû
(
RefBa£
* 
´ÙocŞ
);

22 
	gvœtu®
 ~
ThœdP¬tyS”v”
();

24 
ÚR‘rive
(cÚ¡ * 
moduËName
,* 
d©a
,
size
);

25 
BšdedS‹Chªge
(
boŞ
 
isBšded
,boŞ 
isBË
);

27 
	g´iv©e
:

28 
±h»ad_mu‹x_t
 
m£ndLock
;

29 
	sTHREAD_ARG
{

30 
ThœdP¬tyS”v”
* 
	g£rv”
;

31 
	gş›Á_fd
;

34 
ThœdP¬tyS”v”
* 
	gsIn¡ªû
;

35 
ThœdP¬tyS”v”
(
RefBa£
* 
´ÙocŞ
);

37 *
S‘BTVisibtiy
(*
me
);

38 *
Acû±Th»adW¿µ”
(*
me
);

39 *
Cl›ÁR—dTh»adW¿µ”
(*
m­
);

41 
Acû±Th»adFunc
();

42 
Cl›ÁR—dTh»adFunc
(
ş›Á_fd
);

44 
¡¬tSock‘S”v”
();

45 
¡İSock‘S”v”
();

47 
boŞ
 
»gi¡”ModuË
(
¡ršg
 
moduË
,
ş›Á_fd
);

48 
boŞ
 
unRegi¡”ModuË
(
ş›Á_fd
);

51 
boŞ
 
£ndTimes
(
¡ršg
 
moduË
,* 
by‹s
,
size
, *
u£d_size
);

52 
boŞ
 
£nddÚe
(
ş›Á_fd
,
»t
);

54 
boŞ
 
	gmDÚe
;

55 
boŞ
 
	gmIsBšded
;

56 
	gmLi¡’fd
;

57 
±h»ad_t
 
	gmAcû±Th»ad
;

58 
±h»ad_t
 
	gmR—dTh»ad
;

60 
MODULEMAP
 
	gmModuËM­
;

63 
RefBa£
* 
	gmPrÙocŞ
;

64 
BIND_TYPE
 
	gmTy³
;

	@source/app_ag.c

12 
	~<uni¡d.h
>

13 
	~<fú.h
>

15 
	~"­p_ag.h
"

16 
	~"­p_uts.h
"

17 
	~"­p_xml_uts.h
"

18 
	~"­p_disc.h
"

19 
	~"­p_th»ad.h
"

21 #ifdeà
PCM_ALSA


22 
	~"®§/asoundlib.h
"

25 #ià
BLUETOOTH_AG_SUPPORT


26 
šg’ic_blu‘oÙh_ag_cÚÃù
();

27 
šg’ic_blu‘oÙh_ag_discÚÃù
();

33 
	#APP_AG_SAMPLE_RATE
 8000

	)

34 
	#APP_AG_BITS_PER_SAMPLE
 16

	)

35 
	#APP_AG_CHANNEL_NB
 1

	)

42 
	#APP_AG_FEATURES
 (
BSA_AG_FEAT_ECNR
 | 
BSA_AG_FEAT_3WAY
 | \

43 
BSA_AG_FEAT_VREC
 | 
BSA_AG_FEAT_ECS
 | \

44 
BSA_AG_FEAT_ECC
)

	)

47 
	#APP_AG_XML_REM_DEVICES_FILE_PATH
 "./bt_deviûs.xml"

	)

53 
tAPP_AG_CB
 
	g­p_ag_cb
;

55 cÚ¡ 
	gh¥_£rv_Çme
[] = "BSA Headset";

56 cÚ¡ 
	ghå_£rv_Çme
[] = "BSA Handsfree";

58 #ifdeà
PCM_ALSA


59 *
	g®§_deviû
 = "default";

60 
¢d_pcm_t
 *
	g®§_hªdË_¶ayback
 = 
NULL
;

61 
¢d_pcm_t
 *
	g®§_hªdË_ÿ±u»
 = 
NULL
;

62 
BOOLEAN
 
	g®§_ÿ±u»_İ’ed
 = 
FALSE
;

63 
BOOLEAN
 
	g®§_¶ayback_İ’ed
 = 
FALSE
;

70 
­p_ag_cback
(
tBSA_AG_EVT
 
ev’t
, 
tBSA_AG_MSG
 *
p_d©a
);

71 *
­p_ag_¡©us_2_¡r
(
tBSA_STATUS
 
¡©us
);

72 
­p_ag_sco_uc_cback
(
BT_HDR
 *
p_buf
);

74 #ifdeà
PCM_ALSA


75 
­p_ag_İ’_®§_du¶ex
();

76 
­p_ag_şo£_®§_du¶ex
();

79 
tBSA_AG_CBACK
 *
	gs_pC®lback
 = 
NULL
;

92 
	$­p_ag_»ad_xml_»mÙe_deviûs
()

94 
¡©us
;

95 
šdex
;

97 
šdex
 = 0; index < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

99 
­p_xml_»mÙe_deviûs_db
[
šdex
].
š_u£
 = 
FALSE
;

102 
¡©us
 = 
	`­p_xml_»ad_db
(
APP_AG_XML_REM_DEVICES_FILE_PATH
, 
­p_xml_»mÙe_deviûs_db
,

103 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

105 ià(
¡©us
 < 0)

107 
	`APP_ERROR1
("­p_xml_»ad_db faed (%d)", 
¡©us
);

111 
	}
}

121 
UINT8
 
	$­p_ag_g‘_šdex_by_hªdË
(
UINT16
 
hªdË
)

123 
UINT8
 
šdex
;

125 
šdex
=0; index < 
APP_AG_MAX_NUM_CONN
; index++)

127 ià(
­p_ag_cb
.
hndl
[
šdex
] =ğ
hªdË
)

133  
šdex
;

134 
	}
}

144 
tBSA_STATUS
 
	$­p_ag_’abË
()

146 
tBSA_STATUS
 
¡©us
;

147 
tBSA_AG_ENABLE
 
·¿m
;

149 
	`APP_DEBUG0
("Entering");

151 
¡©us
 = 
	`BSA_AgEÇbËIn™
(&
·¿m
);

152 
·¿m
.
p_cback
 = 
­p_ag_cback
;

153 
¡©us
 = 
	`BSA_AgEÇbË
(&
·¿m
);

155 ià(
¡©us
 !ğ
BSA_SUCCESS
)

157 
	`APP_ERROR1
("BSA_AgEÇbË faed(%d)", 
¡©us
);

160  
¡©us
;

161 
	}
}

171 
tBSA_STATUS
 
	$­p_ag_di§bË
()

173 
tBSA_STATUS
 
¡©us
;

174 
tBSA_AG_DISABLE
 
·¿m
;

175 
šdex
 ;

177 
	`APP_DEBUG0
("Entering");

179 
¡©us
 = 
	`BSA_AgDi§bËIn™
(&
·¿m
);

180 
¡©us
 = 
	`BSA_AgDi§bË
(&
·¿m
);

182 ià(
¡©us
 !ğ
BSA_SUCCESS
)

184 
	`APP_ERROR1
("BSA_AgDi§bË faed(%d)", 
¡©us
);

189 
šdex
=0; index < 
APP_AG_MAX_NUM_CONN
; index++)

191 ià((
­p_ag_cb
.
sco_rou‹
 =ğ
BSA_SCO_ROUTE_HCI
) &&

192 (
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
))

194 
	`UIPC_Clo£
(
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

195 
­p_ag_cb
.
uc_chªÃl
[
šdex
] = 
UIPC_CH_ID_BAD
;

198 ià(
­p_ag_cb
.
hndl
[
šdex
] !ğ
BSA_AG_BAD_HANDLE
)

200 
­p_ag_cb
.
hndl
[
šdex
] = 
BSA_AG_BAD_HANDLE
;

206  
¡©us
;

207 
	}
}

219 
tBSA_STATUS
 
	$­p_ag_»gi¡”
(
UINT8
 
sco_rou‹
)

221 
tBSA_STATUS
 
¡©us
;

222 
tBSA_AG_REGISTER
 
·¿m
;

224 
UINT8
 
šdex
;

226 
	`APP_DEBUG0
("Entering");

228 
šdex
=0; index < 
APP_AG_MAX_NUM_CONN
; index++)

230 ià(
­p_ag_cb
.
hndl
[
šdex
] =ğ
BSA_AG_BAD_HANDLE
)

236 ià(
šdex
 =ğ
APP_AG_MAX_NUM_CONN
)

238 
	`APP_ERROR1
("Cª‚Ù„egi¡” mÜthª %d AG",
APP_AG_MAX_NUM_CONN
);

239  
BSA_ERROR_CLI_BUSY
;

242 
	`BSA_AgRegi¡”In™
(&
·¿m
);

245 
·¿m
.
£rviûs
 = 
BSA_HSP_SERVICE_MASK
 | 
BSA_HFP_SERVICE_MASK
;

246 
·¿m
.
£c_mask
 = 
BSA_SEC_NONE
;

247 
·¿m
.
ã©u»s
 = 
APP_AG_FEATURES
;

248 
	`¡ºıy
(
·¿m
.
£rviû_Çme
[0], 
h¥_£rv_Çme
, (param.service_name[0]));

249 
·¿m
.
£rviû_Çme
[0][(param.service_name[0]) - 1] = '\0';

250 
	`¡ºıy
(
·¿m
.
£rviû_Çme
[1], 
hå_£rv_Çme
, (param.service_name[1]));

251 
·¿m
.
£rviû_Çme
[1][(param.service_name[1]) - 1] = '\0';

254 
·¿m
.
sco_rou‹
 = sco_route;

256 
­p_ag_cb
.
sco_rou‹
 = 
·¿m
.sco_route;

258 
¡©us
 = 
	`BSA_AgRegi¡”
(&
·¿m
);

260 ià(
¡©us
 !ğ
BSA_SUCCESS
)

262 
	`APP_ERROR1
("BSA_AgRegi¡” faed(%d)", 
¡©us
);

266 
­p_ag_cb
.
hndl
[
šdex
] = 
·¿m
.hndl;

267 
­p_ag_cb
.
uc_chªÃl
[
šdex
] = 
·¿m
.uipc_channel;

268 
	`APP_DEBUG1
("Regi¡” com¶‘hªdË %d, stu %d/%s", 
­p_ag_cb
.
hndl
[
šdex
],

269 
¡©us
, 
	`­p_ag_¡©us_2_¡r
(status));

272  
¡©us
;

273 
	}
}

283 
tBSA_STATUS
 
	$­p_ag_d”egi¡”
()

285 
tBSA_STATUS
 
¡©us
 = 
BSA_SUCCESS
;

286 
tBSA_AG_DEREGISTER
 
·¿m
;

287 
UINT8
 
šdex
;

289 
	`APP_DEBUG0
("Entering");

291 
	`BSA_AgD”egi¡”In™
(&
·¿m
);

293 
šdex
=0; index < 
APP_AG_MAX_NUM_CONN
; index++)

295 ià(
­p_ag_cb
.
hndl
[
šdex
] !ğ
BSA_AG_BAD_HANDLE
)

297 
·¿m
.
hndl
 = 
­p_ag_cb
.hndl[
šdex
];

299 
¡©us
 = 
	`BSA_AgD”egi¡”
(&
·¿m
);

300 ià(
¡©us
 !ğ
BSA_SUCCESS
)

302 
	`APP_ERROR1
("BSA_AgD”egi¡” faed(%d)", 
¡©us
);

303  
¡©us
;

307 ià(
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
)

309 if(
­p_ag_cb
.
voiû_İ’ed
)

311 
	`UIPC_Clo£
(
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

312 
­p_ag_cb
.
voiû_İ’ed
 = 
FALSE
;

314 
­p_ag_cb
.
uc_chªÃl
[
šdex
] = 
UIPC_CH_ID_BAD
;

316 
­p_ag_cb
.
hndl
[
šdex
] = 
BSA_AG_BAD_HANDLE
;

321  
BSA_SUCCESS
;

322 
	}
}

334 
	$­p_ag_İ’
(
BD_ADDR
 *
bd_addr_š
 )

336 
tBSA_STATUS
 
¡©us
 = 0;

337 
BD_ADDR
 
bd_addr
;

338 
deviû_šdex
;

340 
tBSA_AG_OPEN
 
·¿m
;

342 if(
bd_addr_š
 =ğ
NULL
)

344 
	`APP_DEBUG0
("Entering");

346 
	`APP_INFO0
("Bluetooth AG menu:");

347 
	`APP_INFO0
(" 0 Device from XML database (already…aired)");

348 
	`APP_INFO0
(" 1 Device found in†ast discovery");

349 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select source");

351 ià(
deviû_šdex
 == 0)

354 
	`­p_ag_»ad_xml_»mÙe_deviûs
();

356 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
, 
	`APP_NUM_ELEMENTS
(app_xml_remote_devices_db));

357 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

358 ià((
deviû_šdex
 >= 0) &&

359 (
deviû_šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

360 (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

362 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

366 
	`APP_ERROR1
("Bad Deviû Index: %d", 
deviû_šdex
);

373 
	`­p_disc_di¥Ïy_deviûs
();

374 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

375 ià((
deviû_šdex
 >= 0) &&

376 (
deviû_šdex
 < 
APP_DISC_NB_DEVICES
) &&

377 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

379 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

383 
	`APP_ERROR1
("Bad Deviû Index: %d", 
deviû_šdex
);

390 
	`bdıy
(
bd_addr
, *
bd_addr_š
);

393 
	`BSA_AgO³nIn™
(&
·¿m
);

395 
	`bdıy
(
·¿m
.
bd_addr
, bd_addr);

396 
·¿m
.
hndl
 = 
­p_ag_cb
.hndl[0];

397 
¡©us
 = 
	`BSA_AgO³n
(&
·¿m
);

399 ià(
¡©us
 !ğ
BSA_SUCCESS
)

401 
	`APP_ERROR1
("BSA_AgO³Àçed (%d)", 
¡©us
);

403  
¡©us
;

404 
	}
}

414 
tBSA_STATUS
 
	$­p_ag_şo£
()

416 
tBSA_STATUS
 
¡©us
;

417 
tBSA_AG_CLOSE
 
·¿m
;

419 
	`APP_DEBUG0
("Entering");

421 
¡©us
 = 
	`BSA_AgClo£In™
(&
·¿m
);

422 
·¿m
.
hndl
 = 
­p_ag_cb
.hndl[0];

423 
¡©us
 = 
	`BSA_AgClo£
(&
·¿m
);

425 ià(
¡©us
 !ğ
BSA_SUCCESS
)

427 
	`APP_ERROR1
("BSA_AgClo£ faed(%d)", 
¡©us
);

430  
¡©us
;

431 
	}
}

441 
	$­p_ag_İ’_audio
()

443 
tBSA_STATUS
 
¡©us
;

444 
tBSA_AG_AUDIO_OPEN
 
·¿m
;

446 
	`APP_DEBUG0
("Entering");

448 ià(
­p_ag_cb
.
İ’ed
 =ğ
FALSE
)

450 
	`APP_ERROR0
("AG connection must beƒstablished first");

454 
¡©us
 = 
	`BSA_AgAudioO³nIn™
(&
·¿m
);

455 
·¿m
.
hndl
 = 
­p_ag_cb
.hndl[0];

456 
·¿m
.
sco_rou‹
 = 
­p_ag_cb
.sco_route;

457 
¡©us
 = 
	`BSA_AgAudioO³n
(&
·¿m
);

459 ià(
¡©us
 !ğ
BSA_SUCCESS
)

461 
	`APP_ERROR1
("BSA_AgAudioO³Àçed (%d)", 
¡©us
);

464 
	}
}

474 
	$­p_ag_şo£_audio
()

476 
tBSA_STATUS
 
¡©us
;

477 
tBSA_AG_AUDIO_CLOSE
 
·¿m
;

479 
	`APP_DEBUG0
("Entering");

481 
¡©us
 = 
	`BSA_AgAudioClo£In™
(&
·¿m
);

482 
·¿m
.
hndl
 = 
­p_ag_cb
.hndl[0];

483 
¡©us
 = 
	`BSA_AgAudioClo£
(&
·¿m
);

485 ià(
¡©us
 !ğ
BSA_SUCCESS
)

487 
	`APP_ERROR1
("BSA_AgAudioClo£ faed: %d", 
¡©us
);

489 
	}
}

500 
	$­p_ag_şo£_»c_fe
()

502 ià(
­p_ag_cb
.
fd_sco_š_fe
 >=0)

504 
	`­p_wav_şo£_fe
(
­p_ag_cb
.
fd_sco_š_fe
, &×µ_ag_cb.
audio_fÜm©
));

505 
­p_ag_cb
.
fd_sco_š_fe
 = -1;

507 
	}
}

518 
	$­p_ag_şo£_¶ayšg_fe
()

520 ià(
­p_ag_cb
.
fd_sco_out_fe
 >=0)

522 
	`şo£
(
­p_ag_cb
.
fd_sco_out_fe
);

523 
­p_ag_cb
.
fd_sco_out_fe
 = -1;

525 
	}
}

538 
	$­p_ag_İ’_»c_fe
(*
f’ame
)

540 
­p_ag_cb
.
fd_sco_š_fe
 = 
	`­p_wav_ü—‹_fe
(
f’ame
, 
O_EXCL
);

542 
­p_ag_cb
.
audio_fÜm©
.
b™s_³r_§m¶e
 = 
APP_AG_BITS_PER_SAMPLE
;

543 
­p_ag_cb
.
audio_fÜm©
.
nb_chªÃls
 = 
APP_AG_CHANNEL_NB
;

544 
­p_ag_cb
.
audio_fÜm©
.
§m¶e_¿‹
 = 
APP_AG_SAMPLE_RATE
;

546 
	}
}

559 
	$­p_ag_wr™e_to_fe
(
UINT8
 *
p_buf
, 
size
)

561 ià(
­p_ag_cb
.
fd_sco_š_fe
 < 0)

565  
	`wr™e
(
­p_ag_cb
.
fd_sco_š_fe
, 
p_buf
, 
size
);

567 
	}
}

580 
	$­p_ag_sco_out_»ad_fe
()

582 
tAPP_WAV_FILE_FORMAT
 
fÜm©
;

583 
nb_by‹s
 = 0;

584 
¡©us
;

587 ià((
­p_ag_cb
.
fd_sco_out_fe
 < 0))

590 ià(
­p_ag_cb
.
voiû_İ’ed
)

592 
­p_ag_cb
.
fd_sco_out_fe
 = 
	`­p_wav_İ’_fe
(
APP_AG_SCO_OUT_SOUND_FILE
, &
fÜm©
);

595 ià(
­p_ag_cb
.
fd_sco_out_fe
 < 0)

597 
	`APP_ERROR1
("Could‚Ù o³Àfe: %s", 
APP_AG_SCO_OUT_SOUND_FILE
);

602 
nb_by‹s
 = 
	`»ad
(
­p_ag_cb
.
fd_sco_out_fe
,‡µ_ag_cb.
pcmbuf
, (app_ag_cb.pcmbuf));

604 ià(
nb_by‹s
 <= 0)

606 
	`APP_INFO0
("End of SCO file„eached");

607 
¡©us
 = 
	`şo£
(
­p_ag_cb
.
fd_sco_out_fe
);

608 ià(
¡©us
 < 0)

610 
	`APP_ERROR1
("şo£d faed: %d", 
¡©us
);

612 
­p_ag_cb
.
fd_sco_out_fe
 = -1;

615  
nb_by‹s
;

616 
	}
}

618 #iâdeà
PCM_ALSA


630 
	$­p_ag_¶ay_fe_th»ad
()

632 
¡©us
 = -1;

633 
nb_by‹s
 = 0;

634 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

635 
šdex
;

637 
	`APP_DEBUG0
("Entering");

639 ià(!
­p_ag_cb
.
voiû_İ’ed
)

641 
	`APP_ERROR0
("Could‚ot…lay file, voice connection‚ot opened");

645 ià((
	`­p_wav_fÜm©
(
APP_AG_SCO_OUT_SOUND_FILE
, &
wav_fÜm©
) == 0) &&

646 (
wav_fÜm©
.
b™s_³r_§m¶e
 =ğ
APP_AG_BITS_PER_SAMPLE
) &&

647 (
wav_fÜm©
.
nb_chªÃls
 =ğ
APP_AG_CHANNEL_NB
) &&

648 (
wav_fÜm©
.
§m¶e_¿‹
 =ğ
APP_AG_SAMPLE_RATE
))

650 
¡©us
 = 0;

652 ià(
¡©us
 != 0)

654 
	`APP_ERROR1
("'%s' does‚otƒxist or is‚ot„ight format (%d/%d/%d)",

655 
APP_AG_SCO_OUT_SOUND_FILE
, 
APP_AG_SAMPLE_RATE
, 
APP_AG_CHANNEL_NB
, 
APP_AG_BITS_PER_SAMPLE
);

659 
šdex
 = 0; index < 
APP_AG_MAX_NUM_CONN
; index++)

662 ià(
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
)

666 ià(
šdex
 =ğ
APP_AG_MAX_NUM_CONN
)

673 ià((
nb_by‹s
 = 
	`­p_ag_sco_out_»ad_fe
()) > 0)

675 ià(!
	`UIPC_S’d
(
­p_ag_cb
.
uc_chªÃl
[
šdex
], 0,‡µ_ag_cb.
pcmbuf
, 
nb_by‹s
))

677 
	`APP_ERROR1
("UIPC_S’d(%dèçed", 
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

680 ià(
nb_by‹s
 < 0)

682 
¡©us
 = -1;

683 
nb_by‹s
 = 0;

686 } (
nb_by‹s
 !ğ0è&& 
­p_ag_cb
.
voiû_İ’ed
 && !­p_ag_cb.
¡İ_¶ay
);

688 ià(
­p_ag_cb
.
fd_sco_out_fe
 >= 0)

690 
¡©us
 = 
	`şo£
(
­p_ag_cb
.
fd_sco_out_fe
);

691 ià(
¡©us
 < 0)

693 
	`APP_ERROR1
("şo£ faed: %d", 
¡©us
);

695 
­p_ag_cb
.
fd_sco_out_fe
 = -1;

698 ià(
¡©us
 =ğ0 && !
­p_ag_cb
.
¡İ_¶ay
 )

700 
	`¦“p
(5);

701 
	`APP_INFO0
("Finished„eading‡udio file...all data sento SCO");

703 
	}
}

718 
	$­p_ag_¶ay_fe
()

720 #ifdeà
PCM_ALSA


721 
	`APP_ERROR0
("Cannot…lay file when PCM_ALSA is defined");

724 
tAPP_THREAD
 
­p_ag_¶ay_fe_¡ruù
;

726 
­p_ag_cb
.
¡İ_¶ay
 = 
FALSE
;

727  
	`­p_ü—‹_th»ad
(
­p_ag_¶ay_fe_th»ad
, 0, 0, &
­p_ag_¶ay_fe_¡ruù
);

729 
	}
}

742 
	$­p_ag_¡İ_¶ay_fe
()

744 
­p_ag_cb
.
¡İ_¶ay
 = 
TRUE
;

746 
	}
}

760 
	$­p_ag_pickupÿÎ
(
UINT16
 
hªdË
)

762 
tBSA_AG_RES
 
b§_ag_»s
;

765 
b§_ag_»s
.
hndl
 = 
hªdË
;

766 
b§_ag_»s
.
»suÉ
 = 
BTA_AG_IN_CALL_CONN_RES
;

767 
b§_ag_»s
.
d©a
.
audio_hªdË
 = 
hªdË
;

769 
	`BSA_AgResuÉ
(&
b§_ag_»s
);

770 
­p_ag_cb
.
ÿÎ_aùive
 = 
TRUE
;

771 
	}
}

785 
	$­p_ag_hªgupÿÎ
(
UINT16
 
hªdË
)

787 
tBSA_AG_RES
 
b§_ag_»s
;

790 
b§_ag_»s
.
hndl
 = 
hªdË
;

791 
b§_ag_»s
.
»suÉ
 = 
BTA_AG_END_CALL_RES
;

792 
	`BSA_AgResuÉ
(&
b§_ag_»s
);

793 
­p_ag_cb
.
ÿÎ_aùive
 = 
FALSE
;

794 
	}
}

809 
	$­p_ag_sco_uc_cback
(
BT_HDR
 *
p_buf
)

811 
UINT8
 *
µ
 ;

812 
UINT16
 
pkt_Ën
 ;

813 #ifdeà
PCM_ALSA


814 
¢d_pcm_säames_t
 
®§_äames
;

815 
¢d_pcm_säames_t
 
®§_äames_ex³ùed
;

818 ià(
p_buf
 =ğ
NULL
)

823 
µ
 = (
UINT8
 *è(
p_buf
 + 1);

824 
pkt_Ën
 = 
p_buf
->
Ën
;

827 
	`­p_ag_wr™e_to_fe
(
µ
, 
pkt_Ën
);

829 #ifdeà
PCM_ALSA


832 
®§_äames_ex³ùed
 = 
pkt_Ën
 / 
APP_AG_CHANNEL_NB
;

833 
®§_äames_ex³ùed
 /= 2;

835 ià(
®§_¶ayback_İ’ed
 !ğ
FALSE
)

840 
®§_äames
 = 
	`¢d_pcm_wr™ei
(
®§_hªdË_¶ayback
, 
µ
, 
®§_äames_ex³ùed
);

841 ià(
®§_äames
 < 0)

843 
	`APP_DEBUG1
("¢d_pcm_»cov” %d", ()
®§_äames
);

844 
®§_äames
 = 
	`¢d_pcm_»cov”
(
®§_hªdË_¶ayback
,‡lsa_frames, 0);

846 ià(
®§_äames
 < 0)

848 
	`APP_ERROR1
("¢d_pcm_wr™e˜çed: %s", 
	`¢d_¡»¼Ü
(
®§_äames
));

850 ià(
®§_äames
 > 0 &&‡l§_äame < 
®§_äames_ex³ùed
)

852 
	`APP_ERROR1
("Short write (expected %d, wrote %d)",

853 ()
®§_äames_ex³ùed
, ()
®§_äames
);

857 ià(
®§_ÿ±u»_İ’ed
 !ğ
FALSE
)

862 
®§_äames
 = 
	`¢d_pcm_»adi
(
®§_hªdË_ÿ±u»
, 
­p_ag_cb
.
pcmbuf
, 
®§_äames_ex³ùed
);

863 ià(
®§_äames
 < 0)

865 
	`APP_ERROR1
("¢d_pcm_»ad˜»tuºs: %d", ()
®§_äames
);

867 ià((
®§_äames
 > 0) &&

868 (
®§_äames
 < 
®§_äames_ex³ùed
))

870 
	`APP_ERROR1
("ShÜˆ»ad (ex³ùed %i, wrÙ%i)", ()
®§_äames_ex³ùed
, ()
®§_äames
);

873 ià(
TRUE
 !ğ
	`UIPC_S’d
(
­p_ag_cb
.
uc_chªÃl
[0], 0,‡µ_ag_cb.
pcmbuf
, 
®§_äames
 * 2))

875 
	`APP_ERROR0
("UIPC_Send failed");

880 
	`GKI_ä“buf
(
p_buf
);

882 
	}
}

895 *
	$­p_ag_¡©us_2_¡r
(
tBSA_STATUS
 
¡©us
)

897 
¡©us
)

899 
BSA_SUCCESS
 :  "success";

900 
BSA_ERROR_SRV_AG_OFFSET
 :  "offset";

901 
BSA_ERROR_SRV_AG_FAIL_SDP
 :  "sdp failed";

902 
BSA_ERROR_SRV_AG_FAIL_RFCOMM
 :  "Open failed dueo RFCOMM";

903 
BSA_ERROR_SRV_AG_FAIL_RESOURCES
:  "bsa‡g out of„esources";

904 
BSA_ERROR_SRV_AG_BUSY
 :  "bsa server busy";

905 
BSA_ERROR_SRV_NYI
 :  "Not Yet Implemented Feature Error";

908 
	}
}

921 
	$­p_ag_cback
(
tBSA_AG_EVT
 
ev’t
, 
tBSA_AG_MSG
 *
p_d©a
)

923 
UINT16
 
hªdË
 = 0;

924 
UINT8
 
šdex
 = 0;

925 
tBSA_AG_RES
 
b§_ag_»s
;

927 ià(
p_d©a
 =ğ
NULL
)

929 
	`APP_ERROR0
("NULL data…ointer");

933 
hªdË
 = 
p_d©a
->
hdr
.
hndl
;

934 
šdex
 = 
	`­p_ag_g‘_šdex_by_hªdË
(
hªdË
);

936 
	`APP_DEBUG1
("ev’t:%d fÜ hªdË: %d, index: %d", 
ev’t
, 
hªdË
, 
šdex
);

937 
ev’t
)

939 
BSA_AG_OPEN_EVT
:

940 
	`APP_DEBUG1
("BSA_AG_OPEN_EVT: s=%d(%s)", 
p_d©a
->
İ’
.
¡©us
, 
	`­p_ag_¡©us_2_¡r
(p_data->open.status));

941 
	`APP_DEBUG1
("%02x:%02x:%02x:%02x:%02x:%02x",

942 
p_d©a
->
İ’
.
bd_addr
[0],…_data->open.bd_addr[1],…_data->open.bd_addr[2],

943 
p_d©a
->
İ’
.
bd_addr
[3],…_data->open.bd_addr[4],…_data->open.bd_addr[5]);

944 ià(
p_d©a
->
İ’
.
¡©us
 =ğ
BSA_SUCCESS
)

946 
­p_ag_cb
.
İ’ed
 = 
TRUE
;

950 
­p_ag_cb
.
İ’ed
 = 
FALSE
;

954 
BSA_AG_CONN_EVT
:

955 
	`APP_DEBUG1
("BSA_AG_CONN_EVT: %02x:%02x:%02x:%02x:%02x:%02x",

956 
p_d©a
->
cÚn
.
bd_addr
[0],…_data->conn.bd_addr[1],…_data->conn.bd_addr[2],

957 
p_d©a
->
cÚn
.
bd_addr
[3],…_data->conn.bd_addr[4],…_data->conn.bd_addr[5]);

958 #ià
BLUETOOTH_AG_SUPPORT


959 
	`­p_ag_İ’_audio
();

963 
BSA_AG_CLOSE_EVT
:

964 
	`APP_DEBUG1
("BSA_AG_CLOSE_EVT: s=%d(%s)", 
p_d©a
->
şo£
.
¡©us
, 
	`­p_ag_¡©us_2_¡r
(p_data->close.status));

965 
­p_ag_cb
.
İ’ed
 = 
FALSE
;

966 #ià
BLUETOOTH_AG_SUPPORT


967 
	`šg’ic_blu‘oÙh_ag_discÚÃù
();

971 
BSA_AG_AUDIO_OPEN_EVT
:

972 
	`APP_DEBUG1
("BSA_AG_AUDIO_OPEN_EVT: s=%d(%s)", 
p_d©a
->
hdr
.
¡©us
, 
	`­p_ag_¡©us_2_¡r
(p_data->hdr.status));

974 if(
šdex
 >ğ
APP_AG_MAX_NUM_CONN
)

977 ià(
­p_ag_cb
.
sco_rou‹
 =ğ
BSA_SCO_ROUTE_HCI
 &&

978 
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
 &&

979 !
­p_ag_cb
.
voiû_İ’ed
)

982 ià(
	`UIPC_O³n
(
­p_ag_cb
.
uc_chªÃl
[
šdex
], 
­p_ag_sco_uc_cback
è!ğ
TRUE
)

984 
	`APP_ERROR1
("UIPC_O³n(%dèçed", 
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

987 
­p_ag_cb
.
voiû_İ’ed
 = 
TRUE
;

988 
	`UIPC_Ioùl
(
­p_ag_cb
.
uc_chªÃl
[
šdex
],
UIPC_REG_CBACK
,(*è
­p_ag_sco_uc_cback
);

991 #ifdeà
PCM_ALSA


992 
	`­p_ag_İ’_®§_du¶ex
();

995 #ià
BLUETOOTH_AG_SUPPORT


996 
	`šg’ic_blu‘oÙh_ag_cÚÃù
();

1000 
BSA_AG_AUDIO_CLOSE_EVT
:

1001 
	`APP_DEBUG1
("BSA_AG_AUDIO_CLOSE_EVT: s=%d(%s)", 
p_d©a
->
hdr
.
¡©us
, 
	`­p_ag_¡©us_2_¡r
(p_data->hdr.status));

1003 if(
šdex
 >ğ
APP_AG_MAX_NUM_CONN
)

1006 if(
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
 &&

1007 
­p_ag_cb
.
voiû_İ’ed
)

1009 
	`UIPC_Clo£
(
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

1010 
­p_ag_cb
.
voiû_İ’ed
 = 
FALSE
;

1013 #ifdeà
PCM_ALSA


1014 
	`­p_ag_şo£_®§_du¶ex
();

1017 #ià
BLUETOOTH_AG_SUPPORT


1018 
	`­p_ag_şo£
();

1022 
BSA_AG_WBS_EVT
:

1023 
	`APP_DEBUG1
("BSA_AG_WBS_EVT: s=%d(%s)", 
p_d©a
->
hdr
.
¡©us
, 
	`­p_ag_¡©us_2_¡r
(p_data->hdr.status));

1026 
BSA_AG_SPK_EVT
:

1027 
	`APP_DEBUG1
("BSA_AG_SPK_EVT %d", 
p_d©a
->
v®
.
num
);

1029 
BSA_AG_MIC_EVT
:

1030 
	`APP_DEBUG1
("BSA_AG_MIC_EVT %d", 
p_d©a
->
v®
.
num
);

1033 
BSA_AG_AT_CKPD_EVT
:

1034 
	`APP_DEBUG0
("BSA_AG_MIC_EVT");

1037 
BSA_AG_AT_A_EVT
:

1038 
	`APP_DEBUG0
("BSA_AG_AT_A_EVT");

1040 
	`­p_ag_pickupÿÎ
(
hªdË
);

1043 
BSA_AG_AT_D_EVT
:

1044 
	`APP_DEBUG1
("BSA_AG_AT_D_EVT: %s", 
p_d©a
->
v®
.
¡r
);

1047 
BSA_AG_AT_CHLD_EVT
:

1048 
	`APP_DEBUG0
("BSA_AG_AT_CHLD_EVT");

1051 
BSA_AG_AT_CHUP_EVT
:

1052 
	`APP_DEBUG0
("BSA_AG_AT_CHUP_EVT");

1054 
	`­p_ag_hªgupÿÎ
(
hªdË
);

1057 
BSA_AG_AT_CIND_EVT
:

1058 
	`APP_DEBUG0
("BSA_AG_AT_CIND_EVT");

1060 
b§_ag_»s
.
hndl
 = 
hªdË
;

1061 
b§_ag_»s
.
»suÉ
 = 
BTA_AG_CIND_RES
;

1062 
	`¡ºıy
(
b§_ag_»s
.
d©a
.
¡r
,
­p_ag_cb
.
ÿÎ_aùive
?"1":"0",

1063 (
b§_ag_»s
.
d©a
.
¡r
)-1);

1064 
	`¡ºÿt
(
b§_ag_»s
.
d©a
.
¡r
, ",0,0,6,0,5,0,7",

1065 ((
b§_ag_»s
.
d©a
.
¡r
)-1è- 
	`¡¾’
(bsa_ag_res.data.str));

1066 
b§_ag_»s
.
d©a
.
¡r
[(bsa_ag_res.data.str)-1] = 0;

1067 
	`BSA_AgResuÉ
(&
b§_ag_»s
);

1069 
BSA_AG_AT_VTS_EVT
 :

1071 
	`APP_DEBUG1
("BSA_AG_AT_VTS_EVT: %s", 
p_d©a
->
v®
.
¡r
);

1073 
BSA_AG_AT_BINP_EVT
 :

1075 
	`APP_DEBUG0
("BSA_AG_AT_BINP_EVT");

1077 
BSA_AG_AT_BLDN_EVT
 :

1079 
	`APP_DEBUG0
("BSA_AG_AT_BLDN_EVT");

1081 
BSA_AG_AT_BVRA_EVT
 :

1083 
	`APP_DEBUG1
("BSA_AG_AT_BVRA_EVT %d", 
p_d©a
->
v®
.
num
);

1085 
BSA_AG_AT_NREC_EVT
 :

1087 
	`APP_DEBUG0
("BSA_AG_AT_NREC_EVT");

1089 
BSA_AG_AT_CNUM_EVT
 :

1091 
	`APP_DEBUG0
("BSA_AG_AT_CNUM_EVT");

1093 
BSA_AG_AT_BTRH_EVT
 :

1095 
	`APP_DEBUG0
("BSA_AG_AT_BTRH_EVT");

1097 
BSA_AG_AT_CLCC_EVT
:

1098 
	`APP_DEBUG0
("BSA_AG_AT_CLCC_EVT");

1100 
b§_ag_»s
.
hndl
 = 
hªdË
;

1101 
b§_ag_»s
.
»suÉ
 = 
BTA_AG_CLCC_RES
;

1102 ià(
­p_ag_cb
.
ÿÎ_aùive
)

1105 
	`¡ºıy
(
b§_ag_»s
.
d©a
.
¡r
, "1,1,0,0, 0",(bsa_ag_res.data.str)-1);

1106 
b§_ag_»s
.
d©a
.
¡r
[(bsa_ag_res.data.str)-1] = 0;

1108 
b§_ag_»s
.
d©a
.
ok_æag
 = 
BTA_AG_OK_DONE
;

1109 
	`BSA_AgResuÉ
(&
b§_ag_»s
);

1112 
BSA_AG_AT_COPS_EVT
:

1113 
	`APP_DEBUG0
("BSA_AG_AT_COPS_EVT");

1115 
b§_ag_»s
.
hndl
 = 
hªdË
;

1116 
b§_ag_»s
.
»suÉ
 = 
BTA_AG_COPS_RES
;

1117 
	`¡ºıy
(
b§_ag_»s
.
d©a
.
¡r
, "0, 0, \"BSA Net\"",(bsa_ag_res.data.str)-1);

1118 
b§_ag_»s
.
d©a
.
¡r
[(bsa_ag_res.data.str)-1] = 0;

1119 
b§_ag_»s
.
d©a
.
ok_æag
 = 
BTA_AG_OK_DONE
;

1120 
	`BSA_AgResuÉ
(&
b§_ag_»s
);

1123 
BSA_AG_AT_UNAT_EVT
 :

1125 
	`APP_DEBUG0
("BSA_AG_AT_UNAT_EVT");

1127 
BSA_AG_AT_CBC_EVT
 :

1129 
	`APP_DEBUG0
("BSA_AG_AT_CBC_EVT");

1131 
BSA_AG_AT_BAC_EVT
 :

1133 
	`APP_DEBUG0
("BSA_AG_AT_BAC_EVT");

1135 
BSA_AG_AT_BCS_EVT
 :

1137 
	`APP_DEBUG0
("BSA_AG_AT_BCS_EVT");

1141 
	`APP_ERROR1
("­p_ag_cback unknowÀev’t:%d", 
ev’t
);

1145 if(
s_pC®lback
)

1146 
	`s_pC®lback
(
ev’t
, 
p_d©a
);

1147 
	}
}

1149 #ifdeà
PCM_ALSA


1161 
	$­p_ag_İ’_®§_du¶ex
()

1163 
¡©us
;

1166 ià(
®§_hªdË_¶ayback
 !ğ
NULL
)

1168 
	`¢d_pcm_şo£
(
®§_hªdË_¶ayback
);

1169 
®§_hªdË_¶ayback
 = 
NULL
;

1172 
	`APP_DEBUG0
("Opening Alsa/Asound‡udio driver Playback");

1174 
¡©us
 = 
	`¢d_pcm_İ’
(&
®§_hªdË_¶ayback
, 
®§_deviû
,

1175 
SND_PCM_STREAM_PLAYBACK
, 
SND_PCM_NONBLOCK
);

1176 ià(
¡©us
 < 0)

1178 
	`APP_ERROR1
("¢d_pcm_İ’ faed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

1179  
¡©us
;

1184 
¡©us
 = 
	`¢d_pcm_£t_·¿ms
(
®§_hªdË_¶ayback
,

1185 
SND_PCM_FORMAT_S16_LE
,

1186 
SND_PCM_ACCESS_RW_INTERLEAVED
,

1187 
APP_AG_CHANNEL_NB
,

1188 
APP_AG_SAMPLE_RATE
,

1191 ià(
¡©us
 < 0)

1193 
	`APP_ERROR1
("¢d_pcm_£t_·¿m çed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

1194  
¡©us
;

1197 
®§_¶ayback_İ’ed
 = 
TRUE
;

1200 ià(
®§_hªdË_ÿ±u»
 !ğ
NULL
)

1202 
	`¢d_pcm_şo£
(
®§_hªdË_ÿ±u»
);

1203 
®§_hªdË_ÿ±u»
 = 
NULL
;

1205 
	`APP_DEBUG0
("Opening Alsa/Asound‡udio driver Capture");

1207 
¡©us
 = 
	`¢d_pcm_İ’
(&
®§_hªdË_ÿ±u»
, 
®§_deviû
,

1208 
SND_PCM_STREAM_CAPTURE
, 
SND_PCM_NONBLOCK
);

1209 ià(
¡©us
 < 0)

1211 
	`APP_ERROR1
("¢d_pcm_İ’ faed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

1212  
¡©us
;

1217 
¡©us
 = 
	`¢d_pcm_£t_·¿ms
(
®§_hªdË_ÿ±u»
,

1218 
SND_PCM_FORMAT_S16_LE
,

1219 
SND_PCM_ACCESS_RW_INTERLEAVED
,

1220 
APP_AG_CHANNEL_NB
,

1221 
APP_AG_SAMPLE_RATE
,

1224 ià(
¡©us
 < 0)

1226 
	`APP_ERROR1
("¢d_pcm_£t_·¿m çed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

1227  
¡©us
;

1230 
®§_ÿ±u»_İ’ed
 = 
TRUE
;

1233 
	}
}

1246 
	$­p_ag_şo£_®§_du¶ex
()

1248 ià(
®§_hªdË_¶ayback
 !ğ
NULL
)

1250 
	`¢d_pcm_şo£
(
®§_hªdË_¶ayback
);

1251 
®§_hªdË_¶ayback
 = 
NULL
;

1252 
®§_¶ayback_İ’ed
 = 
FALSE
;

1254 ià(
®§_hªdË_ÿ±u»
 !ğ
NULL
)

1256 
	`¢d_pcm_şo£
(
®§_hªdË_ÿ±u»
);

1257 
®§_hªdË_ÿ±u»
 = 
NULL
;

1258 
®§_ÿ±u»_İ’ed
 = 
FALSE
;

1261 
	}
}

1276 
tBSA_STATUS
 
	$­p_ag_¡¬t
(
UINT8
 
sco_rou‹
)

1278 
tBSA_STATUS
 
¡©us
;

1280 
¡©us
 = 
	`­p_ag_’abË
();

1281 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1283  
¡©us
;

1286 
¡©us
 = 
	`­p_ag_»gi¡”
(
sco_rou‹
);

1288  
¡©us
;

1289 
	}
}

1302 
tBSA_STATUS
 
	$­p_ag_¡İ
()

1304 
tBSA_STATUS
 
¡©us
 = 
BSA_SUCCESS
;

1305 
tBSA_AG_DISABLE
 
di§bË_·¿m
;

1306 
tBSA_AG_DEREGISTER
 
d”egi¡”_·¿m
;

1308 
	`APP_DEBUG0
("Deregister");

1311 
	`BSA_AgD”egi¡”In™
(&
d”egi¡”_·¿m
);

1312 
d”egi¡”_·¿m
.
hndl
 = 
­p_ag_cb
.hndl[0];

1313 
¡©us
 = 
	`BSA_AgD”egi¡”
(&
d”egi¡”_·¿m
);

1315 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1317 
	`APP_ERROR1
("BSA_AgD”egi¡” faed: %d(%s)", 
¡©us
, 
	`­p_ag_¡©us_2_¡r
(status));

1318  
¡©us
;

1322 
	`BSA_AgDi§bËIn™
(&
di§bË_·¿m
);

1323 
¡©us
 = 
	`BSA_AgDi§bË
(&
di§bË_·¿m
);

1324 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1326 
	`APP_ERROR1
("BSA_AgDi§bË faed: %d(%s)", 
¡©us
, 
	`­p_ag_¡©us_2_¡r
(status));

1327  
¡©us
;

1329  
¡©us
;

1330 
	}
}

1343 
	$­p_ag_š™
()

1345 
šdex
;

1347 
	`mem£t
(&
­p_ag_cb
, 0, (app_ag_cb));

1350 
­p_ag_cb
.
fd_sco_š_fe
 = -1;

1351 
­p_ag_cb
.
fd_sco_out_fe
 = -1;

1353 
šdex
=0; index < 
APP_AG_MAX_NUM_CONN
; index++)

1355 
­p_ag_cb
.
uc_chªÃl
[
šdex
] = 
UIPC_CH_ID_BAD
;

1356 
­p_ag_cb
.
hndl
[
šdex
] = 
BSA_AG_BAD_HANDLE
;

1359 
	}
}

1370 
	$­p_ag_’d
()

1372 
šdex
;

1375 
šdex
 = 0; index < 
APP_AG_MAX_NUM_CONN
; index++)

1377 ià(
­p_ag_cb
.
uc_chªÃl
[
šdex
] !ğ
UIPC_CH_ID_BAD
)

1379 
	`APP_DEBUG0
("Closing UIPC Channel");

1380 
	`UIPC_Clo£
(
­p_ag_cb
.
uc_chªÃl
[
šdex
]);

1381 
­p_ag_cb
.
uc_chªÃl
[
šdex
]ğ
UIPC_CH_ID_BAD
;

1386 
	`­p_ag_¡İ
();

1387 
	}
}

1397 
	$­p_ag_£t_cback
(
tBSA_AG_CBACK
 
pcb
)

1400 
s_pC®lback
 = 
pcb
;

1401 
	}
}

1404 #ià
BLUETOOTH_AG_SUPPORT


1405 
	$šg’ic_blu‘oÙh_ag_cÚÃù
()

1407 
fd
;

1408 
fd
 = 
	`İ’
("/tmp/blu‘oÙh_ag_cÚÃù", 
O_WRONLY
| 
O_CREAT
);

1409 
	`şo£
(
fd
);

1411 
	}
}

1413 
	$šg’ic_blu‘oÙh_ag_discÚÃù
()

1415 
	`uÆšk
("/tmp/bluetooth_ag_connect");

1416 
	}
}

	@source/app_av.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~<fú.h
>

19 
	~<uni¡d.h
>

21 
	~<”ºo.h
>

23 
	~"b§_­i.h
"

25 
	~"gki_št.h
"

26 
	~"uc.h
"

28 
	~"b§_Œaû.h
"

29 
	~"­p_av.h
"

30 #ifdeà
APP_AV_BCST_INCLUDED


31 
	~"­p_av_bc¡.h
"

33 
	~"­p_xml_·¿m.h
"

34 
	~"­p_disc.h
"

35 
	~"­p_uts.h
"

36 
	~"­p_wav.h
"

37 
	~"­p_¶ayli¡.h
"

38 
	~"­p_mu‹x.h
"

39 
	~"­p_th»ad.h
"

40 
	~"­p_xml_uts.h
"

41 
	~"­p_dm.h
"

44 
	#CONFIG_REMOTE_IS_AUDIO_SPEAKER


	)

47 #ifdeà
USE_INGENIC_AUDIO_SOCKET


48 
	~<sys/sock‘.h
>

49 
	~<sys/un.h
>

50 
	#A2DP_SOURCE_DOMAIN
 "/v¬/run/a2dp_sourû_hw_sock‘"

	)

51 
	gmIng’icA2dpSock‘Fd
 = -1;

52 
šg’ic_a2dp_cÚÃù
();

53 
šg’ic_a2dp_discÚÃù
();

54 
šg’ic_a2dp_İ’
();

55 
šg’ic_a2dp_şo£
();

61 vŞ©
	ggavS¹
 = 0;

62 
BD_ADDR
 
	ggavBdaddr
;

64 #iâdeà
APP_AV_FEAT_MASK


66 
	#APP_AV_FEAT_MASK
 (
BSA_AV_FEAT_RCTG
 | 
BSA_AV_FEAT_RCCT
 | 
BSA_AV_FEAT_VENDOR
 | 
BSA_AV_FEAT_METADATA
 | 
BSA_AV_FEAT_BROWSE
)

	)

69 #iâdeà
APP_AV_USE_RC


70 
	#APP_AV_USE_RC
 
FALSE


72 

	)

73 #iâdeà
BSA_AV_DUMP_TX_DATA


74 
	#BSA_AV_DUMP_TX_DATA
 
FALSE


	)

78 
	#APP_AV_MAX_CONNECTIONS
 2

	)

80 
	#APP_AV_MAX_AUDIO_BUF
 256

	)

82 
	#APP_AV_REMOTE_DEVICES_XML_FILE
 "./bt_deviûs.xml"

	)

84 
	#APP_AV_SOUND_FILE
 "./‹¡.wav"

	)

87 
	#APP_AV_PERIOD_MIN
 (
BSA_AV_MIN_SYNCHRONOUS_LATENCY
*1000è

	)

88 
	#APP_AV_PERIOD_MAX
 (
BSA_AV_MAX_SYNCHRONOUS_LATENCY
*1000è

	)

90 
	#APP_AV_LENGTH_MIN
 100

	)

91 
	#APP_AV_LENGTH_MAX
 (8*1024è

	)

94 
	#APP_AV_MAX_AUDIO_BUF_MAX
 10000

	)

97 #iâdeà
APP_AV_COMPENSATION_HIGH_WM


98 
	#APP_AV_COMPENSATION_HIGH_WM
 1.2

	)

101 #iâdeà
APP_AV_COMPENSATION_LOW_WM


102 
	#APP_AV_COMPENSATION_LOW_WM
 0.8

	)

105 cÚ¡ 
	gsšwaves
[2][64] = {{

125 cÚ¡ 
tBSA_AV_CODEC_INFO
 
	g­tx_ÿps
 =

127 
BSA_AV_CODEC_APTX
,

143 cÚ¡ 
tBSA_AV_CODEC_INFO
 
	g£c_ÿps
 =

145 
BSA_AV_CODEC_SEC
,

163 
	#APP_AV_PLAYTYPE_TONE
 0

	)

164 
	#APP_AV_PLAYTYPE_FILE
 1

	)

165 
	#APP_AV_PLAYTYPE_MIC
 2

	)

166 
	#APP_AV_PLAYTYPE_TEST
 3

	)

167 
	#APP_AV_PLAYTYPE_AVK
 4

	)

170 
	#BSA_AV_PLAYER_ID_INVALID
 0

	)

171 
	#BSA_AV_PLAYER_ID_FILES
 1

	)

172 
	#BSA_AV_PLAYER_ID_MPLAYER
 2

	)

175 
	#BSA_AV_NUM_MPLAYERS
 2

176 

	)

177 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”1_fe
 =

180 
BSA_AV_PLAYER_ID_FILES
,

182 (
AVRC_MJ_TYPE_AUDIO
|
AVRC_MJ_TYPE_VIDEO
),

184 
AVRC_SUB_TYPE_NONE
,

187 
AVRC_PLAYSTATE_STOPPED
,

215 
AVRC_CHARSET_ID_UTF8
,

217 (
UINT8
 *)"File Player"

221 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”2_medŸ_¶ay”
 =

224 
BSA_AV_PLAYER_ID_MPLAYER
,

226 
AVRC_MJ_TYPE_AUDIO
,

228 
AVRC_SUB_TYPE_NONE
,

231 
AVRC_PLAYSTATE_STOPPED
,

259 
AVRC_CHARSET_ID_UTF8
,

261 (
UINT8
 *)"Media Player"

266 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”3_fm
 =

269 
BSA_AV_PLAYER_ID_FM
,

271 (
AVRC_MJ_TYPE_BC_AUDIO
),

273 
AVRC_SUB_TYPE_NONE
,

276 
AVRC_PLAYSTATE_STOPPED
,

304 
AVRC_CHARSET_ID_UTF8
,

306 (
UINT8
 *)"FM Radio"

312 
tBSA_ITEM_PLAYER
 * 
	gb§_av_¶ay”s
 [] =

315 &
b§_av_¶ay”1_fe
,

317 &
b§_av_¶ay”2_medŸ_¶ay”


326 
tBSA_UID
 
	muid
;

327 
UINT8
 
	mty³
;

328 
tBSA_FULL_NAME
 
	mÇme
;

329 
UINT8
 
	m©Œ_couÁ
;

330 
tBSA_ATTR_ENTRY
 
	mp_©Œ_li¡
[7];

331 } 
	ttBSA_APP_ITEM_MEDIA
;

335 
tBSA_APP_ITEM_MEDIA
 
	gsÚg1
 =

337 . 
uid
 = { 0x01 },

338 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

339 .
	gÇme
 =

341 
AVRC_CHARSET_ID_UTF8
,

343 (
UINT8
 *)"Beat It ",

345 .
	g©Œ_couÁ
 = 7,

347 .
	gp_©Œ_li¡
[0] =

349 
AVRC_MEDIA_ATTR_ID_TITLE
,

351 
AVRC_CHARSET_ID_UTF8
,

353 (
UINT8
 *)"Beat It ",

357 .
	gp_©Œ_li¡
[1] =

359 
AVRC_MEDIA_ATTR_ID_ARTIST
,

361 
AVRC_CHARSET_ID_UTF8
,

363 (
UINT8
 *)"Michael Jackson "

367 .
	gp_©Œ_li¡
[2] =

369 
AVRC_MEDIA_ATTR_ID_ALBUM
,

371 
AVRC_CHARSET_ID_UTF8
,

373 (
UINT8
 *)"Thriller"

377 .
	gp_©Œ_li¡
[3] =

379 
AVRC_MEDIA_ATTR_ID_GENRE
,

381 
AVRC_CHARSET_ID_UTF8
,

383 (
UINT8
 *)"SoftRock"

387 .
	gp_©Œ_li¡
[4] =

389 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

391 
AVRC_CHARSET_ID_UTF8
,

393 (
UINT8
 *)"3 "

397 .
	gp_©Œ_li¡
[5] =

399 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

401 
AVRC_CHARSET_ID_UTF8
,

403 (
UINT8
 *)"1 "

407 .
	gp_©Œ_li¡
[6] =

409 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

411 
AVRC_CHARSET_ID_UTF8
,

413 (
UINT8
 *)"269000 "

420 
tBSA_APP_ITEM_MEDIA
 
	gsÚg2
 =

422 .
uid
 = { 0x02 },

423 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

424 .
	gÇme
 =

426 
AVRC_CHARSET_ID_UTF8
,

428 (
UINT8
 *)"Happy Nation ",

430 .
	g©Œ_couÁ
 = 7,

432 .
	gp_©Œ_li¡
[0] =

434 
AVRC_MEDIA_ATTR_ID_TITLE
,

436 
AVRC_CHARSET_ID_UTF8
,

438 (
UINT8
 *)"Happy Nation "

442 .
	gp_©Œ_li¡
[1] =

444 
AVRC_MEDIA_ATTR_ID_ARTIST
,

446 
AVRC_CHARSET_ID_UTF8
,

448 (
UINT8
 *)"Jonas, Jenny "

453 .
	gp_©Œ_li¡
[2] =

455 
AVRC_MEDIA_ATTR_ID_ALBUM
,

457 
AVRC_CHARSET_ID_UTF8
,

459 (
UINT8
 *)"Ace of Base "

463 .
	gp_©Œ_li¡
[3] =

465 
AVRC_MEDIA_ATTR_ID_GENRE
,

467 
AVRC_CHARSET_ID_UTF8
,

469 (
UINT8
 *)"Pop "

473 .
	gp_©Œ_li¡
[4] =

475 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

477 
AVRC_CHARSET_ID_UTF8
,

479 (
UINT8
 *)"2 "

483 .
	gp_©Œ_li¡
[5] =

485 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

487 
AVRC_CHARSET_ID_UTF8
,

489 (
UINT8
 *)"3 "

493 .
	gp_©Œ_li¡
[6] =

495 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

497 
AVRC_CHARSET_ID_UTF8
,

499 (
UINT8
 *)"255000 "

507 
tBSA_APP_ITEM_MEDIA
 
	gsÚg3
 =

509 . 
uid
 = { 0x03 },

510 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

511 .
	gÇme
 =

513 
AVRC_CHARSET_ID_UTF8
,

515 (
UINT8
 *)"River of Dreams ",

517 .
	g©Œ_couÁ
 = 7,

518 .
	gp_©Œ_li¡
[0] =

520 
AVRC_MEDIA_ATTR_ID_TITLE
,

522 
AVRC_CHARSET_ID_UTF8
,

524 (
UINT8
 *)"River of Dreams "

528 .
	gp_©Œ_li¡
[1] =

530 
AVRC_MEDIA_ATTR_ID_ARTIST
,

532 
AVRC_CHARSET_ID_UTF8
,

534 (
UINT8
 *)"Billy Joel "

539 .
	gp_©Œ_li¡
[2] =

541 
AVRC_MEDIA_ATTR_ID_ALBUM
,

543 
AVRC_CHARSET_ID_UTF8
,

545 (
UINT8
 *)"River of Dreams "

549 .
	gp_©Œ_li¡
[3] =

551 
AVRC_MEDIA_ATTR_ID_GENRE
,

553 
AVRC_CHARSET_ID_UTF8
,

555 (
UINT8
 *)"Soul"

559 .
	gp_©Œ_li¡
[4] =

561 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

563 
AVRC_CHARSET_ID_UTF8
,

565 (
UINT8
 *)"3 "

569 .
	gp_©Œ_li¡
[5] =

571 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

573 
AVRC_CHARSET_ID_UTF8
,

575 (
UINT8
 *)"3 "

579 .
	gp_©Œ_li¡
[6] =

581 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

583 
AVRC_CHARSET_ID_UTF8
,

585 (
UINT8
 *)"211000 "

590 
	#BSA_AV_NUMSONGS
 3

	)

592 
tBSA_APP_ITEM_MEDIA
 * 
	gb§_av_sÚgs
[] =

594 &
sÚg1
,

595 &
sÚg2
,

596 &
sÚg3


599 
	#BSA_AV_NUMSONGS
 0

	)

601 
tBSA_APP_ITEM_MEDIA
 * 
	gb§_av_sÚgs
[] =

605 
UINT16
 
	ttBSA_AV_EVT_MASK
;

607 
tBSA_AV_EVT_MASK
 
	mevt_mask
;

608 
UINT8
 
	mÏb–
[
AVRC_NUM_NOTIF_EVENTS
];

609 } 
	ttBSA_AV_REG_EVT
;

611 
	#BSA_ATTR_STRING_LEN
 15

	)

614 
UINT8
 
	mv®1
[
BSA_ATTR_STRING_LEN
];

615 
UINT8
 
	mv®2
[
BSA_ATTR_STRING_LEN
];

616 } 
	ttBSA_AV_META_ATTRIB_SETTINGS
;

619 
UINT8
 
	m©Œib_id
;

620 
UINT8
 
	mcu¼_v®ue
;

621 
BOOLEAN
 
	mv®ue_upd©ed
;

622 
UINT8
 
	m©Œib_¡r
[
BSA_ATTR_STRING_LEN
];

623 
tBSA_AV_META_ATTRIB_SETTINGS
 
	m©Œ_£‰šgs
[2];

624 } 
	ttBSA_AV_META_ATTRIB
;

627 
tBSA_AV_META_ATTRIB
 
	mequ®iz”
;

628 
tBSA_AV_META_ATTRIB
 
	m»³©
;

629 
tBSA_AV_META_ATTRIB
 
	mshufæe
;

630 } 
	ttBSA_AV_PAS_INFO
;

634 
UINT32
 
	msÚg_Ëngth
;

635 
UINT32
 
	msÚg_pos
;

636 
UINT8
 
	m¶ay_¡©us
;

637 } 
	ttBSA_AV_META_PLAYSTAT
;

641 
UINT8
 
	mev’t_id
;

642 
UINT32
 
	m¶ayback_š‹rv®
;

643 
UINT32
 
	m¶ayback_pos
;

644 
UINT8
 
	mb©_¡©
;

645 
UINT8
 
	msys_¡©
;

646 } 
	ttBSA_AV_STAT_INFO
;

650 
tBSA_AV_REG_EVT
 
	m»gi¡”ed_ev’ts
;

651 
UINT16
 
	mch¬£t_id
;

652 
UINT8
 
	mmax_©Œib_num
;

653 
tBSA_AV_PAS_INFO
 
	m·s_šfo
;

654 
tBSA_AV_META_PLAYSTAT
 
	m¶ay_¡©us
;

655 
tBSA_AV_STAT_INFO
 
	mnÙif_šfo
;

656 
UINT8
 
	mŒack_num
;

657 
UINT16
 
	maddr_¶ay”_id
;

658 
UINT16
 
	mbrow£d_¶ay”_id
;

659 
UINT16
 
	mcur_uid_couÁ”
;

660 } 
	ttBSA_AV_METADATA
;

665 
UINT8
 
	mcur_¶ay
;

666 
UINT8
 
	m¶ay_couÁ
;

667 
tBSA_AV_METADATA
 
	mm‘a_šfo
;

668 } 
	ttBSA_AV_CB
;

670 
tBSA_AV_CB
 *
	gp_b§_av_cb
 = 
NULL
;

673 
	#AVRCP_NOW_PLAYING_FOLDER_ID_FIRST_BYTE
 0x02

	)

674 
	#AVRCP_NOW_PLAYING_FOLDER_ID
 0x02000000

	)

675 
	#AVRCP_PLAY_LISTS_FOLDER_ID
 0x00000000

	)

676 
	#AVRCP_NOW_PLAYING_FILE_ID
 0x00000000

	)

677 
	#AVRCP_NO_NOW_PLAYING_FOLDER_ID
 0xFFFFFFFF

	)

678 
	#AVRCP_NO_NOW_PLAYING_FILE_ID
 0xFFFFFFFF

	)

684 
tAPP_MUTEX
 
	g­p_¡»am_tx_mu‹x
;

685 
tAPP_THREAD
 
	g­p_uc_tx_th»ad_¡ruù
;

691 
tUIPC_CH_ID
 
	m¡»am_uc_chªÃl
;

693 
tAPP_AV_CONNECTION
 
	mcÚÃùiÚs
[
APP_AV_MAX_CONNECTIONS
];

695 
tBSA_STATUS
 
	mÏ¡_¡¬t_¡©us
;

697 
tBSA_AV_MEDIA_FEEDINGS
 
	mmedŸ_ãedšg
;

699 vŞ©
UINT8
 
	m¶ay_¡©e
;

701 
UINT8
 
	m¶ay_ty³
;

703 
BOOLEAN
 
	m¶ay_li¡
;

706 **
	msoundfe_li¡
;

707 
	msoundfe_li¡_size
;

710 
	mfe_šdex
;

711 
	mfe_Çme
[1000];

714 
UINT8
 
	msšus_šdex
;

715 
UINT8
 
	msšus_ty³
;

718 
tAPP_AV_UIPC
 
	muc_cfg
;

721 
	maudio_buf
[
APP_AV_MAX_AUDIO_BUF_MAX
];

724 
UINT16
 
	mtÚe_§m¶e_äeq
;

726 
UINT32
 
	m£c_äame_size
;

728 
UINT8
 
	mÏb–
;

731 
tBSA_AV_CP_ID
 
	mı_id
;

732 
UINT8
 
	mı_scms_æag
;

735 
	m‹¡_£c_§mpäeq_šdex
;

736 } 
	g­p_av_cb
;

739 
tBSA_AV_META_PLAYSTAT
 
	g¶ay¡
 =

743 
BSA_AVRC_PLAYSTATE_STOPPED
,

746 
tAvC®lback
 *
	gs_pC®lback
 = 
NULL
;

748 
tAPP_THREAD
 
	gt_­p_rc_th»ad
;

749 
	gs_commªd
 = 0;

750 
­p_avk_rc_commªd_th»ad
();

755 *
­p_av_di¥Ïy_v’dÜ_commªd
(
UINT8
 
commªd
);

756 
­p_av_uc_»cÚfig
();

757 
­p_av_d–ay_¡¬t
(
tAPP_AV_DELAY
 *
p_d–ay
);

758 
­p_av_¡İ_cu¼’t
();

759 
­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
UINT8
 
ev’t_id
, 
tBSA_AV_META_RSP_CMD
 *
b§_av_m‘a_r¥_cmd
);

760 
­p_av_š™_m‘a_d©a
();

761 (*
p_­p_av_nÙify_cb
)(
¡©e
)=
NULL
;

771 *
	$­p_av_di¥Ïy_v’dÜ_commªd
(
UINT8
 
commªd
)

773 
commªd
)

775 
BSA_AV_RC_VD_GET_CAPABILITIES
:

777 
BSA_AV_RC_VD_LIST_PLAYER_APP_ATTR
:

779 
BSA_AV_RC_VD_LIST_PLAYER_APP_VALUES
:

781 
BSA_AV_RC_VD_GET_CUR_PLAYER_APP_VALUE
:

783 
BSA_AV_RC_VD_SET_PLAYER_APP_VALUE
:

785 
BSA_AV_RC_VD_GET_PLAYER_APP_ATTR_TEXT
:

787 
BSA_AV_RC_VD_GET_PLAYER_APP_VALUE_TEXT
:

789 
BSA_AV_RC_VD_INFORM_DISPLAY_CHARSET
:

791 
BSA_AV_RC_VD_INFORM_BATTERY_STAT_OF_CT
:

793 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
:

795 
BSA_AV_RC_VD_GET_PLAY_STATUS
:

797 
BSA_AV_RC_VD_REGISTER_NOTIFICATION
:

799 
BSA_AV_RC_VD_ABORT_CONTINUATION_RSP
:

801 
BSA_AV_RC_VD_SET_ABSOLUTE_VOLUME
:

803 
BSA_AV_RC_VD_SET_ADDRESSED_PLAYER
:

805 
BSA_AV_RC_VD_SET_BROWSED_PLAYER
:

807 
BSA_AV_RC_VD_GET_FOLDER_ITEMS
:

809 
BSA_AV_RC_VD_CHANGE_PATH
:

811 
BSA_AV_RC_VD_GET_ITEM_ATTRIBUTES
:

813 
BSA_AV_RC_VD_PLAY_ITEM
:

815 
BSA_AV_RC_VD_SEARCH
:

817 
BSA_AV_RC_VD_ADD_TO_NOW_PLAYING
:

824 
	}
}

836 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_hªdË
(
tBSA_AV_HNDL
 
hªdË
)

838 
šdex
;

839 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

841 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
 == handle)

842  &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

844  
NULL
;

845 
	}
}

856 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
BD_ADDR
 
bd_addr
)

858 
šdex
;

859 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

861 ià(
	`bdcmp
(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
, bd_addr) == 0)

862  &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

864  
NULL
;

865 
	}
}

876 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_¡©us
(
BOOLEAN
 
»gi¡”ed
, BOOLEAN 
İ’
)

878 
út
;

879 
út
 = 0; cÁ < 
APP_AV_MAX_CONNECTIONS
; cnt++)

881 ià((
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_»gi¡”ed
 =ğ
»gi¡”ed
) &&

882 (
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_İ’
 =ğ
İ’
))

883  &
­p_av_cb
.
cÚÃùiÚs
[
út
];

885  
NULL
;

886 
	}
}

897 
	$­p_av_di¥Ïy_cÚÃùiÚs
()

899 
šdex
;

900 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

902 
	`APP_INFO1
(" CÚÃùiÚ index %d:", 
šdex
);

903 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_»gi¡”ed
)

905 
	`APP_INFO1
(" Regi¡”ed -> hªdË = %d", 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
);

906 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_İ’
)

908 
	`APP_INFO1
(" Connectedo %02X:%02X:%02X:%02X:%02X:%02X",

909 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[0],‡pp_av_cb.connections[index].bd_addr[1],

910 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[2],‡pp_av_cb.connections[index].bd_addr[3],

911 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[4],‡pp_av_cb.connections[index].bd_addr[5]);

912 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_rc
)

914 
	`APP_INFO1
(" RC -> hªdË %d", 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
rc_hªdË
);

918 
	`APP_INFO0
(" does‚ot have RC");

923 
	`APP_INFO0
(" Not connected");

928 
	`APP_INFO0
(" Not„egistered");

932 
	}
}

933 
	$­p_av_lškdn_nÙify
() {

934 if(
p_­p_av_nÙify_cb
)

935 
	`p_­p_av_nÙify_cb
(0);

936 
	}
}

947 
	$­p_av_cback
(
tBSA_AV_EVT
 
ev’t
, 
tBSA_AV_MSG
 *
p_d©a
)

949 
¡©us
, 
šdex
;

950 
UINT8
 
commªd
;

951 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

954 
ev’t
){

955 
BSA_AV_OPEN_EVT
:

956 
	`APP_INFO1
("BSA_AV_OPEN_EVT status:%d handle:%d cp:%d‡ptx:%d sec:%d",

957 
p_d©a
->
İ’
.
¡©us
,…_d©a->İ’.
hªdË
,

958 
p_d©a
->
İ’
.
ı_suµÜ‹d
,

959 
p_d©a
->
İ’
.
­tx_suµÜ‹d
,

960 
p_d©a
->
İ’
.
£c_suµÜ‹d
);

961 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
İ’
.
hªdË
);

962 ià(
cÚÃùiÚ
 =ğ
NULL
){

963 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
İ’
.
hªdË
);

965 ià(
p_d©a
->
İ’
.
¡©us
 =ğ
BSA_SUCCESS
){

966 
s1
,
s2
=-1;

969 
	`bdıy
(
cÚÃùiÚ
->
bd_addr
, 
p_d©a
->
İ’
.bd_addr);

970 
	`bdıy
(
gavBdaddr
, 
p_d©a
->
İ’
.
bd_addr
);

971 
cÚÃùiÚ
->
is_İ’
 = 
TRUE
;

974 
	`­p_»ad_xml_»mÙe_deviûs
();

977 
s1
 = 
	`­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

978 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

979 
BSA_A2DP_SERVICE_MASK
 | 
BSA_AVRCP_SERVICE_MASK
);

982 
šdex
 = 0; index < 
	`APP_NUM_ELEMENTS
(
­p_discov”y_cb
.
devs
); index++){

983 ià(!
	`bdcmp
(
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
, 
cÚÃùiÚ
->bd_addr)){

984 
	`­p_xml_upd©e_Çme_db
(
­p_xml_»mÙe_deviûs_db
,

985 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

986 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
Çme
);

987 
	`APP_INFO1
("\tClassOfDevice:%02x:%02x:%02x => %s",

988 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[0],

989 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[1],

990 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[2],

991 
	`­p_g‘_cod_¡ršg
(

992 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
));

993 
s2
 = 
	`­p_xml_upd©e_cod_db
(
­p_xml_»mÙe_deviûs_db
,

994 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

995 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
);

999 if(
šdex
 =ğ
	`APP_NUM_ELEMENTS
(
­p_discov”y_cb
.
devs
))

1001 
	`APP_ERROR0
("app_discovery_cb have‚o ClassOfDevice info!!!");

1003 if((
s1
==0è|| (
s2
==0))

1005 
¡©us
 = 
	`­p_wr™e_xml_»mÙe_deviûs
();

1006 ià(
¡©us
 < 0){

1007 
	`APP_ERROR1
("­p_av_wr™e_»mÙe_deviû çed: %d", 
¡©us
);

1010 
	`APP_INFO1
("­p_av_cb.¶ay_¡©e=%d",
­p_av_cb
.
¶ay_¡©e
);

1012 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STOPPED
){

1014 
	`­p_av_¶ay_mic
();

1018 
cÚÃùiÚ
->
is_İ’
 = 
FALSE
;

1023 
BSA_AV_CLOSE_EVT
:

1024 
	`APP_INFO1
("BSA_AV_CLOSE_EVT stus:%d hªdË:%d", 
p_d©a
->
şo£
.
¡©us
,…_d©a->şo£.
hªdË
);

1025 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
şo£
.
hªdË
);

1026 ià(
cÚÃùiÚ
 =ğ
NULL
)

1028 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
şo£
.
hªdË
);

1032 
cÚÃùiÚ
->
is_İ’
 = 
FALSE
;

1034 #ifdeà
USE_INGENIC_AUDIO_SOCKET


1036 
	`šg’ic_a2dp_şo£
();

1038 
gavS¹
 = 0;

1041 
	`APP_INFO1
("gavS¹ s‘Ø%d",
gavS¹
);

1045 
BSA_AV_DELAY_RPT_EVT
:

1046 
	`APP_INFO1
("BSA_AV_DELAY_RPT_EVT channel:%d handle:%d delay: %d",

1047 
p_d©a
->
d–ay
.
chªÃl
,…_d©a->d–ay.
hªdË
,…_data->delay.delay);

1048 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
d–ay
.
hªdË
);

1049 ià(
cÚÃùiÚ
 =ğ
NULL
)

1051 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
d–ay
.
hªdË
);

1055 
cÚÃùiÚ
->
d–ay
 = 
p_d©a
->delay.delay;

1059 
BSA_AV_PENDING_EVT
:

1061 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1062 
tBSA_AV_OPEN
 
İ’_·¿m
;

1064 
	`APP_INFO1
("BSA_AV_PENDING_EVT‡dd»ss=%x:%x:%x:%x:%x:%x",
p_d©a
->
³nd
.
bd_addr
[0],

1065 
p_d©a
->
³nd
.
bd_addr
[1],p_data->pend.bd_addr[2],p_data->pend.bd_addr[3],

1066 
p_d©a
->
³nd
.
bd_addr
[4],p_data->pend.bd_addr[5]);

1068 
	`­p_av_İ’
(
p_d©a
->
³nd
.
bd_addr
);

1070 
p_cÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
TRUE
, 
FALSE
);

1071 ià(
p_cÚ
 =ğ
NULL
)

1073 
	`APP_ERROR0
("No‡vailable connection structureo open stream");

1078 
	`APP_INFO0
("Connectingo AV device");

1079 
	`BSA_AvO³nIn™
(&
İ’_·¿m
);

1080 
	`bdıy
(
İ’_·¿m
.
bd_addr
, 
p_d©a
->
³nd
.bd_addr);

1081 
İ’_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1083 
İ’_·¿m
.
u£_rc
 = 
APP_AV_USE_RC
;

1084 
¡©us
 = 
	`BSA_AvO³n
(&
İ’_·¿m
);

1085 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1087 
	`APP_ERROR1
("BSA_AvOpen(%02X:%02X:%02X:%02X:%02X:%02X) failed: %d",

1088 
İ’_·¿m
.
bd_addr
[0], open_param.bd_addr[1], open_param.bd_addr[2],

1089 
İ’_·¿m
.
bd_addr
[3], o³n_·¿m.bd_addr[4], o³n_·¿m.bd_addr[5], 
¡©us
);

1096 
BSA_AV_START_EVT
:

1097 
	`APP_INFO1
("BSA_AV_START_EVT status:%d channel:%x UIPC:%d SCMS:%d,%d",

1098 
p_d©a
->
¡¬t
.
¡©us
,…_d©a->¡¬t.
chªÃl
,…_d©a->¡¬t.
uc_chªÃl
,

1099 
p_d©a
->
¡¬t
.
ı_’abËd
,…_d©a->¡¬t.
ı_æag
);

1101 ià(
p_d©a
->
¡¬t
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO
)

1103 ià(
p_d©a
->
¡¬t
.
¡©us
 =ğ
BSA_SUCCESS
)

1105 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STARTED
;

1106 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PLAYING
);

1108 
­p_av_cb
.
medŸ_ãedšg
 = 
p_d©a
->
¡¬t
.media_feeding;

1109 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
)

1111 
BSA_AV_CODEC_PCM
:

1112 
	`APP_INFO1
(" Start PCM feeding: freq=%d / channels=%d / bits=%d",

1113 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
,

1114 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
,

1115 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
);

1117 
BSA_AV_CODEC_APTX
:

1118 
	`APP_INFO1
(" Start‡pt-X feeding: freq=%d / mode=%d",

1119 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
,

1120 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
);

1122 
BSA_AV_CODEC_SEC
:

1123 
	`APP_INFO1
(" Start SEC feeding: freq=%d / mode=%d",

1124 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
,

1125 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
);

1129 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
);

1133 
	`APP_INFO1
(" SCMS-T: cp_enabled = %s, cp_flag = %d",

1134 
p_d©a
->
¡¬t
.
ı_’abËd
 ? "TRUE" : "FALSE",

1135 
p_d©a
->
¡¬t
.
ı_æag
);

1137 ià(
	`­p_dm_g‘_du®_¡ack_mode
(è=ğ
BSA_DM_DUAL_STACK_MODE_BSA
)

1140 
	`­p_av_uc_»cÚfig
();

1143 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

1144 ià(
¡©us
 < 0)

1146 
	`APP_ERROR1
("­p_uÆock_mu‹x faed:%d", 
¡©us
);

1151 
	`APP_INFO0
("Stack is‚ot in BSA mode. Do‚ot Start AVhread");

1157 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1159 
­p_av_cb
.
Ï¡_¡¬t_¡©us
 = 
p_d©a
->
¡¬t
.
¡©us
;

1164 #ifdeà
APP_AV_BCST_INCLUDED


1165 
	`­p_av_bc¡_¡¬t_ev’t_hdÌ
(&
p_d©a
->
¡¬t
);

1168 
gavS¹
 = 1;

1169 if(
p_­p_av_nÙify_cb
)

1170 
	`p_­p_av_nÙify_cb
(1);

1171 
	`APP_INFO1
("gavS¹ s‘Ø%d",
gavS¹
);

1174 
BSA_AV_STOP_EVT
:

1175 
	`APP_DEBUG1
("BSA_AV_STOP_EVT…ause:%d Channel:%d UIPC:%d",

1176 
p_d©a
->
¡İ
.
·u£
,…_d©a->¡İ.
chªÃl
,…_d©a->¡İ.
uc_chªÃl
);

1178 ià(
p_d©a
->
¡İ
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO
){

1180 ià(
p_d©a
->
¡İ
.
·u£
){

1181 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_PAUSED
;

1182 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PAUSED
);

1185 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPED
;

1186 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_STOPPED
);

1188 ià(
	`­p_dm_g‘_du®_¡ack_mode
(è=ğ
BSA_DM_DUAL_STACK_MODE_BSA
){

1190 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

1191 ià(
¡©us
 < 0){

1192 
	`APP_ERROR1
("­p_uÆock_mu‹x faed:%d", 
¡©us
);

1196 
	`APP_INFO0
("Stack is‚ot in BSA mode. Do‚ot Stop AVhread");

1201 ià(
p_d©a
->
¡İ
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO_BCST
){

1202 #ifdeà
APP_AV_BCST_INCLUDED


1203 
	`­p_av_bc¡_¡İ_ev’t_hdÌ
(&
p_d©a
->
¡İ
);

1206 
	`APP_ERROR1
("Bad chªÃl:%d Stİ³d", 
p_d©a
->
¡İ
.
chªÃl
);

1211 
BSA_AV_RC_OPEN_EVT
:

1212 
	`APP_DEBUG1
("BSA_AV_RC_OPEN_EVT stus:%d hªdË:%d", 
p_d©a
->
rc_İ’
.
¡©us
,…_d©a->rc_İ’.
rc_hªdË
);

1214 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
p_d©a
->
rc_İ’
.
³”_addr
);

1215 ià(
cÚÃùiÚ
 =ğ
NULL
)

1217 
	`APP_ERROR1
("unknown connection bd‡ddr for %02X:%02X:%02X:%02X:%02X:%02X",

1218 
p_d©a
->
rc_İ’
.
³”_addr
[0],…_data->rc_open.peer_addr[1],…_data->rc_open.peer_addr[2],

1219 
p_d©a
->
rc_İ’
.
³”_addr
[3],…_data->rc_open.peer_addr[4],…_data->rc_open.peer_addr[5]);

1221 ià(
p_d©a
->
rc_İ’
.
¡©us
 =ğ
BSA_SUCCESS
)

1223 
cÚÃùiÚ
->
is_rc
 = 
TRUE
;

1224 
cÚÃùiÚ
->
rc_hªdË
 = 
p_d©a
->
rc_İ’
.rc_handle;

1228 
BSA_AV_RC_CLOSE_EVT
:

1229 
	`APP_DEBUG1
("BSA_AV_RC_CLOSE_EVT hªdË:%d bdadd¸%02X:%02X:%02X:%02X:%02X:%02X", 
p_d©a
->
rc_şo£
.
rc_hªdË
,

1230 
p_d©a
->
rc_şo£
.
³”_addr
[0],…_data->rc_close.peer_addr[1],…_data->rc_close.peer_addr[2],

1231 
p_d©a
->
rc_şo£
.
³”_addr
[3],…_data->rc_close.peer_addr[4],…_data->rc_close.peer_addr[5]);

1233 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
p_d©a
->
rc_şo£
.
³”_addr
);

1234 ià(
cÚÃùiÚ
 =ğ
NULL
)

1236 
	`APP_ERROR1
("unknown connection bd‡ddr for %02X:%02X:%02X:%02X:%02X:%02X",

1237 
p_d©a
->
rc_şo£
.
³”_addr
[0],…_data->rc_close.peer_addr[1],…_data->rc_close.peer_addr[2],

1238 
p_d©a
->
rc_şo£
.
³”_addr
[3],…_data->rc_close.peer_addr[4],…_data->rc_close.peer_addr[5]);

1242 
cÚÃùiÚ
->
is_rc
 = 
FALSE
;

1246 
BSA_AV_REMOTE_CMD_EVT
:

1247 
	`APP_DEBUG1
("BSA_AV_REMOTE_CMD_EVT hªdË:%d", 
p_d©a
->
»mÙe_cmd
.
rc_hªdË
);

1248 #ià!
	`defšed
(
CONFIG_REMOTE_IS_AUDIO_SPEAKER
)

1249 
p_d©a
->
»mÙe_cmd
.
rc_id
)

1251 
BSA_AV_RC_PLAY
:

1252 
	`APP_INFO0
("Play key");

1253 
commªd
 = 
APP_AV_START
;

1255 
BSA_AV_RC_STOP
:

1256 
	`APP_INFO0
("Stop key");

1257 
commªd
 = 
APP_AV_STOP
;

1259 
BSA_AV_RC_PAUSE
:

1260 
	`APP_INFO0
("Pause key");

1261 
commªd
 = 
APP_AV_PAUSE
;

1263 
BSA_AV_RC_FORWARD
:

1264 
	`APP_INFO0
("Forward key");

1265 
commªd
 = 
APP_AV_FORWARD
;

1267 
BSA_AV_RC_BACKWARD
:

1268 
	`APP_INFO0
("Backward key");

1269 
commªd
 = 
APP_AV_BACKWARD
;

1272 
	`APP_INFO1
("key:0x%x", 
p_d©a
->
»mÙe_cmd
.
rc_id
);

1273 
commªd
 = 
APP_AV_IDLE
;

1277 #ià!
	`defšed
(
CONFIG_REMOTE_IS_AUDIO_SPEAKER
)

1278 ià(
p_d©a
->
»mÙe_cmd
.
key_¡©e
 =ğ
BSA_AV_STATE_PRESS
)

1280 
	`APP_INFO1
("Key…»s£d ->ƒxecutšg commªd %d", 
commªd
);

1281 
commªd
)

1283 
APP_AV_START
:

1284 
­p_av_cb
.
¶ay_¡©e
)

1286 
APP_AV_PLAY_PAUSED
:

1287 
	`­p_av_»sume
();

1289 
APP_AV_PLAY_STOPPED
:

1290 
­p_av_cb
.
¶ay_ty³
)

1292 
APP_AV_PLAYTYPE_FILE
:

1293 
	`­p_av_¶ay_¶ayli¡
(
commªd
);

1295 
APP_AV_PLAYTYPE_TONE
:

1296 
	`­p_av_¶ay_tÚe
();

1298 
APP_AV_PLAYTYPE_MIC
:

1299 
	`­p_av_¶ay_mic
();

1301 
APP_AV_PLAYTYPE_TEST
:

1302 
	`­p_av_‹¡_£c_codec
(
TRUE
);

1305 
	`APP_ERROR1
("UnsuµÜ‹d…Ïyy³ (%d)", 
­p_av_cb
.
¶ay_ty³
);

1309 
APP_AV_PLAY_STARTED
:

1311 
	`APP_DEBUG0
("Stream‡lready started,‚ot calling start");

1313 
APP_AV_PLAY_STOPPING
:

1315 
	`APP_DEBUG0
("Stream stopping,‚ot calling start");

1318 
	`APP_ERROR1
("UnsuµÜ‹d…Ïy s‹ (%d)", 
­p_av_cb
.
¶ay_¡©e
);

1322 
APP_AV_STOP
:

1323 
	`­p_av_¡İ
();

1325 
APP_AV_PAUSE
:

1326 
	`­p_av_·u£
();

1328 
APP_AV_FORWARD
:

1329 
APP_AV_BACKWARD
:

1330 ià(
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

1331 ià(
­p_av_cb
.
¶ay_ty³
 !ğ
APP_AV_PLAYTYPE_AVK
)

1333 
	`­p_av_¡İ
();

1337 
s_commªd
 = 
commªd
;

1338 
¡©us
 = 
	`­p_ü—‹_th»ad
(
­p_avk_rc_commªd_th»ad
, 0, 0, &
t_­p_rc_th»ad
);

1343 ià(
p_d©a
->
»mÙe_cmd
.
key_¡©e
 =ğ
BSA_AV_STATE_RELEASE
)

1345 
	`APP_INFO0
("„eleased -> just informative");

1350 #ià!
	`defšed
(
CONFIG_REMOTE_IS_AUDIO_SPEAKER
)

1351 
	`APP_ERROR0
("Unknown key state");

1356 
BSA_AV_REMOTE_RSP_EVT
:

1357 
	`APP_DEBUG1
("BSA_AV_REMOTE_RSP_EVT hªdË:%d", 
p_d©a
->
»mÙe_r¥
.
rc_hªdË
);

1360 
BSA_AV_VENDOR_CMD_EVT
:

1361 
	`APP_DEBUG1
("BSA_AV_VENDOR_CMD_EVT hªdË:%d", 
p_d©a
->
v’dÜ_cmd
.
rc_hªdË
);

1362 
	`APP_DEBUG1
("†en=%d,†abel=%d, code=%d, company_id=0x%x",

1363 
p_d©a
->
v’dÜ_cmd
.
Ën
,…_d©a->v’dÜ_cmd.
Ïb–
,…_d©a->v’dÜ_cmd.
code
,

1364 
p_d©a
->
v’dÜ_cmd
.
com·ny_id
);

1365 if(
p_d©a
->
v’dÜ_cmd
.
Ën
)

1367 
	`APP_DEBUG1
("Name:%s",
	`­p_av_di¥Ïy_v’dÜ_commªd
(
p_d©a
->
v’dÜ_cmd
.
d©a
[0]));

1368 
	`APP_DUMP
("D©a", (
UINT8
 *)
p_d©a
->
v’dÜ_cmd
.
d©a
,…_d©a->v’dÜ_cmd.
Ën
);

1372 
BSA_AV_VENDOR_RSP_EVT
:

1373 
	`APP_DEBUG1
("BSA_AV_VENDOR_RSP_EVT hªdË:%d", 
p_d©a
->
v’dÜ_r¥
.
rc_hªdË
);

1374 
	`APP_DEBUG1
("†en=%d,†abel=%d, code=%d, company_id=0x%x",

1375 
p_d©a
->
v’dÜ_r¥
.
Ën
,…_d©a->v’dÜ_r¥.
Ïb–
,…_d©a->v’dÜ_r¥.
code
,

1376 
p_d©a
->
v’dÜ_r¥
.
com·ny_id
);

1377 if(
p_d©a
->
v’dÜ_r¥
.
Ën
)

1379 
	`APP_DEBUG1
("Name:%s",
	`­p_av_di¥Ïy_v’dÜ_commªd
(
p_d©a
->
v’dÜ_r¥
.
d©a
[0]));

1380 
	`APP_DUMP
("D©a", (
UINT8
 *)
p_d©a
->
v’dÜ_r¥
.
d©a
,…_d©a->v’dÜ_r¥.
Ën
);

1384 
BSA_AV_META_MSG_EVT
:

1385 
	`APP_DEBUG1
("BSA_AV_META_MSG_EVT hªdË:%d", 
p_d©a
->
m‘a_msg
.
rc_hªdË
);

1387 
	`APP_DEBUG1
("†abel=%d,…du=%d, company_id=0x%x",

1388 
p_d©a
->
m‘a_msg
.
Ïb–
,…_d©a->m‘a_msg.
pdu
,…_d©a->m‘a_msg.
com·ny_id
);

1390 
­p_av_cb
.
Ïb–
 = 
p_d©a
->
m‘a_msg
.label;

1392 
p_d©a
->
m‘a_msg
.
pdu
)

1394 
BSA_AVRC_PDU_GET_ELEMENT_ATTR
:

1395 
	`­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_m‘a_»¥Ú£
(0);

1398 
BSA_AVRC_PDU_GET_PLAY_STATUS
:

1399 
	`­p_av_rc_£nd_¶ay_¡©us_m‘a_»¥Ú£
(0);

1402 
BSA_AVRC_PDU_SET_ADDRESSED_PLAYER
:

1403 
	`­p_av_rc_£t_addr_¶ay”_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1406 
BSA_AVRC_PDU_GET_FOLDER_ITEMS
:

1407 
	`­p_av_rc_g‘_fŞd”_™ems
(0, &
p_d©a
->
m‘a_msg
);

1410 
BSA_AVRC_PDU_REGISTER_NOTIFICATION
:

1411 
	`­p_av_rc_»gi¡”_nÙifiÿtiÚs
(0, &
p_d©a
->
m‘a_msg
);

1414 
BSA_AVRC_PDU_SET_BROWSED_PLAYER
:

1415 
	`­p_av_rc_£t_brow£d_¶ay”_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1418 
BSA_AVRC_PDU_CHANGE_PATH
:

1419 
	`­p_av_rc_chªge_·th_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1422 
BSA_AVRC_PDU_GET_ITEM_ATTRIBUTES
:

1423 
	`­p_av_rc_g‘_™em_©Œ_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1426 
BSA_AVRC_PDU_PLAY_ITEM
:

1427 
	`­p_av_rc_¶ay_™em_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1433 
BSA_AV_FEAT_EVT
:

1434 
	`APP_DEBUG1
("BSA_AV_FEAT_EVT P“¸ã©u»:%x", 
p_d©a
->
rc_ã©
.
³”_ã©u»s
);

1438 
	`APP_ERROR1
("UnknowÀmsg %d", 
ev’t
);

1443 if(
s_pC®lback
)

1444 
	`s_pC®lback
(
ev’t
, 
p_d©a
);

1445 
	}
}

1454 
	$­p_avk_rc_commªd_th»ad
()

1456 
wa™út
 = 0;

1460 (
	`­p_av_g‘_¶ay_¡©e
(è=ğ
APP_AV_PLAY_STOPPING
) &&

1461 (
	`­p_av_g‘_¶ay_¡©e
()!ğ
APP_AV_PLAY_STOPPED
) &&

1462 
wa™út
 < 5)

1464 
	`¦“p
(1);

1465 
wa™út
++;

1468 if(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

1469 
	`­p_av_¶ay_¶ayli¡
(
s_commªd
);

1471 if(
s_commªd
 =ğ
APP_AV_FORWARD
)

1473 
p_b§_av_cb
->
cur_¶ay
++;

1474 if(
p_b§_av_cb
->
cur_¶ay
 >ğ
BSA_AV_NUMSONGS
)

1475 
p_b§_av_cb
->
cur_¶ay
 = 0;

1476 
	`­p_av_rc_chªge_Œack
();

1478 if(
s_commªd
 =ğ
APP_AV_BACKWARD
)

1480 if(
p_b§_av_cb
->
cur_¶ay
 > 0)

1481 
p_b§_av_cb
->
cur_¶ay
--;

1483 
p_b§_av_cb
->
cur_¶ay
 = 
BSA_AV_NUMSONGS
 -1;

1484 
	`­p_av_rc_chªge_Œack
();

1486 
	}
}

1488 
	$­p_av_£t_nÙify_cb
((*
­p_av_nÙify_cb
)(
¡©e
)) {

1489 
p_­p_av_nÙify_cb
 = 
­p_av_nÙify_cb
;

1490 
	}
}

1491 
	$­p_av_is_cÚÃù
(){

1492  
gavS¹
;

1493 
	}
}

1505 
	$­p_av_İ’
(
BD_ADDR
 *
bd_addr_š
)

1507 
¡©us
;

1508 
BD_ADDR
 
bd_addr
;

1509 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1510 
tBSA_AV_OPEN
 
İ’_·¿m
;

1512 
	`­p_av_di¥Ïy_cÚÃùiÚs
();

1514 ià(!
	`­p_av_şo£
()) {

1515 
t
;

1516 
t
=0;<2000;++) {

1517 if(
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
TRUE
,TRUE))

1518 
	`u¦“p
(1000);

1525 
p_cÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
TRUE
, 
FALSE
);

1526 ià(
p_cÚ
 =ğ
NULL
){

1527 
	`APP_ERROR0
("No‡vailable connection structureo open stream");

1534 
	`APP_INFO0
("Connectingo AV device");

1535 
	`APP_ERROR1
("BSA_AvOpen(%02hhX:%02hhX:%02hhX:%02hhX:%02hhX:%02hhX) ",

1536 
bd_addr_š
[0], bd_addr_in[1], bd_addr_in[2],

1537 
bd_addr_š
[3], bd_addr_in[4], bd_addr_in[5]);

1538 
	`BSA_AvO³nIn™
(&
İ’_·¿m
);

1539 
	`bdıy
(
İ’_·¿m
.
bd_addr
, *
bd_addr_š
);

1540 
İ’_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1542 
İ’_·¿m
.
u£_rc
 = 
APP_AV_USE_RC
;

1543 
¡©us
 = 
	`BSA_AvO³n
(&
İ’_·¿m
);

1544 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1546 
	`APP_ERROR1
("BSA_AvOpen(%02X:%02X:%02X:%02X:%02X:%02X) failed: %d",

1547 
İ’_·¿m
.
bd_addr
[0], open_param.bd_addr[1], open_param.bd_addr[2],

1548 
İ’_·¿m
.
bd_addr
[3], o³n_·¿m.bd_addr[4], o³n_·¿m.bd_addr[5], 
¡©us
);

1552 
	}
}

1563 
	$­p_av_şo£
()

1565 
¡©us
 = -1;

1566 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1567 
tBSA_AV_CLOSE
 
şo£_·¿m
;

1570 
	`­p_av_di¥Ïy_cÚÃùiÚs
();

1571 
út
;

1572 
út
 = 0; cÁ < 
APP_AV_MAX_CONNECTIONS
; cnt++)

1574 ià((
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_»gi¡”ed
) &&

1575 (
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_İ’
)) {

1576 
p_cÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
út
];

1578 
	`APP_DEBUG0
("BSA_AvClose ");

1579 
¡©us
 = 
	`BSA_AvClo£In™
(&
şo£_·¿m
);

1580 
şo£_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1581 
¡©us
 = 
	`BSA_AvClo£
(&
şo£_·¿m
);

1583 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1585 
	`APP_ERROR1
("BSA_AvClo£ faed stu ğ%d", 
¡©us
);

1590 
choiû
;

1591 
choiû
 = 0;

1592 
p_cÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
choiû
];

1593 ià(!
p_cÚ
->
is_İ’
)

1595 
	`APP_ERROR0
("not connected");

1599 
¡©us
 = 
	`BSA_AvClo£In™
(&
şo£_·¿m
);

1600 
şo£_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1601 
¡©us
 = 
	`BSA_AvClo£
(&
şo£_·¿m
);

1603 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1605 
	`APP_ERROR1
("BSA_AvClo£ faed stu ğ%d", 
¡©us
);

1608  
¡©us
;

1609 
	}
}

1620 
	$­p_av_»ad_tÚe
(* 
pOut
, 
nb_by‹s
, 
UINT8
 
sšus_ty³
, UINT8 *
p_sšus_šdex
)

1622 
šdex
;

1623 
UINT8
 
sšus_šdex
 = *
p_sšus_šdex
;

1626 
šdex
 = 0; index < (
nb_by‹s
 / 4); index++)

1628 
pOut
[
šdex
 * 2] = 
sšwaves
[
sšus_ty³
][
sšus_šdex
 % 64];

1629 
pOut
[
šdex
 * 2 + 1] = 
sšwaves
[
sšus_ty³
][
sšus_šdex
 % 64];

1630 
sšus_šdex
++;

1632 *
p_sšus_šdex
 = 
sšus_šdex
;

1633 
	}
}

1643 
	$­p_av_»ad_‹¡
(* 
pOut
, 
nb_by‹s
)

1645 
šdex
;

1646 
d©a
 = 1;

1648 
d©a
++;

1649 
šdex
 = 0; index < 
nb_by‹s
/2 ; index++)

1651 
pOut
[
šdex
] = 
d©a
;

1654 
	`APP_DEBUG1
("­p_av_»ad_‹¡ d©¨ğ0x%x,†’gth = %d", 
d©a
, 
nb_by‹s
);

1655 
	}
}

1666 
	$­p_av_£t_tÚe_§m¶e_äequ’cy
(
UINT16
 
§m¶e_äeq
)

1668 
	`APP_DEBUG1
("­p_av_£t_tÚe_§m¶e_äequ’cy %d", 
§m¶e_äeq
);

1669 
­p_av_cb
.
tÚe_§m¶e_äeq
 = 
§m¶e_äeq
;

1670 
	}
}

1681 
	$­p_av_toggË_tÚe
()

1683 ià(
­p_av_cb
.
sšus_ty³
 == 0)

1684 
­p_av_cb
.
sšus_ty³
 = 1;

1686 
­p_av_cb
.
sšus_ty³
 = 0;

1687 
	}
}

1698 
	$­p_av_¶ay_tÚe
()

1700 
¡©us
;

1701 
tBSA_AV_START
 
¡¬t_·¿m
;

1703 ifĞ((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
) &&

1704 (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_PAUSED
))

1706 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1711 
­p_av_cb
.
sšus_šdex
 = 0;

1712 
­p_av_cb
.
sšus_ty³
 = 0;

1715 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1716 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

1718 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
­p_av_cb
.
tÚe_§m¶e_äeq
;

1719 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

1720 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

1721 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1722 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1725 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

1726 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

1728 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_TONE
;

1729 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1731 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1732 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1734 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

1735  
¡©us
;

1739 
	}
}

1741 
	$­p_av_¶ay_äom_avk
()

1743 
¡©us
;

1744 
tBSA_AV_START
 
¡¬t_·¿m
;

1746 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

1748 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1753 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1755 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_AVK
;

1756 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1758 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1759 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1761 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

1762  
¡©us
;

1766 
	}
}

1777 
	$­p_av_¶ay_fe
()

1779 
¡©us
;

1780 
tBSA_AV_START
 
¡¬t_·¿m
;

1781 
choiû
;

1782 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

1784 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

1786 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1790 
	`­p_av_di¥Ïy_¶ayli¡
();

1792 
choiû
 = 
	`­p_g‘_choiû
("Select file");

1793 ià((
choiû
 < 0 ) || (choiû >ğ
­p_av_cb
.
soundfe_li¡_size
))

1795 
	`APP_ERROR1
("Fšdex ouˆoàbounds:%d", 
choiû
);

1799 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
choiû
], &
wav_fÜm©
) < 0)

1801 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
choiû
]);

1805 
	`APP_INFO1
("%d :%s", ()
choiû
, 
­p_av_cb
.
soundfe_li¡
[choice]);

1806 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

1807 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

1810 
­p_av_cb
.
fe_šdex
 = 
choiû
;

1811 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[
choiû
], (app_av_cb.file_name)-1);

1812 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

1815 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1817 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
wav_fÜm©
.
codec
;

1818 
wav_fÜm©
.
codec
)

1820 
BSA_AV_CODEC_PCM
:

1821 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1822 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 
wav_fÜm©
.
nb_chªÃls
;

1823 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 
wav_fÜm©
.
b™s_³r_§m¶e
;

1825 
BSA_AV_CODEC_APTX
:

1826 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1827 ià(
wav_fÜm©
.
nb_chªÃls
 == 2)

1829 ià(
wav_fÜm©
.
¡”eo_mode
 == 2)

1831 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_STEREO
;

1835 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_JOINT
;

1840 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_MONO
;

1844 
	`APP_ERROR1
("UnsuµÜ‹d codeø(x%xèš WAV f(%s)", 
wav_fÜm©
.
codec
, 
­p_av_cb
.
soundfe_li¡
[
choiû
]);

1847 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1848 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1851 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

1852 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

1854 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_FILE
;

1855 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1857 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1858 ià(
¡©us
 =ğ
BSA_ERROR_SRV_AV_FEEDING_NOT_SUPPORTED
)

1860 
	`APP_ERROR0
("BSA_AvStart failed because fileƒncoding is‚ot supported by„emote devices");

1861  
¡©us
;

1863 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1865 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

1866  
¡©us
;

1870 
	`APP_INFO0
("Waiting for AV connectiono start");

1871 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STARTED
);

1873 ià(
­p_av_cb
.
Ï¡_¡¬t_¡©us
 !ğ
BSA_SUCCESS
)

1875 
	`APP_ERROR1
("Faed s¹šg AV cÚÃùiÚ : stu %d", 
­p_av_cb
.
Ï¡_¡¬t_¡©us
);

1876  
¡©us
;

1880 
	}
}

1891 
	$­p_av_¶ay_¶ayli¡
(
UINT8
 
commªd
)

1893 
¡©us
;

1894 
tBSA_AV_START
 
¡¬t_·¿m
;

1895 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

1896 
BOOLEAN
 
fÜm©_known
;

1897 
©‹m±
 = 0;

1899 ià((
	`­p_av_g‘_¶ay_¡©e
()!ğ
APP_AV_PLAY_STOPPED
) &&

1900 (
	`­p_av_g‘_¶ay_¡©e
(è!ğ
APP_AV_PLAY_STOPPING
) &&

1901 (
	`­p_av_g‘_¶ay_¡©e
(è!ğ
APP_AV_PLAY_PAUSED
))

1903 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1907 ià((
­p_av_cb
.
soundfe_li¡_size
 =ğ0è|| (­p_av_cb.
soundfe_li¡
 =ğ
NULL
))

1909 
	`APP_ERROR0
("No…laylist");

1914 ià(
commªd
 =ğ
APP_AV_START
)

1917 
	`APP_DEBUG1
("­p_av_¶ay_¶ayli¡ s¹ index:%d", 
­p_av_cb
.
fe_šdex
);

1920 ià(
commªd
 =ğ
APP_AV_FORWARD
)

1922 ià(
­p_av_cb
.
fe_šdex
 >ğ×µ_av_cb.
soundfe_li¡_size
 -1))

1923 
­p_av_cb
.
fe_šdex
 = 0;

1925 
­p_av_cb
.
fe_šdex
++;

1928 ià(
commªd
 =ğ
APP_AV_BACKWARD
)

1930 ià(
­p_av_cb
.
fe_šdex
 == 0)

1931 
­p_av_cb
.
fe_šdex
 =‡µ_av_cb.
soundfe_li¡_size
 - 1;

1933 
­p_av_cb
.
fe_šdex
--;

1937 
	`APP_ERROR1
("UnsuµÜ‹d commªd:%d", 
commªd
);

1941 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_FILE
;

1942 
­p_av_cb
.
¶ay_li¡
 = 
TRUE
;

1946 
fÜm©_known
 = 
TRUE
;

1947 
¡©us
 = -1;

1950 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1951 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
], &
wav_fÜm©
) < 0)

1953 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1957 
	`APP_INFO1
("L‘' ŒyØ¶ay WAV fe:% fÜm©:", 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1958 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

1959 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

1960 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
wav_fÜm©
.
codec
;

1961 
wav_fÜm©
.
codec
)

1963 
BSA_AV_CODEC_PCM
:

1964 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1965 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 
wav_fÜm©
.
nb_chªÃls
;

1966 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 
wav_fÜm©
.
b™s_³r_§m¶e
;

1968 
BSA_AV_CODEC_APTX
:

1969 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1970 ià(
wav_fÜm©
.
nb_chªÃls
 == 2)

1972 ià(
wav_fÜm©
.
¡”eo_mode
 == 2)

1974 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_STEREO
;

1978 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_JOINT
;

1983 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_MONO
;

1987 
	`APP_ERROR1
("UnsuµÜ‹d codeø(x%xèš WAV f(%s)", 
wav_fÜm©
.
codec
, 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1988 
fÜm©_known
 = 
FALSE
;

1991 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1992 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1995 ià(
fÜm©_known
)

1997 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[­p_av_cb.
fe_šdex
], (app_av_cb.file_name)-1);

1998 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

2001 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

2002 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

2004 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

2005 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2007 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

2012 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2014 ià((
commªd
 =ğ
APP_AV_START
è|| (commªd =ğ
APP_AV_FORWARD
))

2016 ià(
­p_av_cb
.
fe_šdex
 >ğ×µ_av_cb.
soundfe_li¡_size
 - 1))

2018 
­p_av_cb
.
fe_šdex
 = 0;

2022 
­p_av_cb
.
fe_šdex
++;

2026 ià(
commªd
 =ğ
APP_AV_BACKWARD
)

2028 ià(
­p_av_cb
.
fe_šdex
 == 0)

2030 
­p_av_cb
.
fe_šdex
 =‡µ_av_cb.
soundfe_li¡_size
 - 1;

2034 
­p_av_cb
.
fe_šdex
--;

2037 
	`APP_DEBUG1
("¶ayli¡_šdex:%d‡µ_av_cb.soundfe_li¡_size:%d", 
­p_av_cb
.
fe_šdex
,‡µ_av_cb.
soundfe_li¡_size
);

2040 
©‹m±
++;

2042 } (
¡©us
 !ğ
BSA_SUCCESS
è&& (
©‹m±
 < 
­p_av_cb
.
soundfe_li¡_size
));

2044 ià(
¡©us
 =ğ
BSA_SUCCESS
)

2052 
	}
}

2063 
	$­p_av_¶ay_mic
(){

2064 
	`APP_INFO0
("app_av_play_mic in");

2065 
¡©us
;

2066 
tBSA_AV_START
 
¡¬t_·¿m
;

2067 #ifdeà
USE_INGENIC_AUDIO_SOCKET


2069 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

2070 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

2071 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 44100;

2072 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

2073 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

2074 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

2075 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

2078 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

2079 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

2081 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_MIC
;

2083 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

2084 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2086 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

2087  
¡©us
;

2090 
	`šg’ic_a2dp_İ’
();

2095 
	}
}

2106 
	$­p_av_¡İ_cu¼’t
()

2108 
¡©us
;

2109 
tBSA_AV_STOP
 
¡İ_·¿m
;

2110 
UINT8
 
¶ay_¡©e
;

2114 
¶ay_¡©e
 = 
­p_av_cb
.play_state;

2115 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPING
;

2116 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_STOPPED
);

2119 
¡©us
 = 
	`BSA_AvStİIn™
(&
¡İ_·¿m
);

2120 
¡İ_·¿m
.
·u£
 = 
FALSE
;

2121 
¡©us
 = 
	`BSA_AvStİ
(&
¡İ_·¿m
);

2122 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2124 
­p_av_cb
.
¶ay_¡©e
 =…lay_state;

2125 
	`APP_ERROR1
("BSA_AvStİ faed: %d", 
¡©us
);

2126  
¡©us
;

2131 
	}
}

2142 
	$­p_av_¡İ
()

2144 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

2146  
	`­p_av_¡İ_cu¼’t
();

2147 
	}
}

2158 
	$­p_av_·u£
()

2160 
¡©us
;

2161 
tBSA_AV_STOP
 
¡İ_·¿m
;

2162 
UINT8
 
¶ay_¡©e
;

2166 
¶ay_¡©e
 = 
­p_av_cb
.play_state;

2168 if((
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STOPPED
) ||

2169 (
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
))

2172 
	`APP_DEBUG1
("­p_av_·u£ -‡Ì—dy…au£d o¸¡İ³d, %d", 
­p_av_cb
.
¶ay_¡©e
);

2173  
BSA_SUCCESS
;

2176 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_PAUSED
;

2177 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PAUSED
);

2180 
¡©us
 = 
	`BSA_AvStİIn™
(&
¡İ_·¿m
);

2181 
¡İ_·¿m
.
·u£
 = 
TRUE
;

2182 
¡©us
 = 
	`BSA_AvStİ
(&
¡İ_·¿m
);

2183 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2185 
­p_av_cb
.
¶ay_¡©e
 =…lay_state;

2186 
	`APP_ERROR1
("BSA_AvStİ faed: %d", 
¡©us
);

2187  
¡©us
;

2191 
	}
}

2202 
	$­p_av_»sume
()

2204 
¡©us
;

2205 
tBSA_AV_START
 
¡¬t_·¿m
;

2208 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

2209 
¡¬t_·¿m
.
medŸ_ãedšg
 = 
­p_av_cb
.media_feeding;

2210 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

2211 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

2214 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

2215 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

2217 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

2218 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2220 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

2221  
¡©us
;

2225 
	}
}

2236 
	$­p_av_rc_£nd_commªd
(
šdex
, 
commªd
)

2238 
¡©us
;

2239 
tBSA_AV_REM_CMD
 
b§_av_rc_cmd
;

2242 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2244 
	`APP_ERROR0
("Connection index out of bounds");

2249 
¡©us
 = 
	`BSA_AvRemÙeCmdIn™
(&
b§_av_rc_cmd
);

2250 
b§_av_rc_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2251 
b§_av_rc_cmd
.
key_¡©e
 = 
BSA_AV_STATE_PRESS
;

2252 
b§_av_rc_cmd
.
rc_id
 = (
tBSA_AV_RC
)
commªd
;

2253 
b§_av_rc_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2254 
¡©us
 = 
	`BSA_AvRemÙeCmd
(&
b§_av_rc_cmd
);

2255 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2257 
	`APP_ERROR1
("BSA_AvRemÙeCmd faed: %d", 
¡©us
);

2258  
¡©us
;

2261 
	}
}

2272 
	$­p_av_rc_£nd_absŞu‹_vŞume_vd_commªd
(
šdex
, 
vŞume
)

2274 
¡©us
;

2275 
tBSA_AV_VEN_CMD
 
b§_av_vd_cmd
;

2278 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2280 
	`APP_ERROR0
("Connection index out of bounds");

2285 
¡©us
 = 
	`BSA_AvV’dÜCmdIn™
(&
b§_av_vd_cmd
);

2286 
b§_av_vd_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2287 
b§_av_vd_cmd
.
ùy³
 = 
BSA_AV_CMD_CTRL
;

2288 
b§_av_vd_cmd
.
d©a
[0] = 
BSA_AV_RC_VD_SET_ABSOLUTE_VOLUME
;

2289 
b§_av_vd_cmd
.
d©a
[1] = 0;

2290 
b§_av_vd_cmd
.
d©a
[2] = 0;

2291 
b§_av_vd_cmd
.
d©a
[3] = 1;

2292 
b§_av_vd_cmd
.
d©a
[4] = 
vŞume
;

2293 
b§_av_vd_cmd
.
Ëngth
 = 5;

2294 
b§_av_vd_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2295 
¡©us
 = 
	`BSA_AvV’dÜCmd
(&
b§_av_vd_cmd
);

2296 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2298 
	`APP_ERROR1
("BSA_AvV’dÜCmd faed: %d", 
¡©us
);

2299  
¡©us
;

2302 
	}
}

2313 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_vd_commªd
(
šdex
)

2315 
¡©us
;

2316 
tBSA_AV_VEN_CMD
 
b§_av_vd_cmd
;

2319 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2321 
	`APP_ERROR0
("Connection index out of bounds");

2326 
¡©us
 = 
	`BSA_AvV’dÜCmdIn™
(&
b§_av_vd_cmd
);

2327 
b§_av_vd_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2328 
b§_av_vd_cmd
.
ùy³
 = 
BSA_AV_CMD_STATUS
;

2329 
b§_av_vd_cmd
.
d©a
[0] = 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
;

2330 
b§_av_vd_cmd
.
d©a
[1] = 0;

2331 
b§_av_vd_cmd
.
d©a
[2] = 0;

2332 
b§_av_vd_cmd
.
d©a
[3] = 0x11;

2336 
b§_av_vd_cmd
.
d©a
[12] = 2;

2339 
b§_av_vd_cmd
.
d©a
[16] = 0x1;

2342 
b§_av_vd_cmd
.
d©a
[20] = 0x7;

2344 
b§_av_vd_cmd
.
Ëngth
 = 21;

2345 
b§_av_vd_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2346 
¡©us
 = 
	`BSA_AvV’dÜCmd
(&
b§_av_vd_cmd
);

2347 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2349 
	`APP_ERROR1
("BSA_AvV’dÜCmd faed: %d", 
¡©us
);

2350  
¡©us
;

2353 
	}
}

2366 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_vd_»¥Ú£
(
šdex
)

2369 
¡©us
, 
©Œ_id
;

2370 
UINT8
 
xx
, 
©Œ_couÁ
;

2371 
tBSA_AV_VEN_RSP
 
b§_av_vd_r¥
;

2372 *
p_¡r
;

2373 
UINT16
 
ch¬£t_id
, 
¡r_Ën
, 
Ën
;

2374 
UINT8
 *
p_d©a
;

2377 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2379 
	`APP_ERROR0
("Connection index out of bounds");

2384 
¡©us
 = 
	`BSA_AvV’dÜR¥In™
(&
b§_av_vd_r¥
);

2385 
b§_av_vd_r¥
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2386 
b§_av_vd_r¥
.
ùy³
 = 0xc;

2387 
b§_av_vd_r¥
.
d©a
[0] = 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
;

2388 
b§_av_vd_r¥
.
d©a
[1] = 0;

2390 
Ën
 = 0;

2391 
¡r_Ën
 = 0;

2392 
©Œ_couÁ
 = 7;

2394 
p_d©a
 = &
b§_av_vd_r¥
.
d©a
[4];

2395 
	`UINT8_TO_BE_STREAM
(
p_d©a
, 
©Œ_couÁ
);

2396 
Ën
 = 1 ;

2398 
xx
=0; xx<
©Œ_couÁ
; xx++)

2400 
©Œ_id
 = 
xx
 + 1;

2402 
©Œ_id
)

2404 
AVRC_MEDIA_ATTR_ID_TITLE
:

2405 
p_¡r
 = (*) "Happy Nation";

2407 
AVRC_MEDIA_ATTR_ID_ARTIST
:

2408 
p_¡r
 = (*) "Jonas, Jenny, Linn, Ulf";

2410 
AVRC_MEDIA_ATTR_ID_ALBUM
:

2411 
p_¡r
 = (*) "Ace of Base";

2413 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
:

2414 
p_¡r
 = (*) "7";

2416 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
:

2417 
p_¡r
 = (*) "15";

2419 
AVRC_MEDIA_ATTR_ID_GENRE
:

2420 
p_¡r
 = (*) "Pop";

2422 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
:

2423 
p_¡r
 = (*) "255000";

2426 
p_¡r
 = 
NULL
;

2429 ià(
p_¡r
)

2431 
¡r_Ën
 = 
	`¡¾’
(
p_¡r
);

2432 
ch¬£t_id
 = 
AVRC_CHARSET_ID_UTF8
;

2434 
	`UINT32_TO_BE_STREAM
(
p_d©a
, 
©Œ_id
);

2435 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
ch¬£t_id
);

2436 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
¡r_Ën
);

2437 
	`ARRAY_TO_BE_STREAM
(
p_d©a
, 
p_¡r
, 
¡r_Ën
);

2439 
Ën
 =†’ + 4 + 2 + 2 + 
¡r_Ën
;

2444 
p_d©a
 = &
b§_av_vd_r¥
.
d©a
[2];

2445 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
Ën
);

2449 
b§_av_vd_r¥
.
Ëngth
 = 4 + 
Ën
;

2451 
b§_av_vd_r¥
.
Ïb–
 = 
­p_av_cb
.label++;

2452 
¡©us
 = 
	`BSA_AvV’dÜR¥
(&
b§_av_vd_r¥
);

2453 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2455 
	`APP_ERROR1
("BSA_AvV’dÜR¥ faed: %d", 
¡©us
);

2456  
¡©us
;

2459 
	}
}

2473 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_m‘a_»¥Ú£
(
šdex
)

2475 
	`APP_INFO0
("app_av_rc_send_get_element_attributes_meta_response");

2477 
¡©us
;

2478 
UINT8
 
xx
, 
©Œ_couÁ
;

2479 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2481 
tBSA_AV_ATTR_ENTRY
 *
p_©Œ
 = 
NULL
;

2484 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2486 
	`APP_ERROR0
("Connection index out of bounds");

2490 if(
p_b§_av_cb
->
cur_¶ay
 >ğ
BSA_AV_NUMSONGS
)

2492 
	`APP_ERROR0
("song index out of bounds");

2497 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2499 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2500 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_ELEMENT_ATTR
;

2502 
©Œ_couÁ
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->attr_count;

2503 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
num_©Œs
 = 
©Œ_couÁ
;

2505 
p_©Œ
 = (
tBSA_AV_ATTR_ENTRY
 *è&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
©Œs
;

2507 
xx
=0; xx<
©Œ_couÁ
; xx++)

2509 
p_©Œ
[
xx
].
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.charset_id;

2510 
p_©Œ
[
xx
].
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.str_len;

2511 
p_©Œ
[
xx
].
©Œ_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].attr_id;

2513 if(
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
Çme
.
¡r_Ën
 !ğ0 && b§_av_sÚgs[p_b§_av_cb->cur_¶ay]->p_©Œ_li¡[xx].Çme.
p_¡r
)

2515 
	`¡ºıy
((*è
p_©Œ
[
xx
].
¡r
, (*è
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].
Çme
.
p_¡r
, 
BSA_AV_META_INFO_LEN_MAX
 - 1);

2516 
	`APP_INFO1
("A‰¸ID %d, sŒšg‚am%s", 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
©Œ_id
, 
p_©Œ
[xx].
¡r
);

2520 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2522 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2523 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2525 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2526  
¡©us
;

2529 
	}
}

2540 
	$­p_av_rc_£nd_¶ay_¡©us_m‘a_»¥Ú£
(
šdex
)

2542 
	`APP_INFO0
("app_av_rc_send_play_status_meta_response");

2544 
¡©us
;

2545 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2548 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2550 
	`APP_ERROR0
("Connection index out of bounds");

2555 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2557 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2558 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_PLAY_STATUS
;

2559 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2560 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
sÚg_Ën
 = (
UINT32
) 255000;

2561 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
sÚg_pos
 = (
UINT32
) 120000;

2563 if(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STARTED
)

2564 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_PLAYING
 ;

2565 if(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
)

2566 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_PAUSED
;

2568 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_STOPPED
;

2570 
	`APP_INFO1
("PÏy stu ğ%d", 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
);

2572 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2573 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2575 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2576  
¡©us
;

2579 
	}
}

2590 
	$­p_av_rc_£t_addr_¶ay”_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2593 
¡©us
;

2594 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2595 
UINT8
 
xx
;

2598 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2600 
	`APP_ERROR0
("Connection index out of bounds");

2604 if(
pM‘aMsg
 =ğ
NULL
)

2606 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2611 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2613 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2615 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2616  
¡©us
;

2619 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2620 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_SET_ADDRESSED_PLAYER
;

2621 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2622 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2623 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2627 
xx
=0; xx<
BSA_AV_NUM_MPLAYERS
; xx++)

2629 ià(
b§_av_¶ay”s
[
xx
] && 
pM‘aMsg
->
¶ay”_id
 == bsa_av_players[xx]->player_id)

2631 
	`APP_INFO1
("S‘Add»s£dPÏy” sucûeded ID %d", 
pM‘aMsg
->
¶ay”_id
);

2632 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 
pM‘aMsg
->
¶ay”_id
;

2637 ià(
xx
 =ğ
BSA_AV_NUM_MPLAYERS
)

2639 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_BAD_PLAYER_ID
;

2640 
	`APP_INFO1
("S‘Add»s£dPÏy” faed bad ID %d", 
pM‘aMsg
->
¶ay”_id
);

2643 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2644 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2646 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2647  
¡©us
;

2650 
	}
}

2662 
	$­p_av_rc_£t_brow£d_¶ay”_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2665 
¡©us
;

2666 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2667 
UINT8
 
xx
;

2670 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2672 
	`APP_ERROR0
("Connection index out of bounds");

2676 if(
pM‘aMsg
 =ğ
NULL
)

2678 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2683 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2685 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2687 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2688  
¡©us
;

2691 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2692 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_SET_BROWSED_PLAYER
;

2693 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2694 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2695 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2699 
xx
=0; xx<
BSA_AV_NUM_MPLAYERS
; xx++)

2701 ià(
b§_av_¶ay”s
[
xx
] && 
pM‘aMsg
->
¶ay”_id
 == bsa_av_players[xx]->player_id &&

2702 
	`AVRC_PF_BROWSE_SUPPORTED
(
b§_av_¶ay”s
[
xx
]->
ã©u»s
))

2704 
	`APP_INFO1
("S‘BÜw£dPÏy” sucûeded ID %d", 
pM‘aMsg
->
¶ay”_id
);

2705 
p_b§_av_cb
->
m‘a_šfo
.
brow£d_¶ay”_id
 = 
pM‘aMsg
->
¶ay”_id
;

2707 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
num_™ems
 = 
BSA_AV_NUMSONGS
;

2708 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
ch¬£t_id
 = 
AVRC_CHARSET_ID_UTF8
;

2709 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_d•th
 = 0;

2710 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_Çme_size
 = 14;

2711 
	`¡rıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_Çme_¡r
, "Player 1 files");

2717 ià(
xx
 =ğ
BSA_AV_NUM_MPLAYERS
)

2719 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_BAD_PLAYER_ID
;

2720 
	`APP_INFO1
("S‘Brow£dPÏy” faed bad ID %d", 
pM‘aMsg
->
¶ay”_id
);

2723 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2724 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2726 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2727  
¡©us
;

2730 
	}
}

2741 
	$­p_av_rc_chªge_·th_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2743 
	`APP_INFO0
("app_av_rc_change_path_meta_response");

2745 
¡©us
;

2746 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2749 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2751 
	`APP_ERROR0
("Connection index out of bounds");

2755 if(
pM‘aMsg
 =ğ
NULL
)

2757 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2762 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2764 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2766 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2767  
¡©us
;

2770 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2771 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_CHANGE_PATH
;

2772 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2773 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
İcode
 = 
pM‘aMsg
->opcode;

2776 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
¡©us
 = 
AVRC_STS_BAD_DIR
;

2777 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
num_™ems
 = 0;

2779 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2780 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2782 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2783  
¡©us
;

2786 
	}
}

2798 
	$­p_av_rc_g‘_™em_©Œ_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2800 
	`APP_INFO0
("app_av_rc_get_item_attr_meta_response");

2803 
UINT8
 
xx
, 
©Œ_couÁ
;

2804 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2805 
¡©us
;

2807 
tBSA_AV_ATTR_ENTRY
 *
p_©Œ
 = 
NULL
;

2810 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2812 
	`APP_ERROR0
("Connection index out of bounds");

2817 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2819 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2820 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_ITEM_ATTRIBUTES
;

2822 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™em_©Œs
.
İcode
 = 
pM‘aMsg
->param.get_item_attrs.opcode;

2824 
©Œ_couÁ
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->attr_count;

2825 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
num_©Œs
 = 
©Œ_couÁ
;

2827 
p_©Œ
 = (
tBSA_AV_ATTR_ENTRY
 *è&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
©Œs
;

2829 
xx
=0; xx<
©Œ_couÁ
; xx++)

2831 
p_©Œ
[
xx
].
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.charset_id;

2832 
p_©Œ
[
xx
].
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.str_len;

2833 
p_©Œ
[
xx
].
©Œ_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].attr_id;

2835 if(
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
Çme
.
¡r_Ën
 !ğ0 && b§_av_sÚgs[p_b§_av_cb->cur_¶ay]->p_©Œ_li¡[xx].Çme.
p_¡r
)

2837 
	`¡ºıy
((*è
p_©Œ
[
xx
].
¡r
, (*è
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].
Çme
.
p_¡r
, 
BSA_AV_META_INFO_LEN_MAX
 - 1);

2838 
	`APP_INFO1
("A‰¸ID %d, sŒšg‚am%s", 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
©Œ_id
, 
p_©Œ
[xx].
¡r
);

2843 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2845 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2846 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2848 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2849  
¡©us
;

2852 
	}
}

2863 
	$­p_av_rc_g‘_fŞd”_™ems
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2865 
	`APP_INFO0
("app_av_rc_get_folder_items");

2867 
¡©us
;

2868 
UINT8
 
xx
;

2870 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2873 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2875 
	`APP_ERROR0
("Connection index out of bounds");

2879 if(
pM‘aMsg
 =ğ
NULL
)

2881 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2886 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2888 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2890 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2891  
¡©us
;

2894 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2895 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_FOLDER_ITEMS
;

2896 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2898 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 = 
pM‘aMsg
->·¿m.
g‘_fŞd”_™ems
.scope;

2899 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2901 if(
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 =ğ
AVRC_SCOPE_PLAYER_LIST
)

2903 
	`APP_INFO0
("AVRC_SCOPE_PLAYER_LIST");

2905 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
 = 0;

2906 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2908 
	`APP_INFO1
("G‘FŞd”I‹m -†i¡…Ïy”„ªg%dØ%d", 
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
,…M‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
);

2909 
	`APP_INFO1
("num oàavaabË…Ïy” %d", 
BSA_AV_NUM_MPLAYERS
);

2911 
xx
=
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
; xx<
BSA_AV_NUM_MPLAYERS
 && xx <õM‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
 ; xx++)

2913 ià(
b§_av_¶ay”s
[
xx
])

2915 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_ty³
 = 
AVRC_ITEM_PLAYER
;

2916 
	`memıy
(&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
¶ay”
, 
b§_av_¶ay”s
[xx], (
tBSA_ITEM_PLAYER
));

2917 
	`¡ºıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_¡r
, (*)
b§_av_¶ay”s
[xx]->
Çme
.
p_¡r
, 
BSA_AV_ITEM_NAME_LEN_MAX
 - 1);

2918 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
++;

2919 
	`APP_INFO1
("MedŸ…Ïy” ID %d,‚am%s", 
b§_av_¶ay”s
[
xx
]->
¶ay”_id
, b§_av_¶ay”s[xx]->
Çme
.
p_¡r
);

2924 if(
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 =ğ
AVRC_SCOPE_FILE_SYSTEM
)

2926 
	`APP_INFO0
("AVRC_SCOPE_FILE_SYSTEM");

2928 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2929 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
uid_couÁ”
 = 
BSA_AV_NUMSONGS
;

2931 
xx
=
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
; xx<
BSA_AV_NUMSONGS
 && xx <õM‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
 ; xx++)

2933 ià(
b§_av_sÚgs
[
xx
])

2935 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_ty³
 = 
AVRC_ITEM_MEDIA
;

2936 
	`memıy
(&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
uid
, 
b§_av_sÚgs
[xx]->uid, (
tBSA_UID
));

2937 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
ty³
 = 
b§_av_sÚgs
[xx]->type;

2938 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[xx]->name.charset_id;

2939 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[xx]->name.str_len;

2940 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
©Œ_couÁ
 = 0;

2942 
	`¡ºıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_¡r
, (*)
b§_av_sÚgs
[xx]->
Çme
.
p_¡r
, 
BSA_AV_ITEM_NAME_LEN_MAX
 - 1);

2943 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
++;

2945 
	`APP_INFO1
("sÚg‚am%s", 
b§_av_sÚgs
[
xx
]->
Çme
.
p_¡r
);

2951 
	`APP_INFO1
("G‘FŞd”I‹ms, scİ%d‚Ù suµÜ‹d", 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
);

2952 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_BAD_CMD
;

2955 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2956 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2958 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2959  
¡©us
;

2962 
	}
}

2973 
	$­p_av_rc_¶ay_™em_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2976 
¡©us
;

2977 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2978 
xx
=0;

2981 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2983 
	`APP_ERROR0
("Connection index out of bounds");

2987 if(
pM‘aMsg
 =ğ
NULL
)

2989 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2994 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2996 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2998 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2999  
¡©us
;

3002 
	`APPL_TRACE_DEBUG3
("app_av_rc_play_item_meta_response scope:%d, uid[0]:0x%02d, uid[7]:0x%02",

3003 
pM‘aMsg
->
·¿m
.
¶ay_™em
.
scİe
,pM‘aMsg->·¿m.¶ay_™em.
uid
[0],…MetaMsg->param.play_item.uid[7]);

3004 
pM‘aMsg
->
·¿m
.
¶ay_™em
.
scİe
)

3006 
AVRC_SCOPE_FILE_SYSTEM
:

3007 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_REJ
;

3008 
xx
=0; xx<
BSA_AV_NUMSONGS
; xx++)

3010 if(
	`memcmp
(
b§_av_sÚgs
[
xx
]->
uid
, 
pM‘aMsg
->
·¿m
.
¶ay_™em
.uid, (
tBSA_UID
)) == 0)

3012 
p_b§_av_cb
->
cur_¶ay
 = 
xx
;

3013 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_ACCEPT
;

3014 
	`­p_av_rc_chªge_Œack
();

3023 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_NOT_IMPL
;

3026 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
pdu
 = 
BSA_AVRC_PDU_PLAY_ITEM
;

3027 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
İcode
 = 
pM‘aMsg
->opcode;

3028 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

3029 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_PLAY_ITEM
;

3030 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

3032 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

3033 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3035 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

3036  
¡©us
;

3039 
	}
}

3051 
	$­p_av_rc_»gi¡”_nÙifiÿtiÚs
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

3053 
UINT16
 
evt_mask
 = 1, 
šdex_x
;

3056 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

3058 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

3060 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3062 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

3063  
¡©us
;

3068 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

3070 
	`APP_ERROR0
("Connection index out of bounds");

3074 if(
pM‘aMsg
 =ğ
NULL
)

3076 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

3080 
šdex_x
 = 
pM‘aMsg
->
·¿m
.
»g_nÙif
.
ev’t_id
 - 1;

3081 
evt_mask
 <<ğ
šdex_x
;

3083 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

3084 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

3086 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

3087 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
code
 = 
BTA_AV_RSP_INTERIM
;

3090 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 |=ƒvt_mask;

3091 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
šdex_x
] = 
pM‘aMsg
->label;

3093  
	`­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
pM‘aMsg
->
·¿m
.
»g_nÙif
.
ev’t_id
, &
b§_av_m‘a_r¥_cmd
);

3094 
	}
}

3106 
	$­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
UINT8
 
ev’t_id
)

3109 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

3111 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

3113 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3115 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

3120 
tBSA_AV_EVT_MASK
 
evt_mask
 = 1;

3121 
UINT8
 
rc_Ïb–
;

3125 
evt_mask
 <<ğ(
ev’t_id
 - 1);

3127 ià(
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &ƒvt_mask)

3129 
	`APPL_TRACE_DEBUG2
("Event(0x%x) was„egistered(0x%x)ƒvt_mask:0x%x",

3130 
ev’t_id
,

3131 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 );

3134 
rc_Ïb–
 = 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
ev’t_id
-1];

3135 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
code
 = 
BTA_AV_RSP_CHANGED
;

3136 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[0].rc_handle;

3137 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

3139 
	`­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
ev’t_id
, &
b§_av_m‘a_r¥_cmd
);

3142 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &= ~evt_mask;

3143 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
ev’t_id
-1] = 0xFF;

3145 
	`APPL_TRACE_DEBUG3
("EVENT NOTIF - Registeredƒvt val‡fter 0x%x clearing:0x%x†abel %d",

3146 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
,ƒvt_mask, 
rc_Ïb–
 );

3153 
	`APPL_TRACE_DEBUG1
("NÙ„egi¡”edƒv’ˆrcvd:0x%x", 
ev’t_id
);

3155 
	}
}

3166 
BOOLEAN
 
	$­p_av_is_ev’t_»gi¡”ed
(
UINT8
 
ev’t_id
)

3168 
tBSA_AV_EVT_MASK
 
evt_mask
 = 1;

3169 
evt_mask
 <<ğ(
ev’t_id
 - 1);

3170 ià(
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &ƒvt_mask)

3171  (
TRUE
);

3173  (
FALSE
);

3174 
	}
}

3185 
	$­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
UINT8
 
ev’t_id
, 
tBSA_AV_META_RSP_CMD
 *
p_b§_av_m‘a_r¥_cmd
)

3187 
¡©us
;

3188 
tBSA_AV_META_ATTRIB
 *
p_·s_©Œib
;

3189 
UINT8
 
xx
;

3190 
UINT8
 *
p
;

3192 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

3194 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
ev’t_id
 =ƒvent_id;

3195 
p_b§_av_m‘a_r¥_cmd
->
pdu
 = 
BSA_AVRC_PDU_REGISTER_NOTIFICATION
;

3197 
ev’t_id
)

3199 
AVRC_EVT_PLAY_STATUS_CHANGE
:

3200 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.play_status.play_status;

3203 
AVRC_EVT_TRACK_CHANGE
:

3204 
p
 = 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
Œack
;

3205 
	`APPL_TRACE_DEBUG2
("¶ay_couÁ %d cur_¶ay %d",
p_b§_av_cb
->
¶ay_couÁ
,…_b§_av_cb->
cur_¶ay
);

3207 ià(
p_b§_av_cb
->
¶ay_couÁ
 == 0 )

3210 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NO_NOW_PLAYING_FOLDER_ID
);

3211 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NO_NOW_PLAYING_FILE_ID
);

3216 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NOW_PLAYING_FOLDER_ID
);

3217 
	`UINT32_TO_BE_STREAM
(
p
, 
p_b§_av_cb
->
cur_¶ay
+1);

3221 
AVRC_EVT_TRACK_REACHED_END
:

3222 
AVRC_EVT_TRACK_REACHED_START
:

3225 
AVRC_EVT_PLAY_POS_CHANGED
:

3226 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay_pos
 = 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.
sÚg_pos
;

3229 
AVRC_EVT_BATTERY_STATUS_CHANGE
:

3230 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
b©‹ry_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
nÙif_šfo
.
b©_¡©
;

3233 
AVRC_EVT_SYSTEM_STATUS_CHANGE
:

3234 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
sy¡em_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
nÙif_šfo
.
sys_¡©
;

3237 
AVRC_EVT_APP_SETTING_CHANGE
:

3238 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
num_©Œ
 = 
p_b§_av_cb
->
m‘a_šfo
.
max_©Œib_num
;

3239 
p_·s_©Œib
 = &
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
;

3240 
xx
=0; xx<
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
num_©Œ
; xx++)

3242 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
©Œ_id
[
xx
] = 
p_·s_©Œib
->
©Œib_id
;

3243 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
©Œ_v®ue
[
xx
] = 
p_·s_©Œib
->
cu¼_v®ue
;

3244 
p_·s_©Œib
++;

3248 
AVRC_EVT_NOW_PLAYING_CHANGE
:

3249 
AVRC_EVT_AVAL_PLAYERS_CHANGE
:

3252 
AVRC_EVT_ADDR_PLAYER_CHANGE
:

3253 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
addr_¶ay”
.
¶ay”_id
 = 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
;

3255 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
addr_¶ay”
.
uid_couÁ”
 = 
p_b§_av_cb
->
m‘a_šfo
.
cur_uid_couÁ”
;

3258 
AVRC_EVT_UIDS_CHANGE
:

3259 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
uid_couÁ”
 = 0;

3262 
AVRC_EVT_VOLUME_CHANGE
:

3263 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
vŞume
 = 0;

3267 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
¡©us
 = 
BTA_AV_RSP_NOT_IMPL
;

3272 
¡©us
 = 
	`BSA_AvM‘aR¥
(
p_b§_av_m‘a_r¥_cmd
);

3273 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3275 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

3276  
¡©us
;

3279 
	`APPL_TRACE_DEBUG1
("­p_av_bud_nÙifiÿtiÚ_»¥Ú£ %d", 
ev’t_id
)

3281 
	}
}

3293 
	$­p_av_rc_chªge_¶ay_¡©us
(
UINT8
 
Ãw_¶ay_¡©us
)

3295 if(
Ãw_¶ay_¡©us
 <ğ(
UINT8
)
AVRC_PLAYSTATE_REV_SEEK
)

3297 
UINT8
 
Şd_¶ay_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status;

3299 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.¶ay_¡©u ğ
Ãw_¶ay_¡©us
;

3300 
	`APPL_TRACE_DEBUG2
("¶ay_¡©u ğ%d/%d", 
Şd_¶ay_¡©us
, 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status );

3301 ià(
Şd_¶ay_¡©us
 !ğ
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status)

3303 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_PLAY_STATUS_CHANGE
);

3304 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_PLAY_POS_CHANGED
);

3309 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoà¶ay_¡©u ğ%d", 
Ãw_¶ay_¡©us
);

3312 
	}
}

3324 
	$­p_av_rc_chªge_Œack
()

3326 
p_b§_av_cb
->
m‘a_šfo
.
Œack_num
++;

3327 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_TRACK_CHANGE
);

3328 
	}
}

3340 
	$­p_av_rc_add»s£d_¶ay”_chªge
(
UINT16
 
addr_¶ay”
)

3343 if((
addr_¶ay”
 !ğ
BSA_AV_PLAYER_ID_FILES
) &&

3344 (
addr_¶ay”
 !ğ
BSA_AV_PLAYER_ID_MPLAYER
)

3347 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoàadd»s£d…Ïy” = %d", 
addr_¶ay”
);

3351 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 
addr_¶ay”
;

3352 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_ADDR_PLAYER_CHANGE
);

3353 
	}
}

3365 
	$­p_av_rc_£‰šgs_chªge
(
UINT8
 
£‰šg
, UINT8 
v®ue
)

3368 if(
£‰šg
 !ğ
AVRC_PLAYER_SETTING_EQUALIZER
 &&

3369 
£‰šg
 !ğ
AVRC_PLAYER_SETTING_REPEAT
 &&

3370 
£‰šg
 !ğ
AVRC_PLAYER_SETTING_SHUFFLE
)

3372 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoà£‰šg = %d", 
£‰šg
);

3377 if(
v®ue
 != 0x1 && value != 0x2)

3379 
	`APPL_TRACE_ERROR1
("IÎeg® s‘tšg v®uğ%d", 
v®ue
);

3383 
£‰šg
)

3386 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
cu¼_v®ue
 = 
v®ue
;

3389 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 
v®ue
;

3392 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 
v®ue
;

3396 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_APP_SETTING_CHANGE
);

3397 
	}
}

3409 
	$­p_av_š™_m‘a_d©a
()

3411 if(
p_b§_av_cb
 =ğ
NULL
)

3412 
p_b§_av_cb
 = 
	`m®loc
((
tBSA_AV_CB
));

3414 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œib_id
 = 1;

3415 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
cu¼_v®ue
 = 1;

3417 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œib_¡r
, "Equalizer");

3418 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œ_£‰šgs
[0].
v®1
, "Off");

3419 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œ_£‰šgs
[1].
v®2
, "On");

3421 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œib_id
 = 2;

3422 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 2;

3424 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œib_¡r
, "Repeat");

3425 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œ_£‰šgs
[0].
v®1
, "Repeat Off");

3426 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œ_£‰šgs
[1].
v®2
, "Repeat Single");

3428 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œib_id
 = 3;

3429 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
cu¼_v®ue
 = 2;

3431 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œib_¡r
, "Shuffle");

3432 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œ_£‰šgs
[0].
v®1
, "Shuffle Off");

3433 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œ_£‰šgs
[1].
v®2
, "Shuffle All");

3435 
p_b§_av_cb
->
m‘a_šfo
.
max_©Œib_num
 = 3;

3437 
	`memıy
(&
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
, &
¶ay¡
, (
tBSA_AV_META_PLAYSTAT
));

3439 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 1;

3440 
p_b§_av_cb
->
m‘a_šfo
.
brow£d_¶ay”_id
 = 1;

3441 
p_b§_av_cb
->
m‘a_šfo
.
cur_uid_couÁ”
 = 0;

3442 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 = 0;

3443 
p_b§_av_cb
->
m‘a_šfo
.
Œack_num
 = 1;

3444 
p_b§_av_cb
->
cur_¶ay
 = 0;

3445 
p_b§_av_cb
->
¶ay_couÁ
 = 
BSA_AV_NUMSONGS
;

3447 
	}
}

3458 
	$­p_av_rc_şo£
(
šdex
)

3460 
¡©us
;

3461 
tBSA_AV_CLOSE_RC
 
b§_av_şo£_rc
;

3464 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

3466 
	`APP_ERROR0
("Connection index out of bounds");

3471 
¡©us
 = 
	`BSA_AvClo£RcIn™
(&
b§_av_şo£_rc
);

3472 
b§_av_şo£_rc
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

3473 
¡©us
 = 
	`BSA_AvClo£Rc
(&
b§_av_şo£_rc
);

3474 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3476 
	`APP_ERROR1
("BSA_AvClo£Røçed: %d", 
¡©us
);

3477  
¡©us
;

3481 
	}
}

3492 
	$­p_š™_¶ayli¡
(*
·th
)

3494 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3495 
šdex
;

3497 
­p_av_cb
.
soundfe_li¡_size
 = 
	`­p_¶ayli¡_ü—‹
(
·th
, &­p_av_cb.
soundfe_li¡
);

3498 ià(
­p_av_cb
.
soundfe_li¡_size
 <= 0)

3500 
	`APP_ERROR1
("UÇbËØš™…Ïy†i¡ from:%s", 
·th
);

3504 
šdex
 = 0 ; index < 
­p_av_cb
.
soundfe_li¡_size
 ; index++)

3506 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
šdex
], &
wav_fÜm©
) < 0)

3508 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3512 
	`APP_INFO1
("WAV fÜm© of: %s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3513 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

3514 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

3518  
­p_av_cb
.
soundfe_li¡_size
;

3519 
	}
}

3530 *
	$­p_av_g‘_soundfe_·th
(
fe_šdex
)

3532 ià((
fe_šdex
 >ğ0è&& (fe_šdex < 
­p_av_cb
.
soundfe_li¡_size
))

3534  
­p_av_cb
.
soundfe_li¡
[
fe_šdex
];

3536  
NULL
;

3537 
	}
}

3548 
	$­p_av_di¥Ïy_¶ayli¡
()

3550 
šdex
;

3551 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3553 
	`APP_INFO0
("Play†ist:");

3554 
šdex
 = 0 ; index < 
­p_av_cb
.
soundfe_li¡_size
 ; index++)

3556 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
šdex
], &
wav_fÜm©
) < 0)

3558 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3562 
	`APP_INFO1
(" %d : %s", 
šdex
, 
­p_av_cb
.
soundfe_li¡
[index]);

3563 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

3564 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

3567  
­p_av_cb
.
soundfe_li¡_size
;

3568 
	}
}

3579 
BOOLEAN
 
	$­p_av_check_ãedšg
(cÚ¡ 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
)

3581 ià(
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
 =ğ
p_fÜm©
->
codec
)

3583 
p_fÜm©
->
codec
)

3585 
BSA_AV_CODEC_PCM
:

3586  (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 =ğ
p_fÜm©
->
nb_chªÃls
) &&

3587 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 =ğ
p_fÜm©
->
§m¶e_¿‹
) &&

3588 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 =ğ
p_fÜm©
->
b™s_³r_§m¶e
);

3590 
BSA_AV_CODEC_APTX
:

3591  (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 =ğ
p_fÜm©
->
§m¶e_¿‹
) &&

3592 (((
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 =ğ
A2D_SBC_IE_CH_MD_MONO
)?1:2è=ğ
p_fÜm©
->
nb_chªÃls
);

3595 
	`APP_DEBUG0
("Unsupported codec format");

3596  
FALSE
;

3601 
	`APP_ERROR0
("Feeding does‚ot match!!!");

3602  
FALSE
;

3604 
	}
}

3615 
	$­p_uc_tx_th»ad
()

3617 
¡©us
;

3618 
nb_by‹s
 = 0;

3619 
fe_desc
 = -1;

3620 
time¥ec
 
Ãwtime
;

3621 
time_t
 
¡¬t
, 
–­£d
;

3622 
tAPP_AV_DELAY
 
d–ay
;

3623 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3624 
UINT16
 
uc_”rÜ
 = 0;

3625 
»Œy_times
=0;

3627 
	`APP_DEBUG0
("Starting UIPC Txhread");

3630 
	`APP_DEBUG0
("Waiting for…lay start");

3632 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STARTED
)

3635 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3636 ià(
¡©us
 < 0)

3638 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

3642 
	`APP_DEBUG0
("Play started");

3644 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_TONE
)

3646 
	`APP_DEBUG0
("Playingone");

3648 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_AVK
)

3650 
	`APP_DEBUG0
("Playing from‡vk source");

3652 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

3654 
	`APP_DEBUG1
("PÏyšg f%s", 
­p_av_cb
.
fe_Çme
);

3656 
fe_desc
 = 
	`­p_wav_İ’_fe
(
­p_av_cb
.
fe_Çme
, &
wav_fÜm©
);

3657 ià(
fe_desc
 < 0)

3659 
	`APP_ERROR1
("İ’(%sèçed(%dè-> Stİ…Ïyšg", 
­p_av_cb
.
fe_Çme
, 
”ºo
);

3660 ià(
	`­p_av_¡İ
() != 0)

3666 
	`APP_DEBUG0
("Waiting for AVo stop");

3667 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3672 ià(
	`­p_av_check_ãedšg
(&
wav_fÜm©
è=ğ
FALSE
)

3674 
	`APP_ERROR1
("F“dšg‚Ù com·tibË w™h fe: %s", 
­p_av_cb
.
fe_Çme
);

3675 
	`şo£
(
fe_desc
);

3676 ià(
	`­p_av_¡İ
() != 0)

3682 
	`APP_DEBUG0
("Waiting for AVo stop");

3683 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3685 ià(
	`­p_av_¶ay_¶ayli¡
(
APP_AV_START
) != 0)

3691 
	`APP_DEBUG0
("Playing file successfully");

3693 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_MIC
)

3695 
	`APP_DEBUG0
("Playing MIC Input");

3696 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3697 
	`APP_DEBUG0
("APP_AV_PLAYTYPE_MIC Streaming start");

3702 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_TEST
)

3704 
	`APP_DEBUG0
("Playingest data");

3709 
	`­p_av_d–ay_¡¬t
(&
d–ay
);

3710 
–­£d
 = 0;

3711 
¡¬t
 = 
d–ay
.
time¡amp
.
tv_£c
;

3714 
­p_av_cb
.
¶ay_ty³
)

3716 
APP_AV_PLAYTYPE_TONE
:

3717 
	`­p_av_»ad_tÚe
(
­p_av_cb
.
audio_buf
,‡µ_av_cb.
uc_cfg
.
Ëngth
,

3718 
­p_av_cb
.
sšus_ty³
, &­p_av_cb.
sšus_šdex
);

3719 
nb_by‹s
 = 
­p_av_cb
.
uc_cfg
.
Ëngth
;

3721 
APP_AV_PLAYTYPE_TEST
:

3722 
	`­p_av_»ad_‹¡
(
­p_av_cb
.
audio_buf
,‡µ_av_cb.
£c_äame_size
);

3723 
nb_by‹s
 = 
­p_av_cb
.
£c_äame_size
;

3725 
APP_AV_PLAYTYPE_FILE
:

3726 
nb_by‹s
 = 
	`­p_wav_»ad_d©a
(
fe_desc
, &
wav_fÜm©
, (*)
­p_av_cb
.
audio_buf
,‡µ_av_cb.
uc_cfg
.
Ëngth
);

3728 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3729 
APP_AV_PLAYTYPE_MIC
:

3732 if(
mIng’icA2dpSock‘Fd
 < 0){

3734 
	`APP_DEBUG1
("sock‘ i discÚÃùed,wa™„ecÚÃù,%d(100ms)", ++
»Œy_times
);

3735 
	`šg’ic_a2dp_İ’
();

3736 
	`u¦“p
(100*1000);

3737 
nb_by‹s
 = 0;

3738 if(((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
) &&

3739 (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPING
)))

3742 
»Œy_times
 = 0;

3744 
nb_by‹s
 = 
	`»cv
(
mIng’icA2dpSock‘Fd
, 
­p_av_cb
.
audio_buf
,

3745 
­p_av_cb
.
uc_cfg
.
Ëngth
, 
MSG_NOSIGNAL
);

3750 
APP_AV_PLAYTYPE_AVK
:

3751 
nb_by‹s
 = 0;

3755 
	`APP_ERROR0
("Unsupported…lay_type");

3760 ià(
nb_by‹s
 <= 0)

3762 ià(
­p_av_cb
.
¶ay_ty³
 !ğ
APP_AV_PLAYTYPE_AVK
)

3764 
	`APP_DEBUG1
("NØmÜ§m¶e -> stİpšg cu¼’t,nb_by‹s:%d,”r:%s.”ºo:%d",
nb_by‹s
,
	`¡»¼Ü
(
”ºo
),errno);

3767 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3768 
	`APP_INFO1
("šg’ic_a2dp_discÚÃù", 
__func__
);

3769 
	`šg’ic_a2dp_discÚÃù
();

3777 ià(
	`UIPC_S’d
(
­p_av_cb
.
¡»am_uc_chªÃl
, 0, (
UINT8
 *è­p_av_cb.
audio_buf
, 
nb_by‹s
è=ğ
FALSE
)

3779 if(
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
UIPC_READ_ERROR
, &
uc_”rÜ
))

3781 ià(
uc_”rÜ
 =ğ
UIPC_ENOMEM
)

3783 
	`APP_DEBUG0
("UIPC buffer full! Pause…laying");

3784 
	`­p_av_·u£
();

3785 
	`GKI_d–ay
(3000);

3786 
	`APP_DEBUG0
("UIPC buffer full! Resume…laying");

3787 
	`­p_av_»sume
();

3791 
	`APP_ERROR0
("UIPC_Send failed");

3795 #ià(
	`defšed
(
BSA_AV_DUMP_TX_DATA
è&& (BSA_AV_DUMP_TX_DATA =ğ
TRUE
))

3796 
	`APP_DUMP
("A2DP D©a", (
UINT8
 *è
­p_av_cb
.
audio_buf
, 
nb_by‹s
);

3799 ià(
­p_av_cb
.
uc_cfg
.
is_blockšg
 =ğ
FALSE
)

3802 
	`­p_av_wa™_d–ay
(1, &
d–ay
, &
­p_av_cb
.
uc_cfg
);

3806 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
Ãwtime
);

3807 ià((
Ãwtime
.
tv_£c
 - 
¡¬t
è> 
–­£d
)

3809 
–­£d
 = 
Ãwtime
.
tv_£c
 - 
¡¬t
;

3810 
	`APP_DEBUG1
("SŒ—mšg fÜ %d secs", 
–­£d
);

3814 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
)

3816 
	`APP_DEBUG0
("Pausing (wait mutex)");

3817 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3818 ià(
¡©us
 < 0)

3820 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

3825 
	`­p_av_d–ay_¡¬t
(&
d–ay
);

3826 
–­£d
 = 0;

3828 
	`APP_DEBUG0
("Un-pausing");

3831 } (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
) &&

3832 (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPING
));

3834 
	`APP_DEBUG0
("Streaming stopped");

3837 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

3839 
	`şo£
(
fe_desc
);

3841 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3842 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_MIC
)

3844 
	`APP_DEBUG0
("APP_AV_PLAYTYPE_MIC Streaming stopped");

3851 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3854 ià(
­p_av_cb
.
¶ay_li¡
)

3857 
	`­p_av_¶ay_¶ayli¡
(
APP_AV_FORWARD
);

3860 
	`APP_DEBUG0
("Exit");

3861 
	`±h»ad_ex™
(
NULL
);

3862 
	}
}

3873 
	$­p_av_»gi¡”
()

3875 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

3876 
tBSA_STATUS
 
¡©us
;

3877 
tBSA_AV_REGISTER
 
»gi¡”_·¿m
;

3880 
šdex
;

3881 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
 ; index++)

3883 ià(!
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_»gi¡”ed
) {

3884 
cÚÃùiÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

3887 
	`BSA_AvRegi¡”In™
(&
»gi¡”_·¿m
);

3888 
¡©us
 = 
	`BSA_AvRegi¡”
(&
»gi¡”_·¿m
);

3889 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3891 
	`APP_ERROR1
("BSA_AvRegi¡” faed: %d", 
¡©us
);

3894 
cÚÃùiÚ
->
is_»gi¡”ed
 = 
TRUE
;

3895 
cÚÃùiÚ
->
hªdË
 = 
»gi¡”_·¿m
.handle;

3897 ià(
­p_av_cb
.
¡»am_uc_chªÃl
 =ğ
UIPC_CH_ID_BAD
)

3900 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
»gi¡”_·¿m
.
uc_chªÃl
;

3902 ià(
	`UIPC_O³n
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
NULL
è=ğ
FALSE
)

3904 
	`APP_ERROR1
("UIPC_O³Àçed: %d", 
¡©us
);

3909 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
UIPC_WRITE_BLOCK
, 
NULL
))

3911 
	`APP_ERROR0
("Failed settinghe UIPC‚on blocking");

3917 ià(
»gi¡”_·¿m
.
uc_chªÃl
 !ğ
­p_av_cb
.
¡»am_uc_chªÃl
)

3919 
	`APP_ERROR1
("UIPC channel differs between„egister %d != %d",

3920 
»gi¡”_·¿m
.
uc_chªÃl
, 
­p_av_cb
.
¡»am_uc_chªÃl
);

3925 
	`­p_av_di¥Ïy_cÚÃùiÚs
();

3927 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
FALSE
, FALSE);

3929 ià(
cÚÃùiÚ
 =ğ
NULL
)

3931 
	`APP_ERROR0
("All‡vailable connections‡lready„egistered");

3936 
	`BSA_AvRegi¡”In™
(&
»gi¡”_·¿m
);

3937 
¡©us
 = 
	`BSA_AvRegi¡”
(&
»gi¡”_·¿m
);

3938 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3940 
	`APP_ERROR1
("BSA_AvRegi¡” faed: %d", 
¡©us
);

3943 
cÚÃùiÚ
->
is_»gi¡”ed
 = 
TRUE
;

3944 
cÚÃùiÚ
->
hªdË
 = 
»gi¡”_·¿m
.handle;

3946 ià(
­p_av_cb
.
¡»am_uc_chªÃl
 =ğ
UIPC_CH_ID_BAD
)

3949 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
»gi¡”_·¿m
.
uc_chªÃl
;

3951 ià(
	`UIPC_O³n
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
NULL
è=ğ
FALSE
)

3953 
	`APP_ERROR1
("UIPC_O³Àçed: %d", 
¡©us
);

3958 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
UIPC_WRITE_BLOCK
, 
NULL
))

3960 
	`APP_ERROR0
("Failed settinghe UIPC‚on blocking");

3966 ià(
»gi¡”_·¿m
.
uc_chªÃl
 !ğ
­p_av_cb
.
¡»am_uc_chªÃl
)

3968 
	`APP_ERROR1
("UIPC channel differs between„egister %d != %d",

3969 
»gi¡”_·¿m
.
uc_chªÃl
, 
­p_av_cb
.
¡»am_uc_chªÃl
);

3972 
	`­p_av_di¥Ïy_cÚÃùiÚs
();

3976 
	}
}

3987 
	$­p_av_d”egi¡”
(
šdex
)

3989 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

3990 
tBSA_AV_DEREGISTER
 
d”egi¡”_·¿m
;

3991 
tBSA_STATUS
 
¡©us
;

3994 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

3996 
	`APP_ERROR0
("Connection index out of bounds");

4000 
cÚÃùiÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

4001 ià(!
cÚÃùiÚ
->
is_»gi¡”ed
)

4003 
	`APP_ERROR1
("cÚÃùiÚ index %d‚Ù„egi¡”ed", 
šdex
);

4010 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

4013 
	`BSA_AvD”egi¡”In™
(&
d”egi¡”_·¿m
);

4014 
d”egi¡”_·¿m
.
hªdË
 = 
cÚÃùiÚ
->handle;

4015 
¡©us
 = 
	`BSA_AvD”egi¡”
(&
d”egi¡”_·¿m
);

4016 if(
¡©us
 !ğ
BSA_SUCCESS
)

4018 
	`APP_ERROR1
("BSA_AvD”egi¡” faed stus=%d", 
¡©us
);

4021 
cÚÃùiÚ
->
is_»gi¡”ed
 = 
FALSE
;

4023 
	}
}

4034 
	$­p_av_š™
(
BOOLEAN
 
boÙ
)

4036 
tBSA_AV_ENABLE
 
’abË_·¿m
;

4037 
¡©us
;

4038 
tBSA_STATUS
 
b§¡©us
;

4041 
	`mem£t
(&
­p_av_cb
, 0, (app_av_cb));

4042 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

4043 
­p_av_cb
.
tÚe_§m¶e_äeq
 = 48000;

4046 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_NONE
;

4047 
­p_av_cb
.
ı_scms_æag
 = 0x00;

4051 ià(
boÙ
)

4056 
¡©us
 = 
	`­p_š™_mu‹x
(&
­p_¡»am_tx_mu‹x
);

4057 ià(
¡©us
 < 0)

4061 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

4062 ià(
¡©us
 < 0)

4066 
¡©us
 = 
	`­p_ü—‹_th»ad
(
­p_uc_tx_th»ad
, 0, 0, &
­p_uc_tx_th»ad_¡ruù
);

4067 ià(
¡©us
 < 0)

4069 
	`APP_ERROR1
("­p_ü—‹_th»ad faed: %d", 
¡©us
);

4075 
­p_av_cb
.
uc_cfg
.
is_blockšg
 = 
TRUE
;

4078 
	`­p_š™_¶ayli¡
("./test_files/av");

4079 ià(
­p_av_cb
.
soundfe_li¡_size
 > 0)

4081 
	`APP_INFO1
("­p_av_cb.soundfe_li¡_size:%d", 
­p_av_cb
.
soundfe_li¡_size
);

4083 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[0], (app_av_cb.file_name)-1);

4084 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

4088 
	`BSA_AvEÇbËIn™
(&
’abË_·¿m
);

4090 
’abË_·¿m
.
p_cback
 = 
­p_av_cback
;

4093 
’abË_·¿m
.
­tx_ÿps
 =‡ptx_caps;

4096 
’abË_·¿m
.
£c_ÿps
 = sec_caps;

4099 
’abË_·¿m
.
ã©u»s
 = 
APP_AV_FEAT_MASK
;

4101 
b§¡©us
 = 
	`BSA_AvEÇbË
(&
’abË_·¿m
);

4102 ià(
b§¡©us
 !ğ
BSA_SUCCESS
)

4104 
	`APP_ERROR1
("BSA_AvEÇbË faed: %d", 
b§¡©us
);

4108 #ifdeà
APP_AV_BCST_INCLUDED


4110 
	`­p_av_bc¡_š™
();

4114 
	`­p_av_š™_m‘a_d©a
();

4116 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPED
;

4118 #ifdeà
USE_INGENIC_AUDIO_SOCKET


4119 if(
mIng’icA2dpSock‘Fd
 <=0)

4120 
	`APP_DEBUG0
("CALL ingenic_a2dp_connect");

4121 
	`šg’ic_a2dp_cÚÃù
();

4124 
	}
}

4135 
	$­p_av_’d
()

4137 
šdex
;

4138 
tBSA_AV_DISABLE
 
di§bË_·¿m
;

4141 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STARTED
)

4144 
	`­p_av_¡İ
();

4147 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

4149 
	`GKI_d–ay
(10);

4154 ià(
­p_av_cb
.
¡»am_uc_chªÃl
 !ğ
UIPC_CH_ID_BAD
)

4156 
	`APP_INFO0
("Closing UIPC Channel");

4157 
	`UIPC_Clo£
(
­p_av_cb
.
¡»am_uc_chªÃl
);

4158 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

4162 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
 ; index++)

4164 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_»gi¡”ed
)

4166 
	`­p_av_d”egi¡”
(
šdex
);

4170 #ifdeà
APP_AV_BCST_INCLUDED


4172 
	`­p_av_bc¡_’d
();

4176 
	`BSA_AvDi§bËIn™
(&
di§bË_·¿m
);

4177 
iR‘
 = 
	`BSA_AvDi§bË
(&
di§bË_·¿m
);

4179 if(
p_b§_av_cb
 !ğ
NULL
)

4181 
	`ä“
(
p_b§_av_cb
);

4182 
p_b§_av_cb
 = 
NULL
;

4185  
iR‘
;

4187 
	}
}

4198 
BOOLEAN
 
	$­p_av_is_·ddšg_acû±abË
(
Ëngth
, 
tBSA_AV_MEDIA_FEEDINGS
 *
p_medŸ_ãedšg
)

4200 
·ddšg
;

4202 
p_medŸ_ãedšg
->
fÜm©
)

4204 
BSA_AV_CODEC_PCM
:

4206 
·ddšg
 = 
p_medŸ_ãedšg
->
cfg
.
pcm
.
b™_³r_§m¶e
 *

4207 
p_medŸ_ãedšg
->
cfg
.
pcm
.
num_chªÃl
 / 8;

4210 
BSA_AV_CODEC_APTX
:

4212 
·ddšg
 = 2;

4213 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4215 
·ddšg
 *= 2;

4219 
BSA_AV_CODEC_SEC
:

4221 
·ddšg
 = 2;

4222 ià(
p_medŸ_ãedšg
->
cfg
.
£c
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4224 
·ddšg
 *= 2;

4229 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
);

4230  
TRUE
;

4234 ià(
·ddšg
 == 1)

4236 
	`APP_DEBUG1
("·ck‘ size:%d ok (8 b™ ®igÃd)", 
Ëngth
);

4237  
TRUE
;

4240 ià((
·ddšg
 =ğ2è&& ((
Ëngth
 & 0x01) == 0))

4242 
	`APP_DEBUG1
("·ck‘ size:%d i ok (16 b™ ®igÃd)", 
Ëngth
);

4243  
TRUE
;

4246 ià((
·ddšg
 =ğ4è&& ((
Ëngth
 & 0x03) == 0))

4248 
	`APP_DEBUG1
("·ck‘ size:%d i ok (32 b™ ®igÃd)", 
Ëngth
);

4249  
TRUE
;

4253 
	`APP_DEBUG1
("·ck‘ size:%d dÛ nÙ f™‡lignm’t", 
Ëngth
);

4255  
FALSE
;

4256 
	}
}

4267 
	$­p_av_compu‹_uc_·¿m
(
tAPP_AV_UIPC
 *
p_uc_cfg
, 
tBSA_AV_MEDIA_FEEDINGS
 *
p_medŸ_ãedšg
)

4269 
by‹s_³r_£c
;

4270 
tmp
;

4271 
»mašd”
;

4273 
	`APP_DEBUG0
("app_av_compute_uipc_param");

4275 ià(
p_uc_cfg
->
is_blockšg
)

4281 
p_uc_cfg
->
Ëngth
 = 
APP_AV_MAX_AUDIO_BUF
 * 2;

4283 
	`APP_DEBUG1
("UIPC is in blocking mode,‚o‚eedo compute UIPC…arams†ength=%d",

4284 
p_uc_cfg
->
Ëngth
);

4289 
p_medŸ_ãedšg
->
fÜm©
)

4291 
BSA_AV_CODEC_PCM
:

4292 
by‹s_³r_£c
 = 
p_medŸ_ãedšg
->
cfg
.
pcm
.
b™_³r_§m¶e
 / 8;

4293 
by‹s_³r_£c
 *ğ
p_medŸ_ãedšg
->
cfg
.
pcm
.
num_chªÃl
;

4294 
by‹s_³r_£c
 *ğ
p_medŸ_ãedšg
->
cfg
.
pcm
.
§m¶šg_äeq
;

4296 
BSA_AV_CODEC_APTX
:

4301 
by‹s_³r_£c
 = 2 * 
p_medŸ_ãedšg
->
cfg
.
­tx
.
§m¶šg_äeq
;

4302 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4304 
by‹s_³r_£c
 *= 2;

4306 
by‹s_³r_£c
 = bytes_per_sec/4;

4308 
BSA_AV_CODEC_SEC
:

4313 
by‹s_³r_£c
 = 2 * 
p_medŸ_ãedšg
->
cfg
.
£c
.
§m¶šg_äeq
;

4314 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4316 
by‹s_³r_£c
 *= 2;

4318 
by‹s_³r_£c
 = bytes_per_sec/4;

4322 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
p_medŸ_ãedšg
->
fÜm©
);

4323 
by‹s_³r_£c
 = 0;

4326 
	`APP_DEBUG1
("by‹s_³r_£c:%d", 
by‹s_³r_£c
);

4329 
	`APP_DEBUG1
("U£¸asked fÜ‡ s³cifiøP”iod:%d", 
p_uc_cfg
->
asked_³riod
);

4331 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4335 
tmp
 = ()
by‹s_³r_£c
 * ()
p_uc_cfg
->
³riod
 / 1000000.0;

4337 
»mašd”
 = 
tmp
 - ()tmp;

4338 ià(
»mašd”
)

4345 
p_uc_cfg
->
Ëngth
 = ()
tmp
;

4346 ià(
	`­p_av_is_·ddšg_acû±abË
(
p_uc_cfg
->
Ëngth
, 
p_medŸ_ãedšg
è=ğ
TRUE
)

4352 
p_uc_cfg
->
³riod
--;

4353 } 
p_uc_cfg
->
³riod
 >ğ
APP_AV_PERIOD_MIN
);

4356 ià(
p_uc_cfg
->
³riod
 < 
APP_AV_PERIOD_MIN
)

4359 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4363 
tmp
 = ()
by‹s_³r_£c
 * ()
p_uc_cfg
->
³riod
 / 1000000.0;

4365 
»mašd”
 = 
tmp
 - ()tmp;

4366 ià(
»mašd”
)

4373 
p_uc_cfg
->
Ëngth
 = ()
tmp
;

4374 ià(
	`­p_av_is_·ddšg_acû±abË
(
p_uc_cfg
->
Ëngth
, 
p_medŸ_ãedšg
è=ğ
TRUE
)

4380 
p_uc_cfg
->
³riod
++;

4381 } 
p_uc_cfg
->
³riod
 <ğ
APP_AV_PERIOD_MAX
);

4384 ià(
p_uc_cfg
->
³riod
 > 
APP_AV_PERIOD_MAX
)

4386 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4388 
p_uc_cfg
->
Ëngth
 = 
by‹s_³r_£c
 *…_uc_cfg->
³riod
 / 1000000.0;

4389 
	`APP_DEBUG0
("Not‡bleo find…eriod matching‡lignment");

4390 
	`APP_DEBUG1
("L‘' u£…”iod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4395 
	`APP_DEBUG0
("Found…eriod/length matching‡lignment");

4396 
	`APP_DEBUG1
("³riod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4402 
	`APP_DEBUG0
("Found…eriod/length matching‡lignment");

4403 
	`APP_DEBUG1
("³riod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4408 
	}
}

4419 
	$­p_av_uc_»cÚfig
()

4421 
UINT32
 
uc_mode
;

4423 
	`­p_av_compu‹_uc_·¿m
(&
­p_av_cb
.
uc_cfg
, &­p_av_cb.
medŸ_ãedšg
);

4425 ià(
­p_av_cb
.
uc_cfg
.
is_blockšg
)

4427 
uc_mode
 = 
UIPC_WRITE_BLOCK
;

4431 
uc_mode
 = 
UIPC_WRITE_NONBLOCK
;

4434 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
uc_mode
, 
NULL
))

4436 
	`APP_ERROR0
("Failed settinghe UIPC (non) blocking");

4441 
	}
}

4452 
	$­p_av_ask_uc_cÚfig
()

4454 
choiû
;

4455 
tAPP_AV_UIPC
 
uc_cfg
;

4456 
UINT32
 
uc_mode
 = 
UIPC_WRITE_BLOCK
;

4459 ià(
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

4461 
	`APP_INFO0
("Could‚ot…erformhis operation,…lease stophe stream first");

4466 ià((
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 == 0) ||

4467 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 == 0) ||

4468 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 == 0))

4470 
	`APP_INFO0
("AV‚ot yet started =>†et's use default values‡s feedingƒxample (PCM, 48kHz, 16bits, Stereo)");

4472 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

4473 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 48000;

4474 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

4475 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

4479 
uc_cfg
.
is_blockšg
 = 
TRUE
;

4480 
uc_cfg
.
asked_³riod
 = 0;

4481 
uc_cfg
.
³riod
 = 0;

4482 
uc_cfg
.
Ëngth
 = 0;

4484 
	`APP_INFO0
("UIPC blocking/non blocking mode:");

4485 
	`APP_INFO0
(" 0 Blocking mode (default)");

4486 
	`APP_INFO0
(" 1 Non blocking mode");

4487 
choiû
 = 
	`­p_g‘_choiû
("");

4488 ià(
choiû
 == 0)

4490 
uc_cfg
.
is_blockšg
 = 
TRUE
;

4491 
	`APP_INFO0
("UIPC Blocking mode selected");

4493 ià(
choiû
 == 1)

4495 
	`APP_INFO0
("UIPC Non Blocking mode selected");

4496 
uc_cfg
.
is_blockšg
 = 
FALSE
;

4497 
uc_mode
 = 
UIPC_WRITE_NONBLOCK
;

4498 
choiû
 = 
	`­p_g‘_choiû
("Enter Period (in micro)");

4499 ià(
choiû
 < 0)

4501 
	`APP_ERROR1
("Bad…”iod:%d", 
choiû
);

4504 
uc_cfg
.
asked_³riod
 = 
choiû
;

4508 
	`APP_ERROR1
("Bad UIPC mode:%d", 
choiû
);

4512 
	`­p_av_compu‹_uc_·¿m
(&
uc_cfg
, &
­p_av_cb
.
medŸ_ãedšg
);

4514 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
uc_mode
, 
NULL
))

4516 
	`APP_ERROR0
("Failed settinghe UIPC (non) blocking");

4517 
	`APP_DEBUG0
("It will be configured during‚ext AV stop/start");

4521 
	`memıy
(&
­p_av_cb
.
uc_cfg
, &uipc_cfg, (app_av_cb.uipc_cfg));

4525 
	}
}

4536 
	#APP_AV_TIMESPEC_ADD
(
__t1
, 
__t2
) \

4538 
__t1
.
tv_£c
 +ğ
__t2
.tv_sec; \

4539 
__t1
.
tv_n£c
 +ğ
__t2
.tv_nsec; \

4540 ià(
	`BCM_UNLIKELY
(
__t1
.
tv_n£c
 >= 1000000000L)) { \

4541 
__t1
.
tv_£c
++; \

4542 
__t1
.
tv_n£c
 -= 1000000000L; \

4544 } 0)

	)

4562 
	$­p_av_wa™_d–ay
(
couÁ
, 
tAPP_AV_DELAY
 *
p_d–ay
, 
tAPP_AV_UIPC
 *
p_uc_cfg
)

4564 
time¥ec
 
·u£
;

4566 
”r
;

4569 
·u£
.
tv_£c
 = 0;

4570 
·u£
.
tv_n£c
 = 
p_uc_cfg
->
³riod
 * 1000;

4572 
couÁ
--)

4575 
	`APP_AV_TIMESPEC_ADD
(
p_d–ay
->
time¡amp
, 
·u£
);

4578 
”r
 = 
	`şock_Çno¦“p
(
CLOCK_MONOTONIC
, 
TIMER_ABSTIME
, &(
p_d–ay
->
time¡amp
), 
NULL
);

4579 } 
”r
 < 0 && 
”ºo
 =ğ
EINTR
);

4586 
time¥ec
 
aá”
;

4588 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
aá”
);

4589 
	`APP_DEBUG1
("­p_av_wa™_d–ay %d sec; %d‚s", 
aá”
.
tv_£c
,‡á”.
tv_n£c
);

4593 
	}
}

4604 
	$­p_av_d–ay_¡¬t
(
tAPP_AV_DELAY
 *
p_d–ay
)

4607 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &(
p_d–ay
->
time¡amp
));

4608 
p_d–ay
->
timeout
 = 
­p_av_cb
.
uc_cfg
.
³riod
;

4609 
	}
}

4620 
	$­p_av_‹¡_£c_codec
(
BOOLEAN
 
u£_´ev_§mp_äeq
)

4622 
¡©us
, 
choiû
;

4623 
tBSA_AV_START
 
¡¬t_·¿m
;

4625 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

4627 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

4632 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

4633 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_SEC
;

4635 ifĞ
u£_´ev_§mp_äeq
 =ğ
TRUE
)

4637 
choiû
 = 
­p_av_cb
.
‹¡_£c_§mpäeq_šdex
;

4641 
	`APP_INFO0
("Sampling Frequency:");

4642 
	`APP_INFO0
(" 0 - 48kHz");

4643 
	`APP_INFO0
(" 1 - 44.1kHz");

4644 
	`APP_INFO0
(" 2 - 32kHz");

4645 
choiû
 = 
	`­p_g‘_choiû
("");

4646 
­p_av_cb
.
‹¡_£c_§mpäeq_šdex
 = 
choiû
;

4649 if(
choiû
 == 0)

4651 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 48000;

4652 
­p_av_cb
.
£c_äame_size
 = 116;

4654 if(
choiû
 == 1)

4656 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 44100;

4657 
­p_av_cb
.
£c_äame_size
 = 124;

4659 if(
choiû
 == 2)

4661 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 32000;

4662 
­p_av_cb
.
£c_äame_size
 = 176;

4666 
	`APP_ERROR1
("Bad sam¶šg f»qu’cy:%d", 
choiû
);

4670 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
 = 2;

4671 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

4672 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

4674 
	`APP_INFO1
("app_av_test_sec_codec freq:%d, c_m:%d, f_m:%d,lat:%d",

4675 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
,

4676 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
,

4677 
¡¬t_·¿m
.
ãedšg_mode
,

4678 
¡¬t_·¿m
.
Ï‹ncy
);

4680 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_TEST
;

4681 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

4683 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

4684 ià(
¡©us
 !ğ
BSA_SUCCESS
)

4686 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

4687  
¡©us
;

4691 
	}
}

4702 
	$­p_av_chªge_ı
()

4704 
choiû
;

4706 
	`APP_INFO1
("The current Content Protection Id is=%s ScmsFlag=%d",

4707 
	`­p_av_g‘_cu¼’t_ı_desc
(), 
­p_av_cb
.
ı_scms_æag
);

4709 
	`APP_INFO0
("New Content Protection Id:");

4710 
	`APP_INFO0
(" 0 - None");

4711 
	`APP_INFO0
(" 1 - SCMS");

4712 
choiû
 = 
	`­p_g‘_choiû
("");

4713 
choiû
)

4716 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_NONE
;

4717 
­p_av_cb
.
ı_scms_æag
 = 0x00;

4721 
choiû
 = 
	`­p_g‘_choiû
("SCMS Flag/Header 0-Copy Never,1-Copy Once, 2-Copy Free");

4722 if(
choiû
 < 0 || choice >2)

4724 
	`APP_ERROR1
("Inv®id EÁry:%d", 
choiû
);

4727 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_SCMS
;

4728 
­p_av_cb
.
ı_scms_æag
 = (
UINT8
)
choiû
;

4732 
	`APP_ERROR1
("UnknowÀCÚ‹Á PrÙeùiÚ Id=%d", 
choiû
);

4737 
	}
}

4748 *
	$­p_av_g‘_cu¼’t_ı_desc
()

4750 
­p_av_cb
.
ı_id
)

4752 
BSA_AV_CP_ID_NONE
:

4754 
BSA_AV_CP_ID_SCMS
:

4759 
	}
}

4771 
	$­p_av_£t_busy_Ëv–
(
UINT8
 
Ëv–
)

4773 
¡©us
;

4774 
tBSA_AV_BUSY_LEVEL
 
busy_Ëv–
;

4777 
	`BSA_AvBusyLev–In™
(&
busy_Ëv–
);

4778 
busy_Ëv–
.
Ëv–
 =†evel;

4779 
	`APP_INFO1
("­p_av_£t_busy_Ëv–†ev–(0-5):%d", 
Ëv–
);

4780 if(
Ëv–
>5)

4782 
	`APP_ERROR1
("WrÚg v®ue:%d", 
Ëv–
);

4786 
¡©us
 = 
	`BSA_AvBusyLev–
(&
busy_Ëv–
);

4787 ià(
¡©us
 !ğ
BSA_SUCCESS
)

4789 
	`APP_ERROR1
("BSA_AvBusyLev– faed:%d", 
¡©us
);

4790  
¡©us
;

4794 
	}
}

4806 *
	$­p_av_g‘_nÙifiÿtiÚ_¡ršg
(
UINT8
 
commªd
)

4808 
commªd
)

4810 
AVRC_EVT_PLAY_STATUS_CHANGE
:

4812 
AVRC_EVT_TRACK_CHANGE
:

4814 
AVRC_EVT_TRACK_REACHED_END
:

4816 
AVRC_EVT_TRACK_REACHED_START
:

4818 
AVRC_EVT_PLAY_POS_CHANGED
:

4820 
AVRC_EVT_BATTERY_STATUS_CHANGE
:

4822 
AVRC_EVT_SYSTEM_STATUS_CHANGE
:

4824 
AVRC_EVT_APP_SETTING_CHANGE
:

4826 
AVRC_EVT_NOW_PLAYING_CHANGE
:

4828 
AVRC_EVT_AVAL_PLAYERS_CHANGE
:

4830 
AVRC_EVT_ADDR_PLAYER_CHANGE
:

4832 
AVRC_EVT_UIDS_CHANGE
:

4834 
AVRC_EVT_VOLUME_CHANGE
:

4838  
NULL
;

4839 
	}
}

4849 
	$­p_av_£t_cback
(
tAvC®lback
 
pcb
)

4852 
s_pC®lback
 = 
pcb
;

4853 
	}
}

4863 
UINT8
 
	$­p_av_g‘_¶ay_¡©e
()

4865  
­p_av_cb
.
¶ay_¡©e
;

4866 
	}
}

4869 
UINT8
 
	$­p_av_g‘_¶ay_ty³
()

4871  
­p_av_cb
.
¶ay_ty³
;

4872 
	}
}

4873 
	$­p_av_sock‘_cÚÃù
()

4876 if(
mIng’icA2dpSock‘Fd
 <= 0) {

4877 
	`APP_INFO1
("%s()", 
__func__
);

4878 if(!
	`šg’ic_a2dp_cÚÃù
(è&& (
gavS¹
 ==0)) {

4879 
BD_ADDR
 
bd_addr
;

4880 if(
	`­p_mgr_g‘_dev_av_bt_addr
(
bd_addr
) == 0)

4881 
	`­p_av_İ’
(
bd_addr
);

4885 
	}
}

4886 #ifdeà
USE_INGENIC_AUDIO_SOCKET


4887 
	$šg’ic_a2dp_cÚÃù
(){

4888 
	`APP_INFO1
("%s()", 
__func__
);

4890 
sockaddr_un
 
£r_addr
;

4891 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

4892 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

4893 
	`¡rıy
(
£r_addr
.
sun_·th
,
A2DP_SOURCE_DOMAIN
);

4894 
mIng’icA2dpSock‘Fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

4895 if(
mIng’icA2dpSock‘Fd
 < 0){

4896 
	`APP_ERROR1
("Blu‘oÙhMªag” mu¡ boÙ u°aá” medŸ£rv”. sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

4899 
»t
 = 
	`cÚÃù
(
mIng’icA2dpSock‘Fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

4900 if(
»t
 < 0){

4901 
	`şo£
(
mIng’icA2dpSock‘Fd
);

4902 
mIng’icA2dpSock‘Fd
 = -1;

4903 
	`APP_ERROR1
("cÚÃù sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

4906 
	`APP_INFO1
("%s(),mIng’icA2dpSock‘Fd=%d", 
__func__
,
mIng’icA2dpSock‘Fd
);

4908 
	}
}

4910 
	$šg’ic_a2dp_discÚÃù
(){

4911 
	`APP_INFO1
("%s()", 
__func__
);

4912 if(
mIng’icA2dpSock‘Fd
 > 0){

4913 
	`şo£
(
mIng’icA2dpSock‘Fd
);

4914 
mIng’icA2dpSock‘Fd
 = -1;

4917 
	}
}

4919 
	$šg’ic_a2dp_İ’
(){

4920 
	`APP_INFO1
("%s()", 
__func__
);

4921 if(
mIng’icA2dpSock‘Fd
 <= 0) {

4922 
	`šg’ic_a2dp_cÚÃù
();

4924 if(
mIng’icA2dpSock‘Fd
 > 0){

4925 
»’
 = 
	`£nd
(
mIng’icA2dpSock‘Fd
, "a2dp-av-İ’-",
	`¡¾’
("a2dp-av-open-"), 0);

4926 if(
»’
 > 0)

4929 
	`APP_INFO1
("%s(è£nd fa", 
__func__
);

4930 
	`šg’ic_a2dp_discÚÃù
();

4936 
	}
}

4937 
	$šg’ic_a2dp_şo£
(){

4938 
	`APP_INFO1
("%s()", 
__func__
);

4940 if(
mIng’icA2dpSock‘Fd
 > 0){

4941 
»’
 = 
	`£nd
(
mIng’icA2dpSock‘Fd
, "a2dp-av-şo£-",
	`¡¾’
("a2dp-av-close-"), 0);

4942 if(
»’
 > 0)

4945 
	`APP_INFO1
("%s(è£nd fa", 
__func__
);

4946 
	`šg’ic_a2dp_discÚÃù
();

4952 
	}
}

	@source/app_av_ipc.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~<fú.h
>

19 
	~<uni¡d.h
>

21 
	~<”ºo.h
>

23 
	~"b§_­i.h
"

25 
	~"gki_št.h
"

26 
	~"uc.h
"

28 
	~"b§_Œaû.h
"

29 
	~"­p_av.h
"

30 #ifdeà
APP_AV_BCST_INCLUDED


31 
	~"­p_av_bc¡.h
"

33 
	~"­p_xml_·¿m.h
"

34 
	~"­p_disc.h
"

35 
	~"­p_uts.h
"

36 
	~"­p_wav.h
"

37 
	~"­p_¶ayli¡.h
"

38 
	~"­p_mu‹x.h
"

39 
	~"­p_th»ad.h
"

40 
	~"­p_xml_uts.h
"

41 
	~"­p_dm.h
"

44 
	#CONFIG_REMOTE_IS_AUDIO_SPEAKER


	)

47 #ifdeà
USE_INGENIC_AUDIO_SOCKET


48 
	~<Sh¬edMemÜyIÁ”çû.h
>

49 
	~<sys/sock‘.h
>

50 
	~<sys/un.h
>

51 
	#A2DP_SOURCE_DOMAIN
 "/v¬/run/a2dp_sourû_hw_sock‘"

	)

52 
	#A2DP_SOURCE_SHM_KEY
 "a2dp"

	)

53 
	#A2DP_SOURCE_SHM_SIZE
 (64*1024)

	)

54 
	ga2dp_¶ayback_cÚ‹xt
;

55 
	gmIng’icA2dpSock‘Fd
 = -1;

56 
šg’ic_a2dp_cÚÃù
();

57 
šg’ic_a2dp_discÚÃù
();

58 
šg’ic_a2dp_İ’
();

59 
šg’ic_a2dp_şo£
();

66 #iâdeà
APP_AV_FEAT_MASK


68 
	#APP_AV_FEAT_MASK
 (
BSA_AV_FEAT_RCTG
 | 
BSA_AV_FEAT_RCCT
 | 
BSA_AV_FEAT_VENDOR
 | 
BSA_AV_FEAT_METADATA
 | 
BSA_AV_FEAT_BROWSE
)

	)

71 #iâdeà
APP_AV_USE_RC


72 
	#APP_AV_USE_RC
 
TRUE


	)

75 #iâdeà
BSA_AV_DUMP_TX_DATA


76 
	#BSA_AV_DUMP_TX_DATA
 
FALSE


	)

80 
	#APP_AV_MAX_CONNECTIONS
 2

	)

82 
	#APP_AV_MAX_AUDIO_BUF
 1024

	)

84 
	#APP_AV_REMOTE_DEVICES_XML_FILE
 "./bt_deviûs.xml"

	)

86 
	#APP_AV_SOUND_FILE
 "./‹¡.wav"

	)

89 
	#APP_AV_PERIOD_MIN
 (
BSA_AV_MIN_SYNCHRONOUS_LATENCY
*1000è

	)

90 
	#APP_AV_PERIOD_MAX
 (
BSA_AV_MAX_SYNCHRONOUS_LATENCY
*1000è

	)

92 
	#APP_AV_LENGTH_MIN
 100

	)

93 
	#APP_AV_LENGTH_MAX
 (8*1024è

	)

96 
	#APP_AV_MAX_AUDIO_BUF_MAX
 10000

	)

99 #iâdeà
APP_AV_COMPENSATION_HIGH_WM


100 
	#APP_AV_COMPENSATION_HIGH_WM
 1.2

	)

103 #iâdeà
APP_AV_COMPENSATION_LOW_WM


104 
	#APP_AV_COMPENSATION_LOW_WM
 0.8

	)

107 cÚ¡ 
	gsšwaves
[2][64] = {{

127 cÚ¡ 
tBSA_AV_CODEC_INFO
 
	g­tx_ÿps
 =

129 
BSA_AV_CODEC_APTX
,

145 cÚ¡ 
tBSA_AV_CODEC_INFO
 
	g£c_ÿps
 =

147 
BSA_AV_CODEC_SEC
,

165 
	#APP_AV_PLAYTYPE_TONE
 0

	)

166 
	#APP_AV_PLAYTYPE_FILE
 1

	)

167 
	#APP_AV_PLAYTYPE_MIC
 2

	)

168 
	#APP_AV_PLAYTYPE_TEST
 3

	)

169 
	#APP_AV_PLAYTYPE_AVK
 4

	)

172 
	#BSA_AV_PLAYER_ID_INVALID
 0

	)

173 
	#BSA_AV_PLAYER_ID_FILES
 1

	)

174 
	#BSA_AV_PLAYER_ID_MPLAYER
 2

	)

177 
	#BSA_AV_NUM_MPLAYERS
 2

178 

	)

179 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”1_fe
 =

182 
BSA_AV_PLAYER_ID_FILES
,

184 (
AVRC_MJ_TYPE_AUDIO
|
AVRC_MJ_TYPE_VIDEO
),

186 
AVRC_SUB_TYPE_NONE
,

189 
AVRC_PLAYSTATE_STOPPED
,

217 
AVRC_CHARSET_ID_UTF8
,

219 (
UINT8
 *)"File Player"

223 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”2_medŸ_¶ay”
 =

226 
BSA_AV_PLAYER_ID_MPLAYER
,

228 
AVRC_MJ_TYPE_AUDIO
,

230 
AVRC_SUB_TYPE_NONE
,

233 
AVRC_PLAYSTATE_STOPPED
,

261 
AVRC_CHARSET_ID_UTF8
,

263 (
UINT8
 *)"Media Player"

268 
tBSA_ITEM_PLAYER
 
	gb§_av_¶ay”3_fm
 =

271 
BSA_AV_PLAYER_ID_FM
,

273 (
AVRC_MJ_TYPE_BC_AUDIO
),

275 
AVRC_SUB_TYPE_NONE
,

278 
AVRC_PLAYSTATE_STOPPED
,

306 
AVRC_CHARSET_ID_UTF8
,

308 (
UINT8
 *)"FM Radio"

314 
tBSA_ITEM_PLAYER
 * 
	gb§_av_¶ay”s
 [] =

317 &
b§_av_¶ay”1_fe
,

319 &
b§_av_¶ay”2_medŸ_¶ay”


328 
tBSA_UID
 
	muid
;

329 
UINT8
 
	mty³
;

330 
tBSA_FULL_NAME
 
	mÇme
;

331 
UINT8
 
	m©Œ_couÁ
;

332 
tBSA_ATTR_ENTRY
 
	mp_©Œ_li¡
[7];

333 } 
	ttBSA_APP_ITEM_MEDIA
;

337 
tBSA_APP_ITEM_MEDIA
 
	gsÚg1
 =

339 . 
uid
 = { 0x01 },

340 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

341 .
	gÇme
 =

343 
AVRC_CHARSET_ID_UTF8
,

345 (
UINT8
 *)"Beat It ",

347 .
	g©Œ_couÁ
 = 7,

349 .
	gp_©Œ_li¡
[0] =

351 
AVRC_MEDIA_ATTR_ID_TITLE
,

353 
AVRC_CHARSET_ID_UTF8
,

355 (
UINT8
 *)"Beat It ",

359 .
	gp_©Œ_li¡
[1] =

361 
AVRC_MEDIA_ATTR_ID_ARTIST
,

363 
AVRC_CHARSET_ID_UTF8
,

365 (
UINT8
 *)"Michael Jackson "

369 .
	gp_©Œ_li¡
[2] =

371 
AVRC_MEDIA_ATTR_ID_ALBUM
,

373 
AVRC_CHARSET_ID_UTF8
,

375 (
UINT8
 *)"Thriller"

379 .
	gp_©Œ_li¡
[3] =

381 
AVRC_MEDIA_ATTR_ID_GENRE
,

383 
AVRC_CHARSET_ID_UTF8
,

385 (
UINT8
 *)"SoftRock"

389 .
	gp_©Œ_li¡
[4] =

391 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

393 
AVRC_CHARSET_ID_UTF8
,

395 (
UINT8
 *)"3 "

399 .
	gp_©Œ_li¡
[5] =

401 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

403 
AVRC_CHARSET_ID_UTF8
,

405 (
UINT8
 *)"1 "

409 .
	gp_©Œ_li¡
[6] =

411 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

413 
AVRC_CHARSET_ID_UTF8
,

415 (
UINT8
 *)"269000 "

422 
tBSA_APP_ITEM_MEDIA
 
	gsÚg2
 =

424 .
uid
 = { 0x02 },

425 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

426 .
	gÇme
 =

428 
AVRC_CHARSET_ID_UTF8
,

430 (
UINT8
 *)"Happy Nation ",

432 .
	g©Œ_couÁ
 = 7,

434 .
	gp_©Œ_li¡
[0] =

436 
AVRC_MEDIA_ATTR_ID_TITLE
,

438 
AVRC_CHARSET_ID_UTF8
,

440 (
UINT8
 *)"Happy Nation "

444 .
	gp_©Œ_li¡
[1] =

446 
AVRC_MEDIA_ATTR_ID_ARTIST
,

448 
AVRC_CHARSET_ID_UTF8
,

450 (
UINT8
 *)"Jonas, Jenny "

455 .
	gp_©Œ_li¡
[2] =

457 
AVRC_MEDIA_ATTR_ID_ALBUM
,

459 
AVRC_CHARSET_ID_UTF8
,

461 (
UINT8
 *)"Ace of Base "

465 .
	gp_©Œ_li¡
[3] =

467 
AVRC_MEDIA_ATTR_ID_GENRE
,

469 
AVRC_CHARSET_ID_UTF8
,

471 (
UINT8
 *)"Pop "

475 .
	gp_©Œ_li¡
[4] =

477 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

479 
AVRC_CHARSET_ID_UTF8
,

481 (
UINT8
 *)"2 "

485 .
	gp_©Œ_li¡
[5] =

487 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

489 
AVRC_CHARSET_ID_UTF8
,

491 (
UINT8
 *)"3 "

495 .
	gp_©Œ_li¡
[6] =

497 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

499 
AVRC_CHARSET_ID_UTF8
,

501 (
UINT8
 *)"255000 "

509 
tBSA_APP_ITEM_MEDIA
 
	gsÚg3
 =

511 . 
uid
 = { 0x03 },

512 .
	gty³
 = 
AVRC_MEDIA_TYPE_AUDIO
,

513 .
	gÇme
 =

515 
AVRC_CHARSET_ID_UTF8
,

517 (
UINT8
 *)"River of Dreams ",

519 .
	g©Œ_couÁ
 = 7,

520 .
	gp_©Œ_li¡
[0] =

522 
AVRC_MEDIA_ATTR_ID_TITLE
,

524 
AVRC_CHARSET_ID_UTF8
,

526 (
UINT8
 *)"River of Dreams "

530 .
	gp_©Œ_li¡
[1] =

532 
AVRC_MEDIA_ATTR_ID_ARTIST
,

534 
AVRC_CHARSET_ID_UTF8
,

536 (
UINT8
 *)"Billy Joel "

541 .
	gp_©Œ_li¡
[2] =

543 
AVRC_MEDIA_ATTR_ID_ALBUM
,

545 
AVRC_CHARSET_ID_UTF8
,

547 (
UINT8
 *)"River of Dreams "

551 .
	gp_©Œ_li¡
[3] =

553 
AVRC_MEDIA_ATTR_ID_GENRE
,

555 
AVRC_CHARSET_ID_UTF8
,

557 (
UINT8
 *)"Soul"

561 .
	gp_©Œ_li¡
[4] =

563 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

565 
AVRC_CHARSET_ID_UTF8
,

567 (
UINT8
 *)"3 "

571 .
	gp_©Œ_li¡
[5] =

573 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

575 
AVRC_CHARSET_ID_UTF8
,

577 (
UINT8
 *)"3 "

581 .
	gp_©Œ_li¡
[6] =

583 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
,

585 
AVRC_CHARSET_ID_UTF8
,

587 (
UINT8
 *)"211000 "

592 
	#BSA_AV_NUMSONGS
 3

	)

594 
tBSA_APP_ITEM_MEDIA
 * 
	gb§_av_sÚgs
[] =

596 &
sÚg1
,

597 &
sÚg2
,

598 &
sÚg3


601 
UINT16
 
	ttBSA_AV_EVT_MASK
;

603 
tBSA_AV_EVT_MASK
 
	mevt_mask
;

604 
UINT8
 
	mÏb–
[
AVRC_NUM_NOTIF_EVENTS
];

605 } 
	ttBSA_AV_REG_EVT
;

607 
	#BSA_ATTR_STRING_LEN
 15

	)

610 
UINT8
 
	mv®1
[
BSA_ATTR_STRING_LEN
];

611 
UINT8
 
	mv®2
[
BSA_ATTR_STRING_LEN
];

612 } 
	ttBSA_AV_META_ATTRIB_SETTINGS
;

615 
UINT8
 
	m©Œib_id
;

616 
UINT8
 
	mcu¼_v®ue
;

617 
BOOLEAN
 
	mv®ue_upd©ed
;

618 
UINT8
 
	m©Œib_¡r
[
BSA_ATTR_STRING_LEN
];

619 
tBSA_AV_META_ATTRIB_SETTINGS
 
	m©Œ_£‰šgs
[2];

620 } 
	ttBSA_AV_META_ATTRIB
;

623 
tBSA_AV_META_ATTRIB
 
	mequ®iz”
;

624 
tBSA_AV_META_ATTRIB
 
	m»³©
;

625 
tBSA_AV_META_ATTRIB
 
	mshufæe
;

626 } 
	ttBSA_AV_PAS_INFO
;

630 
UINT32
 
	msÚg_Ëngth
;

631 
UINT32
 
	msÚg_pos
;

632 
UINT8
 
	m¶ay_¡©us
;

633 } 
	ttBSA_AV_META_PLAYSTAT
;

637 
UINT8
 
	mev’t_id
;

638 
UINT32
 
	m¶ayback_š‹rv®
;

639 
UINT32
 
	m¶ayback_pos
;

640 
UINT8
 
	mb©_¡©
;

641 
UINT8
 
	msys_¡©
;

642 } 
	ttBSA_AV_STAT_INFO
;

646 
tBSA_AV_REG_EVT
 
	m»gi¡”ed_ev’ts
;

647 
UINT16
 
	mch¬£t_id
;

648 
UINT8
 
	mmax_©Œib_num
;

649 
tBSA_AV_PAS_INFO
 
	m·s_šfo
;

650 
tBSA_AV_META_PLAYSTAT
 
	m¶ay_¡©us
;

651 
tBSA_AV_STAT_INFO
 
	mnÙif_šfo
;

652 
UINT8
 
	mŒack_num
;

653 
UINT16
 
	maddr_¶ay”_id
;

654 
UINT16
 
	mbrow£d_¶ay”_id
;

655 
UINT16
 
	mcur_uid_couÁ”
;

656 } 
	ttBSA_AV_METADATA
;

661 
UINT8
 
	mcur_¶ay
;

662 
UINT8
 
	m¶ay_couÁ
;

663 
tBSA_AV_METADATA
 
	mm‘a_šfo
;

664 } 
	ttBSA_AV_CB
;

666 
tBSA_AV_CB
 *
	gp_b§_av_cb
 = 
NULL
;

669 
	#AVRCP_NOW_PLAYING_FOLDER_ID_FIRST_BYTE
 0x02

	)

670 
	#AVRCP_NOW_PLAYING_FOLDER_ID
 0x02000000

	)

671 
	#AVRCP_PLAY_LISTS_FOLDER_ID
 0x00000000

	)

672 
	#AVRCP_NOW_PLAYING_FILE_ID
 0x00000000

	)

673 
	#AVRCP_NO_NOW_PLAYING_FOLDER_ID
 0xFFFFFFFF

	)

674 
	#AVRCP_NO_NOW_PLAYING_FILE_ID
 0xFFFFFFFF

	)

680 
tAPP_MUTEX
 
	g­p_¡»am_tx_mu‹x
;

681 
tAPP_THREAD
 
	g­p_uc_tx_th»ad_¡ruù
;

687 
tUIPC_CH_ID
 
	m¡»am_uc_chªÃl
;

689 
tAPP_AV_CONNECTION
 
	mcÚÃùiÚs
[
APP_AV_MAX_CONNECTIONS
];

691 
tBSA_STATUS
 
	mÏ¡_¡¬t_¡©us
;

693 
tBSA_AV_MEDIA_FEEDINGS
 
	mmedŸ_ãedšg
;

695 vŞ©
UINT8
 
	m¶ay_¡©e
;

697 
UINT8
 
	m¶ay_ty³
;

699 
BOOLEAN
 
	m¶ay_li¡
;

702 **
	msoundfe_li¡
;

703 
	msoundfe_li¡_size
;

706 
	mfe_šdex
;

707 
	mfe_Çme
[1000];

710 
UINT8
 
	msšus_šdex
;

711 
UINT8
 
	msšus_ty³
;

714 
tAPP_AV_UIPC
 
	muc_cfg
;

717 
	maudio_buf
[
APP_AV_MAX_AUDIO_BUF_MAX
];

720 
UINT16
 
	mtÚe_§m¶e_äeq
;

722 
UINT32
 
	m£c_äame_size
;

724 
UINT8
 
	mÏb–
;

727 
tBSA_AV_CP_ID
 
	mı_id
;

728 
UINT8
 
	mı_scms_æag
;

731 
	m‹¡_£c_§mpäeq_šdex
;

732 } 
	g­p_av_cb
;

735 
tBSA_AV_META_PLAYSTAT
 
	g¶ay¡
 =

739 
BSA_AVRC_PLAYSTATE_STOPPED
,

742 
tAvC®lback
 *
	gs_pC®lback
 = 
NULL
;

744 
tAPP_THREAD
 
	gt_­p_rc_th»ad
;

745 
	gs_commªd
 = 0;

746 
­p_avk_rc_commªd_th»ad
();

751 *
­p_av_di¥Ïy_v’dÜ_commªd
(
UINT8
 
commªd
);

752 
­p_av_uc_»cÚfig
();

753 
­p_av_d–ay_¡¬t
(
tAPP_AV_DELAY
 *
p_d–ay
);

754 
­p_av_¡İ_cu¼’t
();

755 
­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
UINT8
 
ev’t_id
, 
tBSA_AV_META_RSP_CMD
 *
b§_av_m‘a_r¥_cmd
);

756 
­p_av_š™_m‘a_d©a
();

767 *
	$­p_av_di¥Ïy_v’dÜ_commªd
(
UINT8
 
commªd
)

769 
commªd
)

771 
BSA_AV_RC_VD_GET_CAPABILITIES
:

773 
BSA_AV_RC_VD_LIST_PLAYER_APP_ATTR
:

775 
BSA_AV_RC_VD_LIST_PLAYER_APP_VALUES
:

777 
BSA_AV_RC_VD_GET_CUR_PLAYER_APP_VALUE
:

779 
BSA_AV_RC_VD_SET_PLAYER_APP_VALUE
:

781 
BSA_AV_RC_VD_GET_PLAYER_APP_ATTR_TEXT
:

783 
BSA_AV_RC_VD_GET_PLAYER_APP_VALUE_TEXT
:

785 
BSA_AV_RC_VD_INFORM_DISPLAY_CHARSET
:

787 
BSA_AV_RC_VD_INFORM_BATTERY_STAT_OF_CT
:

789 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
:

791 
BSA_AV_RC_VD_GET_PLAY_STATUS
:

793 
BSA_AV_RC_VD_REGISTER_NOTIFICATION
:

795 
BSA_AV_RC_VD_ABORT_CONTINUATION_RSP
:

797 
BSA_AV_RC_VD_SET_ABSOLUTE_VOLUME
:

799 
BSA_AV_RC_VD_SET_ADDRESSED_PLAYER
:

801 
BSA_AV_RC_VD_SET_BROWSED_PLAYER
:

803 
BSA_AV_RC_VD_GET_FOLDER_ITEMS
:

805 
BSA_AV_RC_VD_CHANGE_PATH
:

807 
BSA_AV_RC_VD_GET_ITEM_ATTRIBUTES
:

809 
BSA_AV_RC_VD_PLAY_ITEM
:

811 
BSA_AV_RC_VD_SEARCH
:

813 
BSA_AV_RC_VD_ADD_TO_NOW_PLAYING
:

820 
	}
}

832 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_hªdË
(
tBSA_AV_HNDL
 
hªdË
)

834 
šdex
;

835 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

837 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
 == handle)

838  &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

840  
NULL
;

841 
	}
}

852 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
BD_ADDR
 
bd_addr
)

854 
šdex
;

855 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

857 ià(
	`bdcmp
(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
, bd_addr) == 0)

858  &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

860  
NULL
;

861 
	}
}

872 
tAPP_AV_CONNECTION
 *
	$­p_av_fšd_cÚÃùiÚ_by_¡©us
(
BOOLEAN
 
»gi¡”ed
, BOOLEAN 
İ’
)

874 
út
;

875 
út
 = 0; cÁ < 
APP_AV_MAX_CONNECTIONS
; cnt++)

877 ià((
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_»gi¡”ed
 =ğ
»gi¡”ed
) &&

878 (
­p_av_cb
.
cÚÃùiÚs
[
út
].
is_İ’
 =ğ
İ’
))

879  &
­p_av_cb
.
cÚÃùiÚs
[
út
];

881  
NULL
;

882 
	}
}

893 
	$­p_av_di¥Ïy_cÚÃùiÚs
()

895 
šdex
;

896 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
; index++)

898 
	`APP_INFO1
(" CÚÃùiÚ index %d:", 
šdex
);

899 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_»gi¡”ed
)

901 
	`APP_INFO1
(" Regi¡”ed -> hªdË = %d", 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
);

902 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_İ’
)

904 
	`APP_INFO1
(" Connectedo %02X:%02X:%02X:%02X:%02X:%02X",

905 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[0],‡pp_av_cb.connections[index].bd_addr[1],

906 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[2],‡pp_av_cb.connections[index].bd_addr[3],

907 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
[4],‡pp_av_cb.connections[index].bd_addr[5]);

908 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_rc
)

910 
	`APP_INFO1
(" RC -> hªdË %d", 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
rc_hªdË
);

914 
	`APP_INFO0
(" does‚ot have RC");

919 
	`APP_INFO0
(" Not connected");

924 
	`APP_INFO0
(" Not„egistered");

928 
	}
}

939 
	$­p_av_cback
(
tBSA_AV_EVT
 
ev’t
, 
tBSA_AV_MSG
 *
p_d©a
)

941 
¡©us
, 
šdex
;

942 
UINT8
 
commªd
;

943 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

945 
ev’t
){

946 
BSA_AV_OPEN_EVT
:

947 
	`APP_INFO1
("BSA_AV_OPEN_EVT status:%d handle:%d cp:%d‡ptx:%d sec:%d",

948 
p_d©a
->
İ’
.
¡©us
,…_d©a->İ’.
hªdË
,

949 
p_d©a
->
İ’
.
ı_suµÜ‹d
,

950 
p_d©a
->
İ’
.
­tx_suµÜ‹d
,

951 
p_d©a
->
İ’
.
£c_suµÜ‹d
);

952 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
İ’
.
hªdË
);

953 ià(
cÚÃùiÚ
 =ğ
NULL
){

954 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
İ’
.
hªdË
);

956 ià(
p_d©a
->
İ’
.
¡©us
 =ğ
BSA_SUCCESS
){

959 
	`bdıy
(
cÚÃùiÚ
->
bd_addr
, 
p_d©a
->
İ’
.bd_addr);

960 
cÚÃùiÚ
->
is_İ’
 = 
TRUE
;

963 
	`­p_»ad_xml_»mÙe_deviûs
();

966 
	`­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

967 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

968 
BSA_A2DP_SERVICE_MASK
 | 
BSA_AVRCP_SERVICE_MASK
);

971 
šdex
 = 0; index < 
	`APP_NUM_ELEMENTS
(
­p_discov”y_cb
.
devs
); index++){

972 ià(!
	`bdcmp
(
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
, 
cÚÃùiÚ
->bd_addr)){

973 
	`­p_xml_upd©e_Çme_db
(
­p_xml_»mÙe_deviûs_db
,

974 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

975 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
Çme
);

976 
	`APP_INFO1
("\tClassOfDevice:%02x:%02x:%02x => %s",

977 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[0],

978 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[1],

979 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[2],

980 
	`­p_g‘_cod_¡ršg
(

981 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
));

982 
	`­p_xml_upd©e_cod_db
(
­p_xml_»mÙe_deviûs_db
,

983 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
cÚÃùiÚ
->
bd_addr
,

984 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
);

988 
¡©us
 = 
	`­p_wr™e_xml_»mÙe_deviûs
();

989 ià(
¡©us
 < 0){

990 
	`APP_ERROR1
("­p_av_wr™e_»mÙe_deviû çed: %d", 
¡©us
);

993 
	`APP_INFO1
("­p_av_cb.¶ay_¡©e=%d",
­p_av_cb
.
¶ay_¡©e
);

995 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STOPPED
){

997 
	`­p_av_¶ay_mic
();

1001 
cÚÃùiÚ
->
is_İ’
 = 
FALSE
;

1006 
BSA_AV_CLOSE_EVT
:

1007 
	`APP_INFO1
("BSA_AV_CLOSE_EVT stus:%d hªdË:%d", 
p_d©a
->
şo£
.
¡©us
,…_d©a->şo£.
hªdË
);

1008 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
şo£
.
hªdË
);

1009 ià(
cÚÃùiÚ
 =ğ
NULL
)

1011 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
şo£
.
hªdË
);

1015 
cÚÃùiÚ
->
is_İ’
 = 
FALSE
;

1017 #ifdeà
USE_INGENIC_AUDIO_SOCKET


1019 
	`šg’ic_a2dp_şo£
();

1023 
BSA_AV_DELAY_RPT_EVT
:

1024 
	`APP_INFO1
("BSA_AV_DELAY_RPT_EVT channel:%d handle:%d delay: %d",

1025 
p_d©a
->
d–ay
.
chªÃl
,…_d©a->d–ay.
hªdË
,…_data->delay.delay);

1026 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_hªdË
(
p_d©a
->
d–ay
.
hªdË
);

1027 ià(
cÚÃùiÚ
 =ğ
NULL
)

1029 
	`APP_ERROR1
("unknowÀcÚÃùiÚ hªdË %d", 
p_d©a
->
d–ay
.
hªdË
);

1033 
cÚÃùiÚ
->
d–ay
 = 
p_d©a
->delay.delay;

1037 
BSA_AV_PENDING_EVT
:

1039 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1040 
tBSA_AV_OPEN
 
İ’_·¿m
;

1042 
	`APP_INFO1
("BSA_AV_PENDING_EVT‡dd»ss=%x:%x:%x:%x:%x:%x",
p_d©a
->
³nd
.
bd_addr
[0],

1043 
p_d©a
->
³nd
.
bd_addr
[1],p_data->pend.bd_addr[2],p_data->pend.bd_addr[3],

1044 
p_d©a
->
³nd
.
bd_addr
[4],p_data->pend.bd_addr[5]);

1045 
p_cÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
TRUE
, 
FALSE
);

1046 ià(
p_cÚ
 =ğ
NULL
)

1048 
	`APP_ERROR0
("No‡vailable connection structureo open stream");

1053 
	`APP_INFO0
("Connectingo AV device");

1054 
	`BSA_AvO³nIn™
(&
İ’_·¿m
);

1055 
	`bdıy
(
İ’_·¿m
.
bd_addr
, 
p_d©a
->
³nd
.bd_addr);

1056 
İ’_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1058 
İ’_·¿m
.
u£_rc
 = 
APP_AV_USE_RC
;

1059 
¡©us
 = 
	`BSA_AvO³n
(&
İ’_·¿m
);

1060 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1062 
	`APP_ERROR1
("BSA_AvOpen(%02X:%02X:%02X:%02X:%02X:%02X) failed: %d",

1063 
İ’_·¿m
.
bd_addr
[0], open_param.bd_addr[1], open_param.bd_addr[2],

1064 
İ’_·¿m
.
bd_addr
[3], o³n_·¿m.bd_addr[4], o³n_·¿m.bd_addr[5], 
¡©us
);

1070 
BSA_AV_START_EVT
:

1071 
	`APP_INFO1
("BSA_AV_START_EVT status:%d channel:%x UIPC:%d SCMS:%d,%d",

1072 
p_d©a
->
¡¬t
.
¡©us
,…_d©a->¡¬t.
chªÃl
,…_d©a->¡¬t.
uc_chªÃl
,

1073 
p_d©a
->
¡¬t
.
ı_’abËd
,…_d©a->¡¬t.
ı_æag
);

1075 ià(
p_d©a
->
¡¬t
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO
)

1077 ià(
p_d©a
->
¡¬t
.
¡©us
 =ğ
BSA_SUCCESS
)

1079 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STARTED
;

1080 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PLAYING
);

1082 
­p_av_cb
.
medŸ_ãedšg
 = 
p_d©a
->
¡¬t
.media_feeding;

1083 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
)

1085 
BSA_AV_CODEC_PCM
:

1086 
	`APP_INFO1
(" Start PCM feeding: freq=%d / channels=%d / bits=%d",

1087 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
,

1088 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
,

1089 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
);

1091 
BSA_AV_CODEC_APTX
:

1092 
	`APP_INFO1
(" Start‡pt-X feeding: freq=%d / mode=%d",

1093 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
,

1094 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
);

1096 
BSA_AV_CODEC_SEC
:

1097 
	`APP_INFO1
(" Start SEC feeding: freq=%d / mode=%d",

1098 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
,

1099 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
);

1103 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
);

1107 
	`APP_INFO1
(" SCMS-T: cp_enabled = %s, cp_flag = %d",

1108 
p_d©a
->
¡¬t
.
ı_’abËd
 ? "TRUE" : "FALSE",

1109 
p_d©a
->
¡¬t
.
ı_æag
);

1111 ià(
	`­p_dm_g‘_du®_¡ack_mode
(è=ğ
BSA_DM_DUAL_STACK_MODE_BSA
)

1114 
	`­p_av_uc_»cÚfig
();

1117 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

1118 ià(
¡©us
 < 0)

1120 
	`APP_ERROR1
("­p_uÆock_mu‹x faed:%d", 
¡©us
);

1125 
	`APP_INFO0
("Stack is‚ot in BSA mode. Do‚ot Start AVhread");

1131 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1133 
­p_av_cb
.
Ï¡_¡¬t_¡©us
 = 
p_d©a
->
¡¬t
.
¡©us
;

1138 #ifdeà
APP_AV_BCST_INCLUDED


1139 
	`­p_av_bc¡_¡¬t_ev’t_hdÌ
(&
p_d©a
->
¡¬t
);

1144 
BSA_AV_STOP_EVT
:

1145 
	`APP_DEBUG1
("BSA_AV_STOP_EVT…ause:%d Channel:%d UIPC:%d",

1146 
p_d©a
->
¡İ
.
·u£
,…_d©a->¡İ.
chªÃl
,…_d©a->¡İ.
uc_chªÃl
);

1148 ià(
p_d©a
->
¡İ
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO
){

1150 ià(
p_d©a
->
¡İ
.
·u£
){

1151 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_PAUSED
;

1152 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PAUSED
);

1155 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPED
;

1156 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_STOPPED
);

1158 ià(
	`­p_dm_g‘_du®_¡ack_mode
(è=ğ
BSA_DM_DUAL_STACK_MODE_BSA
){

1160 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

1161 ià(
¡©us
 < 0){

1162 
	`APP_ERROR1
("­p_uÆock_mu‹x faed:%d", 
¡©us
);

1166 
	`APP_INFO0
("Stack is‚ot in BSA mode. Do‚ot Stop AVhread");

1171 ià(
p_d©a
->
¡İ
.
chªÃl
 =ğ
BSA_AV_CHNL_AUDIO_BCST
){

1172 #ifdeà
APP_AV_BCST_INCLUDED


1173 
	`­p_av_bc¡_¡İ_ev’t_hdÌ
(&
p_d©a
->
¡İ
);

1176 
	`APP_ERROR1
("Bad chªÃl:%d Stİ³d", 
p_d©a
->
¡İ
.
chªÃl
);

1180 
BSA_AV_RC_OPEN_EVT
:

1181 
	`APP_DEBUG1
("BSA_AV_RC_OPEN_EVT stus:%d hªdË:%d", 
p_d©a
->
rc_İ’
.
¡©us
,…_d©a->rc_İ’.
rc_hªdË
);

1183 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
p_d©a
->
rc_İ’
.
³”_addr
);

1184 ià(
cÚÃùiÚ
 =ğ
NULL
)

1186 
	`APP_ERROR1
("unknown connection bd‡ddr for %02X:%02X:%02X:%02X:%02X:%02X",

1187 
p_d©a
->
rc_İ’
.
³”_addr
[0],…_data->rc_open.peer_addr[1],…_data->rc_open.peer_addr[2],

1188 
p_d©a
->
rc_İ’
.
³”_addr
[3],…_data->rc_open.peer_addr[4],…_data->rc_open.peer_addr[5]);

1190 ià(
p_d©a
->
rc_İ’
.
¡©us
 =ğ
BSA_SUCCESS
)

1192 
cÚÃùiÚ
->
is_rc
 = 
TRUE
;

1193 
cÚÃùiÚ
->
rc_hªdË
 = 
p_d©a
->
rc_İ’
.rc_handle;

1197 
BSA_AV_RC_CLOSE_EVT
:

1198 
	`APP_DEBUG1
("BSA_AV_RC_CLOSE_EVT hªdË:%d bdadd¸%02X:%02X:%02X:%02X:%02X:%02X", 
p_d©a
->
rc_şo£
.
rc_hªdË
,

1199 
p_d©a
->
rc_şo£
.
³”_addr
[0],…_data->rc_close.peer_addr[1],…_data->rc_close.peer_addr[2],

1200 
p_d©a
->
rc_şo£
.
³”_addr
[3],…_data->rc_close.peer_addr[4],…_data->rc_close.peer_addr[5]);

1202 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_bd_addr
(
p_d©a
->
rc_şo£
.
³”_addr
);

1203 ià(
cÚÃùiÚ
 =ğ
NULL
)

1205 
	`APP_ERROR1
("unknown connection bd‡ddr for %02X:%02X:%02X:%02X:%02X:%02X",

1206 
p_d©a
->
rc_şo£
.
³”_addr
[0],…_data->rc_close.peer_addr[1],…_data->rc_close.peer_addr[2],

1207 
p_d©a
->
rc_şo£
.
³”_addr
[3],…_data->rc_close.peer_addr[4],…_data->rc_close.peer_addr[5]);

1211 
cÚÃùiÚ
->
is_rc
 = 
FALSE
;

1215 
BSA_AV_REMOTE_CMD_EVT
:

1216 
	`APP_DEBUG1
("BSA_AV_REMOTE_CMD_EVT hªdË:%d", 
p_d©a
->
»mÙe_cmd
.
rc_hªdË
);

1217 
p_d©a
->
»mÙe_cmd
.
rc_id
)

1219 
BSA_AV_RC_PLAY
:

1220 
	`APP_INFO0
("Play key");

1221 
commªd
 = 
APP_AV_START
;

1223 
BSA_AV_RC_STOP
:

1224 
	`APP_INFO0
("Stop key");

1225 
commªd
 = 
APP_AV_STOP
;

1227 
BSA_AV_RC_PAUSE
:

1228 
	`APP_INFO0
("Pause key");

1229 
commªd
 = 
APP_AV_PAUSE
;

1231 
BSA_AV_RC_FORWARD
:

1232 
	`APP_INFO0
("Forward key");

1233 
commªd
 = 
APP_AV_FORWARD
;

1235 
BSA_AV_RC_BACKWARD
:

1236 
	`APP_INFO0
("Backward key");

1237 
commªd
 = 
APP_AV_BACKWARD
;

1240 
	`APP_INFO1
("key:0x%x", 
p_d©a
->
»mÙe_cmd
.
rc_id
);

1241 
commªd
 = 
APP_AV_IDLE
;

1244 #ià!
	`defšed
(
CONFIG_REMOTE_IS_AUDIO_SPEAKER
)

1245 ià(
p_d©a
->
»mÙe_cmd
.
key_¡©e
 =ğ
BSA_AV_STATE_PRESS
)

1247 
	`APP_INFO1
("Key…»s£d ->ƒxecutšg commªd %d", 
commªd
);

1248 
commªd
)

1250 
APP_AV_START
:

1251 
­p_av_cb
.
¶ay_¡©e
)

1253 
APP_AV_PLAY_PAUSED
:

1254 
	`­p_av_»sume
();

1256 
APP_AV_PLAY_STOPPED
:

1257 
­p_av_cb
.
¶ay_ty³
)

1259 
APP_AV_PLAYTYPE_FILE
:

1260 
	`­p_av_¶ay_¶ayli¡
(
commªd
);

1262 
APP_AV_PLAYTYPE_TONE
:

1263 
	`­p_av_¶ay_tÚe
();

1265 
APP_AV_PLAYTYPE_MIC
:

1266 
	`­p_av_¶ay_mic
();

1268 
APP_AV_PLAYTYPE_TEST
:

1269 
	`­p_av_‹¡_£c_codec
(
TRUE
);

1272 
	`APP_ERROR1
("UnsuµÜ‹d…Ïyy³ (%d)", 
­p_av_cb
.
¶ay_ty³
);

1276 
APP_AV_PLAY_STARTED
:

1278 
	`APP_DEBUG0
("Stream‡lready started,‚ot calling start");

1280 
APP_AV_PLAY_STOPPING
:

1282 
	`APP_DEBUG0
("Stream stopping,‚ot calling start");

1285 
	`APP_ERROR1
("UnsuµÜ‹d…Ïy s‹ (%d)", 
­p_av_cb
.
¶ay_¡©e
);

1289 
APP_AV_STOP
:

1290 
	`­p_av_¡İ
();

1292 
APP_AV_PAUSE
:

1293 
	`­p_av_·u£
();

1295 
APP_AV_FORWARD
:

1296 
APP_AV_BACKWARD
:

1297 ià(
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

1298 ià(
­p_av_cb
.
¶ay_ty³
 !ğ
APP_AV_PLAYTYPE_AVK
)

1300 
	`­p_av_¡İ
();

1304 
s_commªd
 = 
commªd
;

1305 
¡©us
 = 
	`­p_ü—‹_th»ad
(
­p_avk_rc_commªd_th»ad
, 0, 0, &
t_­p_rc_th»ad
);

1310 ià(
p_d©a
->
»mÙe_cmd
.
key_¡©e
 =ğ
BSA_AV_STATE_RELEASE
)

1312 
	`APP_INFO0
("„eleased -> just informative");

1317 
	`APP_ERROR0
("Unknown key state");

1321 
BSA_AV_REMOTE_RSP_EVT
:

1322 
	`APP_DEBUG1
("BSA_AV_REMOTE_RSP_EVT hªdË:%d", 
p_d©a
->
»mÙe_r¥
.
rc_hªdË
);

1325 
BSA_AV_VENDOR_CMD_EVT
:

1326 
	`APP_DEBUG1
("BSA_AV_VENDOR_CMD_EVT hªdË:%d", 
p_d©a
->
v’dÜ_cmd
.
rc_hªdË
);

1327 
	`APP_DEBUG1
("†en=%d,†abel=%d, code=%d, company_id=0x%x",

1328 
p_d©a
->
v’dÜ_cmd
.
Ën
,…_d©a->v’dÜ_cmd.
Ïb–
,…_d©a->v’dÜ_cmd.
code
,

1329 
p_d©a
->
v’dÜ_cmd
.
com·ny_id
);

1330 if(
p_d©a
->
v’dÜ_cmd
.
Ën
)

1332 
	`APP_DEBUG1
("Name:%s",
	`­p_av_di¥Ïy_v’dÜ_commªd
(
p_d©a
->
v’dÜ_cmd
.
d©a
[0]));

1333 
	`APP_DUMP
("D©a", (
UINT8
 *)
p_d©a
->
v’dÜ_cmd
.
d©a
,…_d©a->v’dÜ_cmd.
Ën
);

1337 
BSA_AV_VENDOR_RSP_EVT
:

1338 
	`APP_DEBUG1
("BSA_AV_VENDOR_RSP_EVT hªdË:%d", 
p_d©a
->
v’dÜ_r¥
.
rc_hªdË
);

1339 
	`APP_DEBUG1
("†en=%d,†abel=%d, code=%d, company_id=0x%x",

1340 
p_d©a
->
v’dÜ_r¥
.
Ën
,…_d©a->v’dÜ_r¥.
Ïb–
,…_d©a->v’dÜ_r¥.
code
,

1341 
p_d©a
->
v’dÜ_r¥
.
com·ny_id
);

1342 if(
p_d©a
->
v’dÜ_r¥
.
Ën
)

1344 
	`APP_DEBUG1
("Name:%s",
	`­p_av_di¥Ïy_v’dÜ_commªd
(
p_d©a
->
v’dÜ_r¥
.
d©a
[0]));

1345 
	`APP_DUMP
("D©a", (
UINT8
 *)
p_d©a
->
v’dÜ_r¥
.
d©a
,…_d©a->v’dÜ_r¥.
Ën
);

1349 
BSA_AV_META_MSG_EVT
:

1350 
	`APP_DEBUG1
("BSA_AV_META_MSG_EVT hªdË:%d", 
p_d©a
->
m‘a_msg
.
rc_hªdË
);

1352 
	`APP_DEBUG1
("†abel=%d,…du=%d, company_id=0x%x",

1353 
p_d©a
->
m‘a_msg
.
Ïb–
,…_d©a->m‘a_msg.
pdu
,…_d©a->m‘a_msg.
com·ny_id
);

1355 
­p_av_cb
.
Ïb–
 = 
p_d©a
->
m‘a_msg
.label;

1357 
p_d©a
->
m‘a_msg
.
pdu
)

1359 
BSA_AVRC_PDU_GET_ELEMENT_ATTR
:

1360 
	`­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_m‘a_»¥Ú£
(0);

1363 
BSA_AVRC_PDU_GET_PLAY_STATUS
:

1364 
	`­p_av_rc_£nd_¶ay_¡©us_m‘a_»¥Ú£
(0);

1367 
BSA_AVRC_PDU_SET_ADDRESSED_PLAYER
:

1368 
	`­p_av_rc_£t_addr_¶ay”_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1371 
BSA_AVRC_PDU_GET_FOLDER_ITEMS
:

1372 
	`­p_av_rc_g‘_fŞd”_™ems
(0, &
p_d©a
->
m‘a_msg
);

1375 
BSA_AVRC_PDU_REGISTER_NOTIFICATION
:

1376 
	`­p_av_rc_»gi¡”_nÙifiÿtiÚs
(0, &
p_d©a
->
m‘a_msg
);

1379 
BSA_AVRC_PDU_SET_BROWSED_PLAYER
:

1380 
	`­p_av_rc_£t_brow£d_¶ay”_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1383 
BSA_AVRC_PDU_CHANGE_PATH
:

1384 
	`­p_av_rc_chªge_·th_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1387 
BSA_AVRC_PDU_GET_ITEM_ATTRIBUTES
:

1388 
	`­p_av_rc_g‘_™em_©Œ_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1391 
BSA_AVRC_PDU_PLAY_ITEM
:

1392 
	`­p_av_rc_¶ay_™em_m‘a_»¥Ú£
(0, &
p_d©a
->
m‘a_msg
);

1398 
BSA_AV_FEAT_EVT
:

1399 
	`APP_DEBUG1
("BSA_AV_FEAT_EVT P“¸ã©u»:%x", 
p_d©a
->
rc_ã©
.
³”_ã©u»s
);

1403 
	`APP_ERROR1
("UnknowÀmsg %d", 
ev’t
);

1408 if(
s_pC®lback
)

1409 
	`s_pC®lback
(
ev’t
, 
p_d©a
);

1410 
	}
}

1419 
	$­p_avk_rc_commªd_th»ad
()

1421 
wa™út
 = 0;

1425 (
	`­p_av_g‘_¶ay_¡©e
(è=ğ
APP_AV_PLAY_STOPPING
) &&

1426 (
	`­p_av_g‘_¶ay_¡©e
()!ğ
APP_AV_PLAY_STOPPED
) &&

1427 
wa™út
 < 5)

1429 
	`¦“p
(1);

1430 
wa™út
++;

1433 if(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

1434 
	`­p_av_¶ay_¶ayli¡
(
s_commªd
);

1436 if(
s_commªd
 =ğ
APP_AV_FORWARD
)

1438 
p_b§_av_cb
->
cur_¶ay
++;

1439 if(
p_b§_av_cb
->
cur_¶ay
 >ğ
BSA_AV_NUMSONGS
)

1440 
p_b§_av_cb
->
cur_¶ay
 = 0;

1441 
	`­p_av_rc_chªge_Œack
();

1443 if(
s_commªd
 =ğ
APP_AV_BACKWARD
)

1445 if(
p_b§_av_cb
->
cur_¶ay
 > 0)

1446 
p_b§_av_cb
->
cur_¶ay
--;

1448 
p_b§_av_cb
->
cur_¶ay
 = 
BSA_AV_NUMSONGS
 -1;

1449 
	`­p_av_rc_chªge_Œack
();

1451 
	}
}

1464 
	$­p_av_İ’
(
BD_ADDR
 *
bd_addr_š
)

1466 
¡©us
;

1467 
BD_ADDR
 
bd_addr
;

1468 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1469 
tBSA_AV_OPEN
 
İ’_·¿m
;

1472 
p_cÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
TRUE
, 
FALSE
);

1473 ià(
p_cÚ
 =ğ
NULL
){

1474 
	`APP_ERROR0
("No‡vailable connection structureo open stream");

1482 
	`APP_INFO0
("Connectingo AV device");

1483 
	`BSA_AvO³nIn™
(&
İ’_·¿m
);

1484 
	`bdıy
(
İ’_·¿m
.
bd_addr
, *
bd_addr_š
);

1485 
İ’_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1487 
İ’_·¿m
.
u£_rc
 = 
APP_AV_USE_RC
;

1488 
¡©us
 = 
	`BSA_AvO³n
(&
İ’_·¿m
);

1489 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1491 
	`APP_ERROR1
("BSA_AvOpen(%02X:%02X:%02X:%02X:%02X:%02X) failed: %d",

1492 
İ’_·¿m
.
bd_addr
[0], open_param.bd_addr[1], open_param.bd_addr[2],

1493 
İ’_·¿m
.
bd_addr
[3], o³n_·¿m.bd_addr[4], o³n_·¿m.bd_addr[5], 
¡©us
);

1497 
	}
}

1508 
	$­p_av_şo£
()

1510 
¡©us
;

1511 
choiû
;

1512 
tAPP_AV_CONNECTION
 *
p_cÚ
;

1513 
tBSA_AV_CLOSE
 
şo£_·¿m
;

1515 
choiû
 = 0;

1517 
p_cÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
choiû
];

1518 ià(!
p_cÚ
->
is_İ’
)

1520 
	`APP_ERROR0
("not connected");

1524 
¡©us
 = 
	`BSA_AvClo£In™
(&
şo£_·¿m
);

1525 
şo£_·¿m
.
hªdË
 = 
p_cÚ
->handle;

1526 
¡©us
 = 
	`BSA_AvClo£
(&
şo£_·¿m
);

1528 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1530 
	`APP_ERROR1
("BSA_AvClo£ faed stu ğ%d", 
¡©us
);

1532  
¡©us
;

1533 
	}
}

1544 
	$­p_av_»ad_tÚe
(* 
pOut
, 
nb_by‹s
, 
UINT8
 
sšus_ty³
, UINT8 *
p_sšus_šdex
)

1546 
šdex
;

1547 
UINT8
 
sšus_šdex
 = *
p_sšus_šdex
;

1550 
šdex
 = 0; index < (
nb_by‹s
 / 4); index++)

1552 
pOut
[
šdex
 * 2] = 
sšwaves
[
sšus_ty³
][
sšus_šdex
 % 64];

1553 
pOut
[
šdex
 * 2 + 1] = 
sšwaves
[
sšus_ty³
][
sšus_šdex
 % 64];

1554 
sšus_šdex
++;

1556 *
p_sšus_šdex
 = 
sšus_šdex
;

1557 
	}
}

1567 
	$­p_av_»ad_‹¡
(* 
pOut
, 
nb_by‹s
)

1569 
šdex
;

1570 
d©a
 = 1;

1572 
d©a
++;

1573 
šdex
 = 0; index < 
nb_by‹s
/2 ; index++)

1575 
pOut
[
šdex
] = 
d©a
;

1578 
	`APP_DEBUG1
("­p_av_»ad_‹¡ d©¨ğ0x%x,†’gth = %d", 
d©a
, 
nb_by‹s
);

1579 
	}
}

1590 
	$­p_av_£t_tÚe_§m¶e_äequ’cy
(
UINT16
 
§m¶e_äeq
)

1592 
	`APP_DEBUG1
("­p_av_£t_tÚe_§m¶e_äequ’cy %d", 
§m¶e_äeq
);

1593 
­p_av_cb
.
tÚe_§m¶e_äeq
 = 
§m¶e_äeq
;

1594 
	}
}

1605 
	$­p_av_toggË_tÚe
()

1607 ià(
­p_av_cb
.
sšus_ty³
 == 0)

1608 
­p_av_cb
.
sšus_ty³
 = 1;

1610 
­p_av_cb
.
sšus_ty³
 = 0;

1611 
	}
}

1622 
	$­p_av_¶ay_tÚe
()

1624 
¡©us
;

1625 
tBSA_AV_START
 
¡¬t_·¿m
;

1627 ifĞ((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
) &&

1628 (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_PAUSED
))

1630 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1635 
­p_av_cb
.
sšus_šdex
 = 0;

1636 
­p_av_cb
.
sšus_ty³
 = 0;

1639 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1640 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

1642 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
­p_av_cb
.
tÚe_§m¶e_äeq
;

1643 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

1644 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

1645 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1646 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1649 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

1650 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

1652 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_TONE
;

1653 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1655 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1656 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1658 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

1659  
¡©us
;

1663 
	}
}

1665 
	$­p_av_¶ay_äom_avk
()

1667 
¡©us
;

1668 
tBSA_AV_START
 
¡¬t_·¿m
;

1670 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

1672 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1677 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1679 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_AVK
;

1680 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1682 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1683 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1685 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

1686  
¡©us
;

1690 
	}
}

1701 
	$­p_av_¶ay_fe
()

1703 
¡©us
;

1704 
tBSA_AV_START
 
¡¬t_·¿m
;

1705 
choiû
;

1706 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

1708 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

1710 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1714 
	`­p_av_di¥Ïy_¶ayli¡
();

1716 
choiû
 = 
	`­p_g‘_choiû
("Select file");

1717 ià((
choiû
 < 0 ) || (choiû >ğ
­p_av_cb
.
soundfe_li¡_size
))

1719 
	`APP_ERROR1
("Fšdex ouˆoàbounds:%d", 
choiû
);

1723 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
choiû
], &
wav_fÜm©
) < 0)

1725 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
choiû
]);

1729 
	`APP_INFO1
("%d :%s", ()
choiû
, 
­p_av_cb
.
soundfe_li¡
[choice]);

1730 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

1731 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

1734 
­p_av_cb
.
fe_šdex
 = 
choiû
;

1735 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[
choiû
], (app_av_cb.file_name)-1);

1736 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

1739 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1741 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
wav_fÜm©
.
codec
;

1742 
wav_fÜm©
.
codec
)

1744 
BSA_AV_CODEC_PCM
:

1745 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1746 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 
wav_fÜm©
.
nb_chªÃls
;

1747 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 
wav_fÜm©
.
b™s_³r_§m¶e
;

1749 
BSA_AV_CODEC_APTX
:

1750 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1751 ià(
wav_fÜm©
.
nb_chªÃls
 == 2)

1753 ià(
wav_fÜm©
.
¡”eo_mode
 == 2)

1755 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_STEREO
;

1759 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_JOINT
;

1764 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_MONO
;

1768 
	`APP_ERROR1
("UnsuµÜ‹d codeø(x%xèš WAV f(%s)", 
wav_fÜm©
.
codec
, 
­p_av_cb
.
soundfe_li¡
[
choiû
]);

1771 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1772 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1775 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

1776 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

1778 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_FILE
;

1779 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

1781 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1782 ià(
¡©us
 =ğ
BSA_ERROR_SRV_AV_FEEDING_NOT_SUPPORTED
)

1784 
	`APP_ERROR0
("BSA_AvStart failed because fileƒncoding is‚ot supported by„emote devices");

1785  
¡©us
;

1787 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1789 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

1790  
¡©us
;

1794 
	`APP_INFO0
("Waiting for AV connectiono start");

1795 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STARTED
);

1797 ià(
­p_av_cb
.
Ï¡_¡¬t_¡©us
 !ğ
BSA_SUCCESS
)

1799 
	`APP_ERROR1
("Faed s¹šg AV cÚÃùiÚ : stu %d", 
­p_av_cb
.
Ï¡_¡¬t_¡©us
);

1800  
¡©us
;

1804 
	}
}

1815 
	$­p_av_¶ay_¶ayli¡
(
UINT8
 
commªd
)

1817 
¡©us
;

1818 
tBSA_AV_START
 
¡¬t_·¿m
;

1819 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

1820 
BOOLEAN
 
fÜm©_known
;

1821 
©‹m±
 = 0;

1823 ià((
	`­p_av_g‘_¶ay_¡©e
()!ğ
APP_AV_PLAY_STOPPED
) &&

1824 (
	`­p_av_g‘_¶ay_¡©e
(è!ğ
APP_AV_PLAY_STOPPING
) &&

1825 (
	`­p_av_g‘_¶ay_¡©e
(è!ğ
APP_AV_PLAY_PAUSED
))

1827 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

1831 ià((
­p_av_cb
.
soundfe_li¡_size
 =ğ0è|| (­p_av_cb.
soundfe_li¡
 =ğ
NULL
))

1833 
	`APP_ERROR0
("No…laylist");

1838 ià(
commªd
 =ğ
APP_AV_START
)

1841 
	`APP_DEBUG1
("­p_av_¶ay_¶ayli¡ s¹ index:%d", 
­p_av_cb
.
fe_šdex
);

1844 ià(
commªd
 =ğ
APP_AV_FORWARD
)

1846 ià(
­p_av_cb
.
fe_šdex
 >ğ×µ_av_cb.
soundfe_li¡_size
 -1))

1847 
­p_av_cb
.
fe_šdex
 = 0;

1849 
­p_av_cb
.
fe_šdex
++;

1852 ià(
commªd
 =ğ
APP_AV_BACKWARD
)

1854 ià(
­p_av_cb
.
fe_šdex
 == 0)

1855 
­p_av_cb
.
fe_šdex
 =‡µ_av_cb.
soundfe_li¡_size
 - 1;

1857 
­p_av_cb
.
fe_šdex
--;

1861 
	`APP_ERROR1
("UnsuµÜ‹d commªd:%d", 
commªd
);

1865 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_FILE
;

1866 
­p_av_cb
.
¶ay_li¡
 = 
TRUE
;

1870 
fÜm©_known
 = 
TRUE
;

1871 
¡©us
 = -1;

1874 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1875 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
], &
wav_fÜm©
) < 0)

1877 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1881 
	`APP_INFO1
("L‘' ŒyØ¶ay WAV fe:% fÜm©:", 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1882 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

1883 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

1884 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
wav_fÜm©
.
codec
;

1885 
wav_fÜm©
.
codec
)

1887 
BSA_AV_CODEC_PCM
:

1888 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1889 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 
wav_fÜm©
.
nb_chªÃls
;

1890 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 
wav_fÜm©
.
b™s_³r_§m¶e
;

1892 
BSA_AV_CODEC_APTX
:

1893 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 = 
wav_fÜm©
.
§m¶e_¿‹
;

1894 ià(
wav_fÜm©
.
nb_chªÃls
 == 2)

1896 ià(
wav_fÜm©
.
¡”eo_mode
 == 2)

1898 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_STEREO
;

1902 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_JOINT
;

1907 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 = 
BSA_AV_CHANNEL_MODE_MONO
;

1911 
	`APP_ERROR1
("UnsuµÜ‹d codeø(x%xèš WAV f(%s)", 
wav_fÜm©
.
codec
, 
­p_av_cb
.
soundfe_li¡
[­p_av_cb.
fe_šdex
]);

1912 
fÜm©_known
 = 
FALSE
;

1915 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1916 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

1919 ià(
fÜm©_known
)

1921 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[­p_av_cb.
fe_šdex
], (app_av_cb.file_name)-1);

1922 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

1925 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

1926 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

1928 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

1929 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1931 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

1936 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1938 ià((
commªd
 =ğ
APP_AV_START
è|| (commªd =ğ
APP_AV_FORWARD
))

1940 ià(
­p_av_cb
.
fe_šdex
 >ğ×µ_av_cb.
soundfe_li¡_size
 - 1))

1942 
­p_av_cb
.
fe_šdex
 = 0;

1946 
­p_av_cb
.
fe_šdex
++;

1950 ià(
commªd
 =ğ
APP_AV_BACKWARD
)

1952 ià(
­p_av_cb
.
fe_šdex
 == 0)

1954 
­p_av_cb
.
fe_šdex
 =‡µ_av_cb.
soundfe_li¡_size
 - 1;

1958 
­p_av_cb
.
fe_šdex
--;

1961 
	`APP_DEBUG1
("¶ayli¡_šdex:%d‡µ_av_cb.soundfe_li¡_size:%d", 
­p_av_cb
.
fe_šdex
,‡µ_av_cb.
soundfe_li¡_size
);

1964 
©‹m±
++;

1966 } (
¡©us
 !ğ
BSA_SUCCESS
è&& (
©‹m±
 < 
­p_av_cb
.
soundfe_li¡_size
));

1968 ià(
¡©us
 =ğ
BSA_SUCCESS
)

1976 
	}
}

1987 
	$­p_av_¶ay_mic
(){

1988 
	`APP_INFO0
("app_av_play_mic in");

1989 
¡©us
;

1990 
tBSA_AV_START
 
¡¬t_·¿m
;

1991 #ifdeà
USE_INGENIC_AUDIO_SOCKET


1993 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

1994 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

1995 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 44100;

1996 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

1997 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

1998 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

1999 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

2002 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

2003 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

2005 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_MIC
;

2007 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

2008 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2010 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

2011  
¡©us
;

2014 
	`šg’ic_a2dp_İ’
();

2019 
	}
}

2030 
	$­p_av_¡İ_cu¼’t
()

2032 
¡©us
;

2033 
tBSA_AV_STOP
 
¡İ_·¿m
;

2034 
UINT8
 
¶ay_¡©e
;

2038 
¶ay_¡©e
 = 
­p_av_cb
.play_state;

2039 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPING
;

2040 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_STOPPED
);

2043 
¡©us
 = 
	`BSA_AvStİIn™
(&
¡İ_·¿m
);

2044 
¡İ_·¿m
.
·u£
 = 
FALSE
;

2045 
¡©us
 = 
	`BSA_AvStİ
(&
¡İ_·¿m
);

2046 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2048 
­p_av_cb
.
¶ay_¡©e
 =…lay_state;

2049 
	`APP_ERROR1
("BSA_AvStİ faed: %d", 
¡©us
);

2050  
¡©us
;

2055 
	}
}

2066 
	$­p_av_¡İ
()

2068 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

2070  
	`­p_av_¡İ_cu¼’t
();

2071 
	}
}

2082 
	$­p_av_·u£
()

2084 
¡©us
;

2085 
tBSA_AV_STOP
 
¡İ_·¿m
;

2086 
UINT8
 
¶ay_¡©e
;

2090 
¶ay_¡©e
 = 
­p_av_cb
.play_state;

2092 if((
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STOPPED
) ||

2093 (
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
))

2096 
	`APP_DEBUG1
("­p_av_·u£ -‡Ì—dy…au£d o¸¡İ³d, %d", 
­p_av_cb
.
¶ay_¡©e
);

2097  
BSA_SUCCESS
;

2100 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_PAUSED
;

2101 
	`­p_av_rc_chªge_¶ay_¡©us
(
BSA_AVRC_PLAYSTATE_PAUSED
);

2104 
¡©us
 = 
	`BSA_AvStİIn™
(&
¡İ_·¿m
);

2105 
¡İ_·¿m
.
·u£
 = 
TRUE
;

2106 
¡©us
 = 
	`BSA_AvStİ
(&
¡İ_·¿m
);

2107 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2109 
­p_av_cb
.
¶ay_¡©e
 =…lay_state;

2110 
	`APP_ERROR1
("BSA_AvStİ faed: %d", 
¡©us
);

2111  
¡©us
;

2115 
	}
}

2126 
	$­p_av_»sume
()

2128 
¡©us
;

2129 
tBSA_AV_START
 
¡¬t_·¿m
;

2132 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

2133 
¡¬t_·¿m
.
medŸ_ãedšg
 = 
­p_av_cb
.media_feeding;

2134 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

2135 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

2138 
¡¬t_·¿m
.
ı_id
 = 
­p_av_cb
.cp_id;

2139 
¡¬t_·¿m
.
scm¡_æag
 = 
­p_av_cb
.
ı_scms_æag
;

2141 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

2142 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2144 
	`APP_ERROR1
("BSA_AvS¹ faed: %d", 
¡©us
);

2145  
¡©us
;

2149 
	}
}

2160 
	$­p_av_rc_£nd_commªd
(
šdex
, 
commªd
)

2162 
¡©us
;

2163 
tBSA_AV_REM_CMD
 
b§_av_rc_cmd
;

2166 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2168 
	`APP_ERROR0
("Connection index out of bounds");

2173 
¡©us
 = 
	`BSA_AvRemÙeCmdIn™
(&
b§_av_rc_cmd
);

2174 
b§_av_rc_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2175 
b§_av_rc_cmd
.
key_¡©e
 = 
BSA_AV_STATE_PRESS
;

2176 
b§_av_rc_cmd
.
rc_id
 = (
tBSA_AV_RC
)
commªd
;

2177 
b§_av_rc_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2178 
¡©us
 = 
	`BSA_AvRemÙeCmd
(&
b§_av_rc_cmd
);

2179 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2181 
	`APP_ERROR1
("BSA_AvRemÙeCmd faed: %d", 
¡©us
);

2182  
¡©us
;

2185 
	}
}

2196 
	$­p_av_rc_£nd_absŞu‹_vŞume_vd_commªd
(
šdex
, 
vŞume
)

2198 
¡©us
;

2199 
tBSA_AV_VEN_CMD
 
b§_av_vd_cmd
;

2202 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2204 
	`APP_ERROR0
("Connection index out of bounds");

2209 
¡©us
 = 
	`BSA_AvV’dÜCmdIn™
(&
b§_av_vd_cmd
);

2210 
b§_av_vd_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2211 
b§_av_vd_cmd
.
ùy³
 = 
BSA_AV_CMD_CTRL
;

2212 
b§_av_vd_cmd
.
d©a
[0] = 
BSA_AV_RC_VD_SET_ABSOLUTE_VOLUME
;

2213 
b§_av_vd_cmd
.
d©a
[1] = 0;

2214 
b§_av_vd_cmd
.
d©a
[2] = 0;

2215 
b§_av_vd_cmd
.
d©a
[3] = 1;

2216 
b§_av_vd_cmd
.
d©a
[4] = 
vŞume
;

2217 
b§_av_vd_cmd
.
Ëngth
 = 5;

2218 
b§_av_vd_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2219 
¡©us
 = 
	`BSA_AvV’dÜCmd
(&
b§_av_vd_cmd
);

2220 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2222 
	`APP_ERROR1
("BSA_AvV’dÜCmd faed: %d", 
¡©us
);

2223  
¡©us
;

2226 
	}
}

2237 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_vd_commªd
(
šdex
)

2239 
¡©us
;

2240 
tBSA_AV_VEN_CMD
 
b§_av_vd_cmd
;

2243 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2245 
	`APP_ERROR0
("Connection index out of bounds");

2250 
¡©us
 = 
	`BSA_AvV’dÜCmdIn™
(&
b§_av_vd_cmd
);

2251 
b§_av_vd_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2252 
b§_av_vd_cmd
.
ùy³
 = 
BSA_AV_CMD_STATUS
;

2253 
b§_av_vd_cmd
.
d©a
[0] = 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
;

2254 
b§_av_vd_cmd
.
d©a
[1] = 0;

2255 
b§_av_vd_cmd
.
d©a
[2] = 0;

2256 
b§_av_vd_cmd
.
d©a
[3] = 0x11;

2260 
b§_av_vd_cmd
.
d©a
[12] = 2;

2263 
b§_av_vd_cmd
.
d©a
[16] = 0x1;

2266 
b§_av_vd_cmd
.
d©a
[20] = 0x7;

2268 
b§_av_vd_cmd
.
Ëngth
 = 21;

2269 
b§_av_vd_cmd
.
Ïb–
 = 
­p_av_cb
.label++;

2270 
¡©us
 = 
	`BSA_AvV’dÜCmd
(&
b§_av_vd_cmd
);

2271 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2273 
	`APP_ERROR1
("BSA_AvV’dÜCmd faed: %d", 
¡©us
);

2274  
¡©us
;

2277 
	}
}

2290 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_vd_»¥Ú£
(
šdex
)

2293 
¡©us
, 
©Œ_id
;

2294 
UINT8
 
xx
, 
©Œ_couÁ
;

2295 
tBSA_AV_VEN_RSP
 
b§_av_vd_r¥
;

2296 *
p_¡r
;

2297 
UINT16
 
ch¬£t_id
, 
¡r_Ën
, 
Ën
;

2298 
UINT8
 *
p_d©a
;

2301 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2303 
	`APP_ERROR0
("Connection index out of bounds");

2308 
¡©us
 = 
	`BSA_AvV’dÜR¥In™
(&
b§_av_vd_r¥
);

2309 
b§_av_vd_r¥
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2310 
b§_av_vd_r¥
.
ùy³
 = 0xc;

2311 
b§_av_vd_r¥
.
d©a
[0] = 
BSA_AV_RC_VD_GET_ELEMENT_ATTR
;

2312 
b§_av_vd_r¥
.
d©a
[1] = 0;

2314 
Ën
 = 0;

2315 
¡r_Ën
 = 0;

2316 
©Œ_couÁ
 = 7;

2318 
p_d©a
 = &
b§_av_vd_r¥
.
d©a
[4];

2319 
	`UINT8_TO_BE_STREAM
(
p_d©a
, 
©Œ_couÁ
);

2320 
Ën
 = 1 ;

2322 
xx
=0; xx<
©Œ_couÁ
; xx++)

2324 
©Œ_id
 = 
xx
 + 1;

2326 
©Œ_id
)

2328 
AVRC_MEDIA_ATTR_ID_TITLE
:

2329 
p_¡r
 = (*) "Happy Nation";

2331 
AVRC_MEDIA_ATTR_ID_ARTIST
:

2332 
p_¡r
 = (*) "Jonas, Jenny, Linn, Ulf";

2334 
AVRC_MEDIA_ATTR_ID_ALBUM
:

2335 
p_¡r
 = (*) "Ace of Base";

2337 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
:

2338 
p_¡r
 = (*) "7";

2340 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
:

2341 
p_¡r
 = (*) "15";

2343 
AVRC_MEDIA_ATTR_ID_GENRE
:

2344 
p_¡r
 = (*) "Pop";

2346 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
:

2347 
p_¡r
 = (*) "255000";

2350 
p_¡r
 = 
NULL
;

2353 ià(
p_¡r
)

2355 
¡r_Ën
 = 
	`¡¾’
(
p_¡r
);

2356 
ch¬£t_id
 = 
AVRC_CHARSET_ID_UTF8
;

2358 
	`UINT32_TO_BE_STREAM
(
p_d©a
, 
©Œ_id
);

2359 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
ch¬£t_id
);

2360 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
¡r_Ën
);

2361 
	`ARRAY_TO_BE_STREAM
(
p_d©a
, 
p_¡r
, 
¡r_Ën
);

2363 
Ën
 =†’ + 4 + 2 + 2 + 
¡r_Ën
;

2368 
p_d©a
 = &
b§_av_vd_r¥
.
d©a
[2];

2369 
	`UINT16_TO_BE_STREAM
(
p_d©a
, 
Ën
);

2373 
b§_av_vd_r¥
.
Ëngth
 = 4 + 
Ën
;

2375 
b§_av_vd_r¥
.
Ïb–
 = 
­p_av_cb
.label++;

2376 
¡©us
 = 
	`BSA_AvV’dÜR¥
(&
b§_av_vd_r¥
);

2377 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2379 
	`APP_ERROR1
("BSA_AvV’dÜR¥ faed: %d", 
¡©us
);

2380  
¡©us
;

2383 
	}
}

2397 
	$­p_av_rc_£nd_g‘_–em’t_©Œibu‹s_m‘a_»¥Ú£
(
šdex
)

2399 
	`APP_INFO0
("app_av_rc_send_get_element_attributes_meta_response");

2401 
¡©us
;

2402 
UINT8
 
xx
, 
©Œ_couÁ
;

2403 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2405 
tBSA_AV_ATTR_ENTRY
 *
p_©Œ
 = 
NULL
;

2408 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2410 
	`APP_ERROR0
("Connection index out of bounds");

2414 if(
p_b§_av_cb
->
cur_¶ay
 >ğ
BSA_AV_NUMSONGS
)

2416 
	`APP_ERROR0
("song index out of bounds");

2421 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2423 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2424 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_ELEMENT_ATTR
;

2426 
©Œ_couÁ
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->attr_count;

2427 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
num_©Œs
 = 
©Œ_couÁ
;

2429 
p_©Œ
 = (
tBSA_AV_ATTR_ENTRY
 *è&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
©Œs
;

2431 
xx
=0; xx<
©Œ_couÁ
; xx++)

2433 
p_©Œ
[
xx
].
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.charset_id;

2434 
p_©Œ
[
xx
].
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.str_len;

2435 
p_©Œ
[
xx
].
©Œ_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].attr_id;

2437 if(
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
Çme
.
¡r_Ën
 !ğ0 && b§_av_sÚgs[p_b§_av_cb->cur_¶ay]->p_©Œ_li¡[xx].Çme.
p_¡r
)

2439 
	`¡ºıy
((*è
p_©Œ
[
xx
].
¡r
, (*è
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].
Çme
.
p_¡r
, 
BSA_AV_META_INFO_LEN_MAX
 - 1);

2440 
	`APP_INFO1
("A‰¸ID %d, sŒšg‚am%s", 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
©Œ_id
, 
p_©Œ
[xx].
¡r
);

2444 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2446 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2447 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2449 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2450  
¡©us
;

2453 
	}
}

2464 
	$­p_av_rc_£nd_¶ay_¡©us_m‘a_»¥Ú£
(
šdex
)

2466 
	`APP_INFO0
("app_av_rc_send_play_status_meta_response");

2468 
¡©us
;

2469 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2472 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2474 
	`APP_ERROR0
("Connection index out of bounds");

2479 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2481 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2482 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_PLAY_STATUS
;

2483 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2484 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
sÚg_Ën
 = (
UINT32
) 255000;

2485 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
sÚg_pos
 = (
UINT32
) 120000;

2487 if(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STARTED
)

2488 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_PLAYING
 ;

2489 if(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
)

2490 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_PAUSED
;

2492 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
 = 
BSA_AVRC_PLAYSTATE_STOPPED
;

2494 
	`APP_INFO1
("PÏy stu ğ%d", 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_¶ay_¡©us
.
¶ay_¡©us
);

2496 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2497 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2499 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2500  
¡©us
;

2503 
	}
}

2514 
	$­p_av_rc_£t_addr_¶ay”_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2517 
¡©us
;

2518 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2519 
UINT8
 
xx
;

2522 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2524 
	`APP_ERROR0
("Connection index out of bounds");

2528 if(
pM‘aMsg
 =ğ
NULL
)

2530 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2535 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2537 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2539 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2540  
¡©us
;

2543 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2544 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_SET_ADDRESSED_PLAYER
;

2545 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2546 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2547 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2551 
xx
=0; xx<
BSA_AV_NUM_MPLAYERS
; xx++)

2553 ià(
b§_av_¶ay”s
[
xx
] && 
pM‘aMsg
->
¶ay”_id
 == bsa_av_players[xx]->player_id)

2555 
	`APP_INFO1
("S‘Add»s£dPÏy” sucûeded ID %d", 
pM‘aMsg
->
¶ay”_id
);

2556 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 
pM‘aMsg
->
¶ay”_id
;

2561 ià(
xx
 =ğ
BSA_AV_NUM_MPLAYERS
)

2563 
b§_av_m‘a_r¥_cmd
.
·¿m
.
addr_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_BAD_PLAYER_ID
;

2564 
	`APP_INFO1
("S‘Add»s£dPÏy” faed bad ID %d", 
pM‘aMsg
->
¶ay”_id
);

2567 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2568 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2570 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2571  
¡©us
;

2574 
	}
}

2586 
	$­p_av_rc_£t_brow£d_¶ay”_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2589 
¡©us
;

2590 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2591 
UINT8
 
xx
;

2594 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2596 
	`APP_ERROR0
("Connection index out of bounds");

2600 if(
pM‘aMsg
 =ğ
NULL
)

2602 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2607 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2609 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2611 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2612  
¡©us
;

2615 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2616 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_SET_BROWSED_PLAYER
;

2617 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2618 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2619 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2623 
xx
=0; xx<
BSA_AV_NUM_MPLAYERS
; xx++)

2625 ià(
b§_av_¶ay”s
[
xx
] && 
pM‘aMsg
->
¶ay”_id
 == bsa_av_players[xx]->player_id &&

2626 
	`AVRC_PF_BROWSE_SUPPORTED
(
b§_av_¶ay”s
[
xx
]->
ã©u»s
))

2628 
	`APP_INFO1
("S‘BÜw£dPÏy” sucûeded ID %d", 
pM‘aMsg
->
¶ay”_id
);

2629 
p_b§_av_cb
->
m‘a_šfo
.
brow£d_¶ay”_id
 = 
pM‘aMsg
->
¶ay”_id
;

2631 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
num_™ems
 = 
BSA_AV_NUMSONGS
;

2632 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
ch¬£t_id
 = 
AVRC_CHARSET_ID_UTF8
;

2633 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_d•th
 = 0;

2634 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_Çme_size
 = 14;

2635 
	`¡rıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
fŞd”_Çme_¡r
, "Player 1 files");

2641 ià(
xx
 =ğ
BSA_AV_NUM_MPLAYERS
)

2643 
b§_av_m‘a_r¥_cmd
.
·¿m
.
brow£d_¶ay”_¡©us
.
¡©us
 = 
AVRC_STS_BAD_PLAYER_ID
;

2644 
	`APP_INFO1
("S‘Brow£dPÏy” faed bad ID %d", 
pM‘aMsg
->
¶ay”_id
);

2647 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2648 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2650 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2651  
¡©us
;

2654 
	}
}

2665 
	$­p_av_rc_chªge_·th_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2667 
	`APP_INFO0
("app_av_rc_change_path_meta_response");

2669 
¡©us
;

2670 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2673 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2675 
	`APP_ERROR0
("Connection index out of bounds");

2679 if(
pM‘aMsg
 =ğ
NULL
)

2681 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2686 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2688 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2690 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2691  
¡©us
;

2694 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2695 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_CHANGE_PATH
;

2696 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2697 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
İcode
 = 
pM‘aMsg
->opcode;

2700 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
¡©us
 = 
AVRC_STS_BAD_DIR
;

2701 
b§_av_m‘a_r¥_cmd
.
·¿m
.
chªge_·th
.
num_™ems
 = 0;

2703 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2704 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2706 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2707  
¡©us
;

2710 
	}
}

2722 
	$­p_av_rc_g‘_™em_©Œ_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2724 
	`APP_INFO0
("app_av_rc_get_item_attr_meta_response");

2727 
UINT8
 
xx
, 
©Œ_couÁ
;

2728 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2729 
¡©us
;

2731 
tBSA_AV_ATTR_ENTRY
 *
p_©Œ
 = 
NULL
;

2734 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2736 
	`APP_ERROR0
("Connection index out of bounds");

2741 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2743 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2744 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_ITEM_ATTRIBUTES
;

2746 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™em_©Œs
.
İcode
 = 
pM‘aMsg
->param.get_item_attrs.opcode;

2748 
©Œ_couÁ
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->attr_count;

2749 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
num_©Œs
 = 
©Œ_couÁ
;

2751 
p_©Œ
 = (
tBSA_AV_ATTR_ENTRY
 *è&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_–em_©Œs
.
©Œs
;

2753 
xx
=0; xx<
©Œ_couÁ
; xx++)

2755 
p_©Œ
[
xx
].
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.charset_id;

2756 
p_©Œ
[
xx
].
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].name.str_len;

2757 
p_©Œ
[
xx
].
©Œ_id
 = 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].attr_id;

2759 if(
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
Çme
.
¡r_Ën
 !ğ0 && b§_av_sÚgs[p_b§_av_cb->cur_¶ay]->p_©Œ_li¡[xx].Çme.
p_¡r
)

2761 
	`¡ºıy
((*è
p_©Œ
[
xx
].
¡r
, (*è
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[xx].
Çme
.
p_¡r
, 
BSA_AV_META_INFO_LEN_MAX
 - 1);

2762 
	`APP_INFO1
("A‰¸ID %d, sŒšg‚am%s", 
b§_av_sÚgs
[
p_b§_av_cb
->
cur_¶ay
]->
p_©Œ_li¡
[
xx
].
©Œ_id
, 
p_©Œ
[xx].
¡r
);

2767 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2769 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2770 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2772 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2773  
¡©us
;

2776 
	}
}

2787 
	$­p_av_rc_g‘_fŞd”_™ems
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2789 
	`APP_INFO0
("app_av_rc_get_folder_items");

2791 
¡©us
;

2792 
UINT8
 
xx
;

2794 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2797 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2799 
	`APP_ERROR0
("Connection index out of bounds");

2803 if(
pM‘aMsg
 =ğ
NULL
)

2805 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2810 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2812 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2814 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2815  
¡©us
;

2818 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2819 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_GET_FOLDER_ITEMS
;

2820 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2822 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 = 
pM‘aMsg
->·¿m.
g‘_fŞd”_™ems
.scope;

2823 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

2825 if(
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 =ğ
AVRC_SCOPE_PLAYER_LIST
)

2827 
	`APP_INFO0
("AVRC_SCOPE_PLAYER_LIST");

2829 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
 = 0;

2830 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2832 
	`APP_INFO1
("G‘FŞd”I‹m -†i¡…Ïy”„ªg%dØ%d", 
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
,…M‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
);

2833 
	`APP_INFO1
("num oàavaabË…Ïy” %d", 
BSA_AV_NUM_MPLAYERS
);

2835 
xx
=
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
; xx<
BSA_AV_NUM_MPLAYERS
 && xx <õM‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
 ; xx++)

2837 ià(
b§_av_¶ay”s
[
xx
])

2839 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_ty³
 = 
AVRC_ITEM_PLAYER
;

2840 
	`memıy
(&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
¶ay”
, 
b§_av_¶ay”s
[xx], (
tBSA_ITEM_PLAYER
));

2841 
	`¡ºıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_¡r
, (*)
b§_av_¶ay”s
[xx]->
Çme
.
p_¡r
, 
BSA_AV_ITEM_NAME_LEN_MAX
 - 1);

2842 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
++;

2843 
	`APP_INFO1
("MedŸ…Ïy” ID %d,‚am%s", 
b§_av_¶ay”s
[
xx
]->
¶ay”_id
, b§_av_¶ay”s[xx]->
Çme
.
p_¡r
);

2848 if(
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
 =ğ
AVRC_SCOPE_FILE_SYSTEM
)

2850 
	`APP_INFO0
("AVRC_SCOPE_FILE_SYSTEM");

2852 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

2853 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
uid_couÁ”
 = 
BSA_AV_NUMSONGS
;

2855 
xx
=
pM‘aMsg
->
·¿m
.
g‘_fŞd”_™ems
.
¡¬t_™em
; xx<
BSA_AV_NUMSONGS
 && xx <õM‘aMsg->·¿m.g‘_fŞd”_™ems.
’d_™em
 ; xx++)

2857 ià(
b§_av_sÚgs
[
xx
])

2859 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_ty³
 = 
AVRC_ITEM_MEDIA
;

2860 
	`memıy
(&
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
uid
, 
b§_av_sÚgs
[xx]->uid, (
tBSA_UID
));

2861 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
ty³
 = 
b§_av_sÚgs
[xx]->type;

2862 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
Çme
.
ch¬£t_id
 = 
b§_av_sÚgs
[xx]->name.charset_id;

2863 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
Çme
.
¡r_Ën
 = 
b§_av_sÚgs
[xx]->name.str_len;

2864 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
u
.
medŸ
.
©Œ_couÁ
 = 0;

2866 
	`¡ºıy
((*)
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
™em_li¡
[
xx
].
™em_¡r
, (*)
b§_av_sÚgs
[xx]->
Çme
.
p_¡r
, 
BSA_AV_ITEM_NAME_LEN_MAX
 - 1);

2867 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
num_™ems
++;

2869 
	`APP_INFO1
("sÚg‚am%s", 
b§_av_sÚgs
[
xx
]->
Çme
.
p_¡r
);

2875 
	`APP_INFO1
("G‘FŞd”I‹ms, scİ%d‚Ù suµÜ‹d", 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
scİe
);

2876 
b§_av_m‘a_r¥_cmd
.
·¿m
.
g‘_™ems_¡©us
.
¡©us
 = 
AVRC_STS_BAD_CMD
;

2879 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2880 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2882 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2883  
¡©us
;

2886 
	}
}

2897 
	$­p_av_rc_¶ay_™em_m‘a_»¥Ú£
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2900 
¡©us
;

2901 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2902 
xx
=0;

2905 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2907 
	`APP_ERROR0
("Connection index out of bounds");

2911 if(
pM‘aMsg
 =ğ
NULL
)

2913 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

2918 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2920 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2922 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2923  
¡©us
;

2926 
	`APPL_TRACE_DEBUG3
("app_av_rc_play_item_meta_response scope:%d, uid[0]:0x%02d, uid[7]:0x%02",

2927 
pM‘aMsg
->
·¿m
.
¶ay_™em
.
scİe
,pM‘aMsg->·¿m.¶ay_™em.
uid
[0],…MetaMsg->param.play_item.uid[7]);

2928 
pM‘aMsg
->
·¿m
.
¶ay_™em
.
scİe
)

2930 
AVRC_SCOPE_FILE_SYSTEM
:

2931 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_REJ
;

2932 
xx
=0; xx<
BSA_AV_NUMSONGS
; xx++)

2934 if(
	`memcmp
(
b§_av_sÚgs
[
xx
]->
uid
, 
pM‘aMsg
->
·¿m
.
¶ay_™em
.uid, (
tBSA_UID
)) == 0)

2936 
p_b§_av_cb
->
cur_¶ay
 = 
xx
;

2937 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_ACCEPT
;

2938 
	`­p_av_rc_chªge_Œack
();

2947 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
¡©us
 = 
BTA_AV_RSP_NOT_IMPL
;

2950 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
pdu
 = 
BSA_AVRC_PDU_PLAY_ITEM
;

2951 
b§_av_m‘a_r¥_cmd
.
·¿m
.
¶ay_™em
.
İcode
 = 
pM‘aMsg
->opcode;

2952 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

2953 
b§_av_m‘a_r¥_cmd
.
pdu
 = 
BSA_AVRC_PDU_PLAY_ITEM
;

2954 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

2956 
¡©us
 = 
	`BSA_AvM‘aR¥
(&
b§_av_m‘a_r¥_cmd
);

2957 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2959 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

2960  
¡©us
;

2963 
	}
}

2975 
	$­p_av_rc_»gi¡”_nÙifiÿtiÚs
(
šdex
, 
tBSA_AV_META_MSG_MSG
 *
pM‘aMsg
)

2977 
UINT16
 
evt_mask
 = 1, 
šdex_x
;

2980 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

2982 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

2984 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2986 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

2987  
¡©us
;

2992 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

2994 
	`APP_ERROR0
("Connection index out of bounds");

2998 if(
pM‘aMsg
 =ğ
NULL
)

3000 
	`APP_ERROR0
("NullBSA_AV_META_MSG_MSG…ointer");

3004 
šdex_x
 = 
pM‘aMsg
->
·¿m
.
»g_nÙif
.
ev’t_id
 - 1;

3005 
evt_mask
 <<ğ
šdex_x
;

3007 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

3008 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

3010 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
İcode
 = 
pM‘aMsg
->opcode;

3011 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
code
 = 
BTA_AV_RSP_INTERIM
;

3014 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 |=ƒvt_mask;

3015 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
šdex_x
] = 
pM‘aMsg
->label;

3017  
	`­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
pM‘aMsg
->
·¿m
.
»g_nÙif
.
ev’t_id
, &
b§_av_m‘a_r¥_cmd
);

3018 
	}
}

3030 
	$­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
UINT8
 
ev’t_id
)

3033 
tBSA_AV_META_RSP_CMD
 
b§_av_m‘a_r¥_cmd
;

3035 
¡©us
 = 
	`BSA_AvM‘aR¥In™
(&
b§_av_m‘a_r¥_cmd
);

3037 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3039 
	`APP_ERROR1
("BSA_AvM‘aR¥In™ faed: %d", 
¡©us
);

3044 
tBSA_AV_EVT_MASK
 
evt_mask
 = 1;

3045 
UINT8
 
rc_Ïb–
;

3049 
evt_mask
 <<ğ(
ev’t_id
 - 1);

3051 ià(
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &ƒvt_mask)

3053 
	`APPL_TRACE_DEBUG2
("Event(0x%x) was„egistered(0x%x)ƒvt_mask:0x%x",

3054 
ev’t_id
,

3055 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 );

3058 
rc_Ïb–
 = 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
ev’t_id
-1];

3059 
b§_av_m‘a_r¥_cmd
.
·¿m
.
nÙify_¡©us
.
code
 = 
BTA_AV_RSP_CHANGED
;

3060 
b§_av_m‘a_r¥_cmd
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[0].rc_handle;

3061 
b§_av_m‘a_r¥_cmd
.
Ïb–
 = 
­p_av_cb
.label;

3063 
	`­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
ev’t_id
, &
b§_av_m‘a_r¥_cmd
);

3066 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &= ~evt_mask;

3067 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
Ïb–
[
ev’t_id
-1] = 0xFF;

3069 
	`APPL_TRACE_DEBUG3
("EVENT NOTIF - Registeredƒvt val‡fter 0x%x clearing:0x%x†abel %d",

3070 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
,ƒvt_mask, 
rc_Ïb–
 );

3077 
	`APPL_TRACE_DEBUG1
("NÙ„egi¡”edƒv’ˆrcvd:0x%x", 
ev’t_id
);

3079 
	}
}

3090 
BOOLEAN
 
	$­p_av_is_ev’t_»gi¡”ed
(
UINT8
 
ev’t_id
)

3092 
tBSA_AV_EVT_MASK
 
evt_mask
 = 1;

3093 
evt_mask
 <<ğ(
ev’t_id
 - 1);

3094 ià(
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 &ƒvt_mask)

3095  (
TRUE
);

3097  (
FALSE
);

3098 
	}
}

3109 
	$­p_av_bud_nÙifiÿtiÚ_»¥Ú£
(
UINT8
 
ev’t_id
, 
tBSA_AV_META_RSP_CMD
 *
p_b§_av_m‘a_r¥_cmd
)

3111 
¡©us
;

3112 
tBSA_AV_META_ATTRIB
 *
p_·s_©Œib
;

3113 
UINT8
 
xx
;

3114 
UINT8
 *
p
;

3116 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
¡©us
 = 
AVRC_STS_NO_ERROR
;

3118 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
ev’t_id
 =ƒvent_id;

3119 
p_b§_av_m‘a_r¥_cmd
->
pdu
 = 
BSA_AVRC_PDU_REGISTER_NOTIFICATION
;

3121 
ev’t_id
)

3123 
AVRC_EVT_PLAY_STATUS_CHANGE
:

3124 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.play_status.play_status;

3127 
AVRC_EVT_TRACK_CHANGE
:

3128 
p
 = 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
Œack
;

3129 
	`APPL_TRACE_DEBUG2
("¶ay_couÁ %d cur_¶ay %d",
p_b§_av_cb
->
¶ay_couÁ
,…_b§_av_cb->
cur_¶ay
);

3131 ià(
p_b§_av_cb
->
¶ay_couÁ
 == 0 )

3134 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NO_NOW_PLAYING_FOLDER_ID
);

3135 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NO_NOW_PLAYING_FILE_ID
);

3140 
	`UINT32_TO_BE_STREAM
(
p
, 
AVRCP_NOW_PLAYING_FOLDER_ID
);

3141 
	`UINT32_TO_BE_STREAM
(
p
, 
p_b§_av_cb
->
cur_¶ay
+1);

3145 
AVRC_EVT_TRACK_REACHED_END
:

3146 
AVRC_EVT_TRACK_REACHED_START
:

3149 
AVRC_EVT_PLAY_POS_CHANGED
:

3150 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay_pos
 = 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.
sÚg_pos
;

3153 
AVRC_EVT_BATTERY_STATUS_CHANGE
:

3154 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
b©‹ry_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
nÙif_šfo
.
b©_¡©
;

3157 
AVRC_EVT_SYSTEM_STATUS_CHANGE
:

3158 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
sy¡em_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
nÙif_šfo
.
sys_¡©
;

3161 
AVRC_EVT_APP_SETTING_CHANGE
:

3162 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
num_©Œ
 = 
p_b§_av_cb
->
m‘a_šfo
.
max_©Œib_num
;

3163 
p_·s_©Œib
 = &
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
;

3164 
xx
=0; xx<
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
num_©Œ
; xx++)

3166 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
©Œ_id
[
xx
] = 
p_·s_©Œib
->
©Œib_id
;

3167 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
¶ay”_£‰šg
.
©Œ_v®ue
[
xx
] = 
p_·s_©Œib
->
cu¼_v®ue
;

3168 
p_·s_©Œib
++;

3172 
AVRC_EVT_NOW_PLAYING_CHANGE
:

3173 
AVRC_EVT_AVAL_PLAYERS_CHANGE
:

3176 
AVRC_EVT_ADDR_PLAYER_CHANGE
:

3177 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
addr_¶ay”
.
¶ay”_id
 = 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
;

3179 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
addr_¶ay”
.
uid_couÁ”
 = 
p_b§_av_cb
->
m‘a_šfo
.
cur_uid_couÁ”
;

3182 
AVRC_EVT_UIDS_CHANGE
:

3183 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
uid_couÁ”
 = 0;

3186 
AVRC_EVT_VOLUME_CHANGE
:

3187 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.·¿m.
vŞume
 = 0;

3191 
p_b§_av_m‘a_r¥_cmd
->
·¿m
.
nÙify_¡©us
.
¡©us
 = 
BTA_AV_RSP_NOT_IMPL
;

3196 
¡©us
 = 
	`BSA_AvM‘aR¥
(
p_b§_av_m‘a_r¥_cmd
);

3197 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3199 
	`APP_ERROR1
("BSA_AvM‘aR¥ faed: %d", 
¡©us
);

3200  
¡©us
;

3203 
	`APPL_TRACE_DEBUG1
("­p_av_bud_nÙifiÿtiÚ_»¥Ú£ %d", 
ev’t_id
)

3205 
	}
}

3217 
	$­p_av_rc_chªge_¶ay_¡©us
(
UINT8
 
Ãw_¶ay_¡©us
)

3219 if(
Ãw_¶ay_¡©us
 <ğ(
UINT8
)
AVRC_PLAYSTATE_REV_SEEK
)

3221 
UINT8
 
Şd_¶ay_¡©us
 = 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status;

3223 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.¶ay_¡©u ğ
Ãw_¶ay_¡©us
;

3224 
	`APPL_TRACE_DEBUG2
("¶ay_¡©u ğ%d/%d", 
Şd_¶ay_¡©us
, 
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status );

3225 ià(
Şd_¶ay_¡©us
 !ğ
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
.play_status)

3227 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_PLAY_STATUS_CHANGE
);

3228 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_PLAY_POS_CHANGED
);

3233 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoà¶ay_¡©u ğ%d", 
Ãw_¶ay_¡©us
);

3236 
	}
}

3248 
	$­p_av_rc_chªge_Œack
()

3250 
p_b§_av_cb
->
m‘a_šfo
.
Œack_num
++;

3251 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_TRACK_CHANGE
);

3252 
	}
}

3264 
	$­p_av_rc_add»s£d_¶ay”_chªge
(
UINT16
 
addr_¶ay”
)

3267 if((
addr_¶ay”
 !ğ
BSA_AV_PLAYER_ID_FILES
) &&

3268 (
addr_¶ay”
 !ğ
BSA_AV_PLAYER_ID_MPLAYER
)

3271 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoàadd»s£d…Ïy” = %d", 
addr_¶ay”
);

3275 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 
addr_¶ay”
;

3276 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_ADDR_PLAYER_CHANGE
);

3277 
	}
}

3289 
	$­p_av_rc_£‰šgs_chªge
(
UINT8
 
£‰šg
, UINT8 
v®ue
)

3292 if(
£‰šg
 !ğ
AVRC_PLAYER_SETTING_EQUALIZER
 &&

3293 
£‰šg
 !ğ
AVRC_PLAYER_SETTING_REPEAT
 &&

3294 
£‰šg
 !ğ
AVRC_PLAYER_SETTING_SHUFFLE
)

3296 
	`APPL_TRACE_ERROR1
("IÎeg® v®uoà£‰šg = %d", 
£‰šg
);

3301 if(
v®ue
 != 0x1 && value != 0x2)

3303 
	`APPL_TRACE_ERROR1
("IÎeg® s‘tšg v®uğ%d", 
v®ue
);

3307 
£‰šg
)

3310 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
cu¼_v®ue
 = 
v®ue
;

3313 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 
v®ue
;

3316 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 
v®ue
;

3320 
	`­p_av_rc_com¶‘e_nÙifiÿtiÚ
(
AVRC_EVT_APP_SETTING_CHANGE
);

3321 
	}
}

3333 
	$­p_av_š™_m‘a_d©a
()

3335 if(
p_b§_av_cb
 =ğ
NULL
)

3336 
p_b§_av_cb
 = 
	`m®loc
((
tBSA_AV_CB
));

3338 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œib_id
 = 1;

3339 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
cu¼_v®ue
 = 1;

3341 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œib_¡r
, "Equalizer");

3342 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œ_£‰šgs
[0].
v®1
, "Off");

3343 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
equ®iz”
.
©Œ_£‰šgs
[1].
v®2
, "On");

3345 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œib_id
 = 2;

3346 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
cu¼_v®ue
 = 2;

3348 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œib_¡r
, "Repeat");

3349 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œ_£‰šgs
[0].
v®1
, "Repeat Off");

3350 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
»³©
.
©Œ_£‰šgs
[1].
v®2
, "Repeat Single");

3352 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œib_id
 = 3;

3353 
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
cu¼_v®ue
 = 2;

3355 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œib_¡r
, "Shuffle");

3356 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œ_£‰šgs
[0].
v®1
, "Shuffle Off");

3357 
	`¡rıy
((*)
p_b§_av_cb
->
m‘a_šfo
.
·s_šfo
.
shufæe
.
©Œ_£‰šgs
[1].
v®2
, "Shuffle All");

3359 
p_b§_av_cb
->
m‘a_šfo
.
max_©Œib_num
 = 3;

3361 
	`memıy
(&
p_b§_av_cb
->
m‘a_šfo
.
¶ay_¡©us
, &
¶ay¡
, (
tBSA_AV_META_PLAYSTAT
));

3363 
p_b§_av_cb
->
m‘a_šfo
.
addr_¶ay”_id
 = 1;

3364 
p_b§_av_cb
->
m‘a_šfo
.
brow£d_¶ay”_id
 = 1;

3365 
p_b§_av_cb
->
m‘a_šfo
.
cur_uid_couÁ”
 = 0;

3366 
p_b§_av_cb
->
m‘a_šfo
.
»gi¡”ed_ev’ts
.
evt_mask
 = 0;

3367 
p_b§_av_cb
->
m‘a_šfo
.
Œack_num
 = 1;

3368 
p_b§_av_cb
->
cur_¶ay
 = 0;

3369 
p_b§_av_cb
->
¶ay_couÁ
 = 
BSA_AV_NUMSONGS
;

3371 
	}
}

3382 
	$­p_av_rc_şo£
(
šdex
)

3384 
¡©us
;

3385 
tBSA_AV_CLOSE_RC
 
b§_av_şo£_rc
;

3388 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

3390 
	`APP_ERROR0
("Connection index out of bounds");

3395 
¡©us
 = 
	`BSA_AvClo£RcIn™
(&
b§_av_şo£_rc
);

3396 
b§_av_şo£_rc
.
rc_hªdË
 = 
­p_av_cb
.
cÚÃùiÚs
[
šdex
].rc_handle;

3397 
¡©us
 = 
	`BSA_AvClo£Rc
(&
b§_av_şo£_rc
);

3398 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3400 
	`APP_ERROR1
("BSA_AvClo£Røçed: %d", 
¡©us
);

3401  
¡©us
;

3405 
	}
}

3416 
	$­p_š™_¶ayli¡
(*
·th
)

3418 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3419 
šdex
;

3421 
­p_av_cb
.
soundfe_li¡_size
 = 
	`­p_¶ayli¡_ü—‹
(
·th
, &­p_av_cb.
soundfe_li¡
);

3422 ià(
­p_av_cb
.
soundfe_li¡_size
 <= 0)

3424 
	`APP_ERROR1
("UÇbËØš™…Ïy†i¡ from:%s", 
·th
);

3428 
šdex
 = 0 ; index < 
­p_av_cb
.
soundfe_li¡_size
 ; index++)

3430 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
šdex
], &
wav_fÜm©
) < 0)

3432 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3436 
	`APP_INFO1
("WAV fÜm© of: %s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3437 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

3438 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

3442  
­p_av_cb
.
soundfe_li¡_size
;

3443 
	}
}

3454 *
	$­p_av_g‘_soundfe_·th
(
fe_šdex
)

3456 ià((
fe_šdex
 >ğ0è&& (fe_šdex < 
­p_av_cb
.
soundfe_li¡_size
))

3458  
­p_av_cb
.
soundfe_li¡
[
fe_šdex
];

3460  
NULL
;

3461 
	}
}

3472 
	$­p_av_di¥Ïy_¶ayli¡
()

3474 
šdex
;

3475 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3477 
	`APP_INFO0
("Play†ist:");

3478 
šdex
 = 0 ; index < 
­p_av_cb
.
soundfe_li¡_size
 ; index++)

3480 ià(
	`­p_wav_fÜm©
(
­p_av_cb
.
soundfe_li¡
[
šdex
], &
wav_fÜm©
) < 0)

3482 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
­p_av_cb
.
soundfe_li¡
[
šdex
]);

3486 
	`APP_INFO1
(" %d : %s", 
šdex
, 
­p_av_cb
.
soundfe_li¡
[index]);

3487 
	`APP_INFO1
(" codec(%sèch(%dèb™s(%dè¿‹(%d)", (
wav_fÜm©
.
codec
==
BSA_AV_CODEC_PCM
)?"PCM":"apt-X",

3488 
wav_fÜm©
.
nb_chªÃls
, wav_fÜm©.
b™s_³r_§m¶e
, ()wav_fÜm©.
§m¶e_¿‹
);

3491  
­p_av_cb
.
soundfe_li¡_size
;

3492 
	}
}

3503 
BOOLEAN
 
	$­p_av_check_ãedšg
(cÚ¡ 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
)

3505 ià(
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
 =ğ
p_fÜm©
->
codec
)

3507 
p_fÜm©
->
codec
)

3509 
BSA_AV_CODEC_PCM
:

3510  (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 =ğ
p_fÜm©
->
nb_chªÃls
) &&

3511 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 =ğ
p_fÜm©
->
§m¶e_¿‹
) &&

3512 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 =ğ
p_fÜm©
->
b™s_³r_§m¶e
);

3514 
BSA_AV_CODEC_APTX
:

3515  (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
§m¶šg_äeq
 =ğ
p_fÜm©
->
§m¶e_¿‹
) &&

3516 (((
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
­tx
.
ch_mode
 =ğ
A2D_SBC_IE_CH_MD_MONO
)?1:2è=ğ
p_fÜm©
->
nb_chªÃls
);

3519 
	`APP_DEBUG0
("Unsupported codec format");

3520  
FALSE
;

3525 
	`APP_ERROR0
("Feeding does‚ot match!!!");

3526  
FALSE
;

3528 
	}
}

3539 
	$­p_uc_tx_th»ad
()

3541 
¡©us
;

3542 
nb_by‹s
 = 0;

3543 
fe_desc
 = -1;

3544 
time¥ec
 
Ãwtime
;

3545 
time_t
 
¡¬t
, 
–­£d
;

3546 
tAPP_AV_DELAY
 
d–ay
;

3547 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

3548 
UINT16
 
uc_”rÜ
 = 0;

3550 
	`APP_DEBUG0
("Starting UIPC Txhread");

3553 
	`APP_DEBUG0
("Waiting for…lay start");

3555 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STARTED
)

3558 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3559 ià(
¡©us
 < 0)

3561 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

3565 
	`APP_DEBUG0
("Play started");

3567 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_TONE
)

3569 
	`APP_DEBUG0
("Playingone");

3571 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_AVK
)

3573 
	`APP_DEBUG0
("Playing from‡vk source");

3575 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

3577 
	`APP_DEBUG1
("PÏyšg f%s", 
­p_av_cb
.
fe_Çme
);

3579 
fe_desc
 = 
	`­p_wav_İ’_fe
(
­p_av_cb
.
fe_Çme
, &
wav_fÜm©
);

3580 ià(
fe_desc
 < 0)

3582 
	`APP_ERROR1
("İ’(%sèçed(%dè-> Stİ…Ïyšg", 
­p_av_cb
.
fe_Çme
, 
”ºo
);

3583 ià(
	`­p_av_¡İ
() != 0)

3589 
	`APP_DEBUG0
("Waiting for AVo stop");

3590 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3595 ià(
	`­p_av_check_ãedšg
(&
wav_fÜm©
è=ğ
FALSE
)

3597 
	`APP_ERROR1
("F“dšg‚Ù com·tibË w™h fe: %s", 
­p_av_cb
.
fe_Çme
);

3598 
	`şo£
(
fe_desc
);

3599 ià(
	`­p_av_¡İ
() != 0)

3605 
	`APP_DEBUG0
("Waiting for AVo stop");

3606 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3608 ià(
	`­p_av_¶ay_¶ayli¡
(
APP_AV_START
) != 0)

3614 
	`APP_DEBUG0
("Playing file successfully");

3616 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_MIC
)

3618 
	`APP_DEBUG0
("Playing MIC Input");

3619 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3620 
	`APP_DEBUG0
("APP_AV_PLAYTYPE_MIC Streaming start");

3625 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_TEST
)

3627 
	`APP_DEBUG0
("Playingest data");

3632 
	`­p_av_d–ay_¡¬t
(&
d–ay
);

3633 
–­£d
 = 0;

3634 
¡¬t
 = 
d–ay
.
time¡amp
.
tv_£c
;

3637 
­p_av_cb
.
¶ay_ty³
)

3639 
APP_AV_PLAYTYPE_TONE
:

3640 
	`­p_av_»ad_tÚe
(
­p_av_cb
.
audio_buf
,‡µ_av_cb.
uc_cfg
.
Ëngth
,

3641 
­p_av_cb
.
sšus_ty³
, &­p_av_cb.
sšus_šdex
);

3642 
nb_by‹s
 = 
­p_av_cb
.
uc_cfg
.
Ëngth
;

3644 
APP_AV_PLAYTYPE_TEST
:

3645 
	`­p_av_»ad_‹¡
(
­p_av_cb
.
audio_buf
,‡µ_av_cb.
£c_äame_size
);

3646 
nb_by‹s
 = 
­p_av_cb
.
£c_äame_size
;

3648 
APP_AV_PLAYTYPE_FILE
:

3649 
nb_by‹s
 = 
	`­p_wav_»ad_d©a
(
fe_desc
, &
wav_fÜm©
, (*)
­p_av_cb
.
audio_buf
,‡µ_av_cb.
uc_cfg
.
Ëngth
);

3651 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3652 
APP_AV_PLAYTYPE_MIC
:

3654 if(
mIng’icA2dpSock‘Fd
 < 0){

3655 
	`APP_DEBUG0
("socket is disconnected");

3658 
¡
 = 0LL;

3659 
tÙ®
 = 0;

3666 
nb_by‹s
 = 
	`SHM_R—d
(
a2dp_¶ayback_cÚ‹xt
,
­p_av_cb
.
audio_buf
,­p_av_cb.
uc_cfg
.
Ëngth
);

3667 if(
nb_by‹s
 == -1)

3669 }
nb_by‹s
 !ğ
­p_av_cb
.
uc_cfg
.
Ëngth
);

3671 
tÙ®
 +ğ
nb_by‹s
;

3673 if(
tÙ®
 > 2 * 1024 * 1024){

3674 
timev®
 
tv
;

3675 
’
,
diff
;

3676 
	`g‘timeofday
(&
tv
,0);

3677 
’
 = 
tv
.
tv_£c
 * (1000*1000LLè+v.
tv_u£c
;

3678 
diff
 = 
’
 - 
¡
;

3679 
¡
 = 
’
;

3680 
	`APP_INFO1
("»cv ouˆtÙ® = %d difàğ%d\n",
tÙ®
,
diff
);

3681 
tÙ®
 = 0;

3688 
APP_AV_PLAYTYPE_AVK
:

3689 
nb_by‹s
 = 0;

3693 
	`APP_ERROR0
("Unsupported…lay_type");

3698 ià(
nb_by‹s
 <= 0)

3700 ià(
­p_av_cb
.
¶ay_ty³
 !ğ
APP_AV_PLAYTYPE_AVK
)

3702 
	`APP_DEBUG0
("No more samples -> stopping current");

3704 
	`­p_av_¡İ_cu¼’t
();

3710 ià(
	`UIPC_S’d
(
­p_av_cb
.
¡»am_uc_chªÃl
, 0, (
UINT8
 *è­p_av_cb.
audio_buf
, 
nb_by‹s
è=ğ
FALSE
)

3712 if(
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
UIPC_READ_ERROR
, &
uc_”rÜ
))

3714 ià(
uc_”rÜ
 =ğ
UIPC_ENOMEM
)

3716 
	`APP_DEBUG0
("UIPC buffer full! Pause…laying");

3717 
	`­p_av_·u£
();

3718 
	`GKI_d–ay
(3000);

3719 
	`APP_DEBUG0
("UIPC buffer full! Resume…laying");

3720 
	`­p_av_»sume
();

3724 
	`APP_ERROR0
("UIPC_Send failed");

3728 #ià(
	`defšed
(
BSA_AV_DUMP_TX_DATA
è&& (BSA_AV_DUMP_TX_DATA =ğ
TRUE
))

3729 
	`APP_DUMP
("A2DP D©a", (
UINT8
 *è
­p_av_cb
.
audio_buf
, 
nb_by‹s
);

3732 ià(
­p_av_cb
.
uc_cfg
.
is_blockšg
 =ğ
FALSE
)

3735 
	`­p_av_wa™_d–ay
(1, &
d–ay
, &
­p_av_cb
.
uc_cfg
);

3739 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
Ãwtime
);

3740 ià((
Ãwtime
.
tv_£c
 - 
¡¬t
è> 
–­£d
)

3742 
–­£d
 = 
Ãwtime
.
tv_£c
 - 
¡¬t
;

3747 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_PAUSED
)

3749 
	`APP_DEBUG0
("Pausing (wait mutex)");

3750 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3751 ià(
¡©us
 < 0)

3753 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

3758 
	`­p_av_d–ay_¡¬t
(&
d–ay
);

3759 
–­£d
 = 0;

3761 
	`APP_DEBUG0
("Un-pausing");

3764 } (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
) &&

3765 (
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPING
));

3767 
	`APP_DEBUG0
("Streaming stopped");

3770 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_FILE
)

3772 
	`şo£
(
fe_desc
);

3774 #ifdeà
USE_INGENIC_AUDIO_SOCKET


3775 ià(
­p_av_cb
.
¶ay_ty³
 =ğ
APP_AV_PLAYTYPE_MIC
)

3777 
	`APP_DEBUG0
("APP_AV_PLAYTYPE_MIC Streaming stopped");

3784 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è
	`GKI_d–ay
(10);

3787 ià(
­p_av_cb
.
¶ay_li¡
)

3790 
	`­p_av_¶ay_¶ayli¡
(
APP_AV_FORWARD
);

3793 
	`APP_DEBUG0
("Exit");

3794 
	`±h»ad_ex™
(
NULL
);

3795 
	}
}

3806 
	$­p_av_»gi¡”
()

3808 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

3809 
tBSA_STATUS
 
¡©us
;

3810 
tBSA_AV_REGISTER
 
»gi¡”_·¿m
;

3812 
cÚÃùiÚ
 = 
	`­p_av_fšd_cÚÃùiÚ_by_¡©us
(
FALSE
, FALSE);

3814 ià(
cÚÃùiÚ
 =ğ
NULL
)

3816 
	`APP_ERROR0
("All‡vailable connections‡lready„egistered");

3821 
	`BSA_AvRegi¡”In™
(&
»gi¡”_·¿m
);

3822 
¡©us
 = 
	`BSA_AvRegi¡”
(&
»gi¡”_·¿m
);

3823 ià(
¡©us
 !ğ
BSA_SUCCESS
)

3825 
	`APP_ERROR1
("BSA_AvRegi¡” faed: %d", 
¡©us
);

3828 
cÚÃùiÚ
->
is_»gi¡”ed
 = 
TRUE
;

3829 
cÚÃùiÚ
->
hªdË
 = 
»gi¡”_·¿m
.handle;

3831 ià(
­p_av_cb
.
¡»am_uc_chªÃl
 =ğ
UIPC_CH_ID_BAD
)

3834 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
»gi¡”_·¿m
.
uc_chªÃl
;

3836 ià(
	`UIPC_O³n
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
NULL
è=ğ
FALSE
)

3838 
	`APP_ERROR1
("UIPC_O³Àçed: %d", 
¡©us
);

3843 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
UIPC_WRITE_BLOCK
, 
NULL
))

3845 
	`APP_ERROR0
("Failed settinghe UIPC‚on blocking");

3851 ià(
»gi¡”_·¿m
.
uc_chªÃl
 !ğ
­p_av_cb
.
¡»am_uc_chªÃl
)

3853 
	`APP_ERROR1
("UIPC channel differs between„egister %d != %d",

3854 
»gi¡”_·¿m
.
uc_chªÃl
, 
­p_av_cb
.
¡»am_uc_chªÃl
);

3858 
	}
}

3869 
	$­p_av_d”egi¡”
(
šdex
)

3871 
tAPP_AV_CONNECTION
 *
cÚÃùiÚ
;

3872 
tBSA_AV_DEREGISTER
 
d”egi¡”_·¿m
;

3873 
tBSA_STATUS
 
¡©us
;

3876 ià((
šdex
 < 0è|| (šdex >ğ
	`APP_NUM_ELEMENTS
(
­p_av_cb
.
cÚÃùiÚs
)))

3878 
	`APP_ERROR0
("Connection index out of bounds");

3882 
cÚÃùiÚ
 = &
­p_av_cb
.
cÚÃùiÚs
[
šdex
];

3883 ià(!
cÚÃùiÚ
->
is_»gi¡”ed
)

3885 
	`APP_ERROR1
("cÚÃùiÚ index %d‚Ù„egi¡”ed", 
šdex
);

3892 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

3895 
	`BSA_AvD”egi¡”In™
(&
d”egi¡”_·¿m
);

3896 
d”egi¡”_·¿m
.
hªdË
 = 
cÚÃùiÚ
->handle;

3897 
¡©us
 = 
	`BSA_AvD”egi¡”
(&
d”egi¡”_·¿m
);

3898 if(
¡©us
 !ğ
BSA_SUCCESS
)

3900 
	`APP_ERROR1
("BSA_AvD”egi¡” faed stus=%d", 
¡©us
);

3903 
cÚÃùiÚ
->
is_»gi¡”ed
 = 
FALSE
;

3905 
	}
}

3916 
	$­p_av_š™
(
BOOLEAN
 
boÙ
)

3918 
tBSA_AV_ENABLE
 
’abË_·¿m
;

3919 
¡©us
;

3920 
tBSA_STATUS
 
b§¡©us
;

3923 
	`mem£t
(&
­p_av_cb
, 0, (app_av_cb));

3924 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

3925 
­p_av_cb
.
tÚe_§m¶e_äeq
 = 48000;

3928 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_NONE
;

3929 
­p_av_cb
.
ı_scms_æag
 = 0x00;

3933 ià(
boÙ
)

3938 
¡©us
 = 
	`­p_š™_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3939 ià(
¡©us
 < 0)

3943 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_¡»am_tx_mu‹x
);

3944 ià(
¡©us
 < 0)

3948 
¡©us
 = 
	`­p_ü—‹_th»ad
(
­p_uc_tx_th»ad
, 0, 0, &
­p_uc_tx_th»ad_¡ruù
);

3949 ià(
¡©us
 < 0)

3951 
	`APP_ERROR1
("­p_ü—‹_th»ad faed: %d", 
¡©us
);

3957 
­p_av_cb
.
uc_cfg
.
is_blockšg
 = 
TRUE
;

3960 
	`­p_š™_¶ayli¡
("./test_files/av");

3961 ià(
­p_av_cb
.
soundfe_li¡_size
 > 0)

3963 
	`APP_INFO1
("­p_av_cb.soundfe_li¡_size:%d", 
­p_av_cb
.
soundfe_li¡_size
);

3965 
	`¡ºıy
(
­p_av_cb
.
fe_Çme
,‡µ_av_cb.
soundfe_li¡
[0], (app_av_cb.file_name)-1);

3966 
­p_av_cb
.
fe_Çme
[(app_av_cb.file_name)-1] = '\0';

3970 
	`BSA_AvEÇbËIn™
(&
’abË_·¿m
);

3972 
’abË_·¿m
.
p_cback
 = 
­p_av_cback
;

3975 
’abË_·¿m
.
­tx_ÿps
 =‡ptx_caps;

3978 
’abË_·¿m
.
£c_ÿps
 = sec_caps;

3981 
’abË_·¿m
.
ã©u»s
 = 
APP_AV_FEAT_MASK
;

3983 
b§¡©us
 = 
	`BSA_AvEÇbË
(&
’abË_·¿m
);

3984 ià(
b§¡©us
 !ğ
BSA_SUCCESS
)

3986 
	`APP_ERROR1
("BSA_AvEÇbË faed: %d", 
b§¡©us
);

3990 #ifdeà
APP_AV_BCST_INCLUDED


3992 
	`­p_av_bc¡_š™
();

3996 
	`­p_av_š™_m‘a_d©a
();

3998 
­p_av_cb
.
¶ay_¡©e
 = 
APP_AV_PLAY_STOPPED
;

4000 #ifdeà
USE_INGENIC_AUDIO_SOCKET


4001 
	`šg’ic_a2dp_cÚÃù
();

4004 
	}
}

4015 
	$­p_av_’d
()

4017 
šdex
;

4018 
tBSA_AV_DISABLE
 
di§bË_·¿m
;

4021 ià(
­p_av_cb
.
¶ay_¡©e
 =ğ
APP_AV_PLAY_STARTED
)

4024 
	`­p_av_¡İ
();

4027 
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

4029 
	`GKI_d–ay
(10);

4034 ià(
­p_av_cb
.
¡»am_uc_chªÃl
 !ğ
UIPC_CH_ID_BAD
)

4036 
	`APP_INFO0
("Closing UIPC Channel");

4037 
	`UIPC_Clo£
(
­p_av_cb
.
¡»am_uc_chªÃl
);

4038 
­p_av_cb
.
¡»am_uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

4042 
šdex
 = 0; index < 
APP_AV_MAX_CONNECTIONS
 ; index++)

4044 ià(
­p_av_cb
.
cÚÃùiÚs
[
šdex
].
is_»gi¡”ed
)

4046 
	`­p_av_d”egi¡”
(
šdex
);

4050 #ifdeà
APP_AV_BCST_INCLUDED


4052 
	`­p_av_bc¡_’d
();

4056 
	`BSA_AvDi§bËIn™
(&
di§bË_·¿m
);

4057 
iR‘
 = 
	`BSA_AvDi§bË
(&
di§bË_·¿m
);

4059 if(
p_b§_av_cb
 !ğ
NULL
)

4061 
	`ä“
(
p_b§_av_cb
);

4062 
p_b§_av_cb
 = 
NULL
;

4065  
iR‘
;

4067 
	}
}

4078 
BOOLEAN
 
	$­p_av_is_·ddšg_acû±abË
(
Ëngth
, 
tBSA_AV_MEDIA_FEEDINGS
 *
p_medŸ_ãedšg
)

4080 
·ddšg
;

4082 
p_medŸ_ãedšg
->
fÜm©
)

4084 
BSA_AV_CODEC_PCM
:

4086 
·ddšg
 = 
p_medŸ_ãedšg
->
cfg
.
pcm
.
b™_³r_§m¶e
 *

4087 
p_medŸ_ãedšg
->
cfg
.
pcm
.
num_chªÃl
 / 8;

4090 
BSA_AV_CODEC_APTX
:

4092 
·ddšg
 = 2;

4093 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4095 
·ddšg
 *= 2;

4099 
BSA_AV_CODEC_SEC
:

4101 
·ddšg
 = 2;

4102 ià(
p_medŸ_ãedšg
->
cfg
.
£c
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4104 
·ddšg
 *= 2;

4109 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
);

4110  
TRUE
;

4114 ià(
·ddšg
 == 1)

4116 
	`APP_DEBUG1
("·ck‘ size:%d ok (8 b™ ®igÃd)", 
Ëngth
);

4117  
TRUE
;

4120 ià((
·ddšg
 =ğ2è&& ((
Ëngth
 & 0x01) == 0))

4122 
	`APP_DEBUG1
("·ck‘ size:%d i ok (16 b™ ®igÃd)", 
Ëngth
);

4123  
TRUE
;

4126 ià((
·ddšg
 =ğ4è&& ((
Ëngth
 & 0x03) == 0))

4128 
	`APP_DEBUG1
("·ck‘ size:%d i ok (32 b™ ®igÃd)", 
Ëngth
);

4129  
TRUE
;

4133 
	`APP_DEBUG1
("·ck‘ size:%d dÛ nÙ f™‡lignm’t", 
Ëngth
);

4135  
FALSE
;

4136 
	}
}

4147 
	$­p_av_compu‹_uc_·¿m
(
tAPP_AV_UIPC
 *
p_uc_cfg
, 
tBSA_AV_MEDIA_FEEDINGS
 *
p_medŸ_ãedšg
)

4149 
by‹s_³r_£c
;

4150 
tmp
;

4151 
»mašd”
;

4153 
	`APP_DEBUG0
("app_av_compute_uipc_param");

4155 ià(
p_uc_cfg
->
is_blockšg
)

4161 
p_uc_cfg
->
Ëngth
 = 
APP_AV_MAX_AUDIO_BUF
 * 2;

4163 
	`APP_DEBUG1
("UIPC is in blocking mode,‚o‚eedo compute UIPC…arams†ength=%d",

4164 
p_uc_cfg
->
Ëngth
);

4169 
p_medŸ_ãedšg
->
fÜm©
)

4171 
BSA_AV_CODEC_PCM
:

4172 
by‹s_³r_£c
 = 
p_medŸ_ãedšg
->
cfg
.
pcm
.
b™_³r_§m¶e
 / 8;

4173 
by‹s_³r_£c
 *ğ
p_medŸ_ãedšg
->
cfg
.
pcm
.
num_chªÃl
;

4174 
by‹s_³r_£c
 *ğ
p_medŸ_ãedšg
->
cfg
.
pcm
.
§m¶šg_äeq
;

4176 
BSA_AV_CODEC_APTX
:

4181 
by‹s_³r_£c
 = 2 * 
p_medŸ_ãedšg
->
cfg
.
­tx
.
§m¶šg_äeq
;

4182 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4184 
by‹s_³r_£c
 *= 2;

4186 
by‹s_³r_£c
 = bytes_per_sec/4;

4188 
BSA_AV_CODEC_SEC
:

4193 
by‹s_³r_£c
 = 2 * 
p_medŸ_ãedšg
->
cfg
.
£c
.
§m¶šg_äeq
;

4194 ià(
p_medŸ_ãedšg
->
cfg
.
­tx
.
ch_mode
 !ğ
BSA_AV_CHANNEL_MODE_MONO
)

4196 
by‹s_³r_£c
 *= 2;

4198 
by‹s_³r_£c
 = bytes_per_sec/4;

4202 
	`APP_ERROR1
("UnsuµÜ‹d f“dšg fÜm© code: %d", 
p_medŸ_ãedšg
->
fÜm©
);

4203 
by‹s_³r_£c
 = 0;

4206 
	`APP_DEBUG1
("by‹s_³r_£c:%d", 
by‹s_³r_£c
);

4209 
	`APP_DEBUG1
("U£¸asked fÜ‡ s³cifiøP”iod:%d", 
p_uc_cfg
->
asked_³riod
);

4211 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4215 
tmp
 = ()
by‹s_³r_£c
 * ()
p_uc_cfg
->
³riod
 / 1000000.0;

4217 
»mašd”
 = 
tmp
 - ()tmp;

4218 ià(
»mašd”
)

4225 
p_uc_cfg
->
Ëngth
 = ()
tmp
;

4226 ià(
	`­p_av_is_·ddšg_acû±abË
(
p_uc_cfg
->
Ëngth
, 
p_medŸ_ãedšg
è=ğ
TRUE
)

4232 
p_uc_cfg
->
³riod
--;

4233 } 
p_uc_cfg
->
³riod
 >ğ
APP_AV_PERIOD_MIN
);

4236 ià(
p_uc_cfg
->
³riod
 < 
APP_AV_PERIOD_MIN
)

4239 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4243 
tmp
 = ()
by‹s_³r_£c
 * ()
p_uc_cfg
->
³riod
 / 1000000.0;

4245 
»mašd”
 = 
tmp
 - ()tmp;

4246 ià(
»mašd”
)

4253 
p_uc_cfg
->
Ëngth
 = ()
tmp
;

4254 ià(
	`­p_av_is_·ddšg_acû±abË
(
p_uc_cfg
->
Ëngth
, 
p_medŸ_ãedšg
è=ğ
TRUE
)

4260 
p_uc_cfg
->
³riod
++;

4261 } 
p_uc_cfg
->
³riod
 <ğ
APP_AV_PERIOD_MAX
);

4264 ià(
p_uc_cfg
->
³riod
 > 
APP_AV_PERIOD_MAX
)

4266 
p_uc_cfg
->
³riod
 =…_uc_cfg->
asked_³riod
;

4268 
p_uc_cfg
->
Ëngth
 = 
by‹s_³r_£c
 *…_uc_cfg->
³riod
 / 1000000.0;

4269 
	`APP_DEBUG0
("Not‡bleo find…eriod matching‡lignment");

4270 
	`APP_DEBUG1
("L‘' u£…”iod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4275 
	`APP_DEBUG0
("Found…eriod/length matching‡lignment");

4276 
	`APP_DEBUG1
("³riod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4282 
	`APP_DEBUG0
("Found…eriod/length matching‡lignment");

4283 
	`APP_DEBUG1
("³riod:%d†’gth:%d", 
p_uc_cfg
->
³riod
,…_uc_cfg->
Ëngth
);

4288 
	}
}

4299 
	$­p_av_uc_»cÚfig
()

4301 
UINT32
 
uc_mode
;

4303 
	`­p_av_compu‹_uc_·¿m
(&
­p_av_cb
.
uc_cfg
, &­p_av_cb.
medŸ_ãedšg
);

4305 ià(
­p_av_cb
.
uc_cfg
.
is_blockšg
)

4307 
uc_mode
 = 
UIPC_WRITE_BLOCK
;

4311 
uc_mode
 = 
UIPC_WRITE_NONBLOCK
;

4314 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
uc_mode
, 
NULL
))

4316 
	`APP_ERROR0
("Failed settinghe UIPC (non) blocking");

4321 
	}
}

4332 
	$­p_av_ask_uc_cÚfig
()

4334 
choiû
;

4335 
tAPP_AV_UIPC
 
uc_cfg
;

4336 
UINT32
 
uc_mode
 = 
UIPC_WRITE_BLOCK
;

4339 ià(
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
)

4341 
	`APP_INFO0
("Could‚ot…erformhis operation,…lease stophe stream first");

4346 ià((
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 == 0) ||

4347 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 == 0) ||

4348 (
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 == 0))

4350 
	`APP_INFO0
("AV‚ot yet started =>†et's use default values‡s feedingƒxample (PCM, 48kHz, 16bits, Stereo)");

4352 
­p_av_cb
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_PCM
;

4353 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
§m¶šg_äeq
 = 48000;

4354 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
b™_³r_§m¶e
 = 16;

4355 
­p_av_cb
.
medŸ_ãedšg
.
cfg
.
pcm
.
num_chªÃl
 = 2;

4359 
uc_cfg
.
is_blockšg
 = 
TRUE
;

4360 
uc_cfg
.
asked_³riod
 = 0;

4361 
uc_cfg
.
³riod
 = 0;

4362 
uc_cfg
.
Ëngth
 = 0;

4364 
	`APP_INFO0
("UIPC blocking/non blocking mode:");

4365 
	`APP_INFO0
(" 0 Blocking mode (default)");

4366 
	`APP_INFO0
(" 1 Non blocking mode");

4367 
choiû
 = 
	`­p_g‘_choiû
("");

4368 ià(
choiû
 == 0)

4370 
uc_cfg
.
is_blockšg
 = 
TRUE
;

4371 
	`APP_INFO0
("UIPC Blocking mode selected");

4373 ià(
choiû
 == 1)

4375 
	`APP_INFO0
("UIPC Non Blocking mode selected");

4376 
uc_cfg
.
is_blockšg
 = 
FALSE
;

4377 
uc_mode
 = 
UIPC_WRITE_NONBLOCK
;

4378 
choiû
 = 
	`­p_g‘_choiû
("Enter Period (in micro)");

4379 ià(
choiû
 < 0)

4381 
	`APP_ERROR1
("Bad…”iod:%d", 
choiû
);

4384 
uc_cfg
.
asked_³riod
 = 
choiû
;

4388 
	`APP_ERROR1
("Bad UIPC mode:%d", 
choiû
);

4392 
	`­p_av_compu‹_uc_·¿m
(&
uc_cfg
, &
­p_av_cb
.
medŸ_ãedšg
);

4394 ià(!
	`UIPC_Ioùl
(
­p_av_cb
.
¡»am_uc_chªÃl
, 
uc_mode
, 
NULL
))

4396 
	`APP_ERROR0
("Failed settinghe UIPC (non) blocking");

4397 
	`APP_DEBUG0
("It will be configured during‚ext AV stop/start");

4401 
	`memıy
(&
­p_av_cb
.
uc_cfg
, &uipc_cfg, (app_av_cb.uipc_cfg));

4405 
	}
}

4416 
	#APP_AV_TIMESPEC_ADD
(
__t1
, 
__t2
) \

4418 
__t1
.
tv_£c
 +ğ
__t2
.tv_sec; \

4419 
__t1
.
tv_n£c
 +ğ
__t2
.tv_nsec; \

4420 ià(
	`BCM_UNLIKELY
(
__t1
.
tv_n£c
 >= 1000000000L)) { \

4421 
__t1
.
tv_£c
++; \

4422 
__t1
.
tv_n£c
 -= 1000000000L; \

4424 } 0)

	)

4442 
	$­p_av_wa™_d–ay
(
couÁ
, 
tAPP_AV_DELAY
 *
p_d–ay
, 
tAPP_AV_UIPC
 *
p_uc_cfg
)

4444 
time¥ec
 
·u£
;

4446 
”r
;

4449 
·u£
.
tv_£c
 = 0;

4450 
·u£
.
tv_n£c
 = 
p_uc_cfg
->
³riod
 * 1000;

4452 
couÁ
--)

4455 
	`APP_AV_TIMESPEC_ADD
(
p_d–ay
->
time¡amp
, 
·u£
);

4458 
”r
 = 
	`şock_Çno¦“p
(
CLOCK_MONOTONIC
, 
TIMER_ABSTIME
, &(
p_d–ay
->
time¡amp
), 
NULL
);

4459 } 
”r
 < 0 && 
”ºo
 =ğ
EINTR
);

4466 
time¥ec
 
aá”
;

4468 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
aá”
);

4469 
	`APP_DEBUG1
("­p_av_wa™_d–ay %d sec; %d‚s", 
aá”
.
tv_£c
,‡á”.
tv_n£c
);

4473 
	}
}

4484 
	$­p_av_d–ay_¡¬t
(
tAPP_AV_DELAY
 *
p_d–ay
)

4487 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &(
p_d–ay
->
time¡amp
));

4488 
p_d–ay
->
timeout
 = 
­p_av_cb
.
uc_cfg
.
³riod
;

4489 
	}
}

4500 
	$­p_av_‹¡_£c_codec
(
BOOLEAN
 
u£_´ev_§mp_äeq
)

4502 
¡©us
, 
choiû
;

4503 
tBSA_AV_START
 
¡¬t_·¿m
;

4505 ià((
­p_av_cb
.
¶ay_¡©e
 !ğ
APP_AV_PLAY_STOPPED
è||‡µ_av_cb.
¶ay_li¡
)

4507 
	`APP_INFO0
("Could‚ot…erformhe…lay operation,…lease stophe stream first");

4512 
	`BSA_AvS¹In™
(&
¡¬t_·¿m
);

4513 
¡¬t_·¿m
.
medŸ_ãedšg
.
fÜm©
 = 
BSA_AV_CODEC_SEC
;

4515 ifĞ
u£_´ev_§mp_äeq
 =ğ
TRUE
)

4517 
­p_av_cb
.
‹¡_£c_§mpäeq_šdex
 = 1;

4518 
choiû
 = 
­p_av_cb
.
‹¡_£c_§mpäeq_šdex
;

4522 
	`APP_INFO0
("Sampling Frequency:");

4523 
	`APP_INFO0
(" 0 - 48kHz");

4524 
	`APP_INFO0
(" 1 - 44.1kHz");

4525 
	`APP_INFO0
(" 2 - 32kHz");

4526 
choiû
 = 
	`­p_g‘_choiû
("");

4527 
­p_av_cb
.
‹¡_£c_§mpäeq_šdex
 = 
choiû
;

4530 if(
choiû
 == 0)

4532 
	`APP_INFO0
(" 0 - 48kHz");

4533 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 48000;

4534 
­p_av_cb
.
£c_äame_size
 = 116;

4536 if(
choiû
 == 1)

4538 
	`APP_INFO0
(" 1 - 44.1kHz");

4539 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 44100;

4540 
­p_av_cb
.
£c_äame_size
 = 124;

4542 if(
choiû
 == 2)

4544 
	`APP_INFO0
(" 2 - 32kHz");

4545 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
 = 32000;

4546 
­p_av_cb
.
£c_äame_size
 = 176;

4550 
	`APP_ERROR1
("Bad sam¶šg f»qu’cy:%d", 
choiû
);

4554 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
 = 2;

4555 
¡¬t_·¿m
.
ãedšg_mode
 = 
­p_av_cb
.
uc_cfg
.
is_blockšg
? 
BSA_AV_FEEDING_ASYNCHRONOUS
: 
BSA_AV_FEEDING_SYNCHRONOUS
;

4556 
¡¬t_·¿m
.
Ï‹ncy
 = 
­p_av_cb
.
uc_cfg
.
³riod
/1000;

4558 
	`APP_INFO1
("app_av_test_sec_codec freq:%d, c_m:%d, f_m:%d,lat:%d",

4559 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
§m¶šg_äeq
,

4560 
¡¬t_·¿m
.
medŸ_ãedšg
.
cfg
.
£c
.
ch_mode
,

4561 
¡¬t_·¿m
.
ãedšg_mode
,

4562 
¡¬t_·¿m
.
Ï‹ncy
);

4564 
­p_av_cb
.
¶ay_ty³
 = 
APP_AV_PLAYTYPE_TEST
;

4565 
­p_av_cb
.
¶ay_li¡
 = 
FALSE
;

4567 
¡©us
 = 
	`BSA_AvS¹
(&
¡¬t_·¿m
);

4568 ià(
¡©us
 !ğ
BSA_SUCCESS
)

4570 
	`APP_ERROR1
("BSA_AvS¹ faed:%d", 
¡©us
);

4571  
¡©us
;

4575 
	}
}

4586 
	$­p_av_chªge_ı
()

4588 
choiû
;

4590 
	`APP_INFO1
("The current Content Protection Id is=%s ScmsFlag=%d",

4591 
	`­p_av_g‘_cu¼’t_ı_desc
(), 
­p_av_cb
.
ı_scms_æag
);

4593 
	`APP_INFO0
("New Content Protection Id:");

4594 
	`APP_INFO0
(" 0 - None");

4595 
	`APP_INFO0
(" 1 - SCMS");

4596 
choiû
 = 
	`­p_g‘_choiû
("");

4597 
choiû
)

4600 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_NONE
;

4601 
­p_av_cb
.
ı_scms_æag
 = 0x00;

4605 
choiû
 = 
	`­p_g‘_choiû
("SCMS Flag/Header 0-Copy Never,1-Copy Once, 2-Copy Free");

4606 if(
choiû
 < 0 || choice >2)

4608 
	`APP_ERROR1
("Inv®id EÁry:%d", 
choiû
);

4611 
­p_av_cb
.
ı_id
 = 
BSA_AV_CP_ID_SCMS
;

4612 
­p_av_cb
.
ı_scms_æag
 = (
UINT8
)
choiû
;

4616 
	`APP_ERROR1
("UnknowÀCÚ‹Á PrÙeùiÚ Id=%d", 
choiû
);

4621 
	}
}

4632 *
	$­p_av_g‘_cu¼’t_ı_desc
()

4634 
­p_av_cb
.
ı_id
)

4636 
BSA_AV_CP_ID_NONE
:

4638 
BSA_AV_CP_ID_SCMS
:

4643 
	}
}

4655 
	$­p_av_£t_busy_Ëv–
(
UINT8
 
Ëv–
)

4657 
¡©us
;

4658 
tBSA_AV_BUSY_LEVEL
 
busy_Ëv–
;

4661 
	`BSA_AvBusyLev–In™
(&
busy_Ëv–
);

4662 
busy_Ëv–
.
Ëv–
 =†evel;

4663 
	`APP_INFO1
("­p_av_£t_busy_Ëv–†ev–(0-5):%d", 
Ëv–
);

4664 if(
Ëv–
>5)

4666 
	`APP_ERROR1
("WrÚg v®ue:%d", 
Ëv–
);

4670 
¡©us
 = 
	`BSA_AvBusyLev–
(&
busy_Ëv–
);

4671 ià(
¡©us
 !ğ
BSA_SUCCESS
)

4673 
	`APP_ERROR1
("BSA_AvBusyLev– faed:%d", 
¡©us
);

4674  
¡©us
;

4678 
	}
}

4690 *
	$­p_av_g‘_nÙifiÿtiÚ_¡ršg
(
UINT8
 
commªd
)

4692 
commªd
)

4694 
AVRC_EVT_PLAY_STATUS_CHANGE
:

4696 
AVRC_EVT_TRACK_CHANGE
:

4698 
AVRC_EVT_TRACK_REACHED_END
:

4700 
AVRC_EVT_TRACK_REACHED_START
:

4702 
AVRC_EVT_PLAY_POS_CHANGED
:

4704 
AVRC_EVT_BATTERY_STATUS_CHANGE
:

4706 
AVRC_EVT_SYSTEM_STATUS_CHANGE
:

4708 
AVRC_EVT_APP_SETTING_CHANGE
:

4710 
AVRC_EVT_NOW_PLAYING_CHANGE
:

4712 
AVRC_EVT_AVAL_PLAYERS_CHANGE
:

4714 
AVRC_EVT_ADDR_PLAYER_CHANGE
:

4716 
AVRC_EVT_UIDS_CHANGE
:

4718 
AVRC_EVT_VOLUME_CHANGE
:

4722  
NULL
;

4723 
	}
}

4733 
	$­p_av_£t_cback
(
tAvC®lback
 
pcb
)

4736 
s_pC®lback
 = 
pcb
;

4737 
	}
}

4747 
UINT8
 
	$­p_av_g‘_¶ay_¡©e
()

4749  
­p_av_cb
.
¶ay_¡©e
;

4750 
	}
}

4753 
UINT8
 
	$­p_av_g‘_¶ay_ty³
()

4755  
­p_av_cb
.
¶ay_ty³
;

4756 
	}
}

4758 #ifdeà
USE_INGENIC_AUDIO_SOCKET


4759 
	$šg’ic_a2dp_cÚÃù
(){

4760 
	`APP_INFO1
("%s()", 
__func__
);

4762 
sockaddr_un
 
£r_addr
;

4763 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

4764 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

4765 
	`¡rıy
(
£r_addr
.
sun_·th
,
A2DP_SOURCE_DOMAIN
);

4766 
mIng’icA2dpSock‘Fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

4767 if(
mIng’icA2dpSock‘Fd
 < 0){

4768 
	`APP_ERROR1
("Blu‘oÙhMªag” mu¡ boÙ u°aá” medŸ£rv”. sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

4771 
»t
 = 
	`cÚÃù
(
mIng’icA2dpSock‘Fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

4772 if(
»t
 < 0){

4773 
	`APP_ERROR1
("cÚÃù sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

4776 
a2dp_¶ayback_cÚ‹xt
 = 
	`SHM_O³n
(
A2DP_SOURCE_SHM_KEY
,
A2DP_SOURCE_SHM_SIZE
);

4777 if(
a2dp_¶ayback_cÚ‹xt
 == 0){

4778 
	`APP_ERROR1
("Blu‘oÙhMªag”:shm o³Àçed: %s\n",
	`¡»¼Ü
(
”ºo
));

4782 
	}
}

4784 
	$šg’ic_a2dp_discÚÃù
(){

4785 
	`APP_INFO1
("%s()", 
__func__
);

4786 if(
mIng’icA2dpSock‘Fd
 > 0){

4787 
	`şo£
(
mIng’icA2dpSock‘Fd
);

4788 
mIng’icA2dpSock‘Fd
 = -1;

4790 if(
a2dp_¶ayback_cÚ‹xt
){

4791 
	`SHM_Clo£
(
a2dp_¶ayback_cÚ‹xt
);

4794 
	}
}

4796 
	$šg’ic_a2dp_İ’
(){

4797 
	`APP_INFO1
("%s()", 
__func__
);

4798 if(
mIng’icA2dpSock‘Fd
 > 0){

4799 
»’
 = 
	`£nd
(
mIng’icA2dpSock‘Fd
, "a2dp-av-İ’-",
	`¡¾’
("a2dp-av-open-"), 0);

4800 if(
»’
 > 0)

4806 
	}
}

4807 
	$šg’ic_a2dp_şo£
(){

4808 
	`APP_INFO1
("%s()", 
__func__
);

4810 if(
mIng’icA2dpSock‘Fd
 > 0){

4811 
»’
 = 
	`£nd
(
mIng’icA2dpSock‘Fd
, "a2dp-av-şo£-",
	`¡¾’
("a2dp-av-close-"), 0);

4812 if(
»’
 > 0)

4818 
	}
}

	@source/app_avk.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<fú.h
>

16 
	~<uni¡d.h
>

17 
	~<”ºo.h
>

18 
	~<sys/ty³s.h
>

19 
	~<sys/¡©.h
>

20 
	~<sys/sock‘.h
>

21 
	~<sys/un.h
>

23 
	~"budcfg.h
"

25 
	~"b§_­i.h
"

26 
	~"b§_avk_­i.h
"

28 
	~"gki.h
"

29 
	~"uc.h
"

31 
	~"­p_xml_uts.h
"

32 
	~"­p_disc.h
"

33 
	~"­p_uts.h
"

34 
	~"­p_wav.h
"

35 
	~"­p_avk.h
"

36 
	#PCM_ALSA
 1

	)

37 #ifdeà
PCM_ALSA


38 
	~"®§/asoundlib.h
"

39 
	#APP_AVK_ASLA_DEV
 "deçuÉ"

	)

42 
	~"šg’ic_oss_ouut.h
"

48 
	#APP_XML_REM_DEVICES_FILE_PATH
 "./bt_deviûs.xml"

	)

50 
	#APP_AVK_SOUND_FILE
 "‹¡_avk"

	)

52 #iâdeà
BSA_AVK_SECURITY


53 
	#BSA_AVK_SECURITY
 
BSA_SEC_AUTHORIZATION


	)

55 #iâdeà
BSA_AVK_FEATURES


56 
	#BSA_AVK_FEATURES
 (
BSA_AVK_FEAT_RCCT
|
BSA_AVK_FEAT_RCTG
|\

57 
BSA_AVK_FEAT_VENDOR
|
BSA_AVK_FEAT_METADATA
|\

58 
BSA_AVK_FEAT_BROWSE
|
BSA_AVK_FEAT_DELAY_RPT
)

	)

61 #iâdeà
BSA_AVK_DUMP_RX_DATA


62 
	#BSA_AVK_DUMP_RX_DATA
 
FALSE


	)

65 #iâdeà
BSA_AVK_AAC_SUPPORTED


66 
	#BSA_AVK_AAC_SUPPORTED
 
FALSE


	)

70 
tBSA_AVK_REG_NOTIFICATIONS
 
	g»g_nÙifiÿtiÚs
 =

71 (1 << (
BSA_AVK_RC_EVT_PLAY_STATUS_CHANGE
 - 1)) |

72 (1 << (
BSA_AVK_RC_EVT_TRACK_CHANGE
 - 1)) |

73 (1 << (
BSA_AVK_RC_EVT_TRACK_REACHED_END
 - 1)) |

74 (1 << (
BSA_AVK_RC_EVT_TRACK_REACHED_START
 - 1)) |

75 (1 << (
BSA_AVK_RC_EVT_PLAY_POS_CHANGED
 - 1)) |

76 (1 << (
BSA_AVK_RC_EVT_BATTERY_STATUS_CHANGE
 - 1)) |

77 (1 << (
BSA_AVK_RC_EVT_SYSTEM_STATUS_CHANGE
 - 1)) |

78 (1 << (
BSA_AVK_RC_EVT_APP_SETTING_CHANGE
 - 1)) |

79 (1 << (
BSA_AVK_RC_EVT_NOW_PLAYING_CHANGE
 - 1)) |

80 (1 << (
BSA_AVK_RC_EVT_AVAL_PLAYERS_CHANGE
 - 1)) |

81 (1 << (
BSA_AVK_RC_EVT_ADDR_PLAYER_CHANGE
 - 1)) |

82 (1 << (
BSA_AVK_RC_EVT_UIDS_CHANGE
 - 1)) |

83 (1 << (
BSA_AVK_RC_EVT_VOLUME_CHANGE
 - 1));

90 
tBSA_STATUS
 
	mÏ¡_İ’_¡©us
;

91 
tBSA_STATUS
 
	mÏ¡_¡¬t_¡©us
;

92 vŞ©
BOOLEAN
 
	mİ’_³ndšg
;

93 
BOOLEAN
 
	mis_rc_İ’
;

94 
tBSA_AVK_FEAT
 
	mã©u»s
;

95 
UINT16
 
	m³”_v”siÚ
;

96 
BOOLEAN
 
	mis_İ’
;

97 
BOOLEAN
 
	mis_¡¬‹d
;

98 
tBTA_AVK_CODEC
 
	mfÜm©
;

99 
UINT16
 
	m§m¶e_¿‹
;

100 
UINT8
 
	mnum_chªÃl
;

101 
UINT8
 
	mb™_³r_§m¶e
;

102 
tBSA_AVK_CHNL
 
	mchªÃl
;

103 
UINT8
 
	mrc_hªdË
;

104 
tUIPC_CH_ID
 
	muc_audio_chªÃl
;

105 
	mfd
;

106 #ifdeà
PCM_ALSA


107 
¢d_pcm_t
 *
	m®§_hªdË
;

109 
UINT8
 
	mÏb–
;

110 
UINT8
 
	mvŞLab–
;

111 
UINT8
 
	mvŞume
;

112 
BD_ADDR
 
	mbda_cÚÃùed
;

113 } 
	ttAPP_AVK_CB
;

119 
tAPP_AVK_CB
 
	g­p_avk_cb
;

121 #ifdeà
PCM_ALSA


122 *
	g®§_deviû
 = "default";

128 
­p_avk_şo£_wave_fe
();

129 
­p_avk_ü—‹_wave_fe
();

130 
­p_avk_uc_cback
(
BT_HDR
 *
p_msg
);

132 
tAvkC®lback
 *
	gs_pC®lback
 = 
NULL
;

142 
	$­p_avk_ü—‹_wave_fe
()

144 
fe_šdex
 = 0;

145 
fd
;

146 
f’ame
[200];

148 #ifdeà
PCM_ALSA


153 ià(
­p_avk_cb
.
fd
 != -1)

155 
	`­p_avk_şo£_wave_fe
();

160 
	`¢´štf
(
f’ame
, (f’ame), "/v¬/run/%s-%d.wav", 
APP_AVK_SOUND_FILE
, 
fe_šdex
);

161 
f’ame
[(filename)-1] = '\0';

162 
fd
 = 
	`­p_wav_ü—‹_fe
(
f’ame
, 0);

163 
fe_šdex
++;

164 } 
fd
 < 0);

165 
	`APP_INFO1
("‡µ_avk_ü—‹_wave_ffd=%d\n",
fd
);

166 
­p_avk_cb
.
fd
 = fd;

167 
	}
}

177 
	$­p_avk_ü—‹_¯c_fe
()

179 
fe_šdex
 = 0;

180 
fd
;

181 
f’ame
[200];

184 ià(
­p_avk_cb
.
fd
 != -1)

186 
	`şo£
(
­p_avk_cb
.
fd
);

187 
­p_avk_cb
.
fd
 = -1;

192 
æags
 = 
O_EXCL
 | 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
;

194 
	`¢´štf
(
f’ame
, (f’ame), "%s-%d.¯c", 
APP_AVK_SOUND_FILE
, 
fe_šdex
);

195 
f’ame
[(filename)-1] = '\0';

198 
fd
 = 
	`İ’
(
f’ame
, 
æags
, 0666);

199 ià(
fd
 < 0)

201 
	`APP_ERROR1
("İ’(%sèçed: %d", 
f’ame
, 
”ºo
);

204 
fe_šdex
++;

205 } (
fd
 < 0è&& (
fe_šdex
<100));

207 
­p_avk_cb
.
fd
 = fd;

208 
	}
}

219 
	$­p_avk_şo£_wave_fe
()

221 
tAPP_WAV_FILE_FORMAT
 
fÜm©
;

223 #ifdeà
PCM_ALSA


227 ià(
­p_avk_cb
.
fd
 == -1)

229 
	`´štf
("app_avk_close_wave_file:‚o fileo close\n");

233 
fÜm©
.
b™s_³r_§m¶e
 = 
­p_avk_cb
.
b™_³r_§m¶e
;

234 
fÜm©
.
nb_chªÃls
 = 
­p_avk_cb
.
num_chªÃl
;

235 
fÜm©
.
§m¶e_¿‹
 = 
­p_avk_cb
.sample_rate;

237 
	`­p_wav_şo£_fe
(
­p_avk_cb
.
fd
, &
fÜm©
);

239 
­p_avk_cb
.
fd
 = -1;

240 
	}
}

251 
	$­p_avk_’d
()

253 
tBSA_AVK_DISABLE
 
di§bË_·¿m
;

254 
tBSA_AVK_DEREGISTER
 
d”egi¡”_·¿m
;

257 
	`BSA_AvkD”egi¡”In™
(&
d”egi¡”_·¿m
);

258 
d”egi¡”_·¿m
.
chªÃl
 = 
­p_avk_cb
.
num_chªÃl
;

259 
	`BSA_AvkD”egi¡”
(&
d”egi¡”_·¿m
);

262 
	`BSA_AvkDi§bËIn™
(&
di§bË_·¿m
);

263 
	`BSA_AvkDi§bË
(&
di§bË_·¿m
);

264 
	}
}

276 
	$­p_avk_hªdË_¡¬t
(
tBSA_AVK_MSG
 *
p_d©a
)

278 *
avk_fÜm©_di¥Ïy
[12] =

280 #ifdeà
PCM_ALSA


281 
¡©us
;

282 
¢d_pcm_fÜm©_t
 
fÜm©
;

285 ià(
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
fÜm©
 < ((
avk_fÜm©_di¥Ïy
)/(avk_format_display[0])))

287 
	`APP_INFO1
("AVK s¹: fÜm© %s", 
avk_fÜm©_di¥Ïy
[
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
fÜm©
]);

291 
	`APP_INFO1
("AVK s¹: fÜm© cod(%uèunknown", 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
fÜm©
);

294 
­p_avk_cb
.
fÜm©
 = 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.format;

295 
	`APP_INFO1
("­p_avk_cb.fÜm©=%d\n", 
­p_avk_cb
.
fÜm©
);

296 
	`APP_INFO1
("BSA_AVK_CODEC_PCM=%d\n", 
BSA_AVK_CODEC_PCM
);

297 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_PCM
)

300 
­p_avk_cb
.
§m¶e_¿‹
 = 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.
§m¶šg_äeq
;

301 
­p_avk_cb
.
num_chªÃl
 = 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.num_channel;

302 
­p_avk_cb
.
b™_³r_§m¶e
 = 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.bit_per_sample;

303 
	`´štf
("Sampling„ate:%d,‚umber of channel:%d bit…er sample:%d\n",

304 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.
§m¶šg_äeq
,

305 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.
num_chªÃl
,

306 
p_d©a
->
¡¬t
.
medŸ_»ûivšg
.
cfg
.
pcm
.
b™_³r_§m¶e
);

307 #ifdeà
PCM_ALSA


309 ià(
­p_avk_cb
.
®§_hªdË
 !ğ
NULL
)

311 
	`¢d_pcm_şo£
(
­p_avk_cb
.
®§_hªdË
);

312 
­p_avk_cb
.
®§_hªdË
 = 
NULL
;

316 
¡©us
 = 
	`¢d_pcm_İ’
(&(
­p_avk_cb
.
®§_hªdË
), 
®§_deviû
,

317 
SND_PCM_STREAM_PLAYBACK
, 
SND_PCM_NONBLOCK
);

318 ià(
¡©us
 < 0)

320 
	`APP_ERROR1
("¢d_pcm_İ’ faed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

324 
	`APP_DEBUG0
("ALSA driver opened");

325 ià(
­p_avk_cb
.
b™_³r_§m¶e
 == 8)

326 
fÜm©
 = 
SND_PCM_FORMAT_U8
;

328 
fÜm©
 = 
SND_PCM_FORMAT_S16_LE
;

330 
¡©us
 = 
	`¢d_pcm_£t_·¿ms
(
­p_avk_cb
.
®§_hªdË
, 
fÜm©
,

331 
SND_PCM_ACCESS_RW_INTERLEAVED
, 
­p_avk_cb
.
num_chªÃl
,

332 
­p_avk_cb
.
§m¶e_¿‹
, 1, 500000);

333 ià(
¡©us
 < 0)

335 
	`APP_ERROR1
("¢d_pcm_£t_·¿m çed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

336 
	`ex™
(1);

341 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_M24
)

344 
	`­p_avk_ü—‹_¯c_fe
();

349 
	}
}

360 
	$­p_avk_cback
(
tBSA_AVK_EVT
 
ev’t
, 
tBSA_AVK_MSG
 *
p_d©a
)

362 
ev’t
)

364 
BSA_AVK_OPEN_EVT
:

365 
	`APP_DEBUG1
("BSA_AVK_OPEN_EVT stu 0x%x", 
p_d©a
->
İ’
.
¡©us
);

366 
­p_avk_cb
.
Ï¡_İ’_¡©us
 = 
p_d©a
->
İ’
.
¡©us
;

367 
­p_avk_cb
.
chªÃl
 = 
p_d©a
->
İ’
.channel;

369 ià(
p_d©a
->
İ’
.
¡©us
 =ğ
BSA_SUCCESS
)

371 
­p_avk_cb
.
is_İ’
 = 
TRUE
;

372 
	`bdıy
(
­p_avk_cb
.
bda_cÚÃùed
, 
p_d©a
->
İ’
.
bd_addr
);

376 
­p_avk_cb
.
is_İ’
 = 
FALSE
;

379 
­p_avk_cb
.
İ’_³ndšg
 = 
FALSE
;

381 
	`APP_DEBUG1
("AVK connectedo device %02X:%02X:%02X:%02X:%02X:%02X",

382 
p_d©a
->
İ’
.
bd_addr
[0],…_data->open.bd_addr[1],p_data->open.bd_addr[2],

383 
p_d©a
->
İ’
.
bd_addr
[3],…_data->open.bd_addr[4],p_data->open.bd_addr[5]);

385 
BSA_AVK_CLOSE_EVT
:

387 
	`APP_DEBUG1
("BSA_AVK_CLOSE_EVT stu 0x%x", 
p_d©a
->
şo£
.
¡©us
);

388 
­p_avk_cb
.
is_İ’
 = 
FALSE
;

389 
­p_avk_cb
.
İ’_³ndšg
 = 
FALSE
;

390 ià(
­p_avk_cb
.
is_¡¬‹d
 =ğ
TRUE
)

392 
­p_avk_cb
.
is_¡¬‹d
 = 
FALSE
;

394 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_M24
)

395 
	`şo£
(
­p_avk_cb
.
fd
);

397 
	`­p_avk_şo£_wave_fe
();

400 
BSA_AVK_START_EVT
:

401 
	`APP_DEBUG1
("BSA_AVK_START_EVT stu 0x%x", 
p_d©a
->
¡¬t
.
¡©us
);

402 
­p_avk_cb
.
Ï¡_¡¬t_¡©us
 = 
p_d©a
->
¡¬t
.
¡©us
;

403 
­p_avk_cb
.
is_¡¬‹d
 = 
TRUE
;

404 
	`­p_avk_hªdË_¡¬t
(
p_d©a
);

405 
	`İ’_šg’ic_audio_oss_ouut
("a2dp",4);

407 
BSA_AVK_STOP_EVT
:

408 
	`APP_DEBUG0
("BSA_AVK_STOP_EVT");

409 
­p_avk_cb
.
is_¡¬‹d
 = 
FALSE
;

411 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_M24
)

412 
	`şo£
(
­p_avk_cb
.
fd
);

414 
	`­p_avk_şo£_wave_fe
();

415 
	`şo£_šg’ic_audio_oss_ouut
();

416 #ifdeà
PCM_ALSA


417 ià((
­p_avk_cb
.
®§_hªdË
è!ğ
NULL
)

419 
	`¢d_pcm_şo£
(
­p_avk_cb
.
®§_hªdË
);

420 
­p_avk_cb
.
®§_hªdË
 = 
NULL
;

424 
BSA_AVK_RC_OPEN_EVT
:

425 
	`APP_DEBUG1
("BSA_AVK_RC_OPEN_EVT…eer_feature=0x%x„c_handle=%d",

426 
p_d©a
->
rc_İ’
.
³”_ã©u»s
,…_d©a->rc_İ’.
rc_hªdË
);

427 
	`APP_DEBUG1
("BD‡ddress %02X:%02X:%02X:%02X:%02X:%02X",

428 
p_d©a
->
rc_İ’
.
bd_addr
[0],…_data->rc_open.bd_addr[1],

429 
p_d©a
->
rc_İ’
.
bd_addr
[2],…_data->rc_open.bd_addr[3],

430 
p_d©a
->
rc_İ’
.
bd_addr
[4],…_data->rc_open.bd_addr[5]);

431 
­p_avk_cb
.
rc_hªdË
 = 
p_d©a
->
rc_İ’
.rc_handle;

432 
­p_avk_cb
.
ã©u»s
 = 
p_d©a
->
rc_İ’
.
³”_ã©u»s
;

433 
­p_avk_cb
.
³”_v”siÚ
 = 
p_d©a
->
rc_İ’
.peer_version;

434 
­p_avk_cb
.
is_rc_İ’
 = 
TRUE
;

437 
BSA_AVK_RC_PEER_OPEN_EVT
:

438 
	`APP_DEBUG1
("BSA_AVK_RC_PEER_OPEN_EVT…eer_feature=0x%x„c_handle=%d",

439 
p_d©a
->
rc_İ’
.
³”_ã©u»s
,…_d©a->rc_İ’.
rc_hªdË
);

440 
­p_avk_cb
.
rc_hªdË
 = 
p_d©a
->
rc_İ’
.rc_handle;

441 
­p_avk_cb
.
ã©u»s
 = 
p_d©a
->
rc_İ’
.
³”_ã©u»s
;

442 
­p_avk_cb
.
³”_v”siÚ
 = 
p_d©a
->
rc_İ’
.peer_version;

443 
­p_avk_cb
.
is_rc_İ’
 = 
TRUE
;

446 
BSA_AVK_RC_CLOSE_EVT
:

447 
	`APP_DEBUG0
("BSA_AVK_RC_CLOSE_EVT");

448 
­p_avk_cb
.
is_rc_İ’
 = 
FALSE
;

451 
BSA_AVK_REMOTE_RSP_EVT
:

452 
	`APP_DEBUG0
("BSA_AVK_REMOTE_RSP_EVT");

454 
BSA_AVK_VENDOR_CMD_EVT
:

455 
	`APP_DEBUG0
("BSA_AVK_VENDOR_CMD_EVT");

456 
	`APP_DEBUG1
(" code:0x%x", 
p_d©a
->
v’dÜ_cmd
.
code
);

457 
	`APP_DEBUG1
(" com·ny_id:0x%x", 
p_d©a
->
v’dÜ_cmd
.
com·ny_id
);

458 
	`APP_DEBUG1
("†ab–:0x%x", 
p_d©a
->
v’dÜ_cmd
.
Ïb–
);

459 
	`APP_DEBUG1
("†’:0x%x", 
p_d©a
->
v’dÜ_cmd
.
Ën
);

460 #ià(
	`defšed
(
BSA_AVK_DUMP_RX_DATA
è&& (BSA_AVK_DUMP_RX_DATA =ğ
TRUE
))

461 
	`APP_DUMP
("A2DP D©a", 
p_d©a
->
v’dÜ_cmd
.
d©a
,…_d©a->v’dÜ_cmd.
Ën
);

464 
BSA_AVK_VENDOR_RSP_EVT
:

465 
	`APP_DEBUG0
("BSA_AVK_VENDOR_RSP_EVT");

466 
	`APP_DEBUG1
(" code:0x%x", 
p_d©a
->
v’dÜ_r¥
.
code
);

467 
	`APP_DEBUG1
(" com·ny_id:0x%x", 
p_d©a
->
v’dÜ_r¥
.
com·ny_id
);

468 
	`APP_DEBUG1
("†ab–:0x%x", 
p_d©a
->
v’dÜ_r¥
.
Ïb–
);

469 
	`APP_DEBUG1
("†’:0x%x", 
p_d©a
->
v’dÜ_r¥
.
Ën
);

470 #ià(
	`defšed
(
BSA_AVK_DUMP_RX_DATA
è&& (BSA_AVK_DUMP_RX_DATA =ğ
TRUE
))

471 
	`APP_DUMP
("A2DP D©a", 
p_d©a
->
v’dÜ_r¥
.
d©a
,…_d©a->v’dÜ_r¥.
Ën
);

475 
BSA_AVK_CP_INFO_EVT
:

476 
	`APP_DEBUG0
("BSA_AVK_CP_INFO_EVT");

477 if(
p_d©a
->
ı_šfo
.
id
 =ğ
BSA_AVK_CP_SCMS_T_ID
)

479 
p_d©a
->
ı_šfo
.
šfo
.
scm¡_æag
)

481 
BSA_AVK_CP_SCMS_COPY_NEVER
:

482 
	`APP_INFO1
(" cÚ‹Á…rÙeùiÚ:0x%x - COPY NEVER", 
p_d©a
->
ı_šfo
.
šfo
.
scm¡_æag
);

484 
BSA_AVK_CP_SCMS_COPY_ONCE
:

485 
	`APP_INFO1
(" cÚ‹Á…rÙeùiÚ:0x%x - COPY ONCE", 
p_d©a
->
ı_šfo
.
šfo
.
scm¡_æag
);

487 
BSA_AVK_CP_SCMS_COPY_FREE
:

488 (
BSA_AVK_CP_SCMS_COPY_FREE
+1):

489 
	`APP_INFO1
(" cÚ‹Á…rÙeùiÚ:0x%x - COPY FREE", 
p_d©a
->
ı_šfo
.
šfo
.
scm¡_æag
);

492 
	`APP_ERROR1
(" cÚ‹Á…rÙeùiÚ:0x%x - UNKNOWN VALUE", 
p_d©a
->
ı_šfo
.
šfo
.
scm¡_æag
);

498 
	`APP_INFO0
("No content…rotection");

502 
BSA_AVK_REGISTER_NOTIFICATION_EVT
:

503 
	`APP_DEBUG1
("BSA_AVK_REGISTER_NOTIFICATION_EVT : ID %d, opcode:%d", 
p_d©a
->
»g_nÙif
.
ev’t_id
,…_d©a->»g_nÙif.
İcode
);

504 if(
p_d©a
->
»g_nÙif
.
ev’t_id
 =ğ
AVRC_EVT_PLAY_STATUS_CHANGE
)

506 if(
p_d©a
->
»g_nÙif
.
İcode
 =ğ
AVRC_RSP_CHANGED
)

507 
	`APP_DEBUG1
("Re¥Ú£ CHANGED,…Ïy¡©us:%d", 
p_d©a
->
»g_nÙif
.
·¿m
.
¶ay_¡©us
);

508 if(
p_d©a
->
»g_nÙif
.
İcode
 =ğ
AVRC_RSP_INTERIM
)

509 
	`APP_DEBUG1
("Re¥Ú£ INTERIM,…Ïy¡©us:%d", 
p_d©a
->
»g_nÙif
.
·¿m
.
¶ay_¡©us
);

513 
BSA_AVK_LIST_PLAYER_APP_ATTR_EVT
:

514 
BSA_AVK_LIST_PLAYER_APP_VALUES_EVT
:

515 
BSA_AVK_SET_PLAYER_APP_VALUE_EVT
:

516 
BSA_AVK_GET_PLAYER_APP_VALUE_EVT
:

517 
BSA_AVK_GET_ELEM_ATTR_EVT
:

518 
BSA_AVK_GET_PLAY_STATUS_EVT
:

519 
BSA_AVK_SET_ADDRESSED_PLAYER_EVT
:

520 
BSA_AVK_SET_BROWSED_PLAYER_EVT
:

521 
BSA_AVK_GET_FOLDER_ITEMS_EVT
:

522 
BSA_AVK_CHANGE_PATH_EVT
:

523 
BSA_AVK_GET_ITEM_ATTR_EVT
:

524 
BSA_AVK_PLAY_ITEM_EVT
:

525 
BSA_AVK_ADD_TO_NOW_PLAYING_EVT
:

528 
BSA_AVK_SET_ABS_VOL_CMD_EVT
:

529 
	`APP_DEBUG0
("BSA_AVK_SET_ABS_VOL_CMD_EVT");

533 
	`APP_DEBUG1
("vŞume:0x%x", 
p_d©a
->
abs_vŞume
.
abs_vŞume_cmd
.
vŞume
);

534 
­p_avk_cb
.
vŞume
 = 
p_d©a
->
abs_vŞume
.
abs_vŞume_cmd
.volume;

535 
	`­p_avk_£t_abs_vŞ_r¥
(
­p_avk_cb
.
vŞume
,

536 
p_d©a
->
abs_vŞume
.
hªdË
,

537 
p_d©a
->
abs_vŞume
.
Ïb–
);

544 
BSA_AVK_REG_NOTIFICATION_CMD_EVT
:

545 ià(
p_d©a
->
»g_nÙif_cmd
.»g_nÙif_cmd.
ev’t_id
 =ğ
AVRC_EVT_VOLUME_CHANGE
)

547 
­p_avk_cb
.
vŞLab–
 = 
p_d©a
->
»g_nÙif_cmd
.
Ïb–
;

551 
	`­p_avk_»g_nÙâ_r¥
(
­p_avk_cb
.
vŞume
,

552 
p_d©a
->
»g_nÙif_cmd
.
hªdË
,

553 
p_d©a
->
»g_nÙif_cmd
.
Ïb–
,

554 
p_d©a
->
»g_nÙif_cmd
.»g_nÙif_cmd.
ev’t_id
,

555 
BTA_AV_RSP_INTERIM
);

560 
	`APP_ERROR1
("UnsuµÜ‹dƒv’ˆ%d", 
ev’t
);

565 if(
s_pC®lback
)

566 
	`s_pC®lback
(
ev’t
, 
p_d©a
);

567 
	}
}

578 
	$­p_avk_İ’
()

580 
tBSA_STATUS
 
¡©us
;

581 
choiû
;

582 
BOOLEAN
 
cÚÃù
 = 
FALSE
;

583 
BD_ADDR
 
bd_addr
;

584 
UINT8
 *
p_Çme
;

585 
tBSA_AVK_OPEN
 
İ’_·¿m
;

587 ià(
­p_avk_cb
.
İ’_³ndšg
)

589 
	`APP_ERROR0
("alreadyryingo connect");

593 
	`´štf
("Bluetooth AVK Open menu:\n");

594 
	`´štf
(" 0 Device from XML database (already…aired)\n");

595 
	`´štf
(" 1 Device found in†ast discovery\n");

596 
choiû
 = 
	`­p_g‘_choiû
("Select source");

598 
choiû
)

602 
	`­p_»ad_xml_»mÙe_deviûs
();

604 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
,

605 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

606 
choiû
 = 
	`­p_g‘_choiû
("Select device");

607 ià((
choiû
 >ğ0è&& (choiû < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)))

609 ià(
­p_xml_»mÙe_deviûs_db
[
choiû
].
š_u£
 !ğ
FALSE
)

611 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
choiû
].bd_addr);

612 
p_Çme
 = 
­p_xml_»mÙe_deviûs_db
[
choiû
].
Çme
;

613 
cÚÃù
 = 
TRUE
;

617 
	`APP_ERROR0
("Deviceƒntry‚ot in use");

622 
	`APP_ERROR0
("Unsupported device‚umber");

626 
	`­p_disc_di¥Ïy_deviûs
();

627 
choiû
 = 
	`­p_g‘_choiû
("Select device");

628 ià((
choiû
 >ğ0è&& (choiû < 
	`APP_NUM_ELEMENTS
(
­p_discov”y_cb
.
devs
)))

630 ià(
­p_discov”y_cb
.
devs
[
choiû
].
š_u£
 !ğ
FALSE
)

632 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
choiû
].
deviû
.bd_addr);

633 
p_Çme
 = 
­p_discov”y_cb
.
devs
[
choiû
].
deviû
.
Çme
;

634 
cÚÃù
 = 
TRUE
;

638 
	`APP_ERROR0
("Deviceƒntry‚ot in use");

643 
	`APP_ERROR0
("Unsupported device‚umber");

647 
	`APP_ERROR0
("Unsupported choice");

651 ià(
cÚÃù
 !ğ
FALSE
)

654 
	`´štf
("CÚÃùšgØAV deviû:% \n", 
p_Çme
);

656 
­p_avk_cb
.
İ’_³ndšg
 = 
TRUE
;

658 
	`BSA_AvkO³nIn™
(&
İ’_·¿m
);

659 
	`memıy
((*è(
İ’_·¿m
.
bd_addr
), bd_addr, (
BD_ADDR
));

660 
İ’_·¿m
.
chªÃl
 = 
BSA_AVK_CHNL_AUDIO
;

661 
İ’_·¿m
.
£c_mask
 = 
BSA_SEC_NONE
;

662 
¡©us
 = 
	`BSA_AvkO³n
(&
İ’_·¿m
);

663 ià(
¡©us
 !ğ
BSA_SUCCESS
)

665 
	`APP_ERROR1
("Unableo connecto device %02X:%02X:%02X:%02X:%02X:%02X with status %d",

666 
İ’_·¿m
.
bd_addr
[0], open_param.bd_addr[1], open_param.bd_addr[2],

667 
İ’_·¿m
.
bd_addr
[3], o³n_·¿m.bd_addr[4], o³n_·¿m.bd_addr[5], 
¡©us
);

669 
­p_avk_cb
.
İ’_³ndšg
 = 
FALSE
;

674 
	`´štf
("waiting for AV connectiono open\n");

676 
­p_avk_cb
.
İ’_³ndšg
 =ğ
TRUE
);

678 ià(
­p_avk_cb
.
is_İ’
 =ğ
FALSE
)

681 
	`´štf
("çu» o³nšg AV cÚÃùiÚ stu %d \n", 
­p_avk_cb
.
Ï¡_İ’_¡©us
);

686 
	`APP_DEBUG1
("CÚÃùedØAV deviû:%s", 
p_Çme
);

688 
	`­p_»ad_xml_»mÙe_deviûs
();

691 
	`­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

692 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
bd_addr
,

693 
BSA_A2DP_SERVICE_MASK
 | 
BSA_AVRCP_SERVICE_MASK
);

695 
	`­p_xml_upd©e_Çme_db
(
­p_xml_»mÙe_deviûs_db
,

696 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
bd_addr
, 
p_Çme
);

699 ià(
	`­p_wr™e_xml_»mÙe_deviûs
() < 0)

701 
	`APP_ERROR0
("Failedo store„emote devices database");

707 
	}
}

718 
	$­p_avk_şo£
()

720 
tBSA_STATUS
 
¡©us
;

721 
tBSA_AVK_CLOSE
 
b§_avk_şo£_·¿m
;

724 
	`BSA_AvkClo£In™
(&
b§_avk_şo£_·¿m
);

725 
¡©us
 = 
	`BSA_AvkClo£
(&
b§_avk_şo£_·¿m
);

726 ià(
¡©us
 !ğ
BSA_SUCCESS
)

728 
	`APP_ERROR1
("UÇbËØClo£ AVK cÚÃùiÚ w™h stu %d", 
¡©us
);

731 
	}
}

742 
	$­p_avk_İ’_rc
()

744 
tBSA_STATUS
 
¡©us
;

745 
tBSA_AVK_OPEN
 
b§_avk_İ’_·¿m
;

748 
	`BSA_AvkO³nRcIn™
(&
b§_avk_İ’_·¿m
);

749 
¡©us
 = 
	`BSA_AvkO³nRc
(&
b§_avk_İ’_·¿m
);

750 ià(
¡©us
 !ğ
BSA_SUCCESS
)

752 
	`APP_ERROR1
("UÇbËØİ’‡rvøcÚÃùiÚ w™h stu %d", 
¡©us
);

755 
	}
}

766 
	$­p_avk_şo£_rc
()

768 
tBSA_STATUS
 
¡©us
;

769 
tBSA_AVK_CLOSE
 
b§_avk_şo£_·¿m
;

772 
	`BSA_AvkClo£RcIn™
(&
b§_avk_şo£_·¿m
);

774 
b§_avk_şo£_·¿m
.
hªdË
 = 
­p_avk_cb
.
rc_hªdË
;

776 
¡©us
 = 
	`BSA_AvkClo£Rc
(&
b§_avk_şo£_·¿m
);

777 ià(
¡©us
 !ğ
BSA_SUCCESS
)

779 
	`APP_ERROR1
("UÇbËØşo£‡rvøcÚÃùiÚ w™h stu %d", 
¡©us
);

782 
	}
}

793 
	$­p_avk_¡¬t
()

795 
tBSA_STATUS
 
¡©us
;

796 
tBSA_AVK_START
 
»q
;

799 
	`BSA_AvkS¹In™
(&
»q
);

800 
¡©us
 = 
	`BSA_AvkS¹
(&
»q
);

801 ià(
¡©us
 !ğ
BSA_SUCCESS
)

803 
	`APP_ERROR1
("UÇbËØ¡¬ˆAVK cÚÃùiÚ w™h stu %d", 
¡©us
);

805 
	}
}

816 
	$­p_avk_¡İ
(
BOOLEAN
 
su¥’d
)

818 
tBSA_STATUS
 
¡©us
;

819 
tBSA_AVK_STOP
 
»q
;

822 
	`BSA_AvkStİIn™
(&
»q
);

823 
»q
.
·u£
 = 
su¥’d
;

825 
¡©us
 = 
	`BSA_AvkStİ
(&
»q
);

826 ià(
¡©us
 !ğ
BSA_SUCCESS
)

828 
	`APP_ERROR1
("UÇbËØ¡İ AVK cÚÃùiÚ w™h stu %d", 
¡©us
);

830 
	}
}

841 
	$­p_avk_»gi¡”
()

843 
tBSA_STATUS
 
¡©us
;

844 
tBSA_AVK_REGISTER
 
b§_avk_»gi¡”_·¿m
;

847 
	`BSA_AvkRegi¡”In™
(&
b§_avk_»gi¡”_·¿m
);

848 
b§_avk_»gi¡”_·¿m
.
chªÃl
 = 
BSA_AVK_CHNL_AUDIO
;

849 
b§_avk_»gi¡”_·¿m
.
medŸ_sup_fÜm©
.
audio
.
pcm_suµÜ‹d
 = 
TRUE
;

850 
b§_avk_»gi¡”_·¿m
.
medŸ_sup_fÜm©
.
audio
.
£c_suµÜ‹d
 = 
TRUE
;

851 #ià(
	`defšed
(
BSA_AVK_AAC_SUPPORTED
è&& (BSA_AVK_AAC_SUPPORTED==
TRUE
))

853 
b§_avk_»gi¡”_·¿m
.
medŸ_sup_fÜm©
.
audio
.
¯c_suµÜ‹d
 = 
TRUE
;

855 
	`¡ºıy
(
b§_avk_»gi¡”_·¿m
.
£rviû_Çme
, "BSA Audio Service",

856 
BSA_AVK_SERVICE_NAME_LEN_MAX
);

858 
b§_avk_»gi¡”_·¿m
.
»g_nÙifiÿtiÚs
 =„eg_notifications;

860 
¡©us
 = 
	`BSA_AvkRegi¡”
(&
b§_avk_»gi¡”_·¿m
);

861 ià(
¡©us
 !ğ
BSA_SUCCESS
)

863 
	`APP_ERROR1
("UÇbËØ»gi¡”‡ÀAV sšk w™h stu %d", 
¡©us
);

867 
­p_avk_cb
.
uc_audio_chªÃl
 = 
b§_avk_»gi¡”_·¿m
.
uc_chªÃl
;

870 ià(
	`UIPC_O³n
(
b§_avk_»gi¡”_·¿m
.
uc_chªÃl
, 
­p_avk_uc_cback
è=ğ
FALSE
)

872 
	`APP_ERROR0
("Unableo open UIPC channel");

876 
­p_avk_cb
.
fd
 = -1;

880 
	}
}

891 
	$­p_avk_d”egi¡”
()

893 
tBSA_STATUS
 
¡©us
;

894 
tBSA_AVK_DEREGISTER
 
»q
;

897 
	`BSA_AvkD”egi¡”In™
(&
»q
);

898 
¡©us
 = 
	`BSA_AvkD”egi¡”
(&
»q
);

899 ià(
¡©us
 !ğ
BSA_SUCCESS
)

901 
	`APP_ERROR1
("UÇbËØd”egi¡”‡ÀAV sšk w™h stu %d", 
¡©us
);

904 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_M24
)

905 
	`şo£
(
­p_avk_cb
.
fd
);

907 
	`­p_avk_şo£_wave_fe
();

910 
	`UIPC_Clo£
(
­p_avk_cb
.
uc_audio_chªÃl
);

911 
­p_avk_cb
.
uc_audio_chªÃl
 = 
UIPC_CH_ID_BAD
;

913 
	}
}

926 
	$­p_avk_uc_cback
(
BT_HDR
 *
p_msg
)

928 #ifdeà
PCM_ALSA


929 
¢d_pcm_säames_t
 
®§_äames
;

930 
¢d_pcm_säames_t
 
®§_äames_to_£nd
;

932 
UINT8
 *
p_bufãr
;

933 
dummy
;

935 ià(
p_msg
 =ğ
NULL
)

940 
p_bufãr
 = ((
UINT8
 *)(
p_msg
 + 1)è+…_msg->
off£t
;

941 ià(
­p_avk_cb
.
fd
 != -1)

943 
dummy
 = 
	`wr™e
(
­p_avk_cb
.
fd
, 
p_bufãr
, 
p_msg
->
Ën
);

944 ()
dummy
;

946 #ifdeà
USE_INGENIC_AUDIO_SOCKET


947 
»t
 = 
	`šg’ic_audio_oss_wr™e
(
p_bufãr
, 
p_msg
->
Ën
);

948 if(
»t
 <= 0)

949 
	`APP_ERROR1
("£nd bufã¸d©¨”rÜ: %s\n",
	`¡»¼Ü
(
”ºo
));

952 #ià(
	`defšed
(
BSA_AVK_DUMP_RX_DATA
è&& (BSA_AVK_DUMP_RX_DATA =ğ
TRUE
))

953 
	`APP_DUMP
("A2DP D©a", 
p_bufãr
, 
p_msg
->
Ën
);

956 ià(
­p_avk_cb
.
fÜm©
 =ğ
BSA_AVK_CODEC_M24
)

961 #ifdeà
PCM_ALSA


962 ià(
­p_avk_cb
.
®§_hªdË
 !ğ
NULL
)

965 
®§_äames_to_£nd
 = 
p_msg
->
Ën
 / 
­p_avk_cb
.
num_chªÃl
;

966 ià(
­p_avk_cb
.
b™_³r_§m¶e
 == 16)

967 
®§_äames_to_£nd
 /= 2;

969 
®§_äames
 = 
	`¢d_pcm_wr™ei
(
­p_avk_cb
.
®§_hªdË
, 
p_bufãr
, 
®§_äames_to_£nd
);

970 ià(
®§_äames
 < 0)

972 
®§_äames
 = 
	`¢d_pcm_»cov”
(
­p_avk_cb
.
®§_hªdË
,‡lsa_frames, 0);

974 ià(
®§_äames
 < 0)

978 ià(
®§_äames
 > 0 &&‡l§_äame < 
®§_äames_to_£nd
)

979 
	`´štf
("app_avk_uipc_cback Short write (expected %li, wrote %li)\n",

980 (è
®§_äames_to_£nd
, 
®§_äames
);

983 
	`GKI_ä“buf
(
p_msg
);

984 
	}
}

997 
	$­p_avk_š™
(
tAvkC®lback
 
pcb
)

999 
tBSA_AVK_ENABLE
 
b§_avk_’abË_·¿m
;

1000 
tBSA_STATUS
 
¡©us
;

1003 
s_pC®lback
 = 
pcb
;

1006 
	`mem£t
(&
­p_avk_cb
, 0, (app_avk_cb));

1007 
­p_avk_cb
.
uc_audio_chªÃl
 = 
UIPC_CH_ID_BAD
;

1009 
­p_avk_cb
.
ã©u»s
 = 
BSA_AVK_FEATURES
;

1010 
­p_avk_cb
.
fd
 = -1;

1012 
	`BSA_AvkEÇbËIn™
(&
b§_avk_’abË_·¿m
);

1014 
b§_avk_’abË_·¿m
.
£c_mask
 = 
BSA_AVK_SECURITY
;

1015 
b§_avk_’abË_·¿m
.
ã©u»s
 = 
BSA_AVK_FEATURES
;

1016 
b§_avk_’abË_·¿m
.
p_cback
 = 
­p_avk_cback
;

1018 
¡©us
 = 
	`BSA_AvkEÇbË
(&
b§_avk_’abË_·¿m
);

1019 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1021 
	`APP_ERROR0
("Unableoƒnable AVK service");

1025  
BSA_SUCCESS
;

1027 
	}
}

1038 
	$­p_avk_rc_£nd_commªd
(
UINT8
 
key_¡©e
, UINT8 
commªd
)

1040 
¡©us
;

1041 
tBSA_AVK_REM_CMD
 
b§_avk_rc_cmd
;

1044 
¡©us
 = 
	`BSA_AvkRemÙeCmdIn™
(&
b§_avk_rc_cmd
);

1045 
b§_avk_rc_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1046 
b§_avk_rc_cmd
.
key_¡©e
 = (
tBSA_AVK_STATE
)key_state;

1047 
b§_avk_rc_cmd
.
rc_id
 = (
tBSA_AVK_RC
)
commªd
;

1048 
b§_avk_rc_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1050 
¡©us
 = 
	`BSA_AvkRemÙeCmd
(&
b§_avk_rc_cmd
);

1051 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1053 
	`APP_ERROR1
("UÇbËØS’d AV RC Commªd %d", 
¡©us
);

1055 
	}
}

1066 
	$­p_avk_rc_£nd_şick
(
UINT8
 
commªd
)

1068 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_PRESS
, 
commªd
);

1069 
	`GKI_d–ay
(300);

1070 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_RELEASE
, 
commªd
);

1071 
	}
}

1083 
	$­p_avk_¶ay_¡¬t
()

1085 ià((
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è&&‡µ_avk_cb.
is_rc_İ’
)

1087 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_PLAY
);

1091 
	`­p_avk_¡¬t
();

1093 
	}
}

1104 
	$­p_avk_¶ay_¡İ
()

1106 ià((
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è&&‡µ_avk_cb.
is_rc_İ’
)

1108 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_STOP
);

1112 
	`­p_avk_¡İ
(
TRUE
);

1115 
	`şo£_šg’ic_audio_oss_ouut
();

1116 
	}
}

1128 
	$­p_avk_¶ay_·u£
()

1130 ià((
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è&&‡µ_avk_cb.
is_rc_İ’
)

1132 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_PAUSE
);

1136 
	`­p_avk_¡İ
(
TRUE
);

1138 
	}
}

1150 
	$­p_avk_¶ay_Ãxt_Œack
()

1152 ià((
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è&&‡µ_avk_cb.
is_rc_İ’
)

1154 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_FORWARD
);

1158 
	`APP_ERROR1
("Unableo send AVRC command, is support RCTG %d, is„c open %d",

1159 (
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
),‡µ_avk_cb.
is_rc_İ’
);

1161 
	}
}

1173 
	$­p_avk_¶ay_´evious_Œack
()

1175 ià((
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è&&‡µ_avk_cb.
is_rc_İ’
)

1177 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_BACKWARD
);

1181 
	`APP_ERROR1
("Unableo send AVRC command, is support RCCT %d, is„c open %d",

1182 (
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
),‡µ_avk_cb.
is_rc_İ’
);

1184 
	}
}

1196 
	$­p_avk_rc_cmd
()

1198 
choiû
;

1202 
	`´štf
("Bluetooth AVK AVRC CMD menu:\n");

1203 
	`´štf
(" 0…lay\n");

1204 
	`´štf
(" 1 stop\n");

1205 
	`´štf
(" 2…ause\n");

1206 
	`´štf
(" 3 forward\n");

1207 
	`´štf
(" 4 backward\n");

1208 
	`´štf
(" 5„ewind key_press\n");

1209 
	`´štf
(" 6„ewind key_release\n");

1210 
	`´štf
(" 7 fast forward key_press\n");

1211 
	`´štf
(" 8 fast forward key_release\n");

1213 
	`´štf
(" 99ƒxit\n");

1215 
choiû
 = 
	`­p_g‘_choiû
("Select source");

1217 
choiû
)

1220 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_PLAY
);

1224 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_STOP
);

1228 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_PAUSE
);

1232 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_FORWARD
);

1236 
	`­p_avk_rc_£nd_şick
(
BSA_AVK_RC_BACKWARD
);

1240 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_PRESS
, 
BSA_AVK_RC_REWIND
);

1244 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_RELEASE
, 
BSA_AVK_RC_REWIND
);

1248 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_PRESS
, 
BSA_AVK_RC_FAST_FOR
);

1252 
	`­p_avk_rc_£nd_commªd
(
BSA_AV_STATE_RELEASE
, 
BSA_AVK_RC_FAST_FOR
);

1256 
	`APP_ERROR0
("Unsupported choice");

1259 } 
choiû
 != 99);

1260 
	}
}

1272 
	$­p_avk_£nd_g‘_–em’t_©Œibu‹s_cmd
()

1274 
¡©us
;

1275 
tBSA_AVK_VEN_CMD
 
b§_avk_v’dÜ_cmd
;

1278 
¡©us
 = 
	`BSA_AvkV’dÜCmdIn™
(&
b§_avk_v’dÜ_cmd
);

1280 
b§_avk_v’dÜ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1281 
b§_avk_v’dÜ_cmd
.
ùy³
 = 
BSA_AVK_CMD_STATUS
;

1282 
b§_avk_v’dÜ_cmd
.
d©a
[0] = 
BSA_AVK_RC_VD_GET_ELEMENT_ATTR
;

1283 
b§_avk_v’dÜ_cmd
.
d©a
[1] = 0;

1284 
b§_avk_v’dÜ_cmd
.
d©a
[2] = 0;

1285 
b§_avk_v’dÜ_cmd
.
d©a
[3] = 0x11;

1289 
b§_avk_v’dÜ_cmd
.
d©a
[12] = 2;

1292 
b§_avk_v’dÜ_cmd
.
d©a
[16] = 0x1;

1295 
b§_avk_v’dÜ_cmd
.
d©a
[20] = 0x7;

1297 
b§_avk_v’dÜ_cmd
.
Ëngth
 = 21;

1298 
b§_avk_v’dÜ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1300 
¡©us
 = 
	`BSA_AvkV’dÜCmd
(&
b§_avk_v’dÜ_cmd
);

1301 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1303 
	`APP_ERROR1
("UÇbËØS’d AV V’dÜ Commªd %d", 
¡©us
);

1305 
	}
}

1318 
BOOLEAN
 
	$avk_is_İ’_³ndšg
()

1320  
­p_avk_cb
.
İ’_³ndšg
;

1321 
	}
}

1334 
	$avk_£t_İ’_³ndšg
(
BOOLEAN
 
bİ’³nd
)

1336 
­p_avk_cb
.
İ’_³ndšg
 = 
bİ’³nd
;

1337 
	}
}

1350 
BOOLEAN
 
	$avk_is_İ’
(
BD_ADDR
 
bda
)

1352 
BOOLEAN
 
bİ’
 = 
­p_avk_cb
.
is_İ’
;

1353 if(
bİ’
)

1355 
	`bdıy
(
bda
, 
­p_avk_cb
.
bda_cÚÃùed
);

1358  
bİ’
;

1359 
	}
}

1372 
BOOLEAN
 
	$avk_is_rc_İ’
()

1374  
­p_avk_cb
.
is_rc_İ’
;

1375 
	}
}

1388 
tBSA_STATUS
 
	$avk_Ï¡_İ’_¡©us
()

1390  
­p_avk_cb
.
Ï¡_İ’_¡©us
;

1391 
	}
}

1404 
BOOLEAN
 
	$avk_is_¡¬‹d
()

1406  
­p_avk_cb
.
is_¡¬‹d
;

1407 
	}
}

1418 
	$­p_avk_ÿnûl
()

1420 
¡©us
;

1421 
tBSA_AVK_CANCEL_CMD
 
b§_avk_ÿnûl_cmd
;

1424 
¡©us
 = 
	`BSA_AvkCªûlCmdIn™
(&
b§_avk_ÿnûl_cmd
);

1426 
¡©us
 = 
	`BSA_AvkCªûlCmd
(&
b§_avk_ÿnûl_cmd
);

1427 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1429 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_ÿnûl_commªd %d", 
¡©us
);

1431 
	}
}

1443 
	$­p_avk_rc_g‘_–em’t_©Œ_commªd
()

1445 
¡©us
;

1446 
tBSA_AVK_GET_ELEMENT_ATTR
 
b§_avk_g‘_–em_©Œ_cmd
;

1448 
UINT8
 
©Œs
[] = {
AVRC_MEDIA_ATTR_ID_TITLE
,

1449 
AVRC_MEDIA_ATTR_ID_ARTIST
,

1450 
AVRC_MEDIA_ATTR_ID_ALBUM
,

1451 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

1452 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

1453 
AVRC_MEDIA_ATTR_ID_GENRE
,

1454 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
};

1455 
UINT8
 
num_©Œ
 = 7;

1458 
¡©us
 = 
	`BSA_AvkG‘EËm’tA‰rCmdIn™
(&
b§_avk_g‘_–em_©Œ_cmd
);

1459 
b§_avk_g‘_–em_©Œ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1460 
b§_avk_g‘_–em_©Œ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1462 
b§_avk_g‘_–em_©Œ_cmd
.
num_©Œ
 =‚um_attr;

1463 
	`memıy
(
b§_avk_g‘_–em_©Œ_cmd
.
©Œs
,‡ttrs, (attrs));

1465 
¡©us
 = 
	`BSA_AvkG‘EËm’tA‰rCmd
(&
b§_avk_g‘_–em_©Œ_cmd
);

1466 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1468 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_g‘_–em’t_©Œ_commªd %d", 
¡©us
);

1470 
	}
}

1481 
	$­p_avk_rc_li¡_¶ay”_©Œ_commªd
()

1483 
¡©us
;

1484 
tBSA_AVK_LIST_PLAYER_ATTR
 
b§_avk_li¡_¶ay”_©Œ_cmd
;

1487 
¡©us
 = 
	`BSA_AvkLi¡PÏy”A‰rCmdIn™
(&
b§_avk_li¡_¶ay”_©Œ_cmd
);

1488 
b§_avk_li¡_¶ay”_©Œ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1489 
b§_avk_li¡_¶ay”_©Œ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1491 
¡©us
 = 
	`BSA_AvkLi¡PÏy”A‰rCmd
(&
b§_avk_li¡_¶ay”_©Œ_cmd
);

1492 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1494 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_li¡_¶ay”_©Œ_commªd %d", 
¡©us
);

1496 
	}
}

1507 
	$­p_avk_rc_li¡_¶ay”_©Œ_v®ue_commªd
(
UINT8
 
©Œ
)

1509 
¡©us
;

1510 
tBSA_AVK_LIST_PLAYER_VALUES
 
b§_avk_li¡_¶ay”_©Œ_cmd
;

1513 
¡©us
 = 
	`BSA_AvkLi¡PÏy”V®uesCmdIn™
(&
b§_avk_li¡_¶ay”_©Œ_cmd
);

1514 
b§_avk_li¡_¶ay”_©Œ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1515 
b§_avk_li¡_¶ay”_©Œ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1516 
b§_avk_li¡_¶ay”_©Œ_cmd
.
©Œ
 =‡ttr;

1518 
¡©us
 = 
	`BSA_AvkLi¡PÏy”V®uesCmd
(&
b§_avk_li¡_¶ay”_©Œ_cmd
);

1519 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1521 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_li¡_¶ay”_©Œ_commªd %d", 
¡©us
);

1523 
	}
}

1535 
	$­p_avk_rc_g‘_¶ay”_v®ue_commªd
(
UINT8
 *
©Œs
, UINT8 
num_©Œ
)

1537 
¡©us
;

1538 
tBSA_AVK_GET_PLAYER_VALUE
 
b§_avk_g‘_¶ay”_v®_cmd
;

1541 
¡©us
 = 
	`BSA_AvkG‘PÏy”V®ueCmdIn™
(&
b§_avk_g‘_¶ay”_v®_cmd
);

1542 
b§_avk_g‘_¶ay”_v®_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1543 
b§_avk_g‘_¶ay”_v®_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1544 
b§_avk_g‘_¶ay”_v®_cmd
.
num_©Œ
 =‚um_attr;

1546 
	`memıy
(
b§_avk_g‘_¶ay”_v®_cmd
.
©Œs
,‡‰rs, (
UINT8
è* 
num_©Œ
);

1548 
¡©us
 = 
	`BSA_AvkG‘PÏy”V®ueCmd
(&
b§_avk_g‘_¶ay”_v®_cmd
);

1549 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1551 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_g‘_¶ay”_v®ue_commªd %d", 
¡©us
);

1553 
	}
}

1566 
	$­p_avk_rc_£t_¶ay”_v®ue_commªd
(
UINT8
 
num_©Œ
, UINT8 *
©Œ_ids
, UINT8 * 
©Œ_v®
)

1568 
¡©us
;

1569 
tBSA_AVK_SET_PLAYER_VALUE
 
b§_avk_£t_¶ay”_v®_cmd
;

1572 
¡©us
 = 
	`BSA_AvkS‘PÏy”V®ueCmdIn™
(&
b§_avk_£t_¶ay”_v®_cmd
);

1573 
b§_avk_£t_¶ay”_v®_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1574 
b§_avk_£t_¶ay”_v®_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1575 
b§_avk_£t_¶ay”_v®_cmd
.
num_©Œ
 =‚um_attr;

1577 
	`memıy
(
b§_avk_£t_¶ay”_v®_cmd
.
¶ay”_©Œ
, 
©Œ_ids
, (
UINT8
è* 
num_©Œ
);

1578 
	`memıy
(
b§_avk_£t_¶ay”_v®_cmd
.
¶ay”_v®ue
, 
©Œ_v®
, (
UINT8
è* 
num_©Œ
);

1580 
¡©us
 = 
	`BSA_AvkS‘PÏy”V®ueCmd
(&
b§_avk_£t_¶ay”_v®_cmd
);

1581 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1583 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_£t_¶ay”_v®ue_commªd %d", 
¡©us
);

1585 
	}
}

1597 
	$­p_avk_rc_g‘_¶ay_¡©us_commªd
()

1599 
¡©us
;

1600 
tBSA_AVK_GET_PLAY_STATUS
 
b§_avk_¶ay_¡©us_cmd
;

1603 
¡©us
 = 
	`BSA_AvkG‘PÏyStusCmdIn™
(&
b§_avk_¶ay_¡©us_cmd
);

1604 
b§_avk_¶ay_¡©us_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1605 
b§_avk_¶ay_¡©us_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1607 
¡©us
 = 
	`BSA_AvkG‘PÏyStusCmd
(&
b§_avk_¶ay_¡©us_cmd
);

1608 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1610 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_g‘_¶ay_¡©us_commªd %d", 
¡©us
);

1612 
	}
}

1624 
	$­p_avk_rc_£t_brow£d_¶ay”_commªd
(
UINT16
 
¶ay”_id
)

1626 
¡©us
;

1627 
tBSA_AVK_SET_BROWSED_PLAYER
 
b§_avk_£t_brow£d_¶ay”
;

1630 
¡©us
 = 
	`BSA_AvkS‘Brow£dPÏy”CmdIn™
(&
b§_avk_£t_brow£d_¶ay”
);

1631 
b§_avk_£t_brow£d_¶ay”
.
¶ay”_id
 =…layer_id;

1632 
b§_avk_£t_brow£d_¶ay”
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1633 
b§_avk_£t_brow£d_¶ay”
.
Ïb–
 = 
­p_avk_cb
.label++;

1635 
¡©us
 = 
	`BSA_AvkS‘Brow£dPÏy”Cmd
(&
b§_avk_£t_brow£d_¶ay”
);

1636 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1638 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_£t_brow£d_¶ay”_commªd %d", 
¡©us
);

1640 
	}
}

1652 
	$­p_avk_rc_£t_add»s£d_¶ay”_commªd
(
UINT16
 
¶ay”_id
)

1654 
¡©us
;

1655 
tBSA_AVK_SET_ADDR_PLAYER
 
b§_avk_£t_¶ay”
;

1658 
¡©us
 = 
	`BSA_AvkS‘Add»s£dPÏy”CmdIn™
(&
b§_avk_£t_¶ay”
);

1659 
b§_avk_£t_¶ay”
.
¶ay”_id
 =…layer_id;

1660 
b§_avk_£t_¶ay”
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1661 
b§_avk_£t_¶ay”
.
Ïb–
 = 
­p_avk_cb
.label++;

1663 
¡©us
 = 
	`BSA_AvkS‘Add»s£dPÏy”Cmd
(&
b§_avk_£t_¶ay”
);

1664 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1666 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_£t_add»s£d_¶ay”_commªd %d", 
¡©us
);

1668 
	}
}

1679 
	$­p_avk_rc_chªge_·th_commªd
(
UINT16
 
uid_couÁ”
, 
UINT8
 
dœeùiÚ
, 
tAVRC_UID
 
fŞd”_uid
)

1681 
¡©us
;

1682 
tBSA_AVK_CHG_PATH
 
b§_chªge_·th
;

1685 
¡©us
 = 
	`BSA_AvkChªgeP©hCmdIn™
(&
b§_chªge_·th
);

1687 
b§_chªge_·th
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1688 
b§_chªge_·th
.
Ïb–
 = 
­p_avk_cb
.label++;

1690 
b§_chªge_·th
.
uid_couÁ”
 = uid_counter;

1691 
b§_chªge_·th
.
dœeùiÚ
 = direction;

1692 
	`memıy
(
b§_chªge_·th
.
fŞd”_uid
, fŞd”_uid, (
tAVRC_UID
));

1694 
¡©us
 = 
	`BSA_AvkChªgeP©hCmd
(&
b§_chªge_·th
);

1695 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1697 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_chªge_·th_commªd %d", 
¡©us
);

1699 
	}
}

1711 
	$­p_avk_rc_g‘_fŞd”_™ems
(
UINT8
 
scİe
, 
UINT32
 
¡¬t_™em
, UINT32 
’d_™em
)

1713 
¡©us
;

1714 
tBSA_AVK_GET_FOLDER_ITEMS
 
b§_g‘_fŞd”_™ems
;

1716 
UINT32
 
©Œs
[] = {
AVRC_MEDIA_ATTR_ID_TITLE
,

1717 
AVRC_MEDIA_ATTR_ID_ARTIST
,

1718 
AVRC_MEDIA_ATTR_ID_ALBUM
,

1719 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

1720 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

1721 
AVRC_MEDIA_ATTR_ID_GENRE
,

1722 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
};

1723 
UINT8
 
num_©Œ
 = 7;

1726 
¡©us
 = 
	`BSA_AvkG‘FŞd”I‹msCmdIn™
(&
b§_g‘_fŞd”_™ems
);

1728 
b§_g‘_fŞd”_™ems
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1729 
b§_g‘_fŞd”_™ems
.
Ïb–
 = 
­p_avk_cb
.label++;

1731 
b§_g‘_fŞd”_™ems
.
scİe
 = scope;

1732 
b§_g‘_fŞd”_™ems
.
¡¬t_™em
 = start_item;

1733 
b§_g‘_fŞd”_™ems
.
’d_™em
 =ƒnd_item;

1735 if(
AVRC_SCOPE_PLAYER_LIST
 !ğ
scİe
)

1737 
b§_g‘_fŞd”_™ems
.
©Œ_couÁ
 = 
num_©Œ
;

1738 
	`memıy
(
b§_g‘_fŞd”_™ems
.
©Œs
,‡ttrs, (attrs));

1742 
¡©us
 = 
	`BSA_AvkG‘FŞd”I‹msCmd
(&
b§_g‘_fŞd”_™ems
);

1743 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1745 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_g‘_fŞd”_™em %d", 
¡©us
);

1747 
	}
}

1758 
	$­p_avk_rc_g‘_™ems_©Œ
(
UINT8
 
scİe
, 
tAVRC_UID
 
uid
, 
UINT16
 
uid_couÁ”
)

1760 
¡©us
;

1761 
tBSA_AVK_GET_ITEMS_ATTR
 
b§_g‘_™ems_©Œ
;

1763 
UINT8
 
©Œs
[] = {
AVRC_MEDIA_ATTR_ID_TITLE
,

1764 
AVRC_MEDIA_ATTR_ID_ARTIST
,

1765 
AVRC_MEDIA_ATTR_ID_ALBUM
,

1766 
AVRC_MEDIA_ATTR_ID_TRACK_NUM
,

1767 
AVRC_MEDIA_ATTR_ID_NUM_TRACKS
,

1768 
AVRC_MEDIA_ATTR_ID_GENRE
,

1769 
AVRC_MEDIA_ATTR_ID_PLAYING_TIME
};

1770 
UINT8
 
num_©Œ
 = 7;

1773 
¡©us
 = 
	`BSA_AvkG‘I‹msA‰rCmdIn™
(&
b§_g‘_™ems_©Œ
);

1775 
b§_g‘_™ems_©Œ
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1776 
b§_g‘_™ems_©Œ
.
Ïb–
 = 
­p_avk_cb
.label++;

1778 
b§_g‘_™ems_©Œ
.
scİe
 = scope;

1779 
	`memıy
(
b§_g‘_™ems_©Œ
.
uid
, uid, (
tAVRC_UID
));

1780 
b§_g‘_™ems_©Œ
.
uid_couÁ”
 = uid_counter;

1781 
b§_g‘_™ems_©Œ
.
©Œ_couÁ
 = 
num_©Œ
;

1782 
	`memıy
(
b§_g‘_™ems_©Œ
.
©Œs
,‡ttrs, (attrs));

1784 
¡©us
 = 
	`BSA_AvkG‘I‹msA‰rCmd
(&
b§_g‘_™ems_©Œ
);

1785 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1787 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_g‘_™ems_©Œ %d", 
¡©us
);

1789 
	}
}

1801 
	$­p_avk_rc_¶ay_™em
(
UINT8
 
scİe
, 
tAVRC_UID
 
uid
, 
UINT16
 
uid_couÁ”
)

1803 
¡©us
;

1804 
tBSA_AVK_PLAY_ITEM
 
b§_¶ay_™em
;

1808 
¡©us
 = 
	`BSA_AvkPÏyI‹mCmdIn™
(&
b§_¶ay_™em
);

1810 
b§_¶ay_™em
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1811 
b§_¶ay_™em
.
Ïb–
 = 
­p_avk_cb
.label++;

1813 
b§_¶ay_™em
.
scİe
 = scope;

1814 
	`memıy
(
b§_¶ay_™em
.
uid
, uid, (
tAVRC_UID
));

1815 
b§_¶ay_™em
.
uid_couÁ”
 = uid_counter;

1817 
¡©us
 = 
	`BSA_AvkPÏyI‹mCmd
(&
b§_¶ay_™em
);

1818 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1820 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_¶ay_™em %d", 
¡©us
);

1822 
	}
}

1834 
	$­p_avk_rc_add_to_¶ay
(
UINT8
 
scİe
, 
tAVRC_UID
 
uid
, 
UINT16
 
uid_couÁ”
)

1836 
¡©us
;

1837 
tBSA_AVK_ADD_TO_PLAY
 
b§_add_¶ay
;

1841 
¡©us
 = 
	`BSA_AvkAddToPÏyCmdIn™
(&
b§_add_¶ay
);

1843 
b§_add_¶ay
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1844 
b§_add_¶ay
.
Ïb–
 = 
­p_avk_cb
.label++;

1846 
b§_add_¶ay
.
scİe
 = scope;

1847 
	`memıy
(
b§_add_¶ay
.
uid
, uid, (
tAVRC_UID
));

1848 
b§_add_¶ay
.
uid_couÁ”
 = uid_counter;

1850 
¡©us
 = 
	`BSA_AvkAddToPÏyCmd
(&
b§_add_¶ay
);

1851 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1853 
	`APP_ERROR1
("UÇbËØS’d‡µ_avk_rc_add_to_¶ay %d", 
¡©us
);

1855 
	}
}

1866 
	$­p_avk_£t_abs_vŞ_r¥
(
UINT8
 
vŞume
, UINT8 
rc_hªdË
, UINT8 
Ïb–
)

1868 
¡©us
;

1869 
tBSA_AVK_SET_ABS_VOLUME_RSP
 
abs_vŞ
;

1870 
	`BSA_AvkS‘AbsVŞumeR¥In™
(&
abs_vŞ
);

1872 
abs_vŞ
.
Ïb–
 =†abel;

1873 
abs_vŞ
.
rc_hªdË
 =„c_handle;

1874 
abs_vŞ
.
vŞume
 = volume;

1875 
¡©us
 = 
	`BSA_AvkS‘AbsVŞumeR¥
(&
abs_vŞ
);

1876 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1878 
	`APP_ERROR1
("UÇbËØ£nd‡µ_avk_£t_abs_vŞ_r¥ %d", 
¡©us
);

1880 
	}
}

1891 
	$­p_avk_»g_nÙâ_r¥
(
UINT8
 
vŞume
, UINT8 
rc_hªdË
, UINT8 
Ïb–
, UINT8 
ev’t
,

1892 
tBTA_AV_CODE
 
code
)

1894 
¡©us
;

1895 
tBSA_AVK_REG_NOTIF_RSP
 
»g_nÙf
;

1896 
	`BSA_AvkRegNÙifR¥In™
(&
»g_nÙf
);

1898 
»g_nÙf
.»g_nÙf.
·¿m
.
vŞume
 = volume;

1899 
»g_nÙf
.»g_nÙf.
ev’t_id
 = 
ev’t
;

1900 
»g_nÙf
.
rc_hªdË
 =„c_handle;

1901 
»g_nÙf
.
Ïb–
 =†abel;

1902 
»g_nÙf
.
code
 = code;

1904 
¡©us
 = 
	`BSA_AvkRegNÙifR¥
(&
»g_nÙf
);

1905 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1907 
	`APP_ERROR1
("UÇbËØ£nd‡µ_avk_»g_nÙâ_r¥ %d", 
¡©us
);

1909 
	}
}

1921 
	$­p_avk_£nd_g‘_ÿ·b™›s
()

1923 
¡©us
;

1924 
tBSA_AVK_VEN_CMD
 
b§_avk_v’dÜ_cmd
;

1927 
¡©us
 = 
	`BSA_AvkV’dÜCmdIn™
(&
b§_avk_v’dÜ_cmd
);

1929 
b§_avk_v’dÜ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1930 
b§_avk_v’dÜ_cmd
.
ùy³
 = 
BSA_AVK_CMD_STATUS
;

1931 
b§_avk_v’dÜ_cmd
.
d©a
[0] = 
BSA_AVK_RC_VD_GET_CAPABILITIES
;

1932 
b§_avk_v’dÜ_cmd
.
d©a
[1] = 0;

1933 
b§_avk_v’dÜ_cmd
.
d©a
[2] = 0;

1934 
b§_avk_v’dÜ_cmd
.
d©a
[3] = 1;

1935 
b§_avk_v’dÜ_cmd
.
d©a
[4] = 0x03;

1937 
b§_avk_v’dÜ_cmd
.
Ëngth
 = 5;

1938 
b§_avk_v’dÜ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1940 
¡©us
 = 
	`BSA_AvkV’dÜCmd
(&
b§_avk_v’dÜ_cmd
);

1941 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1943 
	`APP_ERROR1
("UÇbËØS’d AV V’dÜ Commªd %d", 
¡©us
);

1945 
	}
}

1956 
	$­p_avk_£nd_»gi¡”_nÙifiÿtiÚ
(
evt
)

1958 
¡©us
;

1959 
tBSA_AVK_VEN_CMD
 
b§_avk_v’dÜ_cmd
;

1962 
¡©us
 = 
	`BSA_AvkV’dÜCmdIn™
(&
b§_avk_v’dÜ_cmd
);

1964 
b§_avk_v’dÜ_cmd
.
rc_hªdË
 = 
­p_avk_cb
.rc_handle;

1965 
b§_avk_v’dÜ_cmd
.
ùy³
 = 
BSA_AVK_CMD_NOTIF
;

1966 
b§_avk_v’dÜ_cmd
.
d©a
[0] = 
BSA_AVK_RC_VD_REGISTER_NOTIFICATION
;

1967 
b§_avk_v’dÜ_cmd
.
d©a
[1] = 0;

1968 
b§_avk_v’dÜ_cmd
.
d©a
[2] = 0;

1969 
b§_avk_v’dÜ_cmd
.
d©a
[3] = 5;

1970 
b§_avk_v’dÜ_cmd
.
d©a
[4] = 
evt
;

1972 
b§_avk_v’dÜ_cmd
.
Ëngth
 = 9;

1973 
b§_avk_v’dÜ_cmd
.
Ïb–
 = 
­p_avk_cb
.label++;

1975 
¡©us
 = 
	`BSA_AvkV’dÜCmd
(&
b§_avk_v’dÜ_cmd
);

1976 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1978 
	`APP_ERROR1
("UÇbËØS’d AV V’dÜ Commªd %d", 
¡©us
);

1980 
	}
}

1991 
	$­p_avk_£nd_d–ay_»pÜt
(
UINT16
 
d–ay
)

1993 
tBSA_AVK_DELAY_REPORT
 
»pÜt
;

1994 
¡©us
;

1996 
	`APP_DEBUG1
("£nd d–ay„•Üt:%d", 
d–ay
);

1998 
	`BSA_AvkD–ayR•ÜtIn™
(&
»pÜt
);

1999 
»pÜt
.
d–ay
 = delay;

2000 
¡©us
 = 
	`BSA_AvkD–ayR•Üt
(&
»pÜt
);

2001 ià(
¡©us
 !ğ
BSA_SUCCESS
)

2003 
	`APP_ERROR1
("UÇbËØS’d d–ay„•Üˆ%d", 
¡©us
);

2005 
	}
}

2017 
	$­p_avk_rc_abs_vŞume_up
()

2019 
UINT8
 
abs_vŞume
 = 
­p_avk_cb
.
vŞume
;

2021 ià(!(
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è|| !­p_avk_cb.
is_rc_İ’
)

2023 
	`APP_ERROR1
("Unableo send AVRC command, is support RCTG %d, is„c open %d",

2024 (
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
),‡µ_avk_cb.
is_rc_İ’
);

2028 
abs_vŞume
 += 8;

2029 if(
abs_vŞume
 >= 0x7F)

2030 
abs_vŞume
 = 0x7F;

2031 
­p_avk_cb
.
vŞume
 = 
abs_vŞume
;

2033 
	`APP_DEBUG1
("­p_avk_rc_abs_vŞume_u°vŞum=0x%x\n", 
­p_avk_cb
.
vŞume
);

2035 
	`­p_avk_»g_nÙâ_r¥
(
­p_avk_cb
.
vŞume
,‡µ_avk_cb.
rc_hªdË
,‡µ_avk_cb.
vŞLab–
,

2036 
AVRC_EVT_VOLUME_CHANGE
, 
BTA_AV_RSP_CHANGED
);

2037 
	}
}

2048 
	$­p_avk_rc_abs_vŞume_down
()

2050 
UINT8
 
abs_vŞume
 = 
­p_avk_cb
.
vŞume
;

2052 ià(!(
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
è|| !­p_avk_cb.
is_rc_İ’
)

2054 
	`APP_ERROR1
("Unableo send AVRC command, is support RCTG %d, is„c open %d",

2055 (
­p_avk_cb
.
ã©u»s
 & 
BTA_AVK_FEAT_RCTG
),‡µ_avk_cb.
is_rc_İ’
);

2059 if(
abs_vŞume
 > 8)

2061 
abs_vŞume
 -= 8;

2065 
abs_vŞume
 = 0;

2067 
­p_avk_cb
.
vŞume
 = 
abs_vŞume
;

2069 
	`APP_DEBUG1
("­p_avk_rc_abs_vŞume_dowÀvŞum=0x%x\n", 
­p_avk_cb
.
vŞume
);

2071 
	`­p_avk_»g_nÙâ_r¥
(
­p_avk_cb
.
vŞume
,‡µ_avk_cb.
rc_hªdË
,‡µ_avk_cb.
vŞLab–
,

2072 
AVRC_EVT_VOLUME_CHANGE
, 
BTA_AV_RSP_CHANGED
);

2073 
	}
}

	@source/app_ble.c

12 
	~<”ºo.h
>

13 
	~<sys/un.h
>

14 
	~"­p_bË.h
"

15 
	~"­p_xml_uts.h
"

16 
	~"­p_uts.h
"

17 
	~"­p_mgt.h
"

18 
	~"­p_disc.h
"

19 
	~"­p_dm.h
"

20 
	~"­p_bË_ş›Á_db.h
"

25 
tAPP_BLE_CB
 
	g­p_bË_cb
;

40 
	#APP_BLE_ENABLE_WAKE_GPIO_VSC
 0xFD60

	)

41 
	#APP_BLE_PF_MANU_DATA_CO_ID
 0x000F

	)

42 
	#APP_BLE_PF_MANU_DATA_COND_TYPE
 5

	)

53 *
	$­p_bË_di¥Ïy_£rviû_Çme
(
UINT16
 
uuid
)

55 
uuid
)

57 
BSA_BLE_UUID_SERVCLASS_GAP_SERVER
:

59 
BSA_BLE_UUID_SERVCLASS_GATT_SERVER
:

61 
BSA_BLE_UUID_SERVCLASS_IMMEDIATE_ALERT
:

63 
BSA_BLE_UUID_SERVCLASS_LINKLOSS
:

65 
BSA_BLE_UUID_SERVCLASS_TX_POWER
:

67 
BSA_BLE_UUID_SERVCLASS_CURRENT_TIME
:

69 
BSA_BLE_UUID_SERVCLASS_DST_CHG
:

71 
BSA_BLE_UUID_SERVCLASS_REF_TIME_UPD
:

73 
BSA_BLE_UUID_SERVCLASS_GLUCOSE
:

75 
BSA_BLE_UUID_SERVCLASS_HEALTH_THERMOMETER
:

77 
BSA_BLE_UUID_SERVCLASS_DEVICE_INFORMATION
:

79 
BSA_BLE_UUID_SERVCLASS_NWA
:

81 
BSA_BLE_UUID_SERVCLASS_PHALERT
:

83 
BSA_BLE_UUID_SERVCLASS_HEART_RATE
:

85 
BSA_BLE_UUID_SERVCLASS_BATTERY_SERVICE
:

87 
BSA_BLE_UUID_SERVCLASS_BLOOD_PRESSURE
:

89 
BSA_BLE_UUID_SERVCLASS_ALERT_NOTIFICATION_SERVICE
:

91 
BSA_BLE_UUID_SERVCLASS_HUMAN_INTERFACE_DEVICE
:

93 
BSA_BLE_UUID_SERVCLASS_SCAN_PARAMETERS
:

95 
BSA_BLE_UUID_SERVCLASS_RUNNING_SPEED_AND_CADENCE
:

97 
BSA_BLE_UUID_SERVCLASS_CYCLING_SPEED_AND_CADENCE
:

99 
BSA_BLE_UUID_SERVCLASS_TEST_SERVER
:

107 
	}
}

120 
	$­p_bË_š™
()

122 
šdex
;

124 
	`mem£t
(&
­p_bË_cb
, 0, (app_ble_cb));

126 
šdex
 = 0;šdex < 
BSA_BLE_CLIENT_MAX
;index++)

128 
­p_bË_cb
.
bË_ş›Á
[
šdex
].
ş›Á_if
 = 
BSA_BLE_INVALID_IF
;

129 
­p_bË_cb
.
bË_ş›Á
[
šdex
].
cÚn_id
 = 
BSA_BLE_INVALID_CONN
;

132 
šdex
 = 0;šdex < 
BSA_BLE_SERVER_MAX
;index++)

134 
­p_bË_cb
.
bË_£rv”
[
šdex
].
£rv”_if
 = 
BSA_BLE_INVALID_IF
;

135 
­p_bË_cb
.
bË_£rv”
[
šdex
].
cÚn_id
 = 
BSA_BLE_INVALID_CONN
;

138 
	`­p_xml_š™
();

143 
	}
}

156 
	$­p_bË_ex™
()

158 
tBSA_STATUS
 
¡©us
;

159 
tBSA_BLE_DISABLE
 
·¿m
;

162 
	`­p_dm_£t_bË_visib™y
(
FALSE
, FALSE);

167 
	`BSA_BËDi§bËIn™
(&
·¿m
);

169 
¡©us
 = 
	`BSA_BËDi§bË
(&
·¿m
);

170 ià(
¡©us
 !ğ
BSA_SUCCESS
)

172 
	`APP_ERROR1
("UÇbËØdi§bË BLE stus:%d", 
¡©us
);

177 
	}
}

190 
	$­p_bË_¡¬t
()

192 
tBSA_STATUS
 
¡©us
;

193 
tBSA_BLE_ENABLE
 
’abË_·¿m
;

195 
	`APP_INFO0
("app_ble_start");

197 
	`BSA_BËEÇbËIn™
(&
’abË_·¿m
);

199 
¡©us
 = 
	`BSA_BËEÇbË
(&
’abË_·¿m
);

200 ià(
¡©us
 !ğ
BSA_SUCCESS
)

202 
	`APP_ERROR1
("UÇbËØ’abË BLE stus:%d", 
¡©us
);

207 
	}
}

220 
	$­p_bË_wake_cÚfigu»
()

222 
tBSA_BLE_WAKE_CFG
 
b§_bË_wake_cfg
;

223 
tBSA_BLE_WAKE_ENABLE
 
b§_bË_wake_’abË
;

224 
tBSA_STATUS
 
b§_¡©us
;

225 
tBSA_TM_VSC
 
b§_vsc
;

226 
mªu_·‰”n
[] = "WAKEUP";

228 
b§_¡©us
 = 
	`BSA_BËWakeCfgIn™
(&
b§_bË_wake_cfg
);

230 
b§_bË_wake_cfg
.
cÚd
.
mªu_d©a
.
com·ny_id
 = 
APP_BLE_PF_MANU_DATA_CO_ID
;

231 
	`memıy
(
b§_bË_wake_cfg
.
cÚd
.
mªu_d©a
.
·‰”n
, 
mªu_·‰”n
,(manu_pattern));

232 
b§_bË_wake_cfg
.
cÚd
.
mªu_d©a
.
d©a_Ën
 = (
mªu_·‰”n
) - 1;

233 
b§_bË_wake_cfg
.
cÚd_ty³
 = 
APP_BLE_PF_MANU_DATA_COND_TYPE
;

235 
b§_¡©us
 = 
	`BSA_BËWakeCfg
(&
b§_bË_wake_cfg
);

236 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

238 
	`APP_ERROR1
("BSA_BËWakeCfg faed stus:%d", 
b§_¡©us
);

242 
b§_¡©us
 = 
	`BSA_BËWakeEÇbËIn™
(&
b§_bË_wake_’abË
);

243 
b§_bË_wake_’abË
.
’abË
 = 
TRUE
;

244 
b§_¡©us
 = 
	`BSA_BËWakeEÇbË
(&
b§_bË_wake_’abË
);

245 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

247 
	`APP_ERROR1
("BSA_BËWakçed stus:%d", 
b§_¡©us
);

251 
b§_¡©us
 = 
	`BSA_TmVscIn™
(&
b§_vsc
);

252 
b§_vsc
.
İcode
 = 
APP_BLE_ENABLE_WAKE_GPIO_VSC
;

253 
b§_vsc
.
Ëngth
 = 1;

254 
b§_vsc
.
d©a
[0] = 1;

256 
b§_¡©us
 = 
	`BSA_TmVsc
(&
b§_vsc
);

257 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

259 
	`APP_ERROR1
("UÇbËØS’d EÇbË WakÚ BLE GPIO VSC stus:%d", 
b§_¡©us
);

264 
	}
}

	@source/app_ble_server.c

11 
	~<fú.h
>

12 
	~<sys/ty³s.h
>

13 
	~<sys/¡©.h
>

14 
	~<uni¡d.h
>

15 
	~<ùy³.h
>

16 
	~<±h»ad.h
>

17 
	~"btm_­i.h
"

18 
	~"­p_bË.h
"

19 
	~"­p_disc.h
"

20 
	~"­p_dm.h
"

21 
	~"­p_mgt.h
"

22 
	~"­p_uts.h
"

23 
	~"­p_xml_uts.h
"

25 
	~"­p_bË_£rv”.h
"

27 
	#APP_BLE_SERVICE_NUM
 1

	)

29 #iâdeà
BLUETOOTH_HILINK_SUPPORT


30 
	#APP_BLE_ADV_VALUE_LEN
 6

	)

31 
	#APP_BLE_ADV_CONF_UUID_VAL
 0x1800

32 
	#APP_BLE_ADV_CONF_IS_SCAN_RSP
 0

34 

	)

35 
	#APP_BLE_SERVICE_IS_PRIMARY
 1

36 
	#APP_BLE_SENDIND_NEED_CONFIRM
 1

37 

	)

38 
	#APP_BLE_UNBOND_END
 "unbondEnd"

39 

	)

40 #ifdeà
BLUETOOTH_HILINK_SUPPORT


41 cÚ¡ 
UINT8
 
	gHILINK_SERVICE_SUM
 = 2;

42 
	g©Œ_id_num
[] = {0, 0, 0};

44 
	g©Œ_id_num
[] = {0};

45 
	#APP_BLE_SERVICE_NUM_HANDLE
 11

	)

48 
UINT8
 
	gSERVICE_UUID128
[
MAX_UUID_SIZE
] = {0x86, 0xBC, 0xFA, 0xF4, 0xD0, 0x50, 0x05, 0xA4, 0x86, 0x45, 0x4B, 0xD6, 0x03, 0xCF, 0x9E, 0xCE};

50 
UINT8
 
	gCHAR_UUID128
[
MAX_UUID_SIZE
] = {0x7D, 0x57, 0x18, 0x0B, 0x3C, 0x7B, 0xC8, 0xB0, 0x6D, 0x4B, 0x21, 0x55, 0x1D, 0xD9, 0xAB, 0x1F};

52 
	#APP_BLE_REGISTER_UUID
 0xabcd

	)

56 (*
mWr™eReque¡Cback
)(*
addr
, 
cÚn_id
, *
d©a
, 
size
èğ
NULL
;

57 (*
mCÚÃùiÚS‹Chªge
)(*
add
, 
¡©e
èğ
NULL
;

58 #ifdeà
BLUETOOTH_HILINK_SUPPORT


59 (*
mHškCÚÃùiÚS‹Chªge
)(*
addr
, 
lšk_¡©e
, 
cÚ_id
, 
£rv”_num
èğ
NULL
;

60 (*
mHškBLEWr™eReque¡Cback
)(
£rv”_no
, *
addr
, 
cÚn_id
, *
d©a
, 
size
èğ
NULL
;

62 
tBSA_BLE_CBACK
 *
ohos_ev’t_cback
 = 
NULL
;

66 
	`­p_mgr_g‘_bËName
(*
Çme
);

67 
	$£tBTVisib™y
(
_BoŞ
 
discov”abË
, _BoŞ 
cÚÃùabË
) {

68 
	`­p_dm_£t_bË_visib™y
(
discov”abË
, 
cÚÃùabË
);

69 
	}
}

85 
	$­p_bË_£rv”_fšd_ä“_£rv”
() {

86 
šdex
;

88 
šdex
 = 0; index < 
BSA_BLE_SERVER_MAX
; index++) {

89 ià(!
­p_bË_cb
.
bË_£rv”
[
šdex
].
’abËd
) {

90  
šdex
;

94 
	}
}

107 
	$­p_bË_£rv”_fšd_ä“_©Œ
(
UINT16
 
£rv”
) {

108 
šdex
;

110 
šdex
 = 0; index < 
BSA_BLE_ATTRIBUTE_MAX
; index++) {

111 ià(!
­p_bË_cb
.
bË_£rv”
[
£rv”
].
©Œ
[
šdex
].
©Œ_UUID
.
uu
.
uuid16
) {

112  
šdex
;

116 
	}
}

129 
	$­p_bË_£rv”_di¥Ïy
() {

130 
šdex
, 
©Œ_num
;

132 
	`APP_INFO0
("*************** BLE SERVER LIST *****************");

133 
šdex
 = 0; index < 
BSA_BLE_SERVER_MAX
; index++) {

134 ià(
­p_bË_cb
.
bË_£rv”
[
šdex
].
’abËd
) {

135 
	`APP_INFO1
("%d:BLE S”v” s”v”_if:%d", 
šdex
,

136 
­p_bË_cb
.
bË_£rv”
[
šdex
].
£rv”_if
);

137 
©Œ_num
 = 0;‡‰r_num < 
BSA_BLE_ATTRIBUTE_MAX
;‡ttr_num++) {

138 ià(
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_UUID
.
uu
.
uuid16
) {

139 ià((
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_ty³
 =ğ
BSA_GATTC_ATTR_TYPE_SRVC
) ||

140 (
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_ty³
 =ğ
BSA_GATTC_ATTR_TYPE_INCL_SRVC
)) {

141 
	`APP_INFO1
("\t‡ttr_num:%d:uuid:0x%04x, is_pri:%d, service_id:%d‡ttr_id:%d",

142 
©Œ_num
,

143 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_UUID
.
uu
.
uuid16
,

144 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
is_´i
,

145 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
£rviû_id
,

146 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_id
);

148 
	`APP_INFO1
("\t\t‡ttr_num:%d:uuid:0x%04x, is_pri:%d, service_id:%d‡ttr_id:%d",

149 
©Œ_num
,

150 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_UUID
.
uu
.
uuid16
,

151 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
is_´i
,

152 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
£rviû_id
,

153 
­p_bË_cb
.
bË_£rv”
[
šdex
].
©Œ
[
©Œ_num
].
©Œ_id
);

159 
	`APP_INFO0
("*************** BLE SERVER LIST END *************");

160 
	}
}

173 
	$­p_bË_£rv”_fšd_»g_³ndšg_šdex
() {

174 
šdex
;

176 
šdex
 = 0; index < 
BSA_BLE_SERVER_MAX
; index++) {

177 ià((
­p_bË_cb
.
bË_£rv”
[
šdex
].
’abËd
) &&

178 (
­p_bË_cb
.
bË_£rv”
[
šdex
].
£rv”_if
 =ğ
BSA_BLE_INVALID_IF
)) {

179  
šdex
;

183 
	}
}

196 
	$­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
tBSA_BLE_IF
 
if_num
) {

197 
šdex
;

199 
šdex
 = 0; index < 
BSA_BLE_SERVER_MAX
; index++) {

200 ià(
­p_bË_cb
.
bË_£rv”
[
šdex
].
£rv”_if
 =ğ
if_num
) {

201  
šdex
;

205 
	}
}

218 
	$­p_bË_£rv”_fšd_šdex_by_cÚn_id
(
UINT16
 
cÚn_id
) {

219 
šdex
;

221 
šdex
 = 0; index < 
BSA_BLE_CLIENT_MAX
; index++) {

222 ià(
­p_bË_cb
.
bË_£rv”
[
šdex
].
cÚn_id
 == conn_id) {

223  
šdex
;

227 
	}
}

229 
	$´štDumpInfo
(cÚ¡ *
t™Ë
, cÚ¡ *
buf
, 
size
) {

230 
j
, 
i
, 
k
;

231 
´tšfo
[512], 
´2
[256];

233 
	`APP_INFO1
(" -%s-size=%d--- -¡¬t-------", 
t™Ë
, 
size
);

234 
k
 = 
i
 = 0; i < 
size
; k++) {

235 
´tšfo
[0] = 0;

236 
´2
[0] = 0;

237 
j
 = 0; (
i
 < 
size
 && j < 16); j++, i++) {

238 
	`¥rštf
(
´2
 + 
j
, "%c", 
	`isg¿ph
(
buf
[
i
]) ? buf[i] : ' ');

239 
	`¥rštf
(
´tšfo
 + 
	`¡¾’
Õ¹šfo), "%02X, ", (()
buf
[
i
]) & 0xff);

241 
	`APP_INFO1
("%3x| % -- %s", 
k
, 
´tšfo
, 
´2
);

243 
	`APP_INFO1
(" -%s-size=%d--’d----------", 
t™Ë
, 
size
);

244 
	}
}

246 
	$­p_bË_£rv”_»gi¡”
(
UINT16
 
uuid
, 
tBSA_BLE_CBACK
 *
p_cback
) {

247 
tBSA_STATUS
 
¡©us
;

248 
tBSA_BLE_SE_REGISTER
 
bË_»gi¡”_·¿m
;

249 
£rv”_num
;

250 
idx
;

251 
£rv”_num
 = 
	`­p_bË_£rv”_fšd_ä“_£rv”
();

252 ià(
£rv”_num
 < 0) {

253 
	`APP_ERROR0
("No more spaces!!");

256 
	`APP_INFO1
("Regi¡”‡µ UUIDÓg. 0x%04x)", 
uuid
);

257 ià(!
uuid
) {

258 
uuid
 = 
APP_BLE_REGISTER_UUID
;

261 
¡©us
 = 
	`BSA_BËSeAµRegi¡”In™
(&
bË_»gi¡”_·¿m
);

262 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

263 
	`APP_ERROR1
("BSA_BËSeAµRegi¡”In™ faed stu ğ%d", 
¡©us
);

267 
bË_»gi¡”_·¿m
.
uuid
.
Ën
 = 2;

268 
bË_»gi¡”_·¿m
.
uuid
.
uu
.
uuid16
 = uuid;

269 if(
p_cback
 !ğ
NULL
)

270 
ohos_ev’t_cback
 = 
p_cback
;

271 
bË_»gi¡”_·¿m
.
p_cback
 = 
­p_bË_£rv”_´ofe_cback
;

277 
bË_»gi¡”_·¿m
.
£c_aù
 = 
BTM_BLE_SEC_NONE
;

278 
¡©us
 = 
	`BSA_BËSeAµRegi¡”
(&
bË_»gi¡”_·¿m
);

279 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

280 
	`APP_ERROR1
("BSA_BËSeAµRegi¡” faed stu ğ%d", 
¡©us
);

283 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
’abËd
 = 
TRUE
;

284 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
£rv”_if
 = 
bË_»gi¡”_·¿m
.server_if;

285 
	`APP_INFO1
("idx:%d,£rv”_num:%d,’abËd:%d, s”v”_if:%d,cÚn_id:%d", 
idx
, 
£rv”_num
, 
­p_bË_cb
.
bË_£rv”
[£rv”_num].
’abËd
,

286 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
£rv”_if
,

287 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
cÚn_id
);

289 
	}
}

301 
	$­p_bË_£rv”_d”egi¡”
() {

302 
tBSA_STATUS
 
¡©us
;

303 
tBSA_BLE_SE_DEREGISTER
 
bË_d”egi¡”_·¿m
;

304 
num
;

306 
	`APP_INFO0
("Bluetooth BLE deregister menu:");

307 
	`APP_INFO0
("Select Server:");

308 
	`­p_bË_£rv”_di¥Ïy
();

309 
num
 = 
	`­p_g‘_choiû
("Select");

310 ià((
num
 < 0è|| (num >ğ
BSA_BLE_SERVER_MAX
)) {

311 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
num
);

314 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
’abËd
 !ğ
TRUE
) {

315 
	`APP_ERROR1
("S”v” wa nÙ„egi¡”ed! = %d", 
num
);

319 
¡©us
 = 
	`BSA_BËSeAµD”egi¡”In™
(&
bË_d”egi¡”_·¿m
);

320 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

321 
	`APP_ERROR1
("BSA_BËSeAµD”egi¡”In™ faed stu ğ%d", 
¡©us
);

325 
bË_d”egi¡”_·¿m
.
£rv”_if
 = 
­p_bË_cb
.
bË_£rv”
[
num
].server_if;

327 
¡©us
 = 
	`BSA_BËSeAµD”egi¡”
(&
bË_d”egi¡”_·¿m
);

328 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

329 
	`APP_ERROR1
("BSA_BËSeAµD”egi¡” faed stu ğ%d", 
¡©us
);

334 
	}
}

347 
	$­p_bË_£rv”_ü—‹_£rviû
(
£rv”_num
, 
UINT8
* 
£rviû_uuid
, 
boŞ
 
is_´im¬y
, 
numb”
) {

348 
tBSA_STATUS
 
¡©us
;

349 
tBSA_BLE_SE_CREATE
 
bË_ü—‹_·¿m
;

350 
©Œ_num
;

352 ià((
£rv”_num
 < 0è|| (£rv”_num >ğ
BSA_BLE_SERVER_MAX
)) {

353 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
£rv”_num
);

356 ià(
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
’abËd
 !ğ
TRUE
) {

357 
	`APP_ERROR1
("S”v” wa nÙƒÇbËd! = %d", 
£rv”_num
);

360 ià(!
numb”
)

362 
	`APP_ERROR1
("wrÚg v®uğ%d", 
numb”
);

365 ià(!(
is_´im¬y
 == 0) && !(is_primary == 1))

367 
	`APP_ERROR1
("wrÚg v®uğ%d", 
is_´im¬y
);

378 
©Œ_num
 = 
	`­p_bË_£rv”_fšd_ä“_©Œ
(
£rv”_num
);

379 ià(
©Œ_num
 < 0) {

380 
	`APP_ERROR1
("WrÚg‡‰¸numb”! = %d", 
©Œ_num
);

383 
¡©us
 = 
	`BSA_BËSeC»©eS”viûIn™
(&
bË_ü—‹_·¿m
);

384 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

385 
	`APP_ERROR1
("BSA_BËSeC»©eS”viûIn™ faed stu ğ%d", 
¡©us
);

389 
šdex
;

390 
šdex
 = 0; index < 
MAX_UUID_SIZE
; index++) {

391 
bË_ü—‹_·¿m
.
£rviû_uuid
.
uu
.
uuid128
[
šdex
] = service_uuid[index];

393 
bË_ü—‹_·¿m
.
£rviû_uuid
.
Ën
 = 
MAX_UUID_SIZE
;

394 
bË_ü—‹_·¿m
.
£rv”_if
 = 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].server_if;

395 
bË_ü—‹_·¿m
.
num_hªdË
 = 
numb”
;

397 if(
is_´im¬y
 != 0) {

398 
bË_ü—‹_·¿m
.
is_´im¬y
 = 
TRUE
;

400 
bË_ü—‹_·¿m
.
is_´im¬y
 = 
FALSE
;

403 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
wa™_æag
 = 
TRUE
;

405 
¡©us
 = 
	`BSA_BËSeC»©eS”viû
(&
bË_ü—‹_·¿m
);

406 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

407 
	`APP_ERROR1
("BSA_BËSeC»©eS”viû faed stu ğ%d", 
¡©us
);

408 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
wa™_æag
 = 
FALSE
;

413 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
©Œ_UUID
.
Ën
 = 
MAX_UUID_SIZE
;

414 
šdex
 = 0; index < 
MAX_UUID_SIZE
; index++) {

415 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
©Œ_UUID
.
uu
.
uuid128
[
šdex
] = 
£rviû_uuid
[index];

417 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
is_´i
 = 
is_´im¬y
;

418 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
©Œ_num
].
©Œ_ty³
 = 
BSA_GATTC_ATTR_TYPE_SRVC
;

420 
	}
}

433 
	$­p_bË_£rv”_add_ch¬
(
£rv”_id
, 
£rv”_num
, 
UINT8
* 
ch¬ac_uuid
, 
´İ”t›s
, 
³rmissiÚs
)

435 
tBSA_STATUS
 
¡©us
;

436 
tBSA_BLE_SE_ADDCHAR
 
bË_addch¬_·¿m
;

437 
¤vc_©Œ_num
, 
ch¬_©Œ_num
;

438 
ch¬aù”i¡ic_´İ”ty
 = 0;

439 
šdex
;

441 
	`´štf
("%s-%d,­p_bË_cb.bË_£rv”[%d].’abËd:%d\n", 
__FUNCTION__
, 
__LINE__
,

442 
£rv”_num
, 
­p_bË_cb
.
bË_£rv”
[£rv”_num].
’abËd
);

443 ià((
£rv”_num
 < 0è|| (£rv”_num >ğ
BSA_BLE_SERVER_MAX
)) {

444 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
£rv”_num
);

447 ià(
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
’abËd
 !ğ
TRUE
) {

448 
	`APP_ERROR1
("S”v” wa nÙƒÇbËd! = %d", 
£rv”_num
);

452 
¤vc_©Œ_num
 = 0;

453 ià(
¤vc_©Œ_num
 < 0) {

454 
	`APP_ERROR0
("app_ble_server_add_char : Invalid srvc_attr_numƒntered");

458 
ch¬_©Œ_num
 = 
	`­p_bË_£rv”_fšd_ä“_©Œ
(
£rv”_num
);

459 
¡©us
 = 
	`BSA_BËSeAddCh¬In™
(&
bË_addch¬_·¿m
);

460 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

461 
	`APP_ERROR1
("BSA_BËSeAddCh¬In™ faed stu ğ%d", 
¡©us
);

464 
bË_addch¬_·¿m
.
£rviû_id
 = 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
¤vc_©Œ_num
].service_id;

465 
bË_addch¬_·¿m
.
ch¬_uuid
.
Ën
 = 
MAX_UUID_SIZE
;

466 
šdex
 = 0; index < 
MAX_UUID_SIZE
; index++) {

467 
bË_addch¬_·¿m
.
ch¬_uuid
.
uu
.
uuid128
[
šdex
] = 
ch¬ac_uuid
[index];

470 
bË_addch¬_·¿m
.
is_desü
 = 
FALSE
;

471 
	`ALOGD
("app_ble_server_add_char set BTA_GATT_PERM_READ | BTA_GATT_PERM_WRITE");

472 
bË_addch¬_·¿m
.
³rm
 = 
³rmissiÚs
;

474 
bË_addch¬_·¿m
.
´İ”ty
 = 
´İ”t›s
;

475 
¡©us
 = 
	`BSA_BËSeAddCh¬
(&
bË_addch¬_·¿m
);

476 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

477 
	`APP_ERROR1
("BSA_BËSeAddCh¬ faed stu ğ%d", 
¡©us
);

481 #ifdeà
BLUETOOTH_HILINK_SUPPORT


482 ià(
£rv”_num
 == 0)

483 
©Œ_id_num
[
i
] = 
ch¬_©Œ_num
;

485 
©Œ_id_num
[
i
 + 2] = 
ch¬_©Œ_num
;

487 
	`ALOGD
("­p_bË_£rv”_add_ch¬ s”v”_num:%d,sum:%d, ch¬_idx:%d,ch¬_©Œ_num:%d", 
£rv”_num
, 
ch¬_sum
, 
i
, 
ch¬_©Œ_num
);

490 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
ch¬_©Œ_num
].
©Œ_UUID
.
Ën
 = 
MAX_UUID_SIZE
;

491 
šdex
 = 0; index < 
MAX_UUID_SIZE
; index++) {

492 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
ch¬_©Œ_num
].
©Œ_UUID
.
uu
.
uuid128
[
šdex
] = 
ch¬ac_uuid
[index];

494 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
ch¬_©Œ_num
].
´İ
 = 
´İ”t›s
;

495 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
ch¬_©Œ_num
].
©Œ_ty³
 = 
BSA_GATTC_ATTR_TYPE_CHAR
;

496 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
©Œ
[
ch¬_©Œ_num
].
wa™_æag
 = 
TRUE
;

499 
	}
}

513 
	$­p_bË_£rv”_¡¬t_£rviû
(
£rv”_id
, 
num
) {

514 
tBSA_STATUS
 
¡©us
;

515 
tBSA_BLE_SE_START
 
bË_¡¬t_·¿m
;

516 
©Œ_num
;

518 ià((
num
 < 0è|| (num >ğ
BSA_BLE_SERVER_MAX
)) {

519 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
num
);

522 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
’abËd
 !ğ
TRUE
) {

523 
	`APP_ERROR1
("S”v” wa nÙƒÇbËd! = %d", 
num
);

526 
©Œ_num
 = 0;

527 ià(
©Œ_num
 < 0) {

528 
	`APP_ERROR0
("app_ble_server_start_service : Invalid‡ttr_numƒntered");

532 
¡©us
 = 
	`BSA_BËSeS¹S”viûIn™
(&
bË_¡¬t_·¿m
);

533 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

534 
	`APP_ERROR1
("BSA_BËSeS¹S”viûIn™ faed stu ğ%d", 
¡©us
);

538 
bË_¡¬t_·¿m
.
£rviû_id
 = 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_num
].service_id;

539 
bË_¡¬t_·¿m
.
sup_Œª¥Üt
 = 
BSA_BLE_GATT_TRANSPORT_LE_BR_EDR
;

541 
	`´štf
("£rviû_id:%d,‚um:%d\n", 
bË_¡¬t_·¿m
.
£rviû_id
, 
num
);

542 
	`APP_INFO1
("£rviû_id:%d,‚um:%d", 
bË_¡¬t_·¿m
.
£rviû_id
, 
num
);

544 
¡©us
 = 
	`BSA_BËSeS¹S”viû
(&
bË_¡¬t_·¿m
);

545 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

546 
	`APP_ERROR1
("BSA_BËSeS¹S”viû faed stu ğ%d", 
¡©us
);

550 
	}
}

562 
UINT32
 
	gbt_£nd_times
 = 0, 
	gbt_£nd_tÙ®s
 = 0;

563 
	$­p_bË_£rv”_£nd_šdiÿtiÚ
(
cÚn_id
, *
šdiÿtiÚ
, 
size
) {

564 ++
bt_£nd_times
;

565 
bt_£nd_tÙ®s
 +ğ
size
;

566 
	`APP_INFO1
("¡¬ˆ­p_bË_£rv”_£nd_šdiÿtiÚ..sizğ%d,imes:%u,Ù®s:%u", 
size
, 
bt_£nd_times
, 
bt_£nd_tÙ®s
);

568 
tBSA_STATUS
 
¡©us
;

569 
tBSA_BLE_SE_SENDIND
 
bË_£ndšd_·¿m
;

570 
num
, 
Ëngth_of_d©a
, 
šdex
, 
©Œ_num
;

573 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_cÚn_id
(
cÚn_id
);

574 ià((
num
 < 0è|| (num >ğ
BSA_BLE_SERVER_MAX
)) {

575 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
num
);

578 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
’abËd
 !ğ
TRUE
) {

579 
	`APP_ERROR1
("S”v” wa nÙƒÇbËd! = %d", 
num
);

582 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
cÚge¡ed
) {

583 
	`APP_ERROR1
("ç : cÚge¡ed(%d)!", 
­p_bË_cb
.
bË_£rv”
[
num
].
cÚge¡ed
);

586 #ifdeà
BLUETOOTH_HILINK_SUPPORT


587 
©Œ_num
 = 1;

590 
©Œ_num
 = 
©Œ_id_num
[0];

594 
¡©us
 = 
	`BSA_BËSeS’dIndIn™
(&
bË_£ndšd_·¿m
);

595 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

596 
	`APP_ERROR1
("BSA_BËSeS’dIndIn™ faed stu ğ%d", 
¡©us
);

599 
	`APP_INFO1
("¡¬ˆ£rv”_num:%d, cÚn_id:%d,‡‰r_num:%d,©Œ_id:%d", 
num
, 
cÚn_id
, 
©Œ_num
, 
­p_bË_cb
.
bË_£rv”
[num].
©Œ
[©Œ_num].
©Œ_id
);

600 
bË_£ndšd_·¿m
.
cÚn_id
 = conn_id;

601 #ifdeà
BLUETOOTH_HILINK_SUPPORT


602 
bË_£ndšd_·¿m
.
©Œ_id
 = 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_num
].attr_id;

604 
bË_£ndšd_·¿m
.
©Œ_id
 = 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_num
].attr_id;

607 
bË_£ndšd_·¿m
.
d©a_Ën
 = 
size
;

609 
	`memıy
(
bË_£ndšd_·¿m
.
v®ue
, 
šdiÿtiÚ
, 
size
);

612 #ià
APP_BLE_SENDIND_NEED_CONFIRM


613 
bË_£ndšd_·¿m
.
Ãed_cÚfœm
 = 
TRUE
;

615 
bË_£ndšd_·¿m
.
Ãed_cÚfœm
 = 
FALSE
;

617 
¡©us
 = 
	`BSA_BËSeS’dInd
(&
bË_£ndšd_·¿m
);

618 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

619 
	`APP_ERROR1
("BSA_BËSeS’dInd faed stu ğ%d", 
¡©us
);

622 
	`APP_INFO0
("end‡pp_ble_server_send_indication..");

624 
	}
}

625 
UINT32
 
	gbt_wr™e_times
 = 0, 
	gbt_wr™e_tÙ®s
 = 0;

635 
	$­p_bË_£rv”_´ofe_cback
(
tBSA_BLE_EVT
 
ev’t
, 
tBSA_BLE_MSG
 *
p_d©a
) {

636 
num
, 
©Œ_šdex
;

637 
¡©us
;

638 
tBSA_BLE_SE_SENDRSP
 
£nd_£rv”_»¥
;

639 
UINT8
 
©Œibu‹_v®ue
[
BSA_BLE_MAX_ATTR_LEN
] = {0x11, 0x22, 0x33, 0x44};

641 
	`APP_DEBUG1
("­p_bË_£rv”_´ofe_cbackƒv’ˆğ%d ", 
ev’t
);

643 
ev’t
) {

644 
BSA_BLE_SE_DEREGISTER_EVT
:

645 
	`APP_INFO1
("BSA_BLE_SE_DEREGISTER_EVT server_if:%d status:%d",

646 
p_d©a
->
£r_d”egi¡”
.
£rv”_if
,…_d©a->£r_d”egi¡”.
¡©us
);

647 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_d”egi¡”
.
£rv”_if
);

648 ià(
num
 < 0) {

649 
	`APP_ERROR0
("no deregister…ending!!");

653 
­p_bË_cb
.
bË_£rv”
[
num
].
£rv”_if
 = 
BSA_BLE_INVALID_IF
;

654 
­p_bË_cb
.
bË_£rv”
[
num
].
’abËd
 = 
FALSE
;

655 
©Œ_šdex
 = 0;‡‰r_šdex < 
BSA_BLE_ATTRIBUTE_MAX
;‡ttr_index++) {

656 
	`mem£t
(&
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
], 0, (
tAPP_BLE_ATTRIBUTE
));

661 
BSA_BLE_SE_CREATE_EVT
:

662 
	`APP_INFO1
("BSA_BLE_SE_CREATE_EVT server_if:%d status:%d service_id:%d",

663 
p_d©a
->
£r_ü—‹
.
£rv”_if
,…_d©a->£r_ü—‹.
¡©us
,…_d©a->£r_ü—‹.
£rviû_id
);

665 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_ü—‹
.
£rv”_if
);

668 ià(
num
 < 0) {

669 
	`APP_ERROR0
("no interface!!");

674 
©Œ_šdex
 = 0;‡‰r_šdex < 
BSA_BLE_ATTRIBUTE_MAX
;‡ttr_index++) {

675 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
wa™_æag
 =ğ
TRUE
) {

676 
	`APP_INFO1
("BSA_BLE_SE_CREATE_EVT if_num:%d,‡‰r_num:%d", 
num
, 
©Œ_šdex
);

677 ià(
p_d©a
->
£r_ü—‹
.
¡©us
 =ğ
BSA_SUCCESS
) {

678 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
£rviû_id
 = 
p_d©a
->
£r_ü—‹
.service_id;

679 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
wa™_æag
 = 
FALSE
;

683 
	`mem£t
(&
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
], 0, (
tAPP_BLE_ATTRIBUTE
));

688 ià(
©Œ_šdex
 >ğ
BSA_BLE_ATTRIBUTE_MAX
) {

689 
	`APP_ERROR0
("BSA_BLE_SE_CREATE_EVT‚o waiting!!");

694 
BSA_BLE_SE_ADDCHAR_EVT
:

695 
	`APP_INFO1
("BSA_BLE_SE_ADDCHAR_EVT stus:%d", 
p_d©a
->
£r_addch¬
.
¡©us
);

696 
	`APP_INFO1
("©Œ_id:0x%x", 
p_d©a
->
£r_addch¬
.
©Œ_id
);

697 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_addch¬
.
£rv”_if
);

700 ià(
num
 < 0) {

701 
	`APP_ERROR0
("no interface!!");

705 
©Œ_šdex
 = 0;‡‰r_šdex < 
BSA_BLE_ATTRIBUTE_MAX
;‡ttr_index++) {

706 ià(
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
wa™_æag
 =ğ
TRUE
) {

708 ià(
p_d©a
->
£r_addch¬
.
¡©us
 =ğ
BSA_SUCCESS
) {

709 
	`APP_INFO1
("£rv”_num:%d,‡‰r_num:%d,£rv”_id:%d,©Œ_id:%d", 
num
, 
©Œ_šdex
, 
p_d©a
->
£r_addch¬
.
£rviû_id
,…_d©a->£r_addch¬.
©Œ_id
);

710 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
£rviû_id
 = 
p_d©a
->
£r_addch¬
.service_id;

711 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
©Œ_id
 = 
p_d©a
->
£r_addch¬
.attr_id;

712 
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
].
wa™_æag
 = 
FALSE
;

716 
	`mem£t
(&
­p_bË_cb
.
bË_£rv”
[
num
].
©Œ
[
©Œ_šdex
], 0, (
tAPP_BLE_ATTRIBUTE
));

721 ià(
©Œ_šdex
 >ğ
BSA_BLE_ATTRIBUTE_MAX
) {

722 
	`APP_ERROR0
("BSA_BLE_SE_ADDCHAR_EVT‚o waiting!!");

727 
BSA_BLE_SE_START_EVT
:

728 
	`APP_INFO1
("BSA_BLE_SE_START_EVT stus:%d", 
p_d©a
->
£r_¡¬t
.
¡©us
);

729 #iâdeà
BLUETOOTH_HILINK_SUPPORT


730 ià(
p_d©a
->
£r_¡¬t
.
¡©us
 =ğ
BSA_SUCCESS
) {

732 
	`­p_bË_cÚfig_adv_d©a
();

737 
BSA_BLE_SE_READ_EVT
:

738 
	`APP_INFO1
("BSA_BLE_SE_READ_EVT stus:%d", 
p_d©a
->
£r_»ad
.
¡©us
);

739 
	`BSA_BËSeS’dR¥In™
(&
£nd_£rv”_»¥
);

740 
£nd_£rv”_»¥
.
cÚn_id
 = 
p_d©a
->
£r_»ad
.conn_id;

741 
£nd_£rv”_»¥
.
Œªs_id
 = 
p_d©a
->
£r_»ad
.trans_id;

742 
£nd_£rv”_»¥
.
¡©us
 = 
p_d©a
->
£r_»ad
.status;

743 
£nd_£rv”_»¥
.
hªdË
 = 
p_d©a
->
£r_»ad
.handle;

744 
£nd_£rv”_»¥
.
off£t
 = 
p_d©a
->
£r_»ad
.offset;

745 
£nd_£rv”_»¥
.
Ën
 = 0;

746 
£nd_£rv”_»¥
.
auth_»q
 = 
GATT_AUTH_REQ_NONE
;

750 
	`APP_INFO1
("BSA_BLE_SE_READ_EVT: s’d_£rv”_»¥.cÚn_id:%d, s’d_£rv”_»¥.Œªs_id:%d", 
£nd_£rv”_»¥
.
cÚn_id
, s’d_£rv”_»¥.
Œªs_id
, s’d_£rv”_»¥.
¡©us
);

751 
	`APP_INFO1
("BSA_BLE_SE_READ_EVT: s’d_£rv”_»¥.¡©us:%d,£nd_£rv”_»¥.auth_»q:%d", 
£nd_£rv”_»¥
.
¡©us
, s’d_£rv”_»¥.
auth_»q
);

752 
	`APP_INFO1
("BSA_BLE_SE_READ_EVT: s’d_£rv”_»¥.hªdË:%d, s’d_£rv”_»¥.off£t:%d, s’d_£rv”_»¥.Ën:%d", 
£nd_£rv”_»¥
.
hªdË
, s’d_£rv”_»¥.
off£t
, s’d_£rv”_»¥.
Ën
);

753 
	`BSA_BËSeS’dR¥
(&
£nd_£rv”_»¥
);

757 
BSA_BLE_SE_WRITE_EVT
:

758 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_cÚn_id
(
p_d©a
->
£r_wr™e
.
cÚn_id
);

759 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s”_wr™e.cÚn_id:%d, s”v”_num:%d", 
p_d©a
->
£r_wr™e
.
cÚn_id
, 
num
);

760 ++
bt_wr™e_times
;

761 
bt_wr™e_tÙ®s
 +ğ
p_d©a
->
£r_wr™e
.
Ën
;

762 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT stus:%d,size:%d,imes:%u,Ù®s:%u", 
p_d©a
->
£r_wr™e
.
¡©us
,

763 
p_d©a
->
£r_wr™e
.
Ën
, 
bt_wr™e_times
, 
bt_wr™e_tÙ®s
);

765 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVTrans_id:%d, conn_id:%d, handle:%d",

766 
p_d©a
->
£r_wr™e
.
Œªs_id
,…_d©a->£r_wr™e.
cÚn_id
,…_d©a->£r_wr™e.
hªdË
);

768 ià(
p_d©a
->
£r_wr™e
.
Ãed_r¥
) {

769 
	`BSA_BËSeS’dR¥In™
(&
£nd_£rv”_»¥
);

770 
£nd_£rv”_»¥
.
cÚn_id
 = 
p_d©a
->
£r_wr™e
.conn_id;

771 
£nd_£rv”_»¥
.
Œªs_id
 = 
p_d©a
->
£r_wr™e
.trans_id;

772 
£nd_£rv”_»¥
.
¡©us
 = 
p_d©a
->
£r_wr™e
.status;

773 
£nd_£rv”_»¥
.
hªdË
 = 
p_d©a
->
£r_wr™e
.handle;

774 
£nd_£rv”_»¥
.
Ën
 = 0;

775 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s’d_£rv”_»¥.cÚn_id:%d, s’d_£rv”_»¥.Œªs_id:%d", 
£nd_£rv”_»¥
.
cÚn_id
, s’d_£rv”_»¥.
Œªs_id
, s’d_£rv”_»¥.
¡©us
);

776 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s’d_£rv”_»¥.¡©us:%d,£nd_£rv”_»¥.auth_»q:%d", 
£nd_£rv”_»¥
.
¡©us
, s’d_£rv”_»¥.
auth_»q
);

777 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s’d_£rv”_»¥.hªdË:%d, s’d_£rv”_»¥.off£t:%d, s’d_£rv”_»¥.Ën:%d", 
£nd_£rv”_»¥
.
hªdË
, s’d_£rv”_»¥.
off£t
, s’d_£rv”_»¥.
Ën
);

778 
	`BSA_BËSeS’dR¥
(&
£nd_£rv”_»¥
);

781 
­p_bË_cb
.
bË_£rv”
[
num
].
cÚn_id
 = 
p_d©a
->
£r_wr™e
.conn_id;

782 
wr™e_addr
[20];

783 
	`¥rštf
(
wr™e_addr
, "%02x:%02x:%02x:%02x:%02x:%02x", 
p_d©a
->
£r_wr™e
.
»mÙe_bda
[0],…_data->ser_write.remote_bda[1],…_data->ser_write.remote_bda[2],…_data->ser_write.remote_bda[3],…_data->ser_write.remote_bda[4],…_data->ser_write.remote_bda[5]);

784 
Ëngth
 = ()(
p_d©a
->
£r_wr™e
.
Ën
);

785 
Ëngth
 =†’gth > 
BLE_DATA_MAX_SIZE
 * 2 ? BLE_DATA_MAX_SIZE * 2 :†ength;

786 
»que¡_v®ue
[
BLE_DATA_MAX_SIZE
 * 2];

787 
	`mem£t
(
»que¡_v®ue
, 0, 
BLE_DATA_MAX_SIZE
 * 2);

788 
	`memıy
(
»que¡_v®ue
, 
p_d©a
->
£r_wr™e
.
v®ue
, 
Ëngth
);

791 #ifdeà
BLUETOOTH_HILINK_SUPPORT


793 ià((
num
 >ğ0è&& (num < 
HILINK_SERVICE_SUM
)) {

794 ià(
mHškBLEWr™eReque¡Cback
 !ğ
NULL
)

795 
	`mHškBLEWr™eReque¡Cback
(
num
, 
wr™e_addr
, 
p_d©a
->
£r_wr™e
.
cÚn_id
, 
»que¡_v®ue
, 
Ëngth
);

798 ià(
mWr™eReque¡Cback
 !ğ
NULL
)

799 
	`mWr™eReque¡Cback
(
wr™e_addr
, 
p_d©a
->
£r_wr™e
.
cÚn_id
, 
»que¡_v®ue
,…_d©a->£r_wr™e.
Ën
);

802 
BSA_BLE_SE_EXEC_WRITE_EVT
:

803 
	`APP_INFO1
("BSA_BLE_SE_EXEC_WRITE_EVT stus:%d", 
p_d©a
->
£r_exec_wr™e
.
¡©us
);

804 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVTrans_id:%d, conn_id:%d,ƒxec_write:%d",

805 
p_d©a
->
£r_exec_wr™e
.
Œªs_id
,…_d©a->£r_exec_wr™e.
cÚn_id
,…_d©a->£r_exec_wr™e.
exec_wr™e
);

807 
	`BSA_BËSeS’dR¥In™
(&
£nd_£rv”_»¥
);

808 
£nd_£rv”_»¥
.
cÚn_id
 = 
p_d©a
->
£r_exec_wr™e
.conn_id;

809 
£nd_£rv”_»¥
.
Œªs_id
 = 
p_d©a
->
£r_exec_wr™e
.trans_id;

810 
£nd_£rv”_»¥
.
¡©us
 = 
p_d©a
->
£r_exec_wr™e
.status;

811 
£nd_£rv”_»¥
.
hªdË
 = 0;

812 
£nd_£rv”_»¥
.
Ën
 = 0;

813 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s’d_£rv”_»¥.cÚn_id:%d, s’d_£rv”_»¥.Œªs_id:%d", 
£nd_£rv”_»¥
.
cÚn_id
, s’d_£rv”_»¥.
Œªs_id
, s’d_£rv”_»¥.
¡©us
);

814 
	`APP_INFO1
("BSA_BLE_SE_WRITE_EVT: s’d_£rv”_»¥.¡©us:%d", 
£nd_£rv”_»¥
.
¡©us
);

815 
	`BSA_BËSeS’dR¥
(&
£nd_£rv”_»¥
);

819 
BSA_BLE_SE_OPEN_EVT
:

820 
	`APP_INFO1
("BSA_BLE_SE_OPEN_EVT stus:%d", 
p_d©a
->
£r_İ’
.
»asÚ
);

821 ià(
p_d©a
->
£r_İ’
.
»asÚ
 =ğ
BSA_SUCCESS
) {

822 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_İ’
.
£rv”_if
);

824 ià(
num
 < 0) {

825 
	`APP_ERROR0
("no interface!!");

828 
	`APP_INFO1
("BSA_BLE_SE_OPEN_EVT cÚn_id:%d,£rv”_if:%d,num:%d", 
p_d©a
->
£r_İ’
.
cÚn_id
,…_d©a->£r_İ’.
£rv”_if
, 
num
);

829 
	`APP_INFO1
("©Œ_num0:%d,©Œ_num1:%d", 
©Œ_id_num
[0],‡ttr_id_num[1]);

830 
­p_bË_cb
.
bË_£rv”
[
num
].
cÚn_id
 = 
p_d©a
->
£r_İ’
.conn_id;

831 
İ’_addr
[20];

832 
	`¥rštf
(
İ’_addr
, "%02x:%02x:%02x:%02x:%02x:%02x", 
p_d©a
->
£r_İ’
.
»mÙe_bda
[0],…_data->ser_open.remote_bda[1],…_data->ser_open.remote_bda[2],…_data->ser_open.remote_bda[3],…_data->ser_open.remote_bda[4],…_data->ser_open.remote_bda[5]);

833 #ifdeà
BLUETOOTH_HILINK_SUPPORT


834 ià((
num
 >ğ0è&& (num < 
HILINK_SERVICE_SUM
)) {

835 ià(
mHškCÚÃùiÚS‹Chªge
 !ğ
NULL
)

836 
	`mHškCÚÃùiÚS‹Chªge
(
İ’_addr
, 1, 
p_d©a
->
£r_İ’
.
cÚn_id
, 
num
);

839 ià(
mCÚÃùiÚS‹Chªge
 !ğ
NULL
)

840 
	`mCÚÃùiÚS‹Chªge
(
İ’_addr
, 1);

842 
	`­p_»ad_xml_»mÙe_deviûs
();

844 
	`­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

845 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
p_d©a
->
£r_İ’
.
»mÙe_bda
,

846 
BSA_BLE_SERVICE_MASK
);

848 
¡©us
 = 
	`­p_wr™e_xml_»mÙe_deviûs
();

849 ià(
¡©us
 < 0) {

850 
	`APP_ERROR1
("­p_bË_wr™e_»mÙe_deviû çed: %d", 
¡©us
);

856 
BSA_BLE_SE_CONGEST_EVT
:

857 
	`APP_INFO1
("BSA_BLE_SE_CONGEST_EVT :conn_id:0x%x, congested:%d",

858 
p_d©a
->
£r_cÚge¡
.
cÚn_id
,…_d©a->£r_cÚge¡.
cÚge¡ed
);

859 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_cÚn_id
(
p_d©a
->
£r_cÚge¡
.
cÚn_id
);

860 ià(
num
 >= 0) {

861 
­p_bË_cb
.
bË_£rv”
[
num
].
cÚge¡ed
 = 
p_d©a
->
£r_cÚge¡
.congested;

865 
BSA_BLE_SE_CLOSE_EVT
:

866 
	`APP_INFO1
("BSA_BLE_SE_CLOSE_EVT stus:%d", 
p_d©a
->
£r_şo£
.
»asÚ
);

867 
	`APP_INFO1
("cÚn_id:0x%x", 
p_d©a
->
£r_şo£
.
cÚn_id
);

868 
num
 = 
	`­p_bË_£rv”_fšd_šdex_by_š‹rçû
(
p_d©a
->
£r_şo£
.
£rv”_if
);

870 ià(
num
 < 0) {

871 
	`APP_ERROR0
("no interface!!");

874 
şo£_addr
[20];

875 
	`¥rštf
(
şo£_addr
, "%02x:%02x:%02x:%02x:%02x:%02x", 
p_d©a
->
£r_şo£
.
»mÙe_bda
[0],…_data->ser_close.remote_bda[1],…_data->ser_close.remote_bda[2],…_data->ser_close.remote_bda[3],…_data->ser_close.remote_bda[4],…_data->ser_close.remote_bda[5]);

876 #ifdeà
BLUETOOTH_HILINK_SUPPORT


877 ià((
num
 >ğ0è&& (num < 
HILINK_SERVICE_SUM
)) {

878 ià(
mHškCÚÃùiÚS‹Chªge
 !ğ
NULL
)

879 
	`mHškCÚÃùiÚS‹Chªge
(
şo£_addr
, 0, 
p_d©a
->
£r_şo£
.
cÚn_id
, 
num
);

882 ià(
mCÚÃùiÚS‹Chªge
 !ğ
NULL
)

883 
	`mCÚÃùiÚS‹Chªge
(
şo£_addr
, 0);

884 
­p_bË_cb
.
bË_£rv”
[
num
].
cÚn_id
 = 
BSA_BLE_INVALID_CONN
;

886 #iâdeà
BLUETOOTH_HILINK_SUPPORT


887 
	`­p_bË_cÚfig_adv_d©a
();

891 
BSA_BLE_SE_CONF_EVT
:

892 
	`APP_INFO1
("BSA_BLE_SE_CONF_EVT stus:%d,cÚn_id:0x%x", 
p_d©a
->
£r_cÚf
.
¡©us
,…_d©a->£r_cÚf.
cÚn_id
);

898 if(
ohos_ev’t_cback
 !ğ
NULL
)

899 
	`ohos_ev’t_cback
(
ev’t
, 
p_d©a
);

900 
	}
}

913 
	$­p_bË_£rv”_İ’
() {

914 
tBSA_STATUS
 
¡©us
;

915 
tBSA_BLE_SE_OPEN
 
bË_İ’_·¿m
;

916 
deviû_šdex
;

917 
BD_ADDR
 
bd_addr
;

918 
£rv”_num
;

919 
dœeù
;

921 
	`APP_INFO0
("Bluetooth BLE connect menu:");

922 
	`APP_INFO0
(" 0 Device from XML database (already…aired)");

923 
	`APP_INFO0
(" 1 Device found in†ast discovery");

924 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select source");

926 ià(
deviû_šdex
 == 0) {

928 
	`­p_»ad_xml_»mÙe_deviûs
();

930 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
,

931 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

932 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

933 ià((
deviû_šdex
 >= 0) &&

934 (
deviû_šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

935 (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
)) {

936 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

938 
	`APP_ERROR1
("Bad Deviû Index:%d\n", 
deviû_šdex
);

944 ià(
deviû_šdex
 == 1) {

945 
	`­p_disc_di¥Ïy_deviûs
();

946 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

947 ià((
deviû_šdex
 >= 0) &&

948 (
deviû_šdex
 < 
APP_DISC_NB_DEVICES
) &&

949 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
)) {

950 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

953 
	`APP_ERROR0
("Bad choice [XML(0) or Disc(1) only]");

957 
	`APP_INFO0
("Select Server:");

958 
	`­p_bË_£rv”_di¥Ïy
();

959 
£rv”_num
 = 
	`­p_g‘_choiû
("Select");

961 ià((
£rv”_num
 < 0) ||

962 (
£rv”_num
 >ğ
BSA_BLE_SERVER_MAX
) ||

963 (
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
’abËd
 =ğ
FALSE
)) {

964 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
£rv”_num
);

968 ià(
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
cÚn_id
 !ğ
BSA_BLE_INVALID_CONN
) {

969 
	`APP_ERROR1
("Connection‡lreadyƒxist, conn_id = %d",

970 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
cÚn_id
);

974 
¡©us
 = 
	`BSA_BËSeCÚÃùIn™
(&
bË_İ’_·¿m
);

975 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

976 
	`APP_ERROR1
("BSA_BËSeCÚÃùIn™ faed stu ğ%d", 
¡©us
);

980 
bË_İ’_·¿m
.
£rv”_if
 = 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].server_if;

981 
dœeù
 = 
	`­p_g‘_choiû
("Direct connection:1, Background connection:0");

982 ià(
dœeù
 == 1) {

983 
bË_İ’_·¿m
.
is_dœeù
 = 
TRUE
;

984 } ià(
dœeù
 == 0) {

985 
bË_İ’_·¿m
.
is_dœeù
 = 
FALSE
;

987 
	`APP_ERROR1
("WrÚg s–eùiÚ! = %d", 
dœeù
);

990 
	`bdıy
(
bË_İ’_·¿m
.
bd_addr
, bd_addr);

992 
¡©us
 = 
	`BSA_BËSeCÚÃù
(&
bË_İ’_·¿m
);

993 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

994 
	`APP_ERROR1
("BSA_BËSeCÚÃù faed stu ğ%d", 
¡©us
);

999 
	}
}

1012 
	$­p_bË_£rv”_şo£
() {

1013 
tBSA_STATUS
 
¡©us
;

1014 
tBSA_BLE_SE_CLOSE
 
bË_şo£_·¿m
;

1015 
£rv”_num
 = 0;

1020 
£rv”_num
 = 0; s”v”_num < 
BSA_BLE_SERVER_MAX
; server_num++) {

1021 ià((
£rv”_num
 < 0) ||

1022 (
£rv”_num
 >ğ
BSA_BLE_SERVER_MAX
) ||

1023 (
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].
’abËd
 =ğ
FALSE
)) {

1024 
	`APP_ERROR1
("WrÚg s”v”‚umb”! = %d", 
£rv”_num
);

1027 
¡©us
 = 
	`BSA_BËSeClo£In™
(&
bË_şo£_·¿m
);

1028 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

1029 
	`APP_ERROR1
("BSA_BËSeClo£In™ faed stu ğ%d", 
¡©us
);

1032 
bË_şo£_·¿m
.
cÚn_id
 = 
­p_bË_cb
.
bË_£rv”
[
£rv”_num
].conn_id;

1033 
¡©us
 = 
	`BSA_BËSeClo£
(&
bË_şo£_·¿m
);

1034 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

1035 
	`APP_ERROR1
("BSA_BËSeClo£ faed stu ğ%d", 
¡©us
);

1040 
	}
}

1058 #iâdeà
BLUETOOTH_HILINK_SUPPORT


1059 
	$­p_bË_cÚfig_adv_d©a
() {

1060 
	`APP_INFO0
("start confighe ble‡dv data..");

1061 
Çme
[50];

1062 
	`mem£t
(
Çme
, 0, 50);

1063 
	`­p_mgr_g‘_bËName
(
Çme
);

1064 
i
;

1065 
tBSA_DM_BLE_ADV_CONFIG
 
adv_cÚf
;

1066 
UINT8
 
­p_bË_adv_v®ue
[
APP_BLE_ADV_VALUE_LEN
] = {0x2b, 0x1a, 0xaa, 0xbb, 0xcc, 0xdd};

1067 
	`mem£t
(&
adv_cÚf
, 0, (
tBSA_DM_BLE_ADV_CONFIG
));

1068 
adv_cÚf
.
Ën
 = 
APP_BLE_ADV_VALUE_LEN
;

1069 
adv_cÚf
.
æag
 = 
BSA_DM_BLE_ADV_FLAG_MASK
;

1071 ià(
	`¡¾’
((*)
Çme
) <= 18) {

1072 
	`memıy
(
adv_cÚf
.
p_v®
, 
­p_bË_adv_v®ue
, 
APP_BLE_ADV_VALUE_LEN
);

1074 
adv_cÚf
.
adv_d©a_mask
 = 
BSA_DM_BLE_AD_BIT_FLAGS
 | 
BSA_DM_BLE_AD_BIT_DEV_NAME
 | 
BSA_DM_BLE_AD_BIT_MANU
;

1076 
adv_cÚf
.
adv_d©a_mask
 = 
BSA_DM_BLE_AD_BIT_FLAGS
 | 
BSA_DM_BLE_AD_BIT_DEV_NAME
;

1078 
adv_cÚf
.
num_£rviû
 = 
APP_BLE_SERVICE_NUM
;

1079 
adv_cÚf
.
uuid_v®
[0] = 
APP_BLE_ADV_CONF_UUID_VAL
;

1080 
adv_cÚf
.
£rviû_d©a_Ën
 = 4 + 16 + 0;

1081 
šdex
;

1082 
šdex
 = 0; index < 
MAX_UUID_SIZE
; index++) {

1083 
adv_cÚf
.
£rviûs_128b
.
uuid128
[
šdex
] = 
SERVICE_UUID128
[index];

1084 
adv_cÚf
.
£rviû_d©a_uuid
.
uu
.
uuid128
[
šdex
] = 
SERVICE_UUID128
[index];

1086 
adv_cÚf
.
is_·¹_£rviû
 = 
TRUE
;

1087 
adv_cÚf
.
is_sÿn_r¥
 = 
APP_BLE_ADV_CONF_IS_SCAN_RSP
;

1089 
	`­p_dm_£t_bË_adv_d©a
(&
adv_cÚf
);

1090 
	`APP_INFO0
("end confighe ble‡dv data..");

1092 
	}
}

1095 
	$­p_mgr_g‘_bË_Çme
(*
bË_Çme
, 
Ën
) {

1096 
¡©us
;

1097 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

1102 
¡©us
 = 
	`BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

1103 
¡©us
 = 
	`BSA_DmG‘CÚfig
(&
bt_cÚfig
);

1104 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

1105 
	`APP_ERROR1
("BSA_DmG‘CÚfig faed:%d", 
¡©us
);

1109 
¡r_Ën
 = 
	`¡¾’
(
bt_cÚfig
.
bË_Çme
);

1110 ià(
¡r_Ën
 < 
Ën
)

1111 
	`¡ºıy
(
bË_Çme
, 
bt_cÚfig
.bË_Çme, 
¡r_Ën
);

1113 
	`¡ºıy
(
bË_Çme
, 
bt_cÚfig
.bË_Çme, 
Ën
);

1114  (
¡r_Ën
 < 
Ën
) ? str_len :†en;

1115 
	}
}

1117 
	$­p_mgr_£t_bË_Çme
(*
bË_Çme
, 
Ën
) {

1118 
¡©us
;

1119 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

1122 
¡©us
 = 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

1123 
bt_cÚfig
.
’abË
 = 
TRUE
;

1124 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_NAME_MASK
;

1125 
	`¡ºıy
(
bt_cÚfig
.
Çme
, 
bË_Çme
, (
BD_NAME
));

1126 
	`¡ºıy
(
bt_cÚfig
.
bË_Çme
, bË_Çme, (
BD_NAME
));

1127 
¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

1128 ià(
¡©us
 !ğ
BSA_SUCCESS
) {

1129 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed:%d", 
¡©us
);

1133 
	}
}

1135 
	$hšk_bË_£rv”_»gi¡”_wr™e_cback
((*
»ûiveWr™eReque¡Cback
)(
£rv”_no
, *
addr
, 
cÚn_id
, *
d©a
, 
size
)) {

1136 
mHškBLEWr™eReque¡Cback
 = 
»ûiveWr™eReque¡Cback
;

1138 
	}
}

1139 
	$hšk_­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
((*
hškOnCÚÃùiÚS‹Chªge
)(*
addr
, 
lšk_¡©e
, 
cÚ_id
, 
£rv”_num
)) {

1140 
mHškCÚÃùiÚS‹Chªge
 = 
hškOnCÚÃùiÚS‹Chªge
;

1141 
	}
}

1144 
	$­p_bË_£rv”_»gi¡”_wr™e_cback
((*
»ûiveWr™eReque¡Cback
)(*
addr
, 
cÚn_id
, *
d©a
, 
size
)) {

1145 
mWr™eReque¡Cback
 = 
»ûiveWr™eReque¡Cback
;

1147 
	}
}

1149 
	$­p_bË_£rv”_»gi¡”_cÚÃù¡©e_cback
((*
ÚCÚÃùiÚS‹Chªge
)(*
add
, 
¡©e
)) {

1150 
mCÚÃùiÚS‹Chªge
 = 
ÚCÚÃùiÚS‹Chªge
;

1151 
	}
}

	@source/app_common/app_disc.c

12 
	~"­p_disc.h
"

14 
	~"b§_­i.h
"

15 
	~"­p_xml_·¿m.h
"

16 
	~"­p_uts.h
"

17 
	~"­p_£rviûs.h
"

18 
	~"­p_uts.h
"

19 
	~"­p_xml_uts.h
"

21 
	#HCI_EIR_DEVICE_ID_TYPE
 0x10

	)

25 
	mnb_deviûs
;

26 
tBSA_DISC_CBACK
 *
	mp_disc_cback
;

27 } 
	ttAPP_DISC_CB
;

29 
tAPP_DISC_CB
 
	g­p_disc_cb
;

31 
tAPP_DISCOVERY_CB
 
	g­p_discov”y_cb
;

34 
UINT16
 
	mv’dÜ
;

35 
UINT16
 
	mv’dÜ_id_sourû
;

36 } 
	ttAPP_VENDOR
;

38 
	#APP_VENDOR_APPLE_COUNT
 2

	)

39 
	#VENDOR_SOURCE_BT
 1

	)

40 
	#VENDOR_SOURCE_USB
 2

	)

41 
tAPP_VENDOR
 
	g­p_v’dÜ_­¶e
[
APP_VENDOR_APPLE_COUNT
] =

43 {76, 
VENDOR_SOURCE_BT
},

44 {1452, 
VENDOR_SOURCE_USB
}

52 
UINT16
 
	muuid
;

53 *
	mdesc
;

54 } 
	ttAPP_DISC_UUID16_DESC
;

55 
	#X
(
uuid
, 
desc
è{uuid, desc},

	)

56 
tAPP_DISC_UUID16_DESC
 
	guuid16_desc
[]=

58 
	~"­p_uuid16_desc.txt
"

60 #undeà
X


67 
UINT16
 
	mkey
;

68 *
	mdesc
;

69 *
	msub_desc
;

70 } 
	ttAPP_DISC_APPEARANCE_DESC
;

71 
	#X
(
key
, 
desc
, 
sub_desc
è{key, desc, sub_desc},

	)

72 
tAPP_DISC_APPEARANCE_DESC
 
	gbË_­³¬ªû_desc
[]=

74 
	~"­p_bË_­³¬ªû.txt
"

76 #undeà
X


83 
UINT16
 
	mid
;

84 *
	mÇme
;

85 } 
	ttAPP_DISC_BT_COMPANY_ID_DESC
;

86 
	#X
(
id
, 
Çme
è{id,‚ame},

	)

87 
tAPP_DISC_BT_COMPANY_ID_DESC
 
	gbt_com·ny_id
[]=

89 
	~"­p_bt_com·ny_id.txt
"

91 #undeà
X


94 
UINT8
 
­p_g‘_dev_¶©fÜm
(
UINT16
 
v’dÜ
, UINT16 
v’dÜ_id_sourû
);

105 
	$­p_disc_di¥Ïy_deviûs
()

107 
šdex
;

109 
šdex
 = 0; index < 
APP_DISC_NB_DEVICES
; index++)

111 ià(
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 !ğ
FALSE
)

113 
	`APP_INFO1
("Dev:%d", 
šdex
);

114 
	`APP_INFO1
("\tBdaddr:%02x:%02x:%02x:%02x:%02x:%02x",

115 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[0],

116 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[1],

117 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[2],

118 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[3],

119 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[4],

120 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
[5]);

121 
	`APP_INFO1
("\tName:%s", 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
Çme
);

122 
	`APP_INFO1
("\tClassOfDevice:%02x:%02x:%02x => %s",

123 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[0],

124 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[1],

125 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
[2],

126 
	`­p_g‘_cod_¡ršg
(

127 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
şass_of_deviû
));

128 
	`APP_INFO1
("\tRssi:%d", 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
rssi
);

129 ià(
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
eœ_vid_pid
[0].
v®id
)

131 
	`APP_INFO1
("\tVidSrc:%d Vid:0x%04X Pid:0x%04X Version:0x%04X",

132 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
eœ_vid_pid
[0].
v’dÜ_id_sourû
,

133 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
eœ_vid_pid
[0].
v’dÜ
,

134 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
eœ_vid_pid
[0].
´oduù
,

135 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
eœ_vid_pid
[0].
v”siÚ
);

139 
	}
}

151 
	$­p_¡ºÿt
(*
p_de¡
, 
de¡_size
, 
šdex
, *
p_¤c
)

153 *
p_d
;

154 *
p_s
;

157 ià((
de¡_size
 < 
šdex
) || (dest_size < 0) || (index < 0))

159 
	`APP_ERROR1
("­p_disc_¡ºÿˆERROR index %d ouˆoà¿ng%d", 
šdex
, 
de¡_size
);

164 
p_d
 = 
p_de¡
 + 
šdex
;

165 
p_s
 = 
p_¤c
;

166 (*
p_s
 !ğ'\0'è&& ((
p_d
 - 
p_de¡
è< 
de¡_size
))

168 *
p_d
++ = *
p_s
++;

172 ià((
p_d
 - 
p_de¡
è>ğ
de¡_size
)

175 
p_d
 = 
p_de¡
 + 
de¡_size
 - 1;

177 *
p_d
 = '\0';

180  
p_d
 - 
p_de¡
;

181 
	}
}

192 
	$­p_disc_·r£_eœ_æags
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

194 
bufãr
[200];

196 
	`¢´štf
(
bufãr
, (bufãr), "\ˆ FÏgs:0x%x [", *
p_eœ
);

197 ià(*
p_eœ
 & 
BSA_DM_BLE_LIMIT_DISC_FLAG
)

198 
	`¡ºÿt
(
bufãr
, "LE_Limited ", (buffer));

199 ià(*
p_eœ
 & 
BSA_DM_BLE_GEN_DISC_FLAG
)

200 
	`¡ºÿt
(
bufãr
, "LE_General ", (buffer));

201 ià(*
p_eœ
 & 
BSA_DM_BLE_BREDR_NOT_SPT
)

202 
	`¡ºÿt
(
bufãr
, "No_BR/EDR ", (buffer));

203 ià(*
p_eœ
 & 
BTA_BLE_DMT_CONTROLLER_SPT
)

204 
	`¡ºÿt
(
bufãr
, "Controller_LE/BR/EDR ", (buffer));

205 ià(*
p_eœ
 & 
BTA_BLE_DMT_HOST_SPT
)

206 
	`¡ºÿt
(
bufãr
, "Host_LE/BR/EDR", (buffer));

207 
	`¡ºÿt
(
bufãr
, "]", (buffer));

208 
bufãr
[(buffer) - 1] = '\0';

209 
	`APP_INFO1
("%s", 
bufãr
);

210 
	}
}

221 *
	$­p_disc_g‘_uuid16_desc
(
UINT16
 
uuid16
)

223 
šdex
;

224 
max
 = (
uuid16_desc
) / (uuid16_desc[0]);

225 
tAPP_DISC_UUID16_DESC
 *
p_uuid16_desc
 = 
uuid16_desc
;

227 
šdex
 = 0 ; index < 
max
 ; index++, 
p_uuid16_desc
++)

229 ià(
p_uuid16_desc
->
uuid
 =ğ
uuid16
)

231  
p_uuid16_desc
->
desc
;

234  
NULL
;

235 
	}
}

246 
	$­p_disc_·r£_eœ_uuid16
(*
p_ty³
, 
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

248 
UINT16
 
uuid16
;

249 *
p_desc
;

251 
	`APP_INFO1
("\ˆ % [UUID16]:", 
p_ty³
);

252 
d©a_Ëngth
 >ğ(
UINT16
))

254 
	`STREAM_TO_UINT16
(
uuid16
, 
p_eœ
);

255 
d©a_Ëngth
 -ğ(
UINT16
);

256 
p_desc
 = 
	`­p_disc_g‘_uuid16_desc
(
uuid16
);

257 ià(
p_desc
 !ğ
NULL
)

259 
	`APP_INFO1
("\ˆ 0x%04X [%s]", 
uuid16
, 
p_desc
);

263 
	`APP_INFO1
("\ˆ 0x%04X [Unknown]", 
uuid16
, 
p_desc
);

266 
	}
}

277 
	$­p_disc_·r£_eœ_uuid32
(*
p_ty³
, 
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

279 
UINT32
 
uuid32
;

281 
	`APP_INFO1
("\ˆ % [UUID32]:", 
p_ty³
);

282 
d©a_Ëngth
 >ğ(
UINT32
))

284 
	`STREAM_TO_UINT32
(
uuid32
, 
p_eœ
);

285 
d©a_Ëngth
 -ğ(
UINT32
);

286 
	`APP_INFO1
("\ˆ 0x%08X", 
uuid32
);

288 
	}
}

299 
	$­p_disc_·r£_eœ_uuid128
(*
p_ty³
, 
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

301 
bufãr
[200];

302 
UINT8
 
uuid128
[
MAX_UUID_SIZE
];

304 
	`mem£t
(
bufãr
, 0, (buffer));

305 
	`APP_INFO1
("\ˆ % [UUID128]:", 
p_ty³
);

306 
d©a_Ëngth
 >ğ(
UINT32
))

308 
	`STREAM_TO_ARRAY
(
uuid128
, 
p_eœ
, 
MAX_UUID_SIZE
);

309 
d©a_Ëngth
 -ğ
MAX_UUID_SIZE
;

310 
	`¢´štf
(
bufãr
, (buffer),

312 
uuid128
[0], uuid128[1], uuid128[2], uuid128[3],

313 
uuid128
[4], uuid128[5], uuid128[6], uuid128[7],

314 
uuid128
[8], uuid128[9], uuid128[10], uuid128[11],

315 
uuid128
[12], uuid128[13], uuid128[14], uuid128[15]);

316 
	`APP_INFO1
("%s", 
bufãr
);

318 
	}
}

329 
	$­p_disc_·r£_eœ_bË_­³¬ªû
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

331 
UINT16
 
key
;

332 
šdex
;

333 
tAPP_DISC_APPEARANCE_DESC
 *
p_­³¬ªû_desc
;

334 
max
 = (
bË_­³¬ªû_desc
) / (ble_appearance_desc[0]);

336 
	`STREAM_TO_UINT16
(
key
, 
p_eœ
);

338 
p_­³¬ªû_desc
 = 
bË_­³¬ªû_desc
;

339 
šdex
 = 0 ; index < 
max
 ; index++, 
p_­³¬ªû_desc
++)

341 ià(
p_­³¬ªû_desc
->
key
 == key)

346 ià(
šdex
 >ğ
max
)

348 
	`APP_INFO1
("\ˆ BLE Aµ—¿nû:0x%04X [Unknown]", 
key
);

352 
	`APP_INFO1
("\ˆ BLE Aµ—¿nû:0x%04X [% - %s]", 
key
,

353 
p_­³¬ªû_desc
->
desc
,…_­³¬ªû_desc->
sub_desc
);

354 
	}
}

365 
	$­p_disc_·r£_eœ_Çme
(*
p_ty³
, 
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

367 
bufãr
[200];

368 
pos
;

370 
	`mem£t
(
bufãr
, 0, (buffer));

371 
pos
 = 
	`¢´štf
(
bufãr
, (bufãr), "\ˆ %s: ", 
p_ty³
);

373 (
pos
 < (
bufãr
)) &&

374 (
d©a_Ëngth
 > 0))

376 
bufãr
[
pos
++] = *
p_eœ
++;

377 
d©a_Ëngth
--;

379 
bufãr
[(buffer) - 1] = '\0';

381 
	`APP_INFO1
("%s", 
bufãr
);

382 
	}
}

394 
	$­p_disc_·r£_eœ_tx_pow”
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

396 
pow”
 = ()*
p_eœ
;

397 
	`APP_INFO1
("\ˆ TxPow”:%d dB", 
pow”
);

398 
	}
}

409 
	$­p_disc_·r£_eœ_3d
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

411 
UINT8
 
æags
;

412 
UINT8
 
·th_loss_th»shŞd
;

414 
	`STREAM_TO_UINT8
(
æags
, 
p_eœ
);

415 
	`STREAM_TO_UINT8
(
·th_loss_th»shŞd
, 
p_eœ
);

417 
	`APP_INFO1
("\ˆ 3D Sync: FÏgs:0x%02x P©hLossTh»shŞd:%ddBm", 
æags
, 
·th_loss_th»shŞd
);

418 
	}
}

429 
	$­p_disc_·r£_eœ_mªuf_¥ecific
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

431 
UINT16
 
com·ny_id
;

432 
šdex
;

433 
tAPP_DISC_BT_COMPANY_ID_DESC
 *
p_bt_com·ny_id
;

434 
max
 = (
bt_com·ny_id
) / (bt_company_id[0]);

435 
bufãr
[200];

436 
hex_bufãr
[4];

437 
pos
;

438 
UINT8
 
by‹
;

439 
lše_Ëngth
;

441 
	`STREAM_TO_UINT16
(
com·ny_id
, 
p_eœ
);

442 
d©a_Ëngth
 -ğ(
UINT16
);

444 
p_bt_com·ny_id
 = 
bt_com·ny_id
;

445 
šdex
 = 0 ; index < 
max
 ; index++, 
p_bt_com·ny_id
++)

447 ià(
p_bt_com·ny_id
->
id
 =ğ
com·ny_id
)

452 ià(
šdex
 >ğ
max
)

454 
	`APP_INFO1
("\ˆ Mªuçùu»¸S³cifiøCom·nyId:0x%04X [Unknown]:", 
com·ny_id
);

458 
	`APP_INFO1
("\ˆ Mªuçùu»¸S³cifiøCom·nyId:0x%04X [%s]:", 
com·ny_id
,

459 
p_bt_com·ny_id
->
Çme
);

462 
d©a_Ëngth
)

465 
pos
 = 
	`¢´štf
(
bufãr
, (buffer), "\t Data: ");

466 ià(
d©a_Ëngth
 > 16)

467 
lše_Ëngth
 = 16;

469 
lše_Ëngth
 = 
d©a_Ëngth
;

470 
šdex
 = 0 ; index < 
lše_Ëngth
 ; index++)

472 
	`STREAM_TO_UINT8
(
by‹
, 
p_eœ
);

473 
d©a_Ëngth
--;

474 
	`¥rštf
(
hex_bufãr
, "%02X ", 
by‹
);

475 
pos
 = 
	`­p_¡ºÿt
(
bufãr
, (bufãr),…os, 
hex_bufãr
);

477 
	`APP_INFO1
("%s", 
bufãr
);

479 
	}
}

490 
	$­p_disc_·r£_eœ_deviû_id
(
UINT8
 *
p_eœ
, UINT8 
d©a_Ëngth
)

492 
UINT16
 
v’dÜ_id_sourû
;

493 
UINT16
 
v’dÜ_id
;

494 
UINT16
 
´oduù_id
;

495 
UINT16
 
v”siÚ
;

496 
šdex
;

497 
tAPP_DISC_BT_COMPANY_ID_DESC
 *
p_bt_com·ny_id
;

498 
max
 = (
bt_com·ny_id
) / (bt_company_id[0]);

500 
	`STREAM_TO_UINT16
(
v’dÜ_id_sourû
, 
p_eœ
);

501 
	`STREAM_TO_UINT16
(
v’dÜ_id
, 
p_eœ
);

502 
	`STREAM_TO_UINT16
(
´oduù_id
, 
p_eœ
);

503 
	`STREAM_TO_UINT16
(
v”siÚ
, 
p_eœ
);

506 ià(
v’dÜ_id_sourû
 == 0x0001)

508 
p_bt_com·ny_id
 = 
bt_com·ny_id
;

509 
šdex
 = 0 ; index < 
max
 ; index++, 
p_bt_com·ny_id
++)

511 ià(
p_bt_com·ny_id
->
id
 =ğ
v’dÜ_id
)

516 ià(
šdex
 >ğ
max
)

518 
	`APP_INFO1
("\ˆ DeviûId: V’dÜId:0x%04X [BT SIG Unknown]", 
v’dÜ_id
);

522 
	`APP_INFO1
("\ˆ DeviûId: V’dÜId:0x%04X [%s]", 
v’dÜ_id
, 
p_bt_com·ny_id
->
Çme
);

524 
	`APP_INFO1
("\ˆ : ProduùId:0x%04X V”siÚ:0x%04X", 
´oduù_id
, 
v”siÚ
);

528 
	`APP_INFO1
("\t DeviceId: VendorId:0x%04X [USB] ProductId:0x%04X Version:0x%04X",

529 
v’dÜ_id
, 
´oduù_id
, 
v”siÚ
);

531 
	}
}

542 
	$­p_disc_·r£_eœ
(
UINT8
 *
p_eœ
)

544 
UINT8
 *
p
 = 
p_eœ
;

545 
UINT8
 
eœ_Ëngth
;

546 
UINT8
 
eœ_g
;

548 
	`APP_INFO0
("\tExtended Information:");

553 
	`STREAM_TO_UINT8
(
eœ_Ëngth
, 
p
);

554 ià(
eœ_Ëngth
 == 0)

558 
eœ_Ëngth
--;

561 
	`STREAM_TO_UINT8
(
eœ_g
, 
p
);

563 
eœ_g
)

565 
HCI_EIR_FLAGS_TYPE
:

566 
	`­p_disc_·r£_eœ_æags
(
p
, 
eœ_Ëngth
);

568 
HCI_EIR_MORE_16BITS_UUID_TYPE
:

569 
	`­p_disc_·r£_eœ_uuid16
("Incom¶‘S”viû", 
p
, 
eœ_Ëngth
);

571 
HCI_EIR_COMPLETE_16BITS_UUID_TYPE
:

572 
	`­p_disc_·r£_eœ_uuid16
("Com¶‘S”viû", 
p
, 
eœ_Ëngth
);

574 
HCI_EIR_MORE_32BITS_UUID_TYPE
:

575 
	`­p_disc_·r£_eœ_uuid32
("Incom¶‘S”viû", 
p
, 
eœ_Ëngth
);

577 
HCI_EIR_COMPLETE_32BITS_UUID_TYPE
:

578 
	`­p_disc_·r£_eœ_uuid32
("Com¶‘S”viû", 
p
, 
eœ_Ëngth
);

580 
HCI_EIR_MORE_128BITS_UUID_TYPE
:

581 
	`­p_disc_·r£_eœ_uuid128
("Incom¶‘S”viû", 
p
, 
eœ_Ëngth
);

583 
HCI_EIR_COMPLETE_128BITS_UUID_TYPE
:

584 
	`­p_disc_·r£_eœ_uuid128
("Com¶‘S”viû", 
p
, 
eœ_Ëngth
);

586 
HCI_EIR_SHORTENED_LOCAL_NAME_TYPE
:

587 
	`­p_disc_·r£_eœ_Çme
("ShÜtName", 
p
, 
eœ_Ëngth
);

589 
HCI_EIR_COMPLETE_LOCAL_NAME_TYPE
:

590 
	`­p_disc_·r£_eœ_Çme
("FuÎName", 
p
, 
eœ_Ëngth
);

592 
HCI_EIR_TX_POWER_LEVEL_TYPE
:

593 
	`­p_disc_·r£_eœ_tx_pow”
(
p
, 
eœ_Ëngth
);

595 
HCI_EIR_3D_SYNC_TYPE
:

596 
	`­p_disc_·r£_eœ_3d
(
p
, 
eœ_Ëngth
);

598 
HCI_EIR_MANUFACTURER_SPECIFIC_TYPE
:

599 
	`­p_disc_·r£_eœ_mªuf_¥ecific
(
p
, 
eœ_Ëngth
);

601 
HCI_EIR_DEVICE_ID_TYPE
:

602 
	`­p_disc_·r£_eœ_deviû_id
(
p
, 
eœ_Ëngth
);

604 
BTM_BLE_AD_TYPE_SERVICE_DATA
:

605 
	`­p_disc_·r£_eœ_uuid16
("BLE S”viû", 
p
, 
eœ_Ëngth
);

607 
BTM_BLE_AD_TYPE_APPEARANCE
:

608 
	`­p_disc_·r£_eœ_bË_­³¬ªû
(
p
, 
eœ_Ëngth
);

611 
	`APP_DUMP
("UnknowÀEIR (Tag‡nd d©a)", 
p
 - 1 , 
eœ_Ëngth
 + 1);

614 
p
 +ğ
eœ_Ëngth
;

616 
	}
}

628 *
	$­p_disc_deviû_ty³_desc
(
UINT8
 
deviû_ty³
)

630 
deviû_ty³
)

632 
BT_DEVICE_TYPE_BREDR
:

634 
BT_DEVICE_TYPE_BLE
:

636 
BT_DEVICE_TYPE_DUMO
:

640 
	}
}

651 *
	$­p_disc_šquœy_ty³_desc
(
UINT8
 
deviû_ty³
)

653 
deviû_ty³
)

655 
BTM_INQ_RESULT_BR
:

657 
BTM_INQ_RESULT_BLE
:

661 
	}
}

672 *
	$­p_disc_add»ss_ty³_desc
(
UINT8
 
deviû_ty³
)

674 
deviû_ty³
)

676 
BLE_ADDR_PUBLIC
:

678 
BLE_ADDR_RANDOM
:

682 
	}
}

693 
	$­p_g’”ic_disc_cback
(
tBSA_DISC_EVT
 
ev’t
, 
tBSA_DISC_MSG
 *
p_d©a
)

695 
šdex
;

698 ià(
­p_disc_cb
.
p_disc_cback
)

700 
­p_disc_cb
.
	`p_disc_cback
(
ev’t
, 
p_d©a
);

703 
ev’t
)

706 
BSA_DISC_NEW_EVT
:

708 
šdex
 = 0; index < 
APP_DISC_NB_DEVICES
; index++)

710 ià((
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 =ğ
TRUE
) &&

711 (!
	`bdcmp
(
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
, 
p_d©a
->
disc_Ãw
.bd_addr)))

714 
	`APP_INFO1
("Upd©deviû:%d", 
šdex
);

715 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
 = 
p_d©a
->
disc_Ãw
;

720 ià(
šdex
 >ğ
APP_DISC_NB_DEVICES
)

723 
šdex
 = 0; index < 
APP_DISC_NB_DEVICES
; index++)

725 ià(
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 =ğ
FALSE
)

727 
	`APP_INFO1
("New Discov”ed deviû:%d", 
šdex
);

728 
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 = 
TRUE
;

729 
	`memıy
(&
­p_discov”y_cb
.
devs
[
šdex
].
deviû
, &
p_d©a
->
disc_Ãw
,

730 (
tBSA_DISC_REMOTE_DEV
));

736 ià(
šdex
 >ğ
APP_DISC_NB_DEVICES
)

738 
	`APP_INFO0
("No„oomo save‚ew discovered");

741 
	`APP_INFO1
("\tBdaddr:%02x:%02x:%02x:%02x:%02x:%02x",

742 
p_d©a
->
disc_Ãw
.
bd_addr
[0],

743 
p_d©a
->
disc_Ãw
.
bd_addr
[1],

744 
p_d©a
->
disc_Ãw
.
bd_addr
[2],

745 
p_d©a
->
disc_Ãw
.
bd_addr
[3],

746 
p_d©a
->
disc_Ãw
.
bd_addr
[4],

747 
p_d©a
->
disc_Ãw
.
bd_addr
[5]);

748 
	`APP_INFO1
("\tName:%s", 
p_d©a
->
disc_Ãw
.
Çme
);

749 
	`APP_INFO1
("\tClassOfDevice:%02x:%02x:%02x => %s",

750 
p_d©a
->
disc_Ãw
.
şass_of_deviû
[0],

751 
p_d©a
->
disc_Ãw
.
şass_of_deviû
[1],

752 
p_d©a
->
disc_Ãw
.
şass_of_deviû
[2],

753 
	`­p_g‘_cod_¡ršg
(
p_d©a
->
disc_Ãw
.
şass_of_deviû
));

754 
	`APP_INFO1
("\tServices:0x%08x (%s)",

755 (è
p_d©a
->
disc_Ãw
.
£rviûs
,

756 
	`­p_£rviû_mask_to_¡ršg
(
p_d©a
->
disc_Ãw
.
£rviûs
));

757 
	`APP_INFO1
("\tRssi:%d", 
p_d©a
->
disc_Ãw
.
rssi
);

758 ià(
p_d©a
->
disc_Ãw
.
eœ_vid_pid
[0].
v®id
)

760 
	`APP_INFO1
("\tVidSrc:%d Vid:0x%04X Pid:0x%04X Version:0x%04X",

761 
p_d©a
->
disc_Ãw
.
eœ_vid_pid
[0].
v’dÜ_id_sourû
,

762 
p_d©a
->
disc_Ãw
.
eœ_vid_pid
[0].
v’dÜ
,

763 
p_d©a
->
disc_Ãw
.
eœ_vid_pid
[0].
´oduù
,

764 
p_d©a
->
disc_Ãw
.
eœ_vid_pid
[0].
v”siÚ
);

767 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

768 
	`APP_INFO1
("\tDeviceType:%s InquiryType:%s AddressType:%s",

769 
	`­p_disc_deviû_ty³_desc
(
p_d©a
->
disc_Ãw
.
deviû_ty³
),

770 
	`­p_disc_šquœy_ty³_desc
(
p_d©a
->
disc_Ãw
.
šq_»suÉ_ty³
),

771 
	`­p_disc_add»ss_ty³_desc
(
p_d©a
->
disc_Ãw
.
bË_addr_ty³
));

774 ià(
p_d©a
->
disc_Ãw
.
eœ_d©a
[0])

776 
	`­p_disc_·r£_eœ
(
p_d©a
->
disc_Ãw
.
eœ_d©a
);

780 
BSA_DISC_CMPL_EVT
:

781 
	`APP_INFO0
("Discovery complete");

782 
­p_disc_cb
.
p_disc_cback
 = 
NULL
;

785 
BSA_DISC_DEV_INFO_EVT
:

786 
	`APP_INFO1
("Discov” Deviû InfØ¡©us:%d", 
p_d©a
->
dev_šfo
.
¡©us
);

787 
	`APP_INFO1
("\tBdaddr:%02x:%02x:%02x:%02x:%02x:%02x",

788 
p_d©a
->
dev_šfo
.
bd_addr
[0],

789 
p_d©a
->
dev_šfo
.
bd_addr
[1],

790 
p_d©a
->
dev_šfo
.
bd_addr
[2],

791 
p_d©a
->
dev_šfo
.
bd_addr
[3],

792 
p_d©a
->
dev_šfo
.
bd_addr
[4],

793 
p_d©a
->
dev_šfo
.
bd_addr
[5]);

794 ià(
p_d©a
->
dev_šfo
.
¡©us
 =ğ
BSA_SUCCESS
)

796 
UINT8
 
dev_¶©fÜm
 = 
	`­p_g‘_dev_¶©fÜm
(
p_d©a
->
dev_šfo
.
v’dÜ
,

797 
p_d©a
->
dev_šfo
.
v’dÜ_id_sourû
);

799 
	`APP_INFO1
("\tDeviû V’dÜIdSourû:0x%x", 
p_d©a
->
dev_šfo
.
v’dÜ_id_sourû
);

800 
	`APP_INFO1
("\tDeviû V’dÜ:0x%x", 
p_d©a
->
dev_šfo
.
v’dÜ
);

801 
	`APP_INFO1
("\tDeviû Produù:0x%x", 
p_d©a
->
dev_šfo
.
´oduù
);

802 
	`APP_INFO1
("\tDeviû V”siÚ:0x%x", 
p_d©a
->
dev_šfo
.
v”siÚ
);

803 
	`APP_INFO1
("\tDeviû S³cId:0x%x", 
p_d©a
->
dev_šfo
.
¥ec_id
);

805 ià(
dev_¶©fÜm
 =ğ
BSA_DEV_PLATFORM_IOS
)

807 
tBSA_SEC_ADD_SI_DEV
 
si_dev
;

808 
	`BSA_SecAddSiDevIn™
(&
si_dev
);

809 
	`bdıy
(
si_dev
.
bd_addr
, 
p_d©a
->
dev_šfo
.bd_addr);

810 
si_dev
.
¶©fÜm
 = 
dev_¶©fÜm
;

811 
	`BSA_SecAddSiDev
(&
si_dev
);

813 
	`­p_xml_upd©e_si_dev_¶©fÜm_db
(
­p_xml_si_deviûs_db
,

814 
	`APP_NUM_ELEMENTS
(
­p_xml_si_deviûs_db
),

815 
p_d©a
->
dev_šfo
.
bd_addr
, 
dev_¶©fÜm
);

816 
	`­p_wr™e_xml_si_deviûs
();

820 
BSA_DISC_REMOTE_NAME_EVT
:

821 
	`APP_INFO1
("BSA_DISC_REMOTE_NAME_EVT (¡©us=%d)", 
p_d©a
->
»mÙe_Çme
.
¡©us
);

822 ià(
p_d©a
->
dev_šfo
.
¡©us
 =ğ
BSA_SUCCESS
)

824 
	`APP_INFO1
("Read device‚ame for %02x:%02x:%02x:%02x:%02x:%02x",

825 
p_d©a
->
»mÙe_Çme
.
bd_addr
[0],…_data->remote_name.bd_addr[1],

826 
p_d©a
->
»mÙe_Çme
.
bd_addr
[2],…_data->remote_name.bd_addr[3],

827 
p_d©a
->
»mÙe_Çme
.
bd_addr
[4],…_data->remote_name.bd_addr[5]);

828 
	`APP_INFO1
("Name:%s", 
p_d©a
->
»mÙe_Çme
.
»mÙe_bd_Çme
);

833 
	`APP_ERROR1
("­p_g’”ic_disc_cback unknowÀev’t:%d", 
ev’t
);

836 
	}
}

847 
	$­p_disc_¡¬t_»guÏr
(
tBSA_DISC_CBACK
 *
p_cu¡om_disc_cback
, 
du¿tiÚ
)

849 
¡©us
;

850 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

852 
	`APP_INFO0
("Start Regular Discovery");

854 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

856 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

857 
disc_¡¬t_·¿m
.
nb_deviûs
 = 
­p_disc_cb
.nb_devices;

858 
disc_¡¬t_·¿m
.
du¿tiÚ
 = duration;

859 
disc_¡¬t_·¿m
.
mode
 = 
BSA_DM_GENERAL_INQUIRY
;

860 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

861 
disc_¡¬t_·¿m
.
mode
 |ğ
BSA_BLE_GENERAL_INQUIRY
;

865 
­p_disc_cb
.
p_disc_cback
 = 
p_cu¡om_disc_cback
;

867 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

869 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

870 ià(
¡©us
 !ğ
BSA_SUCCESS
)

872 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

877 
	}
}

879 #ià((
defšed
 
BLE_INCLUDED
è&& (BLE_INCLUDED =ğ
TRUE
))

889 
	$­p_disc_¡¬t_bË_»guÏr
(
tBSA_DISC_CBACK
 *
p_cu¡om_disc_cback
)

891 
¡©us
;

892 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

894 
	`APP_INFO0
("Start Regular BLE Discovery");

896 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

898 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

899 
disc_¡¬t_·¿m
.
nb_deviûs
 = 
­p_disc_cb
.nb_devices;

900 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 4;

901 
disc_¡¬t_·¿m
.
mode
 = 
BSA_BLE_GENERAL_INQUIRY
;

904 
­p_disc_cb
.
p_disc_cback
 = 
p_cu¡om_disc_cback
;

906 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

908 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

909 ià(
¡©us
 !ğ
BSA_SUCCESS
)

911 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

916 
	}
}

928 
	$­p_disc_¡¬t_£rviûs
(
tBSA_SERVICE_MASK
 
£rviûs
)

930 
¡©us
;

931 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

933 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

935 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

936 
disc_¡¬t_·¿m
.
nb_deviûs
 = 0;

937 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 15;

939 
disc_¡¬t_·¿m
.
£rviûs
 = services;

940 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

942 
	`APP_INFO0
("Start Services filtered Discovery");

943 
	`APP_INFO1
("Look fÜ (%sè£rviûs", 
	`­p_£rviû_mask_to_¡ršg
(
£rviûs
));

944 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

945 ià(
¡©us
 !ğ
BSA_SUCCESS
)

947 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

952 
	}
}

963 
	$­p_disc_¡¬t_cod
(
£rviûs
, 
majÜ
, 
mšÜ
,

964 
tBSA_DISC_CBACK
 *
p_cu¡om_disc_cback
)

966 
¡©us
;

967 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

968 
DEV_CLASS
 
dev_şass
;

969 
DEV_CLASS
 
dev_şass_mask
;

970 
£rviûs_mask
;

971 
majÜ_mask
;

972 
mšÜ_mask
;

974 
	`APP_INFO0
("Start COD filtered Discovery");

975 
	`APP_INFO1
("Look fÜ COD s”viû:%x majÜ:%x mšÜ:%x", 
£rviûs
, 
majÜ
, 
mšÜ
);

977 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

979 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

980 
disc_¡¬t_·¿m
.
nb_deviûs
 = 0;

981 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 4;

982 
disc_¡¬t_·¿m
.
£rviûs
 = 0;

983 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

986 
disc_¡¬t_·¿m
.
f‹r_ty³
 = 
BSA_DM_INQ_DEV_CLASS
;

987 
	`FIELDS_TO_COD
(
dev_şass
, 
mšÜ
, 
majÜ
, 
£rviûs
);

988 
	`APP_INFO1
("COD: 0x%02x 0x%02x 0x%02x", 
dev_şass
[0], dev_class[1],dev_class[2]);

989 
	`memıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
dev_şass_cÚd
.
dev_şass
,

990 
dev_şass
,

991 (
DEV_CLASS
));

996 
£rviûs_mask
 = 
£rviûs
;

999 ià(
majÜ
 != 0)

1000 
majÜ_mask
 = 
BTM_COD_MAJOR_CLASS_MASK
;

1002 
majÜ_mask
 = 0;

1005 ià(
mšÜ
 != 0)

1006 
mšÜ_mask
 = 
BTM_COD_MINOR_CLASS_MASK
;

1008 
mšÜ_mask
 = 0;

1010 
	`FIELDS_TO_COD
(
dev_şass_mask
, 
mšÜ_mask
, 
majÜ_mask
, 
£rviûs_mask
);

1011 
	`APP_INFO1
("COD Mask: 0x%02x 0x%02x 0x%02x", 
dev_şass_mask
[0], dev_class_mask[1],dev_class_mask[2]);

1012 
	`memıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
dev_şass_cÚd
.
dev_şass_mask
,

1013 
dev_şass_mask
,

1014 (
DEV_CLASS
));

1017 
­p_disc_cb
.
p_disc_cback
 = 
p_cu¡om_disc_cback
;

1020 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1021 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1023 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1028 
	}
}

1039 
	$­p_disc_abÜt
()

1041 
tBSA_STATUS
 
¡©us
;

1042 
tBSA_DISC_ABORT
 
disc_abÜt_·¿m
;

1044 
	`APP_INFO0
("Aborting Discovery");

1046 
	`BSA_DiscAbÜtIn™
(&
disc_abÜt_·¿m
);

1047 
¡©us
 = 
	`BSA_DiscAbÜt
(&
disc_abÜt_·¿m
);

1048 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1050 
	`APP_ERROR1
("BSA_DiscAbÜˆçed stus:%d", 
¡©us
);

1054 
	}
}

1066 
	$­p_disc_¡¬t_dev_šfo
(
BD_ADDR
 
bd_addr
, 
tBSA_DISC_CBACK
 *
p_cu¡om_disc_cback
)

1068 
¡©us
;

1069 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1071 
	`APP_INFO1
("Start Device Info Discovery for %02x-%02x-%02x-%02x-%02x-%02x",

1072 
bd_addr
[0], bd_addr[1], bd_addr[2], bd_addr[3],

1073 
bd_addr
[4], bd_addr[5]);

1075 
­p_disc_cb
.
p_disc_cback
 = 
p_cu¡om_disc_cback
;

1077 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1079 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1080 
disc_¡¬t_·¿m
.
deviû_šfo
 = 
TRUE
;

1083 
disc_¡¬t_·¿m
.
f‹r_ty³
 = 
BTA_DM_INQ_BD_ADDR
;

1084 
	`bdıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
bd_addr
, bd_addr);

1087 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1088 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1090 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1095 
	}
}

1106 
	$­p_disc_¡¬t_brcm_f‹r_cod
(
tBSA_DISC_BRCM_FILTER
 
brcm_f‹r
,

1107 
£rviûs
, 
majÜ
, 
mšÜ
,

1108 
tBSA_DISC_CBACK
 *
p_disc_cback
)

1110 
¡©us
;

1111 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1112 
DEV_CLASS
 
dev_şass
;

1113 
DEV_CLASS
 
dev_şass_mask
;

1114 
£rviûs_mask
;

1115 
majÜ_mask
;

1116 
mšÜ_mask
;

1118 
	`APP_INFO0
("Start COD‡nd BRCM-specific filtered Discovery");

1119 
	`APP_INFO1
("Look for COD service:%x major:%x minor:%x‡nd BRCM filter:0x%x",

1120 
£rviûs
, 
majÜ
, 
mšÜ
, 
brcm_f‹r
);

1123 
­p_disc_cb
.
p_disc_cback
 =…_disc_cback;

1125 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1127 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1128 
disc_¡¬t_·¿m
.
nb_deviûs
 = 0;

1129 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 4;

1130 
disc_¡¬t_·¿m
.
£rviûs
 = 0;

1131 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1134 
disc_¡¬t_·¿m
.
brcm_f‹r
 = brcm_filter;

1137 
disc_¡¬t_·¿m
.
f‹r_ty³
 = 
BSA_DM_INQ_DEV_CLASS
;

1138 
	`FIELDS_TO_COD
(
dev_şass
, 
mšÜ
, 
majÜ
, 
£rviûs
);

1139 
	`APP_INFO1
("COD: 0x%02x 0x%02x 0x%02x", 
dev_şass
[0], dev_class[1],dev_class[2]);

1140 
	`memıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
dev_şass_cÚd
.
dev_şass
,

1141 
dev_şass
,

1142 (
DEV_CLASS
));

1147 
£rviûs_mask
 = 
£rviûs
;

1150 ià(
majÜ
 != 0)

1151 
majÜ_mask
 = 
BTM_COD_MAJOR_CLASS_MASK
;

1153 
majÜ_mask
 = 0;

1156 ià(
mšÜ
 != 0)

1157 
mšÜ_mask
 = 
BTM_COD_MINOR_CLASS_MASK
;

1159 
mšÜ_mask
 = 0;

1161 
	`FIELDS_TO_COD
(
dev_şass_mask
, 
mšÜ_mask
, 
majÜ_mask
, 
£rviûs_mask
);

1162 
	`APP_INFO1
("COD Mask: 0x%02x 0x%02x 0x%02x", 
dev_şass_mask
[0], dev_class_mask[1],dev_class_mask[2]);

1163 
	`memıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
dev_şass_cÚd
.
dev_şass_mask
,

1164 
dev_şass_mask
,

1165 (
DEV_CLASS
));

1168 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1169 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1171 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1176 
	}
}

1187 
	$­p_disc_¡¬t_bdaddr
(
BD_ADDR
 
bd_addr
, 
BOOLEAN
 
Çme_»q
,

1188 
tBSA_DISC_CBACK
 *
p_disc_cback
)

1190 
¡©us
;

1191 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1193 
	`APP_INFO0
("Start BdAddr filtered Discovery");

1194 
	`APP_INFO1
("Look for BdAddr :%02X-%02X-%02X-%02X-%02X-%02X",

1195 
bd_addr
[0], bd_addr[1], bd_addr[2], bd_addr[3], bd_addr[4], bd_addr[5]);

1198 
­p_disc_cb
.
p_disc_cback
 =…_disc_cback;

1201 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1203 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1205 
disc_¡¬t_·¿m
.
nb_deviûs
 = 1;

1206 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 1;

1207 
disc_¡¬t_·¿m
.
£rviûs
 = 0;

1209 
disc_¡¬t_·¿m
.
sk_Çme_»que¡
 = 
TRUE
;

1211 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1214 
disc_¡¬t_·¿m
.
f‹r_ty³
 = 
BSA_DM_INQ_BD_ADDR
;

1215 
	`bdıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
bd_addr
, bd_addr);

1218 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1219 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1221 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1226 
	}
}

1237 
	$­p_disc_¡¬t_bdaddr_£rviûs
(
BD_ADDR
 
bd_addr
,

1238 
tBSA_SERVICE_MASK
 
£rviûs
, 
tBSA_DISC_CBACK
 *
p_disc_cback
)

1240 
¡©us
;

1241 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1243 
	`APP_INFO0
("Start Services search for one device");

1244 
	`APP_INFO1
("Device BdAddr :%02X-%02X-%02X-%02X-%02X-%02X",

1245 
bd_addr
[0], bd_addr[1], bd_addr[2], bd_addr[3], bd_addr[4], bd_addr[5]);

1248 
­p_disc_cb
.
p_disc_cback
 =…_disc_cback;

1251 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1253 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1256 
disc_¡¬t_·¿m
.
f‹r_ty³
 = 
BSA_DM_INQ_BD_ADDR
;

1257 
	`bdıy
(
disc_¡¬t_·¿m
.
f‹r_cÚd
.
bd_addr
, bd_addr);

1260 
disc_¡¬t_·¿m
.
£rviûs
 = services;

1265 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1268 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1269 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1271 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1276 
	}
}

1287 
	$­p_disc_¡¬t_upd©e
(
tBSA_DISC_UPDATE
 
upd©e
)

1289 
¡©us
;

1290 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1292 
	`APP_INFO0
("Start Update mode specific Discovery");

1294 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1296 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1297 
disc_¡¬t_·¿m
.
nb_deviûs
 = 0;

1298 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 8;

1299 
disc_¡¬t_·¿m
.
upd©e
 = update;

1301 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1303 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1304 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1306 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1311 
	}
}

1322 
	$­p_disc_¡¬t_lim™ed
()

1324 
¡©us
;

1325 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1327 
	`APP_INFO0
("Start Limited Discovery");

1329 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1331 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1332 
disc_¡¬t_·¿m
.
mode
 = 
BSA_DM_LIMITED_INQUIRY
;

1333 
disc_¡¬t_·¿m
.
nb_deviûs
 = 0;

1334 
disc_¡¬t_·¿m
.
du¿tiÚ
 = 4;

1336 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1338 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1339 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1341 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1346 
	}
}

1357 
	$­p_disc_¡¬t_pow”
(
INT8
 
šq_tx_pow”
)

1359 
¡©us
;

1360 
tBSA_DISC_START
 
disc_¡¬t_·¿m
;

1362 
	`APP_INFO0
("Start Inquiry…ower specific Discovery");

1364 
	`BSA_DiscS¹In™
(&
disc_¡¬t_·¿m
);

1366 
disc_¡¬t_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1367 
disc_¡¬t_·¿m
.
šq_tx_pow”
 = inq_tx_power;

1369 
	`mem£t
(
­p_discov”y_cb
.
devs
, 0, (app_discovery_cb.devs));

1371 
¡©us
 = 
	`BSA_DiscS¹
(&
disc_¡¬t_·¿m
);

1372 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1374 
	`APP_ERROR1
("BSA_DiscS¹ faed stus:%d", 
¡©us
);

1379 
	}
}

1392 
tBSA_DISC_DEV
 *
	$­p_disc_fšd_deviû
(
BD_ADDR
 
bda
)

1394 
šdex
;

1398 
šdex
 = 0; index < 
APP_DISC_NB_DEVICES
; index++)

1400 ià((
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 !ğ
FALSE
) &&

1401 (
	`bdcmp
(
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
bd_addr
, 
bda
) == 0))

1403  &
­p_discov”y_cb
.
devs
[
šdex
];

1406  
NULL
;

1407 
	}
}

1420 
	$­p_disc_£t_nb_deviûs
(
nb_deviûs
)

1422 
­p_disc_cb
.
nb_deviûs
 =‚b_devices;

1425 
	}
}

1436 
UINT8
 
	$­p_g‘_dev_¶©fÜm
(
UINT16
 
v’dÜ
, UINT16 
v’dÜ_id_sourû
)

1438 
UINT8
 
¶©fÜm
 = 
BSA_DEV_PLATFORM_UNKNOWN
;

1439 
i
;

1441 
i
 = 0; i < 
APP_VENDOR_APPLE_COUNT
; i++)

1443 ià(
­p_v’dÜ_­¶e
[
i
].
v’dÜ
 == vendor &&

1444 
­p_v’dÜ_­¶e
[
i
].
v’dÜ_id_sourû
 == vendor_id_source)

1446 
¶©fÜm
 = 
BSA_DEV_PLATFORM_IOS
;

1451  
¶©fÜm
;

1452 
	}
}

1462 
	$­p_disc_»ad_»mÙe_deviû_Çme
(
BD_ADDR
 
bd_addr
,
tBSA_TRANSPORT
 
Œª¥Üt
)

1464 
tBSA_STATUS
 
¡©us
;

1465 
tBSA_DISC_READ_REMOTE_NAME
 
disc_»ad_»mÙe_Çme_·¿m
;

1467 
	`BSA_R—dRemÙeNameIn™
(&
disc_»ad_»mÙe_Çme_·¿m
);

1468 
disc_»ad_»mÙe_Çme_·¿m
.
cback
 = 
­p_g’”ic_disc_cback
;

1469 
disc_»ad_»mÙe_Çme_·¿m
.
Œª¥Üt
 =ransport;

1470 
	`bdıy
(
disc_»ad_»mÙe_Çme_·¿m
.
bd_addr
, bd_addr);

1472 
¡©us
 = 
	`BSA_R—dRemÙeName
(&
disc_»ad_»mÙe_Çme_·¿m
);

1473 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1475 
	`APP_ERROR1
("BSA_R—dRemÙeNamçed stus:%d", 
¡©us
);

1479 
	}
}

	@source/app_common/app_dm.c

12 
	~"b§_­i.h
"

13 
	~"­p_dm.h
"

14 
	~"­p_uts.h
"

15 
	~"­p_xml_·¿m.h
"

16 
	~"­p_xml_uts.h
"

29 
	$­p_dm_g‘_loÿl_bt_cÚfig
()

31 
¡©us
;

32 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

37 
¡©us
 = 
	`BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

38 
¡©us
 = 
	`BSA_DmG‘CÚfig
(&
bt_cÚfig
);

39 ià(
¡©us
 !ğ
BSA_SUCCESS
)

41 
	`APP_ERROR1
("UÇbËØg‘ BT cÚfig from s”v” stus:%d", 
¡©us
);

44 
	`APP_INFO0
("Get Local Bluetooth Config:");

45 
	`APP_INFO1
("\tEÇbË:%d", 
bt_cÚfig
.
’abË
);

46 
	`APP_INFO1
("\tDiscov”abË:%d", 
bt_cÚfig
.
discov”abË
);

47 
	`APP_INFO1
("\tCÚÃùabË:%d", 
bt_cÚfig
.
cÚÃùabË
);

48 
	`APP_INFO1
("\tName:%s", 
bt_cÚfig
.
Çme
);

49 
	`APP_INFO1
("\tBLE Name:%s", 
bt_cÚfig
.
bË_Çme
);

50 
	`APP_INFO1
 ("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

51 
bt_cÚfig
.
bd_addr
[0], bt_config.bd_addr[1],

52 
bt_cÚfig
.
bd_addr
[2], bt_config.bd_addr[3],

53 
bt_cÚfig
.
bd_addr
[4], bt_config.bd_addr[5]);

54 
	`APP_INFO1
("\tCÏssOfDeviû:%02x:%02x:%02x", 
bt_cÚfig
.
şass_of_deviû
[0],

55 
bt_cÚfig
.
şass_of_deviû
[1], bt_config.class_of_device[2]);

57 if(
bt_cÚfig
.
’abË
)

61 
	}
}

74 
	$­p_dm_£t_loÿl_bt_cÚfig
(
BOOLEAN
 
’abË
)

76 
¡©us
;

77 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

78 
tAPP_XML_CONFIG
 
xml_loÿl_cÚfig
;

80 
¡©us
 = 
	`­p_»ad_xml_cÚfig
(&
xml_loÿl_cÚfig
);

81 ià(
¡©us
 < 0)

83 
	`APP_ERROR0
("Unableo Read XML config file");

84  
¡©us
;

88 
¡©us
 = 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

91 
bt_cÚfig
.
’abË
 =ƒnable;

93 
bt_cÚfig
.
discov”abË
 = 
FALSE
;

94 
bt_cÚfig
.
cÚÃùabË
 = 
FALSE
;

95 
	`bdıy
(
bt_cÚfig
.
bd_addr
, 
xml_loÿl_cÚfig
.bd_addr);

96 
	`¡ºıy
((*)
bt_cÚfig
.
Çme
, (*)
xml_loÿl_cÚfig
.name, (bt_config.name));

97 
bt_cÚfig
.
Çme
[(bt_config.name)-1] = '\0';

98 
	`¡ºıy
((*)
bt_cÚfig
.
bË_Çme
, (*)
xml_loÿl_cÚfig
.ble_name, (bt_config.ble_name));

99 
bt_cÚfig
.
bË_Çme
[(bt_config.ble_name)-1] = '\0';

100 
	`memıy
(
bt_cÚfig
.
şass_of_deviû
, 
xml_loÿl_cÚfig
.şass_of_deviû, (
DEV_CLASS
));

102 
	`APP_INFO0
("Set Local Bluetooth Config:");

103 
	`APP_INFO1
("\tEÇbË:%d", 
bt_cÚfig
.
’abË
);

104 
	`APP_INFO1
("\tDiscov”abË:%d", 
bt_cÚfig
.
discov”abË
);

105 
	`APP_INFO1
("\tCÚÃùabË:%d", 
bt_cÚfig
.
cÚÃùabË
);

106 
	`APP_INFO1
("\tName:%s", 
bt_cÚfig
.
Çme
);

107 
	`APP_INFO1
("\tBLE Name:%s", 
bt_cÚfig
.
bË_Çme
);

108 
	`APP_INFO1
("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

109 
bt_cÚfig
.
bd_addr
[0], bt_config.bd_addr[1],

110 
bt_cÚfig
.
bd_addr
[2], bt_config.bd_addr[3],

111 
bt_cÚfig
.
bd_addr
[4], bt_config.bd_addr[5]);

112 
	`APP_INFO1
("\tCÏssOfDeviû:%02x:%02x:%02x", 
bt_cÚfig
.
şass_of_deviû
[0],

113 
bt_cÚfig
.
şass_of_deviû
[1], bt_config.class_of_device[2]);

116 
¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

117 ià(
¡©us
 !ğ
BSA_SUCCESS
)

119 
	`APP_ERROR1
("UÇbËØ£ˆBT CÚfigØ£rv” stus:%d", 
¡©us
);

124 ià((
’abË
) &&

125 (
xml_loÿl_cÚfig
.
discov”abË
 || xml_loÿl_cÚfig.
cÚÃùabË
))

128 
¡©us
 = 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

131 
bt_cÚfig
.
’abË
 =ƒnable;

132 
bt_cÚfig
.
discov”abË
 = 
xml_loÿl_cÚfig
.discoverable;

133 
bt_cÚfig
.
cÚÃùabË
 = 
xml_loÿl_cÚfig
.connectable;

134 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

136 
	`APP_INFO0
("Set Local Bluetooth Config:");

137 
	`APP_INFO1
("\tEÇbË:%d", 
bt_cÚfig
.
’abË
);

138 
	`APP_INFO1
("\tDiscov”abË:%d", 
bt_cÚfig
.
discov”abË
);

139 
	`APP_INFO1
("\tCÚÃùabË:%d", 
bt_cÚfig
.
cÚÃùabË
);

142 
¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

143 ià(
¡©us
 !ğ
BSA_SUCCESS
)

145 
	`APP_ERROR1
("UÇbËØ£ˆBT CÚfig (Sÿnè¡©us:%d", 
¡©us
);

151 
	}
}

166 
	$­p_dm_£t_chªÃl_m­
(
fœ¡_afh_ch
, 
Ï¡_afh_ch
)

168 
tBSA_DM_SET_CONFIG
 
Ãw_bt_cÚfig
;

169 
tBSA_STATUS
 
¡©us
;

171 
	`BSA_DmS‘CÚfigIn™
(&
Ãw_bt_cÚfig
);

172 
Ãw_bt_cÚfig
.
fœ¡_di§bËd_chªÃl
 = 
fœ¡_afh_ch
;

173 
Ãw_bt_cÚfig
.
Ï¡_di§bËd_chªÃl
 = 
Ï¡_afh_ch
;

175 
Ãw_bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_CHANNEL_MASK
;

177 
¡©us
 = 
	`BSA_DmS‘CÚfig
(&
Ãw_bt_cÚfig
);

179 ià(
¡©us
 !ğ
BSA_SUCCESS
)

181 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed:%d", 
¡©us
);

185 
	}
}

196 
	$­p_dm_£t_tx_şass
(
UINT8
 
tx_pow”
)

198 
¡©us
;

199 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

202 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

205 
bt_cÚfig
.
’abË
 = 
TRUE
;

208 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_TX_POWER_MASK
;

209 
bt_cÚfig
.
tx_pow”
 =x_power;

211 
¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

212 ià(
¡©us
 !ğ
BSA_SUCCESS
)

214 
	`APP_ERROR1
("UÇbËØchªgTx…ow” stus:%d", 
¡©us
);

216  
¡©us
;

217 
	}
}

231 
	$­p_dm_£t_·ge_sÿn_·¿m
(
UINT16
 
š‹rv®
, UINT16 
wšdow
)

233 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

234 
tBSA_STATUS
 
b§_¡©us
;

236 
	`APP_DEBUG1
("IÁ”v®:%d (%dmsèwšdow:%d (%dms)", 
š‹rv®
, ()(()interval*0.625),

237 
wšdow
, ()(()window*0.625));

240 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

243 
bt_cÚfig
.
’abË
 = 
TRUE
;

246 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_PAGE_SCAN_PARAM_MASK
;

247 
bt_cÚfig
.
·ge_sÿn_š‹rv®
 = 
š‹rv®
;

248 
bt_cÚfig
.
·ge_sÿn_wšdow
 = 
wšdow
;

250 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

251 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

253 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

257 
	}
}

271 
	$­p_dm_£t_šquœy_sÿn_·¿m
(
UINT16
 
š‹rv®
, UINT16 
wšdow
)

273 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

274 
tBSA_STATUS
 
b§_¡©us
;

276 
	`APP_DEBUG1
("IÁ”v®:%d (%dmsèwšdow:%d (%dms)", 
š‹rv®
, ()(()interval*0.625),

277 
wšdow
, ()(()window*0.625));

280 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

283 
bt_cÚfig
.
’abË
 = 
TRUE
;

286 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_INQ_SCAN_PARAM_MASK
;

287 
bt_cÚfig
.
šquœy_sÿn_š‹rv®
 = 
š‹rv®
;

288 
bt_cÚfig
.
šquœy_sÿn_wšdow
 = 
wšdow
;

290 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

291 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

293 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

297 
	}
}

311 
	$­p_dm_£t_bË_sÿn_·¿m
(
UINT16
 
š‹rv®
, UINT16 
wšdow
)

313 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

314 
tBSA_STATUS
 
b§_¡©us
;

316 
	`APP_DEBUG1
("IÁ”v®:%d (%dmsèwšdow:%d (%dms)", 
š‹rv®
, ()(()interval*0.625),

317 
wšdow
, ()(()window*0.625));

320 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

323 
bt_cÚfig
.
’abË
 = 
TRUE
;

326 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_SCAN_PARAM_MASK
;

327 
bt_cÚfig
.
bË_sÿn_š‹rv®
 = 
š‹rv®
;

328 
bt_cÚfig
.
bË_sÿn_wšdow
 = 
wšdow
;

330 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

331 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

333 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

337 
	}
}

350 
	$­p_dm_£t_bË_cÚn_·¿m
(
tBSA_DM_BLE_CONN_PARAM
 *
p_»q
)

352 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

353 
tBSA_STATUS
 
b§_¡©us
;

355 
	`APP_DEBUG1
("BDA:%02X:%02X:%02X:%02X:%02X:%02X ",

356 
p_»q
->
bd_addr
[0],…_req->bd_addr[1],

357 
p_»q
->
bd_addr
[2],…_req->bd_addr[3],

358 
p_»q
->
bd_addr
[4],…_req->bd_addr[5]);

360 
	`APP_DEBUG1
("min_conn_int:%d max_conn_int:%d slave_latency:%d supervision_tout:%d",

361 
p_»q
->
max_cÚn_št
,…_»q->
mš_cÚn_št
,

362 
p_»q
->
¦ave_Ï‹ncy
,…_»q->
su³rvisiÚ_tout
);

364 
	`APP_DEBUG1
("is_immedŸ‹_upd©šg:%d", 
p_»q
->
is_immedŸ‹_upd©šg
);

367 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

370 
bt_cÚfig
.
’abË
 = 
TRUE
;

373 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_CONN_PARAM_MASK
;

374 
	`bdıy
(
bt_cÚfig
.
bË_cÚn_·¿m
.
bd_addr
, 
p_»q
->bd_addr);

375 
bt_cÚfig
.
bË_cÚn_·¿m
.
max_cÚn_št
 = 
p_»q
->max_conn_int;

376 
bt_cÚfig
.
bË_cÚn_·¿m
.
mš_cÚn_št
 = 
p_»q
->min_conn_int;

377 
bt_cÚfig
.
bË_cÚn_·¿m
.
¦ave_Ï‹ncy
 = 
p_»q
->slave_latency;

378 
bt_cÚfig
.
bË_cÚn_·¿m
.
su³rvisiÚ_tout
 = 
p_»q
->supervision_tout;

379 
bt_cÚfig
.
bË_cÚn_·¿m
.
is_immedŸ‹_upd©šg
 = 
p_»q
->is_immediate_updating;

381 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

382 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

384 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

388 
	}
}

401 
	$­p_dm_£t_bË_adv_d©a
(
tBSA_DM_BLE_ADV_CONFIG
 *
p_d©a
)

403 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

404 
tBSA_STATUS
 
b§_¡©us
;

407 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

410 
bt_cÚfig
.
’abË
 = 
TRUE
;

413 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_ADV_CONFIG_MASK
;

415 
bt_cÚfig
.
adv_cÚfig
.
Ën
 = 
p_d©a
->len;

416 
bt_cÚfig
.
adv_cÚfig
.
æag
 = 
p_d©a
->flag;

417 
bt_cÚfig
.
adv_cÚfig
.
adv_d©a_mask
 = 
p_d©a
->adv_data_mask;

418 
bt_cÚfig
.
adv_cÚfig
.
­³¬ªû_d©a
 = 
p_d©a
->appearance_data;

419 
bt_cÚfig
.
adv_cÚfig
.
num_£rviû
 = 
p_d©a
->num_service;

420 
bt_cÚfig
.
adv_cÚfig
.
is_sÿn_r¥
 = 
p_d©a
->is_scan_rsp;

421 
bt_cÚfig
.
adv_cÚfig
.
is_·¹_£rviû
 = 
p_d©a
->is_part_service;

423 
	`memıy
(
bt_cÚfig
.
adv_cÚfig
.
uuid_v®
, 
p_d©a
->uuid_v®,p_d©a->
num_£rviû
 * (
UINT16
));

424 
	`memıy
(
bt_cÚfig
.
adv_cÚfig
.
p_v®
,
p_d©a
->p_v®,p_d©a->
Ën
);

427 
bt_cÚfig
.
adv_cÚfig
.
£rviû_d©a_Ën
 = 
p_d©a
->service_data_len;

428 
bt_cÚfig
.
adv_cÚfig
.
£rviû_d©a_uuid
.
Ën
 = 
p_d©a
->service_data_uuid.len;

429 
bt_cÚfig
.
adv_cÚfig
.
£rviû_d©a_uuid
.
uu
.
uuid16
 = 
p_d©a
->service_data_uuid.uu.uuid16;

430 
	`memıy
(
bt_cÚfig
.
adv_cÚfig
.
£rviû_d©a_v®
,
p_d©a
->£rviû_d©a_v®,p_d©a->
£rviû_d©a_Ën
);

433 
	`memıy
(&
bt_cÚfig
.
adv_cÚfig
.
sŞ_£rviû_128b
, &
p_d©a
->sŞ_£rviû_128b, (
tBSA_DM_BLE_128SERVICE
));

436 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

437 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

439 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

443 
	}
}

455 
	$­p_dm_g‘_bË_adv_·¿m
()

457 
¡©us
;

458 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

463 
¡©us
 = 
	`BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

464 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_ADV_PARAM_MASK
;

465 
¡©us
 = 
	`BSA_DmG‘CÚfig
(&
bt_cÚfig
);

466 ià(
¡©us
 !ğ
BSA_SUCCESS
)

468 
	`APP_ERROR1
("UÇbËØg‘ BT cÚfig from s”v” stus:%d", 
¡©us
);

471 
	`APP_INFO1
("bË_adv_·¿m‡dv_št_mš=0x%x,‡dv_št_max=0x%x",(
UINT16
)
bt_cÚfig
.
bË_adv_·¿m
.
adv_št_mš
, (UINT16)bt_cÚfig.bË_adv_·¿m.
adv_št_max
);

473 if(
bt_cÚfig
.
’abË
)

477 
	}
}

489 
	$­p_dm_£t_bË_adv_·¿m
(
tBSA_DM_BLE_ADV_PARAM
 *
p_»q
)

491 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

492 
tBSA_STATUS
 
b§_¡©us
;

495 
p_»q
->
dœ_bda
.
bd_addr
[0],…_req->dir_bda.bd_addr[1], \

496 
p_»q
->
dœ_bda
.
bd_addr
[2],…_req->dir_bda.bd_addr[3], \

497 
p_»q
->
dœ_bda
.
bd_addr
[4],…_req->dir_bda.bd_addr[5]);

499 
	`APP_DEBUG1
("adv_št_mš:%d‡dv_št_max:%d", 
p_»q
->
adv_št_mš
,…_»q->
adv_št_max
);

502 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

505 
bt_cÚfig
.
’abË
 = 
TRUE
;

508 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_ADV_PARAM_MASK
;

509 
	`bdıy
(
bt_cÚfig
.
bË_adv_·¿m
.
dœ_bda
.
bd_addr
, 
p_»q
->dir_bda.bd_addr);

510 
bt_cÚfig
.
bË_adv_·¿m
.
adv_št_mš
 = 
p_»q
->adv_int_min;

511 
bt_cÚfig
.
bË_adv_·¿m
.
adv_št_max
 = 
p_»q
->adv_int_max;

513 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

514 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

516 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

520 
	}
}

535 
	$­p_dm_£t_deviû_şass
(
UINT16
 
£rviûs
, 
UINT8
 
majÜ
, UINT8 
mšÜ
)

537 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

538 
tBSA_STATUS
 
b§_¡©us
;

540 
	`APP_DEBUG1
("S‘ COD S”viûs:%x MajÜ:%x MšÜ:%x", 
£rviûs
, 
majÜ
, 
mšÜ
);

543 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

546 
bt_cÚfig
.
’abË
 = 
TRUE
;

549 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_DEV_CLASS_MASK
;

550 
	`FIELDS_TO_COD
(
bt_cÚfig
.
şass_of_deviû
, 
mšÜ
, 
majÜ
, 
£rviûs
);

552 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

553 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

555 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

559 
	}
}

573 
	$­p_dm_£t_visib™y
(
BOOLEAN
 
discov”abË
, BOOLEAN 
cÚÃùabË
)

575 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

576 
tBSA_STATUS
 
b§_¡©us
;

578 
	`APP_DEBUG1
("S‘ Visib™y Discov”abË:%d CÚÃùabË:%d", 
discov”abË
, 
cÚÃùabË
);

581 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

584 
bt_cÚfig
.
’abË
 = 
TRUE
;

587 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

588 
bt_cÚfig
.
cÚÃùabË
 = connectable;

589 
bt_cÚfig
.
discov”abË
 = discoverable;

591 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

592 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

594 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

598 
	}
}

600 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

613 
BOOLEAN
 
	gbË_b—cÚ_¡©e
 = 0;

614 
BOOLEAN
 
	$­p_dm_g‘_bË_visib™y
(){

615  
bË_b—cÚ_¡©e
;

616 
	}
}

617 
	$­p_dm_’su»_bË_visib™y
(){

618 if(!
bË_b—cÚ_¡©e
) {

619 
	`­p_dm_£t_bË_visib™y
(
TRUE
, TRUE);

621 
	}
}

622 
	$­p_dm_£t_bË_visib™y
(
BOOLEAN
 
discov”abË
, BOOLEAN 
cÚÃùabË
)

624 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

625 
tBSA_STATUS
 
b§_¡©us
;

627 
	`APP_DEBUG1
("S‘ BLE Visib™y Discov”abË:%d CÚÃùabË:%d", 
discov”abË
, 
cÚÃùabË
);

630 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

633 
bt_cÚfig
.
’abË
 = 
TRUE
;

636 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_VISIBILITY_MASK
;

637 
bt_cÚfig
.
bË_cÚÃùabË
 = 
cÚÃùabË
;

638 
bt_cÚfig
.
bË_discov”abË
 = 
discov”abË
;

640 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

641 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

643 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

646 
bË_b—cÚ_¡©e
 = 
discov”abË
;

648 
	}
}

661 
	$­p_dm_£t_bË_loÿl_´ivacy
(
BOOLEAN
 
´ivacy_’abË
)

663 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

664 
tBSA_STATUS
 
b§_¡©us
;

666 
	`APP_DEBUG1
("S‘ BLE LoÿÈPrivacy : %d",
´ivacy_’abË
);

668 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

671 
bt_cÚfig
.
’abË
 = 
TRUE
;

674 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_PRIVACY_MASK
;

675 
bt_cÚfig
.
´ivacy_’abË
 =…rivacy_enable;

677 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

678 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

680 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

684 
	}
}

698 
	$­p_dm_£t_du®_¡ack_mode
(
tBSA_DM_DUAL_STACK_MODE
 
du®_¡ack_mode
)

700 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

701 
tBSA_STATUS
 
b§_¡©us
;

703 
	`APP_DEBUG1
("S‘ Du®SckMode:%d ", 
du®_¡ack_mode
);

706 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

709 
bt_cÚfig
.
’abË
 = 
TRUE
;

712 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_DUAL_STACK_MODE_MASK
;

713 
bt_cÚfig
.
du®_¡ack_mode
 = dual_stack_mode;

715 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

716 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

718 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

722 
	}
}

735 
	$­p_dm_g‘_du®_¡ack_mode
()

737 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

738 
tBSA_STATUS
 
b§_¡©us
;

740 
	`APP_DEBUG0
("Get DualStackMode");

743 
	`BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

745 
b§_¡©us
 = 
	`BSA_DmG‘CÚfig
(&
bt_cÚfig
);

746 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

748 
	`APP_ERROR1
("BSA_DmG‘CÚfig faed stus:%d ", 
b§_¡©us
);

751  ()
bt_cÚfig
.
du®_¡ack_mode
;

752 
	}
}

766 
	$­p_dm_g‘_ch_id
()

768 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

769 
tBSA_STATUS
 
b§_¡©us
;

771 
	`APP_DEBUG0
("Get BT Chip ID");

774 
	`BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

776 
b§_¡©us
 = 
	`BSA_DmG‘CÚfig
(&
bt_cÚfig
);

777 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

779 
	`APP_ERROR1
("BSA_DmG‘CÚfig faed stus:%d ", 
b§_¡©us
);

783 
bt_cÚfig
.
ch_id
)

785 
BSA_DM_CHIP_ID_2046B1
:

786 
	`APP_INFO1
("ChId:BCM2046B1:%d",
bt_cÚfig
.
ch_id
);

789 
BSA_DM_CHIP_ID_20702A1
:

790 
	`APP_INFO1
("ChId:BCM20702A1:%d",
bt_cÚfig
.
ch_id
);

793 
BSA_DM_CHIP_ID_20702B0
:

794 
	`APP_INFO1
("ChId:BCM20702B0:%d",
bt_cÚfig
.
ch_id
);

797 
BSA_DM_CHIP_ID_43242A1
:

798 
	`APP_INFO1
("ChId:BCM43242A1:%d",
bt_cÚfig
.
ch_id
);

801 
BSA_DM_CHIP_ID_43569A2
:

802 
	`APP_INFO1
("ChId:BCM43569A2:%d",
bt_cÚfig
.
ch_id
);

806 
	`APP_INFO1
("UnsuµÜ‹d ChId:%d", 
bt_cÚfig
.
ch_id
);

809  ()
bt_cÚfig
.
ch_id
;

810 
	}
}

825 
	$­p_dm_£t_bË_bg_cÚn_ty³
(
ty³
)

827 
tBSA_DM_GET_CONFIG
 
bt_cÚfig
;

828 
tBSA_STATUS
 
b§_¡©us
;

830 
	`APP_DEBUG1
("S‘ BLE BG cÚÀty³ (%d)", 
ty³
);

833 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

836 
bt_cÚfig
.
’abË
 = 
TRUE
;

839 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_BLE_BGCONN_TYPE_MASK
;

840 
bt_cÚfig
.
bË_bg_cÚn_ty³
 = 
ty³
;

842 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

843 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

845 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

849 
	}
}

864 
	$­p_dm_mÚ™Ü_rssi
(
BOOLEAN
 
’abË
, 
UINT16
 
³riod
)

866 
tBSA_DM_SET_CONFIG
 
bt_cÚfig
;

867 
tBSA_STATUS
 
b§_¡©us
;

869 
	`APP_DEBUG1
("% RSSI MÚ™Üšg\n", (
’abË
)?"Enabling":"Disabling" );

872 
	`BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

875 
bt_cÚfig
.
’abË
 = 
TRUE
;

878 
bt_cÚfig
.
cÚfig_mask
 = 
BSA_DM_CONFIG_MONITOR_RSSI
;

881 
bt_cÚfig
.
mÚ™Ü_rssi_·¿m
.
’abË
 =ƒnable;

883 iàĞ
bt_cÚfig
.
mÚ™Ü_rssi_·¿m
.
’abË
 )

885 
bt_cÚfig
.
mÚ™Ü_rssi_·¿m
.
³riod
 =…eriod;

888 
b§_¡©us
 = 
	`BSA_DmS‘CÚfig
(&
bt_cÚfig
);

889 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

891 
	`APP_ERROR1
("BSA_DmS‘CÚfig faed stus:%d ", 
b§_¡©us
);

895 
	}
}

	@source/app_common/app_link.c

12 
	~"­p_lšk.h
"

13 
	~"­p_uts.h
"

14 
	~"bd.h
"

20 
	#APP_LINK_NB_MAX
 10

	)

24 
BOOLEAN
 
	mš_u£
;

25 
DEV_CLASS
 
	mşass_of_deviû
;

26 
BD_ADDR
 
	mbd_addr
;

27 
BOOLEAN
 
	msu¥’ded
;

28 } 
	ttAPP_ACL_LINK
;

33 
tAPP_ACL_LINK
 
	g­p_aş_lšk
[
APP_LINK_NB_MAX
];

48 
tAPP_ACL_LINK
 *
	$­p_lšk_fšd_by_addr
(cÚ¡ 
BD_ADDR
 
bd_addr
)

50 
šdex
;

53 
šdex
 = 0; index < 
APP_LINK_NB_MAX
; index++)

55 ià((
­p_aş_lšk
[
šdex
].
š_u£
) &&

56 (
	`bdcmp
(
­p_aş_lšk
[
šdex
].
bd_addr
, bd_addr) == 0))

58  &
­p_aş_lšk
[
šdex
];

61  
NULL
;

62 
	}
}

76 
	$­p_lšk_fšd_by_cod
(cÚ¡ 
UINT8
 *
p_cod
, cÚ¡ UINT8 *
p_cod_mask
)

78 
šdex
;

81 
šdex
 = 0; index < 
APP_LINK_NB_MAX
; index++)

83 ià((
­p_aş_lšk
[
šdex
].
š_u£
) &&

84 ((
­p_aş_lšk
[
šdex
].
şass_of_deviû
[0] & 
p_cod_mask
[0]è=ğ
p_cod
[0]) &&

85 ((
­p_aş_lšk
[
šdex
].
şass_of_deviû
[1] & 
p_cod_mask
[1]è=ğ
p_cod
[1]) &&

86 ((
­p_aş_lšk
[
šdex
].
şass_of_deviû
[2] & 
p_cod_mask
[2]è=ğ
p_cod
[2]))

92 
	}
}

106 
	$­p_lšk_add
(
BD_ADDR
 
bd_addr
, 
UINT8
 *
p_şass_of_deviû
)

108 
šdex
;

110 
	`APP_DEBUG0
("Adding device in ACL database");

113 ià(
	`­p_lšk_fšd_by_addr
(
bd_addr
è!ğ
NULL
)

115 
	`APP_ERROR0
("This device is‡lready inhe database");

120 
šdex
 = 0; index < 
APP_LINK_NB_MAX
; index++)

122 ià(
­p_aş_lšk
[
šdex
].
š_u£
 =ğ
FALSE
)

127 ià(
šdex
 >ğ
APP_LINK_NB_MAX
)

129 
	`APP_ERROR0
("Database full");

135 
­p_aş_lšk
[
šdex
].
š_u£
 = 
TRUE
;

136 
­p_aş_lšk
[
šdex
].
su¥’ded
 = 
FALSE
;

137 
	`bdıy
(
­p_aş_lšk
[
šdex
].
bd_addr
, bd_addr);

138 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[0] = 
p_şass_of_deviû
[0];

139 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[1] = 
p_şass_of_deviû
[1];

140 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[2] = 
p_şass_of_deviû
[2];

142 
	`­p_lšk_di¥Ïy
();

145 
	}
}

158 
	$­p_lšk_»move
(
BD_ADDR
 
bd_addr
)

160 
tAPP_ACL_LINK
 *
p_lšk
;

162 
	`APP_DEBUG0
("Removing device from ACL database");

164 
p_lšk
 = 
	`­p_lšk_fšd_by_addr
(
bd_addr
);

167 ià(
p_lšk
 =ğ
NULL
)

169 
	`APP_ERROR0
("This device is‚ot inhe database");

173 
	`APP_DEBUG1
("Suµ»ssšg deviû index: %d", ()(
p_lšk
 - 
­p_aş_lšk
));

174 
p_lšk
->
š_u£
 = 
FALSE
;

175 
	`­p_lšk_di¥Ïy
();

178 
	}
}

191 
	$­p_lšk_di¥Ïy
()

193 
šdex
;

194 
BOOLEAN
 
cÚÃùed
 = 
FALSE
;

196 
	`APP_DEBUG0
("Currently connected devices");

199 
šdex
 = 0 ; index < 
APP_LINK_NB_MAX
 ; index++)

201 ià(
­p_aş_lšk
[
šdex
].
š_u£
)

203 
	`APP_DEBUG1
("Device index:[%d] BdAddr: %02X:%02X:%02X:%02X:%02X:%02X COD: %02X:%02X:%02X => %s",

204 
šdex
,

205 
­p_aş_lšk
[
šdex
].
bd_addr
[0],app_acl_link[index].bd_addr[1],

206 
­p_aş_lšk
[
šdex
].
bd_addr
[2],app_acl_link[index].bd_addr[3],

207 
­p_aş_lšk
[
šdex
].
bd_addr
[4],app_acl_link[index].bd_addr[5],

208 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[0],

209 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[1],

210 
­p_aş_lšk
[
šdex
].
şass_of_deviû
[2],

211 
	`­p_g‘_cod_¡ršg
(
­p_aş_lšk
[
šdex
].
şass_of_deviû
) );

213 
cÚÃùed
 = 
TRUE
;

217 ià(
cÚÃùed
 =ğ
FALSE
)

219 
	`APP_DEBUG0
("No device connected");

221 
	}
}

236 
	$­p_lšk_g‘_cod
(
BD_ADDR
 
bd_addr
, 
UINT8
 *
p_şass_of_deviû
)

238 
tAPP_ACL_LINK
 *
p_lšk
;

240 
	`APP_DEBUG0
("Get COD from ACL database");

241 
p_lšk
 = 
	`­p_lšk_fšd_by_addr
(
bd_addr
);

244 ià(
p_lšk
 =ğ
NULL
)

246 
	`APP_DEBUG0
("This device is‚ot inhe database");

247 
p_şass_of_deviû
[0] = 0;

248 
p_şass_of_deviû
[1] = 0;

249 
p_şass_of_deviû
[2] = 0;

250 
	`­p_lšk_di¥Ïy
();

254 
	`APP_DEBUG1
("Device found index:[%d] COD:%02X:%02X:%02X => %s",

255 ()(
p_lšk
 - 
­p_aş_lšk
),

256 
p_lšk
->
şass_of_deviû
[0],

257 
p_lšk
->
şass_of_deviû
[1],

258 
p_lšk
->
şass_of_deviû
[2],

259 
	`­p_g‘_cod_¡ršg
(
p_lšk
->
şass_of_deviû
));

261 
p_şass_of_deviû
[0] = 
p_lšk
->
şass_of_deviû
[0];

262 
p_şass_of_deviû
[1] = 
p_lšk
->
şass_of_deviû
[1];

263 
p_şass_of_deviû
[2] = 
p_lšk
->
şass_of_deviû
[2];

266 
	}
}

280 
	$­p_lšk_£t_su¥’ded
(
BD_ADDR
 
bd_addr
, 
BOOLEAN
 
su¥’ded
)

282 
tAPP_ACL_LINK
 *
p_lšk
;

284 
	`APP_DEBUG1
("S‘ su¥’ded: %d", ()
su¥’ded
);

286 
p_lšk
 = 
	`­p_lšk_fšd_by_addr
(
bd_addr
);

289 ià(
p_lšk
 =ğ
NULL
)

291 
	`APP_DEBUG0
("This device is‚ot inhe database");

295 
p_lšk
->
su¥’ded
 = suspended;

297 
	}
}

310 
	$­p_lšk_g‘_su¥’ded
(
BD_ADDR
 
bd_addr
)

312 
tAPP_ACL_LINK
 *
p_lšk
;

314 
	`APP_DEBUG0
("Get suspended");

316 
p_lšk
 = 
	`­p_lšk_fšd_by_addr
(
bd_addr
);

319 ià(
p_lšk
 =ğ
NULL
)

321 
	`APP_DEBUG0
("This device is‚ot inhe database");

325 ià(
p_lšk
->
su¥’ded
)

330 
	}
}

344 
	$­p_lšk_g‘_bd_addr_äom_šdex
(
šdex
, 
BD_ADDR
 
bd_addr
)

346 
tAPP_ACL_LINK
 *
p_lšk
;

348 
	`APP_DEBUG0
("Get BdAddr");

350 ià(
bd_addr
 =ğ
NULL
)

352 
	`APP_ERROR0
("Null BdAddr…ointer");

356 ià((
šdex
 < 0è|| (šdex >ğ
APP_LINK_NB_MAX
))

358 
	`APP_ERROR1
("Bad Index:%d", 
šdex
);

362 
p_lšk
 = &
­p_aş_lšk
[
šdex
];

364 ià(
p_lšk
->
š_u£
 =ğ
FALSE
)

366 
	`APP_ERROR1
("Deviû Index:%d i nÙ cÚÃùed", 
šdex
);

370 
	`bdıy
(
bd_addr
, 
p_lšk
->bd_addr);

371 
	`APP_DEBUG1
("BdAddr %02X:%02X:%02X:%02X:%02X:%02X",

372 
bd_addr
[0], bd_addr[1], bd_addr[2], bd_addr[3], bd_addr[4], bd_addr[5]);

375 
	}
}

388 
	$­p_lšk_g‘_num_aùive
()

390 
šdex
, 
couÁ
;

392 
couÁ
 = 0;

394 
šdex
 = 0; index < 
APP_LINK_NB_MAX
; index++)

396 ià(
­p_aş_lšk
[
šdex
].
š_u£
)

398 
couÁ
++;

401  
couÁ
;

402 
	}
}

413 *
	$­p_lšk_Œª¥Üt_ty³_desc
(
tBSA_TRANSPORT
 
lšk_ty³
)

415 
lšk_ty³
)

417 
BSA_TRANSPORT_BR_EDR
:

419 
BSA_TRANSPORT_LE
:

423 
	}
}

	@source/app_common/app_mgt.c

11 
	~<uni¡d.h
>

13 
	~"­p_mgt.h
"

14 
	~"­p_uts.h
"

22 
tAPP_MGT_CUSTOM_CBACK
* 
	mmgt_cu¡om_cback
;

23 } 
	g­p_mgt_cb
;

40 
	$­p_mgt_g’”ic_ÿÎback
(
tBSA_MGT_EVT
 
ev’t
, 
tBSA_MGT_MSG
 *
p_d©a
)

42 
BOOLEAN
 
ex™_g’”ic_cback
ğ
FALSE
;

45 if(
­p_mgt_cb
.
mgt_cu¡om_cback
 !ğ
NULL
)

48 
ex™_g’”ic_cback
 = 
­p_mgt_cb
.
	`mgt_cu¡om_cback
(
ev’t
, 
p_d©a
);

76 
	}
}

89 
	$­p_mgt_š™
()

91 
	`mem£t
(&
­p_mgt_cb
, 0, (app_mgt_cb));

93 
	}
}

107 
	$­p_mgt_İ’
(cÚ¡ *
p_uc_·th
, 
tAPP_MGT_CUSTOM_CBACK
 *
p_mgt_ÿÎback
)

109 
tBSA_MGT_OPEN
 
b§_İ’_·¿m
;

110 
tBSA_STATUS
 
b§_¡©us
;

111 
i
;

113 
	`BSA_MgtO³nIn™
(&
b§_İ’_·¿m
);

116 ià(
p_uc_·th
 =ğ
NULL
)

118 
	`¡ºıy
(
b§_İ’_·¿m
.
uc_·th
, 
APP_DEFAULT_UIPC_PATH
, (bsa_open_param.uipc_path) - 1);

119 
b§_İ’_·¿m
.
uc_·th
[(bsa_open_param.uipc_path) - 1] = '\0';

124 
	`¡ºıy
(
b§_İ’_·¿m
.
uc_·th
, 
p_uc_·th
, (bsa_open_param.uipc_path) - 1);

125 
b§_İ’_·¿m
.
uc_·th
[(bsa_open_param.uipc_path) - 1] = '\0';

129 
b§_İ’_·¿m
.
ÿÎback
 = 
­p_mgt_g’”ic_ÿÎback
;

132 
­p_mgt_cb
.
mgt_cu¡om_cback
 = 
p_mgt_ÿÎback
;

135 
i
 = 0 ; i < 50 ; i++)

138 
b§_¡©us
 = 
	`BSA_MgtO³n
(&
b§_İ’_·¿m
);

139 ià(
b§_¡©us
 =ğ
BSA_SUCCESS
)

143 
	`APP_ERROR1
("CÚÃùiÚØ£rv” unsucûssfuÈ(%d),„‘ryšg...", 
i
);

144 
	`u¦“p
(100*1000);

146 ià(
b§_¡©us
 !ğ
BSA_SUCCESS
)

148 
	`APP_ERROR0
("Unableo connecto server");

153 
	}
}

167 
	$­p_mgt_şo£
()

169 
tBSA_MGT_CLOSE
 
b§_şo£_·¿m
;

170 
tBSA_STATUS
 
b§_¡©us
;

172 
	`BSA_MgtClo£In™
(&
b§_şo£_·¿m
);

173 
b§_¡©us
 = 
	`BSA_MgtClo£
(&
b§_şo£_·¿m
);

174 if(
b§_¡©us
 !ğ
BSA_SUCCESS
)

176 
	`APP_ERROR1
("BSA_MgtClo£ faed stus:%d", 
b§_¡©us
);

180 
	}
}

193 
	$­p_mgt_kl_£rv”
()

195 
tBSA_MGT_KILL_SERVER
 
·¿m
;

197 if(
	`BSA_MgtKlS”v”In™
(&
·¿m
è=ğ
BSA_SUCCESS
)

199 if(
	`BSA_MgtKlS”v”
(&
·¿m
è=ğ
BSA_SUCCESS
)

206 
	}
}

	@source/app_common/app_mutex.c

14 
	~<¡dio.h
>

16 
	~<±h»ad.h
>

18 
	~"­p_mu‹x.h
"

31 
	$­p_š™_mu‹x
(
tAPP_MUTEX
 *
p_mu‹x
)

33 
¡©us
;

34 #ifdeà
__CYGWIN__


35 
±h»ad_mu‹x©Œ_t
 
©Œ
;

37 
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
);

38 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_NORMAL
);

39 
¡©us
 = 
	`±h»ad_mu‹x_š™
(
p_mu‹x
, &
©Œ
);

40 #–ià
	`defšed
(
__F»eBSD__
)

41 
	`mem£t
(
p_mu‹x
, 0, (
tAPP_MUTEX
));

42 
¡©us
 = 
	`±h»ad_mu‹x_š™
(&(
p_mu‹x
->
±h»ad_mu‹x
), 
NULL
);

44 
¡©us
 = 
	`±h»ad_mu‹x_š™
(
p_mu‹x
, 
NULL
);

46 ià(
¡©us
)

48 
	`³¼Ü
("app_init_mutex…thread_mutex_init failed Reason:");

49  
¡©us
;

52 #ià
	`defšed
(
__F»eBSD__
)

53 
¡©us
 = 
	`±h»ad_cÚd_š™
(&(
p_mu‹x
->
±h»ad_cÚd
), 
NULL
);

54 ià(
¡©us
)

56 
	`³¼Ü
("app_init_mutex…thread_cond_init failed Reason:");

57 
	`±h»ad_mu‹x_de¡roy
(&(
p_mu‹x
->
±h»ad_mu‹x
));

58  
¡©us
;

60 
p_mu‹x
->
couÁ
 = 1;

63  
¡©us
;

64 
	}
}

77 
	$­p_d–‘e_mu‹x
(
tAPP_MUTEX
 *
p_mu‹x
)

79 
¡©us
;

80 #ià
	`defšed
(
__F»eBSD__
)

81 
»t
 = 0;

83 
¡©us
 = 
	`±h»ad_mu‹x_de¡roy
(&(
p_mu‹x
->
±h»ad_mu‹x
));

84 ià(
¡©us
)

86 
	`³¼Ü
("app_delete_mutex…thread_mutex_destroy failure while destroying Reason:");

87 
»t
 = -1;

89 
¡©us
 = 
	`±h»ad_cÚd_de¡roy
(&(
p_mu‹x
->
±h»ad_cÚd
));

90 ià(
¡©us
)

92 
	`³¼Ü
("app_delete_mutex…thread_cond_destroy failure while destroying Reason:");

93 
»t
 = -1;

95 
p_mu‹x
->
couÁ
 = 0;

97 (
»t
);

99 
¡©us
 = 
	`±h»ad_mu‹x_de¡roy
(
p_mu‹x
);

100 ià(
¡©us
)

102 
	`³¼Ü
("app_delete_mutex…thread_mutex_destroy failure while destroying Reason:");

107 
	}
}

120 
	$­p_lock_mu‹x
(
tAPP_MUTEX
 *
p_mu‹x
)

122 
¡©us
;

125 #ià
	`defšed
(
__F»eBSD__
)

126 
¡©us
 = 
	`±h»ad_mu‹x_lock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

128 
¡©us
 = 
	`±h»ad_mu‹x_lock
(
p_mu‹x
);

130 ià(
¡©us
)

132 
	`³¼Ü
("app_lock_mutex…thread_mutex_lock failure Reason:");

135 #ià
	`defšed
(
__F»eBSD__
)

136 
p_mu‹x
->
couÁ
--;

137 ià(
p_mu‹x
->
couÁ
 < 0)

139 
¡©us
 = 
	`±h»ad_cÚd_wa™
(&(
p_mu‹x
->
±h»ad_cÚd
), &Õ_mu‹x->
±h»ad_mu‹x
));

140 ià(
¡©us
)

142 
	`³¼Ü
("app_lock_mutex…thread_cond_wait failure Reason:");

143 
	`±h»ad_mu‹x_uÆock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

147 
¡©us
 = 
	`±h»ad_mu‹x_uÆock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

148 ià(
¡©us
)

150 
	`³¼Ü
("app_lock_mutex…thread_unlock_mutex failure Reason:");

153  
¡©us
;

154 
	}
}

167 
	$­p_uÆock_mu‹x
(
tAPP_MUTEX
 *
p_mu‹x
)

169 
¡©us
;

172 #ià
	`defšed
(
__F»eBSD__
)

173 
¡©us
 = 
	`±h»ad_mu‹x_lock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

174 ià(
¡©us
)

176 
	`³¼Ü
("app_unlock_mutex…thread_mutex_lock failure Reason:");

179 
p_mu‹x
->
couÁ
++;

180 ià(
p_mu‹x
->
couÁ
 < 1) {

181 
¡©us
 = 
	`±h»ad_cÚd_sigÇl
(&(
p_mu‹x
->
±h»ad_cÚd
));

182 ià(
¡©us
)

184 
	`³¼Ü
("app_unlock_mutex…thread_cond_signal failure Reason:");

185 
	`±h»ad_mu‹x_uÆock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

189 
¡©us
 = 
	`±h»ad_mu‹x_uÆock
(&(
p_mu‹x
->
±h»ad_mu‹x
));

191 
¡©us
 = 
	`±h»ad_mu‹x_uÆock
(
p_mu‹x
);

193 ià(
¡©us
)

195 
	`³¼Ü
("app_unlock_mutex…thread_mutex_unlock failure Reason:");

197  
¡©us
;

198 
	}
}

	@source/app_common/app_playlist.c

12 
	~<¡dlib.h
>

13 
	~<ùy³.h
>

14 
	~<dœ’t.h
>

15 
	~<”ºo.h
>

17 
	~"­p_¶ayli¡.h
"

18 
	~"­p_uts.h
"

19 
	~"­p_wav.h
"

31 
BOOLEAN
 
	$­p_¶ayli¡_fe_suµÜ‹d
(cÚ¡ *
p_âame
)

33 *
p_ch¬
;

34 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

35 
low_ÿ£_ext
[10];

38 
p_ch¬
 = 
	`¡¼chr
(
p_âame
, '.');

41 ià(
p_ch¬
 !ğ
NULL
)

44 
p_ch¬
++;

46 
	`¡ºıy
(
low_ÿ£_ext
, 
p_ch¬
, (low_case_ext));

47 
low_ÿ£_ext
[(low_case_ext) - 1] = '\0';

49 
p_ch¬
 = &
low_ÿ£_ext
[0];

50 *
p_ch¬
 != '\0')

52 *
p_ch¬
 = 
	`tŞow”
(()*p_char);

53 
p_ch¬
++;

57 ià(!
	`¡rcmp
(
low_ÿ£_ext
, "wav"))

60 ià(
	`­p_wav_fÜm©
(
p_âame
, &
wav_fÜm©
) == 0)

62  
TRUE
;

64 
	`APP_ERROR1
("UÇbËØexŒaù WAV fÜm© from:%s", 
p_âame
);

67  
FALSE
;

68 
	}
}

80 
	$­p_¶ayli¡_ü—‹
(cÚ¡ *
p_·th
, ***
µp_¶ayli¡
)

82 #ià!
	`defšed
 (
BSA_ANDROID
è|| (BSA_ANDROID =ğ
FALSE
)

83 
DIR
 *
p_dœeùÜy
;

84 
dœ’t
 *
p_dœeùÜy_’Œy
;

85 **
µ_¶ayli¡
 = 
NULL
;

86 
nb_’Œy
 = 0;

87 
šdex
;

88 
fuÎ_·th
[1000];

91 ià(
µp_¶ayli¡
 =ğ
NULL
)

93 
	`APP_ERROR0
("app_create_play_list…pp_playlist NULL");

97 
p_dœeùÜy
 = 
	`İ’dœ
(
p_·th
);

98 ià(
p_dœeùÜy
 =ğ
NULL
)

100 
	`APP_ERROR1
("İ’dœ(%sèçed: %d", 
p_·th
, 
”ºo
);

101 
	`³¼Ü
("app_create_play_list:");

108 
p_dœeùÜy_’Œy
 = 
	`»addœ
(
p_dœeùÜy
);

109 ià(
p_dœeùÜy_’Œy
 !ğ
NULL
)

111 
	`¢´štf
(
fuÎ_·th
, (fuÎ_·th), "%s/%s", 
p_·th
, 
p_dœeùÜy_’Œy
->
d_Çme
);

113 ià(
	`­p_¶ayli¡_fe_suµÜ‹d
(
fuÎ_·th
))

116 
µ_¶ayli¡
 = 
	`»®loc
Õp_¶ayli¡, (
nb_’Œy
 + 1) * (*));

117 ià(
µ_¶ayli¡
 =ğ
NULL
)

119 
	`APP_ERROR1
("»®loøçed: %d", 
”ºo
);

120 
	`şo£dœ
(
p_dœeùÜy
);

124 
	`APP_DEBUG1
("New fAudiØffound:%s", 
p_dœeùÜy_’Œy
->
d_Çme
);

126 
šdex
 = 
	`¡¾’
(
fuÎ_·th
);

127 
µ_¶ayli¡
[
nb_’Œy
] = 
	`m®loc
(
šdex
 + 1);

129 
	`¡ºıy
(
µ_¶ayli¡
[
nb_’Œy
], 
fuÎ_·th
, 
šdex
);

131 
µ_¶ayli¡
[
nb_’Œy
][
šdex
] = 0;

133 
nb_’Œy
++;

136 
	`£ekdœ
(
p_dœeùÜy
, 
	`‹Îdœ
(p_directory));

138 } 
p_dœeùÜy_’Œy
 !ğ
NULL
);

141 
	`şo£dœ
(
p_dœeùÜy
);

143 
	`­p_¶ayli¡_sÜt
(
µ_¶ayli¡
, 
nb_’Œy
);

146 *
µp_¶ayli¡
 = 
µ_¶ayli¡
;

148  
nb_’Œy
;

152 
	}
}

163 
	$­p_¶ayli¡_ä“
(**
µ_¶ayli¡
)

165 
šdex
;

167 ià(
µ_¶ayli¡
 !ğ
NULL
)

169 
šdex
 = 0 ; 
µ_¶ayli¡
[šdex] !ğ
NULL
 ; index++)

171 
	`ä“
(
µ_¶ayli¡
[
šdex
]);

174 
	`ä“
(
µ_¶ayli¡
);

175 
	}
}

186 
	$­p_¶ayli¡_sÜt
(**
µ_¶ayli¡
, 
nb_’Œy
)

188 
sw­³d
;

189 
šdex
;

190 *
p_tmp
;

193 ià(
µ_¶ayli¡
 =ğ
NULL
)

201 
sw­³d
 = 0;

204 
šdex
 = 0 ; index < (
nb_’Œy
 - 1); index++)

207 ià(
	`¡rcmp
(
µ_¶ayli¡
[
šdex
],…p_playlist[index + 1]) > 0)

210 
p_tmp
 = 
µ_¶ayli¡
[
šdex
];

211 
µ_¶ayli¡
[
šdex
] =…p_playlist[index + 1];

212 
µ_¶ayli¡
[
šdex
 + 1] = 
p_tmp
;

213 
sw­³d
 = 1;

217 } 
sw­³d
 == 1);

218 
	}
}

	@source/app_common/app_services.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<uni¡d.h
>

17 
	~"b§_­i.h
"

19 
	~"­p_£rviûs.h
"

24 
	g£rviûs_¡ršg
[
BSA_MAX_SERVICE_ID
 * 7];

37 cÚ¡ *
	$­p_£rviû_id_to_¡ršg
(
tBSA_SERVICE_ID
 
£rviûId
)

39 
£rviûId
)

41 
BSA_RES_SERVICE_ID
:

43 
BSA_SPP_SERVICE_ID
:

45 
BSA_DUN_SERVICE_ID
:

47 
BSA_A2DP_SRC_SERVICE_ID
:

49 
BSA_AVRCP_TG_SERVICE_ID
:

51 
BSA_HSP_SERVICE_ID
:

53 
BSA_HFP_SERVICE_ID
:

55 
BSA_OPP_SERVICE_ID
:

57 
BSA_FTP_SERVICE_ID
:

59 
BSA_CTP_SERVICE_ID
:

61 
BSA_ICP_SERVICE_ID
:

63 
BSA_SYNC_SERVICE_ID
:

65 
BSA_BPP_SERVICE_ID
:

67 
BSA_BIP_SERVICE_ID
:

69 
BSA_PANU_SERVICE_ID
:

71 
BSA_NAP_SERVICE_ID
:

73 
BSA_GN_SERVICE_ID
:

75 
BSA_SAP_SERVICE_ID
:

77 
BSA_A2DP_SERVICE_ID
:

79 
BSA_AVRCP_SERVICE_ID
:

81 
BSA_HID_SERVICE_ID
:

83 
BSA_HID_DEVICE_SERVICE_ID
:

85 
BSA_VDP_SERVICE_ID
:

87 
BSA_PBAP_SERVICE_ID
:

89 
BSA_HFP_HS_SERVICE_ID
:

91 
BSA_HSP_HS_SERVICE_ID
:

93 
BSA_MAP_SERVICE_ID
:

95 
BSA_HL_SERVICE_ID
:

97 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

98 
BSA_BLE_SERVICE_ID
:

105 
	}
}

118 *
	$­p_£rviû_mask_to_¡ršg
(
tBSA_SERVICE_MASK
 
£rviûMask
)

121 
	`mem£t
(
£rviûs_¡ršg
, 0, (services_string));

123 ià(
£rviûMask
 & 
BSA_RES_SERVICE_MASK
)

124 
	`¡ºÿt
(
£rviûs_¡ršg
, "RESERVED!!! ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

125 ià(
£rviûMask
 & 
BSA_SPP_SERVICE_MASK
)

126 
	`¡ºÿt
(
£rviûs_¡ršg
, "SPP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

127 ià(
£rviûMask
 & 
BSA_DUN_SERVICE_MASK
)

128 
	`¡ºÿt
(
£rviûs_¡ršg
, "DUN ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

129 ià(
£rviûMask
 & 
BSA_A2DP_SRC_SERVICE_MASK
)

130 
	`¡ºÿt
(
£rviûs_¡ršg
, "A2DP_SRC ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

131 ià(
£rviûMask
 & 
BSA_AVRCP_TG_SERVICE_MASK
)

132 
	`¡ºÿt
(
£rviûs_¡ršg
, "AVRCP_TG ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

133 ià(
£rviûMask
 & 
BSA_HSP_SERVICE_MASK
)

134 
	`¡ºÿt
(
£rviûs_¡ršg
, "HSP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

135 ià(
£rviûMask
 & 
BSA_HFP_SERVICE_MASK
)

136 
	`¡ºÿt
(
£rviûs_¡ršg
, "HFP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

137 ià(
£rviûMask
 & 
BSA_OPP_SERVICE_MASK
)

138 
	`¡ºÿt
(
£rviûs_¡ršg
, "OPP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

139 ià(
£rviûMask
 & 
BSA_FTP_SERVICE_MASK
)

140 
	`¡ºÿt
(
£rviûs_¡ršg
, "FTP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

141 ià(
£rviûMask
 & 
BSA_CTP_SERVICE_MASK
)

142 
	`¡ºÿt
(
£rviûs_¡ršg
, "CTP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

143 ià(
£rviûMask
 & 
BSA_ICP_SERVICE_MASK
)

144 
	`¡ºÿt
(
£rviûs_¡ršg
, "ICP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

145 ià(
£rviûMask
 & 
BSA_SYNC_SERVICE_MASK
)

146 
	`¡ºÿt
(
£rviûs_¡ršg
, "SYNC ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

147 ià(
£rviûMask
 & 
BSA_BPP_SERVICE_MASK
)

148 
	`¡ºÿt
(
£rviûs_¡ršg
, "BPP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

149 ià(
£rviûMask
 & 
BSA_BIP_SERVICE_MASK
)

150 
	`¡ºÿt
(
£rviûs_¡ršg
, "BIP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

151 ià(
£rviûMask
 & 
BSA_PANU_SERVICE_MASK
)

152 
	`¡ºÿt
(
£rviûs_¡ršg
, "PANU ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

153 ià(
£rviûMask
 & 
BSA_NAP_SERVICE_MASK
)

154 
	`¡ºÿt
(
£rviûs_¡ršg
, "NAP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

155 ià(
£rviûMask
 & 
BSA_GN_SERVICE_MASK
)

156 
	`¡ºÿt
(
£rviûs_¡ršg
, "GN ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

157 ià(
£rviûMask
 & 
BSA_SAP_SERVICE_MASK
)

158 
	`¡ºÿt
(
£rviûs_¡ršg
, "SAP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

159 ià(
£rviûMask
 & 
BSA_A2DP_SERVICE_MASK
)

160 
	`¡ºÿt
(
£rviûs_¡ršg
, "A2DP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

161 ià(
£rviûMask
 & 
BSA_AVRCP_SERVICE_MASK
)

162 
	`¡ºÿt
(
£rviûs_¡ršg
, "AVRCP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

163 ià(
£rviûMask
 & 
BSA_HID_SERVICE_MASK
)

164 
	`¡ºÿt
(
£rviûs_¡ršg
, "HID ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

165 ià(
£rviûMask
 & 
BSA_HID_DEVICE_SERVICE_MASK
)

166 
	`¡ºÿt
(
£rviûs_¡ršg
, "HID_DEVICE ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

167 ià(
£rviûMask
 & 
BSA_VDP_SERVICE_MASK
)

168 
	`¡ºÿt
(
£rviûs_¡ršg
, "VDP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

169 ià(
£rviûMask
 & 
BSA_PBAP_SERVICE_MASK
)

170 
	`¡ºÿt
(
£rviûs_¡ršg
, "PBAP ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

171 ià(
£rviûMask
 & 
BSA_HSP_HS_SERVICE_MASK
)

172 
	`¡ºÿt
(
£rviûs_¡ršg
, "HSP_HS ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

173 ià(
£rviûMask
 & 
BSA_HFP_HS_SERVICE_MASK
)

174 
	`¡ºÿt
(
£rviûs_¡ršg
, "HFP_HS ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

175 ià(
£rviûMask
 & 
BSA_MAS_SERVICE_MASK
)

176 
	`¡ºÿt
(
£rviûs_¡ršg
, "MAS ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

177 ià(
£rviûMask
 & 
BSA_MN_SERVICE_MASK
)

178 
	`¡ºÿt
(
£rviûs_¡ršg
, "NN ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

179 ià(
£rviûMask
 & 
BSA_HL_SERVICE_MASK
)

180 
	`¡ºÿt
(
£rviûs_¡ršg
, "HL ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

181 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

182 ià(
£rviûMask
 & 
BSA_BLE_SERVICE_MASK
)

183 
	`¡ºÿt
(
£rviûs_¡ršg
, "BLE ", (£rviûs_¡ršgè- 
	`¡¾’
(services_string) - 1);

185  
£rviûs_¡ršg
;

186 
	}
}

	@source/app_common/app_thread.c

12 
	~<¡dio.h
>

13 
	~<¡ršg.h
>

14 
	~<±h»ad.h
>

15 
	~<”ºo.h
>

16 
	~<sigÇl.h
>

18 
	~"b§_­i.h
"

20 
	~"­p_th»ad.h
"

21 
	~"­p_uts.h
"

23 *(*
	tPTHREAD_ENTRY
)(*);

40 
	$­p_ü—‹_th»ad
(
APP_THREAD_ENTRY
 
sk_’Œy
, 
UINT16
 *
¡ack
, UINT16 
¡acksize
, 
tAPP_THREAD
 *
p_th»ad
)

42 
±h»ad_©Œ_t
 
th»ad_©Œ
;

44 
	`±h»ad_©Œ_š™
(&
th»ad_©Œ
);

46 
	`±h»ad_©Œ_£td‘ach¡©e
(&
th»ad_©Œ
, 
PTHREAD_CREATE_DETACHED
);

48 ià(
	`±h»ad_ü—‹
(
p_th»ad
, &
th»ad_©Œ
, (
PTHREAD_ENTRY
)
sk_’Œy
, 
NULL
) < 0 )

50 
	`APP_ERROR1
("±h»ad_ü—‹ faed:%d", 
”ºo
);

54 
	}
}

67 
	$­p_¡İ_th»ad
(
tAPP_THREAD
 
th»ad
)

69 #ià!
	`defšed
(
BSA_ANDROID
è|| (BSA_ANDROID =ğ
FALSE
)

70 ià(
	`±h»ad_ÿnûl
(
th»ad
) < 0)

72 
	`APP_ERROR1
("±h»ad_ÿnûÈçed:%d", 
”ºo
);

77 
	}
}

	@source/app_common/app_utils.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<uni¡d.h
>

16 
	~<¡d¬g.h
>

17 
	~<time.h
>

18 
	~<sys/time.h
>

19 
	~<sys/¡©.h
>

21 
	~"b§_­i.h
"

23 
	~"­p_xml_·¿m.h
"

24 
	~"­p_uts.h
"

30 
	#RESET
 0

	)

31 
	#BRIGHT
 1

	)

32 
	#DIM
 2

	)

33 
	#UNDERLINE
 3

	)

34 
	#BLINK
 4

	)

35 
	#REVERSE
 7

	)

36 
	#HIDDEN
 8

	)

39 
	#BLACK
 0

	)

40 
	#RED
 1

	)

41 
	#GREEN
 2

	)

42 
	#YELLOW
 3

	)

43 
	#BLUE
 4

	)

44 
	#MAGENTA
 5

	)

45 
	#CYAN
 6

	)

46 
	#WHITE
 7

	)

49 
	#APP_TIMESTAMP_LEN
 80

	)

54 #ifdeà
APP_TRACE_COLOR


55 
­p_£t_Œaû_cŞÜ
(
©Œ
, 
fg
, 
bg
);

57 #ifdeà
APP_TRACE_TIMESTAMP


58 *
­p_g‘_time_¡amp
(*
p_bufãr
, 
bufãr_size
);

72 *
	$­p_g‘_cod_¡ršg
(cÚ¡ 
DEV_CLASS
 
şass_of_deviû
)

74 
UINT8
 
majÜ
;

77 
	`BTM_COD_MAJOR_CLASS
(
majÜ
, 
şass_of_deviû
);

79 
majÜ
)

81 
BTM_COD_MAJOR_MISCELLANEOUS
:

84 
BTM_COD_MAJOR_COMPUTER
:

87 
BTM_COD_MAJOR_PHONE
:

90 
BTM_COD_MAJOR_LAN_ACCESS_PT
:

93 
BTM_COD_MAJOR_AUDIO
:

96 
BTM_COD_MAJOR_PERIPHERAL
:

99 
BTM_COD_MAJOR_IMAGING
:

102 
BTM_COD_MAJOR_WEARABLE
:

105 
BTM_COD_MAJOR_TOY
:

108 
BTM_COD_MAJOR_HEALTH
:

115  
NULL
;

116 
	}
}

131 
	$­p_g‘_choiû
(cÚ¡ *
qu”y¡ršg
)

133 
Ãg
, 
v®ue
, 
c
, 
ba£
;

134 
couÁ
 = 0;

136 
ba£
 = 10;

137 
Ãg
 = 1;

138 
	`´štf
("% => ", 
qu”y¡ršg
);

139 
v®ue
 = 0;

142 
c
 = 
	`g‘ch¬
();

144 ià((
couÁ
 =ğ0è&& (
c
 == '\n'))

148 
couÁ
 ++;

150 ià((
c
 >= '0') && (c <= '9'))

152 
v®ue
 = (v®u* 
ba£
è+ (
c
 - '0');

154 ià((
c
 >= 'a') && (c <= 'f'))

156 
v®ue
 = (v®u* 
ba£
è+ (
c
 - 'a' + 10);

158 ià((
c
 >= 'A') && (c <= 'F'))

160 
v®ue
 = (v®u* 
ba£
è+ (
c
 - 'A' + 10);

162 ià(
c
 == '-')

164 
Ãg
 *= -1;

166 ià(
c
 == 'x')

168 
ba£
 = 16;

171 } (
c
 !ğ
EOF
) && (c != '\n'));

173  
v®ue
 * 
Ãg
;

174 
	}
}

190 
	$­p_g‘_¡ršg
(cÚ¡ *
qu”y¡ršg
, *
¡r
, 
Ën
)

192 
c
, 
šdex
;

194 ià(
qu”y¡ršg
)

196 
	`´štf
("% => ", 
qu”y¡ršg
);

199 
šdex
 = 0;

202 
c
 = 
	`g‘ch¬
();

203 ià(
c
 =ğ
EOF
)

207 ià((
c
 !ğ'\n'è&& (
šdex
 < (
Ën
 - 1)))

209 
¡r
[
šdex
] = ()
c
;

210 
šdex
++;

212 } 
c
 != '\n');

214 
¡r
[
šdex
] = '\0';

215  
šdex
;

216 
	}
}

218 #ifdeà
APP_TRACE_TIMESTAMP


231 *
	$­p_g‘_time_¡amp
(*
p_bufãr
, 
bufãr_size
)

233 
time_¡ršg
[80];

236 
	`GKI_g‘_time_¡amp
((
INT8
 *)
time_¡ršg
);

238 
	`¢´štf
(
p_bufãr
, 
bufãr_size
, "%s", 
time_¡ršg
);

240  
p_bufãr
;

241 
	}
}

256 
	$­p_´št_šfo
(*
fÜm©
, ...)

258 
va_li¡
 
­
;

259 #ifdeà
APP_TRACE_TIMESTAMP


260 
time_¡amp
[
APP_TIMESTAMP_LEN
];

263 #ifdeà
APP_TRACE_COLOR


264 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
BLACK
, 
WHITE
);

267 #ifdeà
APP_TRACE_TIMESTAMP


268 
	`­p_g‘_time_¡amp
(
time_¡amp
, (time_stamp));

269 
	`´štf
("INFO@%s: ", 
time_¡amp
);

272 
	`va_¡¬t
(
­
, 
fÜm©
);

273 
	`v´štf
(
fÜm©
,
­
);

274 
	`va_’d
(
­
);

276 #ifdeà
APP_TRACE_COLOR


277 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
BLACK
, 
WHITE
);

279 
	}
}

293 
	$­p_´št_debug
(*
fÜm©
, ...)

295 
va_li¡
 
­
;

296 #ifdeà
APP_TRACE_TIMESTAMP


297 
time_¡amp
[
APP_TIMESTAMP_LEN
];

300 #ifdeà
APP_TRACE_COLOR


301 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
GREEN
, 
WHITE
);

304 #ifdeà
APP_TRACE_TIMESTAMP


305 
	`­p_g‘_time_¡amp
(
time_¡amp
, (time_stamp));

306 
	`´štf
("DEBUG@%s: ", 
time_¡amp
);

308 
	`´štf
("DEBUG: ");

311 
	`va_¡¬t
(
­
, 
fÜm©
);

312 
	`v´štf
(
fÜm©
,
­
);

313 
	`va_’d
(
­
);

315 #ifdeà
APP_TRACE_COLOR


316 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
BLACK
, 
WHITE
);

318 
	}
}

332 
	$­p_´št_”rÜ
(*
fÜm©
, ...)

334 
va_li¡
 
­
;

335 #ifdeà
APP_TRACE_TIMESTAMP


336 
time_¡amp
[
APP_TIMESTAMP_LEN
];

339 #ifdeà
APP_TRACE_COLOR


340 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
RED
, 
WHITE
);

343 #ifdeà
APP_TRACE_TIMESTAMP


344 
	`­p_g‘_time_¡amp
(
time_¡amp
, (time_stamp));

345 
	`´štf
("ERROR@%s: ", 
time_¡amp
);

347 
	`´štf
("ERROR: ");

350 
	`va_¡¬t
(
­
, 
fÜm©
);

351 
	`v´štf
(
fÜm©
,
­
);

352 
	`va_’d
(
­
);

354 #ifdeà
APP_TRACE_COLOR


355 
	`­p_£t_Œaû_cŞÜ
(
RESET
, 
BLACK
, 
WHITE
);

357 
	}
}

359 #ifdeà
APP_TRACE_COLOR


373 
	$­p_£t_Œaû_cŞÜ
(
©Œibu‹
, 
fÜeground
, 
background
)

375 
commªd
[13];

378 
	`¢´štf
(
commªd
, (commªd), "%c[%d;%d;%dm", 0x1B, 
©Œibu‹
, 
fÜeground
 + 30, 
background
 + 40);

379 
	`´štf
("%s", 
commªd
);

380 
	}
}

394 
	$­p_fe_size
(
fd
)

396 
¡©
 
fe_¡©
;

397 
rc
 = -1;

399 
rc
 = 
	`f¡©
(
fd
, &
fe_¡©
);

401 ià(
rc
 >= 0)

404 
rc
 = 
fe_¡©
.
¡_size
;

408 
	`APP_ERROR1
("could‚Ù f¡©(fd=%d)", 
fd
);

410  
rc
;

411 
	}
}

424 
UINT8
 
	$­p_hex_ch¬
(
UINT8
 
c
)

426 ià(
c
 >= 'a')

428  (
c
 - 'a' + 10);

430 ià(
c
 >= 'A')

432  (
c
 - 'A' + 10);

436  (
c
 - '0');

439 
	}
}

455 
	$­p_hex_cÚv”t
(
UINT8
 *
p_ty³
, 
UINT16
 *
p_off£t
, UINT8 *
p_d©a
, UINT16 *
p_Ën
)

457 
r_šdex
, 
w_šdex
, 
size
;

458 
UINT8
 
checksum
;

459 
mš_Ën
;

461 
mš_Ën
 = (
	`¡¾’
((*)
p_d©a
è< *
p_Ën
)?strlen((*)p_data):*p_len;

463 ià(
mš_Ën
 < 11)

465 
	`APP_ERROR0
("Recordoo short");

468 ià(
p_d©a
[0] != ':')

470 
	`APP_ERROR0
("Record does‚ot start with colon character");

475 
r_šdex
 = 1;

476 
w_šdex
 = 0;

477 
p_d©a
[
r_šdex
] != 0)

479 ià((
r_šdex
 % 2) == 0)

481 
p_d©a
[
w_šdex
] = 
	`­p_hex_ch¬
Õ_d©a[
r_šdex
-1]) * 16;

482 
p_d©a
[
w_šdex
] +ğ
	`­p_hex_ch¬
Õ_d©a[
r_šdex
]);

483 
w_šdex
++;

485 
r_šdex
++;

489 
size
 = 
p_d©a
[0] + 5;

491 ià(
size
 > 
w_šdex
)

493 
	`APP_ERROR1
("LšËngth (%dèi sm®Ë¸thª„ecÜd d©¨siz(%d)", 
w_šdex
, 
size
);

497 *
p_Ën
 = 
p_d©a
[0];

498 *
p_off£t
 = (
p_d©a
[1] * 256) +…_data[2];

499 *
p_ty³
 = 
p_d©a
[3];

501 
checksum
 = 0, 
w_šdex
 = 0, 
r_šdex
 = 0;„_šdex < 
size
;„_index++)

503 
checksum
 +ğ
p_d©a
[
r_šdex
];

504 ià(
r_šdex
 > 3)

506 
p_d©a
[
w_šdex
++] =…_d©a[
r_šdex
];

510 ià(
checksum
 != 0)

512 
	`APP_ERROR0
("record CRC failed");

516 
	}
}

533 
	$­p_hex_»ad
(
FILE
 *
p_fe
, 
UINT8
 *
p_ty³
, 
UINT16
 *
p_off£t
, UINT8 *
p_d©a
, UINT16 *
p_Ën
)

535 ià(
	`fg‘s
((*)
p_d©a
, *
p_Ën
, 
p_fe
è=ğ
NULL
)

541  
	`­p_hex_cÚv”t
(
p_ty³
, 
p_off£t
, 
p_d©a
, 
p_Ën
);

542 
	}
}

	@source/app_common/app_wav.c

13 
	~<¡dio.h
>

14 
	~<sys/ty³s.h
>

15 
	~<sys/¡©.h
>

16 
	~<uni¡d.h
>

17 
	~<fú.h
>

18 
	~<¡ršg.h
>

19 
	~<”ºo.h
>

21 
	~"­p_uts.h
"

22 
	~"­p_wav.h
"

26 
BOOLEAN
 
	mis_be
;

27 } 
	ttAPP_WAV_CB
;

29 
tAPP_WAV_CB
 
	g­p_wav_cb
 =

31 
FALSE


34 
	#APP_WAVE_HDR_SIZE
 44

	)

36 cÚ¡ 
	g­p_wav_hdr
[
APP_WAVE_HDR_SIZE
] =

65 
	$­p_wav_fÜm©
(cÚ¡ *
p_âame
, 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
)

67 
fd
;

69 
fd
 = 
	`­p_wav_İ’_fe
(
p_âame
, 
p_fÜm©
);

71 ià(
fd
 >= 0)

73 
	`şo£
(
fd
);

78 
	}
}

94 
	$­p_wav_»ad_d©a
(
fd
, cÚ¡ 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
, *
p_d©a
, 
Ën
)

96 
nby‹s
;

97 
šdex
;

98 
by‹s_³r_§m¶e
 = (
p_fÜm©
->
b™s_³r_§m¶e
 + 7)/8;

99 
tmp16
;

100 *
tmp16_±r
;

101 
tmp32
;

102 *
tmp32_±r
;

104 
nby‹s
 = 
	`»ad
(
fd
, 
p_d©a
, 
Ën
);

107 ià(((
by‹s_³r_§m¶e
 =ğ2è&& ((
size_t
)
p_d©a
 & 1)) ||

108 ((
by‹s_³r_§m¶e
 =ğ4è&& ((
size_t
)
p_d©a
 & 3)))

110 
	`APP_DEBUG1
("Audio buffer start is‚ot‡ligned on PCM sample (%d bytes) word boundary,his could degrade system…erf (%p)",

111 
by‹s_³r_§m¶e
, 
p_d©a
);

114 ià(
nby‹s
 > 0 && 
p_fÜm©
->
codec
 =ğ
BSA_AV_CODEC_PCM
)

116 
by‹s_³r_§m¶e
)

121 ià(
nby‹s
 & 1)

123 
	`APP_DEBUG1
("Numb” oàPCM sam¶e »ad‚Ù muÉË oà§m¶size(%d)", 
by‹s_³r_§m¶e
);

125 ià(
­p_wav_cb
.
is_be
)

127 
tmp16_±r
 = (*)
p_d©a
;

128 
šdex
 = 0; index < 
nby‹s
; index += 2)

130 
tmp16
 = *
tmp16_±r
;

131 *
tmp16_±r
 = (
tmp16
 << 8 |mp16 >> 8);

132 
tmp16_±r
++;

137 ià(
nby‹s
 & 3)

139 
	`APP_DEBUG1
("Numb” oàPCM sam¶e »ad‚Ù muÉË oà§m¶size(%d)", 
by‹s_³r_§m¶e
);

141 ià(
­p_wav_cb
.
is_be
)

143 
tmp32_±r
 = (*)
p_d©a
;

144 
šdex
 = 0; index < 
nby‹s
; index += 4)

146 
tmp32
 = *
tmp32_±r
;

147 *
tmp32_±r
 = (
tmp32
 >> 24) |

148 ((
tmp32
 >> 8) & 0xff00) |

149 ((
tmp32
 << 8) & 0xff0000) |

150 ((
tmp32
 << 24) & 0xff000000);

151 
tmp32_±r
++;

156 
	`APP_ERROR1
("Sam¶sizi nÙ suµÜ‹d (%d)", 
by‹s_³r_§m¶e
);

160  
nby‹s
;

161 
	}
}

175 
	$­p_wav_İ’_fe
(cÚ¡ *
p_âame
, 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
)

177 
fd
;

178 
ssize_t
 
tÙ®size
;

179 
ssize_t
 
size
;

180 
riff
[12];

181 
fmt_·¿ms
[40];

182 
d©a
[8];

183 
off_t
 
fe_size
;

184 
¡©
 
¡©_šfo
;

185 
tmpU32
;

186 
tmpU16
;

189 
tmpU32
 = 1;

190 ià(*((*)(&
tmpU32
)è=ğ0è
­p_wav_cb
.
is_be
 = 
TRUE
;

192 ià(
p_fÜm©
 =ğ
NULL
)

194 
	`APP_ERROR0
("format is NULL");

197 ià(
p_âame
 =ğ
NULL
)

199 
	`APP_ERROR0
("no filename");

202 ià((
fd
 = 
	`İ’
(
p_âame
, 
O_RDONLY
)) < 0)

204 
	`APP_ERROR1
("İ’(%sèçed: %d", 
p_âame
, 
”ºo
);

207 ià(
	`f¡©
(
fd
, &
¡©_šfo
) < 0)

209 
	`APP_ERROR1
("¡©(%sèçed: %d", 
p_âame
, 
”ºo
);

210 
­p_wav_İ’_fe_”rÜ
;

212 
fe_size
 = 
¡©_šfo
.
¡_size
;

216 
size
 = 
	`»ad
(
fd
, 
riff
, (riff));

217 ià(
size
 < 0)

219 
	`APP_ERROR1
("»ad(%sèçed: %d", 
p_âame
, 
”ºo
);

220 
­p_wav_İ’_fe_”rÜ
;

223 ià(
size
 !ğ(
riff
))

225 
	`APP_ERROR1
("L’gth„—d dÛ nÙ m©ch RIFF h—d” (%d !ğ%d)", ()
size
, (
riff
));

226 
­p_wav_İ’_fe_”rÜ
;

230 ià(
	`memcmp
(&
riff
[0], "RIFF", 4))

232 
	`APP_ERROR0
("RIFF‚ot found");

233 
­p_wav_İ’_fe_”rÜ
;

237 
tmpU32
 = 
riff
[4];

238 
tmpU32
 |ğ(
riff
[5] << 8);

239 
tmpU32
 |ğ(
riff
[6] << 16);

240 
tmpU32
 |ğ(è(
riff
[7] << 24);

243 ià((
tmpU32
 + 8è!ğ(
UINT32
)
fe_size
)

245 
	`APP_DEBUG1
("WARNING: RIFF chunk siz(%lu + 8èdÛ nÙ m©ch fsize(%lu)", 
tmpU32
, 
fe_size
);

249 ià(
	`memcmp
(&
riff
[8], "WAVE", 4))

251 
	`APP_ERROR0
("WAVE‚ot found");

252 
­p_wav_İ’_fe_”rÜ
;

256 
tÙ®size
 = 12;

259 
p_fÜm©
->
§m¶e_¿‹
 = 0;

265 
size
 = 
	`»ad
(
fd
, 
d©a
, (data));

266 ià(
size
 < 0)

268 
	`APP_ERROR1
("»ad(%sèçed: %d", 
p_âame
, 
”ºo
);

269 
­p_wav_İ’_fe_”rÜ
;

271 ià(
size
 !ğ(
d©a
))

273 
	`APP_ERROR1
("L’gth„—d dÛ nÙ m©ch h—d” (%d !ğ%d)", ()
size
, (
d©a
));

274 
­p_wav_İ’_fe_”rÜ
;

278 
tmpU32
 = 
d©a
[4];

279 
tmpU32
 |ğ(
d©a
[5] << 8);

280 
tmpU32
 |ğ(
d©a
[6] << 16);

281 
tmpU32
 |ğ(è(
d©a
[7] << 24);

283 
tÙ®size
 +ğ8 + 
tmpU32
;

286 ià(!
	`memcmp
(&
d©a
[0], "fmt ", 4))

288 ià((
tmpU32
 != 16) && (tmpU32 != 18) && (tmpU32 != 40))

290 
	`APP_DEBUG1
("WARNING: fÜm© chunk sizi nÙ suµÜ‹d (%lu !ğ(16, 18, 40))", 
tmpU32
);

291 
­p_wav_İ’_fe_”rÜ
;

295 
size
 = 
	`»ad
(
fd
, 
fmt_·¿ms
, 
tmpU32
);

296 ià(
size
 < 0)

298 
	`APP_ERROR1
("»ad(%sèçed: %d", 
p_âame
, 
”ºo
);

299 
­p_wav_İ’_fe_”rÜ
;

301 ià((
UINT32
)
size
 !ğ
tmpU32
)

303 
	`APP_ERROR1
("L’gth„—d dÛ nÙ m©ch FMT…¬am (%d !ğ%d)", ()
size
, ()
tmpU32
);

304 
­p_wav_İ’_fe_”rÜ
;

308 
tmpU16
 = 
fmt_·¿ms
[0];

309 
tmpU16
 |ğ(
fmt_·¿ms
[1] << 8);

312 ià(
tmpU16
 == 0x01)

314 
p_fÜm©
->
codec
 = 
BSA_AV_CODEC_PCM
;

316 ià(
tmpU16
 == 0x25)

318 
p_fÜm©
->
codec
 = 
BSA_AV_CODEC_APTX
;

322 
	`APP_ERROR1
("WAV‡udiØfÜm© i nÙ suµÜ‹d (%u)", 
tmpU16
);

323 
­p_wav_İ’_fe_”rÜ
;

327 
tmpU16
 = 
fmt_·¿ms
[2];

328 
tmpU16
 |ğ(
fmt_·¿ms
[3] << 8);

331 ià(
p_fÜm©
->
codec
 =ğ
BSA_AV_CODEC_APTX
)

333 ià(
tmpU16
 > 3)

335 
	`APP_ERROR1
("numb” oàchªÃl nÙ suµÜ‹d iÀ­t-X (%u)", 
tmpU16
);

336 
­p_wav_İ’_fe_”rÜ
;

338 ià(
tmpU16
 > 1)

340 
p_fÜm©
->
¡”eo_mode
 = 
tmpU16
;

341 
tmpU16
 = 2;

344 ià(
tmpU16
 > 2)

346 
	`APP_ERROR1
("bad‚umb” oàchªÃl nÙ suµÜ‹d (%u)", 
tmpU16
);

347 
­p_wav_İ’_fe_”rÜ
;

349 
p_fÜm©
->
nb_chªÃls
 = 
tmpU16
;

352 
tmpU32
 = 
fmt_·¿ms
[4];

353 
tmpU32
 |ğ(
fmt_·¿ms
[5] << 8);

354 
tmpU32
 |ğ(
fmt_·¿ms
[6] << 16);

355 
tmpU32
 |ğ(è(
fmt_·¿ms
[7] << 24);

356 
p_fÜm©
->
§m¶e_¿‹
 = 
tmpU32
;

359 
tmpU16
 = 
fmt_·¿ms
[14];

360 
tmpU16
 |ğ(
fmt_·¿ms
[15] << 8);

361 
p_fÜm©
->
b™s_³r_§m¶e
 = 
tmpU16
;

364 
tmpU32
 = 
fmt_·¿ms
[8];

365 
tmpU32
 |ğ(
fmt_·¿ms
[9] << 8);

366 
tmpU32
 |ğ(
fmt_·¿ms
[10] << 16);

367 
tmpU32
 |ğ()(
fmt_·¿ms
[11] << 24);

369 ià(
tmpU32
 !ğ(
p_fÜm©
->
§m¶e_¿‹
 *…_fÜm©->
nb_chªÃls
 *…_fÜm©->
b™s_³r_§m¶e
 / 8))

371 
	`APP_DEBUG1
("WARNING: byte„ate does‚ot match PCM„ate calculation (%lu != (%lu * %u * %u / 8))",

372 
tmpU32
, 
p_fÜm©
->
§m¶e_¿‹
,…_fÜm©->
nb_chªÃls
,…_fÜm©->
b™s_³r_§m¶e
);

376 
tmpU16
 = 
fmt_·¿ms
[12];

377 
tmpU16
 |ğ(
fmt_·¿ms
[13] << 8);

379 ià(
tmpU16
 !ğ(
p_fÜm©
->
nb_chªÃls
 *…_fÜm©->
b™s_³r_§m¶e
 / 8))

381 
	`APP_ERROR1
("Block‡lignment does‚ot match calculation (%u != (%u * %u / 8))",

382 
tmpU16
, 
p_fÜm©
->
nb_chªÃls
,…_fÜm©->
b™s_³r_§m¶e
);

383 
­p_wav_İ’_fe_”rÜ
;

386 ià(!
	`memcmp
(&
d©a
[0], "fact", 4))

388 ià(
tmpU32
 > 8)

390 
	`APP_ERROR1
("FACT chunk sizi nÙ suµÜ‹d (%d)", ()
tmpU32
);

391 
­p_wav_İ’_fe_”rÜ
;

395 
size
 = 
	`»ad
(
fd
, 
d©a
, 
tmpU32
);

396 ià(
size
 < 0)

398 
	`APP_ERROR1
("»ad(%sèçed: %d", 
p_âame
, 
”ºo
);

399 
­p_wav_İ’_fe_”rÜ
;

401 ià(()
size
 !ğ
tmpU32
)

403 
	`APP_ERROR1
("L’gth„—d dÛ nÙ m©ch FACT chunk (%d !ğ%d)", ()
size
, (
d©a
));

404 
­p_wav_İ’_fe_”rÜ
;

407 ià(!
	`memcmp
(&
d©a
[0], "LIST", 4) ||

408 !
	`memcmp
(&
d©a
[0], "cue ", 4))

411 ià(
	`l£ek
(
fd
, 
tmpU32
, 
SEEK_CUR
) == -1)

413 
	`APP_ERROR1
("Faed by·ssšghLIST chunk (%u)", 
tmpU32
);

414 
­p_wav_İ’_fe_”rÜ
;

416 ià(
size
 !ğ(
d©a
))

418 
	`APP_ERROR1
("L’gth„—d dÛ nÙ m©ch LIST chunk (%d !ğ%d)", ()
size
, (
d©a
));

419 
­p_wav_İ’_fe_”rÜ
;

422 ià(!
	`memcmp
(&
d©a
[0], "data", 4))

425 ià(
tmpU32
 & 1)

427 
tÙ®size
++;

430 ià(
tÙ®size
 !ğ
fe_size
)

432 
	`APP_DEBUG1
("WARNING: RIFF size does‚ot match file size (%lu != %lu))",

433 
fe_size
, 
tÙ®size
);

438 
	`APP_ERROR1
("unsuµÜ‹d chunk (%c%c%c%c)", 
d©a
[0], data[1], data[2], data[3]);

439 
­p_wav_İ’_fe_”rÜ
;

441 } 
	`memcmp
(&
d©a
[0], "data", 4));

443 ià(!
p_fÜm©
->
§m¶e_¿‹
)

445 
	`APP_ERROR0
("Format chunk was‚ot found in WAV file");

446 
­p_wav_İ’_fe_”rÜ
;

449  
fd
;

451 
­p_wav_İ’_fe_”rÜ
:

452 
	`şo£
(
fd
);

455 
	}
}

470 
	$­p_wav_ü—‹_fe
(cÚ¡ *
p_âame
, 
æags
)

472 
fd
, 
dummy
;

475 
æags
 |ğ
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
;

477 
fd
 = 
	`İ’
(
p_âame
, 
æags
, 0666);

478 ià(
fd
 < 0)

480 ià(!(
æags
 & 
O_EXCL
))

482 
	`APP_ERROR1
("İ’(%sèçed: %d", 
p_âame
, 
”ºo
);

487 
	`APP_DEBUG1
("ü—‹d WAV f%s", 
p_âame
);

488 
dummy
 = 
	`wr™e
(
fd
, 
­p_wav_hdr
, (app_wav_hdr));

489 ()
dummy
;

491  
fd
;

492 
	}
}

506 
	$­p_wav_şo£_fe
(
fd
, cÚ¡ 
tAPP_WAV_FILE_FORMAT
 *
p_fÜm©
)

508 
d©a_size
, 
dummy
;

509 
h—d”
[
APP_WAVE_HDR_SIZE
];

510 
chunk_size
;

511 
by‹_¿‹
;

512 
block_®ign
;

514 ià(
fd
 < 0)

516 
	`APP_ERROR0
("Bad file descriptor");

521 
	`memıy
(
h—d”
, 
­p_wav_hdr
, (header));

524 
d©a_size
 = 
	`l£ek
(
fd
, 0, 
SEEK_CUR
);

525 ià(
d©a_size
 < 0)

527 
	`APP_ERROR0
("Read current…ointer failed");

528 
d©a_size
 = 
APP_WAVE_HDR_SIZE
;

532 
d©a_size
 -ğ
APP_WAVE_HDR_SIZE
;

534 
chunk_size
 = 
d©a_size
 + 36;

535 ià(
p_fÜm©
->
b™s_³r_§m¶e
 == 8)

537 
by‹_¿‹
 = 
p_fÜm©
->
nb_chªÃls
 * (è*…_fÜm©->
§m¶e_¿‹
;

538 
block_®ign
 = 
p_fÜm©
->
nb_chªÃls
 * ();

542 
by‹_¿‹
 = 
p_fÜm©
->
nb_chªÃls
 * (è*…_fÜm©->
§m¶e_¿‹
;

543 
block_®ign
 = 
p_fÜm©
->
nb_chªÃls
 * ();

546 
h—d”
[4] = ()
chunk_size
;

547 
h—d”
[5] = ()(
chunk_size
 >> 8);

548 
h—d”
[6] = ()(
chunk_size
 >> 16);

549 
h—d”
[7] = ()(
chunk_size
 >> 24);

551 
h—d”
[22] = ()
p_fÜm©
->
nb_chªÃls
;

552 
h—d”
[23] = 0;

554 
h—d”
[24] = ()
p_fÜm©
->
§m¶e_¿‹
;

555 
h—d”
[25] = ()(
p_fÜm©
->
§m¶e_¿‹
 >> 8);

556 
h—d”
[26] = ()(
p_fÜm©
->
§m¶e_¿‹
 >> 16);

557 
h—d”
[27] = ()(
p_fÜm©
->
§m¶e_¿‹
 >> 24);

559 
h—d”
[28] = ()
by‹_¿‹
;

560 
h—d”
[29] = ()(
by‹_¿‹
 >> 8);

561 
h—d”
[30] = ()(
by‹_¿‹
 >> 16);

562 
h—d”
[31] = ()(
by‹_¿‹
 >> 24);

564 
h—d”
[32] = ()
block_®ign
;

565 
h—d”
[33] = ()(
block_®ign
 >> 8);

567 
h—d”
[34] = ()
p_fÜm©
->
b™s_³r_§m¶e
;

568 
h—d”
[35] = ()(
p_fÜm©
->
b™s_³r_§m¶e
 >> 8);

570 
h—d”
[40] = ()
d©a_size
;

571 
h—d”
[41] = ()(
d©a_size
 >> 8);

572 
h—d”
[42] = ()(
d©a_size
 >> 16);

573 
h—d”
[43] = ()(
d©a_size
 >> 24);

575 
	`l£ek
(
fd
, 0, 
SEEK_SET
);

576 
dummy
 = 
	`wr™e
(
fd
, 
h—d”
, (header));

577 ()
dummy
;

578 
	`şo£
(
fd
);

579 
	}
}

	@source/app_common/app_xml_param.c

12 #ifdeà
QT_APP


13 
	~"budcfg.h
"

16 
	~<¡dio.h
>

17 
	~<fú.h
>

18 
	~<uni¡d.h
>

19 
	~<ùy³.h
>

21 
	~"­p_xml_·¿m.h
"

23 
	~"­p_xml_uts.h
"

24 
	~"­p_uts.h
"

26 
	~"Çnoxml.h
"

28 
	#APP_XML_ROOT_KEY
 "X_BROADCOM_COM_Blu‘oÙhAd­‹r"

	)

30 
	#APP_XML_CONF_KEY
 "bt_cÚfig"

	)

31 
	#APP_XML_CONF_ENABLE_KEY
 "’abË"

	)

32 
	#APP_XML_CONF_DISCOVERABLE_KEY
 "visibË"

	)

33 
	#APP_XML_CONF_CONNECTABLE_KEY
 "cÚÃùabË"

	)

34 
	#APP_XML_CONF_NAME_KEY
 "loÿl_Çme"

	)

35 
	#APP_XML_CONF_BLE_NAME_KEY
 "bË_Çme"

	)

36 
	#APP_XML_CONF_BDADDR_KEY
 "bd_addr"

	)

37 
	#APP_XML_CONF_CLASS_KEY
 "şass_of_deviû"

	)

38 
	#APP_XML_CONF_PINCODE_KEY
 "pš_code"

	)

39 
	#APP_XML_CONF_PINLEN_KEY
 "pš_Ën"

	)

40 
	#APP_XML_CONF_ROOTPATH_KEY
 "roÙ_·th"

	)

41 
	#APP_XML_CONF_IO_CAP_KEY
 "io_ÿ·b™›s"

	)

43 
	#APP_XML_DEVS_KEY
 "bt_deviûs"

	)

44 
	#APP_XML_DEV_KEY
 "deviû"

	)

45 
	#APP_XML_DEV_INST_KEY
 "š¡ªû"

	)

46 
	#APP_XML_DEV_BDADDR_KEY
 "bd_addr"

	)

47 
	#APP_XML_DEV_NAME_KEY
 "deviû_Çme"

	)

48 
	#APP_XML_DEV_CLASS_KEY
 "şass_of_deviû"

	)

49 
	#APP_XML_DEV_LINKKEY_KEY
 "lšk_key"

	)

50 
	#APP_XML_DEV_LINKKEYP_KEY
 "Lšk_key_´e£Á"

	)

51 
	#APP_XML_DEV_KEYTYPE_KEY
 "key_ty³"

	)

52 
	#APP_XML_DEV_TRUSTED_KEY
 "Œu¡ed_£rviûs"

	)

53 
	#APP_XML_DEV_PID_KEY
 "pid"

	)

54 
	#APP_XML_DEV_VID_KEY
 "vid"

	)

55 
	#APP_XML_DEV_VERSION_KEY
 "v”siÚ"

	)

56 
	#APP_XML_DEV_FEATURES
 "ã©u»s"

	)

57 
	#APP_XML_DEV_LMP_VERSION
 "lmp_v”siÚ"

	)

59 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

60 
	#APP_XML_DEV_BLE_ADDR_TYPE
 "bË_addr_ty³"

	)

61 
	#APP_XML_DEV_DEVICE_TYPE
 "deviû_ty³"

	)

62 
	#APP_XML_DEV_INQ_RESULT_TYPE
 "šq_»suÉ_ty³"

	)

63 
	#APP_XML_DEV_BLE_LINKKEYP_KEY
 "bË_Lšk_key_´e£Á"

	)

64 
	#APP_XML_DEV_PENC_LTK
 "³nc_Ék"

	)

65 
	#APP_XML_DEV_PENC_RAND
 "³nc_¿nd"

	)

66 
	#APP_XML_DEV_PENC_EDIV
 "³nc_ediv"

	)

67 
	#APP_XML_DEV_PENC_SEC_LEVEL
 "³nc_£c_Ëv–"

	)

68 
	#APP_XML_DEV_PENC_KEY_SIZE
 "³nc_key_size"

	)

69 
	#APP_XML_DEV_PID_IRK
 "´id_œk"

	)

70 
	#APP_XML_DEV_PID_ADDR_TYPE
 "´id_addr_ty³"

	)

71 
	#APP_XML_DEV_PID_STATIC_ADDR
 "´id_¡©ic_addr"

	)

72 
	#APP_XML_DEV_PCSRK_COUNTER
 "pc¤k_couÁ”"

	)

73 
	#APP_XML_DEV_PCSRK_CSRK
 "pc¤k_c¤k"

	)

74 
	#APP_XML_DEV_PCSRK_SEC_LEVEL
 "pc¤k_£c_Ëv–"

	)

75 
	#APP_XML_DEV_LCSRK_COUNTER
 "lc¤k_couÁ”"

	)

76 
	#APP_XML_DEV_LCSRK_DIV
 "lc¤k_dis"

	)

77 
	#APP_XML_DEV_LCSRK_SEC_LEVEL
 "lc¤k_£c_Ëv–"

	)

78 
	#APP_XML_DEV_LENC_DIV
 "Ënc_div"

	)

79 
	#APP_XML_DEV_LENC_KEY_SIZE
 "Ënc_key_size"

	)

80 
	#APP_XML_DEV_LENC_SEC_LEVEL
 "Ënc_£c_Ëv–"

	)

83 
	#APP_XML_SI_DEVS_KEY
 "si_deviûs"

	)

84 
	#APP_XML_SI_DEV_KEY
 "deviû"

	)

85 
	#APP_XML_SI_DEV_INST_KEY
 "š¡ªû"

	)

86 
	#APP_XML_SI_DEV_BDADDR_KEY
 "bd_addr"

	)

87 
	#APP_XML_SI_DEV_PLATFORM_KEY
 "¶©fÜm"

	)

92 
	mCONF_ENABLE_KEY
,

93 
	mCONF_DISCOVERABLE_KEY
,

94 
	mCONF_CONNECTABLE_KEY
,

95 
	mCONF_NAME_KEY
,

96 
	mCONF_BLE_NAME_KEY
,

97 
	mCONF_CLASS_KEY
,

98 
	mCONF_BDADDR_KEY
,

99 
	mCONF_PINCODE_KEY
,

100 
	mCONF_PINLEN_KEY
,

101 
	mCONF_IOCAP_KEY
,

102 
	mCONF_ROOTPATH_KEY
,

105 
	mDEVS_KEY
,

106 
	mDEV_KEY
,

107 
	mDEV_INST_KEY
,

108 
	mDEV_BDADDR_KEY
,

109 
	mDEV_NAME_KEY
,

110 
	mDEV_CLASS_KEY
,

111 
	mDEV_LINKKEY_KEY
,

112 
	mDEV_LINKKEYP_KEY
,

113 
	mDEV_KEYTYPE_KEY
,

114 
	mDEV_TRUSTED_KEY
,

115 
	mDEV_PID_KEY
,

116 
	mDEV_VID_KEY
,

117 
	mDEV_VERSION_KEY
,

118 
	mDEV_FEATURES_KEY
,

119 
	mDEV_LMP_VERSION_KEY
,

120 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

121 
	mDEV_BLE_ADDR_TYPE_KEY
,

122 
	mDEV_DEVICE_TYPE_KEY
,

123 
	mDEV_INQ_RESULT_TYPE
,

124 
	mDEV_BLE_LINKKEYP_KEY
,

125 
	mDEV_PENC_LTK_KEY
,

126 
	mDEV_PENC_RAND_KEY
,

127 
	mDEV_PENC_EDIV_KEY
,

128 
	mDEV_PENC_SEC_LEVEL_KEY
,

129 
	mDEV_PENC_KEY_SIZE_KEY
,

130 
	mDEV_PID_IRK_KEY
,

131 
	mDEV_PID_ADDR_TYPE_KEY
,

132 
	mDEV_PID_STATIC_ADDR_KEY
,

133 
	mDEV_PCSRK_COUNTER_KEY
,

134 
	mDEV_PCSRK_CSRK_KEY
,

135 
	mDEV_PCSRK_SEC_LEVEL_KEY
,

136 
	mDEV_LCSRK_COUNTER_KEY
,

137 
	mDEV_LCSRK_DIV_KEY
,

138 
	mDEV_LCSRK_SEC_LEVEL_KEY
,

139 
	mDEV_LENC_DIV_KEY
,

140 
	mDEV_LENC_KEY_SIZE_KEY
,

141 
	mDEV_LENC_SEC_LEVEL_KEY
,

145 
	mSI_DEVS_KEY
,

146 
	mSI_DEV_KEY
,

147 
	mSI_DEV_INST_KEY
,

148 
	mSI_DEV_BDADDR_KEY
,

149 
	mSI_DEV_PLATFORM_KEY
,

154 
	mcfg_g
;

155 
	mdev_g
;

156 
	msi_dev_g
;

157 
	mdev_š¡ªû
;

158 
	msi_dev_š¡ªû
;

159 
tAPP_XML_CONFIG
 *
	mcÚfig_±r
;

160 
tAPP_XML_REM_DEVICE
 *
	mdeviûs_db_±r
;

161 
tAPP_XML_SI_DEVICE
 *
	msi_dev_db_±r
;

162 
	mdeviûs_max
;

163 
	msi_dev_max
;

164 } 
	ttAPP_XML_PARAM_CB
;

166 
tAPP_XML_PARAM_CB
 
	g­p_xml_·¿m_cb
;

168 
­p_xml_cÚf_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

169 cÚ¡ *
gName
, 
Ën
);

170 
­p_xml_cÚf_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

171 cÚ¡ *
©ŒName
, 
Ën
);

172 
­p_xml_cÚf_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

173 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
);

174 
­p_xml_cÚf_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

175 
Ën
, 
mÜe
);

176 
­p_xml_cÚf_gEndC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
gName
,

177 
Ën
);

179 
­p_xml_dev_db_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

180 cÚ¡ *
gName
, 
Ën
);

181 
­p_xml_dev_db_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

182 cÚ¡ *
©ŒName
, 
Ën
);

183 
­p_xml_dev_db_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

184 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
);

185 
­p_xml_dev_db_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

186 
Ën
, 
mÜe
);

187 
­p_xml_dev_db_gEndC®lbackFunc
(
nxml_t
 
hªdË
,

188 cÚ¡ *
gName
, 
Ën
);

190 
­p_xml_si_dev_db_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

191 cÚ¡ *
gName
, 
Ën
);

192 
­p_xml_si_dev_db_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

193 cÚ¡ *
©ŒName
, 
Ën
);

194 
­p_xml_si_dev_db_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

195 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
);

196 
­p_xml_si_dev_db_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

197 
Ën
, 
mÜe
);

198 
­p_xml_si_dev_db_gEndC®lbackFunc
(
nxml_t
 
hªdË
,

199 cÚ¡ *
gName
, 
Ën
);

211 
	$­p_xml_š™
()

214 
	}
}

229 
	$­p_xml_»ad_cfg
(cÚ¡ *
p_âame
, 
tAPP_XML_CONFIG
 *
p_xml_cÚfig
)

231 
nxml_t
 
nxmlHªdË
;

232 
nxml_£‰šgs
 
nxmlS‘tšgs
;

233 *
’dp
 = 
NULL
;

234 
rc
;

235 
maxL’
;

236 *
fe_bufãr
;

237 
fd
;

238 
Ën
;

241 ià((
fd
 = 
	`İ’
(
p_âame
, 
O_RDONLY
)) >= 0)

244 
maxL’
 = 
	`­p_fe_size
(
fd
);

245 ià(
maxL’
 <= 0)

247 
	`şo£
(
fd
);

251 
fe_bufãr
 = 
	`m®loc
(
maxL’
 + 1);

252 ià(
fe_bufãr
 =ğ
NULL
)

254 
	`APP_ERROR1
("ÿÂÙ‡Îoc:%d by‹s", 
maxL’
);

255 
	`şo£
(
fd
);

260 
Ën
 = 
	`»ad
(
fd
, (*è
fe_bufãr
, 
maxL’
);

261 
fe_bufãr
[
maxL’
] = '\0';

262 
	`şo£
(
fd
);

264 ià(
Ën
 !ğ
maxL’
)

266 
	`ä“
(
fe_bufãr
);

267 
	`APP_ERROR1
("nÙ‡bËØ»ad com¶‘fe:%d/%d", 
Ën
, 
maxL’
);

277 
nxmlS‘tšgs
.
g_begš
 = 
­p_xml_cÚf_gBegšC®lbackFunc
;

278 
nxmlS‘tšgs
.
©Œibu‹_begš
 = 
­p_xml_cÚf_©ŒBegšC®lbackFunc
;

279 
nxmlS‘tšgs
.
©Œibu‹_v®ue
 = 
­p_xml_cÚf_©ŒV®ueC®lbackFunc
;

280 
nxmlS‘tšgs
.
d©a
 = 
­p_xml_cÚf_d©aC®lbackFunc
;

281 
nxmlS‘tšgs
.
g_’d
 = 
­p_xml_cÚf_gEndC®lbackFunc
;

283 ià((
rc
 = 
	`xmlO³n
(&
nxmlHªdË
, &
nxmlS‘tšgs
)) == 0)

285 
	`ä“
(
fe_bufãr
);

286 
	`APP_ERROR1
("ÿÂÙ xmÈ:%d", 
rc
);

290 
­p_xml_·¿m_cb
.
cÚfig_±r
 = 
p_xml_cÚfig
;

293 
rc
 = 
	`xmlWr™e
(
nxmlHªdË
, 
fe_bufãr
, 
maxL’
, &
’dp
);

294 ià(
rc
 != 1)

296 
	`ä“
(
fe_bufãr
);

297 
	`APP_ERROR1
("xmlWr™»tuº :%d", 
rc
);

301 
	`ä“
(
fe_bufãr
);

302 
	`xmlClo£
(
nxmlHªdË
);

305 
	}
}

316 
	$­p_xml_»ad_db
(cÚ¡ *
p_âame
, 
tAPP_XML_REM_DEVICE
 *
p_xml_»m_deviûs
,

317 
deviûs_max
)

319 
nxml_t
 
nxmlHªdË
;

320 
nxml_£‰šgs
 
nxmlS‘tšgs
;

321 *
’dp
 = 
NULL
;

322 
rc
;

323 
maxL’
;

324 *
fe_bufãr
;

325 
fd
;

326 
Ën
;

329 ià((
fd
 = 
	`İ’
(
p_âame
, 
O_RDONLY
)) >= 0)

332 
maxL’
 = 
	`­p_fe_size
(
fd
);

333 ià(
maxL’
 <= 0)

335 
	`APP_ERROR1
("­p_fs_fe_size(%sèçed", 
p_âame
);

336 
	`şo£
(
fd
);

340 
fe_bufãr
 = 
	`m®loc
(
maxL’
 + 1);

341 ià(
fe_bufãr
 =ğ
NULL
)

343 
	`APP_ERROR1
("ÿÂÙ‡Îoc:%d by‹s", 
maxL’
);

344 
	`şo£
(
fd
);

349 
Ën
 = 
	`»ad
(
fd
, (*è
fe_bufãr
, 
maxL’
);

350 
fe_bufãr
[
maxL’
] = '\0';

352 
	`şo£
(
fd
);

354 ià(
Ën
 !ğ
maxL’
)

356 
	`ä“
(
fe_bufãr
);

357 
	`APP_ERROR1
("nÙ‡bËØ»ad com¶‘fe: %d/%d", 
Ën
, 
maxL’
);

363 
	`APP_ERROR1
("İ’(%sèçed", 
p_âame
);

368 
nxmlS‘tšgs
.
g_begš
 = 
­p_xml_dev_db_gBegšC®lbackFunc
;

369 
nxmlS‘tšgs
.
©Œibu‹_begš
 = 
­p_xml_dev_db_©ŒBegšC®lbackFunc
;

370 
nxmlS‘tšgs
.
©Œibu‹_v®ue
 = 
­p_xml_dev_db_©ŒV®ueC®lbackFunc
;

371 
nxmlS‘tšgs
.
d©a
 = 
­p_xml_dev_db_d©aC®lbackFunc
;

372 
nxmlS‘tšgs
.
g_’d
 = 
­p_xml_dev_db_gEndC®lbackFunc
;

374 ià((
rc
 = 
	`xmlO³n
(&
nxmlHªdË
, &
nxmlS‘tšgs
)) == 0)

376 
	`ä“
(
fe_bufãr
);

377 
	`APP_ERROR1
("xmlO³Àçed: %d", 
rc
);

381 
­p_xml_·¿m_cb
.
deviûs_db_±r
 = 
p_xml_»m_deviûs
;

382 
­p_xml_·¿m_cb
.
deviûs_max
 = devices_max;

385 
rc
 = 
	`xmlWr™e
(
nxmlHªdË
, 
fe_bufãr
, 
maxL’
, &
’dp
);

386 ià(
rc
 != 1)

388 
	`ä“
(
fe_bufãr
);

389 
	`APP_ERROR1
("xmlWr™çed: %d", 
rc
);

393 
	`xmlClo£
(
nxmlHªdË
);

394 
	`ä“
(
fe_bufãr
);

397 
	}
}

408 
	$­p_xml_»ad_si_db
(cÚ¡ *
p_âame
, 
tAPP_XML_SI_DEVICE
 *
p_xml_si_deviûs
,

409 
si_dev_max
)

411 
nxml_t
 
nxmlHªdË
;

412 
nxml_£‰šgs
 
nxmlS‘tšgs
;

413 *
’dp
 = 
NULL
;

414 
rc
;

415 
maxL’
;

416 *
fe_bufãr
;

417 
fd
;

418 
Ën
;

421 ià((
fd
 = 
	`İ’
(
p_âame
, 
O_RDONLY
)) >= 0)

424 
maxL’
 = 
	`­p_fe_size
(
fd
);

425 ià(
maxL’
 <= 0)

427 
	`APP_ERROR1
("­p_fs_fe_size(%sèçed", 
p_âame
);

428 
	`şo£
(
fd
);

432 
fe_bufãr
 = 
	`m®loc
(
maxL’
 + 1);

433 ià(
fe_bufãr
 =ğ
NULL
)

435 
	`APP_ERROR1
("ÿÂÙ‡Îoc:%d by‹s", 
maxL’
);

436 
	`şo£
(
fd
);

441 
Ën
 = 
	`»ad
(
fd
, (*è
fe_bufãr
, 
maxL’
);

442 
fe_bufãr
[
maxL’
] = '\0';

444 
	`şo£
(
fd
);

446 ià(
Ën
 !ğ
maxL’
)

448 
	`ä“
(
fe_bufãr
);

449 
	`APP_ERROR1
("nÙ‡bËØ»ad com¶‘fe: %d/%d", 
Ën
, 
maxL’
);

455 
	`APP_ERROR1
("İ’(%sèçed", 
p_âame
);

460 
nxmlS‘tšgs
.
g_begš
 = 
­p_xml_si_dev_db_gBegšC®lbackFunc
;

461 
nxmlS‘tšgs
.
©Œibu‹_begš
 = 
­p_xml_si_dev_db_©ŒBegšC®lbackFunc
;

462 
nxmlS‘tšgs
.
©Œibu‹_v®ue
 = 
­p_xml_si_dev_db_©ŒV®ueC®lbackFunc
;

463 
nxmlS‘tšgs
.
d©a
 = 
­p_xml_si_dev_db_d©aC®lbackFunc
;

464 
nxmlS‘tšgs
.
g_’d
 = 
­p_xml_si_dev_db_gEndC®lbackFunc
;

466 ià((
rc
 = 
	`xmlO³n
(&
nxmlHªdË
, &
nxmlS‘tšgs
)) == 0)

468 
	`ä“
(
fe_bufãr
);

469 
	`APP_ERROR1
("xmlO³Àçed: %d", 
rc
);

473 
­p_xml_·¿m_cb
.
si_dev_db_±r
 = 
p_xml_si_deviûs
;

474 
­p_xml_·¿m_cb
.
si_dev_max
 = si_dev_max;

477 
rc
 = 
	`xmlWr™e
(
nxmlHªdË
, 
fe_bufãr
, 
maxL’
, &
’dp
);

478 ià(
rc
 != 1)

480 
	`ä“
(
fe_bufãr
);

481 
	`APP_ERROR1
("xmlWr™çed: %d", 
rc
);

485 
	`xmlClo£
(
nxmlHªdË
);

486 
	`ä“
(
fe_bufãr
);

489 
	}
}

501 
	$­p_xml_wr™e_cfg
(cÚ¡ *
p_âame
, cÚ¡ 
tAPP_XML_CONFIG
 *
p_xml_cÚfig
)

503 
fd
, 
dummy
;

505 ià((
fd
 = 
	`İ’
((*è
p_âame
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0)

507 
	`APP_ERROR1
("E¼Ü o³nšg/ü—tšg % fe", 
p_âame
);

511 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

512 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_KEY
, 
TRUE
);

514 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_ENABLE_KEY
, 
FALSE
);

516 
	`d´štf
(
fd
, "%d", 
p_xml_cÚfig
->
’abË
);

517 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_ENABLE_KEY
, 
FALSE
);

519 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_DISCOVERABLE_KEY
, 
FALSE
);

520 
	`d´štf
(
fd
, "%d", 
p_xml_cÚfig
->
discov”abË
);

521 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_DISCOVERABLE_KEY
, 
FALSE
);

523 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_CONNECTABLE_KEY
, 
FALSE
);

524 
	`d´štf
(
fd
, "%d", 
p_xml_cÚfig
->
cÚÃùabË
);

525 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_CONNECTABLE_KEY
, 
FALSE
);

527 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_NAME_KEY
, 
FALSE
);

528 
dummy
 = 
	`wr™e
(
fd
, (*è
p_xml_cÚfig
->
Çme
, 
	`¡¾’
((*)…_xml_config->name));

529 ()
dummy
;

530 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_NAME_KEY
, 
FALSE
);

532 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_BLE_NAME_KEY
, 
FALSE
);

533 
dummy
 = 
	`wr™e
(
fd
, (*è
p_xml_cÚfig
->
bË_Çme
, 
	`¡¾’
((*)…_xml_config->ble_name));

534 ()
dummy
;

535 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_BLE_NAME_KEY
, 
FALSE
);

537 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_BDADDR_KEY
, 
FALSE
);

538 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_cÚfig
->
bd_addr
, Õ_xml_cÚfig->bd_addr), 
FALSE
);

539 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_BDADDR_KEY
, 
FALSE
);

541 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_CLASS_KEY
, 
FALSE
);

542 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_cÚfig
->
şass_of_deviû
, Õ_xml_cÚfig->şass_of_deviû), 
FALSE
);

543 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_CLASS_KEY
, 
FALSE
);

545 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_PINCODE_KEY
, 
FALSE
);

546 
dummy
 = 
	`wr™e
(
fd
, 
p_xml_cÚfig
->
pš_code
, 
	`¡¾’
((*)p_xml_config->pin_code));

547 ()
dummy
;

548 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_PINCODE_KEY
, 
FALSE
);

550 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_PINLEN_KEY
, 
FALSE
);

551 
	`d´štf
(
fd
, "%d", 
p_xml_cÚfig
->
pš_Ën
);

552 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_PINLEN_KEY
, 
FALSE
);

554 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_IO_CAP_KEY
, 
FALSE
);

555 
	`d´štf
(
fd
, "%d", 
p_xml_cÚfig
->
io_ÿp
);

556 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_IO_CAP_KEY
, 
FALSE
);

558 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_CONF_ROOTPATH_KEY
, 
FALSE
);

559 
dummy
 = 
	`wr™e
(
fd
, 
p_xml_cÚfig
->
roÙ_·th
, 
	`¡¾’
((*)p_xml_config->root_path));

560 ()
dummy
;

561 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_ROOTPATH_KEY
, 
FALSE
);

563 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_CONF_KEY
, 
TRUE
);

564 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

566 
	`şo£
(
fd
);

569 
	}
}

580 
	$­p_xml_wr™e_db
(cÚ¡ *
p_âame
, cÚ¡ 
tAPP_XML_REM_DEVICE
 *
p_xml_»m_deviûs
, 
deviûs_max
)

582 
fd
, 
dummy
;

583 
šdex
;

584 
š¡ªû
;

586 ià((
fd
 = 
	`İ’
((*)
p_âame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0666)) < 0)

588 
	`APP_ERROR1
("E¼Ü o³nšg/ü—tšg % fe", 
p_âame
);

592 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

593 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEVS_KEY
, 
TRUE
);

596 
šdex
 = 0, 
š¡ªû
 = 0; index < 
deviûs_max
; index++, 
p_xml_»m_deviûs
++)

599 ià(
p_xml_»m_deviûs
->
š_u£
 !ğ
FALSE
)

601 
	`­p_xml_İ’_g_w™h_v®ue
(
fd
, 
APP_XML_DEV_KEY
, 
š¡ªû
);

603 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_BDADDR_KEY
, 
FALSE
);

604 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
bd_addr
, Õ_xml_»m_deviûs->bd_addr), 
FALSE
);

605 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_BDADDR_KEY
, 
FALSE
);

607 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_NAME_KEY
, 
FALSE
);

608 
dummy
 = 
	`wr™e
(
fd
, (*è
p_xml_»m_deviûs
->
Çme
,

609 
	`¡¾’
((*è
p_xml_»m_deviûs
->
Çme
));

610 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_NAME_KEY
, 
FALSE
);

612 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_CLASS_KEY
, 
FALSE
);

613 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
şass_of_deviû
, Õ_xml_»m_deviûs->şass_of_deviû), 
FALSE
);

614 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_CLASS_KEY
, 
FALSE
);

616 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LINKKEY_KEY
, 
FALSE
);

617 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
lšk_key
, Õ_xml_»m_deviûs->lšk_key), 
FALSE
);

618 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LINKKEY_KEY
, 
FALSE
);

620 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LINKKEYP_KEY
, 
FALSE
);

622 
	`d´štf
(
fd
, "%d", 
p_xml_»m_deviûs
->
lšk_key_´e£Á
);

623 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LINKKEYP_KEY
, 
FALSE
);

625 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_KEYTYPE_KEY
, 
FALSE
);

626 
	`d´štf
(
fd
, "%d", 
p_xml_»m_deviûs
->
key_ty³
);

627 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_KEYTYPE_KEY
, 
FALSE
);

629 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_TRUSTED_KEY
, 
FALSE
);

630 
	`d´štf
(
fd
, "0x%08X", (è
p_xml_»m_deviûs
->
Œu¡ed_£rviûs
);

631 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_TRUSTED_KEY
, 
FALSE
);

633 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_VID_KEY
, 
FALSE
);

634 
	`d´štf
(
fd
, "0x%04X", (è
p_xml_»m_deviûs
->
vid
);

635 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_VID_KEY
, 
FALSE
);

637 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PID_KEY
, 
FALSE
);

638 
	`d´štf
(
fd
, "0x%04X", (è
p_xml_»m_deviûs
->
pid
);

639 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PID_KEY
, 
FALSE
);

641 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_VERSION_KEY
, 
FALSE
);

642 
	`d´štf
(
fd
, "0x%04X", (è
p_xml_»m_deviûs
->
v”siÚ
);

643 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_VERSION_KEY
, 
FALSE
);

645 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_FEATURES
, 
FALSE
);

646 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
ã©u»s
, Õ_xml_»m_deviûs->ã©u»s), 
FALSE
);

647 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_FEATURES
, 
FALSE
);

649 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LMP_VERSION
, 
FALSE
);

650 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
lmp_v”siÚ
);

651 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LMP_VERSION
, 
FALSE
);

653 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

654 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_BLE_ADDR_TYPE
, 
FALSE
);

655 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
bË_addr_ty³
);

656 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_BLE_ADDR_TYPE
, 
FALSE
);

658 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_DEVICE_TYPE
, 
FALSE
);

659 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
deviû_ty³
);

660 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_DEVICE_TYPE
, 
FALSE
);

662 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_INQ_RESULT_TYPE
, 
FALSE
);

663 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
šq_»suÉ_ty³
);

664 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_INQ_RESULT_TYPE
, 
FALSE
);

666 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_BLE_LINKKEYP_KEY
, 
FALSE
);

667 
	`d´štf
(
fd
, "%d", 
p_xml_»m_deviûs
->
bË_lšk_key_´e£Á
);

668 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_BLE_LINKKEYP_KEY
, 
FALSE
);

670 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PENC_LTK
, 
FALSE
);

671 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
³nc_Ék
, Õ_xml_»m_deviûs->³nc_Ék), 
FALSE
);

672 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PENC_LTK
, 
FALSE
);

674 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PENC_RAND
, 
FALSE
);

675 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
³nc_¿nd
, Õ_xml_»m_deviûs->³nc_¿nd), 
FALSE
);

676 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PENC_RAND
, 
FALSE
);

678 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PENC_EDIV
, 
FALSE
);

679 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
³nc_ediv
);

680 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PENC_EDIV
, 
FALSE
);

682 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PENC_SEC_LEVEL
, 
FALSE
);

683 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
³nc_£c_Ëv–
);

684 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PENC_SEC_LEVEL
, 
FALSE
);

686 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PENC_KEY_SIZE
, 
FALSE
);

687 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
³nc_key_size
);

688 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PENC_KEY_SIZE
, 
FALSE
);

690 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PID_IRK
, 
FALSE
);

691 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
pid_œk
, Õ_xml_»m_deviûs->pid_œk), 
FALSE
);

692 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PID_IRK
, 
FALSE
);

694 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PID_ADDR_TYPE
, 
FALSE
);

695 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
pid_addr_ty³
);

696 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PID_ADDR_TYPE
, 
FALSE
);

698 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PID_STATIC_ADDR
, 
FALSE
);

699 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
pid_¡©ic_addr
, Õ_xml_»m_deviûs->pid_¡©ic_addr), 
FALSE
);

700 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PID_STATIC_ADDR
, 
FALSE
);

702 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PCSRK_COUNTER
, 
FALSE
);

703 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
pc¤k_couÁ”
);

704 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PCSRK_COUNTER
, 
FALSE
);

706 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PCSRK_CSRK
, 
FALSE
);

707 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_»m_deviûs
->
pc¤k_c¤k
, Õ_xml_»m_deviûs->pc¤k_c¤k), 
FALSE
);

708 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PCSRK_CSRK
, 
FALSE
);

710 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_PCSRK_SEC_LEVEL
, 
FALSE
);

711 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
pc¤k_£c_Ëv–
);

712 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_PCSRK_SEC_LEVEL
, 
FALSE
);

714 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LCSRK_COUNTER
, 
FALSE
);

715 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
lc¤k_couÁ”
);

716 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LCSRK_COUNTER
, 
FALSE
);

718 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LCSRK_DIV
, 
FALSE
);

719 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
lc¤k_div
);

720 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LCSRK_DIV
, 
FALSE
);

722 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LCSRK_SEC_LEVEL
, 
FALSE
);

723 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
lc¤k_£c_Ëv–
);

724 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LCSRK_SEC_LEVEL
, 
FALSE
);

726 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LENC_DIV
, 
FALSE
);

727 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
Ënc_div
);

728 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LENC_DIV
, 
FALSE
);

730 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LENC_KEY_SIZE
, 
FALSE
);

731 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
Ënc_key_size
);

732 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LENC_KEY_SIZE
, 
FALSE
);

734 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_DEV_LENC_SEC_LEVEL
, 
FALSE
);

735 
	`d´štf
(
fd
, "%d", (è
p_xml_»m_deviûs
->
Ënc_£c_Ëv–
);

736 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_LENC_SEC_LEVEL
, 
FALSE
);

739 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEV_KEY
, 
TRUE
);

741 
š¡ªû
++;

745 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_DEVS_KEY
, 
TRUE
);

746 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

748 
	`şo£
(
fd
);

750 ()
dummy
;

753 
	}
}

764 
	$­p_xml_wr™e_si_db
(cÚ¡ *
p_âame
, cÚ¡ 
tAPP_XML_SI_DEVICE
 *
p_xml_si_deviûs
,

765 
si_dev_max
)

767 
fd
;

768 
šdex
;

769 
š¡ªû
;

771 ià((
fd
 = 
	`İ’
((*)
p_âame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0666)) < 0)

773 
	`APP_ERROR1
("E¼Ü o³nšg/ü—tšg % fe", 
p_âame
);

777 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

778 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_SI_DEVS_KEY
, 
TRUE
);

781 
šdex
 = 0, 
š¡ªû
 = 0; index < 
si_dev_max
; index++, 
p_xml_si_deviûs
++)

784 ià(
p_xml_si_deviûs
->
š_u£
 !ğ
FALSE
)

786 
	`­p_xml_İ’_g_w™h_v®ue
(
fd
, 
APP_XML_SI_DEV_KEY
, 
š¡ªû
);

788 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_SI_DEV_BDADDR_KEY
, 
FALSE
);

789 
	`­p_xml_wr™e_d©a
(
fd
, 
p_xml_si_deviûs
->
bd_addr
, Õ_xml_si_deviûs->bd_addr), 
FALSE
);

790 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_SI_DEV_BDADDR_KEY
, 
FALSE
);

792 
	`­p_xml_İ’_g
(
fd
, 
APP_XML_SI_DEV_PLATFORM_KEY
, 
FALSE
);

793 
	`d´štf
(
fd
, "%d", 
p_xml_si_deviûs
->
¶©fÜm
);

794 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_SI_DEV_PLATFORM_KEY
, 
FALSE
);

796 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_SI_DEV_KEY
, 
TRUE
);

798 
š¡ªû
++;

802 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_SI_DEVS_KEY
, 
TRUE
);

803 
	`­p_xml_şo£_g
(
fd
, 
APP_XML_ROOT_KEY
, 
TRUE
);

805 
	`şo£
(
fd
);

808 
	}
}

819 
	$­p_xml_cÚf_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

820 cÚ¡ *
gName
, 
Ën
)

822 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_ENABLE_KEY
, 
	`¡¾’
(

823 
APP_XML_CONF_ENABLE_KEY
)) == 0)

825 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_ENABLE_KEY
;

827 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_DISCOVERABLE_KEY
, 
	`¡¾’
(

828 
APP_XML_CONF_DISCOVERABLE_KEY
)) == 0)

830 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_DISCOVERABLE_KEY
;

832 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_CONNECTABLE_KEY
, 
	`¡¾’
(

833 
APP_XML_CONF_CONNECTABLE_KEY
)) == 0)

835 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_CONNECTABLE_KEY
;

837 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_NAME_KEY
, 
	`¡¾’
(

838 
APP_XML_CONF_NAME_KEY
)) == 0)

840 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_NAME_KEY
;

842 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_BLE_NAME_KEY
, 
	`¡¾’
(

843 
APP_XML_CONF_BLE_NAME_KEY
)) == 0)

845 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_BLE_NAME_KEY
;

847 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_BDADDR_KEY
, 
	`¡¾’
(

848 
APP_XML_CONF_BDADDR_KEY
)) == 0)

850 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_BDADDR_KEY
;

852 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_CLASS_KEY
, 
	`¡¾’
(

853 
APP_XML_CONF_CLASS_KEY
)) == 0)

855 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_CLASS_KEY
;

857 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_PINCODE_KEY
, 
	`¡¾’
(

858 
APP_XML_CONF_PINCODE_KEY
)) == 0)

860 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_PINCODE_KEY
;

862 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_PINLEN_KEY
, 
	`¡¾’
(

863 
APP_XML_CONF_PINLEN_KEY
)) == 0)

865 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_PINLEN_KEY
;

867 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_IO_CAP_KEY
, 
	`¡¾’
(

868 
APP_XML_CONF_IO_CAP_KEY
)) == 0)

870 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_IOCAP_KEY
;

872 ià(
	`¡ºcmp
(
gName
, 
APP_XML_CONF_ROOTPATH_KEY
, 
	`¡¾’
(

873 
APP_XML_CONF_ROOTPATH_KEY
)) == 0)

875 
­p_xml_·¿m_cb
.
cfg_g
 = 
CONF_ROOTPATH_KEY
;

877 
	}
}

888 
	$­p_xml_cÚf_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

889 cÚ¡ *
©ŒName
, 
Ën
)

891 
	}
}

902 
	$­p_xml_cÚf_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

903 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
)

905 
	}
}

916 
	$­p_xml_cÚf_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

917 
Ën
, 
mÜe
)

920 ià(
mÜe
)

922 
	`APP_ERROR1
("NÚ com¶‘d©a,…robably m®fÜmed XML fe: %s", 
d©a
);

925 
­p_xml_·¿m_cb
.
cfg_g
)

927 
CONF_ENABLE_KEY
:

928 
­p_xml_·¿m_cb
.
cÚfig_±r
->
’abË
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

931 
CONF_DISCOVERABLE_KEY
:

932 
­p_xml_·¿m_cb
.
cÚfig_±r
->
discov”abË
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

935 
CONF_CONNECTABLE_KEY
:

936 
­p_xml_·¿m_cb
.
cÚfig_±r
->
cÚÃùabË
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

939 
CONF_NAME_KEY
:

940 
	`­p_xml_»ad_¡ršg
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
Çme
,

941 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
Çme
), 
d©a
, 
Ën
);

944 
CONF_BLE_NAME_KEY
:

945 
	`­p_xml_»ad_¡ršg
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
bË_Çme
,

946 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
bË_Çme
), 
d©a
, 
Ën
);

948 
CONF_BDADDR_KEY
:

949 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
bd_addr
,

950 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
bd_addr
), 
d©a
, 
Ën
è=ğ
FALSE
)

952 
	`APP_ERROR0
("Failed„eading BD‡ddress in XML");

956 
CONF_CLASS_KEY
:

957 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
şass_of_deviû
,

958 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
şass_of_deviû
), 
d©a
, 
Ën
è=ğ
FALSE
)

960 
	`APP_ERROR0
("Failed„eading BD‡ddress in XML");

964 
CONF_PINCODE_KEY
:

965 
	`­p_xml_»ad_¡ršg
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
pš_code
,

966 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
pš_code
), 
d©a
, 
Ën
);

969 
CONF_PINLEN_KEY
:

970 
­p_xml_·¿m_cb
.
cÚfig_±r
->
pš_Ën
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

973 
CONF_IOCAP_KEY
:

974 
­p_xml_·¿m_cb
.
cÚfig_±r
->
io_ÿp
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

977 
CONF_ROOTPATH_KEY
:

978 
	`­p_xml_»ad_¡ršg
(&
­p_xml_·¿m_cb
.
cÚfig_±r
->
roÙ_·th
,

979 (
­p_xml_·¿m_cb
.
cÚfig_±r
->
roÙ_·th
), 
d©a
, 
Ën
);

985 
	}
}

996 
	$­p_xml_cÚf_gEndC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
gName
,

997 
Ën
)

999 
	}
}

1010 
	$­p_xml_dev_db_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

1011 cÚ¡ *
gName
, 
Ën
)

1013 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_BDADDR_KEY
,

1014 
	`¡¾’
(
APP_XML_CONF_ENABLE_KEY
)) == 0)

1016 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_BDADDR_KEY
;

1018 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_NAME_KEY
,

1019 
	`¡¾’
(
APP_XML_DEV_NAME_KEY
)) == 0)

1021 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_NAME_KEY
;

1023 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_CLASS_KEY
, 
	`¡¾’
(

1024 
APP_XML_DEV_CLASS_KEY
)) == 0)

1026 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_CLASS_KEY
;

1028 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LINKKEY_KEY
, 
	`¡¾’
(

1029 
APP_XML_DEV_LINKKEY_KEY
)) == 0)

1031 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LINKKEY_KEY
;

1033 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LINKKEYP_KEY
, 
	`¡¾’
(

1034 
APP_XML_DEV_LINKKEYP_KEY
)) == 0)

1036 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LINKKEYP_KEY
;

1038 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_KEYTYPE_KEY
, 
	`¡¾’
(

1039 
APP_XML_DEV_KEYTYPE_KEY
)) == 0)

1041 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_KEYTYPE_KEY
;

1043 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_TRUSTED_KEY
, 
	`¡¾’
(

1044 
APP_XML_DEV_TRUSTED_KEY
)) == 0)

1046 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_TRUSTED_KEY
;

1048 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PID_KEY
, 
	`¡¾’
(

1049 
APP_XML_DEV_PID_KEY
)) == 0)

1051 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PID_KEY
;

1053 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_VID_KEY
, 
	`¡¾’
(

1054 
APP_XML_DEV_VID_KEY
)) == 0)

1056 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_VID_KEY
;

1058 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_VERSION_KEY
, 
	`¡¾’
(

1059 
APP_XML_DEV_VERSION_KEY
)) == 0)

1061 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_VERSION_KEY
;

1063 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_FEATURES
, 
	`¡¾’
(

1064 
APP_XML_DEV_FEATURES
)) == 0)

1066 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_FEATURES_KEY
;

1068 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LMP_VERSION
, 
	`¡¾’
(

1069 
APP_XML_DEV_LMP_VERSION
)) == 0)

1071 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LMP_VERSION_KEY
;

1073 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

1074 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_BLE_ADDR_TYPE
, 
	`¡¾’
(

1075 
APP_XML_DEV_BLE_ADDR_TYPE
)) == 0)

1077 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_BLE_ADDR_TYPE_KEY
;

1079 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_DEVICE_TYPE
, 
	`¡¾’
(

1080 
APP_XML_DEV_DEVICE_TYPE
)) == 0)

1082 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_DEVICE_TYPE_KEY
;

1084 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_INQ_RESULT_TYPE
, 
	`¡¾’
(

1085 
APP_XML_DEV_DEVICE_TYPE
)) == 0)

1087 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_INQ_RESULT_TYPE
;

1089 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_BLE_LINKKEYP_KEY
, 
	`¡¾’
(

1090 
APP_XML_DEV_BLE_LINKKEYP_KEY
)) == 0)

1092 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_BLE_LINKKEYP_KEY
;

1094 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PENC_LTK
, 
	`¡¾’
(

1095 
APP_XML_DEV_PENC_LTK
)) == 0)

1097 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PENC_LTK_KEY
;

1099 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PENC_RAND
, 
	`¡¾’
(

1100 
APP_XML_DEV_PENC_RAND
)) == 0)

1102 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PENC_RAND_KEY
;

1104 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PENC_EDIV
, 
	`¡¾’
(

1105 
APP_XML_DEV_PENC_EDIV
)) == 0)

1107 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PENC_EDIV_KEY
;

1109 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PENC_SEC_LEVEL
, 
	`¡¾’
(

1110 
APP_XML_DEV_PENC_SEC_LEVEL
)) == 0)

1112 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PENC_SEC_LEVEL_KEY
;

1114 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PENC_KEY_SIZE
, 
	`¡¾’
(

1115 
APP_XML_DEV_PENC_KEY_SIZE
)) == 0)

1117 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PENC_KEY_SIZE_KEY
;

1119 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PID_IRK
, 
	`¡¾’
(

1120 
APP_XML_DEV_PID_IRK
)) == 0)

1122 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PID_IRK_KEY
;

1124 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PID_ADDR_TYPE
, 
	`¡¾’
(

1125 
APP_XML_DEV_PID_ADDR_TYPE
)) == 0)

1127 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PID_ADDR_TYPE_KEY
;

1129 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PID_STATIC_ADDR
, 
	`¡¾’
(

1130 
APP_XML_DEV_PID_STATIC_ADDR
)) == 0)

1132 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PID_STATIC_ADDR_KEY
;

1134 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PCSRK_COUNTER
, 
	`¡¾’
(

1135 
APP_XML_DEV_PCSRK_COUNTER
)) == 0)

1137 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PCSRK_COUNTER_KEY
;

1139 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PCSRK_CSRK
, 
	`¡¾’
(

1140 
APP_XML_DEV_PCSRK_CSRK
)) == 0)

1142 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PCSRK_CSRK_KEY
;

1144 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_PCSRK_SEC_LEVEL
, 
	`¡¾’
(

1145 
APP_XML_DEV_PCSRK_SEC_LEVEL
)) == 0)

1147 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_PCSRK_SEC_LEVEL_KEY
;

1149 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LCSRK_COUNTER
, 
	`¡¾’
(

1150 
APP_XML_DEV_LCSRK_COUNTER
)) == 0)

1152 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LCSRK_COUNTER_KEY
;

1154 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LCSRK_DIV
, 
	`¡¾’
(

1155 
APP_XML_DEV_LCSRK_DIV
)) == 0)

1157 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LCSRK_DIV_KEY
;

1159 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LCSRK_SEC_LEVEL
, 
	`¡¾’
(

1160 
APP_XML_DEV_LCSRK_SEC_LEVEL
)) == 0)

1162 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LCSRK_SEC_LEVEL_KEY
;

1164 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LENC_DIV
, 
	`¡¾’
(

1165 
APP_XML_DEV_LENC_DIV
)) == 0)

1167 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LENC_DIV_KEY
;

1169 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LENC_KEY_SIZE
, 
	`¡¾’
(

1170 
APP_XML_DEV_LENC_KEY_SIZE
)) == 0)

1172 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LENC_KEY_SIZE_KEY
;

1174 ià(
	`¡ºcmp
(
gName
, 
APP_XML_DEV_LENC_SEC_LEVEL
, 
	`¡¾’
(

1175 
APP_XML_DEV_LENC_SEC_LEVEL
)) == 0)

1177 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_LENC_SEC_LEVEL_KEY
;

1180 
	}
}

1191 
	$­p_xml_dev_db_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

1192 cÚ¡ *
©ŒName
, 
Ën
)

1194 ià(
	`¡ºcmp
(
©ŒName
, 
APP_XML_DEV_INST_KEY
, 
	`¡¾’
(APP_XML_DEV_INST_KEY))

1197 
­p_xml_·¿m_cb
.
dev_g
 = 
DEV_INST_KEY
;

1199 
	}
}

1210 
	$­p_xml_dev_db_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

1211 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
)

1214 ià(
mÜe
)

1216 
	`APP_ERROR1
("NÚ com¶‘©Œibu‹ v®ue,…robably m®fÜmed XML fe: %s", 
©ŒV®ue
);

1219 
­p_xml_·¿m_cb
.
dev_š¡ªû
 = 
	`­p_xml_»ad_v®ue
(
©ŒV®ue
, 
Ën
);

1221 ià(
­p_xml_·¿m_cb
.
dev_š¡ªû
 >ğ­p_xml_·¿m_cb.
deviûs_max
)

1223 
	`APP_ERROR1
("bad in¡ªû‚umb” found:%d", 
­p_xml_·¿m_cb
.
dev_š¡ªû
);

1224 
­p_xml_·¿m_cb
.
dev_š¡ªû
 = 0;

1226 
	}
}

1237 
	$­p_xml_dev_db_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

1238 
Ën
, 
mÜe
)

1240 
tAPP_XML_REM_DEVICE
 *
deviûs_db_±r
;

1243 ià(
mÜe
)

1245 
	`APP_ERROR1
("NÚ com¶‘d©a,…robably m®fÜmed XML fe: %s", 
d©a
);

1248 
deviûs_db_±r
 = 
­p_xml_·¿m_cb
.deviûs_db_±¸+‡µ_xml_·¿m_cb.
dev_š¡ªû
;

1250 
­p_xml_·¿m_cb
.
dev_g
)

1252 
DEV_BDADDR_KEY
:

1253 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
bd_addr
,

1254 (
deviûs_db_±r
->
bd_addr
), 
d©a
, 
Ën
è=ğ
FALSE
)

1256 
	`APP_ERROR0
("Failed„eading instance BD‡ddress in XML");

1258 
deviûs_db_±r
-> 
š_u£
 = 1;

1261 
DEV_NAME_KEY
:

1263 
	`­p_xml_»ad_¡ršg
(
deviûs_db_±r
->
Çme
, (devices_db_ptr->name),

1264 
d©a
, 
Ën
);

1267 
DEV_CLASS_KEY
:

1268 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
şass_of_deviû
,

1269 (
deviûs_db_±r
->
şass_of_deviû
), 
d©a
, 
Ën
è=ğ
FALSE
)

1271 
	`APP_ERROR0
("Failed„eading instance class of device in XML");

1275 
DEV_LINKKEY_KEY
:

1276 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
lšk_key
,

1277 (
deviûs_db_±r
->
lšk_key
), 
d©a
, 
Ën
è=ğ
FALSE
)

1279 
	`APP_ERROR0
("Failed„eading instance†ink key in XML");

1283 
DEV_LINKKEYP_KEY
:

1284 
deviûs_db_±r
->
lšk_key_´e£Á
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1287 
DEV_KEYTYPE_KEY
:

1288 
deviûs_db_±r
->
key_ty³
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1291 
DEV_TRUSTED_KEY
:

1292 
deviûs_db_±r
->
Œu¡ed_£rviûs
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1295 
DEV_PID_KEY
:

1296 
deviûs_db_±r
->
pid
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1299 
DEV_VID_KEY
:

1300 
deviûs_db_±r
->
vid
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1303 
DEV_VERSION_KEY
:

1304 
deviûs_db_±r
->
v”siÚ
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1307 
DEV_FEATURES_KEY
:

1308 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
ã©u»s
,

1309 (
deviûs_db_±r
->
ã©u»s
), 
d©a
, 
Ën
è=ğ
FALSE
)

1311 
	`APP_ERROR0
("Failed„eading instance features in XML");

1315 
DEV_LMP_VERSION_KEY
:

1316 
deviûs_db_±r
->
lmp_v”siÚ
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1319 #ià(
	`defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

1320 
DEV_BLE_ADDR_TYPE_KEY
:

1321 
deviûs_db_±r
->
bË_addr_ty³
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1324 
DEV_DEVICE_TYPE_KEY
:

1325 
deviûs_db_±r
->
deviû_ty³
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1328 
DEV_INQ_RESULT_TYPE
:

1329 
deviûs_db_±r
->
šq_»suÉ_ty³
ğ
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1332 
DEV_BLE_LINKKEYP_KEY
:

1333 
deviûs_db_±r
->
bË_lšk_key_´e£Á
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1336 
DEV_PENC_LTK_KEY
:

1337 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
³nc_Ék
,

1338 (
deviûs_db_±r
->
³nc_Ék
), 
d©a
, 
Ën
è=ğ
FALSE
)

1340 
	`APP_ERROR0
("Failed„eading instance…enc†tk in XML");

1344 
DEV_PENC_RAND_KEY
:

1345 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
³nc_¿nd
,

1346 (
deviûs_db_±r
->
³nc_¿nd
), 
d©a
, 
Ën
è=ğ
FALSE
)

1348 
	`APP_ERROR0
("Failed„eading instance…enc„and in XML");

1352 
DEV_PENC_EDIV_KEY
:

1353 
deviûs_db_±r
->
³nc_ediv
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1356 
DEV_PENC_SEC_LEVEL_KEY
:

1357 
deviûs_db_±r
->
³nc_£c_Ëv–
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1360 
DEV_PENC_KEY_SIZE_KEY
:

1361 
deviûs_db_±r
->
³nc_key_size
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1364 
DEV_PID_IRK_KEY
:

1365 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
pid_œk
,

1366 (
deviûs_db_±r
->
pid_œk
), 
d©a
, 
Ën
è=ğ
FALSE
)

1368 
	`APP_ERROR0
("Failed„eading instance…id irk in XML");

1372 
DEV_PID_ADDR_TYPE_KEY
:

1373 
deviûs_db_±r
->
pid_addr_ty³
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1376 
DEV_PID_STATIC_ADDR_KEY
:

1377 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
pid_¡©ic_addr
,

1378 (
deviûs_db_±r
->
pid_¡©ic_addr
), 
d©a
, 
Ën
è=ğ
FALSE
)

1380 
	`APP_ERROR0
("Failed„eading instance…id static‡ddr in XML");

1384 
DEV_PCSRK_COUNTER_KEY
:

1385 
deviûs_db_±r
->
pc¤k_couÁ”
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1388 
DEV_PCSRK_CSRK_KEY
:

1389 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
deviûs_db_±r
->
pc¤k_c¤k
,

1390 (
deviûs_db_±r
->
pc¤k_c¤k
), 
d©a
, 
Ën
è=ğ
FALSE
)

1392 
	`APP_ERROR0
("Failed„eading instance…csrk csrk in XML");

1396 
DEV_PCSRK_SEC_LEVEL_KEY
:

1397 
deviûs_db_±r
->
pc¤k_£c_Ëv–
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1400 
DEV_LCSRK_COUNTER_KEY
:

1401 
deviûs_db_±r
->
lc¤k_couÁ”
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1404 
DEV_LCSRK_DIV_KEY
:

1405 
deviûs_db_±r
->
lc¤k_div
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1408 
DEV_LCSRK_SEC_LEVEL_KEY
:

1409 
deviûs_db_±r
->
lc¤k_£c_Ëv–
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1412 
DEV_LENC_DIV_KEY
:

1413 
deviûs_db_±r
->
Ënc_div
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1416 
DEV_LENC_KEY_SIZE_KEY
:

1417 
deviûs_db_±r
->
Ënc_key_size
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1420 
DEV_LENC_SEC_LEVEL_KEY
:

1421 
deviûs_db_±r
->
Ënc_£c_Ëv–
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1428 
	}
}

1439 
	$­p_xml_dev_db_gEndC®lbackFunc
(
nxml_t
 
hªdË
,

1440 cÚ¡ *
gName
, 
Ën
)

1442 
	}
}

1453 
	$­p_xml_si_dev_db_gBegšC®lbackFunc
(
nxml_t
 
hªdË
,

1454 cÚ¡ *
gName
, 
Ën
)

1456 ià(
	`¡ºcmp
(
gName
, 
APP_XML_SI_DEV_BDADDR_KEY
,

1457 
	`¡¾’
(
APP_XML_SI_DEV_BDADDR_KEY
)) == 0)

1459 
­p_xml_·¿m_cb
.
si_dev_g
 = 
SI_DEV_BDADDR_KEY
;

1461 ià(
	`¡ºcmp
(
gName
, 
APP_XML_SI_DEV_PLATFORM_KEY
,

1462 
	`¡¾’
(
APP_XML_SI_DEV_PLATFORM_KEY
)) == 0)

1464 
­p_xml_·¿m_cb
.
si_dev_g
 = 
SI_DEV_PLATFORM_KEY
;

1466 
	}
}

1477 
	$­p_xml_si_dev_db_©ŒBegšC®lbackFunc
(
nxml_t
 
hªdË
,

1478 cÚ¡ *
©ŒName
, 
Ën
)

1480 ià(
	`¡ºcmp
(
©ŒName
, 
APP_XML_SI_DEV_INST_KEY
, 
	`¡¾’
(APP_XML_SI_DEV_INST_KEY))

1483 
­p_xml_·¿m_cb
.
si_dev_g
 = 
SI_DEV_INST_KEY
;

1485 
	}
}

1496 
	$­p_xml_si_dev_db_©ŒV®ueC®lbackFunc
(
nxml_t
 
hªdË
,

1497 cÚ¡ *
©ŒV®ue
, 
Ën
, 
mÜe
)

1500 ià(
mÜe
)

1502 
	`APP_ERROR1
("NÚ com¶‘©Œibu‹ v®ue,…robably m®fÜmed XML fe: %s", 
©ŒV®ue
);

1505 
­p_xml_·¿m_cb
.
si_dev_š¡ªû
 = 
	`­p_xml_»ad_v®ue
(
©ŒV®ue
, 
Ën
);

1507 ià(
­p_xml_·¿m_cb
.
si_dev_š¡ªû
 >ğ­p_xml_·¿m_cb.
si_dev_max
)

1509 
	`APP_ERROR1
("bad in¡ªû‚umb” found:%d", 
­p_xml_·¿m_cb
.
si_dev_š¡ªû
);

1510 
­p_xml_·¿m_cb
.
si_dev_š¡ªû
 = 0;

1512 
	}
}

1523 
	$­p_xml_si_dev_db_d©aC®lbackFunc
(
nxml_t
 
hªdË
, cÚ¡ *
d©a
,

1524 
Ën
, 
mÜe
)

1526 
tAPP_XML_SI_DEVICE
 *
si_dev_db_±r
;

1529 ià(
mÜe
)

1531 
	`APP_ERROR1
("NÚ com¶‘d©a,…robably m®fÜmed XML fe: %s", 
d©a
);

1534 
si_dev_db_±r
 = 
­p_xml_·¿m_cb
.si_dev_db_±¸+‡µ_xml_·¿m_cb.
si_dev_š¡ªû
;

1536 
­p_xml_·¿m_cb
.
si_dev_g
)

1538 
SI_DEV_BDADDR_KEY
:

1539 ià(
	`­p_xml_»ad_d©a_Ëngth
(&
si_dev_db_±r
->
bd_addr
,

1540 (
si_dev_db_±r
->
bd_addr
), 
d©a
, 
Ën
è=ğ
FALSE
)

1542 
	`APP_ERROR0
("Failed„eading instance BD‡ddress in XML");

1544 
si_dev_db_±r
-> 
š_u£
 = 1;

1547 
SI_DEV_PLATFORM_KEY
:

1548 
si_dev_db_±r
->
¶©fÜm
 = 
	`­p_xml_»ad_v®ue
(
d©a
, 
Ën
);

1554 
	}
}

1565 
	$­p_xml_si_dev_db_gEndC®lbackFunc
(
nxml_t
 
hªdË
,

1566 cÚ¡ *
gName
, 
Ën
)

1568 
	}
}

1579 
	$­p_xml_add_dev_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1580 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
)

1582 
šdex
;

1585 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1587 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1588 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1594 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1597 ià(
p_¡Üed_deviû_db
[
šdex
].
š_u£
 =ğ
FALSE
)

1599 
	`mem£t
(&
p_¡Üed_deviû_db
[
šdex
], 0, (
tAPP_XML_REM_DEVICE
));

1601 
p_¡Üed_deviû_db
[
šdex
].
š_u£
 = 
TRUE
;

1602 
	`bdıy
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr);

1607 
	}
}

1618 
tAPP_XML_REM_DEVICE
 *
	$­p_xml_fšd_dev_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1619 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
)

1621 
šdex
;

1624 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1626 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
) &&

1627 (
	`bdcmp
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1629  &
p_¡Üed_deviû_db
[
šdex
];

1632  
NULL
;

1633 
	}
}

1644 
	$­p_xml_upd©e_key_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1645 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
LINK_KEY
 
lšk_key
,

1646 
key_ty³
)

1648 
šdex
;

1649 
»t_code
 = -1;

1651 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1654 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1656 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1657 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1659 
»t_code
 = 0;

1660 
	`´štf
("Update†ink key\n");

1661 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
lšk_key
,†ink_key,

1662 (
LINK_KEY
));

1663 
p_¡Üed_deviû_db
[
šdex
].
lšk_key_´e£Á
 = 
TRUE
;

1664 
p_¡Üed_deviû_db
[
šdex
].
key_ty³
 = key_type;

1668  
»t_code
;

1669 
	}
}

1671 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

1681 
	$­p_xml_upd©e_bË_key_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1682 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
tBSA_LE_KEY_VALUE
 
bË_key
,

1683 
tBSA_LE_KEY_TYPE
 
bË_key_ty³
)

1685 
šdex
;

1686 
»t_code
 = -1;

1688 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1691 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1693 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1694 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1696 
»t_code
 = 0;

1697 
	`´štf
("Update BLE†ink key\n");

1698 
p_¡Üed_deviû_db
[
šdex
].
bË_lšk_key_´e£Á
 = 
TRUE
;

1699 
bË_key_ty³
)

1701 
BSA_LE_KEY_PENC
:

1702 
	`´štf
("Update BSA_LE_KEY_PENC\n");

1703 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
³nc_Ék
, 
bË_key
.
³nc_key
.
Ék
,

1704 (
p_¡Üed_deviû_db
[
šdex
].
³nc_Ék
));

1705 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
³nc_¿nd
, 
bË_key
.
³nc_key
.
¿nd
,

1706 (
p_¡Üed_deviû_db
[
šdex
].
³nc_¿nd
));

1707 
p_¡Üed_deviû_db
[
šdex
].
³nc_ediv
 = 
bË_key
.
³nc_key
.
ediv
;

1708 
p_¡Üed_deviû_db
[
šdex
].
³nc_£c_Ëv–
 = 
bË_key
.
³nc_key
.
£c_Ëv–
;

1709 
p_¡Üed_deviû_db
[
šdex
].
³nc_key_size
 = 
bË_key
.
³nc_key
.
key_size
;

1711 
BSA_LE_KEY_PID
:

1712 
	`´štf
("Update BSA_LE_KEY_PID\n");

1713 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
pid_œk
, 
bË_key
.
pid_key
.
œk
,

1714 (
p_¡Üed_deviû_db
[
šdex
].
pid_œk
));

1715 
p_¡Üed_deviû_db
[
šdex
].
pid_addr_ty³
 = 
bË_key
.
pid_key
.
addr_ty³
;

1716 
	`bdıy
(
p_¡Üed_deviû_db
[
šdex
].
pid_¡©ic_addr
, 
bË_key
.
pid_key
.
¡©ic_addr
);

1718 
BSA_LE_KEY_PCSRK
:

1719 
	`´štf
("Update BSA_LE_KEY_PCSRK\n");

1720 
p_¡Üed_deviû_db
[
šdex
].
pc¤k_couÁ”
 = 
bË_key
.
pc¤k_key
.
couÁ”
;

1721 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
pc¤k_c¤k
, 
bË_key
.
pc¤k_key
.
c¤k
,

1722 (
p_¡Üed_deviû_db
[
šdex
].
pc¤k_c¤k
));

1723 
p_¡Üed_deviû_db
[
šdex
].
pc¤k_£c_Ëv–
 = 
bË_key
.
pc¤k_key
.
£c_Ëv–
;

1725 
BSA_LE_KEY_LCSRK
:

1726 
	`´štf
("Update BSA_LE_KEY_LCSRK\n");

1727 
p_¡Üed_deviû_db
[
šdex
].
lc¤k_couÁ”
 = 
bË_key
.
lc¤k_key
.
couÁ”
;

1728 
p_¡Üed_deviû_db
[
šdex
].
lc¤k_div
 = 
bË_key
.
lc¤k_key
.
div
;

1729 
p_¡Üed_deviû_db
[
šdex
].
lc¤k_£c_Ëv–
 = 
bË_key
.
lc¤k_key
.
£c_Ëv–
;

1731 
BSA_LE_KEY_LENC
:

1732 
	`´štf
("Update BSA_LE_KEY_LENC\n");

1733 
p_¡Üed_deviû_db
[
šdex
].
Ënc_div
 = 
bË_key
.
Ënc_key
.
div
;

1734 
p_¡Üed_deviû_db
[
šdex
].
Ënc_key_size
 = 
bË_key
.
Ënc_key
.
key_size
;

1735 
p_¡Üed_deviû_db
[
šdex
].
Ënc_£c_Ëv–
 = 
bË_key
.
Ënc_key
.
£c_Ëv–
;

1737 
BSA_LE_KEY_LID
:

1738 
	`´štf
("Update BSA_LE_KEY_LID\n");

1741 
	`´štf
("UnknowÀkey(%d)", 
bË_key_ty³
);

1747  
»t_code
;

1748 
	}
}

1760 
	$­p_xml_d–_§me_£rviûs_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1761 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
tBSA_SERVICE_MASK
 
Œu¡ed_£rviûs
)

1763 
šdex
,
»t
=-1,
»t2
;

1765 
»t2
 = 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1768 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1770 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
) &&

1771 (
	`bdcmp
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) != 0) &&

1772 (
p_¡Üed_deviû_db
[
šdex
].
Œu¡ed_£rviûs
 ==rusted_services))

1774 
	`APP_INFO1
("d– s”viûs=%x,bd_addr=%02x:%02x:%02x:%02x:%02x:%02x",
Œu¡ed_£rviûs
,

1775 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[0],p_stored_device_db[index].bd_addr[1],

1776 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[2],p_stored_device_db[index].bd_addr[3],

1777 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[4],p_stored_device_db[index].bd_addr[5]);

1778 
	`­p_mgr_»move_deviû
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
);

1779 
p_¡Üed_deviû_db
[
šdex
].
š_u£
 = 
FALSE
;

1780 
»t
 = 0;

1794 if(
»t2
 == 0)

1795 
»t
 = 0;

1796  
»t
;

1797 
	}
}

1808 
	$­p_xml_add_Œu¡ed_£rviûs_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1809 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
tBSA_SERVICE_MASK
 
Œu¡ed_£rviûs
)

1811 
šdex
,
»t2
,
»t3
;

1813 
»t2
 = 
	`­p_xml_d–_§me_£rviûs_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
, 
Œu¡ed_£rviûs
);

1814 
»t3
 = 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1816 if(
Œu¡ed_£rviûs
 != 0)

1817 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1819 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1820 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1822 
	`APP_INFO1
("cu¸£rviû=%x,wÈ§v£rviû=%x,bd_addr=%02x:%02x:%02x:%02x:%02x:%02x",
p_¡Üed_deviû_db
[
šdex
].
Œu¡ed_£rviûs
,trusted_services,

1823 ()
bd_addr
[0],()bd_addr[1],

1824 ()
bd_addr
[2],()bd_addr[3],

1825 ()
bd_addr
[4],()bd_addr[5]);

1826 if((
p_¡Üed_deviû_db
[
šdex
].
Œu¡ed_£rviûs
 &rusted_services) !=rusted_services)

1828 
	`´štf
("Addedrusted services\n");

1829 
p_¡Üed_deviû_db
[
šdex
].
Œu¡ed_£rviûs
 |=rusted_services;

1833 if((
»t2
 =ğ0è|| (
»t3
 == 0))

1840 if((
»t2
 =ğ0è|| (
»t3
 == 0))

1844 
	}
}

1855 
	$­p_xml_upd©e_Çme_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1856 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
BD_NAME
 
Çme
)

1858 
šdex
,
»t
;

1860 
»t
 = 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1862 if(
	`¡¾’
(
Çme
)>0)

1864 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1866 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1867 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1869 if(
	`¡rcmp
(
p_¡Üed_deviû_db
[
šdex
].
Çme
,‚ame) != 0)

1871 
	`APP_INFO1
("cu¸Çme=%s,wÈ§vÇme=%s,bd_addr=%02x:%02x:%02x:%02x:%02x:%02x",
p_¡Üed_deviû_db
[
šdex
].
Çme
,name,

1872 ()
bd_addr
[0],()bd_addr[1],

1873 ()
bd_addr
[2],()bd_addr[3],

1874 ()
bd_addr
[4],()bd_addr[5]);

1876 
	`´štf
("Upd©Çmw™h %s\n", 
Çme
);

1877 
	`¡ºıy
((*è
p_¡Üed_deviû_db
[
šdex
].
Çme
, (*)‚ame,

1878 (
p_¡Üed_deviû_db
[
šdex
].
Çme
) - 1);

1879 
p_¡Üed_deviû_db
[
šdex
].
Çme
[(p_stored_device_db[index].name) - 1] = '\0';

1881 }if(
»t
 == 0)

1887  
»t
;

1888 
	}
}

1899 
	$­p_xml_upd©e_cod_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1900 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
DEV_CLASS
 
şass_of_deviû
)

1902 
šdex
,
»t
;

1904 
»t
 = 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1905 if((
şass_of_deviû
[0]!=0) || (class_of_device[1]!=0) || (class_of_device[2]!=0))

1907 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1909 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

1910 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

1912 if(
	`memcmp
(
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
, class_of_device, 3) !=0)

1914 
	`APP_INFO1
("cur cod=%02x:%02x:%02x,will save cod=%02x:%02x:%02x,bd_addr=%02x:%02x:%02x:%02x:%02x:%02x",

1915 ()
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[0],()p_stored_device_db[index].class_of_device[1],()p_stored_device_db[index].class_of_device[2],

1916 ()
şass_of_deviû
[0],()class_of_device[1],()class_of_device[2],

1917 ()
bd_addr
[0],()bd_addr[1],

1918 ()
bd_addr
[2],()bd_addr[3],

1919 ()
bd_addr
[4],()bd_addr[5]);

1920 
	`´štf
("Update class-of-device [0x%02X-0x%02X-0x%02X]\n",

1921 
şass_of_deviû
[0], class_of_device[1], class_of_device[2]);

1922 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[0] = class_of_device[0];

1923 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[1] = class_of_device[1];

1924 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[2] = class_of_device[2];

1926 }if(
»t
 ==0)

1932  
»t
;

1933 
	}
}

1944 
	$­p_xml_di¥Ïy_deviûs
(cÚ¡ 
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1945 
nb_deviû_max
)

1947 
šdex
;

1950 
šdex
 = 0; index < 
nb_deviû_max
; index++)

1952 ià(
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
)

1954 
	`´štf
("Dev:%d\n", 
šdex
);

1955 
	`´štf
("\tBdaddr:%02x:%02x:%02x:%02x:%02x:%02x\n",

1956 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[0],

1957 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[1],

1958 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[2],

1959 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[3],

1960 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[4],

1961 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
[5]);

1962 
	`´štf
("\tName:%s\n", 
p_¡Üed_deviû_db
[
šdex
].
Çme
);

1963 
	`´štf
("\tClassOfDevice:%02x:%02x:%02x => %s\n",

1964 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[0],

1965 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[1],

1966 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
[2],

1967 
	`­p_g‘_cod_¡ršg
(

1968 
p_¡Üed_deviû_db
[
šdex
].
şass_of_deviû
));

1969 
	`´štf
("\tTrusted Services:%x\n",

1970 (è
p_¡Üed_deviû_db
[
šdex
].
Œu¡ed_£rviûs
);

1971 ià(
p_¡Üed_deviû_db
[
šdex
].
lšk_key_´e£Á
 !ğ
FALSE
)

1972 
	`´štf
("\tLink Key…resent:TRUE\n");

1974 
	`´štf
("\tLink Key…resent:FALSE\n");

1976 
	`´štf
("\tPid:%x Vid:%d\n", 
p_¡Üed_deviû_db
[
šdex
].
pid
,

1977 
p_¡Üed_deviû_db
[
šdex
].
vid
);

1981 
	}
}

1992 
	$­p_xml_upd©e_pidvid_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

1993 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT16
 
pid
, UINT16 
vid
)

1995 
šdex
,
»t
;

1997 
»t
 = 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

1998 if((
pid
!=0è|| (
vid
!=0))

2000 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2002 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2003 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2005 
	`´štf
("Upd©Pid:0x%x Vid:0x%x\n", 
pid
, 
vid
);

2006 
p_¡Üed_deviû_db
[
šdex
].
pid
 =…id;

2007 
p_¡Üed_deviû_db
[
šdex
].
vid
 = vid;

2011  
»t
;

2012 
	}
}

2023 
	$­p_xml_upd©e_v”siÚ_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2024 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT16
 
v”siÚ
)

2026 
šdex
;

2028 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2031 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2033 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2034 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2036 
	`´štf
("Upd©V”siÚ:0x%04X\n", 
v”siÚ
);

2037 
p_¡Üed_deviû_db
[
šdex
].
v”siÚ
 = version;

2042 
	}
}

2053 
	$­p_xml_upd©e_ã©u»s_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2054 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
BD_FEATURES
 
ã©u»s
)

2056 
šdex
;

2058 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2061 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2063 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2064 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2066 
	`´štf
("Update features:%02X:%02X:%02X:%02X:%02X:%02X:%02X:%02X\n",

2067 
ã©u»s
[0], features[1], features[2], features[3],

2068 
ã©u»s
[3], features[4], features[5], features[6]);

2069 
	`memıy
(
p_¡Üed_deviû_db
[
šdex
].
ã©u»s
, f—tu»s, (
BD_FEATURES
));

2074 
	}
}

2085 
	$­p_xml_upd©e_lmp_v”siÚ_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2086 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT8
 
lmp_v”siÚ
)

2088 
šdex
;

2090 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2093 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2095 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2096 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2098 
	`´štf
("Upd©lmp_v”siÚ:%d\n", 
lmp_v”siÚ
);

2099 
p_¡Üed_deviû_db
[
šdex
].
lmp_v”siÚ
 =†mp_version;

2104 
	}
}

2106 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

2116 
	$­p_xml_upd©e_bË_addr_ty³_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2117 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT8
 
bË_addr_ty³
)

2119 
šdex
;

2121 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2123 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2125 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2126 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2128 
	`APP_DEBUG1
("Upd©bË_addr_ty³:%d\n", 
bË_addr_ty³
);

2129 
p_¡Üed_deviû_db
[
šdex
].
bË_addr_ty³
 = ble_addr_type;

2134 
	}
}

2145 
	$­p_xml_upd©e_deviû_ty³_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2146 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
tBT_DEVICE_TYPE
 
deviû_ty³
)

2148 
šdex
;

2150 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2153 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2155 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2156 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2158 
	`´štf
("Upd©deviû_ty³:%d\n", 
deviû_ty³
);

2159 
p_¡Üed_deviû_db
[
šdex
].
deviû_ty³
 = device_type;

2161 }if((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&&Õ_¡Üed_deviû_db[šdex].
deviû_ty³
 == device_type)) {

2162 
p_¡Üed_deviû_db
[
šdex
].
š_u£
 = 
FALSE
;

2167 
	}
}

2178 
	$­p_xml_upd©e_šq_»suÉ_ty³_db
(
tAPP_XML_REM_DEVICE
 *
p_¡Üed_deviû_db
,

2179 
nb_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT8
 
šq_»s_ty³
)

2181 
šdex
;

2183 
	`­p_xml_add_dev_db
(
p_¡Üed_deviû_db
, 
nb_deviû_max
, 
bd_addr
);

2186 
šdex
 = 0; index < 
nb_deviû_max
; index++)

2188 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
 !ğ
FALSE
è&& (
	`bdcmp
(

2189 
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2191 
	`´štf
("Upd©šquœy„esuÉy³ :%d\n", 
šq_»s_ty³
);

2192 
p_¡Üed_deviû_db
[
šdex
].
šq_»suÉ_ty³
ğ
šq_»s_ty³
;

2197 
	}
}

2211 
tAPP_XML_SI_DEVICE
 *
	$­p_xml_add_si_dev_db
(
tAPP_XML_SI_DEVICE
 *
p_¡Üed_deviû_db
,

2212 
si_deviû_max
, 
BD_ADDR
 
bd_addr
)

2214 
šdex
;

2217 
šdex
 = 0; index < 
si_deviû_max
; index++)

2219 ià((
p_¡Üed_deviû_db
[
šdex
].
š_u£
) &&

2220 (
	`bdcmp
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr) == 0))

2222  &
p_¡Üed_deviû_db
[
šdex
];

2227 
šdex
 = 0; index < 
si_deviû_max
; index++)

2230 ià(
p_¡Üed_deviû_db
[
šdex
].
š_u£
 =ğ
FALSE
)

2232 
	`mem£t
(&
p_¡Üed_deviû_db
[
šdex
], 0, (
tAPP_XML_SI_DEVICE
));

2234 
p_¡Üed_deviû_db
[
šdex
].
š_u£
 = 
TRUE
;

2235 
	`bdıy
(
p_¡Üed_deviû_db
[
šdex
].
bd_addr
, bd_addr);

2236  &
p_¡Üed_deviû_db
[
šdex
];

2239  
NULL
;

2240 
	}
}

2251 
	$­p_xml_upd©e_si_dev_¶©fÜm_db
(
tAPP_XML_SI_DEVICE
 *
p_¡Üed_deviû_db
,

2252 
si_deviû_max
, 
BD_ADDR
 
bd_addr
, 
UINT8
 
¶©fÜm
)

2254 
tAPP_XML_SI_DEVICE
 *
p_si_deviû
 = 
	`­p_xml_add_si_dev_db
(
p_¡Üed_deviû_db
,

2255 
si_deviû_max
, 
bd_addr
);

2257 ià(
p_si_deviû
 !ğ
NULL
)

2259 
	`´štf
("Upd©¶©fÜm:%d\n", 
¶©fÜm
);

2260 
p_si_deviû
->
¶©fÜm
 =…latform;

2264 
	}
}

	@source/app_common/app_xml_utils.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<ùy³.h
>

15 
	~<fú.h
>

16 
	~<uni¡d.h
>

18 
	~"­p_xml_uts.h
"

19 
	~"­p_uts.h
"

24 
	#APP_XML_TAG_OPEN_PREFIX
 "<"

	)

25 
	#APP_XML_TAG_CLOSE_PREFIX
 "</"

	)

26 
	#APP_XML_TAG_SUFFIX
 ">"

	)

27 
	#APP_XML_CR
 "\n"

	)

28 
	#APP_XML_TAG_SUFFIX_CR
 
APP_XML_TAG_SUFFIX
 
APP_XML_CR


	)

29 
	#APP_XML_TAG_OPEN_CLOSE_SUFFIX
 "/" 
APP_XML_TAG_SUFFIX_CR


	)

31 
	#APP_XML_CONFIG_FILE_PATH
 "/u¤/d©a/b§/bt_cÚfig.xml"

	)

32 
	#APP_XML_REM_DEVICES_FILE_PATH
 "/u¤/d©a/b§/bt_deviûs.xml"

	)

33 
	#APP_XML_SI_DEVICES_FILE_PATH
 "/u¤/d©a/b§/si_deviûs.xml"

	)

38 
tAPP_XML_REM_DEVICE
 
	g­p_xml_»mÙe_deviûs_db
[
APP_MAX_NB_REMOTE_STORED_DEVICES
];

39 
tAPP_XML_SI_DEVICE
 
	g­p_xml_si_deviûs_db
[
APP_MAX_SI_DEVICES
];

41 
	gŒ“Ëv–
 = 0;

55 
	$­p_»ad_xml_cÚfig
(
tAPP_XML_CONFIG
 *
p_xml_cÚfig
)

57 
¡©us
;

59 
¡©us
 = 
	`­p_xml_»ad_cfg
(
APP_XML_CONFIG_FILE_PATH
, 
p_xml_cÚfig
);

61 ià(
¡©us
 < 0)

63 
	`APP_ERROR1
("­p_xml_»ad_cfg faed: %d", 
¡©us
);

68 
	`APP_DEBUG0
("app_read_xml_config:");

69 
	`APP_DEBUG1
("\tEÇbË:%d", 
p_xml_cÚfig
->
’abË
);

70 
	`APP_DEBUG1
("\tDiscov”abË:%d", 
p_xml_cÚfig
->
discov”abË
);

71 
	`APP_DEBUG1
("\tCÚÃùabË:%d", 
p_xml_cÚfig
->
cÚÃùabË
);

72 
	`APP_DEBUG1
("\tName:%s", 
p_xml_cÚfig
->
Çme
);

73 
	`APP_DEBUG1
 ("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

74 
p_xml_cÚfig
->
bd_addr
[0],…_xml_config->bd_addr[1],

75 
p_xml_cÚfig
->
bd_addr
[2],…_xml_config->bd_addr[3],

76 
p_xml_cÚfig
->
bd_addr
[4],…_xml_config->bd_addr[5]);

77 
	`APP_DEBUG1
("\tCÏssOfDeviû:%02x:%02x:%02x => %s", 
p_xml_cÚfig
->
şass_of_deviû
[0],

78 
p_xml_cÚfig
->
şass_of_deviû
[1],…_xml_config->class_of_device[2],

79 
	`­p_g‘_cod_¡ršg
(
p_xml_cÚfig
->
şass_of_deviû
));

80 
	`APP_DEBUG1
("\tRoÙP©h:%s", 
p_xml_cÚfig
->
roÙ_·th
);

81 
	`APP_DEBUG1
("\tDeçuÉ PIN (%d):%s", 
p_xml_cÚfig
->
pš_Ën
,…_xml_cÚfig->
pš_code
);

84 
	}
}

97 
	$­p_wr™e_xml_cÚfig
(cÚ¡ 
tAPP_XML_CONFIG
 *
p_xml_cÚfig
)

99 
¡©us
;

101 
	`APP_INFO1
("====%s %d=================blue MAC:->%02x-%02x-%02x-%02x-%02x-%02x-",

102 
__FUNCTION__
, 
__LINE__
,

103 
p_xml_cÚfig
->
bd_addr
[0],p_xml_config->bd_addr[1],

104 
p_xml_cÚfig
->
bd_addr
[2],p_xml_config->bd_addr[3],

105 
p_xml_cÚfig
->
bd_addr
[4],p_xml_config->bd_addr[5]);

106 
¡©us
 = 
	`­p_xml_wr™e_cfg
(
APP_XML_CONFIG_FILE_PATH
, 
p_xml_cÚfig
);

108 ià(
¡©us
 < 0)

110 
	`APP_ERROR1
("­p_xml_wr™e_cfg faed: %d", 
¡©us
);

115 
	`APP_DEBUG1
("\tEÇbË:%d", 
p_xml_cÚfig
->
’abË
);

116 
	`APP_DEBUG1
("\tDiscov”abË:%d", 
p_xml_cÚfig
->
discov”abË
);

117 
	`APP_DEBUG1
("\tCÚÃùabË:%d", 
p_xml_cÚfig
->
cÚÃùabË
);

118 
	`APP_DEBUG1
("\tName:%s", 
p_xml_cÚfig
->
Çme
);

119 
	`APP_DEBUG1
 ("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

120 
p_xml_cÚfig
->
bd_addr
[0],…_xml_config->bd_addr[1],

121 
p_xml_cÚfig
->
bd_addr
[2],…_xml_config->bd_addr[3],

122 
p_xml_cÚfig
->
bd_addr
[4],…_xml_config->bd_addr[5]);

123 
	`APP_DEBUG1
("\tCÏssOfDeviû:%02x:%02x:%02x", 
p_xml_cÚfig
->
şass_of_deviû
[0],

124 
p_xml_cÚfig
->
şass_of_deviû
[1],…_xml_config->class_of_device[2]);

125 
	`APP_DEBUG1
("\tRoÙP©h:%s", 
p_xml_cÚfig
->
roÙ_·th
);

126 
	`APP_DEBUG1
("\tDeçuÉ PIN (%d):%s", 
p_xml_cÚfig
->
pš_Ën
,…_xml_cÚfig->
pš_code
);

129 
	}
}

142 
	$­p_»ad_xml_»mÙe_deviûs
()

144 
¡©us
;

146 
	`mem£t
(
­p_xml_»mÙe_deviûs_db
, 0, (app_xml_remote_devices_db));

148 
¡©us
 = 
	`­p_xml_»ad_db
(
APP_XML_REM_DEVICES_FILE_PATH
, 
­p_xml_»mÙe_deviûs_db
,

149 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

151 ià(
¡©us
 < 0)

153 
	`APP_ERROR1
("­p_xml_»ad_db faed: %d", 
¡©us
);

158 
	`APP_DEBUG1
("»ad(%s): OK", 
APP_XML_REM_DEVICES_FILE_PATH
);

161 
	}
}

174 
	$­p_wr™e_xml_»mÙe_deviûs
()

176 
¡©us
;

178 
¡©us
 = 
	`­p_xml_wr™e_db
(
APP_XML_REM_DEVICES_FILE_PATH
,

179 
­p_xml_»mÙe_deviûs_db
, 
	`APP_NUM_ELEMENTS
(app_xml_remote_devices_db));

181 ià(
¡©us
 < 0)

183 
	`APP_ERROR1
("­p_xml_wr™e_db faed: %d", 
¡©us
);

188 
	`APP_DEBUG1
("wr™e(%s): OK", 
APP_XML_REM_DEVICES_FILE_PATH
);

191 
	}
}

204 
	$­p_xml_is_deviû_šdex_v®id
(
šdex
)

206 ià((
šdex
 >= 0) &&

207 (
šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

208 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
š_u£
 !ğ
FALSE
))

213 
	}
}

226 
	$­p_»ad_xml_si_deviûs
()

228 
¡©us
;

230 
	`mem£t
(
­p_xml_si_deviûs_db
, 0, (app_xml_si_devices_db));

232 
¡©us
 = 
	`­p_xml_»ad_si_db
(
APP_XML_SI_DEVICES_FILE_PATH
, 
­p_xml_si_deviûs_db
,

233 
	`APP_NUM_ELEMENTS
(
­p_xml_si_deviûs_db
));

235 ià(
¡©us
 < 0)

237 
	`APP_ERROR1
("­p_xml_»ad_si_db faed: %d", 
¡©us
);

242 
	`APP_DEBUG1
("»ad(%s): OK", 
APP_XML_SI_DEVICES_FILE_PATH
);

245 
	}
}

258 
	$­p_wr™e_xml_si_deviûs
()

260 
¡©us
;

262 
¡©us
 = 
	`­p_xml_wr™e_si_db
(
APP_XML_SI_DEVICES_FILE_PATH
,

263 
­p_xml_si_deviûs_db
, 
	`APP_NUM_ELEMENTS
(app_xml_si_devices_db));

265 ià(
¡©us
 < 0)

267 
	`APP_ERROR1
("­p_xml_wr™e_si_db faed: %d", 
¡©us
);

272 
	`APP_DEBUG1
("wr™e(%s): OK", 
APP_XML_SI_DEVICES_FILE_PATH
);

275 
	}
}

290 
	$­p_xml_İ’_g
(
fd
, cÚ¡ *
g
, 
BOOLEAN
 
ü
)

292 
i
, 
dummy
;

295 
i
 = 0; i < 
Œ“Ëv–
; i++)

297 
dummy
 = 
	`wr™e
(
fd
, " ", 2);

298 ()
dummy
;

302 
	`d´štf
(
fd
, 
APP_XML_TAG_OPEN_PREFIX
);

303 
dummy
 = 
	`wr™e
(
fd
, 
g
, 
	`¡¾’
(tag));

304 ()
dummy
;

305 
	`d´štf
(
fd
, 
APP_XML_TAG_SUFFIX
);

306 ià(
ü
 =ğ
TRUE
)

308 
	`d´štf
(
fd
, 
APP_XML_CR
);

312 
Œ“Ëv–
++;

315 
	}
}

330 
	$­p_xml_şo£_g
(
fd
, cÚ¡ *
g
, 
BOOLEAN
 
ü
)

332 
i
, 
dummy
;

335 
Œ“Ëv–
--;

338 ià(
ü
)

340 
i
 = 0; i < 
Œ“Ëv–
; i++)

342 
dummy
 = 
	`wr™e
(
fd
, " ", 2);

343 ()
dummy
;

348 
	`d´štf
(
fd
, 
APP_XML_TAG_CLOSE_PREFIX
);

349 
dummy
 = 
	`wr™e
(
fd
, 
g
, 
	`¡¾’
(tag));

350 ()
dummy
;

351 
	`d´štf
(
fd
, 
APP_XML_TAG_SUFFIX_CR
);

354 
	}
}

369 
	$­p_xml_İ’_g_w™h_v®ue
(
fd
, *
g
, 
v®ue
)

371 
i
, 
dummy
;

374 
i
 = 0; i < 
Œ“Ëv–
; i++)

376 
dummy
 = 
	`wr™e
(
fd
, " ", 2);

377 ()
dummy
;

381 
	`d´štf
(
fd
, 
APP_XML_TAG_OPEN_PREFIX
);

382 
	`d´štf
(
fd
, "% v®uğ\"%d\"", 
g
, 
v®ue
);

383 
	`d´štf
(
fd
, 
APP_XML_TAG_SUFFIX_CR
);

386 
Œ“Ëv–
++;

389 
	}
}

404 
	$­p_xml_İ’_şo£_g_w™h_v®ue
(
fd
, *
g
, 
v®ue
)

406 
i
, 
dummy
;

409 
i
 = 0; i < 
Œ“Ëv–
; i++)

411 
dummy
 = 
	`wr™e
(
fd
, " ", 2);

412 ()
dummy
;

416 
	`d´štf
(
fd
, 
APP_XML_TAG_OPEN_PREFIX
);

417 
	`d´štf
(
fd
, "% v®uğ\"%d\"", 
g
, 
v®ue
);

418 
	`d´štf
(
fd
, 
APP_XML_TAG_OPEN_CLOSE_SUFFIX
);

421 
	}
}

437 
	$­p_xml_wr™e_d©a
(
fd
, cÚ¡ *
p_buf
, 
Ëngth
, 
BOOLEAN
 
ü
)

439 
dummy
;

440 
šdex
;

441 cÚ¡ *
p_d©a
 = 
p_buf
;

443 
šdex
 = 0; index < 
Ëngth
; index++)

446 
	`d´štf
(
fd
, "%02X", 
p_d©a
[
šdex
]);

448 ià(((
šdex
 % 32) == 31))

450 
dummy
 = 
	`wr™e
(
fd
, "\n", 1);

451 ()
dummy
;

455 
dummy
 = 
	`wr™e
(
fd
, ":", 1);

456 ()
dummy
;

461 ià(
ü
 && ((
Ëngth
 % 32) != 0))

463 
dummy
 = 
	`wr™e
(
fd
, "\n", 1);

464 ()
dummy
;

467 
	}
}

482 *
	$­p_xml_»ad_d©a
(*
p_d©®’
, cÚ¡ *
p_buf
, 
Ëngth
)

484 *
p_Ãwbuf
, *
p_d©abuf
, *
p_d©a
;

485 
v®id
, 
®locsize
 = 1024;

486 
šdex
;

489 *
p_d©®’
 = 0;

491 
p_d©abuf
 = 
	`m®loc
(
®locsize
);

492 ià(
p_d©abuf
 =ğ
NULL
)

494 
	`APP_ERROR0
("Failed‡llocating buffer");

495  
NULL
;

498 
p_d©a
 = 
p_d©abuf
;

501 
v®id
 = 0;

502 *
p_d©a
 = 0;

504 
šdex
 = 0; index < 
Ëngth
; index++)

507 ià((
p_buf
[
šdex
] == ':') || (p_buf[index] == '\n') ||

508 (
	`is¥aû
(()
p_buf
[
šdex
]è&& 
v®id
))

510 
p_d©a
++;

512 ià((
p_d©a
 - 
p_d©abuf
è=ğ
®locsize
)

515 
®locsize
 += 1024;

516 
p_Ãwbuf
 = 
	`»®loc
(
p_d©abuf
, 
®locsize
);

517 ià(
p_Ãwbuf
 =ğ
NULL
)

519 
	`APP_ERROR0
("Failed„eallocating buffer");

520 
	`ä“
(
p_d©abuf
);

521  
NULL
;

524 
p_d©a
 = &
p_Ãwbuf
[p_d©¨- 
p_d©abuf
];

527 
p_d©abuf
 = 
p_Ãwbuf
;

530 
v®id
 = 0;

531 *
p_d©a
 = 0;

533 ià(
	`isxdig™
(()
p_buf
[
šdex
]))

536 *
p_d©a
 *= 16;

537 ià(
p_buf
[
šdex
] <= '9')

538 *
p_d©a
 +ğ
p_buf
[
šdex
]-'0';

539 ià(
p_buf
[
šdex
] <= 'F')

540 *
p_d©a
 +ğ
p_buf
[
šdex
]-'A' + 10;

542 *
p_d©a
 +ğ
p_buf
[
šdex
]-'a' + 10;

544 
v®id
 = 1;

546 ià(
	`is¥aû
(()
p_buf
[
šdex
]))

552 
	`APP_ERROR1
("UnsuµÜ‹d ch¬aù” iÀd©¨: x%x", 
p_buf
[
šdex
]);

557 ià(
v®id
)

559 
p_d©a
++;

563 *
p_d©®’
 = 
p_d©a
 - 
p_d©abuf
;

566 ià(*
p_d©®’
 == 0)

568 
	`ä“
(
p_d©abuf
);

569  
NULL
;

573 
p_Ãwbuf
 = 
	`»®loc
(
p_d©abuf
, *
p_d©®’
);

574 ià(
p_Ãwbuf
 =ğ
NULL
)

576 
	`APP_ERROR0
("Failed„esizing buffer");

577 *
p_d©®’
 = 0;

578 
	`ä“
(
p_d©abuf
);

579  
NULL
;

581  
p_Ãwbuf
;

582 
	}
}

598 
BOOLEAN
 
	$­p_xml_»ad_d©a_Ëngth
(*
p_d©a
, 
d©®’
, cÚ¡ *
p_buf
, 
Ëngth
)

600 *
p_Ãwbuf
;

601 
ÃwËn
;

602 
BOOLEAN
 
»suÉ
 = 
FALSE
;

605 
p_Ãwbuf
 = 
	`­p_xml_»ad_d©a
(&
ÃwËn
, 
p_buf
, 
Ëngth
);

608 ià(
ÃwËn
 =ğ
d©®’
)

610 
	`memıy
(
p_d©a
, 
p_Ãwbuf
, 
d©®’
);

611 
»suÉ
 = 
TRUE
;

613 
	`ä“
(
p_Ãwbuf
);

615  
»suÉ
;

616 
	}
}

632 
	$­p_xml_»ad_¡ršg
(*
p_¡ršg
, 
¡ršgËn
, cÚ¡ *
p_buf
, 
Ëngth
)

634 *
p_d©a
 = 
p_¡ršg
;

635 
mšËn
 = ((
¡ršgËn
-1è< 
Ëngth
)?(stringlen-1):length;

638 
	`memıy
(
p_d©a
, 
p_buf
, 
mšËn
);

641 
p_d©a
[
mšËn
] = 0;

644 
	}
}

658 
	$­p_xml_»ad_v®ue
(cÚ¡ *
p_buf
, 
Ëngth
)

660 
v®ue
;

661 *
p_’d
;

663 
v®ue
 = 
	`¡¹oul
(
p_buf
, &
p_’d
, 0);

666 ià((
p_’d
 - 
p_buf
è!ğ
Ëngth
)

668 
	`APP_ERROR1
("V®u·r£d did‚Ù u£‡Î bufã¸(%s)", 
p_buf
);

670  
v®ue
;

671 
	}
}

687 
	$­p_xml_g‘_cod_äom_bd
(
BD_ADDR
 
bd_addr
, 
DEV_CLASS
* 
p_cod
)

689 
šdex
;

691 
šdex
 = 0; index < 
APP_MAX_NB_REMOTE_STORED_DEVICES
; index++)

693 ià((
­p_xml_»mÙe_deviûs_db
[
šdex
].
š_u£
 =ğ
TRUE
) &&

694 (
	`bdcmp
(
bd_addr
,
­p_xml_»mÙe_deviûs_db
[
šdex
].bd_addr) == 0))

696 
	`memıy
(
p_cod
,
­p_xml_»mÙe_deviûs_db
[
šdex
].
şass_of_deviû
,(
DEV_CLASS
));

702 
	}
}

	@source/app_common/nanoxml.c

12 
	~"Çnoxml.h
"

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

17 #ifdeà
DMALLOC


18 
	~"dm®loc.h
"

21 
	#ALLOC_ZEROIZE
 0

	)

23 *
	$cmsMem_®loc
(
size
, 
æag
)

25  
	`m®loc
(
size
);

26 
	}
}

28 
	$cmsMem_ä“
(*
±r
)

30 
	`ä“
(
±r
);

31 
	}
}

33 
	$xmlO³n
(
nxml_t
 *
hªdË
, cÚ¡ 
nxml_£‰šgs
 *
£‰šgs
)

35 ià((*
hªdË
 = (
nxml_t
)
	`cmsMem_®loc
((**hªdË), 
ALLOC_ZEROIZE
)è!ğ
NULL
) {

36 (*
hªdË
)->
£‰šgs
 = *settings;

37 (*
hªdË
)->
Çmeÿchesize
 = 0;

38 (*
hªdË
)->
Œ“Ëv–
 = 0;

39 (*
hªdË
)->
skwh™e¥aû
 = 1;

40 (*
hªdË
)->
¡©e
 = 
¡©e_¡¬t
;

44 
	}
}

46 
	$xmlClo£
(
nxml_t
 
hªdË
)

48 
	`cmsMem_ä“
(
hªdË
);

49 
	}
}

51 
	#WHITESPACE
 " \t\r\n"

	)

52 
	#¡rsk
(
DATA
,
CHARS
è((cÚ¡ *)(
	`¡r¥n
(DATA,CHARSè+ (DATA)))

	)

58 
	$nxml_add_Çmeÿche
(
nxml_t
 
hªdË
, *
d©a
, 
Ën
,

59 **
d©a_nocİy
, *
Ën_nocİy
)

63 ià(
d©a_nocİy
 && !
hªdË
->
Çmeÿchesize
) {

64 *
d©a_nocİy
 = 
d©a
;

65 *
Ën_nocİy
 = 
Ën
;

67 ià(
Ën
 > 
NXML_MAX_NAME_SIZE
 - 
hªdË
->
Çmeÿchesize
)

68 
Ën
 = 
NXML_MAX_NAME_SIZE
 - 
hªdË
->
Çmeÿchesize
;

69 ià(
Ën
) {

70 
	`¡ºıy
(&
hªdË
->
Çmeÿche
[hªdË->
Çmeÿchesize
], 
d©a
, 
Ën
);

71 
hªdË
->
Çmeÿchesize
 +ğ
Ën
;

73 ià(
d©a_nocİy
) {

74 *
d©a_nocİy
 = 
hªdË
->
Çmeÿche
;

75 *
Ën_nocİy
 = 
hªdË
->
Çmeÿchesize
;

78 
	}
}

85 
	$xmlWr™e
(
nxml_t
 
hªdË
, *
d©a
, 
Ën
, **
’dp
)

87 
Œ“End
=0;

88 cÚ¡ *
’dd©a
 = 
d©a
 + 
Ën
;

91 ià(
hªdË
->
¡©e
 =ğ
¡©e_¡¬t
) {

92 *
p
;

94 
p
 = (*è
	`¡rsk
(
d©a
, 
WHITESPACE
);

95 iàĞ!
	`¡ºcmp
(
p
,"<?",2) ) {

96 
p
 = 
	`¡r¡r
(…, "?>");

97 ià(
p
)

98 
d©a
 = 
p
+2;

100 
hªdË
->
¡©e
 = 
¡©e_begš_g
;

103 (
d©a
 < 
’dd©a
è&& (!
Œ“End
)) {

104 *
s
;

107 ià(
hªdË
->
skwh™e¥aû
) {

108 
s
 = (*è
	`¡rsk
(
d©a
, 
WHITESPACE
);

109 ià(
s
 !ğ
d©a
) {

110 
d©a
 = 
s
;

117 
hªdË
->
¡©e
) {

118 
¡©e_begš_g
:

119 
s
 = 
	`¡rchr
(
d©a
, '<');

120 ià(!
s
) {

122 iàĞ
hªdË
->
£‰šgs
.
d©a
 )

123 (*
hªdË
->
£‰šgs
.
d©a
)(hªdË, d©a, 
’dd©a
-data, 1 );

124 *
’dp
 = 
d©a
;

126 } iàĞ(
d©a
 !ğ
s
è&& 
hªdË
->
£‰šgs
.data) {

128 (*
hªdË
->
£‰šgs
.
d©a
)(hªdË, d©a, 
s
-data, 0 );

131 
d©a
 = 
s
+1;

132 
hªdË
->
¡©e
 = 
¡©e_g_Çme
;

133 
hªdË
->
Çmeÿchesize
 = 0;

134 ++(
hªdË
->
Œ“Ëv–
);

137 
¡©e_fšish_g
:

139 
s
 = 
	`¡rchr
(
d©a
, '>');

140 ià(!
s
) {

141 *
’dp
 = 
d©a
;

146 
d©a
 = 
s
+1;

147 
hªdË
->
¡©e
 = 
¡©e_begš_g
;

148 iàĞ--(
hªdË
->
Œ“Ëv–
) <= 0 )

149 
Œ“End
 = 1;

152 
¡©e_’d_g_Çme
:

153 
s
 = 
	`¡½brk
(
d©a
, 
WHITESPACE
 ">");

154 ià(!
s
) {

156 
	`nxml_add_Çmeÿche
(
hªdË
, 
d©a
, 
’dd©a
-d©a, 
NULL
, NULL);

157 
hªdË
->
skwh™e¥aû
 = 0;

158 *
’dp
 = 
d©a
;

161 *
Çme
;

162 
Çm–’
;

163 
	`nxml_add_Çmeÿche
(
hªdË
, 
d©a
, 
s
-d©a, &
Çme
, &
Çm–’
);

165 (*
hªdË
->
£‰šgs
.
g_’d
)(hªdË, 
Çme
, 
Çm–’
);

166 
hªdË
->
¡©e
 = 
¡©e_fšish_g
;

167 
d©a
 = 
s
;

168 ià(--(
hªdË
->
Œ“Ëv–
) <=0)

169 
Œ“End
 = 1;

173 
¡©e_g_Çme
:

174 
¡©e_©Œ_Çme
:

175 ià(*
d©a
 == '/') {

177 ià(
hªdË
->
¡©e
 =ğ
¡©e_g_Çme
 && !hªdË->
Çmeÿchesize
) {

180 
hªdË
->
¡©e
 = 
¡©e_’d_g_Çme
;

181 
d©a
++;

183 } ià(
hªdË
->
¡©e
 =ğ
¡©e_©Œ_Çme
) {

185 (*
hªdË
->
£‰šgs
.
g_’d
)(hªdË, hªdË->
Çmeÿche
, hªdË->
Çmeÿchesize
);

186 
hªdË
->
¡©e
 = 
¡©e_fšish_g
;

187 
d©a
++;

190 } ià(*
d©a
 == '>') {

191 
hªdË
->
¡©e
 = 
¡©e_begš_g
;

192 
d©a
++;

197 
s
 = (*)
	`¡½brk
(
d©a
, 
WHITESPACE
 "=/>");

198 ià(!
s
) {

200 
	`nxml_add_Çmeÿche
(
hªdË
, 
d©a
, 
’dd©a
-d©a, 
NULL
, NULL);

201 
hªdË
->
skwh™e¥aû
 = 0;

202 *
’dp
 = 
d©a
;

206 *
Çme
;

207 
Çm–’
;

208 
	`nxml_add_Çmeÿche
(
hªdË
, 
d©a
, 
s
-d©a, &
Çme
, &
Çm–’
);

210 ià(
hªdË
->
¡©e
 =ğ
¡©e_g_Çme
) {

211 (*
hªdË
->
£‰šgs
.
g_begš
)(hªdË, 
Çme
, 
Çm–’
);

212 
hªdË
->
¡©e
 = 
¡©e_©Œ_Çme
;

214 (*
hªdË
->
£‰šgs
.
©Œibu‹_begš
)(hªdË, 
Çme
, 
Çm–’
);

215 
hªdË
->
¡©e
 = 
¡©e_©Œ_v®ue_equ®s
;

217 
hªdË
->
Çmeÿchesize
 = 0;

218 
d©a
 = 
s
;

222 
¡©e_©Œ_v®ue
:

223 
s
 = (*)
	`¡rchr
(
d©a
, '"');

224 ià(!
s
) {

226 (*
hªdË
->
£‰šgs
.
©Œibu‹_v®ue
)(hªdË, 
d©a
, 
’dd©a
-data, 1);

227 
hªdË
->
skwh™e¥aû
 = 0;

228 *
’dp
 = 
d©a
;

232 (*
hªdË
->
£‰šgs
.
©Œibu‹_v®ue
)(hªdË, 
d©a
, 
s
-data, 0);

235 
d©a
 = 
s
+1;

236 
hªdË
->
¡©e
 = 
¡©e_©Œ_Çme
;

237 
hªdË
->
Çmeÿchesize
 = 0;

241 
¡©e_©Œ_v®ue_equ®s
:

242 ià(*
d©a
 == '>') {

243 
hªdË
->
¡©e
 = 
¡©e_begš_g
;

244 
d©a
++;

245 } ià(*
d©a
 == '=') {

246 
hªdË
->
¡©e
 = 
¡©e_©Œ_v®ue_quÙe
;

247 
d©a
++;

249 
hªdË
->
¡©e
 = 
¡©e_©Œ_Çme
;

252 
¡©e_©Œ_v®ue_quÙe
:

253 ià(*
d©a
 == '"')

254 
d©a
++;

255 
hªdË
->
¡©e
 = 
¡©e_©Œ_v®ue
;

260 
hªdË
->
skwh™e¥aû
 = 1;

262 *
’dp
 = 
d©a
;

263  
Œ“End
? 1: 0;

264 
	}
}

	@source/app_dg.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<uni¡d.h
>

16 
	~<sys/ty³s.h
>

17 
	~<sys/¡©.h
>

18 
	~<sys/sock‘.h
>

19 
	~<sys/un.h
>

20 
	~<fú.h
>

21 
	~<”ºo.h
>

22 
	~<sigÇl.h
>

24 
	~"gki.h
"

25 
	~"uc.h
"

26 
	~"b§_­i.h
"

27 
	~"­p_dg.h
"

28 
	~"b§_Œaû.h
"

30 
	~"­p_mu‹x.h
"

31 
	~"­p_xml_·¿m.h
"

32 
	~"­p_xml_uts.h
"

33 
	~"­p_disc.h
"

34 
	~"­p_uts.h
"

38 
	#APP_DG_TX_BUFFER_SIZE
 1024

	)

39 
	#APP_DG_RX_BUFFER_SIZE
 1024

	)

41 
	#APP_DG_NB_CON_MAX
 20

	)

42 
	#APP_DG_BAD_HANDLE
 0xFF

	)

43 
	#APP_DG_BAD_UIPC
 0xFF

	)

49 
UINT8
 
	grx_bufãr
[
APP_DG_RX_BUFFER_SIZE
];

53 
BOOLEAN
 
	mš_u£
;

54 
BOOLEAN
 
	mis_İ’
;

55 
BOOLEAN
 
	mis_£rv”
;

56 
BD_ADDR
 
	mbd_addr
;

57 
tBSA_DG_HNDL
 
	mhªdË
;

58 
tUIPC_CH_ID
 
	muc_chªÃl
;

59 
BT_HDR
 *
	mp_tx_³ndšg
;

60 
tBSA_SERVICE_ID
 
	m£rviû
;

61 #ifdeà
BSA_USE_SERIAL_PORT


62 
	msoÿt_pid
;

63 
	m£rŸl_fd
;

64 
±h»ad_t
 
	m»ad_th»ad
;

65 
	m¡İ_‰y_»ad
;

67 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


68 
	mli¡’_fd
;

69 
	mcÚn_fd
;

70 
	m¡İ_sock‘
;

71 
±h»ad_t
 
	m»ad_th»ad
;

73 } 
	ttAPP_DG_CON
;

77 
tAPP_DG_CON
 
	mcÚÃùiÚs
[
APP_DG_NB_CON_MAX
];

78 
tAPP_MUTEX
 
	m­p_dg_tx_mu‹x
[
APP_DG_NB_CON_MAX
];

79 
BOOLEAN
 
	mloİback
;

80 } 
	ttAPP_DG_CB
;

82 
tAPP_DG_CB
 
	g­p_dg_cb
;

84 (*
mReûiveSµD©aCback
)(*
u£r
, 
cÚn_id
, * 
d©a
, 
size
èğ
NULL
;

85 (*
mLškS‹Cback
)(*
u£r
,
cÚ_id
, 
BOOLEAN
 
lšked
,* 
»mÙe_addr
, 
size
èğ
NULL
;

86 *
mSµU£r
 = 
NULL
;

91 
	`­p_dg_cÚ_®loc
();

92 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

93 
	`­p_dg_cÚ_di¥Ïy
();

94 
	`­p_dg_cÚ_di¥Ïy_debug
();

95 
	`­p_dg_cÚ_g‘_äom_hªdË
(
tBSA_DG_HNDL
 
hªdË
, 
BOOLEAN
 *
p_is_£rv”
);

96 
	`­p_dg_cÚ_g‘_äom_uc
(
tUIPC_CH_ID
 
chªÃl_id
);

97 *
	`­p_dg_g‘_¤v_desc
(
tBSA_SERVICE_ID
 
£rviû
);

98 
	`­p_dg_£ndbuf
(
cÚÃùiÚ
, 
BT_HDR
 *
p_msg
);

99 
	`­p_dg_rx_İ’_evt
(
tBSA_DG_MSG
 *
p_d©a
);

100 
	`­p_dg_rx_şo£_evt
(
tBSA_DG_MSG
 *
p_d©a
);

101 
	`­p_dg_fšd_£rviû_evt
(
tBSA_DG_MSG
 *
p_d©a
);

102 
	`­p_dg_İ’_‰y
(
cÚÃùiÚ
);

103 
	`­p_dg_şo£_‰y
(
cÚÃùiÚ
);

104 
	`­p_dg_£ndto_v‰y
(* 
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
);

105 *
	`­p_dg_»ad_´oc
Ğ*
±r
 );

107 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


108 
	`­p_dg_İ’_sock‘
(
cÚÃùiÚ
);

109 
	`­p_dg_şo£_sock‘
(
cÚÃùiÚ
);

110 
	`­p_dg_£ndto_sock‘
(* 
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
);

111 *
	`­p_dg_sock‘_´oc
Ğ*
±r
 );

114 
	`­p_dg_uc_cback
(
BT_HDR
 *
p_msg
);

125 
	$­p_dg_cback
(
tBSA_DG_EVT
 
ev’t
, 
tBSA_DG_MSG
 *
p_d©a
)

127 
ev’t
)

129 
BSA_DG_OPEN_EVT
:

130 
	`­p_dg_rx_İ’_evt
(
p_d©a
);

133 
BSA_DG_CLOSE_EVT
:

134 
	`­p_dg_rx_şo£_evt
(
p_d©a
);

137 
BSA_DG_FIND_SERVICE_EVT
:

138 
	`­p_dg_fšd_£rviû_evt
(
p_d©a
);

141 
	`APP_ERROR1
("­p_dg_cback unknowÀev’t:%d", 
ev’t
);

144 
	}
}

157 
	$­p_dg_rx_şo£_evt
(
tBSA_DG_MSG
 *
p_d©a
)

159 
cÚÃùiÚ
;

160 
BOOLEAN
 
is_£rv”
;

161 
¡©us
;

163 
	`APP_DEBUG1
("BSA_DG_CLOSE_EVT HªdË:%d", 
p_d©a
->
şo£
.
hªdË
);

166 
cÚÃùiÚ
 = 
	`­p_dg_cÚ_g‘_äom_hªdË
(
p_d©a
->
şo£
.
hªdË
, &
is_£rv”
);

167 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

169 
	`APP_ERROR0
("No Connection structure matchhis DG†ink");

173 
	`­p_dg_şo£_‰y
(
cÚÃùiÚ
);

174 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


175 
	`­p_dg_şo£_sock‘
(
cÚÃùiÚ
);

178 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
)

180 
	`GKI_ä“buf
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
);

181 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
 = 
NULL
;

182 
	`APP_DEBUG1
("DG S”v” CÚÃùiÚ…_tx_³ndšg f»:%d", 
cÚÃùiÚ
);

184 
	`APP_DEBUG0
("app_dg_cback unlock mutex");

185 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

186 if(
¡©us
 < 0)

188 
	`APP_ERROR1
("­p_uÆock_mu‹x faed stus:%d", 
¡©us
);

190 ià(
is_£rv”
)

192 
	`APP_DEBUG1
("DG S”v” CÚÃùiÚ :%d clo£d", 
cÚÃùiÚ
);

193 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
)

197 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
 = 
FALSE
;

199 
	`UIPC_Clo£
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
uc_chªÃl
);

200 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

202 if(
mLškS‹Cback
 !ğ
NULL
)

203 
	`mLškS‹Cback
(
mSµU£r
,
cÚÃùiÚ
,
FALSE
,
NULL
,0);

208 
	`APP_DEBUG1
("DG Cl›Á CÚÃùiÚ:%d clo£d", 
cÚÃùiÚ
);

209 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
)

211 
	`UIPC_Clo£
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
uc_chªÃl
);

213 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

215 
	`­p_dg_cÚ_di¥Ïy_debug
();

216 
	}
}

229 
	$­p_dg_rx_İ’_evt
(
tBSA_DG_MSG
 *
p_d©a
)

231 
cÚÃùiÚ
;

232 
BOOLEAN
 
is_£rv”
;

233 
¡©us
;

234 
šdex
;

236 
	`APP_DEBUG1
("BSA_DG_OPEN_EVT stus:%d", 
p_d©a
->
İ’
.
¡©us
);

237 
	`APP_DEBUG1
("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

238 
p_d©a
->
İ’
.
bd_addr
[0],…_data->open.bd_addr[1],

239 
p_d©a
->
İ’
.
bd_addr
[2],…_data->open.bd_addr[3],

240 
p_d©a
->
İ’
.
bd_addr
[4],…_data->open.bd_addr[5]);

241 
	`APP_DEBUG1
("\tHandle:%d UIPC Channel:%d Service:%s (%d)",

242 
p_d©a
->
İ’
.
hªdË
,

243 
p_d©a
->
İ’
.
uc_chªÃl
,

244 
	`­p_dg_g‘_¤v_desc
(
p_d©a
->
İ’
.
£rviû
),

245 
p_d©a
->
İ’
.
£rviû
);

247 
cÚÃùiÚ
 = 
	`­p_dg_cÚ_g‘_äom_hªdË
(
p_d©a
->
İ’
.
hªdË
, &
is_£rv”
);

248 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

251 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

254 ià((
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
 =ğ
TRUE
) &&

255 (
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_İ’
 =ğ
FALSE
) &&

256 (
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_£rv”
 =ğ
FALSE
) &&

257 (
	`bdcmp
(
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
bd_addr
, 
p_d©a
->
İ’
.bd_addr) == 0))

259 
	`APP_DEBUG1
("Found DG cÚÃùiÚ:%d m©chšg BdAddr", 
šdex
);

260 
cÚÃùiÚ
 = 
šdex
;

264 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

266 
	`APP_ERROR0
("No Connection structure matchhis DG Connection");

269 
is_£rv”
 = 
FALSE
;

271 ià(
is_£rv”
)

273 
	`APP_DEBUG1
("Incomšg DG CÚÃùiÚ fÜ S”v” cÚÃùiÚ:%d", 
cÚÃùiÚ
);

277 
	`APP_DEBUG1
("Outgošg CÚÃùiÚ fÜ Cl›Á:%d", 
cÚÃùiÚ
);

279 ià(
p_d©a
->
İ’
.
¡©us
 =ğ
BSA_SUCCESS
)

281 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
 = 
TRUE
;

282 
	`bdıy
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
bd_addr
, 
p_d©a
->
İ’
.bd_addr);

283 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
hªdË
 = 
p_d©a
->
İ’
.handle;

284 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
uc_chªÃl
 = 
p_d©a
->
İ’
.uipc_channel;

285 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rviû
 = 
p_d©a
->
İ’
.service;

286 
	`­p_dg_İ’_‰y
(
cÚÃùiÚ
);

287 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


288 
	`­p_dg_İ’_sock‘
(
cÚÃùiÚ
);

291 ià(
	`UIPC_O³n
(
p_d©a
->
İ’
.
uc_chªÃl
, 
­p_dg_uc_cback
è=ğ
FALSE
)

293 
	`APP_ERROR1
("UIPC_O³Àçed chªÃl:%d", 
p_d©a
->
İ’
.
uc_chªÃl
);

296 
	`­p_»ad_xml_»mÙe_deviûs
();

298 
	`­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

299 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
p_d©a
->
İ’
.
bd_addr
,

300 
BSA_SPP_SERVICE_MASK
 | 
BSA_DUN_SERVICE_MASK
 );

302 
	`­p_wr™e_xml_»mÙe_deviûs
();

304 
¡©us
 = 
	`­p_š™_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

305 ià(
¡©us
 < 0)

307 
	`APP_ERROR1
("­p_š™_mu‹x faed stus:%d", 
¡©us
);

310 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

311 ià(
¡©us
 < 0)

313 
	`APP_ERROR1
("­p_lock_mu‹x faed stus:%d", 
¡©us
);

316 if(
mLškS‹Cback
 !ğ
NULL
)

317 
	`mLškS‹Cback
(
mSµU£r
,
cÚÃùiÚ
,
TRUE
,
p_d©a
->
İ’
.
bd_addr
,6);

321 
	`APP_ERROR0
("Fail : BSA_DG_OPEN_EVT");

322 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

325 
	`­p_dg_cÚ_di¥Ïy
();

326 
	`­p_dg_cÚ_di¥Ïy_debug
();

328 
	}
}

341 
	$­p_dg_fšd_£rviû_evt
(
tBSA_DG_MSG
 *
p_d©a
)

343 
	`APP_DEBUG1
("BSA_DG_FIND_SERVICE_EVT stus:%d", 
p_d©a
->
fšd_£rviû
.
¡©us
);

344 
	`APP_DEBUG1
("\tBdaddr %02x:%02x:%02x:%02x:%02x:%02x",

345 
p_d©a
->
fšd_£rviû
.
bd_addr
[0],…_data->find_service.bd_addr[1],

346 
p_d©a
->
fšd_£rviû
.
bd_addr
[2],…_data->find_service.bd_addr[3],

347 
p_d©a
->
fšd_£rviû
.
bd_addr
[4],…_data->find_service.bd_addr[5]);

349 
	`APP_DEBUG1
("\t Status:%d Found:%d Name:%s (SCN: %d)",

350 
p_d©a
->
fšd_£rviû
.
¡©us
,

351 
p_d©a
->
fšd_£rviû
.
found
,

352 
p_d©a
->
fšd_£rviû
.
Çme
,

353 
p_d©a
->
fšd_£rviû
.
sú
);

355 
	}
}

368 
	$­p_dg_uc_cback
(
BT_HDR
 *
p_msg
)

370 
cÚÃùiÚ
;

371 
tAPP_DG_CON
 *
p_cÚÃùiÚ
;

372 
tUIPC_CH_ID
 
uc_chªÃl
;

373 
UINT32
 
Ëngth
;

374 
BT_HDR
 *
p_tx_msg
;

375 
UINT16
 
msg_evt
;

376 
¡©us
;

379 
uc_chªÃl
 = 
p_msg
->
Ïy”_¥ecific
;

381 
cÚÃùiÚ
 = 
	`­p_dg_cÚ_g‘_äom_uc
(
uc_chªÃl
);

382 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

384 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

388 
p_cÚÃùiÚ
 = &
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
];

391 ià(
p_msg
->
ev’t
 =ğ
UIPC_RX_DATA_READY_EVT
)

393 
	`APP_DEBUG1
("UIPC UIPC_RX_DATA_READY_EVT ChId:%d", 
uc_chªÃl
);

396 
Ëngth
 = 
	`UIPC_R—d
(
uc_chªÃl
, &
msg_evt
, 
rx_bufãr
, (rx_buffer));

403 ià(
Ëngth
 == 0)

405 
	`UIPC_Ioùl
(
uc_chªÃl
, 
UIPC_REQ_RX_READY
, 
NULL
);

409 
	`­p_dg_£ndto_v‰y
(
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
);

410 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


411 
	`­p_dg_£ndto_sock‘
(
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
);

413 if(
mReûiveSµD©aCback
 !ğ
NULL
 && 
mSµU£r
 != NULL)

414 
	`mReûiveSµD©aCback
(
mSµU£r
,
cÚÃùiÚ
,
rx_bufãr
,
Ëngth
);

415 ià(
­p_dg_cb
.
loİback
 =ğ
TRUE
)

417 ià(
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
)

419 
	`APP_ERROR1
("UIPC ChªÃl:%d Tx flow i Ofà(Tx bufã¸³ndšg).=> NØloİback", 
uc_chªÃl
);

423 
	`APP_DEBUG0
("Data Loopback (forest)");

425 ià((
p_tx_msg
 = (
BT_HDR
 *è
	`GKI_g‘buf
((BT_HDRè+ 
Ëngth
))

426 !ğ
NULL
)

428 
p_tx_msg
->
off£t
 = 0;

429 
p_tx_msg
->
Ën
 = 
Ëngth
;

430 
	`memıy
((
UINT8
 *)(
p_tx_msg
 + 1), 
rx_bufãr
, 
Ëngth
);

431 
	`­p_dg_£ndbuf
(
cÚÃùiÚ
, 
p_tx_msg
);

436 } 
Ëngth
 > 0);

438 ià(
p_msg
->
ev’t
 =ğ
UIPC_TX_DATA_READY_EVT
)

440 
	`APP_DEBUG1
("UIPC UIPC_TX_DATA_READY_EVT ChId:%d", 
uc_chªÃl
);

441 ià(
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
)

443 
	`APP_DEBUG0
("cback unlock mutex");

444 
¡©us
 = 
	`­p_uÆock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

445 if(
¡©us
 < 0)

447 
	`APP_ERROR1
("­p_uÆock_mu‹x faed stus:%d", 
¡©us
);

452 
	`APP_DEBUG0
("No…ending Tx buffer");

455 ià(
p_msg
->
ev’t
 =ğ
UIPC_RX_DATA_EVT
)

457 
	`APP_ERROR1
("UIPC_RX_DATA_EVT should‚ot be„eceived form DG UIPC ChId:%d",

458 
uc_chªÃl
);

461 
	`GKI_ä“buf
(
p_msg
);

462 
	}
}

477 
	$­p_dg_£ndbuf
(
cÚÃùiÚ
, 
BT_HDR
 *
p_msg
)

479 
BOOLEAN
 
£nd_¡©us
;

480 
tAPP_DG_CON
 *
p_cÚÃùiÚ
;

482 
p_cÚÃùiÚ
 = &
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
];

484 ià((
p_cÚÃùiÚ
->
uc_chªÃl
 < 
UIPC_CH_ID_DG_FIRST
è|| (p_cÚÃùiÚ->uc_chªÃÈ> 
UIPC_CH_ID_DG_LAST
))

486 
	`APP_ERROR0
("uipc connection is invalid");

487 
	`GKI_ä“buf
(
p_msg
);

491 ià((
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
) &&

492 (
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
p_msg
))

494 
	`APP_ERROR0
("Another Tx buffer was…ending");

495 
	`GKI_ä“buf
(
p_msg
);

499 
£nd_¡©us
 = 
	`UIPC_S’dBuf
(
p_cÚÃùiÚ
->
uc_chªÃl
, 
p_msg
);

501 ià(
£nd_¡©us
 =ğ
TRUE
)

504 
p_cÚÃùiÚ
->
p_tx_³ndšg
 = 
NULL
;

511 ià(
p_msg
->
Ïy”_¥ecific
 =ğ
UIPC_LS_TX_FLOW_OFF
)

513 
	`APP_DEBUG0
("flow control");

515 
p_cÚÃùiÚ
->
p_tx_³ndšg
 = 
p_msg
;

518 
	`UIPC_Ioùl
(
p_cÚÃùiÚ
->
uc_chªÃl
, 
UIPC_REQ_TX_READY
, 
NULL
);

523 
	`APP_DEBUG1
("SHOULD‚Ù…ršˆthi mes§g%s,%s,%d",
__FILE__
,
__FUNCTION__
,
__LINE__
);

524 
	`GKI_ä“buf
(
p_msg
);

530 
	}
}

541 
	$­p_dg_»ad
(
cÚÃùiÚ
)

543 
UINT16
 
ev’t
;

544 
UINT32
 
Ën
;

546 ià(
cÚÃùiÚ
 < 0)

548 
	`­p_dg_cÚ_di¥Ïy
();

549 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select connection");

551 ià((
cÚÃùiÚ
 < 0è|| (cÚÃùiÚ >ğ
APP_DG_NB_CON_MAX
))

553 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

557 ià((
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 =ğ
FALSE
) ||

558 ((
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 !ğ
FALSE
)

559 && (
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
 =ğ
FALSE
)))

561 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù o³Ãd", 
cÚÃùiÚ
);

565 
Ën
 = 
	`UIPC_R—d
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
uc_chªÃl
, &
ev’t
, 
rx_bufãr
, 
APP_DG_RX_BUFFER_SIZE
);

566 if(
Ën
 > 0)

568 
	`süu_dump_hex
(
rx_bufãr
, "DG R—d D©a", 
Ën
, 
TRACE_LAYER_NONE
,

569 
TRACE_TYPE_DEBUG
);

572 
	}
}

583 
	$­p_dg_£nd_fe
(* 
p_fe_Çme
, 
cÚÃùiÚ
)

585 
fd
, 
»suÉ
;

586 
ssize_t
 
Ëngth
 = 0;

587 
BT_HDR
 *
p_msg
;

588 
¡©us
;

589 
tAPP_DG_CON
 *
p_cÚÃùiÚ
;

591 
	`APP_DEBUG0
("app_dg_send_file sendƒnter");

593 if(
p_fe_Çme
 =ğ
NULL
)

595 
	`APP_ERROR0
("ERROR‡pp_dg_send_file‚ull file‚ame !!");

599 ià(
cÚÃùiÚ
 < 0)

601 
	`­p_dg_cÚ_di¥Ïy
();

602 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select connection");

604 ià((
cÚÃùiÚ
 < 0è|| (cÚÃùiÚ >ğ
APP_DG_NB_CON_MAX
))

606 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

610 
p_cÚÃùiÚ
 = &
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
];

613 ià((
p_cÚÃùiÚ
->
š_u£
 =ğ
FALSE
) ||

614 ((
p_cÚÃùiÚ
->
š_u£
 !ğ
FALSE
)

615 && (
p_cÚÃùiÚ
->
is_İ’
 =ğ
FALSE
)))

617 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù o³Ãd", 
cÚÃùiÚ
);

621 ià(
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
)

623 
	`APP_ERROR0
("A Tx buffer is‡lready…ending forhis connection");

624 
	`APP_ERROR0
("This meanshathe Tx flow is Off");

629 
»suÉ
 = 0;

632 
fd
 = 
	`İ’
(
p_fe_Çme
, 
O_RDONLY
);

633 ià(
fd
 >= 0)

638 
p_msg
 = (
BT_HDR
 *)
	`GKI_g‘buf
((BT_HDRè+ 
APP_DG_TX_BUFFER_SIZE
);

639 ià(
p_msg
 !ğ
NULL
)

641 
p_msg
->
off£t
 = 0;

644 
Ëngth
 = 
	`»ad
(
fd
, (
UINT8
 *)(
p_msg
 + 1), 
APP_DG_TX_BUFFER_SIZE
);

646 ià(
Ëngth
 > 0)

648 
p_msg
->
Ën
 = 
Ëngth
;

651 
­p_dg_£nd_fe_£nd
:

652 
¡©us
 = 
	`­p_dg_£ndbuf
(
cÚÃùiÚ
, 
p_msg
);

654 ià(
¡©us
 == 0)

659 ià(
¡©us
 < 0)

661 
	`APP_ERROR0
("No‡bleo send buffer");

662 
»suÉ
 = -1;

667 
	`APP_DEBUG1
("UIPC Tx Flow OÀChId:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

668 
	`APP_DEBUG1
("wa™ EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

669 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

670 if(
¡©us
 < 0)

672 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

673 
»suÉ
 = -1;

676 
	`APP_DEBUG1
("»ûived EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

678 if(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
 =ğ
NULL
)

680 
	`APP_ERROR0
("tx_pending status changed");

681 
»suÉ
 = -1;

684 
	`APP_DEBUG0
("Re-Send…acket");

685 
­p_dg_£nd_fe_£nd
;

691 
	`GKI_ä“buf
(
p_msg
);

697 
	`APP_ERROR0
("GKI_getbuf failed");

698 
»suÉ
 = -1;

701 } 
Ëngth
 > 0);

703 
	`şo£
(
fd
);

707 
	`APP_ERROR1
("ERROR‡µ_dg_£nd_fcould‚Ù o³À%s", 
p_fe_Çme
);

708 
»suÉ
 = -1;

710  
»suÉ
;

711 
	}
}

722 
	$­p_dg_£nd_d©a
(
cÚÃùiÚ
)

724 
»suÉ
;

725 
ssize_t
 
Ëngth
 = 0;

726 
BT_HDR
 *
p_msg
;

727 
¡©us
;

728 
tAPP_DG_CON
 *
p_cÚÃùiÚ
;

729 
buf
[128];

730 
UINT8
* 
p_d©a
 = 
NULL
;

731 * 
p_buf
 = 
NULL
;

732 
Ën
 = 0;

734 
	`APP_DEBUG0
("app_dg_send_dataƒnter");

736 ià(
cÚÃùiÚ
 < 0)

738 
	`­p_dg_cÚ_di¥Ïy
();

739 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select connection");

741 ià((
cÚÃùiÚ
 < 0è|| (cÚÃùiÚ >ğ
APP_DG_NB_CON_MAX
))

743 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

747 
p_cÚÃùiÚ
 = &
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
];

750 ià((
p_cÚÃùiÚ
->
š_u£
 =ğ
FALSE
) ||

751 ((
p_cÚÃùiÚ
->
š_u£
 !ğ
FALSE
)

752 && (
p_cÚÃùiÚ
->
is_İ’
 =ğ
FALSE
)))

754 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù o³Ãd", 
cÚÃùiÚ
);

758 ià(
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
)

760 
	`APP_ERROR0
("A Tx buffer is‡lready…ending forhis connection");

761 
	`APP_ERROR0
("This meanshathe Tx flow is Off");

766 
»suÉ
 = 0;

771 
p_msg
 = (
BT_HDR
 *)
	`GKI_g‘buf
((BT_HDRè+ 
APP_DG_TX_BUFFER_SIZE
);

772 ià(
p_msg
 !ğ
NULL
)

774 
p_msg
->
off£t
 = 0;

776 
	`mem£t
(
buf
, 0, (buf));

778 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ” d©¨tØ£nd iÀhex by‹ A0B1C2D3 (Ëngth should bev’)", 
buf
, (buf));

780 
p_d©a
 = (
UINT8
 *)(
p_msg
 + 1);

782 
	`APP_INFO1
("O³nšg DG d©¨Ëngth i :%d", 
Ëngth
);

783 
	`APP_INFO1
("O³nšg DG buà»ad i :%s", (*)(
buf
));

785 ià(
Ëngth
 > 0 && (length%2 == 0))

787 
p_msg
->
Ën
 = 
Ëngth
 / 2;

788 
p_buf
 = 
buf
;

790 
Ëngth
 >= 0)

792 
	`ssÿnf
 (
p_buf
, "%02x", &
p_d©a
[
Ën
]);

793 
p_buf
 += 2*();

794 
Ëngth
 =†ength - 2;

795 
Ën
 =†en + 1;

799 
­p_dg_£nd_fe_£nd
:

800 
¡©us
 = 
	`­p_dg_£ndbuf
(
cÚÃùiÚ
, 
p_msg
);

802 ià(
¡©us
 == 0)

807 ià(
¡©us
 < 0)

809 
	`APP_ERROR0
("No‡bleo send buffer");

810 
»suÉ
 = -1;

815 
	`APP_DEBUG1
("UIPC Tx Flow OÀChId:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

816 
	`APP_DEBUG1
("wa™ EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

817 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]);

818 if(
¡©us
 < 0)

820 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

821 
»suÉ
 = -1;

824 
	`APP_DEBUG1
("»ûived EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

826 if(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
 =ğ
NULL
)

828 
	`APP_ERROR0
("tx_pending status changed");

829 
»suÉ
 = -1;

832 
	`APP_DEBUG0
("Re-Send…acket");

833 
­p_dg_£nd_fe_£nd
;

839 
	`GKI_ä“buf
(
p_msg
);

845 
	`APP_ERROR0
("GKI_getbuf failed");

846 
»suÉ
 = -1;

849 } 
Ëngth
 > 0);

852  
»suÉ
;

853 
	}
}

855 
	$­p_dg_£nd
(
cÚÃùiÚ
, * 
d©a
, 
nBy‹s
)

857 
BT_HDR
 *
p_msg
;

858 
tAPP_DG_CON
 *
p_cÚÃùiÚ
;

859 * 
p_buf
 = 
NULL
;

860 
nBy‹sLeá
=
nBy‹s
;

861 
¡©us
 = 0,
»suÉ
=-1;

863 ià(
cÚÃùiÚ
 < 0)

865 
	`­p_dg_cÚ_di¥Ïy
();

866 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select connection");

868 ià((
cÚÃùiÚ
 < 0è|| (cÚÃùiÚ >ğ
APP_DG_NB_CON_MAX
))

870 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

874 
p_cÚÃùiÚ
 = &
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
];

877 ià((
p_cÚÃùiÚ
->
š_u£
 =ğ
FALSE
) ||

878 ((
p_cÚÃùiÚ
->
š_u£
 !ğ
FALSE
)

879 && (
p_cÚÃùiÚ
->
is_İ’
 =ğ
FALSE
)))

881 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù o³Ãd", 
cÚÃùiÚ
);

885 ià(
p_cÚÃùiÚ
->
p_tx_³ndšg
 !ğ
NULL
)

887 
	`APP_ERROR0
("A Tx buffer is‡lready…ending forhis connection");

888 
	`APP_ERROR0
("This meanshathe Tx flow is Off");

894 
»suÉ
 = -1;

896 ià(
NULL
 =ğ(
p_msg
 = (
BT_HDR
 *)
	`GKI_g‘buf
((BT_HDRè+ 
APP_DG_TX_BUFFER_SIZE
)))

899 
	`mem£t
((*)
p_msg
, 0, (
BT_HDR
è+ 
APP_DG_TX_BUFFER_SIZE
);

901 
p_msg
->
off£t
 = 0;

902 
p_buf
 = ((*)
p_msg
)+(
BT_HDR
);

904 
p_msg
->
Ën
 = (
nBy‹sLeá
 > 
APP_DG_TX_BUFFER_SIZE
) ? APP_DG_TX_BUFFER_SIZE :‚BytesLeft;

906 
	`memıy
(
p_buf
, 
d©a
, 
p_msg
->
Ën
);

911 iàĞ0 =ğ(
¡©us
 = 
	`­p_dg_£ndbuf
(
cÚÃùiÚ
, 
p_msg
)))

913 
nBy‹sLeá
 -ğ
p_msg
->
Ën
;

914 
d©a
 +ğ
p_msg
->
Ën
;

915 
»suÉ
 = 0;

920 ià(
¡©us
 < 0)

922 
	`APP_ERROR0
("No‡bleo send buffer");

923 
»suÉ
 = -1;

927 
	`APP_DEBUG1
("UIPC Tx Flow OÀChId:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

928 
	`APP_DEBUG1
("wa™ EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

930 if(
	`­p_lock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
cÚÃùiÚ
]) < 0)

932 
	`APP_ERROR1
("­p_lock_mu‹x faed: %d", 
¡©us
);

933 
»suÉ
 = -1;

936 
	`APP_DEBUG1
("»ûived EVENT..:%d", 
p_cÚÃùiÚ
->
uc_chªÃl
);

938 if(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
 =ğ
NULL
)

940 
	`APP_ERROR0
("tx_pending status changed");

941 
»suÉ
 = -1;

944 
	`APP_DEBUG0
("Re-Send…acket");

946 } 
nBy‹sLeá
 > 0 && 
»suÉ
 != -1);

948  
»suÉ
;

949 
	}
}

960 
	$­p_dg_li¡’
()

962 
tBSA_STATUS
 
¡©us
;

963 
tBSA_DG_LISTEN
 
·¿m
;

964 
cÚÃùiÚ
;

965 
choiû
, 
i
;

966 
u¬r
[16];

972 
	`APP_DEBUG0
("app_dg_listen");

974 
cÚÃùiÚ
 = 
	`­p_dg_cÚ_®loc
();

975 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

977 
	`APP_ERROR0
("not‡bleo‡llocate connection for server");

981 
¡©us
 = 
	`BSA_DgLi¡’In™
(&
·¿m
);

984 
·¿m
.
£rviû
 = 
BSA_SPP_SERVICE_ID
;

985 
·¿m
.
uuid
.
Ën
 = 
LEN_UUID_128
;

987 
	`¡rıy
(
·¿m
.
£rviû_Çme
,"custom_sync_data");

989 
szKeyName
[] = "fa87c0d0-afac-11de-8a39-0800200c9a62";

990 
	`ssÿnf
 (
szKeyName
, "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x",

991 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

992 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

995 
i
=0; i < 16; i++)

996 
·¿m
.
uuid
.
uu
.
uuid128
[
i
] = (
UINT8
è
u¬r
[i];

998 
	`APP_INFO1
("C»©šg DG uuid: %s", 
szKeyName
);

999 
	`APP_INFO1
("C»©šg DG‚ame: %s", 
·¿m
.
£rviû_Çme
);

1001 
	`APP_INFO0
("Which DG service do you†isteno?:");

1002 
	`APP_INFO1
(" S”ŸÈPÜˆProfe: %d", 
BSA_SPP_SERVICE_ID
);

1003 
	`APP_INFO1
(" dŸÈU°N‘wÜkšg Profe: %d", 
BSA_DUN_SERVICE_ID
);

1005 
choiû
 = 
	`­p_g‘_choiû
("Select service");

1007 ià(
choiû
 =ğ
BSA_SPP_SERVICE_ID
)

1009 
·¿m
.
£rviû
 = 
BSA_SPP_SERVICE_ID
;

1011 
	`APP_INFO0
("Create‡ custom 128-bit UUID serial service ?:");

1012 
	`APP_INFO0
(" 0 No");

1013 
	`APP_INFO0
(" 1 Yes");

1014 
choiû
 = 
	`­p_g‘_choiû
("Select choice");

1016 if(
choiû
)

1019 
	`mem£t
(
szKeyName
, 0, (szKeyName));

1020 
	`APP_INFO0
("Enter 128-bit UUID inhis format: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1021 
	`APP_INFO0
("Sample BtChat Android App - Secure Auth 128-bit UUID is: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1023 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ” 128-b™ UUID: ", 
szKeyName
, (szKeyName));

1025 
	`APP_INFO0
("Sample BtChat Android App - Secure Auth service‚ame is: BluetoothChatSecure");

1026 
	`mem£t
(
·¿m
.
£rviû_Çme
, 0, (param.service_name));

1027 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ” s”viû‚ame", 
·¿m
.
£rviû_Çme
, (param.service_name));

1029 
·¿m
.
uuid
.
Ën
 = 
LEN_UUID_128
;

1031 
	`APP_INFO1
("C»©šg DG cÚÃùiÚ: %s", 
szKeyName
);

1033 
	`ssÿnf
 (
szKeyName
, "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x",

1034 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

1035 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

1038 
i
=0; i < 16; i++)

1039 
·¿m
.
uuid
.
uu
.
uuid128
[
i
] = (
UINT8
è
u¬r
[i];

1041 
	`APP_INFO1
("C»©šg DG cÚÃùiÚ uuid sÿÂed: %s", (*è
·¿m
.
uuid
.
uu
.
uuid128
);

1045 
	`APP_INFO0
("Listen for specific service‚ame?:");

1046 
	`APP_INFO0
(" 0 No");

1047 
	`APP_INFO0
(" 1 Yes");

1048 
choiû
 = 
	`­p_g‘_choiû
("Select choice");

1049 
	`mem£t
(
·¿m
.
£rviû_Çme
, 0, (param.service_name));

1050 ià(
choiû
)

1052 
	`­p_g‘_¡ršg
("£rviû‚ame: ",
·¿m
.
£rviû_Çme
, (param.service_name)-1);

1059 ià(
choiû
 =ğ
BSA_DUN_SERVICE_ID
)

1061 
·¿m
.
£rviû
 = 
BSA_DUN_SERVICE_ID
;

1063 
	`¢´štf
(
·¿m
.
£rviû_Çme
, Õ¬am.£rviû_Çme), "DUN%d", 
cÚÃùiÚ
);

1067 
	`APP_ERROR1
("Bad S”viû s–eùed :%d", 
choiû
);

1068 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1073 
¡©us
 = 
	`BSA_DgLi¡’
(&
·¿m
);

1074 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1076 
	`APP_ERROR1
("BSA_DgLi¡’ fa:%d", 
¡©us
);

1077 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1081 
	`APP_DEBUG1
("DG Li¡’ CÚÃùiÚ:%d HªdË:%d", 
cÚÃùiÚ
, 
·¿m
.
hªdË
);

1083 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
hªdË
 = 
·¿m
.handle;

1084 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_£rv”
 = 
TRUE
;

1085 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rviû
 = 
·¿m
.service;

1087 
	`­p_dg_cÚ_di¥Ïy
();

1089 
	}
}

1100 
	$­p_dg_shutdown
(
cÚÃùiÚ
)

1102 
tBSA_STATUS
 
¡©us
;

1103 
tBSA_DG_SHUTDOWN
 
·¿m
;

1105 
	`APP_DEBUG0
("app_dg_shutdown");

1107 ià(
cÚÃùiÚ
 < 0)

1109 
	`­p_dg_cÚ_di¥Ïy
();

1110 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select server connectiono shutdown");

1112 ià((
cÚÃùiÚ
 < 0) ||

1113 (
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
) ||

1114 (
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 =ğ
FALSE
))

1116 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

1120 ià((
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 !ğ
FALSE
) &&

1121 (
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_£rv”
 =ğ
FALSE
))

1123 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù‡ s”v”", 
cÚÃùiÚ
);

1127 
¡©us
 = 
	`BSA_DgShutdownIn™
(&
·¿m
);

1128 
·¿m
.
hªdË
 = 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].handle;

1130 
¡©us
 = 
	`BSA_DgShutdown
(&
·¿m
);

1131 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1133 
	`APP_ERROR1
("BSA_DgShutdownIn™ fa:%d", 
¡©us
);

1137 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 = 
FALSE
;

1139 
	`­p_dg_cÚ_di¥Ïy
();

1141 
	}
}

1152 
BOOLEAN
 
	$­p_dg_ªy_cÚÃùiÚs
()

1154 
šdex
;

1156 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

1158 ià(
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
 =ğ
TRUE
)

1159  
TRUE
;

1161  
FALSE
;

1162 
	}
}

1173 
	$­p_dg_şo£
(
cÚÃùiÚ
)

1175 
tBSA_STATUS
 
¡©us
;

1176 
tBSA_DG_CLOSE
 
şo£_·¿m
;

1178 
	`APP_DEBUG0
("app_dg_close");

1180 ià(
cÚÃùiÚ
 < 0)

1182 
	`­p_dg_cÚ_di¥Ïy
();

1183 
cÚÃùiÚ
 = 
	`­p_g‘_choiû
("Select connectiono close");

1185 ià((
cÚÃùiÚ
 < 0) ||

1186 (
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
) ||

1187 (
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 =ğ
FALSE
))

1189 
	`APP_ERROR1
("Bad CÚÃùiÚ:%d", 
cÚÃùiÚ
);

1193 ià((
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 !ğ
FALSE
) &&

1194 (
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
is_İ’
 =ğ
FALSE
))

1196 
	`APP_ERROR1
("CÚÃùiÚ:%d‚Ù o³Ãd", 
cÚÃùiÚ
);

1200 
¡©us
 = 
	`BSA_DgClo£In™
(&
şo£_·¿m
);

1201 
şo£_·¿m
.
hªdË
 = 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].handle;

1202 
¡©us
 = 
	`BSA_DgClo£
(&
şo£_·¿m
);

1203 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1205 
	`APP_ERROR1
("BSA_DgClo£ fa:%d", 
¡©us
);

1209 
	}
}

1221 
	$­p_disc_£rviû_cback
(
tBSA_DISC_EVT
 
ev’t
, 
tBSA_DISC_MSG
 *
p_d©a
)

1223 
	`APPL_TRACE_DEBUG1
("­p_disc_£rviû_cback %d",
ev’t
);

1225 
ev’t
)

1227 
BSA_DISC_NEW_EVT
:

1229 
	`APPL_TRACE_DEBUG0
("app_disc_service_cback BSA_DISC_NEW_EVT");

1234 
BSA_DISC_CMPL_EVT
:

1236 
	`APP_INFO0
("app_disc_service_cback: BSA_DISC_CMPL_EVT");

1245 
	}
}

1256 
	$­p_dg_İ’
()

1258  
	`­p_dg_İ’_ex
(1);

1259 
	}
}

1271 
	$­p_dg_İ’_ex
(
sšgË_cÚn_Úly
)

1273 
tBSA_STATUS
 
¡©us
 = 0;

1274 
deviû_šdex
;

1275 
BD_ADDR
 
bd_addr
;

1276 
UINT8
 *
p_Çme
;

1277 
tBSA_DG_OPEN
 
·¿m
;

1278 
cÚÃùiÚ
;

1279 
choiû
;

1280 
šdex
, 
i
;

1281 
u¬r
[16];

1282 
szKeyName
[256];

1283 
Ëngth
 = 0;

1288 
	`APP_DEBUG0
("app_dg_open");

1290 ià(
sšgË_cÚn_Úly
)

1292 ià(
	`­p_dg_ªy_cÚÃùiÚs
())

1294 
	`APP_INFO0
("Only one connection‡llowed");

1299 
cÚÃùiÚ
 = 
	`­p_dg_cÚ_®loc
();

1300 
	`­p_dg_cÚ_di¥Ïy_debug
();

1301 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
)

1303 
	`APP_ERROR0
("Unableo‡lloc connection");

1307 
	`APP_INFO0
("Bluetooth DG menu:");

1308 
	`APP_INFO0
(" 0 Device from XML database (already…aired)");

1309 
	`APP_INFO0
(" 1 Device found in†ast discovery");

1310 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select choice");

1312 ià(
deviû_šdex
 == 0)

1315 
	`­p_»ad_xml_»mÙe_deviûs
();

1317 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
,

1318 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

1319 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

1320 ià((
deviû_šdex
 >= 0) &&

1321 (
deviû_šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

1322 (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

1324 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

1325 
p_Çme
 = 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
Çme
;

1329 
	`APP_ERROR1
("Bad Deviû index:%d", 
deviû_šdex
);

1330 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1335 ià(
deviû_šdex
 == 1)

1337 
	`­p_disc_di¥Ïy_deviûs
();

1338 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

1339 ià((
deviû_šdex
 >ğ0è&& (deviû_šdex < 
APP_DISC_NB_DEVICES
) &&

1340 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

1342 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

1343 
p_Çme
 = 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.
Çme
;

1347 
	`APP_ERROR1
("Bad Deviû index:%d", 
deviû_šdex
);

1348 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1354 
	`APP_ERROR1
("Bad choiû:%d", 
deviû_šdex
);

1355 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1359 
	`BSA_DgO³nIn™
(&
·¿m
);

1364 
	`APP_INFO0
("Which DG service do you wanto connecto?:");

1365 
	`APP_INFO1
(" S”ŸÈPÜˆProfe: %d", 
BSA_SPP_SERVICE_ID
);

1366 
	`APP_INFO1
(" dŸÈU°N‘wÜkšg Profe: %d", 
BSA_DUN_SERVICE_ID
);

1369 
choiû
 = 
	`­p_g‘_choiû
("Select service");

1371 ià(
choiû
 =ğ
BSA_SPP_SERVICE_ID
)

1373 
·¿m
.
£rviû
 = 
BSA_SPP_SERVICE_ID
;

1375 
	`APP_INFO0
("Connecto 128-bit UUID serial service ?:");

1376 
	`APP_INFO0
(" 0 No");

1377 
	`APP_INFO0
(" 1 Yes");

1378 
choiû
 = 
	`­p_g‘_choiû
("Select choice");

1380 if(
choiû
)

1382 
	`mem£t
(
szKeyName
, 0, (szKeyName));

1383 
	`APP_INFO0
("Enter 128-bit UUID inhis format: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1384 
	`APP_INFO0
("Sample BtChat Android App - Secure Auth 128-bit UUID is: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1386 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ”„emÙ128-b™ UUID: ", 
szKeyName
, (szKeyName));

1388 
	`APP_INFO0
("Sample BtChat Android App - Secure Auth service‚ame is: BluetoothChatSecure");

1389 
	`mem£t
(
·¿m
.
£rviû_Çme
, 0, (param.service_name));

1390 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ”„emÙ£rviû‚ame", 
·¿m
.
£rviû_Çme
, (param.service_name));

1392 
·¿m
.
uuid
.
Ën
 = 
LEN_UUID_128
;

1394 
	`APP_INFO1
("O³nšg DG cÚÃùiÚ befÜsÿnà%s", 
szKeyName
);

1396 
	`ssÿnf
 (
szKeyName
, "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x",

1397 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

1398 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

1400 
i
=0; i < 16; i++)

1401 
·¿m
.
uuid
.
uu
.
uuid128
[
i
] = (
UINT8
è
u¬r
[i];

1403 
	`APP_INFO1
("O³nšg DG cÚÃùiÚ uuid i :%s", (*è
·¿m
.
uuid
.
uu
.
uuid128
);

1407 
	`APP_INFO0
("Connecto specific service‚ame?:");

1408 
	`APP_INFO0
(" 0 No");

1409 
	`APP_INFO0
(" 1 Yes");

1410 
choiû
 = 
	`­p_g‘_choiû
("Select choice");

1411 
	`mem£t
(
·¿m
.
£rviû_Çme
, 0, (param.service_name));

1412 ià(
choiû
)

1414 
	`­p_g‘_¡ršg
("£rviû‚ame: ",
·¿m
.
£rviû_Çme
, (param.service_name)-1);

1422 ià(
choiû
 =ğ
BSA_DUN_SERVICE_ID
)

1424 
·¿m
.
£rviû
 = 
BSA_DUN_SERVICE_ID
;

1428 
	`APP_ERROR1
("Bad S”viû s–eùed :%d", 
choiû
);

1429 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1433 
·¿m
.
£c_mask
 |ğ
BSA_SEC_AUTHENTICATION
;

1435 #ià(
	`defšed
(
BSA_TEST
è&& (BSA_TEST==
TRUE
))

1439 
	`APP_INFO0
("Security?");

1440 
	`APP_INFO1
(" NONE: %d", 0);

1441 
	`APP_INFO1
(" Authentication: %d", 1);

1442 
	`APP_INFO1
(" Encryption+Authentication: %d", 3);

1443 
	`APP_INFO1
(" Authorization: %d", 4);

1445 
choiû
 = 
	`­p_g‘_choiû
("Select sec_mask");

1446 ià((
choiû
 & ~7) == 0)

1448 
·¿m
.
£c_mask
 = 
BTA_SEC_NONE
;

1449 ià(
choiû
 & 1)

1451 
·¿m
.
£c_mask
 |ğ
BSA_SEC_AUTHENTICATION
;

1453 ià(
choiû
 & 2)

1455 
·¿m
.
£c_mask
 |ğ
BSA_SEC_ENCRYPTION
;

1457 ià(
choiû
 & 4)

1459 
·¿m
.
£c_mask
 |ğ
BSA_SEC_AUTHORIZATION
;

1464 
	`APP_ERROR1
("Bad Secur™y Mask s–eùed :%d", 
choiû
);

1465 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1471 
	`bdıy
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
bd_addr
, bd_addr);

1472 
	`bdıy
(
·¿m
.
bd_addr
, bd_addr);

1474 
	`APP_INFO1
("O³nšg DG cÚÃùiÚo:%s", 
p_Çme
);

1475 
¡©us
 = 
	`BSA_DgO³n
(&
·¿m
);

1476 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1478 
	`APP_ERROR1
("BSA_DgO³Àç:%d", 
¡©us
);

1479 
	`­p_dg_cÚ_ä“
(
cÚÃùiÚ
);

1483 
	}
}

1494 
	$­p_dg_fšd_£rviû
()

1496 
tBSA_STATUS
 
¡©us
 = 0;

1497 
deviû_šdex
;

1498 
BD_ADDR
 
bd_addr
;

1499 
UINT8
 *
p_Çme
;

1500 
tBSA_DG_FIND_SERVICE
 
·¿m
;

1501 
i
;

1502 
u¬r
[16];

1503 
szKeyName
[256];

1504 
Ëngth
 = 0;

1510 
	`APP_DEBUG0
("app_dg_find_service");

1512 
	`APP_INFO0
("Bluetooth DG menu:");

1513 
	`APP_INFO0
(" 0 Device from XML database (already…aired)");

1514 
	`APP_INFO0
(" 1 Device found in†ast discovery");

1515 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select choice");

1517 ià(
deviû_šdex
 == 0)

1520 
	`­p_»ad_xml_»mÙe_deviûs
();

1522 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
,

1523 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

1524 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

1525 ià((
deviû_šdex
 >= 0) &&

1526 (
deviû_šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

1527 (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

1529 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

1530 
p_Çme
 = 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
Çme
;

1534 
	`APP_ERROR1
("Bad Deviû index:%d", 
deviû_šdex
);

1539 ià(
deviû_šdex
 == 1)

1541 
	`­p_disc_di¥Ïy_deviûs
();

1542 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

1543 ià((
deviû_šdex
 >ğ0è&& (deviû_šdex < 
APP_DISC_NB_DEVICES
) &&

1544 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

1546 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

1547 
p_Çme
 = 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.
Çme
;

1551 
	`APP_ERROR1
("Bad Deviû index:%d", 
deviû_šdex
);

1557 
	`APP_ERROR1
("Bad choiû:%d", 
deviû_šdex
);

1561 
	`BSA_DgFšdS”viûIn™
(&
·¿m
);

1563 
	`bdıy
(
·¿m
.
bd_addr
, bd_addr);

1565 
·¿m
.
uuid
.
Ën
 = 
LEN_UUID_128
;

1567 
	`mem£t
(
szKeyName
, 0, (szKeyName));

1568 
	`APP_INFO0
("Enter 128-bit UUID inhis format: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1569 
	`APP_INFO0
("Sample BtChat Android App - Secure Auth 128-bit UUID is: FA87C0D0-AFAC-11DE-8A39-0800200C9A66");

1571 
Ëngth
 = 
	`­p_g‘_¡ršg
("EÁ”„emÙ128-b™ UUID: ", 
szKeyName
, (szKeyName));

1573 
	`ssÿnf
 (
szKeyName
, "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x",

1574 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

1575 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

1577 
i
=0; i < 16; i++)

1578 
·¿m
.
uuid
.
uu
.
uuid128
[
i
] = (
UINT8
è
u¬r
[i];

1580 
	`APP_INFO1
("O³nšg DG cÚÃùiÚ uuid i :%s", (*è
·¿m
.
uuid
.
uu
.
uuid128
);

1582 
	`APP_DUMP
("BSA_DgFšdS”viû UUID:", (*è
·¿m
.
uuid
.
uu
.
uuid128
, 16);

1584 
	`APP_INFO1
("O³nšg DG cÚÃùiÚo:%s", 
p_Çme
);

1585 
¡©us
 = 
	`BSA_DgFšdS”viû
(&
·¿m
);

1586 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1588 
	`APP_ERROR1
("BSA_DgFšdS”viû fa:%d", 
¡©us
);

1592 
	}
}

1603 
	$­p_dg_š™
()

1605 
¡©us
;

1606 
šdex
;

1609 
	`mem£t
(&
­p_dg_cb
, 0, (app_dg_cb));

1611 
šdex
 = 0; index < 
APP_DG_NB_CON_MAX
 ; index++)

1613 
¡©us
 = 
	`­p_š™_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
šdex
]);

1614 ià(
¡©us
 < 0)

1619 
¡©us
 = 
	`­p_lock_mu‹x
(&
­p_dg_cb
.
­p_dg_tx_mu‹x
[
šdex
]);

1620 ià(
¡©us
 < 0)

1627 
	}
}

1638 
	$­p_dg_¡¬t
()

1640 
tBSA_STATUS
 
¡©us
 = 
BSA_SUCCESS
;

1642 
tBSA_DG_ENABLE
 
’abË_·¿m
;

1644 
	`APP_DEBUG0
("app_dg_start");

1646 
¡©us
 = 
	`BSA_DgEÇbËIn™
(&
’abË_·¿m
);

1647 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1649 
	`APP_ERROR1
("UÇbËØ’abËIn™ DG stus:%d", 
¡©us
);

1653 
’abË_·¿m
.
p_cback
 = 
­p_dg_cback
;

1654 
¡©us
 = 
	`BSA_DgEÇbË
(&
’abË_·¿m
);

1655 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1657 
	`APP_ERROR1
("UÇbËØ’abË DG stus:%d", 
¡©us
);

1662 
	}
}

1673 
	$­p_dg_¡İ
()

1675 
tBSA_STATUS
 
¡©us
;

1676 
tBSA_DG_DISABLE
 
di§bË_·¿m
;

1678 
	`APP_DEBUG0
("app_dg_stop");

1681 
	`­p_dg_cÚ_ä“_®l
();

1683 
¡©us
 = 
	`BSA_DgDi§bËIn™
(&
di§bË_·¿m
);

1684 
¡©us
 = 
	`BSA_DgDi§bË
(&
di§bË_·¿m
);

1685 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1687 
	`APP_ERROR1
("BSA_DgDi§bË faed stus:%d", 
¡©us
);

1692 
	}
}

1704 
	$­p_dg_£ndto_v‰y
(* 
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
)

1706 #ifdeà
BSA_USE_SERIAL_PORT


1707 
	`APP_DEBUG0
("app_dg_sendto_vtty");

1708 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 == -1)

1710 
	`APP_DEBUG0
("app_dg_sendto_vtty 1");

1711 
	`wr™e
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
, 
rx_bufãr
, 
Ëngth
);

1713 
	}
}

1725 
	$g‘_soÿt_pid
(
cÚn
, * 
cmd
)

1727 #ifdeà
BSA_USE_SERIAL_PORT


1728 
buf
[200];

1729 
i
,
pid
,
n
;

1730 * 
p
=
buf
;

1731 
FILE
 * 
å_cmd
=
NULL
;

1732 
FILE
 * 
å_ps
=
NULL
;

1733 
ps_cmd
[100];

1734 
soÿt_cmd
[200];

1737 
	`¥rštf
(
buf
, "/dev/‰yBT%d", 
cÚn
);

1738 
i
 = 0; i < 4; i++)

1740 
¡©
 
¡
;

1741 ià(
	`¡©
(
buf
,&
¡
) != 0)

1743 
	`u¦“p
(250*1000);

1749 ià(
i
 == 4)

1751 
	`APP_ERROR1
("­p_dg: soÿˆçedØÏunch fÜ cÚÀ%d", 
cÚn
);

1756 ià(
å_cmd
 = 
	`pİ’
("pidof socat", "r"))

1761 
	`mem£t
(
buf
,0,(buf));

1762 
	`fg‘s
(
buf
, (buf)-1, 
å_cmd
);

1763 
p
=
buf
;

1764 
i
 = 0; i < (
buf
); i++)

1767 ià(
buf
[
i
] == ' ' || buf[i] == 0)

1770 
buf
[
i
] = 0;

1771 
pid
 = 
	`¡¹oul
(
p
, 
NULL
, 10);

1772 
p
 = &(
buf
[
i
+1]);

1773 
i
++;

1776 
	`¥rštf
(
ps_cmd
, "p -°%d --no-h—dšg -Øcmd", 
pid
);

1777 ià(
å_ps
ğ
	`pİ’
(
ps_cmd
, "r"))

1779 
	`mem£t
(
soÿt_cmd
, 0, (socat_cmd));

1780 
	`fg‘s
(
soÿt_cmd
, (soÿt_cmd)-1, 
å_ps
);

1781 
	`fşo£
(
å_ps
);

1782 
cmd
[
	`¡¾’
(cmd)-2] = 0;

1783 
n
 = 
	`¡¾’
(
cmd
è< sŒËn(
soÿt_cmd
) ? strlen(cmd) : strlen(socat_cmd);

1784 ià(
	`¡ºcmp
(
cmd
,
soÿt_cmd
,
n
) == 0)

1786 
	`APP_INFO1
("g‘_soÿt_pid(): found soÿˆpid: %d", 
pid
);

1787 
­p_dg_cb
.
cÚÃùiÚs
[
cÚn
].
soÿt_pid
 = 
pid
;

1794 
	`pşo£
(
å_cmd
);

1797 
	`APP_ERROR1
("g‘_soÿt_pid():ƒ¼Üƒxecutšg…idoàsoÿt,ƒ¼no: %d", 
”ºo
);

1799  (
­p_dg_cb
.
cÚÃùiÚs
[
cÚn
].
soÿt_pid
 != -1);

1802 
	}
}

1803 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


1804 
	#UNIX_DOMAIN
 "/v¬/run/¥p_sock‘"

	)

1806 
	$­p_dg_İ’_sock‘
(
cÚÃùiÚ
){

1807 
	`APP_DEBUG1
("­p_dg_İ’_sock‘ cÚÃùiÚ:%d\n", 
cÚÃùiÚ
);

1809 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_sock‘
 = 0;

1810 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
 = 0;

1812 
”r
 = 0;

1813 ià(
”r
ğ
	`±h»ad_ü—‹
Ğ&(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
),

1814 
NULL
, 
­p_dg_sock‘_´oc
, (*è
cÚÃùiÚ
)){

1815 
	`APP_ERROR1
("E¼Ü -…th»ad_ü—‹(èsock‘„‘uº code: %d\n",
”r
);

1821 
	}
}

1823 
	$­p_dg_şo£_sock‘
(
cÚÃùiÚ
){

1824 
	`APP_DEBUG1
("--­p_dg_şo£_sock‘ cÚÃùiÚ=%d",
cÚÃùiÚ
);

1825 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_sock‘
 = 1;

1827 
	`APP_DEBUG1
("­p_dg_şo£_sock‘ fd=%d ",
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
);

1828 
	`shutdown
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
, 
SHUT_RDWR
);

1829 
»t
 = 
	`şo£
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
);

1830 
	`APP_DEBUG1
("­p_dg_şo£_sock‘„‘=%d ",
»t
);

1831 
	`APP_DEBUG1
("­p_dg_şo£_sock‘„‘=% ",
	`¡»¼Ü
(
”ºo
));

1832 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
 = 0;

1834 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
 != 0){

1835 
	`APP_DEBUG0
("app_dg_close_socket join in");

1836 
	`±h»ad_još
Ğ
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
, 
NULL
);

1837 
	`APP_DEBUG0
("app_dg_close_socket join out");

1838 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
 = 0;

1840 
	`APP_DEBUG0
("app_dg_close_socket out");

1841 
	}
}

1843 
	$­p_dg_£ndto_sock‘
(* 
rx_bufãr
,
Ëngth
,
cÚÃùiÚ
)

1845 
	`APP_DEBUG0
("app_dg_sendto_socket");

1846 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
 > 0){

1848 
»t
 = 
	`£nd
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
, 
rx_bufãr
, 
Ëngth
, 0);

1849 if(
»t
 <= 0)

1850 
	`APP_ERROR1
("£nd bufã¸d©¨”rÜ: %s\n",
	`¡»¼Ü
(
”ºo
));

1852 
	`APP_DEBUG0
("app_dg_sendto_socket 1");

1853 
	}
}

1855 * 
	$­p_dg_sock‘_´oc
(*
d©a
)

1857 
bufãr
[
APP_DG_RX_BUFFER_SIZE
];

1858 
cÚÃùiÚ
 = ()
d©a
;

1859 
i
 = 0;

1861 ià(
cÚÃùiÚ
 >ğ
APP_DG_NB_CON_MAX
){

1862 
	`APP_ERROR1
("­p_dg_»ad_´oc(èšv®id cÚÃùiÚ: %d",
cÚÃùiÚ
);

1867 
fd
;

1868 
sockaddr_un
 
£r_addr
;

1869 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

1870 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

1871 
	`¡rıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
);

1872 
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

1873 if(
fd
 < 0){

1874 
	`APP_ERROR1
("sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

1878 
	`APP_DEBUG0
("connect in\n");

1879 !
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_sock‘
){

1880 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

1881 if(
»t
 == 0) ;

1882 if(
»t
 < 0è
	`´štf
("E¼Ü:cÚÃùƒ¼Ü: %sÓ¼no: %d)\n",
	`¡»¼Ü
(
”ºo
),errno);

1883 
	`¦“p
(5);

1885 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
cÚn_fd
 = 
fd
;

1886 
	`APP_DEBUG1
(" cÚÃù ouˆfd=%d\n",
fd
);

1889 
»t
 = 
	`£nd
(
fd
, 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
bd_addr
, 6, 0);

1890 if(
»t
 <= 0)

1891 
	`APP_ERROR1
("£nd bufã¸d©¨”rÜ: %s\n",
	`¡»¼Ü
(
”ºo
));

1895 !
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_sock‘
){

1896 
	`mem£t
(
bufãr
, 0, (buffer));

1897 
	`APP_DEBUG0
("app_dg_socket_proc„ecv in");

1898 
n
 = 
	`»cv
(
fd
, 
bufãr
, (buffer),0);

1899 
	`APP_DEBUG0
("app_dg_socket_proc„ecv out");

1900 ià(
n
 < 0){

1901 
	`APP_ERROR1
("­p_dg_»ad_´oc(è»ad faed: %d", 
”ºo
);

1902 }if(
n
==0){

1903 
	`´štf
("E¼Ü:sock‘ i discÚÃù: %sÓ¼no: %d)\n",
	`¡»¼Ü
(
”ºo
),errno);

1904 
	`­p_dg_şo£_sock‘
(
cÚÃùiÚ
);

1910 
	`­p_dg_£nd
(
cÚÃùiÚ
,
bufãr
,
n
);

1913 
	`APP_DEBUG1
("­p_dg_sock‘_´oc(ècÚn=%d,ƒx™šg", 
cÚÃùiÚ
);

1914 
	}
}

1927 
	$­p_dg_İ’_‰y
(
cÚÃùiÚ
)

1929 #ifdeà
BSA_USE_SERIAL_PORT


1930 
”r
 = 0;

1931 
cmd
[500];

1934 
	`¥rštf
(
cmd
, "soÿˆ±y,lšk=/dev/‰yBT%d,¿w,echo=0…ty,lšk=/dev/‰yCÚBT%d,¿w,echo=0 &", 
cÚÃùiÚ
, connection);

1935 ià(-1 =ğ
	`sy¡em
(
cmd
))

1937 
	`APP_ERROR1
("­p_dg_İ’_‰y:ƒ¼ÜryšgØ¡¬ˆsoÿt: %d, cÚn: %d", 
”ºo
, 
cÚÃùiÚ
);

1941 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
soÿt_pid
 = 0;

1942 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 = -1;

1944 
	`g‘_soÿt_pid
(
cÚÃùiÚ
,
cmd
);

1947 
	`¥rštf
(
cmd
, "/dev/‰yCÚBT%d", 
cÚÃùiÚ
);

1948 ià((
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 = 
	`İ’
(
cmd
, 
O_RDWR
|
O_NOCTTY
)) != -1)

1950 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_‰y_»ad
 = 0;

1951 ià(
”r
ğ
	`±h»ad_ü—‹
Ğ&(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
), 
NULL
, 
­p_dg_»ad_´oc
, (*) connection))

1953 
	`APP_ERROR1
("E¼Ü -…th»ad_ü—‹(è»tuº code: %d\n",
”r
);

1954 
	`şo£
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
);

1955 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 = -1;

1958 
	`APP_INFO1
("­p_dg: vœtu® s”ŸÈpÜˆ/dev/‰yBT%d c»©ed.\n", 
cÚÃùiÚ
);

1962 
	`APP_ERROR1
("­p_dg:ƒ¼Ü o³nšg vœtu® s”ŸÈpÜˆfÜ cÚÃùiÚ %d", 
cÚÃùiÚ
);

1967 
	}
}

1978 
	$­p_dg_şo£_‰y
(
cÚÃùiÚ
)

1980 #ifdeà
BSA_USE_SERIAL_PORT


1981 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
¡İ_‰y_»ad
 = 1;

1982 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 != -1)

1984 
	`şo£
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
);

1985 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
£rŸl_fd
 = -1;

1988 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
soÿt_pid
 &&‡pp_dg_cb.connections[connection].socat_pid != -1)

1990 
	`kl
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
soÿt_pid
, 
SIGTERM
);

1991 
	`¦“p
(1);

1992 
	`kl
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
soÿt_pid
, 
SIGKILL
);

1994 
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
soÿt_pid
 = -1;

1995 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
 != 0)

1996 
	`±h»ad_još
Ğ
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
»ad_th»ad
, 
NULL
);

1998 
	}
}

2010 * 
	$­p_dg_»ad_´oc
(*
d©a
)

2012 #ifdeà
BSA_USE_SERIAL_PORT


2013 
bufãr
[
APP_DG_RX_BUFFER_SIZE
];

2014 
cÚn
 = ()
d©a
;

2015 
i
 = 0;

2017 ià(
cÚn
 >ğ
APP_DG_NB_CON_MAX
)

2019 
	`APP_ERROR1
("­p_dg_»ad_´oc(èšv®id cÚÃùiÚ: %d",
cÚn
);

2024 
­p_dg_cb
.
cÚÃùiÚs
[
cÚn
].
£rŸl_fd
 =ğ-1 && !­p_dg_cb.cÚÃùiÚs[cÚn].
¡İ_‰y_»ad
)

2026 ià(
	`­p_dg_İ’_‰y
(
cÚn
) != -1)

2029 ià(
i
++ >= 4)

2031 
	`APP_ERROR1
("­p_dg_»ad_´oc(èuÇbËØİ’ s”ŸÈpÜˆfÜ cÚÃùiÚ: %d",
cÚn
);

2035 
	`u¦“p
(200 * 1000);

2038 !
­p_dg_cb
.
cÚÃùiÚs
[
cÚn
].
¡İ_‰y_»ad
)

2040 
	`mem£t
(
bufãr
, 0, (buffer));

2041 
n
 = 
	`»ad
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚn
].
£rŸl_fd
, 
bufãr
, (buffer));

2043 ià(
n
 < 0)

2045 
	`APP_ERROR1
("­p_dg_»ad_´oc(è»ad faed: %d", 
”ºo
);

2049 
bufãr
[
n
] = 0;

2050 
	`APP_DEBUG1
("­p_dg_»ad_´oc(è»cv %d by‹s", 
n
);

2052 if(
n
 > 0)

2053 
	`­p_dg_£nd
(
cÚn
,
bufãr
,
n
);

2056 
	`APP_DEBUG1
("­p_dg_»ad_´oc(ècÚn=%d,ƒx™šg", 
cÚn
);

2058 
	}
}

2069 
	$­p_dg_loİback_toggË
()

2071 ià(
­p_dg_cb
.
loİback
 =ğ
TRUE
)

2073 
	`APP_INFO0
("Data Loopback in‚ow FALSE");

2074 
­p_dg_cb
.
loİback
 = 
FALSE
;

2078 
	`APP_INFO0
("Data Loopback in‚ow TRUE");

2079 
­p_dg_cb
.
loİback
 = 
TRUE
;

2081 
	}
}

2092 
	$­p_dg_cÚ_®loc
()

2094 
i
;

2096 
i
 = 0 ; i < 
APP_DG_NB_CON_MAX
 ; i++)

2098 ià(
­p_dg_cb
.
cÚÃùiÚs
[
i
].
š_u£
 =ğ
FALSE
)

2101 
	`APP_DEBUG1
("AÎoÿ‹ DG cÚÃùiÚ:%d", 
i
);

2102 
	`mem£t
(&
­p_dg_cb
.
cÚÃùiÚs
[
i
], 0, (app_dg_cb.connections[i]));

2103 
­p_dg_cb
.
cÚÃùiÚs
[
i
].
š_u£
 = 
TRUE
;

2104 
­p_dg_cb
.
cÚÃùiÚs
[
i
].
hªdË
 = 
APP_DG_BAD_HANDLE
;

2105 
­p_dg_cb
.
cÚÃùiÚs
[
i
].
uc_chªÃl
 = 
APP_DG_BAD_UIPC
;

2107  
i
;

2110  
APP_DG_NB_CON_MAX
;

2111 
	}
}

2122 
	$­p_dg_cÚ_ä“
(
cÚÃùiÚ
)

2124 ià((
cÚÃùiÚ
 >= 0 ) &&

2125 (
cÚÃùiÚ
 < 
APP_DG_NB_CON_MAX
))

2127 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
š_u£
 =ğ
FALSE
)

2129 
	`APP_ERROR1
("CÚÃùiÚ:%d wa nÙ iÀu£", 
cÚÃùiÚ
);

2132 ià(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
)

2134 
	`GKI_ä“buf
(
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
].
p_tx_³ndšg
);

2137 
	`mem£t
(&
­p_dg_cb
.
cÚÃùiÚs
[
cÚÃùiÚ
], 0, (app_dg_cb.connections[connection]));

2141 
	`APP_ERROR1
("Bad cÚÃùiÚ:%d", 
cÚÃùiÚ
);

2143 
	}
}

2154 
	$­p_dg_cÚ_ä“_®l
()

2156 
UINT8
 
šdex
;

2157 
šdex
 = 0; index< 
APP_DG_NB_CON_MAX
; index++)

2159 
	`­p_dg_şo£_‰y
(
šdex
);

2160 #ifdeà
BSA_USE_INGENIC_SERIAL_PORT


2161 
	`­p_dg_şo£_sock‘
(
šdex
);

2164 ià(
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
p_tx_³ndšg
)

2166 
	`GKI_ä“buf
(
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
p_tx_³ndšg
);

2169 
	`mem£t
(&
­p_dg_cb
.
cÚÃùiÚs
[
šdex
], 0, (app_dg_cb.connections[index]));

2171 
	}
}

2182 
	$­p_dg_cÚ_di¥Ïy
()

2184 
šdex
;

2186 
	`APP_DEBUG0
("AG Connections:");

2188 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

2190 ià(
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
 !ğ
FALSE
)

2192 
	`APP_INFO1
("\tConnection:%d Handle:%d IsServer:%d IsOpen:%d UIPC:%d Service:%d",

2193 
šdex
,

2194 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
,

2195 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_£rv”
,

2196 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_İ’
,

2197 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
uc_chªÃl
,

2198 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
£rviû
);

2201 
	}
}

2212 
	$­p_dg_cÚ_di¥Ïy_debug
()

2214 
šdex
;

2216 
	`APP_INFO0
("AG Connections(Debug):");

2218 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

2220 
	`APP_INFO1
("Connection:%d Handle:%d IsServer:%d InUse:%d IsOpen:%d UIPC:%d Service:%d",

2221 
šdex
,

2222 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
,

2223 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_£rv”
,

2224 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
,

2225 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_İ’
,

2226 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
uc_chªÃl
,

2227 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
£rviû
);

2229 
	}
}

2240 
	$­p_dg_cÚ_g‘_äom_hªdË
(
tBSA_DG_HNDL
 
hªdË
, 
BOOLEAN
 *
p_is_£rv”
)

2242 
šdex
;

2244 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

2246 ià((
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
 !ğ
FALSE
) &&

2247 (
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
hªdË
 == handle))

2249 
	`APP_DEBUG1
("Found DG cÚÃùiÚ:%d m©chšg HªdË:%d IsS”v”:%d", 
šdex
, 
hªdË
,

2250 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_£rv”
);

2251 ià(
p_is_£rv”
 !ğ
NULL
)

2253 *
p_is_£rv”
 = 
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
is_£rv”
;

2255  
šdex
;

2258  
APP_DG_NB_CON_MAX
;

2259 
	}
}

2270 
	$­p_dg_cÚ_g‘_äom_uc
(
tUIPC_CH_ID
 
chªÃl_id
)

2272 
šdex
;

2274 
šdex
 = 0 ; index < 
APP_DG_NB_CON_MAX
 ; index++)

2276 ià((
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
š_u£
 !ğ
FALSE
) &&

2277 (
­p_dg_cb
.
cÚÃùiÚs
[
šdex
].
uc_chªÃl
 =ğ
chªÃl_id
))

2279 
	`APP_DEBUG1
("Found DG cÚÃùiÚ:%d m©chšg ChªÃl:%d", 
šdex
, 
chªÃl_id
);

2280  
šdex
;

2283  
APP_DG_NB_CON_MAX
;

2284 
	}
}

2295 *
	$­p_dg_g‘_¤v_desc
(
tBSA_SERVICE_ID
 
£rviû
)

2297 ià(
£rviû
 =ğ
BSA_SPP_SERVICE_ID
)

2301 ià(
£rviû
 =ğ
BSA_DUN_SERVICE_ID
)

2309 
	}
}

2312 
	$­p_dg_»gi¡”_d©a_cback
(*
u£r
, (*
»ûiveSµD©aCback
)(*u£r, 
cÚn_id
, * 
d©a
, 
size
)){

2313 
mReûiveSµD©aCback
 = 
»ûiveSµD©aCback
;

2314 
mSµU£r
 = 
u£r
;

2316 
	}
}

2318 
	$­p_dg_»gi¡”_lšk_¡©e_cback
(*
u£r
, (*
lškS‹Cback
)(*u£r,
cÚ_id
, 
BOOLEAN
 
lšked
,* 
»mÙe_addr
, 
size
)){

2319 
mLškS‹Cback
 = 
lškS‹Cback
;

2320 
mSµU£r
 = 
u£r
;

2322 
	}
}

	@source/app_hs.c

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

16 
	~<uni¡d.h
>

17 
	~<sys/ty³s.h
>

18 
	~<sys/¡©.h
>

19 
	~<sys/ioùl.h
>

20 
	~<sys/soundÿrd.h
>

21 
	~<sys/sock‘.h
>

22 
	~<sys/un.h
>

23 
	~<fú.h
>

24 
	~<”ºo.h
>

26 
	~"b§_­i.h
"

28 
	~"gki.h
"

29 
	~"uc.h
"

31 
	~"­p_uts.h
"

32 
	~"­p_xml_·¿m.h
"

33 
	~"­p_xml_uts.h
"

35 
	~"­p_disc.h
"

37 
	~"­p_hs.h
"

38 
	~"­p_dm.h
"

39 
	~"­p_wav.h
"

40 
	~"btm_­i.h
"

41 
	~"b_­i.h
"

43 #ifdeà
PCM_ALSA


44 
	~"®§/asoundlib.h
"

47 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


48 
	~<h¬dw¬e/h¬dw¬e.h
>

49 
	~<h¬dw¬e/audio.h
>

50 
	~"šg’ic_oss_ouut.h
"

51 
	~"šg’ic_oss_šput.h
"

52 
	#ALOGE
 
´štf


	)

57 
	mAPP_HS_KEY_OPEN
 = 1,

58 
	mAPP_HS_KEY_CLOSE
,

59 
	mAPP_HS_KEY_PRESS
,

60 
	mAPP_HS_KEY_PLAY
,

61 
	mAPP_HS_KEY_RECORD
,

62 
	mAPP_HS_KEY_STOP_RECORDING
,

63 
	mAPP_HS_KEY_QUIT
 = 99

66 
	#APP_HS_SAMPLE_RATE
 8000

	)

67 
	#APP_HS_BITS_PER_SAMPLE
 16

	)

68 
	#APP_HS_CHANNEL_NB
 1

	)

70 
	#APP_HS_FEATURES
 ( 
BSA_HS_FEAT_ECNR
 | 
BSA_HS_FEAT_3WAY
 | 
BSA_HS_FEAT_CLIP
 | \

71 
BSA_HS_FEAT_VREC
 | 
BSA_HS_FEAT_RVOL
 | 
BSA_HS_FEAT_ECS
 | \

72 
BSA_HS_FEAT_ECC
 | 
BSA_HS_FEAT_CODEC
 | 
BSA_HS_FEAT_UNAT
 )

	)

74 
	#APP_HS_MIC_VOL
 7

	)

75 
	#APP_HS_SPK_VOL
 7

	)

77 
	#APP_HS_SCO_IN_SOUND_FILE
 "./sco_š.wav"

	)

78 
	#APP_HS_SCO_OUT_SOUND_FILE
 
APP_HS_SCO_IN_SOUND_FILE


	)

80 
	#APP_HS_HSP_SERVICE_NAME
 "BSA H—d£t"

	)

81 
	#APP_HS_HFP_SERVICE_NAME
 "BSA Hªdsä“"

	)

83 
	#APP_HS_MAX_AUDIO_BUF
 240

	)

85 
	#APP_HS_XML_REM_DEVICES_FILE_PATH
 "./bt_deviûs.xml"

	)

86 
	#SNDCTL_EXT_STOP_DMA
 
	`_SIOW
 ('P', 91, )

	)

87 
	#AD_NODE_BUFSIZ
 (1024)

	)

89 
	sbt_cÚ‹xt
 {

90 
±h»ad_t
 
	m»ad_bt_th»ad
;

91 
±h»ad_t
 
	m»ad_dmic_th»ad
;

92 } 
	gbt_dev
;

94 
BOOLEAN
 
avk_is_¡¬‹d
();

95 
­p_avk_¶ay_¡İ
();

103 
tBSA_HS_CONN_CB
 
	mcÚn_cb
[
BSA_HS_MAX_NUM_CONN
];

104 
BOOLEAN
 
	m»gi¡”ed
;

105 
BOOLEAN
 
	mis_mu‹d
;

106 
BOOLEAN
 
	mmu‹_šbªd_ršg
;

107 
UINT32
 
	mršg_hªdË
;

108 
UINT32
 
	mcw_hªdË
;

109 
UINT32
 
	mÿÎ_İ_hªdË
;

110 
UINT8
 
	msco_rou‹
;

111 
	m»c_fd
;

112 
	md©a_size
;

113 
	maudio_buf
[
APP_HS_MAX_AUDIO_BUF
];

114 
BOOLEAN
 
	mİ’_³ndšg
;

115 } 
	ttAPP_HS_CB
;

121 
tAPP_HS_CB
 
	g­p_hs_cb
;

123 
	gbt_r_fd
 = -1;

124 
	gbt_w_fd
 = -1;

125 
BOOLEAN
 
	g»ad_bt_ÿÎ
 = 
FALSE
;

126 
BOOLEAN
 
	g»ad_dmic_ÿÎ
 = 
FALSE
;

128 
bt_¡¬t_ÿÎ
();

129 
bt_’d_ÿÎ
();

133 
	gcu¼’t_hs_bcs
 = 
BSA_SCO_CODEC_CVSD
;

135 cÚ¡ *
	g­p_hs_£rviû_šd_Çme
[] =

141 cÚ¡ *
	g­p_hs_ÿÎ_šd_Çme
[] =

147 cÚ¡ *
	g­p_hs_ÿÎ£tup_šd_Çme
[] =

155 cÚ¡ *
	g­p_hs_ÿÎh–d_šd_Çme
[] =

162 cÚ¡ *
	g­p_hs_rßm_šd_Çme
[] =

169 
tHsC®lback
 *
	gs_pHsC®lback
 = 
NULL
;

171 #ifdeà
PCM_ALSA


172 *
	g®§_deviû
 = "default";

173 
¢d_pcm_t
 *
	g®§_hªdË_¶ayback
 = 
NULL
;

174 
¢d_pcm_t
 *
	g®§_hªdË_ÿ±u»
 = 
NULL
;

175 
BOOLEAN
 
	g®§_ÿ±u»_İ’ed
 = 
FALSE
;

176 
BOOLEAN
 
	g®§_¶ayback_İ’ed
 = 
FALSE
;

179 #ifdeà
PCM_ALSA


180 
­p_hs_İ’_®§_du¶ex
();

181 
­p_hs_şo£_®§_du¶ex
();

186 #ifdeà
__ılu¥lus


189 
cÚ¡ruù_šÿÎ
()

192 if(
NULL
 =ğ
šÿÎ
){

193 
šÿÎ
 = 
Ãw
 
ªdroid
::
InC®l
();

199 
de¡ruù_šÿÎ
()

202 if(
šÿÎ
 !ğ
NULL
){

203 
d–‘e
 
šÿÎ
;

204 
šÿÎ
 = 
NULL
;

209 #ifdeà
__ılu¥lus


225 
tBSA_HS_CONN_CB
 *
	$­p_hs_g‘_deçuÉ_cÚn
()

227 
UINT16
 
cb_šdex
;

229 
	`APPL_TRACE_EVENT0
("app_hs_get_default_conn");

231 
cb_šdex
 = 0; cb_šdex < 
BSA_HS_MAX_NUM_CONN
; cb_index++)

233 if(
­p_hs_cb
.
cÚn_cb
[
cb_šdex
].
cÚÃùiÚ_aùive
)

234  &
­p_hs_cb
.
cÚn_cb
[
cb_šdex
];

236  
NULL
;

237 
	}
}

247 
tBSA_HS_CONN_CB
 *
	$­p_hs_g‘_cÚn_by_hªdË
(
UINT16
 
hªdË
)

249 
	`APPL_TRACE_EVENT1
("­p_hs_g‘_cÚn_by_hªdË: %d", 
hªdË
);

252 ià(
hªdË
 <ğ
BSA_HS_MAX_NUM_CONN
)

254  &
­p_hs_cb
.
cÚn_cb
[
hªdË
-1];

257  
NULL
;

258 
	}
}

268 
UINT8
 
	$­p_hs_fšd_šdiÿtÜ_id
(* 
šd
, * 
f›ld
)

270 
UINT16
 
¡ršg_Ën
 = 
	`¡¾’
(
šd
);

271 
UINT8
 
i
, 
id
 = 0;

272 
BOOLEAN
 
sk
 = 
FALSE
;

274 
i
=0; i< 
¡ršg_Ën
 ; i++)

276 if(
šd
[
i
] == '"')

278 if(!
sk
)

280 
id
++;

281 if(!
	`¡ºcmp
(&
šd
[
i
+1], 
f›ld
, 
	`¡¾’
(field)) && (ind[i+1+strlen(field)] == '"'))

284  
id
;

289 
sk
 = 
TRUE
;

294 
sk
 = 
FALSE
;

299 
	}
}

309 
	$­p_hs_decode_šdiÿtÜ_¡ršg
(
tBSA_HS_CONN_CB
 *
p_cÚn
, * 
šd
)

311 
p_cÚn
->
ÿÎ_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "call");

312 
p_cÚn
->
ÿÎ_£tup_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "callsetup");

313 if(!
p_cÚn
->
ÿÎ_£tup_šd_id
)

315 
p_cÚn
->
ÿÎ_£tup_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "call_setup");

317 
p_cÚn
->
£rviû_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "service");

318 
p_cÚn
->
b©‹ry_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "battchg");

319 
p_cÚn
->
ÿÎh–d_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "callheld");

320 
p_cÚn
->
sigÇl_¡»ngth_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "signal");

321 
p_cÚn
->
rßm_šd_id
 = 
	`­p_hs_fšd_šdiÿtÜ_id
(
šd
, "roam");

322 
	}
}

332 
	$­p_hs_£t_š™Ÿl_šdiÿtÜ_¡©us
(
tBSA_HS_CONN_CB
 *
p_cÚn
, * 
šd
)

334 
UINT8
 
i
, 
pos
;

337 
p_cÚn
->
cu¼_ÿÎ_šd
 = 0;

338 
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 = 0;

339 
p_cÚn
->
cu¼_£rviû_šd
 = 0;

340 
p_cÚn
->
cu¼_ÿÎh–d_šd
 = 0;

341 
p_cÚn
->
cu¼_sigÇl_¡»ngth_šd
 = 0;

342 
p_cÚn
->
cu¼_rßm_šd
 = 0;

343 
p_cÚn
->
cu¼_b©‹ry_šd
 = 0;

346  *
šd
 == ' ' ) ind++;

349 
pos
 = 
p_cÚn
->
ÿÎ_šd_id
 -1;

350 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

352 if(!
pos
)

354 
p_cÚn
->
cu¼_ÿÎ_šd
 = 
šd
[
i
] - '0';

357 if(
šd
[
i
] == ',')

358 
pos
--;

362 
pos
 = 
p_cÚn
->
ÿÎ_£tup_šd_id
 -1;

363 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

365 if(!
pos
)

367 
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 = 
šd
[
i
] - '0';

370 if(
šd
[
i
] == ',')

371 
pos
--;

375 
pos
 = 
p_cÚn
->
£rviû_šd_id
 -1;

376 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

378 if(!
pos
)

380 
p_cÚn
->
cu¼_£rviû_šd
 = 
šd
[
i
] - '0';

382 if(!
p_cÚn
->
cu¼_£rviû_šd
)

392 if(
šd
[
i
] == ',')

393 
pos
--;

397 
pos
 = 
p_cÚn
->
ÿÎh–d_šd_id
 -1;

398 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

400 if(!
pos
)

402 
p_cÚn
->
cu¼_ÿÎh–d_šd
 = 
šd
[
i
] - '0';

405 if(
šd
[
i
] == ',')

406 
pos
--;

410 
pos
 = 
p_cÚn
->
sigÇl_¡»ngth_šd_id
 -1;

411 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

413 if(!
pos
)

415 
p_cÚn
->
cu¼_sigÇl_¡»ngth_šd
 = 
šd
[
i
] - '0';

418 if(
šd
[
i
] == ',')

419 
pos
--;

423 
pos
 = 
p_cÚn
->
rßm_šd_id
 -1;

424 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

426 if(!
pos
)

428 
p_cÚn
->
cu¼_rßm_šd
 = 
šd
[
i
] - '0';

431 if(
šd
[
i
] == ',')

432 
pos
--;

436 
pos
 = 
p_cÚn
->
b©‹ry_šd_id
 -1;

437 
i
=0; i< 
	`¡¾’
(
šd
) ; i++)

439 if(!
pos
)

441 
p_cÚn
->
cu¼_b©‹ry_šd
 = 
šd
[
i
] - '0';

444 if(
šd
[
i
] == ',')

445 
pos
--;

448 if(
p_cÚn
->
cu¼_ÿÎh–d_šd
 != 0)

450 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_3WAY_HELD
);

452 if(
p_cÚn
->
cu¼_ÿÎ_šd
 =ğ
BSA_HS_CALL_ACTIVE
)

454 if(
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 =ğ
BSA_HS_CALLSETUP_INCOMING
)

456 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_WAITCALL
);

460 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_CALLACTIVE
);

463 if(
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 =ğ
BSA_HS_CALLSETUP_INCOMING
)

465 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_RINGACT
);

467 if((
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 =ğ
BSA_HS_CALLSETUP_OUTGOING
) ||

468 (
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 =ğ
BSA_HS_CALLSETUP_ALERTING
)

471 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_OUTGOINGCALL
);

475 if(
p_cÚn
->
cu¼_£rviû_šd
 < 2)

476 
	`APPL_TRACE_EVENT2
("S”viû: %s,%d", 
­p_hs_£rviû_šd_Çme
[
p_cÚn
->
cu¼_£rviû_šd
],p_conn->curr_service_ind);

478 if(
p_cÚn
->
cu¼_ÿÎ_šd
 < 2)

479 
	`APPL_TRACE_EVENT2
("C®l: %s,%d", 
­p_hs_ÿÎ_šd_Çme
[
p_cÚn
->
cu¼_ÿÎ_šd
],p_conn->curr_call_ind);

481 if(
p_cÚn
->
cu¼_ÿÎ_£tup_šd
 < 4)

482 
	`APPL_TRACE_EVENT2
("C®l£tup: Ind %s,%d", 
­p_hs_ÿÎ£tup_šd_Çme
[
p_cÚn
->
cu¼_ÿÎ_£tup_šd
],p_conn->curr_call_setup_ind);

484 if(
p_cÚn
->
cu¼_ÿÎh–d_šd
 < 3)

485 
	`APPL_TRACE_EVENT2
("HŞd: %s,%d", 
­p_hs_ÿÎh–d_šd_Çme
[
p_cÚn
->
cu¼_ÿÎh–d_šd
],p_conn->curr_callheld_ind);

487 if(
p_cÚn
->
cu¼_rßm_šd
 < 2)

488 
	`APPL_TRACE_EVENT2
("Rßm: %s,%d", 
­p_hs_rßm_šd_Çme
[
p_cÚn
->
cu¼_rßm_šd
],p_conn->curr_roam_ind);

489 
	}
}

502 
	$­p_hs_wr™e_to_fe
(
UINT8
 *
p_buf
, 
size
)

504 #ifdeà
PCM_ALSA


505 
	`APP_ERROR0
("Cannot writeo file when PCM_ALSA is defined");

509 
»t
;

510 if(
­p_hs_cb
.
»c_fd
 <= 0)

512 
	`APP_DEBUG0
("no fileo write...\n");

516 
»t
 = 
	`wr™e
(
­p_hs_cb
.
»c_fd
, 
p_buf
, 
size
);

518 if(
»t
 !ğ
size
)

520 
	`APP_ERROR1
("wr™çed w™h cod%d, fd %d", 
»t
, 
­p_hs_cb
.
»c_fd
);

524  
»t
;

525 
	}
}

538 
	$­p_hs_sco_uc_cback
(
BT_HDR
 *
p_buf
)

540 
UINT8
 *
µ
 = (UINT8 *)(
p_buf
 + 1);

541 
UINT8
 
pkt_Ën
;

542 
UINT16
 
»ad_Ën
 = 240;

543 
»t
 = 0;

544 #ifdeà
PCM_ALSA


545 
¢d_pcm_säames_t
 
®§_äames
;

546 
¢d_pcm_säames_t
 
®§_äames_ex³ùed
;

549 ià(
p_buf
 =ğ
NULL
)

554 
pkt_Ën
 = 
p_buf
->
Ën
;

556 ià(
­p_hs_cb
.
»c_fd
>0)

558 
	`­p_hs_wr™e_to_fe
(
µ
, 
pkt_Ën
);

562 #ifdeà
PCM_ALSA


565 
®§_äames_ex³ùed
 = 
pkt_Ën
 / 
APP_HS_CHANNEL_NB
;

566 
®§_äames_ex³ùed
 /= 2;

568 ià(
®§_¶ayback_İ’ed
 !ğ
FALSE
)

573 
®§_äames
 = 
	`¢d_pcm_wr™ei
(
®§_hªdË_¶ayback
, 
µ
, 
®§_äames_ex³ùed
);

574 ià(
®§_äames
 < 0)

576 
	`APP_DEBUG1
("¢d_pcm_»cov” %d", ()
®§_äames
);

577 
®§_äames
 = 
	`¢d_pcm_»cov”
(
®§_hªdË_¶ayback
,‡lsa_frames, 0);

579 ià(
®§_äames
 < 0)

581 
	`APP_ERROR1
("¢d_pcm_wr™e˜çed: %s", 
	`¢d_¡»¼Ü
(
®§_äames
));

583 ià(
®§_äames
 > 0 &&‡l§_äame < 
®§_äames_ex³ùed
)

585 
	`APP_ERROR1
("Short write (expected %d, wrote %d)",

586 ()
®§_äames_ex³ùed
, ()
®§_äames
);

591 
	`APP_DEBUG0
("alsa_playback_opened NOT");

594 ià(
®§_ÿ±u»_İ’ed
 !ğ
FALSE
)

599 
®§_äames
 = 
	`¢d_pcm_»adi
(
®§_hªdË_ÿ±u»
, 
­p_hs_cb
.
audio_buf
, 
®§_äames_ex³ùed
);

600 ià(
®§_äames
 < 0)

602 
	`APP_ERROR1
("¢d_pcm_»ad˜»tuºs: %d", ()
®§_äames
);

604 ià((
®§_äames
 > 0) &&

605 (
®§_äames
 < 
®§_äames_ex³ùed
))

607 
	`APP_ERROR1
("ShÜˆ»ad (ex³ùed %i, wrÙ%i)", ()
®§_äames_ex³ùed
, ()
®§_äames
);

613 
tBSA_HS_CONN_CB
 * 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[0]);

615 ià(
TRUE
 !ğ
	`UIPC_S’d
(
p_cÚn
->
uc_chªÃl
, 0, (
UINT8
 *è
­p_hs_cb
.
audio_buf
, 
®§_äames
 * 2))

617 
	`APP_ERROR0
("UIPC_Send failed");

622 
	`APP_DEBUG0
("alsa_capture NOT opened");

626 
	`GKI_ä“buf
(
p_buf
);

627 
	}
}

641 
	$­p_hs_»ad_xml_»mÙe_deviûs
()

643 
¡©us
;

644 
šdex
;

646 
šdex
 = 0; index < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

648 
­p_xml_»mÙe_deviûs_db
[
šdex
].
š_u£
 = 
FALSE
;

651 
¡©us
 = 
	`­p_xml_»ad_db
(
APP_HS_XML_REM_DEVICES_FILE_PATH
, 
­p_xml_»mÙe_deviûs_db
,

652 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

654 ià(
¡©us
 < 0)

656 
	`APP_ERROR1
("­p_xml_»ad_db faed (%d)", 
¡©us
);

660 
	}
}

674 
	$­p_hs_İ’
(
BD_ADDR
 *
bd_addr_š
 )

676 
tBSA_STATUS
 
¡©us
 = 0;

677 
BD_ADDR
 
bd_addr
;

678 
deviû_šdex
;

680 
tBSA_HS_OPEN
 
·¿m
;

682 
	`APP_DEBUG0
("Entering");

684 if(
bd_addr_š
 =ğ
NULL
)

686 
	`´štf
("Bluetooth AG menu:\n");

687 
	`´štf
(" 0 Device from XML database (already…aired)\n");

688 
	`´štf
(" 1 Device found in†ast discovery\n");

689 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select source");

691 ià(
deviû_šdex
 == 0)

694 
	`­p_hs_»ad_xml_»mÙe_deviûs
();

696 
	`­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
, 
	`APP_NUM_ELEMENTS
(app_xml_remote_devices_db));

697 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

698 ià((
deviû_šdex
 >= 0) &&

699 (
deviû_šdex
 < 
	`APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

700 (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

702 
	`bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

706 
	`´štf
("Bad Deviû Index:%d\n", 
deviû_šdex
);

713 
	`­p_disc_di¥Ïy_deviûs
();

714 
	`´štf
("Enter device‚umber\n");

715 
deviû_šdex
 = 
	`­p_g‘_choiû
("Select device");

716 ià((
deviû_šdex
 >= 0) &&

717 (
deviû_šdex
 < 
APP_DISC_NB_DEVICES
) &&

718 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

720 
	`bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

724 
	`´štf
("Bad Deviû Index:%d\n", 
deviû_šdex
);

731 
	`bdıy
(
bd_addr
, *
bd_addr_š
);

734 
	`BSA_HsO³nIn™
(&
·¿m
);

736 
	`bdıy
(
·¿m
.
bd_addr
, bd_addr);

738 
·¿m
.
hndl
 = 
­p_hs_cb
.
cÚn_cb
[0].
hªdË
;

739 
¡©us
 = 
	`BSA_HsO³n
(&
·¿m
);

740 
­p_hs_cb
.
İ’_³ndšg
 = 
TRUE
;

742 ià(
¡©us
 !ğ
BSA_SUCCESS
)

744 
	`APP_ERROR1
("BSA_HsO³Àçed (%d)", 
¡©us
);

745 
­p_hs_cb
.
İ’_³ndšg
 = 
FALSE
;

747  
¡©us
;

748 
	}
}

761 
	$­p_hs_audio_İ’
()

763 
	`´štf
("app_hs_audio_open\n");

765 
tBSA_STATUS
 
¡©us
;

766 
tBSA_HS_AUDIO_OPEN
 
audio_İ’
;

767 
tBSA_HS_CONN_CB
 * 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[0]);

769 if(
­p_hs_cb
.
sco_rou‹
 =ğ
BSA_SCO_ROUTE_HCI
 &&

770 
p_cÚn
->
uc_chªÃl
 =ğ
UIPC_CH_ID_BAD
)

772 
	`APP_ERROR0
("Bad UIPC channel in‡pp_hs_audio_open");

776 
	`BSA_HsAudioO³nIn™
(&
audio_İ’
);

777 
audio_İ’
.
sco_rou‹
 = 
­p_hs_cb
.sco_route;

778 
audio_İ’
.
hndl
 = 
­p_hs_cb
.
cÚn_cb
[0].
hªdË
;

779 
¡©us
 = 
	`BSA_HsAudioO³n
(&
audio_İ’
);

780 ià(
¡©us
 !ğ
BSA_SUCCESS
)

782 
	`APP_ERROR1
("çed w™h stu : %d", 
¡©us
);

785  
¡©us
;

786 
	}
}

799 
	$­p_hs_audio_şo£
()

801 
	`´štf
("app_hs_audio_close\n");

802 
tBSA_STATUS
 
¡©us
;

803 
tBSA_HS_AUDIO_CLOSE
 
audio_şo£
;

804 
	`BSA_HsAudioClo£In™
(&
audio_şo£
);

805 
audio_şo£
.
hndl
 = 
­p_hs_cb
.
cÚn_cb
[0].
hªdË
;

806 
¡©us
 = 
	`BSA_HsAudioClo£
(&
audio_şo£
);

807 ià(
¡©us
 !ğ
BSA_SUCCESS
)

809 
	`APP_ERROR1
("çed w™h stu : %d", 
¡©us
);

812  
¡©us
;

813 
	}
}

823 
	$­p_hs_şo£
()

825 
tBSA_HS_CLOSE
 
·¿m
;

826 
tBSA_STATUS
 
¡©us
;

829 
	`BSA_HsClo£In™
(&
·¿m
);

833 
·¿m
.
hndl
 = 
­p_hs_cb
.
cÚn_cb
[0].
hªdË
;

835 
¡©us
 = 
	`BSA_HsClo£
(&
·¿m
);

836 ià(
¡©us
 !ğ
BSA_SUCCESS
)

838 
	`APP_ERROR1
("çed w™h stu : %d", 
¡©us
);

843 
	}
}

853 
	$­p_hs_ÿnûl
()

855 
tBSA_HS_CANCEL
 
·¿m
;

856 
tBSA_STATUS
 
¡©us
;

859 
	`BSA_HsCªûlIn™
(&
·¿m
);

861 
¡©us
 = 
	`BSA_HsCªûl
(&
·¿m
);

862 ià(
¡©us
 !ğ
BSA_SUCCESS
)

864 
	`APP_ERROR1
("çed w™h stu : %d", 
¡©us
);

869 
	}
}

878 
BOOLEAN
 
	$­p_is_İ’_³ndšg
()

880  
­p_hs_cb
.
İ’_³ndšg
;

881 
	}
}

891 
	$­p_hs_ªsw”_ÿÎ
()

893 
tBSA_HS_COMMAND
 
cmd_·¿m
;

894 
tBSA_HS_CONN_CB
 *
p_cÚn
;

896 
	`´štf
("app_hs_answer_call\n");

899 ià((
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()è=ğ
NULL
)

901 
	`APP_DEBUG0
("no connection‡vailable");

905 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

906 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

907 
cmd_·¿m
.
commªd
 = 
BSA_HS_A_CMD
;

908 
	`BSA_HsCommªd
(&
cmd_·¿m
);

910 
	}
}

920 
	$­p_hs_hªgup
()

922 
tBSA_HS_COMMAND
 
cmd_·¿m
;

923 
tBSA_HS_CONN_CB
 *
p_cÚn
;

925 
	`´štf
("app_hs_hangup\n");

928 ià((
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()è=ğ
NULL
)

930 
	`APP_DEBUG0
("no connection‡vailable");

934 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

935 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

936 
cmd_·¿m
.
commªd
 = 
BSA_HS_CHUP_CMD
;

937 
	`BSA_HsCommªd
(&
cmd_·¿m
);

940 
	}
}

954 
	$­p_hs_¡İ
()

956 
tBSA_HS_DISABLE
 
di§bË_·¿m
;

957 
tBSA_HS_DEREGISTER
 
d”egi¡”_·¿m
;

958 
tBSA_HS_CONN_CB
 * 
p_cÚn
;

959 
UINT8
 
šdex
;

961 
	`BSA_HsD”egi¡”In™
(&
d”egi¡”_·¿m
);

962 
šdex
=0; index<
BSA_HS_MAX_NUM_CONN
; index++)

964 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[
šdex
]);

965 
d”egi¡”_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

966 
	`APP_DEBUG1
("hªdË %d", 
d”egi¡”_·¿m
.
hndl
);

967 
	`BSA_HsD”egi¡”
(&
d”egi¡”_·¿m
);

969 if(
p_cÚn
->
uc_chªÃl
 !ğ
UIPC_CH_ID_BAD
)

971 if(
p_cÚn
->
uc_cÚÃùed
)

973 
	`APPL_TRACE_DEBUG0
("Closing UIPC Channel");

974 
	`UIPC_Clo£
(
p_cÚn
->
uc_chªÃl
);

975 
p_cÚn
->
uc_cÚÃùed
 = 
FALSE
;

977 
p_cÚn
->
uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

981 
	`BSA_HsDi§bËIn™
(&
di§bË_·¿m
);

982 
	`BSA_HsDi§bË
(&
di§bË_·¿m
);

986 
	}
}

999 
	$­p_hs_şo£_»c_fe
()

1001 
fd
;

1002 
tAPP_WAV_FILE_FORMAT
 
fÜm©
;

1004 if(
­p_hs_cb
.
»c_fd
 <= 0)

1007 
fÜm©
.
b™s_³r_§m¶e
 = 8;

1008 
fÜm©
.
b™s_³r_§m¶e
 = 
APP_HS_BITS_PER_SAMPLE
;

1009 
fÜm©
.
nb_chªÃls
 = 
APP_HS_CHANNEL_NB
;

1010 
fÜm©
.
§m¶e_¿‹
 = 
APP_HS_SAMPLE_RATE
;

1012 
fd
 = 
­p_hs_cb
.
»c_fd
;

1013 
­p_hs_cb
.
»c_fd
 = 0;

1014 
	`­p_wav_şo£_fe
(
fd
, &
fÜm©
);

1015 
	}
}

1028 
	$­p_hs_İ’_»c_fe
(* 
f’ame
)

1030 
­p_hs_cb
.
»c_fd
 = 
	`­p_wav_ü—‹_fe
(
f’ame
, 0);

1031 
	}
}

1044 
	$­p_hs_¶ay_fe
(* 
f’ame
)

1046 
tAPP_WAV_FILE_FORMAT
 
wav_fÜm©
;

1047 
nb_by‹s
 = 0;

1048 
fd
 = 0;

1050 
	`´štf
("app_hs_play_file\n");

1052 
fd
 = 
	`­p_wav_İ’_fe
(
f’ame
, &
wav_fÜm©
);

1054 if(
fd
 < 0)

1056 
	`´štf
("Error could‚ot open wav input file\n");

1057 
	`´štf
("U£hRecÜd‡udiØffunùiÚØü—‹‡ÀaudiØfÿÎed % ªdh’ry‡gaš\n",
APP_HS_SCO_OUT_SOUND_FILE
);

1063 
nb_by‹s
 = 
	`»ad
(
fd
, 
­p_hs_cb
.
audio_buf
, (app_hs_cb.audio_buf));

1065 if(
nb_by‹s
 < 0)

1067 
	`şo£
(
fd
);

1073 
tBSA_HS_CONN_CB
 * 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[0]);

1075 ià(
TRUE
 !ğ
	`UIPC_S’d
(
p_cÚn
->
uc_chªÃl
, 0,

1076 (
UINT8
 *è
­p_hs_cb
.
audio_buf
,

1077 
nb_by‹s
))

1079 
	`´štf
("error in UIPC send could‚ot send data \n");

1082 } 
nb_by‹s
 != 0);

1084 
	`şo£
(
fd
);

1087 
	}
}

1100 
	$­p_hs_cback
(
tBSA_HS_EVT
 
ev’t
, 
tBSA_HS_MSG
 *
p_d©a
)

1102 
buf
[100];

1103 
UINT16
 
hªdË
 = 0;

1104 
tBSA_HS_CONN_CB
 *
p_cÚn
;

1106 ià(!
p_d©a
)

1108 
	`´štf
("­p_hs_cback…_d©a=NULL fÜƒv’t:%d\n", 
ev’t
);

1113 
hªdË
 = 
p_d©a
->
hdr
.handle;

1114 
	`APPL_TRACE_DEBUG2
("­p_hs_cbackƒv’t:%d fÜ hªdË: %d", 
ev’t
, 
hªdË
);

1117 
p_cÚn
 = 
	`­p_hs_g‘_cÚn_by_hªdË
(
hªdË
);

1119 ià(!
p_cÚn
)

1121 
	`´štf
("­p_hs_cback: hªdË %d‚Ù suµÜ‹d\n", 
hªdË
);

1125 
ev’t
)

1127 
BSA_HS_CONN_EVT
:

1128 
	`´štf
("BSA_HS_CONN_EVT:\n");

1129 
­p_hs_cb
.
İ’_³ndšg
 = 
FALSE
;

1130 
	`´štf
(" - Remote bdaddr: %02x:%02x:%02x:%02x:%02x:%02x\n",

1131 
p_d©a
->
cÚn
.
bd_addr
[0],…_data->conn.bd_addr[1],

1132 
p_d©a
->
cÚn
.
bd_addr
[2],…_data->conn.bd_addr[3],

1133 
p_d©a
->
cÚn
.
bd_addr
[4],…_data->conn.bd_addr[5]);

1134 
	`´štf
(" - Service: ");

1135 
p_d©a
->
cÚn
.
£rviû
)

1137 
BSA_HSP_HS_SERVICE_ID
:

1138 
	`´štf
("Headset\n");

1140 
BSA_HFP_HS_SERVICE_ID
:

1141 
	`´štf
("Handsfree\n");

1144 
	`´štf
("NÙ suµÜ‹d 0x%08x\n", 
p_d©a
->
cÚn
.
£rviû
);

1150 ià(
p_cÚn
->
cÚÃùiÚ_aùive
)

1152 
	`´štf
("BSA_HS_CONN_EVT: cÚÃùiÚ‡Ì—dy o³Ãd fÜ hªdË %d\n", 
hªdË
);

1155 
	`bdıy
(
p_cÚn
->
cÚÃùed_bd_addr
, 
p_d©a
->
cÚn
.
bd_addr
);

1156 
p_cÚn
->
hªdË
 = 
p_d©a
->
cÚn
.handle;

1157 
p_cÚn
->
cÚÃùiÚ_aùive
 = 
TRUE
;

1158 
p_cÚn
->
cÚÃùed_hs_£rviû_id
 = 
p_d©a
->
cÚn
.
£rviû
;

1159 
p_cÚn
->
³”_ã©u»
 = 
p_d©a
->
cÚn
.
³”_ã©u»s
;

1160 
p_cÚn
->
¡©us
 = 
BSA_HS_ST_CONNECT
;

1165 
BSA_HS_CLOSE_EVT
:

1167 
	`APP_DEBUG1
("BSA_HS_CLOSE_EVT,„—sÚ %d", 
p_d©a
->
hdr
.
¡©us
);

1168 
­p_hs_cb
.
İ’_³ndšg
 = 
FALSE
;

1170 ià(!
p_cÚn
->
cÚÃùiÚ_aùive
)

1172 
	`´štf
("BSA_HS_CLOSE_EVT: cÚÃùiÚ‚Ù o³Ãd fÜ hªdË %d\n", 
hªdË
);

1175 
p_cÚn
->
cÚÃùiÚ_aùive
 = 
FALSE
;

1176 
p_cÚn
->
šdiÿtÜ_¡ršg_»ûived
 = 
FALSE
;

1179 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_CONNECTABLE
);

1182 
BSA_HS_AUDIO_OPEN_EVT
:

1183 
	`årštf
(
¡dout
,"BSA_HS_AUDIO_OPEN_EVT\n");

1184 ià(
	`avk_is_¡¬‹d
(è=ğ
TRUE
){

1185 
	`­p_avk_¶ay_¡İ
();

1187 
»t
 = -1;

1188 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


1189 
§m¶e_¿‹
 = 8000;

1190 if(
cu¼’t_hs_bcs
==
BSA_SCO_CODEC_MSBC
)

1191 
§m¶e_¿‹
 = 16000;

1193 
»t
 = 
	`İ’_šg’ic_audio_oss_šput
(
§m¶e_¿‹
);

1195 
	`årštf
(
¡dout
,"BSA_HS_AUDIO_OPEN_EVT„‘ %d\n", 
»t
);

1196 #ifdeà
PCM_ALSA


1197 if(
	`BSA_HS_GETSTATUS
(
p_cÚn
, 
BSA_HS_ST_SCOOPEN
))

1198 
	`­p_hs_şo£_®§_du¶ex
();

1199 
	`­p_hs_İ’_®§_du¶ex
();

1201 if(
cu¼’t_hs_bcs
==
BSA_SCO_CODEC_MSBC
)

1202 
	`İ’_šg’ic_audio_oss_ouut
("hfp-msbc", 8);

1204 
	`İ’_šg’ic_audio_oss_ouut
("hfp-cvsd", 8);

1206 ià(
	`bt_¡¬t_ÿÎ
() < 0) {

1207 
	`´štf
("Error: bt_start_call failed!\n");

1210 
p_cÚn
->
ÿÎ_¡©e
 = 
BSA_HS_CALL_CONN
;

1211 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_SCOOPEN
);

1214 
BSA_HS_AUDIO_CLOSE_EVT
:

1215 
	`årštf
(
¡dout
,"BSA_HS_AUDIO_CLOSE_EVT\n");

1216 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


1217 
	`şo£_šg’ic_audio_oss_šput
();

1219 
	`şo£_šg’ic_audio_oss_ouut
();

1221 
	`bt_’d_ÿÎ
();

1222 #ifdeà
PCM_ALSA


1223 
	`­p_hs_şo£_®§_du¶ex
();

1225 ià(!
p_cÚn
->
cÚÃùiÚ_aùive
)

1227 
	`´štf
("BSA_HS_AUDIO_CLOSE_EVT: cÚÃùiÚ‚Ù o³Ãd fÜ hªdË %d\n", 
hªdË
);

1230 
p_cÚn
->
ÿÎ_¡©e
 = 
BSA_HS_CALL_NONE
;

1231 
	`BSA_HS_RESETSTATUS
(
p_cÚn
, 
BSA_HS_ST_SCOOPEN
);

1234 
BSA_HS_CIEV_EVT
:

1235 
	`´štf
("BSA_HS_CIEV_EVT\n");

1236 
	`¡ºıy
(
buf
, 
p_d©a
->
v®
.
¡r
, 4);

1237 
buf
[5] ='\0';

1238 
	`´štf
("C®ÈInd Stu %s\n",
buf
);

1239 ià(
p_cÚn
->
cÚÃùiÚ_aùive
)

1241 
šdiÿtÜ
 = 
buf
[1] - '0';

1242 
šdiÿtÜ_v®ue
 = 
buf
[3] - '0';

1243 if(
šdiÿtÜ
 =ğ
BTA_AG_IND_CALL
){

1244 if(
šdiÿtÜ_v®ue
 =ğ
BSA_HS_CALL_ACTIVE
){

1246 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_CALLACTIVE
);

1247 }if(
šdiÿtÜ_v®ue
 =ğ
BSA_HS_CALL_INACTIVE
){

1249 
	`BSA_HS_RESETSTATUS
(
p_cÚn
, 
BSA_HS_ST_CALLACTIVE
);

1251 }if(
šdiÿtÜ
 =ğ
BTA_AG_IND_CALLSETUP
){

1252 if(
šdiÿtÜ_v®ue
 =ğ
BTA_AG_CALLSETUP_INCOMING
){

1254 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_RINGACT
);

1255 }if(
šdiÿtÜ_v®ue
 =ğ
BSA_HS_CALLSETUP_OUTGOING
 || indiÿtÜ_v®u=ğ
BSA_HS_CALLSETUP_ALERTING
){

1257 
	`BSA_HS_SETSTATUS
(
p_cÚn
, 
BSA_HS_ST_OUTGOINGCALL
);

1260 
	`BSA_HS_RESETSTATUS
(
p_cÚn
, 
BSA_HS_ST_OUTGOINGCALL
 | 
BSA_HS_ST_RINGACT
);

1263 
	`´štf
("BSA_HS_CIEV_EVT:…_cÚn->¡©u %x\n", 
p_cÚn
->
¡©us
);

1264 if(
	`BSA_HS_GETSTATUS
(
p_cÚn
, 
BSA_HS_ST_IN_CALL
))

1267 
	`cÚ¡ruù_šÿÎ
();

1268 }if(
	`BSA_HS_GETSTATUS
(
p_cÚn
, 
BSA_HS_ST_CONNECT
))

1271 
	`de¡ruù_šÿÎ
();

1276 
BSA_HS_CIND_EVT
:

1277 
	`´štf
("BSA_HS_CIND_EVT\n");

1278 
	`´štf
("C®ÈIndiÿtÜ %s\n",
p_d©a
->
v®
.
¡r
);

1281 if(
p_cÚn
->
šdiÿtÜ_¡ršg_»ûived
)

1283 
	`­p_hs_£t_š™Ÿl_šdiÿtÜ_¡©us
(
p_cÚn
, 
p_d©a
->
v®
.
¡r
);

1287 
p_cÚn
->
šdiÿtÜ_¡ršg_»ûived
 = 
TRUE
;

1288 
	`­p_hs_decode_šdiÿtÜ_¡ršg
(
p_cÚn
, 
p_d©a
->
v®
.
¡r
);

1292 
BSA_HS_RING_EVT
:

1293 
	`årštf
(
¡dout
, "BSA_HS_RING_EVT\n");

1296 
BSA_HS_CLIP_EVT
:

1297 
	`årštf
(
¡dout
, "BSA_HS_CLIP_EVT\n");

1300 
BSA_HS_BSIR_EVT
:

1301 
	`årštf
(
¡dout
, "BSA_HS_BSIR_EVT\n");

1304 
BSA_HS_BVRA_EVT
:

1305 
	`årštf
(
¡dout
, "BSA_HS_BVRA_EVT\n");

1308 
BSA_HS_CCWA_EVT
:

1309 
	`årštf
(
¡dout
, "C®Èwa™šg : BSA_HS_CCWA_EVT:%s\n", 
p_d©a
->
v®
.
¡r
);

1312 
BSA_HS_CHLD_EVT
:

1313 
	`årštf
(
¡dout
, "BSA_HS_CHLD_EVT\n");

1316 
BSA_HS_VGM_EVT
:

1317 
	`årštf
(
¡dout
, "BSA_HS_VGM_EVT\n");

1320 
BSA_HS_VGS_EVT
:

1321 
	`årštf
(
¡dout
, "BSA_HS_VGS_EVT\n");

1324 
BSA_HS_BINP_EVT
:

1325 
	`årštf
(
¡dout
, "BSA_HS_BINP_EVT\n");

1328 
BSA_HS_BTRH_EVT
:

1329 
	`årštf
(
¡dout
, "BSA_HS_BTRH_EVT\n");

1332 
BSA_HS_CNUM_EVT
:

1333 
	`årštf
(
¡dout
, "BSA_HS_CNUM_EVT:%s\n",
p_d©a
->
v®
.
¡r
);

1336 
BSA_HS_COPS_EVT
:

1337 
	`årštf
(
¡dout
, "BSA_HS_COPS_EVT:%s\n",
p_d©a
->
v®
.
¡r
);

1340 
BSA_HS_CMEE_EVT
:

1341 
	`årštf
(
¡dout
, "BSA_HS_CMEE_EVT:%s\n", 
p_d©a
->
v®
.
¡r
);

1344 
BSA_HS_CLCC_EVT
:

1345 
	`årštf
(
¡dout
, "BSA_HS_CLCC_EVT:%s\n", 
p_d©a
->
v®
.
¡r
);

1348 
BSA_HS_UNAT_EVT
:

1349 
	`årštf
(
¡dout
, "BSA_HS_UNAT_EVT\n");

1352 
BSA_HS_OK_EVT
:

1353 
	`årštf
(
¡dout
, "BSA_HS_OK_EVT: commªd v®u%d, %s\n",
p_d©a
->
v®
.
num
,…_d©a->v®.
¡r
);

1356 
BSA_HS_ERROR_EVT
:

1357 
	`årštf
(
¡dout
, "BSA_HS_ERROR_EVT\n");

1360 
BSA_HS_BCS_EVT
:

1361 
	`årštf
(
¡dout
, "BSA_HS_BCS_EVT: codeø%d (%s)\n",
p_d©a
->
v®
.
num
,

1362 (
p_d©a
->
v®
.
num
 =ğ
BSA_SCO_CODEC_MSBC
) ? "mSBC":"CVSD");

1363 
cu¼’t_hs_bcs
 = 
p_d©a
->
v®
.
num
;

1366 
BSA_HS_OPEN_EVT
:

1367 
	`årštf
(
¡dout
, "BSA_HS_OPEN_EVT\n");

1368 
­p_hs_cb
.
İ’_³ndšg
 = 
FALSE
;

1372 
	`´štf
("­p_hs_cback unknowÀev’t:%d\n", 
ev’t
);

1375 
	`fæush
(
¡dout
);

1378 if(
s_pHsC®lback
)

1379 
	`s_pHsC®lback
(
ev’t
, 
p_d©a
);

1380 
	}
}

1393 
	$­p_hs_¡¬t
(
tHsC®lback
 
cb
)

1395 
tBSA_STATUS
 
¡©us
;

1397 
¡©us
 = 
	`­p_hs_’abË
();

1398 ià(
¡©us
 != 0)

1400  
¡©us
;

1403 
¡©us
 = 
	`­p_hs_»gi¡”
();

1405 
s_pHsC®lback
 = 
cb
;

1407  
¡©us
;

1408 
	}
}

1421 
	$­p_hs_’abË
()

1423 
¡©us
 = 0;

1424 
tBSA_HS_ENABLE
 
’abË_·¿m
;

1427 
	`BSA_HsEÇbËIn™
(&
’abË_·¿m
);

1428 
’abË_·¿m
.
p_cback
 = 
­p_hs_cback
;

1430 
¡©us
 = 
	`BSA_HsEÇbË
(&
’abË_·¿m
);

1431 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1433 
	`APP_DEBUG1
("BSA_HsEÇbË fae w™h stu %d", 
¡©us
);

1437 
	}
}

1450 
	$­p_hs_»gi¡”
()

1452 
šdex
, 
¡©us
 = 0;

1453 
tBSA_HS_REGISTER
 
·¿m
;

1454 
tBSA_HS_CONN_CB
 * 
p_cÚn
;

1456 
	`APP_DEBUG0
("start Register");

1459 
­p_hs_cb
.
sco_rou‹
 = 
BSA_SCO_ROUTE_PCM
;

1462 
	`BSA_HsRegi¡”In™
(&
·¿m
);

1463 
·¿m
.
£rviûs
 = 
BSA_HSP_HS_SERVICE_MASK
 | 
BSA_HFP_HS_SERVICE_MASK
;

1464 
·¿m
.
£c_mask
 = 
BSA_SEC_NONE
;

1466 
·¿m
.
ã©u»s
 = 
APP_HS_FEATURES
;

1467 if(
­p_hs_cb
.
sco_rou‹
 =ğ
BSA_SCO_ROUTE_HCI
)

1468 
·¿m
.
ã©u»s
 &ğ~
BSA_HS_FEAT_CODEC
;

1469 
·¿m
.
£‰šgs
.
eúr_’abËd
 = (·¿m.
ã©u»s
 & 
BSA_HS_FEAT_ECNR
è? 
TRUE
 : 
FALSE
;

1470 
·¿m
.
£‰šgs
.
mic_vŞ
 = 
APP_HS_MIC_VOL
;

1471 
·¿m
.
£‰šgs
.
¥k_vŞ
 = 
APP_HS_SPK_VOL
;

1472 
	`¡ºıy
(
·¿m
.
£rviû_Çme
[0], 
APP_HS_HSP_SERVICE_NAME
, 
BSA_HS_SERVICE_NAME_LEN_MAX
);

1473 
	`¡ºıy
(
·¿m
.
£rviû_Çme
[1], 
APP_HS_HFP_SERVICE_NAME
, 
BSA_HS_SERVICE_NAME_LEN_MAX
);

1476 
·¿m
.
sco_rou‹
 = 
­p_hs_cb
.sco_route;

1478 
šdex
=0; index<
BSA_HS_MAX_NUM_CONN
; index++)

1480 
¡©us
 = 
	`BSA_HsRegi¡”
(&
·¿m
);

1481 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1483 
	`APP_ERROR1
("UÇbËØ»gi¡” HS w™h stu %d", 
¡©us
);

1487 ià(
¡©us
 !ğ
BSA_SUCCESS
)

1489 
	`APP_ERROR1
("BSA_HsRegi¡” faed(%d)", 
¡©us
);

1493 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[
šdex
]);

1494 
p_cÚn
->
hªdË
 = 
·¿m
.
hndl
;

1495 
p_cÚn
->
uc_chªÃl
 = 
·¿m
.uipc_channel;

1497 
	`APP_DEBUG1
("Register complete handle %d, status %d, uipc [%d->%d], sco_route %d",

1498 
·¿m
.
hndl
, 
¡©us
, 
p_cÚn
->
uc_chªÃl
,…¬am.uc_chªÃl,…¬am.
sco_rou‹
);

1501 
	`APP_DEBUG0
("Register complete");

1504 
	}
}

1517 
	$­p_hs_š™
()

1519 
UINT8
 
šdex
;

1521 
	`mem£t
(&
­p_hs_cb
, 0, (app_hs_cb));

1523 
šdex
=0; index<
BSA_HS_MAX_NUM_CONN
 ; index++)

1525 
­p_hs_cb
.
cÚn_cb
[
šdex
].
uc_chªÃl
 = 
UIPC_CH_ID_BAD
;

1527 
	}
}

1540 
	$­p_hs_hŞd_ÿÎ
(
tBSA_BTHF_CHLD_TYPE_T
 
ty³
)

1542 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1543 
tBSA_HS_CONN_CB
 *
p_cÚn
;

1545 
	`´štf
("app_hs_hold_call\n");

1548 ià((
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()è=ğ
NULL
)

1550 
	`APP_DEBUG0
("no connection‡vailable");

1554 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1555 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1556 
cmd_·¿m
.
commªd
 = 
BSA_HS_CHLD_CMD
;

1557 
cmd_·¿m
.
d©a
.
num
 = 
ty³
;

1558 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1560 
	}
}

1573 
	$­p_hs_Ï¡_num_dŸl
()

1575 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1576 
tBSA_HS_CONN_CB
 *
p_cÚn
;

1578 
	`´štf
("app_hs_answer_call\n");

1581 ià((
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()è=ğ
NULL
)

1583 
	`APP_DEBUG0
("no connection‡vailable");

1587 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1588 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1589 
cmd_·¿m
.
commªd
 = 
BSA_HS_BLDN_CMD
;

1591 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1593 
	}
}

1606 
	$­p_hs_dŸl_num
(cÚ¡ *
num
)

1608 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1609 
tBSA_HS_CONN_CB
 *
p_cÚn
;

1611 
	`´štf
("app_hs_answer_call\n");

1613 if((
num
 =ğ
NULL
è|| (
	`¡¾’
(num) == 0))

1615 
	`APP_DEBUG0
("empty‚umber string");

1620 ià((
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()è=ğ
NULL
)

1622 
	`APP_DEBUG0
("no connection‡vailable");

1626 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1627 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1628 
cmd_·¿m
.
commªd
 = 
BSA_HS_D_CMD
;

1630 
	`¡rıy
(
cmd_·¿m
.
d©a
.
¡r
, 
num
);

1631 
	`¡rÿt
(
cmd_·¿m
.
d©a
.
¡r
, ";");

1632 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1634 
	}
}

1647 
	$­p_hs_£nd_uÇt
(*
cCmd
)

1649 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1650 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1652 
	`´štf
("­p_hs_£nd_uÇt:Commªd : %s\n", 
cCmd
);

1655 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())è|| NULL==
cCmd
)

1657 
	`APP_DEBUG0
("no connection‡vailable or invalid AT Command");

1661 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1662 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1663 
cmd_·¿m
.
commªd
 = 
BSA_HS_UNAT_CMD
;

1665 
	`¡ºıy
(
cmd_·¿m
.
d©a
.
¡r
, 
cCmd
, (cmd_param.data.str)-1);

1667 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1669 
	}
}

1682 
	$­p_hs_£nd_şcc_cmd
()

1684 
	`´štf
("app_hs_send_clcc_cmd\n");

1685 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1686 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1689 ià(
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()))

1691 
	`APP_DEBUG0
("no connection‡vailable");

1695 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1696 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1697 
cmd_·¿m
.
commªd
 = 
BSA_HS_CLCC_CMD
;

1698 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1700 
	}
}

1713 
	$­p_hs_£nd_cİs_cmd
(*
cCmd
)

1715 
	`´štf
("app_hs_send_cops_cmd\n");

1716 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1717 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1720 ià(
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()))

1722 
	`APP_DEBUG0
("no connection‡vailable");

1726 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1727 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1728 
	`¡ºıy
(
cmd_·¿m
.
d©a
.
¡r
, 
cCmd
, (cmd_param.data.str)-1);

1729 
cmd_·¿m
.
commªd
 = 
BSA_HS_COPS_CMD
;

1730 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1732 
	}
}

1745 
	$­p_hs_£nd_šd_cmd
()

1747 
	`´štf
("app_hs_send_cind_cmd\n");

1748 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1749 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1752 ià(
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
()))

1754 
	`APP_DEBUG0
("no connection‡vailable");

1758 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1759 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1760 
cmd_·¿m
.
commªd
 = 
BSA_HS_CIND_CMD
;

1761 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1763 
	}
}

1773 
	$­p_hs_mu‹_unmu‹_miüİhÚe
(
BOOLEAN
 
bMu‹
)

1775 
¡r
[20];

1776 
	`mem£t
(
¡r
,'\0',(str));

1777 
	`¡rıy
(
¡r
, "+CMUT=");

1779 if(
bMu‹
)

1780 
	`¡rÿt
(
¡r
, "1");

1782 
	`¡rÿt
(
¡r
, "0");

1783  
	`­p_hs_£nd_uÇt
(
¡r
);

1784 
	}
}

1797 
	$­p_hs_£nd_dtmf
(
dtmf
)

1799 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1800 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1802 
	`´štf
("­p_hs_£nd_dtmf:Commªd : %x\n", 
dtmf
);

1805 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())è|| '\0'==
dtmf
)

1807 
	`APP_DEBUG0
("no connection‡vailable or invalid DTMF Command");

1811 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1812 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1813 
cmd_·¿m
.
commªd
 = 
BSA_HS_VTS_CMD
;

1815 
cmd_·¿m
.
d©a
.
¡r
[0] = 
dtmf
;

1816 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1818 
	}
}

1831 
	$­p_hs_£nd_úum
()

1833 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1834 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1836 
	`´štf
("app_hs_send_cnum:Command \n");

1839 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())))

1841 
	`APP_DEBUG0
("no connection‡vailable or invalid DTMF Command");

1845 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1846 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1847 
cmd_·¿m
.
commªd
 = 
BSA_HS_CNUM_CMD
;

1848 
cmd_·¿m
.
d©a
.
num
=0;

1850 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1852 
	}
}

1865 
	$­p_hs_£nd_key´ess_evt
(*
cCmd
)

1867 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1868 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1870 
	`´štf
("app_hs_send_keypress_evt:Command \n");

1873 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())))

1875 
	`APP_DEBUG0
("no connection‡vailable");

1879 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1880 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1881 
cmd_·¿m
.
commªd
 = 
BSA_HS_CKPD_CMD
;

1882 
	`¡ºıy
(
cmd_·¿m
.
d©a
.
¡r
, 
cCmd
, (cmd_param.data.str)-1);

1884 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1886 
	}
}

1899 
	$­p_hs_¡¬t_voiû_»cogn™iÚ
()

1901 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1902 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1904 
	`´štf
("app_hs_start_voice_recognition:Command \n");

1907 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())))

1909 
	`APP_DEBUG0
("no connection‡vailable");

1913 if(
­p_hs_cb
.
cÚn_cb
[0].
³”_ã©u»
 & 
BSA_HS_PEER_FEAT_VREC
)

1915 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1916 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1917 
cmd_·¿m
.
commªd
 = 
BSA_HS_BVRA_CMD
;

1918 
cmd_·¿m
.
d©a
.
num
 = 1;

1920 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1924 
	`APP_DEBUG0
("Peer feature - VR feature‚ot‡vailable");

1926 
	}
}

1940 
	$­p_hs_¡İ_voiû_»cogn™iÚ
()

1942 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1943 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1945 
	`´štf
("app_hs_stop_voice_recognition:Command \n");

1948 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())))

1950 
	`APP_DEBUG0
("no connection‡vailable");

1954 if(
­p_hs_cb
.
cÚn_cb
[0].
³”_ã©u»
 & 
BSA_HS_PEER_FEAT_VREC
)

1956 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1957 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1958 
cmd_·¿m
.
commªd
 = 
BSA_HS_BVRA_CMD
;

1959 
cmd_·¿m
.
d©a
.
num
 = 0;

1960 
	`BSA_HsCommªd
(&
cmd_·¿m
);

1964 
	`APP_DEBUG0
("Peer feature - VR feature‚ot‡vailable");

1966 
	}
}

1979 
	$­p_hs_£t_vŞume
(
tBSA_BTHF_VOLUME_TYPE_T
 
ty³
, 
vŞume
)

1981 
tBSA_HS_COMMAND
 
cmd_·¿m
;

1982 
tBSA_HS_CONN_CB
 *
p_cÚn
=
NULL
;

1984 
	`´štf
("­p_hs_£t_vŞume:Commªd : %d, %d\n", 
ty³
, 
vŞume
);

1987 ià((
NULL
==(
p_cÚn
 = 
	`­p_hs_g‘_deçuÉ_cÚn
())))

1989 
	`APP_DEBUG0
("no connection‡vailable");

1993 
	`BSA_HsCommªdIn™
(&
cmd_·¿m
);

1994 
cmd_·¿m
.
hndl
 = 
p_cÚn
->
hªdË
;

1996 if(
BTHF_VOLUME_TYPE_SPK
 =ğ
ty³
)

1997 
cmd_·¿m
.
commªd
 = 
BSA_HS_SPK_CMD
;

1999 
cmd_·¿m
.
commªd
 = 
BSA_HS_MIC_CMD
;

2001 
cmd_·¿m
.
d©a
.
num
 = 
vŞume
;

2002 
	`BSA_HsCommªd
(&
cmd_·¿m
);

2004 
	}
}

2017 
	$­p_hs_g‘®lIndiÿtÜV®ues
(
tBSA_HS_IND_VALS
 *
pIndV®s
)

2019 
tBSA_HS_CONN_CB
 * 
p_cÚn
 = &(
­p_hs_cb
.
cÚn_cb
[0]);

2020 if(
NULL
!=
p_cÚn
 && NULL!=
pIndV®s
)

2022 
pIndV®s
->
cu¼_ÿÎwa™_šd
 = 0;

2023 
pIndV®s
->
cu¼_sigÇl_¡»ngth_šd
 = 
p_cÚn
->curr_signal_strength_ind;

2024 
pIndV®s
->
cu¼_b©‹ry_šd
 = 
p_cÚn
->curr_battery_ind;

2025 
pIndV®s
->
cu¼_ÿÎ_šd
 = 
p_cÚn
->curr_call_ind;

2026 
pIndV®s
->
cu¼_ÿÎ_£tup_šd
 = 
p_cÚn
->curr_call_setup_ind;

2027 
pIndV®s
->
cu¼_rßm_šd
 = 
p_cÚn
->curr_roam_ind;

2028 
pIndV®s
->
cu¼_£rviû_šd
 = 
p_cÚn
->curr_service_ind;

2029 
pIndV®s
->
cu¼_ÿÎh–d_šd
 = 
p_cÚn
->curr_callheld_ind;

2030 if(
pIndV®s
->
cu¼_ÿÎ_šd
 =ğ
BSA_HS_CALL_ACTIVE
 &&

2031 
pIndV®s
->
cu¼_ÿÎ_£tup_šd
 =ğ
BSA_HS_CALLSETUP_INCOMING
)

2033 
pIndV®s
->
cu¼_ÿÎwa™_šd
 = 1;

2038 
	}
}

2040 #ifdeà
PCM_ALSA


2052 
	$­p_hs_İ’_®§_du¶ex
()

2054 
¡©us
;

2057 ià(
®§_hªdË_¶ayback
 !ğ
NULL
)

2059 
	`¢d_pcm_şo£
(
®§_hªdË_¶ayback
);

2060 
®§_hªdË_¶ayback
 = 
NULL
;

2063 
	`APP_DEBUG0
("Opening Alsa/Asound‡udio driver Playback");

2065 
¡©us
 = 
	`¢d_pcm_İ’
(&
®§_hªdË_¶ayback
, 
®§_deviû
,

2066 
SND_PCM_STREAM_PLAYBACK
, 
SND_PCM_NONBLOCK
);

2067 ià(
¡©us
 < 0)

2069 
	`APP_ERROR1
("¢d_pcm_İ’ faed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

2070  
¡©us
;

2075 
¡©us
 = 
	`¢d_pcm_£t_·¿ms
(
®§_hªdË_¶ayback
,

2076 
SND_PCM_FORMAT_S16_LE
,

2077 
SND_PCM_ACCESS_RW_INTERLEAVED
,

2078 
APP_HS_CHANNEL_NB
,

2079 
APP_HS_SAMPLE_RATE
,

2082 ià(
¡©us
 < 0)

2084 
	`APP_ERROR1
("¢d_pcm_£t_·¿m çed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

2085  
¡©us
;

2088 
®§_¶ayback_İ’ed
 = 
TRUE
;

2091 ià(
®§_hªdË_ÿ±u»
 !ğ
NULL
)

2093 
	`¢d_pcm_şo£
(
®§_hªdË_ÿ±u»
);

2094 
®§_hªdË_ÿ±u»
 = 
NULL
;

2096 
	`APP_DEBUG0
("Opening Alsa/Asound‡udio driver Capture");

2098 
¡©us
 = 
	`¢d_pcm_İ’
(&
®§_hªdË_ÿ±u»
, 
®§_deviû
,

2099 
SND_PCM_STREAM_CAPTURE
, 
SND_PCM_NONBLOCK
);

2100 ià(
¡©us
 < 0)

2102 
	`APP_ERROR1
("¢d_pcm_İ’ faed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

2103  
¡©us
;

2108 
¡©us
 = 
	`¢d_pcm_£t_·¿ms
(
®§_hªdË_ÿ±u»
,

2109 
SND_PCM_FORMAT_S16_LE
,

2110 
SND_PCM_ACCESS_RW_INTERLEAVED
,

2111 
APP_HS_CHANNEL_NB
,

2112 
APP_HS_SAMPLE_RATE
,

2115 ià(
¡©us
 < 0)

2117 
	`APP_ERROR1
("¢d_pcm_£t_·¿m çed: %s", 
	`¢d_¡»¼Ü
(
¡©us
));

2118  
¡©us
;

2121 
®§_ÿ±u»_İ’ed
 = 
TRUE
;

2124 
	}
}

2137 
	$­p_hs_şo£_®§_du¶ex
()

2139 ià(
®§_hªdË_¶ayback
 !ğ
NULL
)

2141 
	`¢d_pcm_şo£
(
®§_hªdË_¶ayback
);

2142 
®§_hªdË_¶ayback
 = 
NULL
;

2143 
®§_¶ayback_İ’ed
 = 
FALSE
;

2145 ià(
®§_hªdË_ÿ±u»
 !ğ
NULL
)

2147 
	`¢d_pcm_şo£
(
®§_hªdË_ÿ±u»
);

2148 
®§_hªdË_ÿ±u»
 = 
NULL
;

2149 
®§_ÿ±u»_İ’ed
 = 
FALSE
;

2152 
	}
}

2154 
	$cÚfig_deviû
(
fd
, *
fÜm©
, 
UINT32
 *
chªÃl
, UINT32 *
¥“d
)

2158 ià(
	`ioùl
(
fd
, 
SNDCTL_DSP_SETFMT
, 
fÜm©
) == -1) {

2159 
	`årštf
(
¡d”r
, "S‘ fÜm© faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

2164 ià((
	`ioùl
(
fd
, 
SNDCTL_DSP_CHANNELS
, 
chªÃl
)) == -1) {

2165 
	`årštf
(
¡d”r
, "S‘ chªÃÈçed: %s\n", 
	`¡»¼Ü
(
”ºo
));

2170 ià(
	`ioùl
(
fd
, 
SNDCTL_DSP_SPEED
, 
¥“d
) == -1) {

2171 
	`årštf
(
¡d”r
, "S‘ s³ed faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

2176 
	}
}

2178 *
	$»ad_bt_th»ad_func
(*
_dev
)

2180 
size
 = 0;

2181 #ifdeà
PCM_DEBUG


2182 
FILE
 *
out_fd
=
NULL
;

2183 
out_fd
 = 
	`fİ’
("/data/speak_out.pcm", "wb");

2184 if(
out_fd
==
NULL
){

2185 
	`ALOGE
("out_fd NuÎ, EXITƒ¼no: %d, m—ns: %s", 
”ºo
, 
	`¡»¼Ü
(errno));

2188 *
»ad_buf
 = (*)
	`m®loc
(
AD_NODE_BUFSIZ
);

2189 
»ad_bt_ÿÎ
) {

2190 
size
 = 
	`»ad
(
bt_r_fd
, 
»ad_buf
, 
AD_NODE_BUFSIZ
);

2191 ià(
size
 > 0) {

2192 
»t
 = 
	`šg’ic_audio_oss_wr™e
(
»ad_buf
,
size
);

2193 if(
»t
 <= 0)

2194 
	`APP_ERROR1
("£nd bufã¸d©¨”rÜ: %s\n",
	`¡»¼Ü
(
”ºo
));

2195 #ifdeà
PCM_DEBUG


2196 
	`fwr™e
(
»ad_buf
, 
AD_NODE_BUFSIZ
, 1, 
out_fd
);

2201 
	`ä“
(
»ad_buf
);

2202 #ifdeà
PCM_DEBUG


2203 
	`fşo£
(
out_fd
);

2205 
	`´štf
("===>> Ex™ % \n", 
__func__
);

2206  
NULL
;

2207 
	}
}

2209 *
	$»ad_dmic_th»ad_func
(*
_dev
)

2211 *
»f_buf
 = (*)
	`m®loc
(
AD_NODE_BUFSIZ
);

2212 ià(!
»f_buf
) {

2213 
	`´štf
("Error: malloc„ef_buf failed!!\n");

2214  
NULL
;

2216 
»ad_dmic_ÿÎ
) {

2217 ià(
bt_w_fd
 >= 0){

2218 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


2219 
»t
 = 
	`šg’ic_audio_oss_»ad
(
»f_buf
, 
AD_NODE_BUFSIZ
);

2220 if(
»t
 >= 0){

2221 
	`wr™e
(
bt_w_fd
, 
»f_buf
, 
»t
);

2227 ià(
»f_buf
) {

2228 
	`ä“
(
»f_buf
);

2229 
»f_buf
 = 
NULL
;

2231 
	`´štf
("===>> Ex™ % \n", 
__func__
);

2232  
NULL
;

2233 
	}
}

2235 
	$şo£_d¥
(){

2236 
»t
 = 0;

2239 
»ad_dmic_ÿÎ
 = 
FALSE
;

2240 ià(
bt_w_fd
 >= 0) {

2241 ià(
	`ioùl
(
bt_w_fd
, 
SNDCTL_EXT_STOP_DMA
, &
»t
) < 0)

2242 
	`´štf
("% ioùÈ£ˆSNDCTL_EXT_STOP_DMA faed !\n", 
__func__
);

2243 
	`şo£
(
bt_w_fd
);

2244 
bt_w_fd
 = -1;

2246 ià(
bt_dev
.
»ad_dmic_th»ad
 != 0) {

2247 
	`±h»ad_još
(
bt_dev
.
»ad_dmic_th»ad
, 
NULL
);

2248 
bt_dev
.
»ad_dmic_th»ad
 = 0;

2250 
»ad_bt_ÿÎ
 = 
FALSE
;

2251 ià(
bt_r_fd
 >= 0) {

2252 ià(
	`ioùl
(
bt_r_fd
, 
SNDCTL_EXT_STOP_DMA
, &
»t
) < 0)

2253 
	`´štf
("% ioùÈ£ˆSNDCTL_EXT_STOP_DMA faed !\n", 
__func__
);

2254 
	`şo£
(
bt_r_fd
);

2255 
bt_r_fd
 = -1;

2257 ià(
bt_dev
.
»ad_bt_th»ad
 != 0) {

2258 
	`±h»ad_još
(
bt_dev
.
»ad_bt_th»ad
, 
NULL
);

2259 
bt_dev
.
»ad_bt_th»ad
 = 0;

2261 
	}
}

2262 
	$bt_¡¬t_ÿÎ
()

2264 
»t
 = 0;

2265 
§m¶”©e
 = (
cu¼’t_hs_bcs
==
BSA_SCO_CODEC_MSBC
) ? 16000:8000;

2266 
chªÃl
 = 
APP_HS_CHANNEL_NB
;

2267 
fÜm©
 = 
AFMT_S16_LE
;

2271 
bt_w_fd
 = 
	`İ’
("/dev/d¥1", 
O_WRONLY
);

2272 if(
bt_w_fd
 < 0){

2273 
	`´štf
("open bt_w_fd failed!\n");

2277 
bt_r_fd
 = 
	`İ’
("/dev/d¥1", 
O_RDONLY
);

2278 if(
bt_r_fd
 < 0){

2279 
	`´štf
("open bt_r_fd failed!\n");

2280 
”r_¡¬t
;

2282 ià(
	`cÚfig_deviû
(
bt_w_fd
, &
fÜm©
, &
chªÃl
, &
§m¶”©e
) < 0) {

2283 
	`´štf
("config bt_r_fd failed!\n");

2284 
”r_¡¬t
;

2286 ià(
	`cÚfig_deviû
(
bt_r_fd
, &
fÜm©
, &
chªÃl
, &
§m¶”©e
) < 0) {

2287 
	`´štf
("config bt_r_fd failed!\n");

2288 
”r_¡¬t
;

2291 
»ad_dmic_ÿÎ
 = 
TRUE
;

2292 
»t
 = 
	`±h»ad_ü—‹
(&
bt_dev
.
»ad_dmic_th»ad
, 
NULL
, 
»ad_dmic_th»ad_func
, NULL);

2293 ià(
»t
 != 0) {

2294 
	`´štf
("ü—‹„—d_dmic_th»adƒ¼Ü: %s\n", 
	`¡»¼Ü
(
»t
));

2295 
”r_¡¬t
;

2298 
»ad_bt_ÿÎ
 = 
TRUE
;

2299 
»t
 = 
	`±h»ad_ü—‹
(&
bt_dev
.
»ad_bt_th»ad
, 
NULL
, 
»ad_bt_th»ad_func
, NULL);

2300 ià(
»t
 != 0) {

2301 
	`´štf
("ü—‹„—d_bt_th»adƒ¼Ü: %s\n", 
	`¡»¼Ü
(
»t
));

2302 
”r_¡¬t
;

2306 
”r_¡¬t
:

2307 
	`şo£_d¥
();

2309 
	}
}

2311 
	$bt_’d_ÿÎ
()

2313 
»t
 = 0;

2314 
	`şo£_d¥
();

2315 
	`´štf
("=======>> bt_end_call!\n");

2317 
	}
}

	@source/app_manager.c

11 
	~<¡dio.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<uni¡d.h
>

15 
	~<sys/ty³s.h
>

16 
	~<sys/¡©.h
>

17 
	~<fú.h
>

18 
	~<sys/time.h
>

20 
	~"gki.h
"

21 
	~"uc.h
"

23 
	~"b§_­i.h
"

25 
	~"­p_xml_uts.h
"

27 
	~"­p_disc.h
"

28 
	~"­p_uts.h
"

29 
	~"­p_dm.h
"

32 
	~"­p_£rviûs.h
"

33 
	~"­p_mgt.h
"

35 
	~"­p_mªag”.h
"

36 
	~"­p_lšk.h
"

37 
	~"­p_disc_cback.h
"

40 
	#APP_DEFAULT_BD_ADDR
 {0xBE, 0xEF, 0xBE, 0xEF, 0x00, 0x01}

	)

47 
	#APP_DEFAULT_CLASS_OF_DEVICE
 {0x7a,0x07, 0x04}

48 

	)

49 
	#APP_DEFAULT_ROOT_PATH
 "/u¤/d©a/b§/piùu»s"

	)

51 
	#APP_DEFAULT_PIN_CODE
 "0000"

	)

52 
	#APP_DEFAULT_PIN_LEN
 4

	)

54 
	#APP_XML_CONFIG_FILE_PATH
 "/u¤/d©a/b§/bt_cÚfig.xml"

	)

55 
	#APP_XML_REM_DEVICES_FILE_PATH
 "/u¤/d©a/b§/bt_deviûs.xml"

	)

67 #iâdeà
APP_SEC_IO_CAPABILITIES


68 
	#APP_SEC_IO_CAPABILITIES
 
BSA_SEC_IO_CAP_NONE


	)

72 #iâdeà
APP_SEC_SP_AUTO_ACCEPT


73 
	#APP_SEC_SP_AUTO_ACCEPT
 
TRUE


	)

78 
tAPP_XML_CONFIG
 
	g­p_xml_cÚfig
;

79 
BD_ADDR
 
	g­p_£c_db_addr
;

81 
tAPP_MGR_CB
 
	g­p_mgr_cb
;

83 
tBSA_SEC_SET_REMOTE_OOB
 
	gb§_£c_£t_»mÙe_oob
;

85 
tBSA_SEC_PASSKEY_REPLY
 
	gg_·sskey_»¶y
;

87 
tLINKING_DEVICE
 
	glškšg_dev
[
APP_MAX_NB_REMOTE_STORED_DEVICES
];

91 #ifdeà
__ılu¥lus


95 #ifdeà
BLUETOOTH_HILINK_SUPPORT


96 
£tBËVisib™y
(
discov”abË
, 
cÚÃùabË
);

98 #ifdeà
__ılu¥lus


101 
­p_mgr_cÚfig
(* 
bt_Çme
);

102 *
­p_mgr_g‘_du®_¡ack_mode_desc
();

104 (*
	gmAµDiscCback
)(
	gev’t
, 
tAPP_DISC_MSG
* 
	gp_d©a
èğ
NULL
;

115 
­p_mgr_g‘_bËName
(* 
Çme
)

117 
	g¡©us
;

118 
	g¡©us
 = 
­p_xml_»ad_cfg
(
APP_XML_CONFIG_FILE_PATH
, &
­p_xml_cÚfig
);

119 ià(
	g¡©us
 < 0)

121 
APP_ERROR1
("­p_xml_»ad_cfg faed:%d", 
¡©us
);

126 
¡ºıy
(
Çme
, (*)
­p_xml_cÚfig
.
bË_Çme
, 
¡¾’
(app_xml_config.ble_name));

139 
­p_mgr_g‘_addr
(* 
addr
)

141 
	g¡©us
;

143 
	g¡©us
 = 
­p_xml_»ad_cfg
(
APP_XML_CONFIG_FILE_PATH
, &
­p_xml_cÚfig
);

144 ià(
	g¡©us
 < 0)

146 
APP_ERROR1
("­p_xml_»ad_cfg faed:%d", 
¡©us
);

151 
¥rštf
(
addr
,"%02x:%02x:%02x:%02x:%02x:%02x",

152 
­p_xml_cÚfig
.
bd_addr
[0],‡pp_xml_config.bd_addr[1],

153 
­p_xml_cÚfig
.
bd_addr
[2],‡pp_xml_config.bd_addr[3],

154 
­p_xml_cÚfig
.
bd_addr
[4],‡pp_xml_config.bd_addr[5]);

168 
­p_mgr_»ad_cÚfig
()

170 
	g¡©us
;

172 
	g¡©us
 = 
­p_xml_»ad_cfg
(
APP_XML_CONFIG_FILE_PATH
, &
­p_xml_cÚfig
);

173 ià(
	g¡©us
 < 0)

175 
APP_ERROR1
("­p_xml_»ad_cfg faed:%d", 
¡©us
);

180 
APP_DEBUG1
("EÇbË:%d", 
­p_xml_cÚfig
.
’abË
);

181 
APP_DEBUG1
("Discov”abË:%d", 
­p_xml_cÚfig
.
discov”abË
);

182 
APP_DEBUG1
("CÚÃùabË:%d", 
­p_xml_cÚfig
.
cÚÃùabË
);

183 
APP_DEBUG1
("Name:%s", 
­p_xml_cÚfig
.
Çme
);

184 
APP_DEBUG1
("BLE Name:%s", 
­p_xml_cÚfig
.
bË_Çme
);

185 
APP_DEBUG1
("Bdaddr %02x:%02x:%02x:%02x:%02x:%02x",

186 
­p_xml_cÚfig
.
bd_addr
[0],‡pp_xml_config.bd_addr[1],

187 
­p_xml_cÚfig
.
bd_addr
[2],‡pp_xml_config.bd_addr[3],

188 
­p_xml_cÚfig
.
bd_addr
[4],‡pp_xml_config.bd_addr[5]);

189 
APP_DEBUG1
("CÏssOfDeviû:%02x:%02x:%02x => %s", 
­p_xml_cÚfig
.
şass_of_deviû
[0],

190 
­p_xml_cÚfig
.
şass_of_deviû
[1],‡pp_xml_config.class_of_device[2],

191 
­p_g‘_cod_¡ršg
(
­p_xml_cÚfig
.
şass_of_deviû
));

192 
APP_DEBUG1
("RoÙP©h:%s", 
­p_xml_cÚfig
.
roÙ_·th
);

194 
APP_DEBUG1
("DeçuÉ PIN (%d):%s", 
­p_xml_cÚfig
.
pš_Ën
,‡µ_xml_cÚfig.
pš_code
);

212 
­p_mgr_wr™e_cÚfig
()

214 
	g¡©us
;

216 
	g¡©us
 = 
­p_xml_wr™e_cfg
(
APP_XML_CONFIG_FILE_PATH
, &
­p_xml_cÚfig
);

217 ià(
	g¡©us
 < 0)

219 
APP_ERROR1
("­p_xml_wr™e_cfg faed:%d", 
¡©us
);

224 
APP_DEBUG1
("EÇbË:%d", 
­p_xml_cÚfig
.
’abË
);

225 
APP_DEBUG1
("Discov”abË:%d", 
­p_xml_cÚfig
.
discov”abË
);

226 
APP_DEBUG1
("CÚÃùabË:%d", 
­p_xml_cÚfig
.
cÚÃùabË
);

227 
APP_DEBUG1
("Name:%s", 
­p_xml_cÚfig
.
Çme
);

228 
APP_DEBUG1
("BLE Name:%s", 
­p_xml_cÚfig
.
bË_Çme
);

229 
APP_DEBUG1
("Bdaddr %02x:%02x:%02x:%02x:%02x:%02x",

230 
­p_xml_cÚfig
.
bd_addr
[0],‡pp_xml_config.bd_addr[1],

231 
­p_xml_cÚfig
.
bd_addr
[2],‡pp_xml_config.bd_addr[3],

232 
­p_xml_cÚfig
.
bd_addr
[4],‡pp_xml_config.bd_addr[5]);

233 
APP_DEBUG1
("CÏssOfDeviû:%02x:%02x:%02x", 
­p_xml_cÚfig
.
şass_of_deviû
[0],

234 
­p_xml_cÚfig
.
şass_of_deviû
[1],‡pp_xml_config.class_of_device[2]);

235 
APP_DEBUG1
("RoÙP©h:%s", 
­p_xml_cÚfig
.
roÙ_·th
);

249 
­p_mgr_»ad_»mÙe_deviûs
()

251 
	g¡©us
;

252 
	gšdex
;

254 
	gšdex
 = 0 ; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
) ; index++)

256 
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 = 
FALSE
;

259 
	g¡©us
 = 
­p_xml_»ad_db
(
APP_XML_REM_DEVICES_FILE_PATH
, 
­p_xml_»mÙe_deviûs_db
,

260 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

262 ià(
	g¡©us
 < 0)

264 
APP_ERROR1
("­p_xml_»ad_db faed:%d", 
¡©us
);

270 
­p_mgr_g‘_dev_av_bt_addr
(
BD_ADDR
 
bd_addr
)

272 
	gšdex
;

274 
APP_INFO1
("%s",
__func__
);

275 
	gšdex
 = 0; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

277 if((
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
) &&

278 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
Œu¡ed_£rviûs
 & 
BSA_A2DP_SERVICE_MASK
))

280 
bdıy
(
bd_addr
,
­p_xml_»mÙe_deviûs_db
[
šdex
].bd_addr);

281 
APP_INFO1
("g‘‡‡v dev‚ame:%s,addr:%02x:%02x:%02x:%02x:%02x:%02x",
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
,

282 ()
bd_addr
[0],()bd_addr[1],

283 ()
bd_addr
[2],()bd_addr[3],

284 ()
bd_addr
[4],()bd_addr[5]);

292 
­p_mgr_g‘_bt_£rviûs
(
BD_ADDR
 
bd_addr
, *
bd_ty³
)

294 
	gšdex
;

295 
	gšdex
 = 0; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

297 if((
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
) &&

298 (
bdcmp
(
bd_addr
,
­p_xml_»mÙe_deviûs_db
[
šdex
].bd_addr)==0))

300 
´štf
("£rviû:%x,şass:%02hhx\n",
­p_xml_»mÙe_deviûs_db
[
šdex
].
Œu¡ed_£rviûs
,

301 
­p_xml_»mÙe_deviûs_db
[
šdex
].
şass_of_deviû
[1]);

302 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_BLE_SERVICE_MASK
)

303 *
	gbd_ty³
 = 1;

304 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_SPP_SERVICE_MASK
)

305 *
	gbd_ty³
 = 2;

306 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_A2DP_SERVICE_MASK
)

307 *
	gbd_ty³
 = 3;

308 if((
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gşass_of_deviû
[1] & 0x1Fè=ğ
BTM_COD_MAJOR_AUDIO
)

309 *
bd_ty³
 = 3;

311 *
	gbd_ty³
 = 0;

315 *
	gbd_ty³
 = 0;

319 
­p_mgr_g‘_bt_Çme
(
BD_ADDR
 
bd_addr
, 
BD_NAME
 *
bd_Çme
)

321 
	gšdex
;

322 
	gšdex
 = 0; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

324 if((
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
) &&

325 (
bdcmp
(
bd_addr
,
­p_xml_»mÙe_deviûs_db
[
šdex
].bd_addr)==0))

327 
¡rıy
(
bd_Çme
,
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
);

343 
­p_mgr_wr™e_»mÙe_deviûs
()

345 
	g¡©us
;

347 
	g¡©us
 = 
­p_xml_wr™e_db
(
APP_XML_REM_DEVICES_FILE_PATH
, 
­p_xml_»mÙe_deviûs_db
,

348 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

350 ià(
	g¡©us
 < 0)

352 
APP_ERROR1
("­p_xml_wr™e_db faed:%d", 
¡©us
);

357 
APP_DEBUG0
("app_xml_write_db ok");

374 
­p_mgr_£t_bt_cÚfig
(
BOOLEAN
 
’abË
)

376 
	g¡©us
;

377 
tBSA_DM_SET_CONFIG
 
	gbt_cÚfig
;

380 
	g¡©us
 = 
BSA_DmS‘CÚfigIn™
(&
bt_cÚfig
);

385 
	gbt_cÚfig
.
	g’abË
 = 
’abË
;

386 
	gbt_cÚfig
.
	gdiscov”abË
 = 
­p_xml_cÚfig
.
discov”abË
;

387 
	gbt_cÚfig
.
	gcÚÃùabË
 = 
­p_xml_cÚfig
.
cÚÃùabË
;

388 
bdıy
(
bt_cÚfig
.
bd_addr
, 
­p_xml_cÚfig
.bd_addr);

389 
¡ºıy
((*)
bt_cÚfig
.
Çme
, (*)
­p_xml_cÚfig
.name, (bt_config.name));

390 
¡ºıy
((*)
bt_cÚfig
.
bË_Çme
, (*)
­p_xml_cÚfig
.ble_name, (bt_config.ble_name));

391 
	gbt_cÚfig
.
	gÇme
[(
bt_cÚfig
.
Çme
) - 1] = '\0';

392 
memıy
(
bt_cÚfig
.
şass_of_deviû
, 
­p_xml_cÚfig
.şass_of_deviû, (
DEV_CLASS
));

393 
	gbt_cÚfig
.
	gcÚfig_mask
 |ğ
BSA_DM_CONFIG_NAME_MASK
;

394 #ifdeà
USE_CHIP_BT_ADDR


395 
	gbt_cÚfig
.
	gcÚfig_mask
 &ğ~(
BSA_DM_CONFIG_BDADDR_MASK
);

397 
APP_DEBUG1
("EÇbË:%d", 
bt_cÚfig
.
’abË
);

398 
APP_DEBUG1
("Discov”abË:%d", 
bt_cÚfig
.
discov”abË
);

399 
APP_DEBUG1
("CÚÃùabË:%d,mask:%08x", 
bt_cÚfig
.
cÚÃùabË
,bt_cÚfig.
cÚfig_mask
);

400 
APP_DEBUG1
("Name:%s", 
bt_cÚfig
.
Çme
);

401 
APP_DEBUG1
("BLE Name:%s", 
bt_cÚfig
.
bË_Çme
);

402 
APP_DEBUG1
("Bdaddr %02x:%02x:%02x:%02x:%02x:%02x",

403 
bt_cÚfig
.
bd_addr
[0], bt_config.bd_addr[1],

404 
bt_cÚfig
.
bd_addr
[2], bt_config.bd_addr[3],

405 
bt_cÚfig
.
bd_addr
[4], bt_config.bd_addr[5]);

406 
APP_DEBUG1
("CÏssOfDeviû:%02x:%02x:%02x", 
bt_cÚfig
.
şass_of_deviû
[0],

407 
bt_cÚfig
.
şass_of_deviû
[1], bt_config.class_of_device[2]);

408 
APP_DEBUG1
("Fœ¡ ho¡ di§bËd chªÃl:%d", 
bt_cÚfig
.
fœ¡_di§bËd_chªÃl
);

409 
APP_DEBUG1
("La¡ ho¡ di§bËd chªÃl:%d", 
bt_cÚfig
.
Ï¡_di§bËd_chªÃl
);

412 
	g¡©us
 = 
BSA_DmS‘CÚfig
(&
bt_cÚfig
);

413 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

415 
APP_ERROR1
("BSA_DmS‘CÚfig faed:%d", 
¡©us
);

418 #ifdeà
BLUETOOTH_HILINK_SUPPORT


436 
­p_mgr_g‘_bt_cÚfig
()

438 
	g¡©us
;

439 
tBSA_DM_GET_CONFIG
 
	gbt_cÚfig
;

444 
	g¡©us
 = 
BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

445 
	g¡©us
 = 
BSA_DmG‘CÚfig
(&
bt_cÚfig
);

446 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

448 
APP_ERROR1
("BSA_DmG‘CÚfig faed:%d", 
¡©us
);

451 
APP_DEBUG1
("EÇbË:%d", 
bt_cÚfig
.
’abË
);

452 
APP_DEBUG1
("Discov”abË:%d", 
bt_cÚfig
.
discov”abË
);

453 
APP_DEBUG1
("CÚÃùabË:%d", 
bt_cÚfig
.
cÚÃùabË
);

454 
APP_DEBUG1
("Name:%s", 
bt_cÚfig
.
Çme
);

455 
APP_DEBUG1
("Name:%s", 
bt_cÚfig
.
bË_Çme
);

456 
APP_DEBUG1
("Bdaddr %02x:%02x:%02x:%02x:%02x:%02x",

457 
bt_cÚfig
.
bd_addr
[0], bt_config.bd_addr[1],

458 
bt_cÚfig
.
bd_addr
[2], bt_config.bd_addr[3],

459 
bt_cÚfig
.
bd_addr
[4], bt_config.bd_addr[5]);

460 
APP_DEBUG1
("CÏssOfDeviû:%02x:%02x:%02x", 
bt_cÚfig
.
şass_of_deviû
[0],

461 
bt_cÚfig
.
şass_of_deviû
[1], bt_config.class_of_device[2]);

462 
APP_DEBUG1
("Fœ¡ ho¡ di§bËd chªÃl:%d", 
bt_cÚfig
.
fœ¡_di§bËd_chªÃl
);

463 
APP_DEBUG1
("La¡ ho¡ di§bËd chªÃl:%d", 
bt_cÚfig
.
Ï¡_di§bËd_chªÃl
);

480 
­p_mgr_»ad_oob_d©a
()

482 
tBSA_SEC_READ_OOB
 
	gb§_£c_»ad_oob
;

483 ià(
BSA_SecR—dOOBIn™
(&
b§_£c_»ad_oob
è!ğ
BSA_SUCCESS
)

485 
APP_ERROR0
("BSA_SecReadOOBInit failed");

489 ià(
BSA_SecR—dOOB
(&
b§_£c_»ad_oob
è!ğ
BSA_SUCCESS
)

491 
APP_ERROR0
("BSA_SecReadOOB failed");

509 
­p_mgr_loÿl_oob_evt_d©a
(
tBSA_SEC_LOCAL_OOB_MSG
* 
p_d©a
)

511 
	gszt
[128];

512 
BT_OCTET16
 
	gp_c
;

513 
BT_OCTET16
 
	gp_r
;

514 
memıy
(
p_c
, 
p_d©a
->
c
, 16);

515 
memıy
(
p_r
, 
p_d©a
->
r
, 16);

517 
mem£t
(
szt
,0, (szt));

518 
¥rštf
(
szt
,"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x",

519 
p_c
[0],p_c[1],p_c[2],p_c[3],p_c[4],p_c[5],p_c[6],p_c[7],

520 
p_c
[8],p_c[9],p_c[10],p_c[11],p_c[12],p_c[13],p_c[14],p_c[15]);

521 
APP_DEBUG1
("­p_mgr_loÿl_oob_evt_d©a: C Hash: %s", 
szt
);

523 
mem£t
(
szt
,0, (szt));

524 
¥rštf
(
szt
,"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x",

525 
p_r
[0],p_r[1],p_r[2],p_r[3],p_r[4],p_r[5],p_r[6],p_r[7],

526 
p_r
[8],p_r[9],p_r[10],p_r[11],p_r[12],p_r[13],p_r[14],p_r[15]);

527 
APP_DEBUG1
("­p_mgr_loÿl_oob_evt_d©a: R Rªdomiz”: %s", 
szt
);

529 
APP_DEBUG1
("­p_mgr_loÿl_oob_evt_d©a: OOB V®id: %d", 
p_d©a
->
v®id
);

545 
­p_mgr_£t_»mÙe_oob
()

547 
	gu¬r
[16];

548 
	gszIÅut
[64];

549 
	gi
;

551 ià(
BSA_SecS‘RemÙeOOBIn™
(&
b§_£c_£t_»mÙe_oob
è!ğ
BSA_SUCCESS
)

553 
APP_ERROR0
("app_mgr_set_remote_oob failed");

557 
APP_INFO0
("Enter BDA of Peer device: AABBCCDDEEFF");

558 
mem£t
(
szIÅut
, 0, (szInput));

559 
­p_g‘_¡ršg
("EÁ” BDA: ", 
szIÅut
, (szInput));

560 
ssÿnf
 (
szIÅut
, "%02x%02x%02x%02x%02x%02x",

561 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5]);

563 
	gi
=0; i < 6; i++)

564 
	gb§_£c_£t_»mÙe_oob
.
	gbd_addr
[
i
] = (
UINT8
è
u¬r
[i];

566 
	gb§_£c_£t_»mÙe_oob
.
	g»suÉ
 = 
TRUE
;

568 
APP_INFO0
("Enter 16 byte C Hash inhis format: FA87C0D0AFAC11DE8A390800200C9A66");

569 
mem£t
(
szIÅut
, 0, (szInput));

570 
­p_g‘_¡ršg
("C Hash: ", 
szIÅut
, (szInput));

571 
ssÿnf
 (
szIÅut
, "%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x",

572 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

573 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

575 
	gi
=0; i < 16; i++)

576 
	gb§_£c_£t_»mÙe_oob
.
	gp_c
[
i
] = (
UINT8
è
u¬r
[i];

578 
APP_INFO0
("Enter 16 byte R Randomizer inhis format: FA87C0D0AFAC11DE8A390800200C9A66");

579 
mem£t
(
szIÅut
, 0, (szInput));

580 
­p_g‘_¡ršg
("R Rªdomiz”: ", 
szIÅut
, (szInput));

581 
ssÿnf
 (
szIÅut
, "%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x",

582 &
u¬r
[0], &uarr[1], &uarr[2], &uarr[3], &uarr[4], &uarr[5], &uarr[6], &uarr[7], &uarr[8],

583 &
u¬r
[9], &uarr[10], &uarr[11], &uarr[12], &uarr[13], &uarr[14], &uarr[15]);

585 
	gi
=0; i < 16; i++)

586 
	gb§_£c_£t_»mÙe_oob
.
	gp_r
[
i
] = (
UINT8
è
u¬r
[i];

588 ià(
BSA_SecS‘RemÙeOOB
(&
b§_£c_£t_»mÙe_oob
è!ğ
BSA_SUCCESS
)

590 
APP_ERROR0
("BSA_SecSetRemoteOOB failed");

595 
tBSA_SEC_PIN_CODE_REPLY
 
	gg_pš_code_»¶y
;

596 
	~"Blu‘oÙhUts.h
"

608 
tBSA_SEC_LINK_UP
 
	gbklškup_dev
;

609 
­p_mgr_£cur™y_ÿÎback
(
tBSA_SEC_EVT
 
ev’t
, 
tBSA_SEC_MSG
 *
p_d©a
)

611 
	g¡©us
;

612 
	gšdexDisc
;

613 
tBSA_SEC_PIN_CODE_REPLY
 
	gpš_code_»¶y
;

614 
tBSA_SEC_AUTH_REPLY
 
	gautÜize_»¶y
;

616 
APP_DEBUG1
("ev’t:%d", 
ev’t
);

618 
	gev’t
)

620 
	gBSA_SEC_LINK_UP_EVT
:

621 
memıy
(&
bklškup_dev
, &
p_d©a
->
lšk_up
, (
tBSA_SEC_LINK_UP
));

622 
APP_DEBUG1
("BSA_SEC_LINK_UP_EVT bd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

623 
p_d©a
->
lšk_up
.
bd_addr
[0],…_data->link_up.bd_addr[1],

624 
p_d©a
->
lšk_up
.
bd_addr
[2],…_data->link_up.bd_addr[3],

625 
p_d©a
->
lšk_up
.
bd_addr
[4],…_data->link_up.bd_addr[5]);

626 
APP_DEBUG1
("ClassOfDevice:%02x:%02x:%02x => %s",

627 
p_d©a
->
lšk_up
.
şass_of_deviû
[0],

628 
p_d©a
->
lšk_up
.
şass_of_deviû
[1],

629 
p_d©a
->
lšk_up
.
şass_of_deviû
[2],

630 
­p_g‘_cod_¡ršg
(
p_d©a
->
lšk_up
.
şass_of_deviû
));

631 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

632 
APP_DEBUG1
("LškTy³:%s", 
­p_lšk_Œª¥Üt_ty³_desc
(
p_d©a
->
lšk_up
.
lšk_ty³
));

633 
APP_DEBUG1
("BLE_addr_ty³:%d", 
p_d©a
->
lšk_up
.
bË_addr_ty³
);

635 
	gšdexDisc
 = 0; indexDisø< 
	gAPP_MAX_NB_REMOTE_STORED_DEVICES
; indexDisc++)

637 if(
	glškšg_dev
[
šdexDisc
].
	gš_u£
 =ğ
FALSE
)

639 
mem£t
(&
lškšg_dev
[
šdexDisc
], 0, (
tLINKING_DEVICE
));

640 
	glškšg_dev
[
šdexDisc
].
	gš_u£
 = 
TRUE
;

641 
memıy
(
lškšg_dev
[
šdexDisc
].
bd_addr
, 
p_d©a
->
lšk_up
.bd_addr, (
BD_ADDR
));

642 if((
	gp_d©a
->
	glšk_up
.
	gşass_of_deviû
[1] & 0x1fè=ğ
BTM_COD_MAJOR_AUDIO
) {

643 
lškšg_dev
[
šdexDisc
].
bd_ty³
 = 
BD_TYPE_A2DP
;

647 
­p_mgr_g‘_bt_£rviûs
(
lškšg_dev
[
šdexDisc
].
bd_addr
,&lškšg_dev[šdexDisc].
bd_ty³
);

648 
APP_DEBUG1
("g‘y³:%d", 
lškšg_dev
[
šdexDisc
].
bd_ty³
);

650 
­p_mgr_g‘_bt_Çme
(
lškšg_dev
[
šdexDisc
].
bd_addr
,lškšg_dev[šdexDisc].
bd_Çme
);

654 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

655 #ifdeà
BLUETOOTH_HILINK_SUPPORT


656 ià(!
­p_xml_upd©e_bË_addr_ty³_db
(
­p_xml_»mÙe_deviûs_db
,

657 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
p_d©a
->
lšk_up
.
bd_addr
,…_d©a->lšk_up.
bË_addr_ty³
))

658 
­p_wr™e_xml_»mÙe_deviûs
();

660 if(
	gp_d©a
->
	glšk_up
.
	gbË_addr_ty³
) {

661 if((
	gp_d©a
->
	glšk_up
.
	gşass_of_deviû
[1] & 0x1fè!ğ
BTM_COD_MAJOR_AUDIO
) {

662 
APP_DEBUG0
("send secBondInit");

663 
tBSA_SEC_BOND
 
	g£c_bÚd
;

664 
BSA_SecBÚdIn™
(&
£c_bÚd
);

665 
bdıy
(
£c_bÚd
.
bd_addr
, 
p_d©a
->
lšk_up
.bd_addr);

666 
	g¡©us
 = 
BSA_SecBÚd
(&
£c_bÚd
);

667 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

669 
APP_ERROR1
("BSA_SecBÚd faed:%d", 
¡©us
);

677 
	gBSA_SEC_LINK_DOWN_EVT
:

678 
APP_DEBUG1
("BSA_SEC_LINK_DOWN_EVT bd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

679 
p_d©a
->
lšk_down
.
bd_addr
[0],…_data->link_down.bd_addr[1],

680 
p_d©a
->
lšk_down
.
bd_addr
[2],…_data->link_down.bd_addr[3],

681 
p_d©a
->
lšk_down
.
bd_addr
[4],…_data->link_down.bd_addr[5]);

682 
APP_DEBUG1
("R—sÚ: 0x%x (%d)", 
p_d©a
->
lšk_down
.
¡©us
,…_data->link_down.status);

683 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

684 
APP_DEBUG1
("LškTy³:%s,%d:%d", 
­p_lšk_Œª¥Üt_ty³_desc
(
p_d©a
->
lšk_down
.
lšk_ty³
),…_data->link_down.link_type);

685 ià(
	gp_d©a
->
	gsig_¡»ngth
.
	glšk_ty³
 =ğ
BT_TRANSPORT_LE
){

690 
šdexDisc
 = 0; 
	gšdexDisc
 < 
	gAPP_MAX_NB_REMOTE_STORED_DEVICES
; indexDisc++)

692 if(
	glškšg_dev
[
šdexDisc
].
	gš_u£
 =ğ
TRUE
 )

694 if(
memcmp
(
p_d©a
->
lšk_down
.
bd_addr
, 
lškšg_dev
[
šdexDisc
].bd_addr, (
BD_ADDR
)) == 0)

696 
lškšg_dev
[
šdexDisc
].
š_u£
 = 
FALSE
;

697 if(
	glškšg_dev
[
šdexDisc
].
	gbd_ty³
 = 3){

698 
­p_av_lškdn_nÙify
();

707 
	gBSA_SEC_PIN_REQ_EVT
:

708 
APP_DEBUG1
("BSA_SEC_PIN_REQ_EVT (Pin Code Request)„eceived from: %02x:%02x:%02x:%02x:%02x:%02x",

709 
p_d©a
->
pš_»q
.
bd_addr
[0],…_data->pin_req.bd_addr[1],

710 
p_d©a
->
pš_»q
.
bd_addr
[2],…_data->pin_req.bd_addr[3],

711 
p_d©a
->
pš_»q
.
bd_addr
[4],p_data->pin_req.bd_addr[5]);

713 
APP_DEBUG1
("call BSA_SecPinCodeReply…in:%s†en:%d",

714 
­p_xml_cÚfig
.
pš_code
,‡µ_xml_cÚfig.
pš_Ën
);

716 
BSA_SecPšCodeR•lyIn™
(&
pš_code_»¶y
);

717 
bdıy
(
pš_code_»¶y
.
bd_addr
, 
p_d©a
->
pš_»q
.bd_addr);

718 
	gpš_code_»¶y
.
	gpš_Ën
 = 
­p_xml_cÚfig
.
pš_Ën
;

719 
¡ºıy
((*)
pš_code_»¶y
.
pš_code
, (*)
­p_xml_cÚfig
.pin_code,

720 
­p_xml_cÚfig
.
pš_Ën
);

722 
	gpš_code_»¶y
.
	gpš_code
[
PIN_CODE_LEN
-1] = '\0';

723 
	g¡©us
 = 
BSA_SecPšCodeR•ly
(&
pš_code_»¶y
);

726 
	gBSA_SEC_AUTH_CMPL_EVT
:

727 
APP_DEBUG1
("BSA_SEC_AUTH_CMPL_EVT (name=%s,success=%d)",

728 
p_d©a
->
auth_cm¶
.
bd_Çme
,…_d©a->auth_cm¶.
sucûss
);

729 ià(!
	gp_d©a
->
	gauth_cm¶
.
	gsucûss
)

731 
APP_DEBUG1
(" fa_»asÚ=%d", 
p_d©a
->
auth_cm¶
.
ç_»asÚ
);

733 
APP_DEBUG1
(" bd_addr:%02x:%02x:%02x:%02x:%02x:%02x",

734 
p_d©a
->
auth_cm¶
.
bd_addr
[0],…_data->auth_cmpl.bd_addr[1],…_data->auth_cmpl.bd_addr[2],

735 
p_d©a
->
auth_cm¶
.
bd_addr
[3],…_data->auth_cmpl.bd_addr[4],…_data->auth_cmpl.bd_addr[5]);

736 ià(
	gp_d©a
->
	gauth_cm¶
.
	gkey_´e£Á
 !ğ
FALSE
)

738 
APP_DEBUG1
(" LinkKey:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x",

739 
p_d©a
->
auth_cm¶
.
key
[0],…_data->auth_cmpl.key[1],…_data->auth_cmpl.key[2],…_data->auth_cmpl.key[3],

740 
p_d©a
->
auth_cm¶
.
key
[4],…_data->auth_cmpl.key[5],…_data->auth_cmpl.key[6],…_data->auth_cmpl.key[7],

741 
p_d©a
->
auth_cm¶
.
key
[8],…_data->auth_cmpl.key[9],…_data->auth_cmpl.key[10],…_data->auth_cmpl.key[11],

742 
p_d©a
->
auth_cm¶
.
key
[12],…_data->auth_cmpl.key[13],…_data->auth_cmpl.key[14],…_data->auth_cmpl.key[15]);

746 ià(
	gp_d©a
->
	gauth_cm¶
.
	gsucûss
 != 0)

749 
­p_mgr_»ad_»mÙe_deviûs
();

751 
­p_xml_upd©e_Çme_db
(
­p_xml_»mÙe_deviûs_db
,

752 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

753 
p_d©a
->
auth_cm¶
.
bd_addr
,

754 
p_d©a
->
auth_cm¶
.
bd_Çme
);

756 ià(
	gp_d©a
->
	gauth_cm¶
.
	gkey_´e£Á
 !ğ
FALSE
)

758 
­p_xml_upd©e_key_db
(
­p_xml_»mÙe_deviûs_db
,

759 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

760 
p_d©a
->
auth_cm¶
.
bd_addr
,

761 
p_d©a
->
auth_cm¶
.
key
,

762 
p_d©a
->
auth_cm¶
.
key_ty³
);

766 
	gšdexDisc
 = 0 ; indexDisø< 
	gAPP_DISC_NB_DEVICES
 ; indexDisc++)

768 ià((
	g­p_discov”y_cb
.
	gdevs
[
šdexDisc
].
	gš_u£
 !ğ
FALSE
) &&

769 (
bdcmp
(
­p_discov”y_cb
.
devs
[
šdexDisc
].
deviû
.
bd_addr
, 
p_d©a
->
auth_cm¶
.bd_addr) == 0))

772 
­p_xml_upd©e_cod_db
(
­p_xml_»mÙe_deviûs_db
,

773 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

774 
p_d©a
->
auth_cm¶
.
bd_addr
,

775 
­p_discov”y_cb
.
devs
[
šdexDisc
].
deviû
.
şass_of_deviû
);

779 
­p_xml_upd©e_cod_db
(
­p_xml_»mÙe_deviûs_db
,

780 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

781 
bklškup_dev
.
bd_addr
,

782 
bklškup_dev
.
şass_of_deviû
);

783 
	g¡©us
 = 
­p_mgr_wr™e_»mÙe_deviûs
();

784 ià(
	g¡©us
 < 0)

786 
APP_ERROR1
("­p_mgr_wr™e_»mÙe_deviû çed:%d", 
¡©us
);

789 #ifdeà
BSA_PEER_IOS


791 
­p_disc_¡¬t_dev_šfo
(
p_d©a
->
auth_cm¶
.
bd_addr
, 
NULL
);

796 
	gBSA_SEC_BOND_CANCEL_CMPL_EVT
:

797 
APP_DEBUG1
("BSA_SEC_BOND_CANCEL_CMPL_EVT status=%d",

798 
p_d©a
->
bÚd_ÿnûl
.
¡©us
);

801 
	gBSA_SEC_AUTHORIZE_EVT
:

802 
APP_DEBUG0
("BSA_SEC_AUTHORIZE_EVT");

803 
APP_DEBUG1
("\tRemÙdeviû:%s", 
p_d©a
->
authÜize
.
bd_Çme
);

804 
APP_DEBUG1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

805 
p_d©a
->
authÜize
.
bd_addr
[0],…_data->authorize.bd_addr[1],

806 
p_d©a
->
authÜize
.
bd_addr
[2],…_data->authorize.bd_addr[3],

807 
p_d©a
->
authÜize
.
bd_addr
[4],p_data->authorize.bd_addr[5]);

808 
APP_DEBUG1
("\tRequest‡ccesso service:%x (%s)",

809 ()
p_d©a
->
authÜize
.
£rviû
,

810 
­p_£rviû_id_to_¡ršg
(
p_d©a
->
authÜize
.
£rviû
));

811 
APP_DEBUG0
("\tAccess Granted (permanently)");

812 
	g¡©us
 = 
BSA_SecAuthÜizeR•lyIn™
(&
autÜize_»¶y
);

813 
bdıy
(
autÜize_»¶y
.
bd_addr
, 
p_d©a
->
authÜize
.bd_addr);

814 
	gautÜize_»¶y
.
	gŒu¡ed_£rviû
 = 
p_d©a
->
authÜize
.
£rviû
;

815 
	gautÜize_»¶y
.
	gauth
 = 
BSA_SEC_AUTH_PERM
;

816 
	g¡©us
 = 
BSA_SecAuthÜizeR•ly
(&
autÜize_»¶y
);

821 
­p_mgr_»ad_»mÙe_deviûs
();

823 
­p_xml_add_Œu¡ed_£rviûs_db
(
­p_xml_»mÙe_deviûs_db
,

824 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
p_d©a
->
authÜize
.
bd_addr
,

825 1 << 
p_d©a
->
authÜize
.
£rviû
);

827 ià(
¡¾’
((*)
p_d©a
->
authÜize
.
bd_Çme
) > 0)

828 
­p_xml_upd©e_Çme_db
(
­p_xml_»mÙe_deviûs_db
,

829 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

830 
p_d©a
->
authÜize
.
bd_addr
,…_d©a->authÜize.
bd_Çme
);

833 
	g¡©us
 = 
­p_mgr_wr™e_»mÙe_deviûs
();

834 ià(
	g¡©us
 < 0)

836 
APP_ERROR1
("­p_mgr_wr™e_»mÙe_deviû çed:%d", 
¡©us
);

840 
	gBSA_SEC_SP_CFM_REQ_EVT
:

841 
APP_DEBUG0
("BSA_SEC_SP_CFM_REQ_EVT");

842 
APP_DEBUG1
("\tRemÙdeviû:%s", 
p_d©a
->
cfm_»q
.
bd_Çme
);

843 
APP_DEBUG1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

844 
p_d©a
->
cfm_»q
.
bd_addr
[0],…_data->cfm_req.bd_addr[1],

845 
p_d©a
->
cfm_»q
.
bd_addr
[2],…_data->cfm_req.bd_addr[3],

846 
p_d©a
->
cfm_»q
.
bd_addr
[4],…_data->cfm_req.bd_addr[5]);

847 
APP_DEBUG1
("\tClassOfDevice:%02x:%02x:%02x => %s",

848 
p_d©a
->
cfm_»q
.
şass_of_deviû
[0],…_data->cfm_req.class_of_device[1],…_data->cfm_req.class_of_device[2],

849 
­p_g‘_cod_¡ršg
(
p_d©a
->
cfm_»q
.
şass_of_deviû
));

850 
APP_DEBUG1
("\tJu¡ WÜk:%s", 
p_d©a
->
cfm_»q
.
ju¡_wÜks
 =ğ
TRUE
 ? "TRUE" : "FALSE");

851 
APP_DEBUG1
("\tNum”iøV®ue:%d", 
p_d©a
->
cfm_»q
.
num_v®
);

852 
bdıy
(
­p_£c_db_addr
, 
p_d©a
->
cfm_»q
.
bd_addr
);

853 #ià
defšed
(
APP_SEC_SP_AUTO_ACCEPT
è&& ( APP_SEC_SP_AUTO_ACCEPT =ğ
TRUE
)

854 
APP_DEBUG0
("\tSimple Pairing‡utomatically Accepted");

855 
­p_mgr_¥_cfm_»¶y
(
TRUE
, 
p_d©a
->
cfm_»q
.
bd_addr
);

857 
APP_DEBUG0
("\tYou must‡ccept or„efuse using menu!!");

861 
	gBSA_SEC_SP_KEY_NOTIF_EVT
:

862 
APP_DEBUG0
("BSA_SEC_SP_KEY_NOTIF_EVT");

863 
APP_DEBUG1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

864 
p_d©a
->
key_nÙif
.
bd_addr
[0],…_data->key_notif.bd_addr[1],

865 
p_d©a
->
key_nÙif
.
bd_addr
[2],…_data->key_notif.bd_addr[3],

866 
p_d©a
->
key_nÙif
.
bd_addr
[4],…_data->key_notif.bd_addr[5]);

867 
APP_DEBUG1
("\tClassOfDevice:%02x:%02x:%02x => %s",

868 
p_d©a
->
key_nÙif
.
şass_of_deviû
[0],

869 
p_d©a
->
key_nÙif
.
şass_of_deviû
[1],

870 
p_d©a
->
key_nÙif
.
şass_of_deviû
[2],

871 
­p_g‘_cod_¡ršg
(
p_d©a
->
key_nÙif
.
şass_of_deviû
));

872 
APP_DEBUG1
("\tNum”iøV®ue:%d", 
p_d©a
->
key_nÙif
.
·sskey
);

873 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

874 
APP_DEBUG1
("\tLškTy³:%s", 
­p_lšk_Œª¥Üt_ty³_desc
(
p_d©a
->
key_nÙif
.
lšk_ty³
));

876 
APP_DEBUG0
("\tYou mustƒnterhis value on…eer device's keyboard");

879 
	gBSA_SEC_SP_KEY_REQ_EVT
:

880 
APP_DEBUG0
("BSA_SEC_SP_KEY_REQ_EVT");

881 
APP_DEBUG1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

882 
p_d©a
->
key_nÙif
.
bd_addr
[0],…_data->key_notif.bd_addr[1],

883 
p_d©a
->
key_nÙif
.
bd_addr
[2],…_data->key_notif.bd_addr[3],

884 
p_d©a
->
key_nÙif
.
bd_addr
[4],…_data->key_notif.bd_addr[5]);

885 
APP_DEBUG1
("\tClassOfDevice:%02x:%02x:%02x => %s",

886 
p_d©a
->
key_nÙif
.
şass_of_deviû
[0],…_data->key_notif.class_of_device[1],

887 
p_d©a
->
key_nÙif
.
şass_of_deviû
[2],

888 
­p_g‘_cod_¡ršg
(
p_d©a
->
key_nÙif
.
şass_of_deviû
));

889 
APP_DEBUG1
("\tNum”iøV®ue:%d", 
p_d©a
->
key_nÙif
.
·sskey
);

890 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

891 
APP_DEBUG1
("\tLškTy³: %d", 
p_d©a
->
key_nÙif
.
lšk_ty³
);

893 
APP_DEBUG0
("\tYou mustƒnterhis value on…eer device's keyboard");

895 
mem£t
(&
g_·sskey_»¶y
, 0, (g_passkey_reply));

896 
bdıy
(
g_·sskey_»¶y
.
bd_addr
, 
p_d©a
->
pš_»q
.bd_addr);

899 
	gBSA_SEC_SP_KEYPRESS_EVT
:

900 
APP_DEBUG1
("BSA_SEC_SP_KEYPRESS_EVT (ty³:%d)", 
p_d©a
->
key_´ess
.
nÙif_ty³
);

901 
APP_DEBUG1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

902 
p_d©a
->
key_´ess
.
bd_addr
[0],…_data->key_press.bd_addr[1],

903 
p_d©a
->
key_´ess
.
bd_addr
[2],…_data->key_press.bd_addr[3],

904 
p_d©a
->
key_´ess
.
bd_addr
[4],…_data->key_press.bd_addr[5]);

907 
	gBSA_SEC_SP_RMT_OOB_EVT
:

908 
APP_DEBUG0
("BSA_SEC_SP_RMT_OOB_EVT„eceived - Handled internally if Peer OOB‡lready set");

911 
	gBSA_SEC_LOCAL_OOB_DATA_EVT
:

912 
APP_DEBUG0
("BSA_SEC_LOCAL_OOB_DATA_EVT„eceived");

913 
­p_mgr_loÿl_oob_evt_d©a
(&
p_d©a
->
loÿl_oob
);

916 
	gBSA_SEC_SUSPENDED_EVT
:

917 
APP_INFO1
("BSA_SEC_SUSPENDED_EVT bd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

918 
p_d©a
->
su¥’ded
.
bd_addr
[0],…_data->suspended.bd_addr[1],

919 
p_d©a
->
su¥’ded
.
bd_addr
[2],…_data->suspended.bd_addr[3],

920 
p_d©a
->
su¥’ded
.
bd_addr
[4],…_data->suspended.bd_addr[5]);

923 
	gBSA_SEC_RESUMED_EVT
:

924 
APP_INFO1
("BSA_SEC_RESUMED_EVT bd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

925 
p_d©a
->
»sumed
.
bd_addr
[0],…_data->resumed.bd_addr[1],

926 
p_d©a
->
»sumed
.
bd_addr
[2],…_data->resumed.bd_addr[3],

927 
p_d©a
->
»sumed
.
bd_addr
[4],…_data->resumed.bd_addr[5]);

930 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

931 
	gBSA_SEC_BLE_KEY_EVT
:

932 
APP_INFO0
("BSA_SEC_BLE_KEY_EVT");

933 
	gp_d©a
->
	gbË_key
.
	gkey_ty³
)

935 
	gBSA_LE_KEY_PENC
:

936 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_PENC(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

937 
APP_DUMP
("LTK", 
p_d©a
->
bË_key
.
key_v®ue
.
³nc_key
.
Ék
, 16);

938 
APP_DUMP
("RAND", 
p_d©a
->
bË_key
.
key_v®ue
.
³nc_key
.
¿nd
, 8);

939 
APP_DEBUG1
("ediv: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
³nc_key
.
ediv
);

940 
APP_DEBUG1
("£c_Ëv–: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
³nc_key
.
£c_Ëv–
);

941 
APP_DEBUG1
("key_size: %d:", 
p_d©a
->
bË_key
.
key_v®ue
.
³nc_key
.
key_size
);

943 
	gBSA_LE_KEY_PID
:

944 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_PID(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

945 
APP_DUMP
("IRK", 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
œk
, 16);

946 
APP_DEBUG1
("addr_ty³: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
addr_ty³
);

947 
APP_DEBUG1
("static_addr: %02X-%02X-%02X-%02X-%02X-%02X",

948 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[0],

949 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[1],

950 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[2],

951 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[3],

952 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[4],

953 
p_d©a
->
bË_key
.
key_v®ue
.
pid_key
.
¡©ic_addr
[5]);

955 
	gBSA_LE_KEY_PCSRK
:

956 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_PCSRK(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

957 
APP_DEBUG1
("couÁ”: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
pc¤k_key
.
couÁ”
);

958 
APP_DUMP
("CSRK", 
p_d©a
->
bË_key
.
key_v®ue
.
pc¤k_key
.
c¤k
, 16);

959 
APP_DEBUG1
("£c_Ëv–: %d:", 
p_d©a
->
bË_key
.
key_v®ue
.
pc¤k_key
.
£c_Ëv–
);

961 
	gBSA_LE_KEY_LCSRK
:

962 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_LCSRK(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

963 
APP_DEBUG1
("couÁ”: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
lc¤k_key
.
couÁ”
);

964 
APP_DEBUG1
("div: %d:", 
p_d©a
->
bË_key
.
key_v®ue
.
lc¤k_key
.
div
);

965 
APP_DEBUG1
("£c_Ëv–: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
lc¤k_key
.
£c_Ëv–
);

967 
	gBSA_LE_KEY_LENC
:

968 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_LENC(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

969 
APP_DEBUG1
("div: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
Ënc_key
.
div
);

970 
APP_DEBUG1
("key_size: %d:", 
p_d©a
->
bË_key
.
key_v®ue
.
Ënc_key
.
key_size
);

971 
APP_DEBUG1
("£c_Ëv–: 0x%x:", 
p_d©a
->
bË_key
.
key_v®ue
.
Ënc_key
.
£c_Ëv–
);

973 
	gBSA_LE_KEY_LID
:

974 
APP_DEBUG1
("\ˆkey_ty³: BTM_LE_KEY_LID(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

977 
APP_DEBUG1
("\ˆkey_ty³: UnknowÀkey(%d)", 
p_d©a
->
bË_key
.
key_ty³
);

982 
­p_mgr_»ad_»mÙe_deviûs
();

984 
­p_xml_upd©e_deviû_ty³_db
(
­p_xml_»mÙe_deviûs_db
,

985 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
), 
p_d©a
->
bË_key
.
bd_addr
,

986 
BT_DEVICE_TYPE_BLE
);

988 
­p_xml_upd©e_bË_key_db
(
­p_xml_»mÙe_deviûs_db
,

989 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
),

990 
p_d©a
->
bË_key
.
bd_addr
,

991 
p_d©a
->
bË_key
.
key_v®ue
,

992 
p_d©a
->
bË_key
.
key_ty³
);

994 
	g¡©us
 = 
­p_mgr_wr™e_»mÙe_deviûs
();

995 ià(
	g¡©us
 < 0)

997 
APP_ERROR1
("­p_mgr_wr™e_»mÙe_deviû çed:%d", 
¡©us
);

1001 
	gBSA_SEC_BLE_PASSKEY_REQ_EVT
:

1002 
APP_INFO0
("BSA_SEC_BLE_PASSKEY_REQ_EVT (Passkey Request)„eceived from:");

1003 
APP_INFO1
("\tbd_addr: %02x:%02x:%02x:%02x:%02x:%02x",

1004 
p_d©a
->
bË_·sskey_»q
.
bd_addr
[0],…_data->ble_passkey_req.bd_addr[1],

1005 
p_d©a
->
bË_·sskey_»q
.
bd_addr
[2],…_data->ble_passkey_req.bd_addr[3],

1006 
p_d©a
->
bË_·sskey_»q
.
bd_addr
[4],…_data->ble_passkey_req.bd_addr[5]);

1008 
mem£t
(&
g_pš_code_»¶y
, 0, (g_pin_code_reply));

1009 
bdıy
(
g_pš_code_»¶y
.
bd_addr
, 
p_d©a
->
pš_»q
.bd_addr);

1013 
	gBSA_SEC_RSSI_EVT
:

1014 
APP_INFO1
("BSA_SEC_RSSI_EVT„eceived for BdAddr: %02x:%02x:%02x:%02x:%02x:%02x",

1015 
p_d©a
->
sig_¡»ngth
.
bd_addr
[0],…_data->sig_strength.bd_addr[1],

1016 
p_d©a
->
sig_¡»ngth
.
bd_addr
[2],…_data->sig_strength.bd_addr[3],

1017 
p_d©a
->
sig_¡»ngth
.
bd_addr
[4],…_data->sig_strength.bd_addr[5]);

1018 ià(
	gp_d©a
->
	gsig_¡»ngth
.
	gmask
 & 
	gBSA_SEC_SIG_STRENGTH_RSSI
)

1020 ià(
	gp_d©a
->
	gsig_¡»ngth
.
	glšk_ty³
 =ğ
BSA_TRANSPORT_BR_EDR
)

1023 
APP_INFO1
("\tRSSI: %d (dB)", 
p_d©a
->
sig_¡»ngth
.
rssi_v®ue
);

1028 
APP_INFO1
("\tRSSI: %d (dBm)", 
p_d©a
->
sig_¡»ngth
.
rssi_v®ue
);

1032 ià(
	gp_d©a
->
	gsig_¡»ngth
.
	gmask
 & 
	gBSA_SEC_SIG_STRENGTH_RAW_RSSI
)

1035 
APP_INFO1
("\tRaw RSSI: %d (dBm)", 
p_d©a
->
sig_¡»ngth
.
¿w_rssi_v®ue
);

1038 ià(
	gp_d©a
->
	gsig_¡»ngth
.
	gmask
 & 
	gBSA_SEC_SIG_STRENGTH_LINK_QUALITY
)

1040 
APP_INFO1
("\tLšk Qu®™y: %d", 
p_d©a
->
sig_¡»ngth
.
lšk_qu®™y_v®ue
);

1045 
APP_ERROR1
("unknowÀev’t:%d", 
ev’t
);

1061 
­p_mgr_£nd_pšcode
(
tBSA_SEC_PIN_CODE_REPLY
 
pš_code_»¶y
)

1063 
	g¡©us
;

1064 
bdıy
(
pš_code_»¶y
.
bd_addr
, 
g_pš_code_»¶y
.bd_addr);

1065 
	g¡©us
 = 
BSA_SecPšCodeR•ly
(&
pš_code_»¶y
);

1066 ià(
	g¡©us
)

1068 
APP_ERROR1
("BSA_SecPšCodeR•ly ERROR:%d", 
¡©us
);

1070 
APP_ERROR1
("BSA_SecPinCodeReply bd:%02x:%02x:%02x:%02x:%02x:%02x,pin_code:%x\n",

1071 ()
g_pš_code_»¶y
.
bd_addr
[0],()g_pin_code_reply.bd_addr[1],

1072 ()
g_pš_code_»¶y
.
bd_addr
[2],()g_pin_code_reply.bd_addr[3],

1073 ()
g_pš_code_»¶y
.
bd_addr
[4],()g_pin_code_reply.bd_addr[5],

1074 
g_pš_code_»¶y
.
pš_code
);

1089 
­p_mgr_£nd_·sskey
(
UINT32
 
·sskey
)

1091 
	gg_·sskey_»¶y
.
	g·sskey
 = 
·sskey
;

1092 
BSA_SecSpPasskeyR•ly
(&
g_·sskey_»¶y
);

1106 
­p_mgr_£c_£t_¥_ÿp
(
tBSA_SEC_IO_CAP
 
¥_ÿp
)

1108 
	g¡©us
;

1109 
tBSA_SEC_SET_SECURITY
 
	g£t_£cur™y
;

1111 
BSA_SecS‘Secur™yIn™
(&
£t_£cur™y
);

1112 
	g£t_£cur™y
.
	gsim¶e_·œšg_io_ÿp
 = 
¥_ÿp
;

1113 
	g£t_£cur™y
.
	g£c_cback
 = 
­p_mgr_£cur™y_ÿÎback
;

1114 
	g¡©us
 = 
BSA_SecS‘Secur™y
(&
£t_£cur™y
);

1115 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

1117 
APP_ERROR1
("BSA_SecS‘Secur™y faed:%d", 
¡©us
);

1134 
­p_mgr_£c_£t_£cur™y
()

1136 
	g¡©us
;

1137 
tBSA_SEC_SET_SECURITY
 
	g£t_£cur™y
;

1139 
APP_DEBUG0
("");

1141 
BSA_SecS‘Secur™yIn™
(&
£t_£cur™y
);

1142 
	g£t_£cur™y
.
	gsim¶e_·œšg_io_ÿp
 = 
­p_xml_cÚfig
.
io_ÿp
;

1143 
	g£t_£cur™y
.
	g£c_cback
 = 
­p_mgr_£cur™y_ÿÎback
;

1144 
	g¡©us
 = 
BSA_SecS‘Secur™y
(&
£t_£cur™y
);

1145 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

1147 
APP_ERROR1
("BSA_SecS‘Secur™y faed:%d", 
¡©us
);

1165 
­p_mgr_¥_cfm_»¶y
(
BOOLEAN
 
acû±
, 
BD_ADDR
 
bd_addr
)

1167 
	g¡©us
;

1168 
tBSA_SEC_SP_CFM_REPLY
 
	g­p_£c_¥_cfm_»¶y
;

1170 
APP_DEBUG1
("acû±:%d bd_addr: %02x:%02x:%02x:%02x:%02x:%02x", 
acû±
,

1171 
bd_addr
[0], bd_addr[1], bd_addr[2], bd_addr[3], bd_addr[4], bd_addr[5]);

1173 
BSA_SecSpCfmR•lyIn™
(&
­p_£c_¥_cfm_»¶y
);

1174 
	g­p_£c_¥_cfm_»¶y
.
	gacû±
 = 
acû±
;

1175 
bdıy
(
­p_£c_¥_cfm_»¶y
.
bd_addr
, bd_addr);

1176 
	g¡©us
 = 
BSA_SecSpCfmR•ly
(&
­p_£c_¥_cfm_»¶y
);

1177 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

1179 
APP_ERROR1
("BSA_SecSpCfmR•ly faed:%d", 
¡©us
);

1198 
­p_mgr_£c_bÚd_ÿnûl
()

1200 
	g¡©us
;

1201 
	gdeviû_šdex
;

1202 
tBSA_SEC_BOND_CANCEL
 
	g£c_bÚd_ÿnûl
;

1204 
APP_INFO0
("Bluetooth Bond Cancel menu:");

1205 
­p_disc_di¥Ïy_deviûs
();

1206 
	gdeviû_šdex
 = 
­p_g‘_choiû
("Select device");

1208 ià((
	gdeviû_šdex
 >= 0) &&

1209 (
deviû_šdex
 < 
APP_DISC_NB_DEVICES
) &&

1210 (
­p_discov”y_cb
.
devs
[
deviû_šdex
].
š_u£
 !ğ
FALSE
))

1212 
BSA_SecBÚdCªûlIn™
(&
£c_bÚd_ÿnûl
);

1213 
bdıy
(
£c_bÚd_ÿnûl
.
bd_addr
, 
­p_discov”y_cb
.
devs
[
deviû_šdex
].
deviû
.bd_addr);

1214 
	g¡©us
 = 
BSA_SecBÚdCªûl
(&
£c_bÚd_ÿnûl
);

1215 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

1217 
APP_ERROR1
("BSA_SecBÚdCªûÈçed:%d", 
¡©us
);

1223 
APP_ERROR1
("Bad deviû‚umb”:%d", 
deviû_šdex
);

1243 
­p_mgr_£t_discov”abË
()

1245 
tBSA_DM_SET_CONFIG
 
	gb§_dm_£t_cÚfig
;

1246 ià(
BSA_DmS‘CÚfigIn™
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1248 
APP_ERROR0
("BSA_DmSetConfigInit failed");

1251 
	gb§_dm_£t_cÚfig
.
	gdiscov”abË
 = 1;

1252 
	gb§_dm_£t_cÚfig
.
	gcÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

1253 ià(
BSA_DmS‘CÚfig
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1255 
APP_ERROR0
("BSA_DmSetConfig failed");

1271 
­p_mgr_£t_nÚ_discov”abË
()

1273 
tBSA_DM_SET_CONFIG
 
	gb§_dm_£t_cÚfig
;

1274 ià(
BSA_DmS‘CÚfigIn™
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1276 
APP_ERROR0
("BSA_DmSetConfigInit failed");

1279 
	gb§_dm_£t_cÚfig
.
	gdiscov”abË
 = 0;

1280 
	gb§_dm_£t_cÚfig
.
	gcÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

1281 ià(
BSA_DmS‘CÚfig
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1283 
APP_ERROR0
("BSA_DmSetConfig failed");

1299 
­p_mgr_£t_cÚÃùabË
()

1301 
tBSA_DM_SET_CONFIG
 
	gb§_dm_£t_cÚfig
;

1302 ià(
BSA_DmS‘CÚfigIn™
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1304 
APP_ERROR0
("BSA_DmSetConfigInit failed");

1307 
	gb§_dm_£t_cÚfig
.
	gcÚÃùabË
 = 1;

1308 
	gb§_dm_£t_cÚfig
.
	gcÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

1309 ià(
BSA_DmS‘CÚfig
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1311 
APP_ERROR0
("BSA_DmSetConfig failed");

1327 
­p_mgr_£t_nÚ_cÚÃùabË
()

1329 
tBSA_DM_SET_CONFIG
 
	gb§_dm_£t_cÚfig
;

1330 ià(
BSA_DmS‘CÚfigIn™
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1332 
APP_ERROR0
("BSA_DmSetConfigInit failed");

1335 
	gb§_dm_£t_cÚfig
.
	gcÚÃùabË
 = 0;

1336 
	gb§_dm_£t_cÚfig
.
	gcÚfig_mask
 = 
BSA_DM_CONFIG_VISIBILITY_MASK
;

1337 ià(
BSA_DmS‘CÚfig
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1339 
APP_ERROR0
("BSA_DmSetConfig failed");

1355 
­p_mgr_di_discov”y
()

1357 
	gšdex
, 
	g¡©us
;

1358 
BD_ADDR
 
	gbd_addr
;

1362 
APP_INFO0
("Bluetooth Manager DI Discovery menu:");

1363 
APP_INFO0
(" 0 Device from XML database (previously…aired)");

1364 
APP_INFO0
(" 1 Device found in†ast discovery");

1365 
	gšdex
 = 
­p_g‘_choiû
("Select source");

1366 ià(
	gšdex
 == 0)

1369 
­p_mgr_»ad_»mÙe_deviûs
();

1371 
­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
, 
APP_NUM_ELEMENTS
(app_xml_remote_devices_db));

1372 
	gšdex
 = 
­p_g‘_choiû
("Select device");

1373 ià((
	gšdex
 >= 0) &&

1374 (
šdex
 < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
)) &&

1375 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
š_u£
 !ğ
FALSE
))

1377 
bdıy
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
šdex
].bd_addr);

1385 ià(
	gšdex
 == 1)

1387 
­p_disc_di¥Ïy_deviûs
();

1388 
	gšdex
 = 
­p_g‘_choiû
("Select device");

1389 ià((
	gšdex
 >= 0) &&

1390 (
šdex
 < 
APP_DISC_NB_DEVICES
) &&

1391 (
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 !ğ
FALSE
))

1393 
bdıy
(
bd_addr
, 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.bd_addr);

1406 
	g¡©us
 = 
­p_disc_¡¬t_dev_šfo
(
bd_addr
, 
NULL
);

1407  
	g¡©us
;

1410 
APP_ERROR1
("Bad Deviû index:%d", 
šdex
);

1414 
	#ID_FILE
 "/sys/şass/Ãt/wÏn0/add»ss"

	)

1417 
INT32
 
g‘_mac
(*
âame
, 
UINT8
 * 
id_buf
)

1419 
UINT32
 
	gfd
;

1420 
INT32
 
	g»t
=6;

1421 
UINT8
 
	gbuf
[64];

1422 
UINT8
 
	gtbuf
[20];

1423 
UINT8
 
	gbuf2
[64];

1425 
	gfd
 = 
İ’
(
âame
, 
O_RDONLY
);

1426 ià(
	gfd
 < 0) {

1427 
APP_ERROR1
(" FaØİ’ deviû %s\n", 
ID_FILE
);

1430 
	gbuf
[0] = 0;

1431 
»ad
(
fd
, 
buf
, 63);

1432 
´štf
("âame:%s:g‘_mac:buf:%s\n",
âame
,
buf
);

1433 
şo£
(
fd
);

1434 if(
	gbuf
[0]) {

1435 
UINT8
 *
	g±r
;

1436 
	g±r
 = 
¡rchr
(
buf
,'\n');

1437 if(
	g±r
){

1438 *
	g±r
 = 0;

1440 
ssÿnf
(
buf
,"%02hhx:%02hhx:%02hhx:%02hhx:%02hhx:%02hhx",
tbuf
,tbuf+1,tbuf+2,tbuf+3,tbuf+4,tbuf+5);

1441 
bdıy
(
id_buf
,
tbuf
);

1443 
´štf
("id_buf->%02x:%02x:%02x:%02x:%02x:%02x\n",
id_buf
[0],id_buf[1],\

1444 
id_buf
[2],id_buf[3],id_buf[4],id_buf[5]);

1454 
´štf
("»ad badd¸ç.fd: %d,buf[0]:%02hh\n",
fd
,
buf
[0]);

1455 
	g»t
 = -1;

1457  
	g»t
;

1459 
g‘_wifi_addr
(
BD_ADDR
 
wifi_mac
){

1460 
UINT32
 
	g»t
;

1461 
UINT8
 
	gmacbuf
[6]={0};

1462 
	g»t
 = 
g‘_mac
("/sys/şass/Ãt/wÏn0/add»ss", 
macbuf
);

1463 if(
	g»t
 == 6)

1467 
bdıy
(
wifi_mac
,
macbuf
);

1470  
	g»t
;

1472 
g‘_bt_addr
(
BD_ADDR
 
bt_mac
)

1474 
UINT32
 
	gi
;

1475 
UINT32
 
	g»t
;

1476 
UINT8
 
	gmacbuf
[6]={0};

1479 
	g»t
 = 
g‘_mac
(
ID_FILE
, 
macbuf
);

1480 if(
	g»t
 == 6)

1483 
bdıy
(
bt_mac
,
macbuf
);

1484 
´štf
("\n===================bluMAC:->%02x-%02x-%02x-%02x-%02x-%02x-\n",
bt_mac
[0],bt_mac[1],bt_mac[2],bt_mac[3],bt_mac[4],bt_mac[5]);

1487 
´štf
("\n===================can't get blue MAC.\n");

1489  
	g»t
;

1502 
­p_mgr_cÚfig
(* 
bt_Çme
)

1504 
	g¡©us
;

1505 
	gšdex
;

1506 
BD_ADDR
 
	gloÿl_bd_addr
 = 
APP_DEFAULT_BD_ADDR
;

1507 
UINT8
 
	gbaddr_buf
[20];

1508 
DEV_CLASS
 
	gloÿl_şass_of_deviû
 = 
APP_DEFAULT_CLASS_OF_DEVICE
;

1509 
tBSA_SEC_ADD_DEV
 
	gb§_add_dev_·¿m
;

1510 
tBSA_SEC_ADD_SI_DEV
 
	gb§_add_si_dev_·¿m
;

1511 
timev®
 
	gtv
;

1512 
	g¿nd_£ed
;

1513 
tBSA_DM_GET_CONFIG
 
	gbt_cÚfig
;

1518 
BD_ADDR
 
	gbtmac
,
	gcur£t
;

1520 
mem£t
(
btmac
, 0, (
BD_ADDR
));

1521 
g‘_bt_addr
(
btmac
);

1525 
	g¡©us
 = 
­p_mgr_»ad_cÚfig
();

1526 if(
	g¡©us
 >=0){

1527 if(
memcmp
(
­p_xml_cÚfig
.
bd_addr
, 
btmac
, (
BD_ADDR
)) !=0){

1528 
¡©us
 = -1;

1531 ià(
	g¡©us
 < 0)

1533 
APP_ERROR0
("Creating default XML config file");

1534 
	gbË_Çme
[30];

1535 
¡pıy
(
bË_Çme
, 
bt_Çme
);

1537 
	g­p_xml_cÚfig
.
	g’abË
 = 
TRUE
;

1538 
	g­p_xml_cÚfig
.
	gdiscov”abË
 = 
TRUE
;

1539 
	g­p_xml_cÚfig
.
	gcÚÃùabË
 = 
TRUE
;

1540 
¡ºıy
((*)
­p_xml_cÚfig
.
Çme
, 
bt_Çme
, (app_xml_config.name));

1541 
	g­p_xml_cÚfig
.
	gÇme
[(
­p_xml_cÚfig
.
Çme
) - 1] = '\0';

1542 
¡ºıy
((*)
­p_xml_cÚfig
.
bË_Çme
, ble_name, (app_xml_config.ble_name));

1543 
	g­p_xml_cÚfig
.
	gbË_Çme
[(
­p_xml_cÚfig
.
bË_Çme
) - 1] = '\0';

1544 #ifdeà
USE_CHIP_BT_ADDR


1545 
	g¡©us
 = 
BSA_DmG‘CÚfigIn™
(&
bt_cÚfig
);

1546 
	g¡©us
 = 
BSA_DmG‘CÚfig
(&
bt_cÚfig
);

1547 ià(
	g¡©us
 !ğ
BSA_SUCCESS
){

1548 
APP_ERROR1
("BSA_DmG‘CÚfig faed:%d", 
¡©us
);

1551 
bdıy
(
­p_xml_cÚfig
.
bd_addr
, 
bt_cÚfig
.bd_addr);

1553 if(6 =ğ
g‘_bt_addr
(
baddr_buf
)){

1554 
´štf
("\n\n ------------set baddr\n");

1555 
bdıy
(
­p_xml_cÚfig
.
bd_addr
, 
baddr_buf
);

1557 
´štf
("\n\n ------------set default‡ddr\n");

1558 
bdıy
(
­p_xml_cÚfig
.
bd_addr
, 
loÿl_bd_addr
);

1560 
g‘timeofday
(&
tv
, 
NULL
);

1561 
	g¿nd_£ed
 = 
tv
.
tv_£c
 *v.
tv_u£c
 * 
g‘pid
();

1562 
	g­p_xml_cÚfig
.
	gbd_addr
[4] = 
¿nd_r
(&
¿nd_£ed
);

1563 
	g­p_xml_cÚfig
.
	gbd_addr
[5] = 
¿nd_r
(&
¿nd_£ed
);

1566 
´štf
("=================will write bd_addr:->%02x-%02x-%02x-%02x-%02x-%02x-\n",

1567 
­p_xml_cÚfig
.
bd_addr
[0],app_xml_config.bd_addr[1],

1568 
­p_xml_cÚfig
.
bd_addr
[2],app_xml_config.bd_addr[3],

1569 
­p_xml_cÚfig
.
bd_addr
[4],app_xml_config.bd_addr[5]);

1572 
memıy
(
­p_xml_cÚfig
.
şass_of_deviû
, 
loÿl_şass_of_deviû
, (
DEV_CLASS
));

1573 
¡ºıy
(
­p_xml_cÚfig
.
roÙ_·th
, 
APP_DEFAULT_ROOT_PATH
, (app_xml_config.root_path));

1574 
	g­p_xml_cÚfig
.
	groÙ_·th
[(
­p_xml_cÚfig
.
roÙ_·th
) - 1] = '\0';

1575 
¡ºıy
((*)
­p_xml_cÚfig
.
pš_code
, 
APP_DEFAULT_PIN_CODE
, 
APP_DEFAULT_PIN_LEN
);

1577 
	g­p_xml_cÚfig
.
	gpš_code
[
APP_DEFAULT_PIN_LEN
] = '\0';

1578 
	g­p_xml_cÚfig
.
	gpš_Ën
 = 
APP_DEFAULT_PIN_LEN
;

1579 
	g­p_xml_cÚfig
.
	gio_ÿp
 = 
APP_SEC_IO_CAPABILITIES
;

1581 
´štf
("=================write bd_addr:->%02x-%02x-%02x-%02x-%02x-%02x-\n",

1582 
­p_xml_cÚfig
.
bd_addr
[0],app_xml_config.bd_addr[1],

1583 
­p_xml_cÚfig
.
bd_addr
[2],app_xml_config.bd_addr[3],

1584 
­p_xml_cÚfig
.
bd_addr
[4],app_xml_config.bd_addr[5]);

1585 
	g¡©us
 = 
­p_mgr_wr™e_cÚfig
();

1586 ià(
	g¡©us
 < 0)

1588 
APP_ERROR0
("Unableo Create default XML config file");

1589 
­p_mgt_şo£
();

1590  
	g¡©us
;

1595 
	g¡©us
 = 
­p_mgr_»ad_»mÙe_deviûs
();

1596 ià(
	g¡©us
 < 0)

1598 
APP_ERROR0
("No„emote device database found");

1602 
­p_xml_di¥Ïy_deviûs
(
­p_xml_»mÙe_deviûs_db
,

1603 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
));

1607 
­p_mgr_g‘_bt_cÚfig
();

1610 
	g¡©us
 = 
­p_mgr_£c_£t_£cur™y
();

1611 ià(
	g¡©us
 < 0)

1613 
APP_ERROR1
("­p_mgr_£c_£t_£cur™y faed:%d", 
¡©us
);

1614 
­p_mgt_şo£
();

1615  
	g¡©us
;

1620 
APP_INFO0
("Add‡ll devices found in database");

1621 
	gšdex
 = 0 ; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
) ; index++)

1623 ià(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
)

1625 
APP_INFO1
("Addšg:%s", 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
);

1626 
BSA_SecAddDeviûIn™
(&
b§_add_dev_·¿m
);

1627 
bdıy
(
b§_add_dev_·¿m
.
bd_addr
,

1628 
­p_xml_»mÙe_deviûs_db
[
šdex
].
bd_addr
);

1629 
memıy
(
b§_add_dev_·¿m
.
şass_of_deviû
,

1630 
­p_xml_»mÙe_deviûs_db
[
šdex
].
şass_of_deviû
,

1631 (
DEV_CLASS
));

1632 
memıy
(
b§_add_dev_·¿m
.
lšk_key
,

1633 
­p_xml_»mÙe_deviûs_db
[
šdex
].
lšk_key
,

1634 (
LINK_KEY
));

1635 
	gb§_add_dev_·¿m
.
	glšk_key_´e£Á
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
lšk_key_´e£Á
;

1636 
	gb§_add_dev_·¿m
.
	gŒu¡ed_£rviûs
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Œu¡ed_£rviûs
;

1637 
	gb§_add_dev_·¿m
.
	gis_Œu¡ed
 = 
TRUE
;

1638 
	gb§_add_dev_·¿m
.
	gkey_ty³
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
key_ty³
;

1639 
	gb§_add_dev_·¿m
.
	gio_ÿp
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
io_ÿp
;

1640 #ià(
defšed
(
BLE_INCLUDED
è&& BLE_INCLUDED =ğ
TRUE
)

1641 
	gb§_add_dev_·¿m
.
	gbË_addr_ty³
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
bË_addr_ty³
;

1642 
	gb§_add_dev_·¿m
.
	gdeviû_ty³
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
deviû_ty³
;

1643 
	gb§_add_dev_·¿m
.
	gšq_»suÉ_ty³
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
šq_»suÉ_ty³
;

1644 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gbË_lšk_key_´e£Á
)

1646 
	gb§_add_dev_·¿m
.
	gbË_lšk_key_´e£Á
 = 
TRUE
;

1648 
memıy
(
b§_add_dev_·¿m
.
Ë_³nc_key
.
Ék
,

1649 
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_Ék
,

1650 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_Ék
));

1651 
memıy
(
b§_add_dev_·¿m
.
Ë_³nc_key
.
¿nd
,

1652 
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_¿nd
,

1653 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_¿nd
));

1654 
	gb§_add_dev_·¿m
.
	gË_³nc_key
.
	gediv
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_ediv
;

1655 
	gb§_add_dev_·¿m
.
	gË_³nc_key
.
	g£c_Ëv–
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_£c_Ëv–
;

1656 
	gb§_add_dev_·¿m
.
	gË_³nc_key
.
	gkey_size
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
³nc_key_size
;

1658 
memıy
(
b§_add_dev_·¿m
.
Ë_pid_key
.
œk
,

1659 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pid_œk
,

1660 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
pid_œk
));

1661 
	gb§_add_dev_·¿m
.
	gË_pid_key
.
	gaddr_ty³
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pid_addr_ty³
;

1662 
memıy
(
b§_add_dev_·¿m
.
Ë_pid_key
.
¡©ic_addr
,

1663 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pid_¡©ic_addr
,

1664 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
pid_¡©ic_addr
));

1666 
	gb§_add_dev_·¿m
.
	gË_pc¤k_key
.
	gcouÁ”
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pc¤k_couÁ”
;

1667 
memıy
(
b§_add_dev_·¿m
.
Ë_pc¤k_key
.
c¤k
,

1668 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pc¤k_c¤k
,

1669 (
­p_xml_»mÙe_deviûs_db
[
šdex
].
pc¤k_c¤k
));

1670 
	gb§_add_dev_·¿m
.
	gË_pc¤k_key
.
	g£c_Ëv–
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
pc¤k_£c_Ëv–
;

1672 
	gb§_add_dev_·¿m
.
	gË_lc¤k_key
.
	gcouÁ”
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
lc¤k_couÁ”
;

1673 
	gb§_add_dev_·¿m
.
	gË_lc¤k_key
.
	gdiv
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
lc¤k_div
;

1674 
	gb§_add_dev_·¿m
.
	gË_lc¤k_key
.
	g£c_Ëv–
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
lc¤k_£c_Ëv–
;

1676 
	gb§_add_dev_·¿m
.
	gË_Ënc_key
.
	gdiv
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Ënc_div
;

1677 
	gb§_add_dev_·¿m
.
	gË_Ënc_key
.
	gkey_size
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Ënc_key_size
;

1678 
	gb§_add_dev_·¿m
.
	gË_Ënc_key
.
	g£c_Ëv–
 = 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Ënc_£c_Ëv–
;

1681 
BSA_SecAddDeviû
(&
b§_add_dev_·¿m
);

1686 
­p_»ad_xml_si_deviûs
();

1687 
	gšdex
 = 0 ; index < 
APP_NUM_ELEMENTS
(
­p_xml_si_deviûs_db
) ; index++)

1689 ià(
	g­p_xml_si_deviûs_db
[
šdex
].
	gš_u£
)

1691 
BSA_SecAddSiDevIn™
(&
b§_add_si_dev_·¿m
);

1692 
bdıy
(
b§_add_si_dev_·¿m
.
bd_addr
, 
­p_xml_si_deviûs_db
[
šdex
].bd_addr);

1693 
	gb§_add_si_dev_·¿m
.
	g¶©fÜm
 = 
­p_xml_si_deviûs_db
[
šdex
].
¶©fÜm
;

1694 
BSA_SecAddSiDev
(&
b§_add_si_dev_·¿m
);

1712 
­p_mgr_chªge_du®_¡ack_mode
()

1714 
	gchoiû
;

1715 
tBSA_DM_DUAL_STACK_MODE
 
	gdu®_¡ack_mode
;

1717 
APP_INFO1
("Cu¼’ˆDu®Sck mode: %s", 
­p_mgr_g‘_du®_¡ack_mode_desc
());

1718 
APP_INFO0
("Selecthe‚ew DualStack mode:");

1719 
APP_INFO0
("\t0: DUAL_STACK_MODE_BSA");

1720 
APP_INFO0
("\t1: DUAL_STACK_MODE_MM/Kernel (requires specific BTUSB driver)");

1721 
APP_INFO0
("\t2: DUAL_STACK_MODE_BTC (requires specific FW)");

1722 
	gchoiû
 = 
­p_g‘_choiû
("Choice");

1724 
	gchoiû
)

1727 
APP_INFO0
("Switching Dual Stacko BSA");

1728 
	gdu®_¡ack_mode
 = 
BSA_DM_DUAL_STACK_MODE_BSA
;

1732 
APP_INFO0
("Switching Dual Stacko MM/Kernel");

1733 
	gdu®_¡ack_mode
 = 
BSA_DM_DUAL_STACK_MODE_MM
;

1737 
APP_INFO0
("Switching Dual Stacko BTC");

1738 
	gdu®_¡ack_mode
 = 
BSA_DM_DUAL_STACK_MODE_BTC
;

1742 
APP_ERROR1
("Bad Du®Sck Mode=%d", 
choiû
);

1746 ià(
­p_dm_£t_du®_¡ack_mode
(
du®_¡ack_mode
) < 0)

1748 
APP_ERROR0
("DualStack Switch Failed");

1752 
	g­p_mgr_cb
.
	gdu®_¡ack_mode
 = 
du®_¡ack_mode
;

1768 *
­p_mgr_g‘_du®_¡ack_mode_desc
()

1770 
	g­p_mgr_cb
.
	gdu®_¡ack_mode
)

1772 
	gBSA_DM_DUAL_STACK_MODE_BSA
:

1774 
	gBSA_DM_DUAL_STACK_MODE_MM
:

1776 
	gBSA_DM_DUAL_STACK_MODE_BTC
:

1794 
­p_mgr_discov”y_‹¡
()

1796 
	gchoiû
;

1798 
APP_INFO0
("Selecthe…arametero modify:");

1799 
APP_INFO0
("\t0: Updateype");

1800 
APP_INFO0
("\t1: Inquiry TX…ower");

1801 
	gchoiû
 = 
­p_g‘_choiû
("Choice");

1803 
	gchoiû
)

1806 
APP_INFO0
("Select which update is‚eeded:");

1807 
APP_INFO1
("\t%d: End oàdiscov”y (deçuÉ)", 
BSA_DISC_UPDATE_END
);

1808 
APP_INFO1
("\t%d: UpÚ‡ny modifiÿtiÚ", 
BSA_DISC_UPDATE_ANY
);

1809 
APP_INFO1
("\t%d: UpÚ NamReû±iÚ", 
BSA_DISC_UPDATE_NAME
);

1810 
	gchoiû
 = 
­p_g‘_choiû
("");

1812  
­p_disc_¡¬t_upd©e
((
tBSA_DISC_UPDATE
)
choiû
);

1816 
choiû
 = 
­p_g‘_choiû
("Enter‚ew Inquiry TX…ower");

1818  
­p_disc_¡¬t_pow”
((
INT8
)
choiû
);

1823 
APP_ERROR0
("Unsupported choice value");

1840 
­p_mgr_»ad_v”siÚ
()

1842 
tBSA_TM_READ_VERSION
 
	gb§_»ad_v”siÚ
;

1843 
tBSA_STATUS
 
	gb§_¡©us
;

1845 
	gb§_¡©us
 = 
BSA_TmR—dV”siÚIn™
(&
b§_»ad_v”siÚ
);

1846 
	gb§_¡©us
 = 
BSA_TmR—dV”siÚ
(&
b§_»ad_v”siÚ
);

1847 ià(
	gb§_¡©us
 !ğ
BSA_SUCCESS
)

1849 
APP_ERROR1
("BSA_TmR—dV”siÚ faed stus:%d", 
b§_¡©us
);

1853 
APP_INFO1
("S”v” stus:%d", 
b§_»ad_v”siÚ
.
¡©us
);

1854 
APP_INFO1
("FW Version:%d.%d.%d.%d",

1855 
b§_»ad_v”siÚ
.
fw_v”siÚ
.
majÜ
,

1856 
b§_»ad_v”siÚ
.
fw_v”siÚ
.
mšÜ
,

1857 
b§_»ad_v”siÚ
.
fw_v”siÚ
.
bud
,

1858 
b§_»ad_v”siÚ
.
fw_v”siÚ
.
cÚfig
);

1859 
APP_INFO1
("BSA S”v” V”siÚ:%s", 
b§_»ad_v”siÚ
.
b§_£rv”_v”siÚ
);

1879 
­p_mgr_£t_lšk_pŞicy
(
BD_ADDR
 
bd_addr
, 
tBSA_DM_LP_MASK
 
pŞicy_mask
, 
BOOLEAN
 
£t
)

1881 
tBSA_DM_SET_CONFIG
 
	gb§_dm_£t_cÚfig
;

1882 ià(
BSA_DmS‘CÚfigIn™
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1884 
APP_ERROR0
("BSA_DmSetConfigInit failed");

1888 
	gb§_dm_£t_cÚfig
.
	gcÚfig_mask
 = 
BSA_DM_CONFIG_LINK_POLICY_MASK
;

1890 
bdıy
(
b§_dm_£t_cÚfig
.
pŞicy_·¿m
.
lšk_bd_addr
, 
bd_addr
);

1891 
	gb§_dm_£t_cÚfig
.
	gpŞicy_·¿m
.
	gpŞicy_mask
 = 
pŞicy_mask
;

1892 
	gb§_dm_£t_cÚfig
.
	gpŞicy_·¿m
.
	g£t
 = 
£t
;

1894 ià(
BSA_DmS‘CÚfig
(&
b§_dm_£t_cÚfig
è!ğ
BSA_SUCCESS
)

1896 
APP_ERROR0
("BSA_DmSetConfig failed");

1912 
­p_mgr_£c_bÚd
(cÚ¡ * 
bd_Çme
)

1914 
	g¡©us
;

1915 
	gšdex
 = 0;

1916 
tBSA_SEC_BOND
 
	g£c_bÚd
;

1917 
­p_disc_di¥Ïy_deviûs
();

1919 ;
	gšdex
 < 
	gAPP_DISC_NB_DEVICES
; index++) {

1920 ià((
¡rcmp
(
bd_Çme
, 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.
Çme
) == 0)

1921 && (
­p_discov”y_cb
.
devs
[
šdex
].
š_u£
 !ğ
FALSE
)) {

1922 
BSA_SecBÚdIn™
(&
£c_bÚd
);

1923 
bdıy
(
£c_bÚd
.
bd_addr
, 
­p_discov”y_cb
.
devs
[
šdex
].
deviû
.bd_addr);

1924 
	g¡©us
 = 
BSA_SecBÚd
(&
£c_bÚd
);

1925 ià(
	g¡©us
 =ğ
BSA_SUCCESS
)

1932 
APP_ERROR1
("BSA_SecBÚd faed:%d", 
¡©us
);

1935 
­p_mgr_»move_deviû
(
BD_ADDR
 
bd_addr
)

1937 
	g¡©us
;

1938 
tBSA_SEC_REMOVE_DEV
 
	g£c_»move
;

1940 
APP_INFO0
("app_mgr_remove_device");

1943 
BSA_SecRemoveDeviûIn™
(&
£c_»move
);

1944 
bdıy
(
£c_»move
.
bd_addr
, bd_addr);

1945 
	g¡©us
 = 
BSA_SecRemoveDeviû
(&
£c_»move
);

1946 ià(
	g¡©us
 !ğ
BSA_SUCCESS
)

1948 
APP_INFO1
("BSA_SecRemoveDeviû fa,»t=%d",
¡©us
);

1964 
­p_mgr_£c_uÅaœ_addr
(
BD_ADDR
 
bd_addr
)

1966 
	g¡©us
;

1967 
	gdeviû_šdex
;

1968 
tBSA_SEC_REMOVE_DEV
 
	g£c_»move
;

1970 
APP_INFO0
("app_mgr_sec_unpair");

1973 
BSA_SecRemoveDeviûIn™
(&
£c_»move
);

1976 
­p_»ad_xml_»mÙe_deviûs
();

1978 
	gdeviû_šdex
=0;deviû_šdex < 
	gAPP_MAX_NB_REMOTE_STORED_DEVICES
; device_index++) {

1979 ià((
bdcmp
(
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr) == 0)

1980 && (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
)) {

1982 
bdıy
(
£c_»move
.
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

1983 
	g¡©us
 = 
BSA_SecRemoveDeviû
(&
£c_»move
);

1984 ià(
	g¡©us
 =ğ
BSA_SUCCESS
)

1987 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 = 
FALSE
;

1988 
­p_wr™e_xml_»mÙe_deviûs
();

1994 
APP_ERROR1
("BSA_SecRemoveDeviû O³¿tiÚ Faed w™h stu [%d]",
¡©us
);

2008 
­p_mgr_£c_uÅaœ
(cÚ¡ * 
bd_Çme
)

2010 
	g¡©us
;

2011 
	gdeviû_šdex
;

2012 
tBSA_SEC_REMOVE_DEV
 
	g£c_»move
;

2014 
APP_INFO0
("app_mgr_sec_unpair");

2017 
BSA_SecRemoveDeviûIn™
(&
£c_»move
);

2020 
­p_»ad_xml_»mÙe_deviûs
();

2022 
	gdeviû_šdex
=0;deviû_šdex < 
	gAPP_MAX_NB_REMOTE_STORED_DEVICES
; device_index++) {

2023 ià((
¡rcmp
(
bd_Çme
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
Çme
) == 0)

2024 && (
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 !ğ
FALSE
)) {

2026 
bdıy
(
£c_»move
.
bd_addr
, 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].bd_addr);

2027 
	g¡©us
 = 
BSA_SecRemoveDeviû
(&
£c_»move
);

2028 ià(
	g¡©us
 =ğ
BSA_SUCCESS
)

2031 
­p_xml_»mÙe_deviûs_db
[
deviû_šdex
].
š_u£
 = 
FALSE
;

2032 
­p_wr™e_xml_»mÙe_deviûs
();

2038 
APP_ERROR1
("BSA_SecRemoveDeviû O³¿tiÚ Faed w™h stu [%d]",
¡©us
);

2041 
­p_mgr_d–_lšked_deviûs
(cÚ¡ 
BD_ADDR
 
addr
)

2043 
	gšdex
;

2044 
	g»t
 = 0;

2046 
	gšdex
 = 0; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

2048 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
)

2051 if(
bdcmp
(
­p_xml_»mÙe_deviûs_db
[
šdex
].
bd_addr
, 
addr
) == 0)

2053 
APP_INFO1
("d–‚ame:%s,ty³:%d,bd_addr:%02x:%02x:%02x:%02x:%02x:%02x", 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
,

2054 ()
addr
[0],()addr[1],

2055 ()
addr
[2],()addr[3],

2056 ()
addr
[4],()addr[5]);

2057 
­p_mgr_£c_uÅaœ_addr
(
addr
);

2060 
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 = 
FALSE
;

2061 
	g»t
 = 
­p_wr™e_xml_»mÙe_deviûs
();

2067  
	g»t
;

2069 
­p_mgr_g‘_lškšg_bŠame
(
tLINKING_DEVICE
 *
lškšg_dev
) {

2070 
	gšdex
;

2071 
	g»t
 = 0;

2073 
	gšdex
 = 0; index < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

2075 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
)

2078 if(
bdcmp
(
­p_xml_»mÙe_deviûs_db
[
šdex
].
bd_addr
, 
lškšg_dev
->bd_addr) == 0)

2080 
¡rıy
(
lškšg_dev
->
bd_Çme
, 
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
);

2087 
­p_mgr_g‘_lškšg_deviûs
((*
­pG‘LškšgCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
)

2089 
	gšdex
;

2090 if(
	g­pG‘LškšgCback
 !ğ
NULL
)

2092 
šdex
 = 0; 
	gšdex
 < 
	gAPP_MAX_NB_REMOTE_STORED_DEVICES
; index++)

2094 if(
	glškšg_dev
[
šdex
].
	gš_u£
 !ğ
FALSE
)

2096 
tAPP_DISC_MSG
 
msg
;

2106 
	gmsg
.
	gdisc_Ãw
.
	gbd_ty³
 = 
lškšg_dev
[
šdex
].
bd_ty³
;

2107 
	gmsg
.
	gdisc_Ãw
.
	gbd_addr
 = (cÚ¡ *)(
lškšg_dev
[
šdex
].
bd_addr
);

2108 if(
¡¾’
(
lškšg_dev
[
šdex
].
bd_Çme
) == 0){

2109 
­p_mgr_g‘_lškšg_bŠame
(
lškšg_dev
 +
šdex
);

2111 
	gmsg
.
	gdisc_Ãw
.
	gÇme
 = (cÚ¡ *)
lškšg_dev
[
šdex
].
bd_Çme
;

2112 
APP_INFO1
("lškšg‚ame:%s,ty³:%d,bd_addr:%02x:%02x:%02x:%02x:%02x:%02x", 
msg
.
disc_Ãw
.
Çme
, msg.disc_Ãw.
bd_ty³
,

2113 ()
msg
.
disc_Ãw
.
bd_addr
[0],()msg.disc_new.bd_addr[1],

2114 ()
msg
.
disc_Ãw
.
bd_addr
[2],()msg.disc_new.bd_addr[3],

2115 ()
msg
.
disc_Ãw
.
bd_addr
[4],()msg.disc_new.bd_addr[5]);

2116 
­pG‘LškšgCback
(
BSA_DISC_NEW_EVT
, &
msg
);

2119 
­pG‘LškšgCback
(
BSA_DISC_CMPL_EVT
, 
NULL
);

2123 
­p_mgr_g‘_lšked_deviûs
((*
­pG‘LškedCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
)

2125 
	gšdex
;

2126 if(
	g­pG‘LškedCback
 !ğ
NULL
)

2128 
šdex
 = 0; 
	gšdex
 < 
APP_NUM_ELEMENTS
(
­p_xml_»mÙe_deviûs_db
); index++)

2130 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gš_u£
 !ğ
FALSE
)

2132 
tAPP_DISC_MSG
 
msg
;

2143 
´štf
("class:=%02hhx:%02hhx:%02hhx\n",

2144 
­p_xml_»mÙe_deviûs_db
[
šdex
].
şass_of_deviû
[0],app_xml_remote_devices_db[index].class_of_device[1],

2145 
­p_xml_»mÙe_deviûs_db
[
šdex
].
şass_of_deviû
[2]);

2146 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_BLE_SERVICE_MASK
)

2147 
	gmsg
.
	gdisc_Ãw
.
	gbd_ty³
 = 1;

2148 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_SPP_SERVICE_MASK
)

2149 
	gmsg
.
	gdisc_Ãw
.
	gbd_ty³
 = 2;

2150 if(
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gŒu¡ed_£rviûs
 & 
	gBSA_A2DP_SERVICE_MASK
)

2151 
	gmsg
.
	gdisc_Ãw
.
	gbd_ty³
 = 3;

2152 if((
	g­p_xml_»mÙe_deviûs_db
[
šdex
].
	gşass_of_deviû
[1] & 0x1Fè=ğ
BTM_COD_MAJOR_AUDIO
)

2153 
msg
.
disc_Ãw
.
bd_ty³
 = 3;

2155 
	gmsg
.
	gdisc_Ãw
.
	gbd_ty³
 = 0;

2157 
	gmsg
.
	gdisc_Ãw
.
	gbd_addr
 = (cÚ¡ *)(
­p_xml_»mÙe_deviûs_db
[
šdex
].
bd_addr
);

2158 
	gmsg
.
	gdisc_Ãw
.
	gÇme
 = (cÚ¡ *)
­p_xml_»mÙe_deviûs_db
[
šdex
].
Çme
;

2159 
APP_INFO1
("lšked‚ame:%s,ty³:%d,bd_addr::%02x:%02x:%02x:%02x:%02x:%02x", 
msg
.
disc_Ãw
.
Çme
,msg.disc_Ãw.
bd_ty³
,

2160 ()
msg
.
disc_Ãw
.
bd_addr
[0],()msg.disc_new.bd_addr[1],

2161 ()
msg
.
disc_Ãw
.
bd_addr
[2],()msg.disc_new.bd_addr[3],

2162 ()
msg
.
disc_Ãw
.
bd_addr
[4],()msg.disc_new.bd_addr[5]);

2163 
­pG‘LškedCback
(
BSA_DISC_NEW_EVT
, &
msg
);

2166 
­pG‘LškedCback
(
BSA_DISC_CMPL_EVT
, 
NULL
);

2170 
­p_mgr_¡¬t_discov”y
((*
­pDiscCback
)(
ev’t
, 
tAPP_DISC_MSG
* 
p_d©a
), 
du¿tiÚ
, 
ty³
){

2171 
	gmAµDiscCback
 = 
­pDiscCback
;

2172 if(
	gty³
 == 0)

2173 
­p_disc_¡¬t_»guÏr
(&
­p_disc_cback
, 
du¿tiÚ
);

2175 
­p_disc_¡¬t_cod
(
BTM_COD_SERVICE_AUDIO
, 
BTM_COD_MAJOR_AUDIO
, 0, &
­p_disc_cback
);

2178 
­p_disc_cback
(
tBSA_DISC_EVT
 
ev’t
, 
tBSA_DISC_MSG
 *
p_d©a
){

2179 
	gev’t
)

2182 
	gBSA_DISC_NEW_EVT
:

2184 ià(
mAµDiscCback
 !ğ
NULL
)

2186 
tAPP_DISC_MSG
 
msg
;

2196 
BTM_COD_MAJOR_CLASS
Ğ
msg
.
disc_Ãw
.
bd_ty³
, (
p_d©a
->disc_Ãw.
şass_of_deviû
));

2197 
	gmsg
.
	gdisc_Ãw
.
	gbd_addr
 = (cÚ¡ *)(
p_d©a
->
disc_Ãw
.
bd_addr
);

2198 
	gmsg
.
	gdisc_Ãw
.
	gÇme
 = (cÚ¡ *)
p_d©a
->
disc_Ãw
.
Çme
;

2199 
APP_INFO1
("disøÇme:%s,ty³:%d,bd_addr::%02x:%02x:%02x:%02x:%02x:%02x", 
msg
.
disc_Ãw
.
Çme
,msg.disc_Ãw.
bd_ty³
,

2200 ()
msg
.
disc_Ãw
.
bd_addr
[0],()msg.disc_new.bd_addr[1],

2201 ()
msg
.
disc_Ãw
.
bd_addr
[2],()msg.disc_new.bd_addr[3],

2202 ()
msg
.
disc_Ãw
.
bd_addr
[4],()msg.disc_new.bd_addr[5]);

2203 
mAµDiscCback
(
ev’t
, &
msg
);

2205 ià(
	gp_d©a
->
	gdisc_Ãw
.
	geœ_d©a
[0])

2207 
­p_disc_·r£_eœ
(
p_d©a
->
disc_Ãw
.
eœ_d©a
);

2211 
	gBSA_DISC_CMPL_EVT
:

2212 
APP_INFO0
("Discovery complete");

2213 
mAµDiscCback
(
ev’t
, 
NULL
);

2214 
	gmAµDiscCback
 = 
NULL
;

2217 
ALOGE
("­p_disc_cback unknowÀev’t:%d", 
ev’t
);

	@source/app_unit.c

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<uni¡d.h
>

10 
	~<dœ’t.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/¡©.h
>

13 
	~<fú.h
>

14 
	~<sys/time.h
>

15 
	~<sys/wa™.h
>

16 
	~<¡dboŞ.h
>

17 
	~<”ºo.h
>

19 
	~"gki.h
"

20 
	~"uc.h
"

22 
	~"b§_­i.h
"

24 
	~"­p_xml_uts.h
"

26 
	~"­p_disc.h
"

27 
	~"­p_uts.h
"

28 
	~"­p_dm.h
"

29 
	~"­p_bË.h
"

30 
	~"­p_dg.h
"

31 
	~"­p_bË_£rv”.h
"

32 
	~"­p_uts.h
"

34 
	~"­p_£rviûs.h
"

35 
	~"­p_mgt.h
"

36 
	~"­p_th»ad.h
"

37 
	~"­p_mªag”.h
"

39 
	#ALOGE
 
´štf


	)

43 
	#APP_DG_TEST_FILE
 "./£rv”/bud/‹¡_fes/dg/tx_‹¡_fe.txt"

	)

44 
	#APP_BLE_MAIN_INVALID_UUID
 0

	)

45 
	#BT_POWER_STATE
 "/sys/şass/rfkl/rfkl0/¡©e"

	)

49 
BD_ADDR
 
­p_£c_db_addr
;

50 
tAPP_MGR_CB
 
­p_mgr_cb
;

51 
tAPP_XML_CONFIG
 
­p_xml_cÚfig
;

52 * 
	gbt_Çme
 = 
NULL
;

54 
mªag”In™
(cÚ¡ * 
Çme
);

55 
¡¬tProfes
();

62 
BOOLEAN
 
	$­p_mgr_mgt_ÿÎback
(
tBSA_MGT_EVT
 
ev’t
, 
tBSA_MGT_MSG
 *
p_d©a
)

64 
ev’t
)

66 
BSA_MGT_STATUS_EVT
:

67 
	`APP_DEBUG0
("BSA_MGT_STATUS_EVT");

68 ià(
p_d©a
->
¡©us
.
’abË
)

70 
	`APP_DEBUG0
("Bluetooth„estarted =>„e-initializehe‡pplication");

71 
	`­p_mgr_cÚfig
(
bt_Çme
);

75 
BSA_MGT_DISCONNECT_EVT
:

76 
	`APP_DEBUG1
("---BSA_MGT_DISCONNECT_EVT„—sÚ:%d", 
p_d©a
->
discÚÃù
.
»asÚ
);

77 
	`sy¡em
("killall -2 bsa_server_mips");

79 
pid_t
 
pid
;

80 
pid
 = 
	`fÜk
();

81 ià(
pid
 == -1){

82 
	`APP_ERROR0
("fork failed!");

85 ià(
pid
 == 0) {

86 
	`APP_DEBUG0
("start bsa_server_mips..");

87 
	`exeşp
("/u¤/bš/b§_£rv”_ms", "b§_£rv”_ms","-Ím","-®l=0","-r","14","-d","/dev/‰yS0","-u","/v¬/run/","-p","/fœmw¬e/BCM43455_003.001.025.0160.0303.hcd", 
NULL
);

89 
	`APP_DEBUG0
("signal..");

90 
	`sigÇl
(
SIGCHLD
,
SIG_IGN
);

92 
	`APP_DEBUG1
("bt_Çme:%s", 
bt_Çme
);

93 if(
bt_Çme
 !ğ
NULL
) {

94 if(
	`mªag”In™
(
bt_Çme
) < 0) {

95 
	`APP_ERROR0
("managerInit failed!");

99 if(
	`¡¬tProfes
() < 0) {

100 
	`APP_ERROR0
("startProfiles failed!");

108  
TRUE
;

109 
	}
}

111 
	$mªag”In™
(cÚ¡ * 
Çme
){

112 
mode
;

113 
	`­p_mgt_š™
();

114 ià(
	`­p_mgt_İ’
("/v¬/run/", 
­p_mgr_mgt_ÿÎback
) < 0){

115 
	`APP_ERROR0
("Unableo connecto server");

120 
	`­p_xml_š™
();

121 
bt_Çme
 = (*)
Çme
;

122 ià(
	`­p_mgr_cÚfig
((*)
Çme
)){

123 
	`APP_ERROR0
("Couldn't configure successfully,ƒxiting");

128 
	`­p_mgr_»ad_v”siÚ
();

131 
mode
 = 
	`­p_dm_g‘_du®_¡ack_mode
();

132 ià(
mode
 < 0){

133 
	`APP_ERROR0
("app_dm_get_dual_stack_mode failed");

137 
­p_mgr_cb
.
du®_¡ack_mode
 = 
mode
;

138 
	`APP_INFO1
("Cu¼’ˆDu®Sck mode:%s", 
	`­p_mgr_g‘_du®_¡ack_mode_desc
());

141 #ifdeà
USE_INGENIC_AUDIO_OSS_IN


143 
»t
 = 
	`lßd_šg’ic_audio_oss
();

144 
	`APP_INFO1
("Lßd ing’iøaudiØdev:%d\n",
»t
);

147 
	}
}

149 #ifdeà
BLUETOOTH_HILINK_SUPPORT


150 
tAPP_THREAD
 
	gt_­p_£t_adv_·¿m_th»ad
;

151 
­p_£t_adv_·¿m_th»ad
();

152 
b—cÚ_bË_adv_di§bË
();

153 
b—cÚ_£t_bË_sÿÄ¥_d©a
();

156 
	$¡¬tProfes
(){

158 ià(
	`­p_dg_š™
() < 0){

159 
	`APP_ERROR0
("Unableo init DG");

163 ià(
	`­p_dg_¡¬t
() < 0){

164 
	`APP_ERROR0
("Unableo start DG");

168 
¡©us
 = 
	`­p_bË_š™
();

169 ià(
¡©us
 < 0){

170 
	`APP_ERROR0
("Couldn't Initialize BLE !!");

173 
¡©us
 = 
	`­p_bË_¡¬t
();

174 ià(
¡©us
 < 0){

175 
	`APP_ERROR0
("Couldn't Start BLE !!");

177 
	`­p_bË_£rv”_»gi¡”
(
APP_BLE_MAIN_INVALID_UUID
, 
NULL
);

178 
	`­p_bË_£rv”_ü—‹_£rviû
();

182 #ifdeà
BLUETOOTH_HS_SUPPORT


184 
	`­p_hs_š™
();

186 
	`­p_hs_¡¬t
(
NULL
);

188 
	`­p_dg_li¡’
();

190 #ifdeà
BLUETOOTH_AVK_SUPPORT


191 
	`­p_avk_š™
(
NULL
);

192 
	`­p_avk_»gi¡”
();

194 #ifdeà
BLUETOOTH_AV_SUPPORT


195 
	`­p_av_š™
(
TRUE
);

196 
choiû
;

197 
choiû
 = 0; choiû < 
BTA_AV_NUM_STRS
; choice++){

198 
	`­p_av_»gi¡”
();

200 
BD_ADDR
 
bd_addr
;

201 if(
	`­p_mgr_g‘_dev_av_bt_addr
(
bd_addr
) == 0)

202 
	`­p_av_İ’
(
bd_addr
);

206 #ifdeà
BLUETOOTH_AG_SUPPORT


207 
	`­p_ag_š™
();

208 
	`­p_ag_¡¬t
(
BSA_SCO_ROUTE_PCM
);

211 #ifdeà
BLUETOOTH_HILINK_SUPPORT


212 
	`sy¡em
("wpa_cli scan &");

213 
	`­p_ü—‹_th»ad
(
­p_£t_adv_·¿m_th»ad
, 0, 0, &
t_­p_£t_adv_·¿m_th»ad
);

216 
	}
}

217 
	$£tBtPow”EÇbË
(
boŞ
 
’abË
){

218 
bufãr
 = '0';

219 
fd
 = 
	`İ’
(
BT_POWER_STATE
, 
O_WRONLY
);

220 ià(
fd
 < 0){

221 
	`ALOGE
("set_bluetooth_power : open for write failed: %s (%d)",

222 
	`¡»¼Ü
(
”ºo
),ƒrrno);

226 if(
’abË
){

227 
bufãr
 = '1';

229 
sz
 = 
	`wr™e
(
fd
, &
bufãr
, 1);

230 ià(
sz
 < 0) {

231 
	`ALOGE
("set_bluetooth_power : write failed: %s (%d)",

232 
	`¡»¼Ü
(
”ºo
),ƒrrno);

234 
	`şo£
(
fd
);

235 
	}
}

236 
	$¡İProfes
(){

238 
	`­p_dg_¡İ
();

241 
	`­p_bË_ex™
();

243 #ifdeà
BLUETOOTH_HS_SUPPORT


245 
	`­p_hs_¡İ
();

248 #ifdeà
BLUETOOTH_AVK_SUPPORT


249 
	`­p_avk_’d
();

250 
	`­p_avk_d”egi¡”
();

253 #ifdeà
BLUETOOTH_AV_SUPPORT


254 
	`­p_av_’d
();

257 #ifdeà
BLUETOOTH_AG_SUPPORT


258 
	`­p_ag_’d
();

261 
	`­p_mgt_şo£
();

262 
	}
}

263 #ifdeà
BLUETOOTH_HILINK_SUPPORT


268 
	gbk_bË_b—cÚ_¡©e
=-1;

269 
	gbË_b—cÚ_Ú_off
 = 0;

270 
	gÏ¡_¡©e
 = -1;

271 
	$£tBTBËB—cÚOnOff
(
¡©e
){

272 
Ï¡_¡©e
 = 
bË_b—cÚ_Ú_off
 = 
¡©e
;

273 
	}
}

275 
	$g‘BTBËB—cÚOnOff
(){

276  
bË_b—cÚ_Ú_off
;

277 
	}
}

278 
»£t_b—cÚ_tim”
();

281 
	$£tBTBËB—cÚ
(
¡©e
) {

282 if(
¡©e
 == 4) {

283 ifĞ
bË_b—cÚ_Ú_off
 ) {

284 
	`»£t_b—cÚ_tim”
();

288 if(
Ï¡_¡©e
 =ğ
¡©e
)

290 
Ï¡_¡©e
 = 
¡©e
;

291 
¡©e
) {

294 ià(
bË_b—cÚ_Ú_off
 !ğ
¡©e
) {

295 
bË_b—cÚ_Ú_off
 = 
¡©e
;

296 
	`ALOGD
("\À£tBTBËB—cÚ:%s\n", (
¡©e
 == 0) ? "off" : "on");

301 ià(
bk_bË_b—cÚ_¡©e
 !ğ
¡©e
) {

302 
bk_bË_b—cÚ_¡©e
 = 
¡©e
;

303 
	`ALOGD
("\À£tBTBËB—cÚ:%s\n", (
¡©e
 == 2) ? "unreg" : "reg");

304 
	`hšk_£t_¡©e
((
¡©e
 == 2) ? 0 : 1);

308 
	`b—cÚ_bË_adv_di§bË
();

309 ià(
bË_b—cÚ_Ú_off
 == 1) {

310 ià(
¡©e
) {

312 
	`b—cÚ_£t_bË_sÿÄ¥_d©a
();

314 
¡©e
) {

316 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

320 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

324 
	`b—cÚ_bË_adv_’abË
(
	`hšk_g‘_¡©e
());

332 
	}
}

334 #ifdeà
BLUETOOTH_HILINK_SUPPORT


335 
	$£tBËVisib™y
(
discov”abË
, 
cÚÃùabË
) {

336 
	`­p_dm_£t_bË_visib™y
(
discov”abË
, 
cÚÃùabË
);

337 
	}
}

339 
	$£tBTVisib™y
(
boŞ
 
discov”abË
, boŞ 
cÚÃùabË
) {

340 #ifdeà
BLUETOOTH_HILINK_SUPPORT


341 
	`­p_dm_£t_visib™y
(
çl£
, false);

344 
	`­p_dm_£t_visib™y
(
discov”abË
, 
cÚÃùabË
);

345 
	`­p_dm_£t_bË_visib™y
(
discov”abË
, 
cÚÃùabË
);

346 
	}
}

348 
	$£tBTEÇbË
(
boŞ
 
’abË
)

350 
	`­p_mgr_£t_bt_cÚfig
(
’abË
);

351 
	`£tBtPow”EÇbË
(
’abË
);

352 if(
’abË
)

353 
	`¡¬tProfes
();

355 
	`¡İProfes
();

356 
	}
}

	@source/ingenic_oss_input.c

1 
	~"šg’ic_oss_šput.h
"

3 
hw_deviû_t
 *
	gšg’icAudioDev
 = 
NULL
;

4 
audio_¡»am_š
 *
	gšAudioSŒ—m
 = 
NULL
;

6 
	$lßd_šg’ic_audio_oss
(){

7 
»t
 = 0;

8 
hw_moduË_t
 *
audioModuË
 = 
NULL
;

10 ià(
	`hw_g‘_moduË
(
AUDIO_HARDWARE_MODULE_ID
,

11 (cÚ¡ 
hw_moduË_t
 **)&
audioModuË
) < 0) {

12 
	`´štf
("ERROR:Could‚ot†oad‡udio HAL module\n");

17  
audioModuË
->
m‘hods
->
	`İ’
×udioModuË, 
AUDIO_HARDWARE_INTERFACE
,

18 (
hw_deviû_t
**)&
šg’icAudioDev
);

19 
	}
}

21 
	$İ’_šg’ic_audio_oss_šput
(
§m¶e_¿‹
){

22 
»t
 = 0;

23 if(
šg’icAudioDev
 =ğ
NULL
)

26 
audio_hw_deviû
 *
audioDev
 = (audio_hw_deviû *)
šg’icAudioDev
;

27 
audio_cÚfig
 
šcÚfig
 = {

29 
AUDIO_CHANNEL_IN_MONO
,

30 
AUDIO_FORMAT_PCM_16_BIT
,

36 
šcÚfig
.
§m¶e_¿‹
 = sample_rate;

37 
»t
 = 
audioDev
->
	`İ’_šput_¡»am
×udioDev,0,0,&
šcÚfig
,&
šAudioSŒ—m
);

38 if(
»t
 != 0)

39  
»t
;

40 
»t
 = (
šAudioSŒ—m
->
commÚ
).
	`£t_deviû
(&(šAudioSŒ—m->commÚ),
AUDIO_DEVICE_IN_BUILTIN_MIC
);

41 
	`´štf
("šAudioSŒ—m s‘ deviû„‘ = %d\n", 
»t
);

42  
»t
;

43 
	}
}

45 
	$şo£_šg’ic_audio_oss_šput
(){

46 if(
šg’icAudioDev
 =ğ
NULL
)

48 
audio_hw_deviû
 *
audioDev
 = (audio_hw_deviû *)
šg’icAudioDev
;

49 
audioDev
->
	`şo£_šput_¡»am
×udioDev,
šAudioSŒ—m
);

50 
šAudioSŒ—m
 = 
NULL
;

52 
	}
}

54 
	$šg’ic_audio_oss_»ad
(* 
»f_buf
,
size
){

55 if(
šg’icAudioDev
 =ğ
NULL
 || 
šAudioSŒ—m
 == NULL){

56 
	`´štf
("Error:audio oss is‚ot…repared.");

60  
šAudioSŒ—m
->
	`»ad
(šAudioSŒ—m, 
»f_buf
, 
size
);

61 
	}
}

	@source/ingenic_oss_output.c

1 
	~"šg’ic_oss_ouut.h
"

2 
	~<uni¡d.h
>

3 
	~<fú.h
>

4 
	~<¡dlib.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dio.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<sys/un.h
>

11 
	~<”ºo.h
>

13 
	#UNIX_DOMAIN
 "/v¬/run/audio_sock‘"

	)

14 
	gmSock‘Fd
 = -1;

16 
	$İ’_šg’ic_audio_oss_ouut
(* 
mode
,
mode_size
){

17 
fd
;

18 
sockaddr_un
 
£r_addr
;

19 
	`mem£t
(&
£r_addr
, 0, (ser_addr));

20 
£r_addr
.
sun_çmy
 = 
AF_UNIX
;

21 
	`¡rıy
(
£r_addr
.
sun_·th
,
UNIX_DOMAIN
);

22 
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
 | 
SOCK_CLOEXEC
, 0);

23 if(
fd
 < 0){

24 
	`´štf
("sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

27 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
£r_addr
, (ser_addr));

28 if(
»t
 < 0){

29 
	`´štf
("cÚÃù sock‘ƒ¼Ü: %s\n",
	`¡»¼Ü
(
”ºo
));

32 
»t
 = 
	`£nd
(
fd
, 
mode
, 
mode_size
, 0);

33 if(
»t
 <= 0)

34 
	`´štf
("£nd bufã¸d©¨”rÜ: %s\n",
	`¡»¼Ü
(
”ºo
));

35 
mSock‘Fd
 = 
fd
;

36 
	}
}

38 
	$şo£_šg’ic_audio_oss_ouut
(){

39 if(
mSock‘Fd
 > 0){

40 
	`şo£
(
mSock‘Fd
);

41 
mSock‘Fd
 = -1;

43 
	}
}

44 
	$šg’ic_audio_oss_wr™e
(cÚ¡ * 
d©a
,
size
){

45 if(
mSock‘Fd
 < 0){

50 
»t
 = 
	`£nd
(
mSock‘Fd
, 
d©a
, 
size
, 0);

51 if(
»t
 < 
size
){

52 
	`´štf
("ERROR:£nd faed„‘=%d size=%d",
»t
,
size
);

55  
»t
;

56 
	}
}

	@
1
.
0
48
1132
BtMain.cpp
ble/BleProtocol.cpp
incall/InCall.cpp
ohos_bt.c
protocol/DBHelper.cpp
protocol/SppProtocol.cpp
protocol/SyncData.cpp
protocol/SyncDataTools.cpp
protocol/SyncModule.cpp
protocol/UnBindModule.cpp
sdk/BluetoothController.cpp
sdk/BluetoothController.h
sdk/BluetoothServer.cpp
sdk/BluetoothServer.h
sdk/BluetoothUtils.h
sdk/HilinkModule.cpp
sdk/HilinkModule.h
sdk/HilinkServer.cpp
sdk/HilinkServer.h
sdk/ThirdPartyModule.cpp
sdk/ThirdPartyModule.h
sdk/ThirdPartyServer.cpp
sdk/ThirdPartyServer.h
source/app_ag.c
source/app_av.c
source/app_av_ipc.c
source/app_avk.c
source/app_ble.c
source/app_ble_server.c
source/app_common/app_disc.c
source/app_common/app_dm.c
source/app_common/app_link.c
source/app_common/app_mgt.c
source/app_common/app_mutex.c
source/app_common/app_playlist.c
source/app_common/app_services.c
source/app_common/app_thread.c
source/app_common/app_utils.c
source/app_common/app_wav.c
source/app_common/app_xml_param.c
source/app_common/app_xml_utils.c
source/app_common/nanoxml.c
source/app_dg.c
source/app_hs.c
source/app_manager.c
source/app_unit.c
source/ingenic_oss_input.c
source/ingenic_oss_output.c
